<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<div id="top"></div>


<h1 class="chapter"><a id="sec-4" href="./rails-flavored-ruby.html#top" class="heading"><span class="number">第4章</span>Rails風味のRuby</a></h1>


<p><a class="ref" href="./static-pages.html#top">第3章</a> で使用した例に基いて、この章ではRailsにおいて重要となるRubyのさまざまな要素について探っていくことにしましょう。Rubyは巨大な仕様を持つ言語ですが、幸い、Rails開発者にとって必要な知識は比較的少なくて済みます。さらに、Railsのために必要なRubyの知識は、通常のRubyを学ぶ過程とは<em>異なります</em>。動的なWebアプリを作ることができればそれでよいというのであれば、まずRailsを学ぶようにし、Rubyについては当分の間、必要が生じた場合にのみ学習することをお勧めします。そうではなく、真のRails<em>エキスパート</em>になりたいのであれば、Rubyをさらに深いレベルまで理解する必要があります。本書は、そのための開発技術の基礎を築く助けになるでしょう。<a class="ref" href="./beginning.html#sec-comments_for_various_readers">1.1.1</a>で示したように、<em>Railsチュートリアル</em> を終えた後には <a href="http://amzn.to/1k4KqxP"><em>Beginning Ruby</em></a>、<a href="http://amzn.to/1sRt1LK"><em>The Well-Grounded Rubyist</em></a>、<a href="http://amzn.to/1g8yQCl"><em>The Ruby Way</em></a> などの純粋なRubyについての本を読むことをお勧めします。</p>

<p>この章には多くの話題が盛り込まれていますが、一度読んだだけで理解する必要はまったくありません。今後もこの章には頻繁に立ち戻って参照します。</p>

<div class="label" id="sec-motivation"></div>


<h2><a id="sec-4_1" href="./rails-flavored-ruby.html#sec-motivation" class="heading"><span class="number">4.1</span>動機</a></h2>


<p>前章でお見せしたとおり、Rubyの基礎知識がまったくない状態であったにもかかわらずRailsアプリケーションの骨組みを作り上げ、さらにテストまで行うことができました。このときは、本書が提供するテストコードと、テストスイートがパスするまでエラーメッセージの修正を繰り返すという方法だけを頼りに作業を進めました。しかしこのような初歩的な作業をいつまでも続けるわけにはいきませんので、今の私たちのRubyに関する知識と経験の限界に真正面から挑み、これを乗り越えるためにこの章を割り当てることにします。</p>

<p>前章の終わりでは、Railsのレイアウトを使用してビューでの重複を取り除くために、ほぼ静的なページを単に更新したにとどまりました (<a class="ref" href="./rails-flavored-ruby.html#code-application_layout_redux">リスト4.1</a>)。</p>

<div class="label" id="code-application_layout_redux"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.1</span> <span class="description">サンプルアプリケーションのWebサイトのレイアウト。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./rails-flavored-ruby.html#code-application_layout_redux">リスト4.1</a>の以下の行に注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>ここでは、Railsの組み込み関数<code>stylesheet_link_tag</code> (詳細は<a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/AssetTagHelper/StylesheetTagHelpers.html#method-i-stylesheet_link_tag">Rails API</a>を参照) を使用して、<code>application.css</code>をすべての<a href="http://www.w3.org/TR/CSS2/media.html">メディアタイプ</a>にインクルードしています (メディアタイプには、コンピュータの画面や印刷画面なども含まれます)。Rails開発経験者にとってこの行は実にシンプルですが、しかしここには少なくとも混乱を生じる可能性のあるRubyの概念が4つあります。Railsの組み込み関数、括弧を使わない関数呼び出し、シンボル、そしてハッシュです。これらの概念についてはこの章ですべて説明します。</p>

<p>Railsのビューでは膨大な組み込み関数を使用することができますが、それに加えて新しい関数を作成することもできます。この関数は<em>ヘルパー</em>と呼ばれます。カスタムヘルパーを作成する方法を学ぶために、まず<a class="ref" href="./rails-flavored-ruby.html#code-application_layout_redux">リスト4.1</a>のタイトル行の部分に注目しましょう。</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上の行は、ページタイトルの定義に依存しています。この定義は、以下のようにビューで<code>provide</code>を使用して行われています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.jp/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>


<p>このとき、もしタイトルをまったく与えていなければ、タイトルが空欄になってしまいます。これを防ぐには、すべてのページで使用する<em>基本タイトル</em>を定め、特定のページでは異なるタイトルに変更できるようなオプションを与えるのが常套手段です。これは現在のレイアウトでも、<em>ある点を除いて</em>達成されています。もしビューの1つから<code>provide</code>呼び出しを削除すると、そのページ固有のタイトルの代わりに以下のタイトルが表示されます。</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | 
</pre></div>
</div>


<p>基本タイトルとしてはこれで正しいのですが、末尾に余分な縦棒<code>|</code>が残ってしまっています。</p>

<p>ページタイトルが正しく表示されない問題を解決するために、 <code>full_title</code>というヘルパーを作成することにします。<code>full_title</code>ヘルパーは、ページタイトルが定義されていない場合は基本タイトル “Ruby on Rails Tutorial Sample App”を返し、定義されている場合は基本タイトルに縦棒と追加ページタイトルを追加して返します (<a class="ref" href="./rails-flavored-ruby.html#code-title_helper">リスト4.2</a>)<sup class="footnote" id="fnref-4_1"><a href="./rails-flavored-ruby.html#fn-4_1">1</a></sup>。</p>

<div class="label" id="code-title_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.2</span> <span class="description"><code>full_title</code>ヘルパーを定義する。</span><br /><span class="description"> <code>app/helpers/application_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページごとの完全なタイトルを返します。</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ヘルパーを作成したので、これを使用してレイアウトをシンプルにすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>上の行を以下で置き換えます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>置き換えの結果を<a class="ref" href="./rails-flavored-ruby.html#code-application_layout_full_title">リスト4.3</a>に示します。</p>

<div class="label" id="code-application_layout_full_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.3</span> <span class="description">サンプルアプリケーションのWebサイトのレイアウト。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>このヘルパーを定義することで、Homeページにこれまで表示されていた余分な &quot;Home&quot; という単語を表示せず、基本タイトルのみを正しく表示することもできるようになります。これを行うには、まず<a class="ref" href="./rails-flavored-ruby.html#code-home_base_title_spec">リスト4.4</a>に示すように以前のテストコードを更新し、<code>&#39;Home&#39;</code>の文字が表示されていないことを確認するテストを追加します。</p>

<div class="label" id="code-home_base_title_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.4</span> <span class="description">Homeページのタイトル確認用にテストを更新する。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、単に既存のテストコードを修正するだけではなく、新しいテストコードを追加した理由について考えてみてください (<em>ヒント</em>: 答えは<a class="ref" href="./static-pages.html#sec-testing_a_title_change">3.3.1</a>にあります)。</p>

<p>ここでテストスイートを実行して、テストが失敗することを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>テストがパスするためには、<a class="ref" href="./rails-flavored-ruby.html#code-home_page_base_title">リスト4.5</a>のようにHomeページのビューから<code>provide</code>の行を削除する必要があります。</p>

<div class="label" id="code-home_page_base_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.5</span> <span class="description">ページタイトルをカスタマイズせずに表示するHomeページ。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.jp/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>Rails開発経験者にとっては、<a class="ref" href="./rails-flavored-ruby.html#code-title_helper">リスト4.2</a>のコードはスタイルシートをインクルードするのと大差ない単純なものですが、ここにもRuby未経験者を混乱させる可能性のある概念が<em>多数</em>含まれています。モジュール、コメント、ローカル変数割り当て、論理値 (boolean)、制御フロー、文字列の挿入、戻り値です。これらの概念についても、この章ですべて説明します。</p>

<div class="label" id="sec-strings_and_methods"></div>


<h2><a id="sec-4_2" href="./rails-flavored-ruby.html#sec-strings_and_methods" class="heading"><span class="number">4.2</span>文字列(string)とメソッド</a></h2>


<p>Ruby を学ぶためのツールとして、主に<em>Railsコンソール</em>を使用することにします。これは<a class="ref" href="./a-demo-app.html#sec-demo_user_has_many_microposts">2.3.3</a> でも登場した、Railsアプリケーションを対話的に操作するためのコマンドラインツールです。コンソールはインタラクティブRuby(<code>irb</code>) 上に構築されているため、Rubyの機能をすべて使うことができます (<a class="ref" href="./rails-flavored-ruby.html#sec-a_controller_class">4.4.4</a>でも説明しますが、コンソールからRails環境にアクセスすることもできます)。以下のコマンドをコマンドラインで実行し、Railsコンソールを起動しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment</span>
<span class="gp">&gt;&gt;</span>
</pre></div>
</div>


<p>デフォルトでは、コンソールは<em>開発 (development) 環境</em>という、Railsによって定義された3種類の環境のうちの1つで起動します (他の2つは<em>テスト (test) 環境</em>と<em>本番 (production) 環境</em>です)。この区別はこの章においては重要ではありませんが、<a class="ref" href="./sign-up.html#sec-rails_environments">7.1.1</a>でこれらの環境について詳細に説明します。</p>

<p>Railsコンソールは素晴しい学習ツールであり、その中を自由に探索できます。コンソールの中で何をしようとも、何かを壊すことは (まず) ありえないので、ご安心ください。Railsコンソールでは、スタックから抜けるにはCtrl-C を押し、完全にコンソールを終了するにはCtrl-Dを押します。以後この章を進めるにあたり、有用なリソースである<a href="http://ruby-doc.org/core-1.9.3/">Ruby API</a>を参照しながら学習することをぜひお勧めします。Ruby APIには高濃縮の情報が詰まっています (少々濃厚<em>すぎる</em>とも言えます)。たとえば、Rubyの文字列の詳細を知りたい場合は、Ruby APIエントリの<code>String</code>クラスを参照すればよいのです。</p>

<div class="label" id="sec-comments"></div>


<h3><a id="sec-4_2_1" href="./rails-flavored-ruby.html#sec-comments" class="heading"><span class="number">4.2.1</span>コメント</a></h3>


<p>Rubyの<em>コメント</em> はナンバー記号<code>#</code> (&quot;ハッシュマーク&quot;や、&quot;オクトソープ&quot;とも呼ばれます) から始まり、行の終わりまでコメントとして扱われます。Rubyはコメントの内容を実行することはありませんが、適切なコメントはそれを読む人間にとって (コードの作者にとっても) 非常に有用です。以下のコードの場合、</p>

<div class="code"><div class="highlight"><pre>  <span class="c1"># ページごとの完全なタイトルを返します。</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>最初の行が、その後に定義されている関数の目的を説明しているコメントです。</p>

<p>コンソール内ではコメントを使わないのが普通ですが、ここでは学習のためにあえて以下のようにコメントを追加してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="mi">17</span> <span class="o">+</span> <span class="mi">42</span>   <span class="c1"># 整数の加算</span>
<span class="go">=&gt; 59</span>
</pre></div>
</div>


<p>この章のコードを (ファイルに保存するのでなく) Railsコンソールに入力したりコピペしたりするときであれば、コメントを省略してもかまいません。コメントをRailsコンソールに入力しても、コメントは常に無視されるので問題ありません。</p>

<div class="label" id="sec-strings"></div>


<h3><a id="sec-4_2_2" href="./rails-flavored-ruby.html#sec-strings" class="heading"><span class="number">4.2.2</span>文字列</a></h3>


<p><em>文字列 (string)</em>は、おそらくどのWeb アプリケーションにおいても最も重要なデータ構造です。これは、Web ページというものが究極的にはサーバからブラウザに送信された文字列にすぎないためです。それでは、コンソールで文字列について調べてみましょう。今回は<code>rails console</code>の代わりに、短縮版の<code>rails c</code>でコンソールを起動します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails c</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span>         <span class="c1"># 空の文字列</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span>      <span class="c1"># 空でない文字列</span>
<span class="go">=&gt; &quot;foo&quot;</span>
</pre></div>
</div>


<p>ここで入力したものは<em>文字列リテラル</em>と呼ばれ (面白いことに<em>リテラル文字列</em>とも呼ばれます)、ダブルクォート<code>&quot;</code> で囲むことで作成できます。このコンソールは、入力したそれぞれの行を評価した結果を表示しており、文字列リテラルの場合には文字列自身が表示されます。</p>

<p><code>+</code> 演算子を使用して、文字列を結合することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span> <span class="o">+</span> <span class="s2">&quot;bar&quot;</span>    <span class="c1"># 文字列の結合</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>評価の結果は、<code>&quot;foo&quot;</code> と <code>&quot;bar&quot;</code> を足した<code>&quot;foobar&quot;</code>になりました<sup class="footnote" id="fnref-4_2"><a href="./rails-flavored-ruby.html#fn-4_2">2</a></sup>。</p>

<p>文字列を組み立てる他の方法として<em>補間子による式展開 (interpolation)</em>というものがあり、<code>#{}</code>という特殊な構文を使用します<sup class="footnote" id="fnref-4_3"><a href="./rails-flavored-ruby.html#fn-4_3">3</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>    <span class="c1">#変数割り当て</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> Hartl&quot;</span>     <span class="c1"># 文字列の補間</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>ここでは、<code>&quot;Michael&quot;</code> という値を<code>first_name</code>変数に<em>割り当て</em>、この変数が <code>&quot;#{first_name} Hartl&quot;</code> という文字列の中で式展開されます。苗字と名前の両方を変数に割り当てることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">last_name</span>    <span class="c1"># スペースをはさんで結合する</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>    <span class="c1"># 上と同等の補間</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>最後の2つの結果は同等であることに注目してください。なお、私は後者の補間子による式展開が好みです。空白を<code>&quot; &quot;</code>という形式で加えるのはぎこちなく思えます。</p>

<div class="label" id="sec-printing"></div>


<h4><a id="sec-4_2_2_1" href="./rails-flavored-ruby.html#sec-printing" class="heading">出力</a></h4>


<p>文字列を<em>出力</em>するために、Rubyの関数で最も一般に使われるのは<code>puts</code>です (putの三人称単数現在形ではなく “put string”なので、“put ess” と発音します)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;foo&quot;</span>     <span class="c1"># put string</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p><code>puts</code> メソッドは<em>副作用</em>が重要な役割を果たします。どういうことかと言うと、<code>puts &quot;foo&quot;</code>は文字列 <code>foo</code> を副作用としてスクリーンに表示しますが、返り値には「無」を返します (正確には<a href="http://www.answers.com/topic/nil">nilというリテラル</a>を返します。<code>nil</code> は &quot;まったく無い&quot;ことを表すRubyの特別な値です)。(<code>=&gt; nil</code> という結果は、今後簡素化のために省略することがあります。)</p>

<p><code>puts</code>を使用して出力すると、改行文字である<tt class="verb">\n</tt>が自動的に出力の末尾に追加されます。<code>print</code>メソッドも同様の出力を行いますが、以下のように、改行文字を追加しない点が異なります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo&quot;</span>    <span class="c1"># 文字列の出力 (putsと同じだが改行しない)</span>
<span class="go">foo=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># puts &quot;foo&quot; と同等</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>




<div class="label" id="sec-single_quoted_strings"></div>


<h4><a id="sec-4_2_2_2" href="./rails-flavored-ruby.html#sec-single_quoted_strings" class="heading">シングルクォート内の文字列</a></h4>


<p>これまでの例ではすべて<em>ダブルクォート文字列</em>を使用していましたが、Rubyでは<em>シングルクォート</em>もサポートしています。ほとんどの場合、ダブルクォートとシングルクォートのどちらを使用しても実質的に同じです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span>          <span class="c1"># シングルクォートで囲んだ文字列</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span> <span class="o">+</span> <span class="s1">&#39;bar&#39;</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>ただし、1つ重要な違いがあります。Rubyはシングルクォート文字列の中では補間子の式展開を行いません。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;#{foo} bar&#39;</span>     <span class="c1"># シングルクォートで囲まれた文字列では式展開されない</span>
<span class="go">=&gt; &quot;\#{foo} bar&quot;</span>
</pre></div>
</div>


<p>逆に言えば、ダブルクォート文字列を用いた文字列で<code>#</code>のような特殊な文字を使用する場合は、この文字をバックスラッシュで<em>エスケープ</em>する必要があります。</p>

<p>ダブルクォート文字列でもシングルクォート文字列と同じことができ、ダブルクォート文字列では式展開もできるのであれば、シングルクォート文字列にはどのような使い道があるのでしょうか。シングルクォートは、入力した文字をエスケープせずに「そのまま」保持するときに便利です。たとえば、いわゆる “バックスラッシュ” 文字は、改行文字<tt class="verb">\n</tt>と同様多くのシステム上で特殊な文字として扱われます。シングルクオートで文字列を囲めば、簡単にバックスラッシュ文字のような特殊文字をそのまま変数に含めることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;\n&#39;</span>       <span class="c1"># バックスラッシュ n&#39; をそのまま扱う</span>
<span class="go">=&gt; &quot;\\n&quot;</span>
</pre></div>
</div>


<p>以前の例で扱った<code>#</code>文字と同様、Rubyではバックスラッシュをエスケープするためにバックスラッシュがもう1つ必要です。ダブルクォート文字列の中では、バックスラッシュ文字そのものは<em>2つ</em>のバックスラッシュによって表されます。このようなささいな例の場合はそれほど問題になりませんが、以下のようにエスケープの必要な文字が大量にある場合には、シングルクォートは非常に便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;Newlines (\n) and tabs (\t) both use the backslash character \.&#39;</span>
<span class="go">=&gt; &quot;Newlines (\\n) and tabs (\\t) both use the backslash character \\.&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-objects_and_message_passing"></div>


<h3><a id="sec-4_2_3" href="./rails-flavored-ruby.html#sec-objects_and_message_passing" class="heading"><span class="number">4.2.3</span>オブジェクトとメッセージ受け渡し</a></h3>


<p>Rubyでは、あらゆるものが<em>オブジェクト</em>です。文字列や<code>nil</code>ですらオブジェクトです。このことの技術的な意味は<a class="ref" href="./rails-flavored-ruby.html#sec-a_class_of_our_own">4.4.2</a>で説明しますが、オブジェクトについてのこのような定義は、本で読んだだけではわかりません。さまざまなオブジェクトの例に触れることで、オブジェクトとは何であるかという直感を時間をかけて養う必要があります。</p>

<p>逆に、オブジェクトが何を<em>する</em>かを説明するのは簡単です。オブジェクトとは (いついかなる場合にも) メッセージに応答するものです。文字列のようなオブジェクトは、たとえば <code>length</code>というメッセージに応答できますが、これは文字列の文字数を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">length</span>        <span class="c1"># 文字列に &quot;length&quot; というメッセージを渡す</span>
<span class="go">=&gt; 6</span>
</pre></div>
</div>


<p>オブジェクトに渡されるメッセージは、一般には<em>メソッド</em>と呼ばれます。メソッドの実体は、そのオブジェクトに定義された関数です<sup class="footnote" id="fnref-4_4"><a href="./rails-flavored-ruby.html#fn-4_4">4</a></sup>。Rubyの文字列は、以下のように<code>empty?</code>メソッドにも応答することができます。 </p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><code>empty?</code>メソッドの末尾にある疑問符に注目してください。 これは Rubyの慣習で、<code>true</code> もしくは <code>false</code>という<em>論理値 (boolean)</em>を返すことを示します。論理値は特に<em>制御フロー</em>において有用です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is empty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is nonempty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; &quot;The string is nonempty&quot;</span>
</pre></div>
</div>


<p>論理値は、<code>&amp;&amp;</code> (“and”)、<code>||</code> (“or”)、そして<code>!</code> (&quot;not&quot;) 演算子によって結合することもできます。 </p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;Both strings are empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;One of the strings is empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;One of the strings is empty&quot;</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;x is not empty&quot;</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Rubyでは、あらゆるものがオブジェクトです。従って、<code>nil</code>もオブジェクトであり、これも多くのメソッドに応答できます。ほぼすべてのオブジェクトを文字列に変換する<code>to_s</code>メソッドを使用して、nilがメソッドに応答する例をお目にかけましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span>
<span class="go">=&gt; &quot;&quot;</span>
</pre></div>
</div>


<p>確かに空文字列が出力されました。今度は<code>nil</code> に対してメッセージを<em>連鎖 (chain)</em>して渡せることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">NoMethodError: You have a nil object when you didn&#39;t expect it!</span>
<span class="go">You might have expected an instance of Array.</span>
<span class="go">The error occurred while evaluating nil.empty?</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>      <span class="c1"># メッセージの連鎖</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>上に示したように、<code>nil</code> オブジェクトは<code>empty?</code> メソッドに応答しませんが、<code>nil.to_s</code>には応答します。</p>

<p>ご推察のとおり、<code>nil</code>かどうかを調べるメソッドもあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>ところで、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
</pre></div>
</div>


<p><code>if</code>キーワードの別の使い方を示しています。Rubyではこのように、<code>if</code> での条件式が真のときにだけ実行される式を書くことができ、コードが非常に簡潔になります。なお、<code>unless</code> キーワードも同様に使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;The string &#39;</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&#39; is nonempty.&quot;</span> <span class="k">unless</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">The string &#39;foobar&#39; is nonempty.</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Rubyにおいて<code>nil</code>は特別なオブジェクトです。Rubyのオブジェクトのうち、オブジェクトそのものの論理値がfalseになるのは、(<code>false</code>というオブジェクト自身を除いて) nil<em>だけ</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="kp">nil</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>        <span class="c1"># nilはfalse</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>その他のあらゆるRuby のオブジェクトは、ゼロですら<em>true</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="mi">0</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>        <span class="c1"># 0 (を含むあらゆるオブジェクト、nilとfalseは除く) はtrue</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<div class="label" id="sec-method_definitions"></div>


<h3><a id="sec-4_2_4" href="./rails-flavored-ruby.html#sec-method_definitions" class="heading"><span class="number">4.2.4</span>メソッドの定義</a></h3>


<p>Railsコンソールでも、<a class="ref" href="./static-pages.html#code-static_pages_controller">リスト3.6</a>の<code>home</code>アクションや、<a class="ref" href="./rails-flavored-ruby.html#code-title_helper">リスト4.2</a>の<code>full_title</code>ヘルパーと同じ方法でメソッドを定義することができます (メソッドの定義はファイルで行うのが普通なので、コンソールで行うのは少々面倒ですが、デモンストーレション目的であれば十分です)。たとえば、<code>string_message</code>という<em>引数</em>を1つ取り、引数が空かどうかに基づいたメッセージを返す関数を定義してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;It&#39;s an empty string!&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">It&#39;s an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div>
</div>


<p>ここで、Rubyの関数は <em>暗黙的戻り値</em>を持つということに注意してください。これは最後の式の評価値が返されることを意味します。この場合、引数の<code>string</code>が空かどうかに基づいた2つのメッセージ文字列のうちのいずれかが返されます。Rubyでは、戻り値を明示的に指定することもできます。以下の関数は上の関数と同じ結果を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;It&#39;s an empty string!&quot;</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
</pre></div>
</div>


<p>お気付きの方もいると思いますが、2番目の<code>return</code> は実はなくてもかまいません。関数中の最後の表現 <code>&quot;The string is nonempty.&quot;</code> は、<code>return</code>キーワードがあってもなくても値を返すためです。ここでは、両方に<code>return</code>を使用する方が見た目の対称性が保たれるので好ましいと言えます。</p>

<div class="label" id="sec-back_to_the_title_helper"></div>


<h3><a id="sec-4_2_5" href="./rails-flavored-ruby.html#sec-back_to_the_title_helper" class="heading"><span class="number">4.2.5</span> title ヘルパー、再び</a></h3>


<p>ここまででRubyの知識がある程度身についたので<sup class="footnote" id="fnref-4_5"><a href="./rails-flavored-ruby.html#fn-4_5">5</a></sup>、<a class="ref" href="./rails-flavored-ruby.html#code-title_helper">4.2</a>の<code>full_title</code>ヘルパーを理解できるようになったはずです。</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページごとの完全なタイトルを返します。</span><span class="c1"># コメント行</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>                          <span class="c1"># メソッド定義</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>  <span class="c1"># 変数に値を割り当てる</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>                              <span class="c1"># 論理値テスト</span>
      <span class="n">base_title</span>                                      <span class="c1"># 暗黙の返り値</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>                 <span class="c1"># 文字列の式展開</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Webサイトのレイアウトで使用するコンパクトなヘルパーメソッドは、関数定義、変数割り当て、論理評価、制御フロー、そして文字列の式展開などのRubyの要素が一体となってできあがっています。最後に<code>module ApplicationHelper</code>という要素について解説します。このモジュールは、関連したメソッドをまとめる方法の1つで、Rubyのクラスに<code>include</code>を使うことで<em>ミックスイン (mixed in)</em>することができます。通常のRubyを書くときには、モジュールを書いてはこれを明示的にインクルードするという作業を頻繁に行いますが、このヘルパーモジュールの場合はRailsが自動的にインクルードしてくれます。つまり、この<code>full_title</code>メソッドは<a href="http://catb.org/jargon/html/A/automagically.html">自動的に</a>すべてのビューで利用できます。</p>

<div class="label" id="sec-other_data_structures"></div>


<h2><a id="sec-4_3" href="./rails-flavored-ruby.html#sec-other_data_structures" class="heading"><span class="number">4.3</span>他のデータ構造</a></h2>


<p>Webアプリケーションは突き詰めればただの文字列に過ぎませんが、実際にはこれらの文字列を<em>作る</em>ために文字列以外のデータ構造も必要となります。この節では、Railsアプリケーションを書くために重要となる、いくつかのRubyのデータ構造について説明します。</p>

<div class="label" id="sec-arrays_and_ranges"></div>


<h3><a id="sec-4_3_1" href="./rails-flavored-ruby.html#sec-arrays_and_ranges" class="heading"><span class="number">4.3.1</span>配列と範囲演算子</a></h3>


<p>配列 (array) は、特定の順序を持つ要素のリストです。本書<em>Railsチュートリアル</em>ではこれまで配列について解説していませんでしたが、配列を理解することは、ハッシュ (<a class="ref" href="./rails-flavored-ruby.html#sec-hashes_and_symbols">4.3.3</a>) やRailsのデータモデルを理解するための重要な基盤となります (データモデルとは<code>has_many</code>などの関連付けのことであり、<a class="ref" href="./a-demo-app.html#sec-demo_user_has_many_microposts">2.3.3</a>や<a class="ref" href="./user-microposts.html#sec-user_micropost_associations">10.1.3</a>で詳細を説明します)。</p>

<p>Rubyの文字列の理解にだいぶ時間を使ってしまいましたので、次に進むことにします。文字列から配列を得る自然な方法の1つとして、以下の<code>split</code>メソッドがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span> <span class="s2">&quot;foo bar     baz&quot;</span><span class="o">.</span><span class="n">split</span>     <span class="c1"># 文字列を3つの要素を持つ配列に分割する</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>この操作によって、3つの文字列からなる配列が得られます。デフォルトでは、<code>split</code>は文字列を空白で区切って配列にしますが、以下のように他の文字を指定して区切ることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;fooxbarxbazx&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>多くのコンピュータ言語の慣習と同様、 Rubyの配列も<em>ゼロオリジン</em>を採用しています。これは、配列の最初の要素のインデックスは0、2番目は1...と続くことを意味します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># 配列へのアクセスには [ ] を使用する</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>              <span class="c1"># 負の値を持つインデックスも使用できる</span>
<span class="go">=&gt; 17</span>
</pre></div>
</div>


<p>上で示したとおり、配列の要素にアクセスするには角括弧を使用します。Rubyでは、角括弧によるアクセス方法以外にも配列の要素にアクセスする方法が提供されています<sup class="footnote" id="fnref-4_6"><a href="./rails-flavored-ruby.html#fn-4_6">6</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>                  <span class="c1"># &#39;a&#39; の内容に注目</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">second</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>    <span class="c1"># ==演算子による比較</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>最後の行では、等しいことを確認する比較演算子<code>==</code>を使ってみました。この演算子や <code>!=</code> (“等しくない”) などの演算子は、他の多くの言語と共通です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span>       <span class="c1"># 配列も文字列と同様 &#39;length&#39; メソッドに応答する</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">!</span><span class="o">=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>配列は、上記コードの最初の行の<code>length</code>メソッド以外にも、さまざまなメソッドに応答します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; [17, 8, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; [17, 42, 8]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
</pre></div>
</div>


<p>上のどのメソッドを実行した場合にも、<code>a</code>自身は変更されていないという点に注目してください。配列の内容を<em>変更</em>したい場合は、そのメソッドに対応する “破壊的” メソッドを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort!</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [8, 17, 42]</span>
</pre></div>
</div>


<p>また、<code>push</code>メソッド (または同等の<tt class="verb">&lt;&lt;</tt>演算子) を使用して配列に追加することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>                  <span class="c1"># 配列に6を追加</span>
<span class="go">=&gt; [42, 8, 17, 6]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>                     <span class="c1"># 配列に7を追加</span>
<span class="go">=&gt; [42, 8, 17, 6, 7]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;foo&quot;</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;bar&quot;</span>        <span class="c1"># 配列に連続プッシュ</span>
<span class="go">=&gt; [42, 8, 17, 6, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
</pre></div>
</div>


<p>最後の例では、要素の追加を連鎖 (chain) できることを示しました。また、Rubyの配列は、他の多くの言語の配列とは異なり、さまざまな型を共存させることができます (この場合は整数と文字列)。</p>

<p>文字列を配列に変換するのに<code>split</code>を使用しました。<code>join</code>メソッドはこれと逆の動作です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span>                       <span class="c1"># 区切り文字なしで連結</span>
<span class="go">=&gt; &quot;428177foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>                 <span class="c1"># カンマとスペースで区切って連結</span>
<span class="go">=&gt; &quot;42, 8, 17, 7, foo, bar&quot;</span>
</pre></div>
</div>


<p><em>範囲 (range)</em>は、配列と密接に関係しています。<code>to_a</code>メソッドを使用して配列に変換すると理解しやすいと思います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span>
<span class="go">=&gt; 0..9</span>
<span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">.</span><span class="n">to_a</span>              <span class="c1"># 配列でない数字の9にto_aを実行してしまった</span>
<span class="go">NoMethodError: undefined method `to_a&#39; for 9:Fixnum</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 範囲にto_aを実行するには丸括弧で囲む</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] </span>
</pre></div>
</div>


<p><code>0..9</code> は範囲として有効ですが、上の2番目の表記ではメソッドを呼ぶ際に括弧を追加する必要があることを示しています。</p>

<p>範囲は、配列の要素を取り出すのに便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="sx">%w[foo bar baz quux]</span>         <span class="c1"># %wを使用して文字列の配列に変換</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;, &quot;quux&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>以下のように、文字に対しても範囲を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;e&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span>
</pre></div>
</div>


<div class="label" id="sec-blocks"></div>


<h3><a id="sec-4_3_2" href="./rails-flavored-ruby.html#sec-blocks" class="heading"><span class="number">4.3.2</span>ブロック</a></h3>


<p>配列と範囲はいずれも、<em>ブロック</em>を伴うさまざまなメソッドに対して応答することができます。ブロックとは、Rubyの極めて強力な機能であり、かつ混乱を呼びやすい機能でもあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">}</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>上のコードは、範囲オブジェクトである<code>(1..5)</code>に対して<code>each</code>メソッドを呼び出します。そのときに、<code>{ |i| puts 2 * i }</code>というブロックを渡します。<code>|i|</code>では変数名が縦棒に囲まれていますが、これはブロック変数に対して使用するRubyの構文で、ブロックを操作するときに使用する変数を指定します。この場合、範囲オブジェクトの<code>each</code>メソッドは、<code>i</code>という1つのローカル変数を使用してブロックを操作できます。そして、範囲に含まれるそれぞれの値をこの変数に次々に代入してブロックを実行します。</p>

<p>ブロックは波括弧 { } で囲んで示すことができますが、以下のようにdoとendで囲んで示すこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>ブロックには複数の行を記述できます (実際ほとんどの場合複数です)。<em>Rails チュートリアル</em>では、波括弧を短い1行のブロックに使用し、<code>do..end</code>記法を長い1行や複数行のブロックに使用するという、Ruby共通の慣習に従っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">number</span>
<span class="gp">&gt;&gt; </span>  <span class="nb">puts</span> <span class="s1">&#39;--&#39;</span>
end
<span class="go">2</span>
<span class="go">--</span>
<span class="go">4</span>
<span class="go">--</span>
<span class="go">6</span>
<span class="go">--</span>
<span class="go">8</span>
<span class="go">--</span>
<span class="go">10</span>
<span class="go">--</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>ここでは<code>number</code>を<code>i</code>と差し替えたことで、他の変数名を使用してもよいということを強調しています。</p>

<p>ブロックは見た目に反して奥が深く、ブロックを十分に理解するためには相当なプログラミング経験が必要です。そのためには、ブロックを含むコードをたくさん読みこなすことでブロックの本質を会得する以外に方法はありません<sup class="footnote" id="fnref-4_7"><a href="./rails-flavored-ruby.html#fn-4_7">7</a></sup>。幸いなことに、人間には個別の事例を一般化する能力というものがあります。ささやかですが、<code>map</code>メソッドなどを使用したブロックの使用例を参考のためにいくつか挙げてみます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Betelgeuse!&quot;</span> <span class="p">}</span>   <span class="c1"># 3.timesではブロックに変数を使用していない</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">}</span>          <span class="c1"># **は累乗を表す</span>
<span class="go">=&gt; [1, 4, 9, 16, 25]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span>                        <span class="c1"># %wは文字列配列への変換であることを思い出そう</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
</pre></div>
</div>


<p>上に示したように、<code>map</code> メソッドは、配列や範囲オブジェクトの各要素に対して、与えられたブロックを適用した結果を返します。</p>

<p>ところで、<a class="ref" href="./beginning.html#sec-heroku_commands">1.4.4</a>でランダムなサブドメインを生成するために以下のRubyコードを紹介しましたが、今なら理解できる状態になったはずです。</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div>
</div>


<p>このコードを段階的に組み立ててみると、動作がよくわかります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>                     <span class="c1"># アルファベットの配列</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;,</span>
<span class="go">&quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span>             <span class="c1"># シャッフルする</span>
<span class="go">=&gt; [&quot;c&quot;, &quot;g&quot;, &quot;l&quot;, &quot;k&quot;, &quot;h&quot;, &quot;z&quot;, &quot;s&quot;, &quot;i&quot;, &quot;n&quot;, &quot;d&quot;, &quot;y&quot;, &quot;u&quot;, &quot;t&quot;, &quot;j&quot;, &quot;q&quot;,</span>
<span class="go">&quot;b&quot;, &quot;r&quot;, &quot;o&quot;, &quot;f&quot;, &quot;e&quot;, &quot;w&quot;, &quot;v&quot;, &quot;m&quot;, &quot;a&quot;, &quot;x&quot;, &quot;p&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span>       <span class="c1"># 最初の8つの要素を取り出す</span>
<span class="go">=&gt; [&quot;f&quot;, &quot;w&quot;, &quot;i&quot;, &quot;a&quot;, &quot;h&quot;, &quot;p&quot;, &quot;c&quot;, &quot;x&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>  <span class="c1"># つなげて1つの文字列にする</span>
<span class="go">=&gt; &quot;mznpybuj&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-hashes_and_symbols"></div>


<h3><a id="sec-4_3_3" href="./rails-flavored-ruby.html#sec-hashes_and_symbols" class="heading"><span class="number">4.3.3</span>ハッシュとシンボル</a></h3>


<p>ハッシュ (hash) とは、本質的には配列を一般化したものです。ハッシュは、基本的に配列と同じものとみなすこともできますが、インデックスに整数以外の要素も使用できる点が異なります (この理由から、いくつかの言語 (特にPerl) ではハッシュを<em>連想配列</em>と呼ぶこともあります)。ハッシュのインデックス (<em>キー</em>と呼ぶのが普通です) は、通常何らかのオブジェクトです。たとえば、以下のように文字列をキーとして使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># {}は空のハッシュ</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>     <span class="c1">#キー: &quot;first_name&quot;、値: &quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;last_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>        <span class="c1"># キー: &quot;last_name&quot;、値: &quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span>                 <span class="c1"># 配列と同じ方法で要素にアクセスできる</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span>                               <span class="c1"># ハッシュのリテラルな表記</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>ハッシュは、キーと値のペアを波括弧で囲んで表記します。キーと値のペアを持たない波括弧の組 (<code>{}</code>) は空のハッシュです。ここで重要なのは、ハッシュの波括弧は、ブロックの波括弧とはまったく別物であるという点です (これは確かに紛らわしい点です) 。ハッシュは配列と似ていますが、1つの重要な違いとして、ハッシュでは要素の「並び順」が保証されないという点があります<sup class="footnote" id="fnref-4_8"><a href="./rails-flavored-ruby.html#fn-4_8">8</a></sup>。もし要素の順序が重要である場合は、配列を使用する必要があります。</p>

<p>ハッシュの1要素を角括弧を使って定義する代わりに、以下のようにキーと値をハッシュロケットと呼ばれる<code>=&gt;</code> によってリテラル表現するほうが簡単です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;first_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hartl&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>ここではRubyにおける慣習として、ハッシュの最初と最後に空白を追加しています。この空白はあってもなくてもよく、コンソールでは無視されます (なぜスペースを置くようになったのかはわかりません。おそらく初期の有力な Rubyプログラマが好んだ結果、慣習となったのでしょう)。</p>

<p>ここまではハッシュのキーとして文字列を使用していましたが、Railsでは文字列よりも<em>シンボル</em>を使用する方が普通です。シンボルは文字列と似ていますが、クォートで囲む代わりにコロンが前に置かれている点が異なります。たとえば、<code>:name</code>はシンボルです。もちろん、余計なことを一切考えずに、シンボルを単なる文字列とみなしても構いません<sup class="footnote" id="fnref-4_9"><a href="./rails-flavored-ruby.html#fn-4_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;name&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;n&quot;, &quot;a&quot;, &quot;m&quot;, &quot;e&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">NoMethodError: undefined method `split&#39; for :name:Symbol</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; &quot;raboof&quot;</span>
<span class="gp">&gt;&gt; </span><span class="ss">:foobar</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">NoMethodError: undefined method `reverse&#39; for :foobar:Symbol</span>
</pre></div>
</div>


<p>シンボルは、Ruby以外ではごく一部の言語にしか採用されていない特殊なデータ形式です。最初は奇妙に思うかもしれませんが、Railsではシンボルをふんだんに使用しているので、すぐに慣れるでしょう。</p>

<p>ハッシュのキーとしてシンボルを採用する場合、<code>user</code> のハッシュは以下のように定義できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>              <span class="c1"># :name に一致する値にアクセスします。</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>          <span class="c1"># 未定義のキーの値にアクセスします。</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>最後の例を見ると、未定義のハッシュ値は単純に<code>nil</code>であることがわかります。</p>

<p>ハッシュではシンボルをキーとして使うことが一般的なので、Ruby 1.9ではこのような特殊な場合のための新しい記法をサポートしています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>2つ目の記法は、シンボルとハッシュロケットの組み合わせを、以下のようにキーの名前の (前ではなく) 後にコロンを置き、その後に値が続くように置き換えたものです。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>この構成は、JavaScriptなど他の言語のハッシュ記法により近いものになっており、Railsコミュニティでも人気が高まっています。どちらの記法もよく使われているので、両方の見分けがつくことが重要です。本書の他の章では、ほとんどの場合新しい記法でハッシュを記述しています。この記法はRuby 1.8.7以前では動作しないので注意してください。もし古いバージョンのRubyを使用している場合は、Ruby 1.9に更新する (推奨) か、古い記法に書き換えてください。</p>

<p><a class="ref" href="./rails-flavored-ruby.html#code-nested_hashes">リスト4.6</a>に示したように、ハッシュの値にはほぼ何でも使用することができ、他のハッシュを使用することすらできます。</p>

<div class="label" id="code-nested_hashes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.6</span> <span class="description">ハッシュをネストする。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># &#39;params&#39; というハッシュを定義する (&#39;parameters&#39; の略)。</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span>
<span class="go">=&gt; {:user=&gt;{:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}}</span>
<span class="gp">&gt;&gt; </span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
</pre></div>
</div></div>


<p>Railsでは、このようなハッシュのハッシュ (または<em>ネストされたハッシュ</em>) が大量に使われています。実際の使用例は<a class="ref" href="./sign-up.html#sec-signup_failure">7.3</a>で説明します。</p>

<p>配列や範囲オブジェクトと同様、ハッシュも<code>each</code>メソッドに応答します。たとえば、<code>:success</code>と<code>:error</code>という 2つの状態を持つ <code>flash</code> という名前のハッシュについて考えてみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, :error=&gt;&quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">Key :success has value &quot;It worked!&quot;</span>
<span class="go">Key :error has value &quot;It failed.&quot;</span>
</pre></div>
</div>


<p>ここで、配列の<code>each</code>メソッドでは、ブロックの変数は1つだけですが、ハッシュの<code>each</code>メソッドでは、ブロックの変数は<em>キー</em>と<em>値</em>の2つになっていることに注意してください。従って、 ハッシュに対して<code>each</code>メソッドを実行すると、ハッシュの1つの「キーと値の<em>ペア</em>」ごとに処理を繰り返します。</p>

<p>最後の例として、便利な<code>inspect</code>メソッドを紹介します。これは要求されたオブジェクトを表現する文字列を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 配列を文字列として出力</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">5</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">inspect</span>    <span class="c1"># 配列のリテラルを出力</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:name</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">name</span>
<span class="go">:name</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="s2">&quot;It worked!&quot;</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">It worked!</span>
<span class="go">&quot;It worked!&quot;</span>
</pre></div>
</div>


<p>ところで、オブジェクトを表示するために<code>inspect</code>とputsを使用することは非常によくあることなので、 両者を合わせた<code>p</code>関数というショートカットがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">p</span> <span class="ss">:name</span>             <span class="c1"># &#39;puts :name.inspect&#39; と同等</span>
<span class="go">:name</span>
</pre></div>
</div>




<div class="label" id="sec-css_revisited"></div>


<h3><a id="sec-4_3_4" href="./rails-flavored-ruby.html#sec-css_revisited" class="heading"><span class="number">4.3.4</span> CSS、再び</a></h3>


<p>それでは、もう一度<a class="ref" href="./rails-flavored-ruby.html#code-application_layout_redux">リスト4.1</a>に戻り、レイアウトに CSS (cascading style sheet) を追加する以下の行を見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>今なら、このコードを理解できる段階にあるはずです。<a class="ref" href="./rails-flavored-ruby.html#sec-motivation">4.1</a>でも簡単に説明したとおり、Railsではスタイルシートを追加するための特別な関数を使用しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>上のコードでは、この関数を呼んでいます。しかし、ここで不思議な点が2つあります。第一に、丸括弧がありません。実は、Ruby では丸括弧は使用してもしなくても構いません。以下の2つの行は同等です。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># 関数呼び出しの丸括弧は省略可能。</span>
<span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>第二に、<code>:media</code>引数はハッシュのように見えますが、波括弧がありません。実は、そのハッシュが関数呼び出しの<em>最後の</em>引数の場合は、波括弧を省略できます。以下の2つの行は同等です。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># 最後の引数がハッシュの場合、波括弧は省略可能。</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>従って、</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>上のコードでは<code>stylesheet_link_tag</code>関数を2つの引数で呼んでいます。最初の文字列はスタイルシートへのパスを示しており、次のハッシュはメディアタイプを示しています。コードが<tt class="verb">&lt;%= %&gt;</tt>で囲まれていることによって、 このコードの実行結果はERbのテンプレートに挿入されます。ブラウザ上でこのページのソースを表示すると、必要なスタイルシートが含まれていることを確認できます (<a class="ref" href="./rails-flavored-ruby.html#code-scss_source">リスト4.7</a>)。(CSSファイル名の後に、<code>?body=1</code>のような行が余分に表示されていることがあります。これらはRailsによって挿入されているもので、サーバ上で変更があった場合にブラウザがCSSを再読み込みするのに使用します。)</p>

<div class="label" id="code-scss_source"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.7</span> <span class="description">インクルードされたCSSによって生成されたHTMLソース。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/assets/application.css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div></div>


<p>実際に<a href="http://localhost:3000/assets/application.css">http://localhost:3000/assets/application.css</a>のCSSファイルにアクセスしてみると、わずかなコメントがある以外は空になっています。CSSの変更は<a class="ref" href="./filling-in-the-layout.html#top">第5章</a>で行います。</p>

<div class="label" id="sec-ruby_classes"></div>


<h2><a id="sec-4_4" href="./rails-flavored-ruby.html#sec-ruby_classes" class="heading"><span class="number">4.4</span> Ruby におけるクラス</a></h2>


<p>Rubyではあらゆるものがオブジェクトであるということは既に説明しましたが、この節では実際にオブジェクトをいくつか定義してみましょう。Rubyは、多くのオブジェクト指向言語と同様、メソッドをまとめるのに<em>クラス</em>を使用しています。これらのクラスから<em>インスタンスが生成される</em>ことでオブジェクトが作成されます。オブジェクト指向プログラミングの経験がない方にとっては何のことだかわからないと思いますので、いくつかの具体例を示すことにします。</p>

<div class="label" id="sec-constructors"></div>


<h3><a id="sec-4_4_1" href="./rails-flavored-ruby.html#sec-constructors" class="heading"><span class="number">4.4.1</span>コンストラクタ</a></h3>


<p>実は、これまで示した多くの例の中でも、クラスを使用してオブジェクトのインスタンスを作成してきたのですが、オブジェクトを作成するところを明示的に説明していませんでした。たとえば、ダブルクォートを使って文字列のインスタンスを作成しましたが、これは文字列のオブジェクトを暗黙で作成する<em>リテラルコンストラクタ</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>       <span class="c1"></span># ダブルクォートを使用した、文字列のリテラルコンストラクタ
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
</pre></div>
</div>


<p>上のコードでは、文字列が<code>class</code>メソッドに応答しており、その文字列が所属するクラスを単に返していることがわかります。</p>

<p>暗黙のリテラルコンストラクタを使う代わりに、明示的に同等の<em>名前付きコンストラクタ</em>を使うことができます。名前付きコンストラクタは、クラス名に対して<code>new</code>メソッドを呼び出します<sup class="footnote" id="fnref-4_10"><a href="./rails-flavored-ruby.html#fn-4_10">10</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>   <span class="c1"># 文字列の名前付きコンストラクタ</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;foobar&quot;</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>この動作はリテラルコンストラクタと同等ですが、動作の内容が明確に示されています。</p>

<p>配列でも、文字列と同様にインスタンスを生成できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; [1, 3, 2]</span>
</pre></div>
</div>


<p>ただし、ハッシュの場合は若干異なります。配列のコンストラクタである<code>Array.new</code> は配列の初期値を引数に取りますが、 <code>Hash.new</code> はハッシュの<em>デフォルト</em> 値を引数に取ります。これは、キーが存在しない場合のデフォルト値です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># 存在しないキー :fooの値にわざとアクセスしてみる</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># キーが存在しない場合のデフォルト値をnilから0に変更する</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>メソッドがクラス自身 (この場合は<code>new</code>) に対して呼び出されるとき、このメソッドを<em>クラスメソッド</em>と呼びます。クラスの<code>new</code>メソッドを呼び出した結果は、そのクラスのオブジェクトであり、これはクラスの<em>インスタンス</em>とも呼ばれます。<code>length</code>のように、インスタンスに対して呼び出すメソッドは<em>インスタンスメソッド</em>と呼ばれます。</p>

<div class="label" id="sec-a_class_of_our_own"></div>


<h3><a id="sec-4_4_2" href="./rails-flavored-ruby.html#sec-a_class_of_our_own" class="heading"><span class="number">4.4.2</span>クラス継承</a></h3>


<p>クラスについて学ぶとき、<code>superclass</code>メソッドを使って<em>クラス階層</em>を調べてみるとよくわかります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>                        <span class="c1"># sのクラスを表示</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>             <span class="c1"># Stringクラスのスーパークラスを表示</span>
<span class="go">=&gt; Object</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>  <span class="c1"># Ruby 1.9では新たにBasicObject基底クラスを使用</span>
<span class="go">=&gt; BasicObject</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>継承階層を<a class="ref" href="./rails-flavored-ruby.html#fig-string_inheritance_ruby_1_9">図4.1</a>に示します。ここでは、<code>String</code>クラスのスーパークラスは<code>Object</code>クラスで、<code>Object</code>クラスのスーパークラスは<code>BasicObject</code>クラスですが、 <code>BasicObject</code>クラスはスーパークラスを持たないことがわかります。この図式は、すべての Ruby のオブジェクトにおいて成り立ちます。クラス階層をたどっていくと、 Rubyにおけるすべてのクラスは最終的にスーパークラスを持たない<code>BasicObject</code>クラスを継承しています。これが、&quot;Rubyではあらゆるものがオブジェクトである&quot; ということの技術的な意味です。</p>

<div class="label" id="fig-string_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/string_inheritance_ruby_1_9.png" alt="string_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">図4.1: </span><span class="description"> <code>String</code>クラスの継承階層</span></div></div>


<p>クラスについての理解を深めるには、自分でクラスを作成してみるのが一番です。そこで、<code>Word</code>クラスを作成し、その中に、ある単語を前からと後ろからのどちらから読んでも同じ (つまり回文になっている) ならば<code>true</code>を返す<code>palindrome?</code>メソッドを作成してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>    <span class="n">string</span> <span class="o">==</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>このクラスとメソッドは以下のように使うことができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span>              <span class="c1"># Wordオブジェクトを作成する</span>
<span class="go">=&gt; #&lt;Word:0x22d0b20&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">level&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>もし上の例が少し不自然に思えるならば、勘が鋭いといえます。というのも、これはわざと不自然に書いたからです。文字列を引数に取るメソッドを作るためだけに、わざわざ新しいクラスを作るのは変です。単語<em>は</em>文字列なので、<a class="ref" href="./rails-flavored-ruby.html#code-word_class">リスト4.8</a>のように<code>Word</code>クラスは <code>String</code>クラスを<em>継承</em>するのが自然です (以下のリストを入力する前に、古い<code>Word</code>クラスの定義を消去するために、Railsコンソールをいったん終了してください)。</p>

<div class="label" id="code-word_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.8</span> <span class="description">コンソールで<code>Word</code>クラスを定義する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span> <span class="o">&lt;</span> <span class="nb">String</span>             <span class="c1"># WordクラスはStringクラスを継承する。</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が鏡文字であればtrueを返す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>        <span class="c1"># selfは文字列自身を表す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div></div>


<p><a class="ref" href="./static-pages.html#sec-static_pages_with_rails">3.1.2</a>でも簡単に説明しましたが、上のコードの<code>Word &lt; String</code>は継承のためのRubyの記法です。こうすることで、新しい<code>palindrome?</code>メソッドだけではなく、Stringクラスで使用できるすべてのメソッドをWordクラスに対しても使用できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>    <span class="c1"># 新しいWordを作成し、&quot;level&quot; で初期化する</span>
<span class="go">=&gt; &quot;level&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">palindrome?</span>            # Wordで<span class="c1">palindrome?</span><span class="c1">メソッド</span>を使用する。
<span class="go">=&gt; true                     </span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>                 <span class="c1"># Wordがstringのすべてのメソッドも継承している</span>
<span class="go">=&gt; 5</span>
</pre></div>
</div>


<p><code>Word</code>クラスは<code>String</code>クラスを継承しているので、コンソールを使用してクラス階層を明示的に確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Word</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p><a class="ref" href="./rails-flavored-ruby.html#fig-word_inheritance_ruby_1_9">図4.2</a>にこのクラス階層を示します。</p>

<div class="label" id="fig-word_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/word_inheritance_ruby_1_9.png" alt="word_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">図4.2: </span><a class="ref" href="./rails-flavored-ruby.html#code-word_class">リスト4.8</a>の<span class="description"> (組み込みではない) <code>Word</code>クラスの継承階層</span></div></div>


<p><a class="ref" href="./rails-flavored-ruby.html#code-word_class">リスト4.8</a>では、単語の文字を逆順にしたものが元の単語と同じであるかどうかのチェックを、<code>Word</code>クラスの中から自分自身が持つ単語にアクセスすることで行なっていることに注目してください。Rubyでは、<code>self</code>キーワードを使用してこれを指定することができます。<code>Word</code>クラスの中では、<code>self</code>はオブジェクト自身を指します。これはつまり、以下のコードを使用して、</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</pre></div>
</div>


<p>単語が回文であるかどうかを確認できるということです<sup class="footnote" id="fnref-4_11"><a href="./rails-flavored-ruby.html#fn-4_11">11</a></sup>。</p>

<div class="label" id="sec-modifying_built_in_classes"></div>


<h3><a id="sec-4_4_3" href="./rails-flavored-ruby.html#sec-modifying_built_in_classes" class="heading"><span class="number">4.4.3</span>組込みクラスの変更</a></h3>


<p>継承は強力な概念ですが、もし仮に継承を使用せずに<code>palindrome?</code>メソッドを<code>String</code>クラス自身に追加する (つまりStringクラスを拡張する) という、より自然な方法を使用することが可能だとしたら、わざわざWordクラスを作らなくても<code>palindrome?</code>をリテラル文字列に対して直接実行できるようになるはずです。そんなことが可能なのでしょうか (なお、現在のコードはそのようになっていないため、以下のようにエラーになります)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;level&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">NoMethodError: undefined method `palindrome?&#39;</span><span class="go">for &quot;level&quot;:String</span>
</pre></div>
</div>


<p>驚くべきことに、Rubyでは組み込みの基本クラスの拡張が可能なのです。Ruby のクラスは<em>オープン</em>で変更可能であり、クラス設計者でない私たちでもこれらのクラスにメソッドを追加することが許されています<sup class="footnote" id="fnref-4_12"><a href="./rails-flavored-ruby.html#fn-4_12">12</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が回文であればtrueを返す</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;deified&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>(Rubyで組み込みクラスにメソッドを追加できるということは実にクールですが、<code>&quot;deified&quot;</code> (=神格化された) という単語が回文になっていることも、それに劣らずクールではないでしょうか。)</p>

<p>組み込みクラスの変更は極めて強力なテクニックですが、大いなる力には大いなる責任が伴います (訳注: 「スパイダーマン」の名台詞)。従って、<em>真に</em>正当な理由がない限り、組み込みクラスにメソッドを追加することは無作法であると考えられています。Railsの場合、組み込みクラスの変更を正当化できる理由がいくつもあります。たとえば、Web アプリケーションでは、変数が絶対に<em>空白</em>にならないようにしたくなることがよくあります (ユーザ名などはスペースや<a href="http://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9#.E3.82.B3.E3.83.B3.E3.83.94.E3.83.A5.E3.83.BC.E3.82.BF.E3.81.AB.E3.81.8A.E3.81.91.E3.82.8B.E3.82.B9.E3.83.9A.E3.83.BC.E3.82.B9">その他の空白文字</a>になって欲しくないものです) ので、Railsは<code>blank?</code>メソッドをRuby に追加しています。Railsの拡張は自動的にRailsコンソールにも取り込まれるので、以下のようにコンソールで拡張の結果を確認できます (注意: 以下のコードは純粋な <code>irb</code> では動作しません)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>スペースが集まってできた文字列は<em>空 (empty) </em>とは認識されませんが、<em>空白 (blank) </em>であると認識されていることがわかります。ここで、<code>nil</code>は空白と認識されることに注意してください。<code>nil</code>は文字列ではないので、Railsが実は<code>blank?</code>メソッドを<code>String</code>クラスではなく、そのさらに上の基底クラスに追加していることが推測できます。その基底クラスとは、(この章の最初で説明した) <code>Object</code>自身です。RailsによってRubyの組み込みクラスに追加が行われている例については、<a class="ref" href="./sign-in-sign-out.html#sec-remember_me">8.2.1</a>で説明します。</p>

<div class="label" id="sec-a_controller_class"></div>


<h3><a id="sec-4_4_4" href="./rails-flavored-ruby.html#sec-a_controller_class" class="heading"><span class="number">4.4.4</span>コントローラクラス</a></h3>


<p>これまでクラスや継承について説明してきましたが、これらの話は前の章にもあったような気がします。それもそのはずで、StaticPagesコントローラで継承やクラスについて触れたことがありました (<a class="ref" href="./static-pages.html#code-adding_the_about_page">リスト3.15</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>本書をここまで進めてきた今であれば、上のコードの意味は (たとえ漠然とであっても) 理解できるはずです。<code>StaticPagesController</code>クラスは<code>ApplicationController</code>を継承しており、<code>home</code>メソッド、<code>help</code>メソッド、<code>about</code>メソッドを備えています。 Rails コンソールは、セッションごとにローカルのRails環境を読み込むので、コンソール内で明示的にコントローラを作成したり、そのクラス階層を調べたりすることができます<sup class="footnote" id="fnref-4_13"><a href="./rails-flavored-ruby.html#fn-4_13">13</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span> <span class="o">=</span> <span class="no">StaticPagesController</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;StaticPagesController:0x22855d0&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; StaticPagesController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ApplicationController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Metal</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; AbstractController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p>継承の関係を<a class="ref" href="./rails-flavored-ruby.html#fig-static_pages_controller_inheritance">図4.3</a>に示します。</p>

<div class="label" id="fig-static_pages_controller_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/static_pages_controller_inheritance.png" alt="static_pages_controller_inheritance" /></span></div><div class="caption"><span class="header">図4.3: </span><span class="description"> StaticPagesコントローラの継承階層</span></div></div>


<p>Railsコンソールでは、その中からコントローラのアクション (実はメソッド) を呼ぶこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">home</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>ここでは、<code>home</code>アクションの中身は空なので<code>nil</code>が返されます。</p>

<p>ここで重要な点があります。Railsのアクションには戻り値がありません。少なくとも、返される値は重要ではありません。<a class="ref" href="./static-pages.html#top">第3章</a>で示したとおり、<code>home</code>アクションはWebページを表示するためのものであり、値を返すためのものではありませんでした。しかも、第3章では一度も<code>StaticPagesController.new</code>を実行しませんでした。どうしてこれでうまくいっているのでしょうか。</p>

<p>実は、Railsは確かにRubyで<em>書かれて</em>いますが、既にRubyとは別物なのです。Railsのクラスは、普通のRubyオブジェクトと同様に振る舞うものもありますが、多くのクラスにはRailsの<a href="http://www.answers.com/topic/grist">魔法の粉</a>が振りかけられています。Railsは<em>独特</em>であり、 Rubyとは切り離して学習する必要があります。このため、とにかくWebアプリケーションを書けるようになりたい方は、最初にRailsを学び、次にRubyを学んでから再びRailsに戻ってくることをお勧めします。</p>

<div class="label" id="sec-a_user_class"></div>


<h3><a id="sec-4_4_5" href="./rails-flavored-ruby.html#sec-a_user_class" class="heading"><span class="number">4.4.5</span>ユーザークラス</a></h3>


<p>最後に完全なクラスを作成して、この章を終わりにしましょう。そこで、<a class="ref" href="./modeling-users.html#top">第6章</a>で使用する<code>User</code>クラスを最初から作成することにします。</p>

<p>これまではコンソール上でクラスを定義しましたが、このような面倒な作業はもう行いたくありません。これからは、アプリケーションのルートディレクトリに<code>example_user.rb</code>ファイルを作成し、そこに<a class="ref" href="./rails-flavored-ruby.html#code-example_user">リスト4.9</a>のように書くことにします。</p>

<div class="label" id="code-example_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.9</span> <span class="description">example_userで使用するコード。</span><br /><span class="description"> <code>example_user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードはこれまでよりもやや複雑になっていますので、順に見ていくことにします。以下の最初の行は、</p>

<div class="code"><div class="highlight"><pre>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</pre></div>
</div>


<p>ユーザ名とメールアドレスに対応する<em>アトリビュートアクセサ</em>をそれぞれ作成します。このコードは、<a class="ref" href="./a-demo-app.html#sec-mvc_in_action">2.2.2</a>でも説明したように、<code>@name</code>および<code>@email</code><em>インスタンス変数</em>について、取り出し(get) と割り当て(set) を行う &quot;ゲッター&quot; と &quot;セッター&quot; というメソッドをそれぞれ作成します。Railsでは、インスタンス変数を作成するだけでビューで自動的に使えるようになるという点に主な利用価値がありますが、一般的には、インスタンス変数はRubyのそのクラス内のどこでも利用できるようにしたい変数として使われます (これについては後で詳しく説明します)。インスタンス変数は常に<code>@</code>記号で始まり、未定義の状態では値が<code>nil</code>になります。</p>

<p>最初の行にある<code>initialize</code>は、Rubyの特殊なメソッドです。これは <code>User.new</code>を実行すると自動的に呼び出されるメソッドです。この場合の<code>initialize</code>メソッドは、以下のように<code>attributes</code>という引数を1つ取ります。</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>上のコードで、<code>attributes</code>変数は空のハッシュを<em>デフォルトの値</em>として持つため、名前やメールアドレスのないユーザを作ることができます (<a class="ref" href="./rails-flavored-ruby.html#sec-hashes_and_symbols">4.3.3</a>を思い出してください。存在しないキーに対してハッシュは<code>nil</code>を返すので、<code>:name</code>キーがなければ<code>attributes[:name]</code>は<code>nil</code> になり、同じことが<code>attributes[:email]</code>にも言えます)。</p>

<p>最後に、<code>formatted_email</code>メソッドを定義しましょう (<a class="ref" href="./rails-flavored-ruby.html#sec-strings">4.2.2</a>)。このメソッドは、補間子による文字列の式展開を利用して、<code>@name</code>と<code>@email</code>に割り当てられた値をユーザのメールアドレスとして構成します。</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
</pre></div>
</div>


<p><code>@</code> 記号によって示されているとおり、<code>@name</code>と<code>@email</code>は両方ともインスタンス変数なので、自動的に<code>formatted_email</code>メソッドで使えるようになります。</p>

<p>Railsコンソールを起動し、example_userのコードを<code>require</code>して、自作したクラスを試しに使ってみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">&#39;./example_user&#39;</span>     <span class="c1"># example_user のコードを読み込む方法</span>
<span class="go">=&gt; [&quot;User&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User:0x224ceec @email=nil, @name=nil&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span>                 <span class="c1"># attributes[:name]がnilなのでnilが返される</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>           <span class="c1"># nilでない名前を割り当てる</span>
<span class="go">=&gt; &quot;Example User&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;user@example.com&quot;</span>      <span class="c1"># nil でないメールアドレスも割り当てる</span>
<span class="go">=&gt; &quot;user@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Example User &lt;user@example.com&gt;&quot;</span>
</pre></div>
</div>


<p>上のコードで、requireのパスにある<code>’.’</code>は、Unixの “カレントディレクトリ” (現在のディレクトリ) を表し、<code>’./example_user’</code>というパスは、カレントディレクトリからの相対パスでexample_userファイルを探すようにRubyに指示します。次のコードでは空のexample_userを作成します。次に、対応する属性にそれぞれ手動で値を代入することで、名前とメールアドレスを与えます (<a class="ref" href="./rails-flavored-ruby.html#code-example_user">リスト4.9</a>で<code>attr_accessor</code>を使用しているので、アトリビュートアクセサを使用して代入できます)。以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>
</pre></div>
</div>


<p><code>@name</code>変数に<code>&quot;Example User&quot;</code>という値を設定します。同様に<code>email</code>属性にも値を設定します。これらの値は<code>formatted_email</code>メソッドで使用されます。</p>

<p><a class="ref" href="./rails-flavored-ruby.html#sec-css_revisited">4.3.4</a>では、最後のハッシュ引数の波括弧を省略できることを説明しました。それと同じ要領で<code>initialize</code>メソッドにハッシュを渡すことで、属性が定義済みの他のユーザを作成することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User:0x225167c @email=&quot;mhartl@example.com&quot;, @name=&quot;Michael Hartl&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Michael Hartl &lt;mhartl@example.com&gt;&quot;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up.html#top">第7章</a>では、ハッシュ引数を使用してオブジェクトを初期化します。これは一般に<em>マスアサインメント (mass assignment)</em>と呼ばれる技法で、Railsアプリケーションで多用されています。</p>

<div class="label" id="sec-conclusion"></div>


<h2><a id="sec-4_5" href="./rails-flavored-ruby.html#sec-conclusion" class="heading"><span class="number">4.5</span>最後に</a></h2>


<p>以上で、Ruby言語の概要の説明を終わります。<a class="ref" href="./filling-in-the-layout.html#top">第5章</a>では、この章で学んだ内容をサンプルアプリケーションの開発に活かしていきます。</p>

<p><a class="ref" href="./rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>で作成した<code>example_user.rb</code>ファイルは今後使用することはありませんので、削除してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm example_user.rb
</pre></div>
</div>


<p>その他の変更はリポジトリにコミットしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add a full_title helper&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-exercises"></div>


<h2><a id="sec-4_6" href="./rails-flavored-ruby.html#sec-exercises" class="heading"><span class="number">4.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="./rails-flavored-ruby.html#code-string_shuffle">リスト4.10</a>のコードにある２つの疑問符を、それぞれ適切なメソッドに置き換えて、与えられた文字列の文字をシャッフルする関数を作成してください。ヒント: <code>split</code>メソッド、<code>shuffle</code>メソッド、<code>join</code>メソッドを組み合わせてみましょう。</li>

<li><a class="ref" href="./rails-flavored-ruby.html#code-string_shuffle_two">リスト4.11</a>を参考にして、上で作成した<code>shuffle</code>メソッドを <code>String</code>クラスに追加してください。</li>

<li><code>person1</code>、<code>person2</code>、<code>person3</code>という3つのハッシュを作成してください。それぞれのハッシュには<code>:first</code>キーと<code>:last</code>キーを与え、さらにそれぞれのキーに名前と名字を値として割り当ててください。次に<code>params</code>ハッシュを作成し、<code>params[:father]</code>は<code>person1</code>、<code>params[:mother]</code>は<code>person2</code>、そして<code>params[:child]</code>は <code>person3</code>になるようにしてください。最後に、<code>params[:father][:first]</code>などが正しい値を持っていることを確認してください。</li>

<li>Ruby API のオンラインマニュアルを見つけて、<code>Hash</code>クラスの<code>merge</code>メソッドについて読んでみてください。</li>

<li><a href="http://rubykoans.com/">Ruby Koans</a><sup class="footnote" id="fnref-4_14"><a href="./rails-flavored-ruby.html#fn-4_14">14</a></sup>(訳注: TDDでRubyを学べる無料のコンテンツ)をやってみて、Rubyの感覚を掴んでみてください。</li>
</ol>




<div class="label" id="code-string_shuffle"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.10</span> <span class="description">文字列をシャッフルする関数の骨組み。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">string_shuffle</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div></div>




<div class="label" id="code-string_shuffle_two"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.11</span> <span class="description"><code>shuffle</code>メソッドを<code>String</code>クラスに追加するための骨組み。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">shuffle</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">shuffle</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="./static-pages.html#top">
</a><a class="prev_page" href="./static-pages.html#top"><span class="number">第3章</span>ほぼ静的なページの作成</a><a class="prev_page" href="./static-pages.html#top">  </a>
  <a class="next_page" href="./filling-in-the-layout.html#top">
</a><a class="next_page" href="./filling-in-the-layout.html#top">    <span class="number">第5章</span>レイアウトを作成する</a><a class="next_page" href="./filling-in-the-layout.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-4_1">あるヘルパーが特定のコントローラでのみ使用するものであれば、それに対応するヘルパーファイルに置く必要があります。たとえばStaticPagesコントローラ用ヘルパーは、通常<code>app/helpers/static_pages_helper.rb</code>になります。今回の場合、<code>full_title</code>ヘルパーはサイトのすべてのページで使用することを前提にしていますが、Railsにはこのような場合のための特別なヘルパーファイル<code>app/helpers/application_helper.rb</code>があります。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_1">↑</a></li>
<li id="fn-4_2">“foo”と“bar”という言葉の起源の詳細については、<a href="http://www.catb.org/jargon/html/F/foo.html">Jargon Fileの “foo” の項</a>を参照してください。特に“foobar”は“FUBAR” (=めちゃくちゃ) とは何の関係も<em>ない</em>ということについて。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_2">↑</a></li>
<li id="fn-4_3">PerlやPHPに精通した開発者であれば、<code>&quot;foo $bar&quot;</code>のようなドル記号による自動的な挿入を連想して比較することでしょう。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_3">↑</a></li>
<li id="fn-4_4">この章の全体にわたって、<em>関数</em>という言葉と<em>メソッド</em>という言葉が混在していることを前もってお詫びいたします。Rubyでは関数とメソッドには何の違いもありません。すべてのメソッドは関数であり、すべての関数はメソッドでもあります。それもこれも、あらゆるものがオブジェクトであるからです。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_4">↑</a></li>
<li id="fn-4_5">とはいうものの、まだ理解のおよばない点が<em>1つ</em>残っています。Railsがこれらすべてを結びつけている方法です。URIがどのようにしてアクションにマップされているのか、<code>full_title</code>ヘルパーをどのようにしてビューで使用できるようにしているのかなどは、この時点では明かされていません。これは実に興味深いテーマであり、意欲のある方はぜひ自分で調べてみてください。ただし、Railsが<em>どのように</em>動いているかを正確に知らなくても、Railsを<em>使用する</em>うえでは何の問題もありません (この点を深く理解したい方には、「<a href="http://amzn.to/1ljfOH0"><em>The Rails 3 Way</em></a>」(Obie Fernandez著) がお勧めです) 。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_5">↑</a></li>
<li id="fn-4_6">このコードで使用している<code>second</code>メソッドは、実はRuby自身の一部ではなく、Railsが追加したものです。このコードが動作するのは、RailsによるRubyの拡張がRailsコンソールによって自動的に取り込まれるからです。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_6">↑</a></li>
<li id="fn-4_7">なおエキスパート向けには、ブロックが<em>クロージャ</em>になっているということを知っていただくと理解しやすいと思います。クロージャとは、データを伴う、その場限りの無名関数です。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_7">↑</a></li>
<li id="fn-4_8">実はRuby 1.9では、ハッシュの要素の順序が入力順と同じであることを保証していますが、ハッシュを特定の順序に依存してカウントするのは得策ではありません。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_8">↑</a></li>
<li id="fn-4_9">余計なものを削ぎ落した結果、シンボル同士の比較を容易に行えます。文字列は1文字ずつ比較する必要がありますが、シンボルは一度に全体を比較できます。これはハッシュのキーとして理想的な性質です。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_9">↑</a></li>
<li id="fn-4_10">このメソッドの動作は、使用しているRubyのバージョンによって異なる可能性があります。この例ではRuby 1.9.3を前提としています。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_10">↑</a></li>
<li id="fn-4_11">Rubyのクラスや<code>self</code>キーワードについての詳細は、<a href="http://www.railstips.org/">RailsTips</a>の “<a href="http://www.railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/">Ruby におけるクラスとインスタンス変数</a>” を参照してください。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_11">↑</a></li>
<li id="fn-4_12">JavaScriptに精通している方のために補足すると、この機能は組み込みクラスのプロトタイプオブジェクトを使用してクラスを拡張することと似ています (読者の<a href="http://getsatisfaction.com/railstutorial/topics/adding_methods_to_built_in_classes_comparable_to_using_javascripts_prototype_object">Erik Eldridge</a>による指摘に感謝します)。 <a class="arrow" href="./rails-flavored-ruby.html#fnref-4_12">↑</a></li>
<li id="fn-4_13">これらの階層にあるクラスの詳細を知る必要はないと思います。<em>私ですら</em>それらのクラスの詳細について知らないことがたくさんありますし、それでも私は2005年からRuby on Railsで問題なくプログラミングできています。これは (a) 私がよほど無能であるか、(b) Railsの内部を知りつくさなくても熟練したRails開発者になれる、ということのどちらかでしょう。私のためにも読者の皆様のためにも、後者であることを祈ります。<a class="arrow" href="./rails-flavored-ruby.html#fnref-4_13">↑</a></li>
<li id="fn-4_14">http://rubykoans.com/ <a class="arrow" href="./rails-flavored-ruby.html#fnref-4_14">↑</a></li>
</ol>
</div>




    </div>
  </body>
</html>
