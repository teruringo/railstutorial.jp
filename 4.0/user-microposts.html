<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<div id="top"></div>


<h1 class="chapter"><a id="sec-10" href="./user-microposts.html#top" class="heading"><span class="number">第10章</span>ユーザーのマイクロポスト</a></h1>


<p><a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>ではUsersリソース用のRESTアクションを完成させました。次はいよいよ、ユーザーの<em>マイクロポスト</em>リソースをすべて追加しましょう<sup class="footnote" id="fnref-10_1"><a href="./user-microposts.html#fn-10_1">1</a></sup>。<a class="ref" href="./a-demo-app.html#top">第2章</a>では、特定のユーザーに関連付けられたいくつかの簡単なメッセージがありました。この章では、<a class="ref" href="./a-demo-app.html#sec-microposts_resource">2.3</a>で記述したMicropostデータモデルを作成し、Userモデルと<code>has_many</code>および<code>belongs_to</code>メソッドを使って関連付けを行い、さらに、結果を処理し表示するために必要なフォームとその部品を作成します。 <a class="ref" href="./following-users.html#top">第11章</a>では、マイクロポストの<em>フィード</em>を受け取るために、ユーザーを<em>フォロー</em>するという概念を導入し、Twitterのミニクローンを完成させます。</p>

<p>Git をバージョン管理に使っている場合は、いつものようにトピックブランチを作成しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec-a_micropost_model"></div>


<h2><a id="sec-10_1" href="./user-microposts.html#sec-a_micropost_model" class="heading"><span class="number">10.1</span>Micropostモデル</a></h2>


<p>まずはMicropostリソースの最も本質的な部分を表現するMicropostモデルを作成するところから始めましょう。<a class="ref" href="./a-demo-app.html#sec-microposts_resource">2.3</a>で作成したモデルと同様に、この新しいMicropostモデルもデータ検証とUserモデルの関連付けを含んでいます。以前のモデルとは違って、今回のマイクロポストモデルは完全にテストされ、デフォルトの<em>順序</em>を持ち、また親であるユーザーが破棄された場合には自動的に<em>破棄</em>されるようにします。</p>

<div class="label" id="sec-the_basic_model"></div>


<h3><a id="sec-10_1_1" href="./user-microposts.html#sec-the_basic_model" class="heading"><span class="number">10.1.1</span>基本的なモデル</a></h3>


<p>Micropostモデルは、マイクロポストの内容を保存する<code>content</code>属性<sup class="footnote" id="fnref-10_2"><a href="./user-microposts.html#fn-10_2">2</a></sup>と、特定のユーザーとマイクロポストを関連付ける<code>user_id</code>属性の2つの属性だけを持ちます。Userモデルの場合と同様に (<a class="ref" href="./modeling-users.html#code-generate_user_model">リスト6.1</a>)、<code>generate model</code>コマンドを使って生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p>上のコマンドを実行するとMicropostファクトリーが作成されますが、これは後で手動で作成するので (<a class="ref" href="./user-microposts.html#sec-ordering_and_dependency">10.1.4</a>)、以下を実行していったん削除してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -f spec/factories/microposts.rb
</pre></div>
</div>


<p><a class="ref" href="./modeling-users.html#code-users_migration">リスト6.2</a>でデータベースに<code>users</code>テーブルを作るマイグレーションファイルを生成した時と同様に、このコマンドは <code>microposts</code>テーブルを作成するためのマイグレーションファイルを生成します (<a class="ref" href="./user-microposts.html#code-micropost_migration">リスト10.1</a>)。</p>

<div class="label" id="code-micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.1</span> <span class="description">Micropostマイグレーション</span><span class="description">(<code>user_id</code>と<code>created_at</code>にインデックスが与えられていることに注意)</span><br /><span class="description"> <code>db/migrate/[timestamp]_create_microposts.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>


      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、<a class="ref" href="./user-microposts.html#code-micropost_migration">リスト10.1</a>では<code>user_id</code>と<code>created_at</code>カラムにインデックスが付与されていることに注目してください (<a class="ref" href="./modeling-users.html#sidebar-database_indices">コラム  6.2</a>)。user idに関連付けられたすべてのマイクロポストを作成時刻の逆順で取り出すためです。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>


<p><code>user_id</code>と<code>created_at</code>両方のカラムを1つの配列に含めることで、Active Recordで<em>両方</em>のキーを同時に使用する<em>複合キーインデックス</em>を作成できます。また<a class="ref" href="./modeling-users.html#sec-database_migrations">6.1.1</a>でも述べたように、<code>t.timestamps</code>の行によって<code>created_at</code>カラムと<code>updated_at</code>カラムが作成されていることにも注目してください。この後、<a class="ref" href="./user-microposts.html#sec-ordering_and_dependency">10.1.4</a>および<a class="ref" href="./user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>で<code>created_at</code>カラムをさらに追加します。</p>

<p>それではUserモデルの場合 (<a class="ref" href="./modeling-users.html#code-user_spec">リスト6.5</a>) と同様に、Micropostモデルに対する最小限のテストを書くところから始めましょう。具体的には <a class="ref" href="./user-microposts.html#code-initial_micropost_spec">リスト10.2</a> に示すように、micropostオブジェクトが <code>content</code>属性と<code>user_id</code>属性を持っていることを確認するテストを作成します。</p>

<div class="label" id="code-initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.2</span> <span class="description">最初のMicropost spec。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># このコードは慣用的な意味で正しくない。</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Micropost マイグレーションを実行し、テストデータベースを準備することで、これらのテストをパスさせることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>実行した結果のMicropostモデルの構造は<a class="ref" href="./user-microposts.html#fig-micropost_model">図10.1</a>のようになります。</p>

<div class="label" id="fig-micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/micropost_model.png" alt="micropost_model" /></span></div><div class="caption"><span class="header">図10.1</span><span class="description">Micropostデータモデル</span></div></div>


<p>テストにパスすることを確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>


<p>テストにパスしたとしても、コードの中にある以下のコメントに気付いた方もいると思います。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># このコードは慣用的な意味で正しくない。</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコメントは、<code>before</code> ブロックのコードが慣用的な意味で正しくないことを指摘しています。このコードは動きますが、Railsの流儀に合っていません。その理由を考えてみてください。解答は<a class="ref" href="./user-microposts.html#sec-user_micropost_associations">10.1.3</a>で確認できます。</p>

<div class="label" id="sec-first_micropost_validation"></div>


<h3><a id="sec-10_1_2" href="./user-microposts.html#sec-first_micropost_validation" class="heading"><span class="number">10.1.2</span> 最初の検証</a></h3>


<p>Micropostモデルが必要とされている理由のひとつに、マイクロポストを投稿したユーザーを示すユーザーidを持っているということがあります。これを慣用的な意味で正しく行うには、Active Recordの<em>関連付け</em>を行います。実際の関連付けは<a class="ref" href="./user-microposts.html#sec-user_micropost_associations">10.1.3</a>で行います。この作業にはある程度のリファクタリングが必要なので、テストを作成してバグの再発をキャッチするようにします。</p>

<p><a class="ref" href="./user-microposts.html#code-micropost_validity_test">リスト10.3</a>に示したテストでは、ユーザーidを<code>nil</code>にしてから投稿したマイクロポストが無効になるかどうかをチェックすることで、検証を行なっています。(<a class="ref" href="./modeling-users.html#code-failing_validates_name_spec">リスト6.8</a>でのUserモデルのテストと比較してみてください)。</p>

<div class="label" id="code-micropost_validity_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.3</span> <span class="description">新しいマイクロポストに対する検証をテストする。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># このコードは慣用的な意味で正しくない。</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードはマイクロポストが有効であり、かつ<code>user_id</code>属性が存在していることをテストしています。<a class="ref" href="./user-microposts.html#code-micropost_user_id_validation">リスト10.4</a> に示すような簡単な存在確認検証によって、このテストはパスします。</p>

<div class="label" id="code-micropost_user_id_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.4</span> <span class="description">マイクロポストの<code>user_id</code>に対する検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-user_micropost_associations"></div>


<h3><a id="sec-10_1_3" href="./user-microposts.html#sec-user_micropost_associations" class="heading"><span class="number">10.1.3</span>User/Micropostの関連付け</a></h3>


<p>Webアプリケーション用のデータモデルを構築するにあたって、個々のモデル間での<em>関連付け</em>を十分考えておくことが重要です。今回の場合は、 <a class="ref" href="./a-demo-app.html#sec-demo_user_has_many_microposts">2.3.3</a>でも示したように、それぞれのマイクロポストは１人のユーザーと関連付けられ、それぞれのユーザーは (潜在的に) 複数のマイクロポストと関連付けられます。この関連付けを<a class="ref" href="./user-microposts.html#fig-micropost_belongs_to_user">図10.2</a>と<a class="ref" href="./user-microposts.html#fig-user_has_many_microposts">図10.3</a>に示します。これらの関連付けを実装するための一環として、Micropostモデルに対するテストを作成し、さらにUserモデルにいくつかのテストを追加します。</p>

<div class="label" id="fig-micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" /></span></div><div class="caption"><span class="header">図10.2</span><span class="description">micropost と user</span>間の<code>belongs_to</code>リレーションシップ</div></div>




<div class="label" id="fig-user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_has_many_microposts.png" alt="user_has_many_microposts" /></span></div><div class="caption"><span class="header">図10.3</span><span class="description">userとmicropost</span>間の<code>has_many</code>リレーションシップ</div></div>


<p>この節で定義する<code>belongs_to</code>/<code>has_many</code>関連付けを使用することで、<a class="ref" href="./user-microposts.html#table-association_methods">表10.1</a>に示すようなメソッドをRailsで使えるようになります。</p>

<div class="label" id="table-association_methods"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>メソッド</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">マイクロポストに関連付けられたユーザーオブジェクトを返す。</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">ユーザーのマイクロポストの配列を返す。</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">マイクロポストを作成する (<code>user_id = user.id</code>)。</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">マイクロポストを作成する (失敗した場合は例外を発生する)。</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">新しいMicropostオブジェクトを返す (<code>user_id = user.id</code>)。</td></tr></table></div><div class="caption"><span class="header">表10.1</span><span class="description">user/micropost関連メソッドのまとめ</span></div></div>


<p><a class="ref" href="./user-microposts.html#table-association_methods">表10.1</a>では、以下のメソッドではなく</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>


<p>以下のメソッドになっていることに注意してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>このパターンは、user オブジェクトの関連付けを<em>経由して</em>マイクロポストを作成する標準的な方法です。新規のマイクロポストがこの方法で作成される場合、<code>user_id</code>は<em>自動的</em>に正しい値に設定されます。特に、以下のような</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># このコードは慣用的な意味で正しくない。</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p><a class="ref" href="./user-microposts.html#code-micropost_validity_test">リスト10.3</a>のコードを、以下のコードと置き換えることができるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>一度正しい関連付けを定義してしまえば、<code>@micropost</code>変数の<code>user_id</code>には、関連するユーザーのidが自動的に設定されます。</p>

<p><a class="ref" href="./user-microposts.html#table-association_methods">表10.1</a>に示したように、ユーザーとマイクロポストの関連付けの結果には、単にマイクロポストのユーザーを返す<code>micropost.user</code>メソッドもあり、これもテストが必要です。このメソッドは、<code>it</code>と<code>its</code>メソッドを以下のように使うことでテストできます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルのテストを<a class="ref" href="./user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.5</a>に示します。</p>

<div class="label" id="code-micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.5</span> <span class="description">マイクロポストのユーザーとの関連付けのテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Userモデル側の関連付けに対する詳細なテストは<a class="ref" href="./user-microposts.html#sec-ordering_and_dependency">10.1.4</a>まで保留することにし、今は単に<code>microposts</code>属性の存在をテストするだけにしておきます (<a class="ref" href="./user-microposts.html#code-user_has_many_microposts_spec">リスト10.6</a>)。</p>

<div class="label" id="code-user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.6</span> <span class="description">ユーザーの<code>microposts</code>属性に対するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>関連付けを実装する最終的なコードは、テストコードの長さと比べるとあっけないほど短いものになります。<a class="ref" href="./user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.5</a>と<a class="ref" href="./user-microposts.html#code-user_has_many_microposts_spec">リスト10.6</a>の両方のテストにパスするためには、<code>belongs_to :user</code> (<a class="ref" href="./user-microposts.html#code-micropost_belongs_to_user">リスト10.7</a>)と<code>has_many :microposts</code> (<a class="ref" href="./user-microposts.html#code-user_has_many_microposts">リスト10.8</a>) の2行を加えるだけで済みます。</p>

<div class="label" id="code-micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.7</span> <span class="description">マイクロポストがユーザーに所属する (<code>belongs_to</code>) 関連付け。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.8</span> <span class="description">ユーザーがマイクロポストを複数所有する (<code>has_many</code>) 関連付け。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、<a class="ref" href="./user-microposts.html#table-association_methods">表10.1</a>の項目と、<a class="ref" href="./user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.5</a>および<a class="ref" href="./user-microposts.html#code-user_has_many_microposts_spec">リスト10.6</a>のコードをよく見比べて、関連付けの基本的原則を理解しておいてください。テストにパスすることも確認しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>




<div class="label" id="sec-ordering_and_dependency"></div>


<h3><a id="sec-10_1_4" href="./user-microposts.html#sec-ordering_and_dependency" class="heading"><span class="number">10.1.4</span>マイクロポストを改良する</a></h3>


<p><a class="ref" href="./user-microposts.html#code-user_has_many_microposts_spec">リスト10.6</a>の<code>has_many</code>関連付けのテストでは、<code>microposts</code>属性の<em>存在</em>をほとんど検証していないので、あまり意味がありませんでした。この章では、<em>順序</em>と<em>依存関係</em>をマイクロポストに追加し、<code>user.microposts</code>メソッドが実際にマイクロポストの配列を返すことをテストします。</p>

<p>Userモデルのテストのためにいくつかのマイクロポストを作成しておく必要がありますので、この時点でマイクロポストを生成するファクトリーを作成しておきましょう。そのためには、Factory Girlに関連付けを作成する方法を知っておく必要があります。幸い、<a class="ref" href="./user-microposts.html#code-micropost_factory">リスト10.9</a>に示したとおり、これは非常に簡単です。</p>

<div class="label" id="code-micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.9</span> <span class="description">マイクロポスト作成用の新しいファクトリーを含む、完全なFactoryファイル。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここでは、以下のようにマイクロポスト用のファクトリーの定義にuserを含めるだけで、マイクロポストに関連付けられるユーザーのことがFactory Girlに伝わります。</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>


<p>次の節でもお見せしますが、これによって、以下のようにマイクロポスト用のファクトリーを定義できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<div class="label" id="sec-default_scope"></div>


<h4><a id="sec-10_1_4_1" href="./user-microposts.html#sec-default_scope" class="heading">デフォルトのスコープ</a></h4>


<p>データベースからユーザーのマイクロポストを読み出す<code>user.microposts</code>メソッドは、デフォルトでは読み出しの順序に対して何も保証しませんが、 ブログやTwitterの慣習に従って、作成時間の逆順、つまり最も新しいマイクロポストを最初に表示するようにしてみましょう。この順序をテストするために、次のようにマイクロポストをいくつか作成しておきます。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>(<a class="ref" href="./sign-in-sign-out.html#sidebar-time_helpers">コラム 8.1</a>で説明した時間指定用ヘルパーメソッドを使うことで) 2番目のポストの作成時刻がより新しく (<code>1.hour.ago</code>: 1時間前)、最初のポストの作成日時が<code>1.day.ago</code> (1日前) になります。Factory Girlを使用すると、Active Recordがアクセスを許可しないような<code>created_at</code>属性も手動で設定できるので大変便利です (<code>created_at</code>や<code>updated_at</code>などは通常のカラムと異なる “マジック”カラムであり、これらの作成タイムスタンプや更新タイムスタンプは自動的に設定されてしまうため、明示的に値を設定しても上書きされてしまうことを思い出してください)。</p>

<p>(SQLiteを含む) ほとんどのデータベースアダプターは、マイクロポストを id順で返すため、<a class="ref" href="./user-microposts.html#code-micropost_ordering_test">リスト10.10</a>のようなテストはほぼ確実に失敗することになります。このコードでは<code>let</code>メソッドの代わりに<code>let!</code> (“let バン”と読みます) メソッドを使っています。その理由は、<code>let</code>変数は<em>lazy</em>、つまり参照されたときにはじめて初期化されるためです。ここでは、マイクロポストを遅延することなく即座に作成する必要があります。そのことにより、マイクロポストのタイムスタンプが常に正しい順序で作成されるように、かつ<code>@user.microposts</code>が空の状態が生じることのないようにしたいからです。<code>let!</code>を使用すれば、対応する変数を強制的に即座に作成できます。</p>

<div class="label" id="code-micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.10</span> <span class="description">ユーザーのマイクロポストの順序をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right microposts in the right order&quot;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上記のコードで重要なのは、以下の行です。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div>
</div>


<p>これは新しいポストが最初に来ることをテストしています。デフォルトでは id順に並ぶため<code>[older_micropost, newer_micropost]</code>の順序になりテストは失敗するはずです。またこのテストは、<a class="ref" href="./user-microposts.html#table-association_methods">表10.1</a>で示すように、 <code>user.microposts</code>が有効なマイクロポストの配列を返すことをチェックすることにより、基本的な<code>has_many</code>関連付け自体の正しさも確認しています。<a class="ref" href="./rails-flavored-ruby.html#sec-arrays_and_ranges">4.3.1</a>でも説明したように、<code>to_a</code>メソッドは、 <code>@user.microposts</code>をデフォルトの状態 (これはたまたまActive Recordの &quot;collection proxy&quot; になっています) から正しい配列に変換します。変換された配列は、手作りの配列と比較可能になります。</p>

<p>順序テストがパスするために、 <a class="ref" href="./user-microposts.html#code-micropost_ordering">リスト 10.11</a>に示すようにRailsの<code>default_scope</code>に<code>order</code>パラメータを渡して使用します (このコードは<em>スコープ</em>に関する最初の例でもあります。より一般的なスコープについては<a class="ref" href="./following-users.html#top">第11章</a>で説明します)。</p>

<div class="label" id="code-micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.11</span> <span class="description"><code>default_scope</code>でマイクロポストを順序付ける。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでの順序は<code>’created_at DESC’</code>としています。<code>DESC</code>は SQLでいうところの “descending” であり、新しいものから古い順への降順ということになります。</p>

<p>Rails 4.0からは、あらゆるスコープは、スコープで必要な域値を返す無名関数を受け取ります。これにより、スコープをその場で評価する必要がほぼなくなり、後に読み込まれたときに必要に応じて評価するようになります (いわゆる<em></em>遅延評価 (lazy evaluation) です)。上のコードの場合、以下がその関数です。</p>

<div class="code"><div class="highlight"><pre><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>この種のオブジェクトの構文は、<em>Proc</em> (手続き: procedure) とか<em>ラムダ (lambda)</em>と呼ばれ、<code>-&gt;</code>という矢印で表されます。この構文はブロック (<a class="ref" href="./rails-flavored-ruby.html#sec-blocks">4.3.2</a>) を引数に取り、後に<code>call</code>メソッドによって呼び出されるときにブロックを実際に評価します。この構文をコンソールで確かめてみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">&quot;foo&quot;</span> <span class="o">}</span>
<span class="go">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">&quot;foo&quot;</span> <span class="o">}</span>.call
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>(ProcやラムダはRubyのトピックとしてはやや高度な部類に含まれるので、今すぐわからなくても心配する必要はありません。)</p>

<div class="label" id="sec-dependent_destroy"></div>


<h4><a id="sec-10_1_4_2" href="./user-microposts.html#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>順序についてはひとまずここで区切ることにし、今度はマイクロポストに第二の要素を追加してみましょう。<a class="ref" href="./updating-showing-and-deleting-users.html#sec-destroying_users">9.4</a>で書いたように、サイト管理者はユーザーを<em>破棄する</em>権限を持ちます。ユーザーが破棄された場合、ユーザーのマイクロポストも同様に破棄されるべきです。最初のマイクロポストのユーザーを破棄した後、関連するマイクロポストもデータベースからなくなったことを確認することで、ユーザーの破棄をテストすることができます。</p>

<p>適切にマイクロポストの破棄をテストするために、最初にローカル変数で指定されたユーザーのポストを取得し、次にユーザーを破棄します。シンプルな実装は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードで、<code>to_a</code>メソッドが呼び出されていることでマイクロポストのコピーが作成されていることに注目してください (参照のコピーではなく、オブジェクト自体がコピーされています)。さらに、以下の行にも注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
</pre></div>
</div>


<p>上の行は一種のセフティチェックの役割も果たしており、うっかり<code>to_a</code>メソッドを付け忘れたときのエラーをすべてキャッチしてくれます。ここで重要なのは、<code>to_a</code>メソッドがなかったら、ユーザーを削除したときに<code>microposts</code>変数に含まれているポストまで削除されてしまうということです。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>つまり、<code>microposts</code>が空になってしまうため、上のテストに何を書いても動作しなくなってしまうということです。</p>

<p>データベースにマイクロポストがないという予想は、以下のように書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_empty</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードでは、<code>Micropost.find</code>ではなく<code>Micropost.where</code>を使用しています。whereメソッドは、レコードがない場合に空のオブジェクトを返すので多少テストが書きやすくなるためです (findはレコードがない場合に例外を発生します)。(気になる方への補足: findを使用する場合は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="k">do</span>
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveRecord::RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>これでfindの場合のテストを実施できます。)</p>

<p>これまでのコードを集約したものを<a class="ref" href="./user-microposts.html#code-micropost_dependency_test">リスト10.12</a>に示します。</p>

<div class="label" id="code-micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.12</span> <span class="description">ユーザーを破棄するとマイクロポストも破棄されることをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy associated microposts&quot;</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_empty</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./user-microposts.html#code-micropost_dependency_test">リスト10.12</a>のテストをパスするためのアプリケーションコードは1行に満たないほどの量しかなく、事実それは<a class="ref" href="./user-microposts.html#code-micropost_dependency">リスト10.13</a>に示す <code>has_many</code>関連付けメソッドのオプションにすぎません。</p>

<div class="label" id="code-micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.13</span> <span class="description">ユーザーのマイクロポストがユーザーと一緒に破棄されることを保証するコード。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードの中にある以下の<code>dependent: :destroy</code>オプションは、</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
</pre></div>
</div>


<p>ユーザー自体が破棄されたときに、そのユーザーに依存するマイクロポスト (つまり特定のユーザーのもの) も破棄されることを指定しています。これは、管理者がシステムからユーザーを削除したときに、依存するユーザーが存在しないマイクロポストがデータベースに取り残されてしまうことを防ぎます。</p>

<p>これで、ユーザー/マイクロポスト関連付けの最終形が完成しました。すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-micropost_validations"></div>


<h3><a id="sec-10_1_5" href="./user-microposts.html#sec-micropost_validations" class="heading"><span class="number">10.1.5</span>コンテンツの検証</a></h3>


<p>Micropostモデルを離れる前に、(<a class="ref" href="./a-demo-app.html#sec-putting_the_micro_in_microposts">2.3.2</a>の例に従い) マイクロポストの<code>content</code>の検証を追加しましょう。<code>user_id</code>属性と同様、<code>content</code>属性も存在する必要があり、さらに<em>マイクロ</em>ポストが140文字より長くならないよう制限を加えます。このテストは<a class="ref" href="./modeling-users.html#sec-user_validations">6.2</a>でのユーザーモデルの検証テストの例に従って、<a class="ref" href="./user-microposts.html#code-micropost_validations_tests">リスト10.14</a>のように書きます。</p>

<div class="label" id="code-micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.14</span> <span class="description">Micropostモデルの検証のテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with blank content&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with content that is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./modeling-users.html#sec-user_validations">6.2</a>と同様、<a class="ref" href="./user-microposts.html#code-micropost_validations_tests">リスト10.14</a>ではマイクロポストの長さの検証コードをテストするために、文字列の乗算を使用しています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 10
<span class="go">=&gt; &quot;aaaaaaaaaa&quot;</span>
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 141
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
</pre></div>
</div>


<p>実際のアプリケーションコードはわずか1行です。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルを<a class="ref" href="./user-microposts.html#code-micropost_validations">リスト10.15</a>に示します。</p>

<div class="label" id="code-micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.15</span> <span class="description">Micropostモデルの検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-showing_microposts"></div>


<h2><a id="sec-10_2" href="./user-microposts.html#sec-showing_microposts" class="heading"><span class="number">10.2</span>マイクロポストを表示する</a></h2>


<p>Web経由でマイクロポストを作成する方法は現時点ではありませんが (<a class="ref" href="./user-microposts.html#sec-creating_microposts">10.3.2</a>から作り始めます)、マイクロポストを表示することと、テストすることならできます。ここでは、Twitterのような独立したマイクロポスト<code>index</code>ページでユーザーのマイクロポストを表示するよりも、<a class="ref" href="./user-microposts.html#fig-user_microposts_mockup">図10.4</a>のモックアップに示したように、直接ユーザーの<code>show</code>ページで表示させることにしましょう。ユーザープロファイルにマイクロポストを表示させるため、最初に極めてシンプルなERbテンプレートを作成します。次に、<a class="ref" href="./updating-showing-and-deleting-users.html#sec-sample_users">9.3.2</a>のサンプルデータ生成タスクにマイクロポストのサンプルを追加して、画面にサンプルデータが表示されるようにしてみます。</p>

<div class="label" id="fig-user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_microposts_mockup_bootstrap.png" alt="user_microposts_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.4</span><span class="description">マイクロポストが表示されたプロファイルページのモックアップ。<a href="../images/figures/user_microposts_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-in-sign-out.html#sec-remember_me">8.2.1</a>でサインイン機能について説明したときと同様に、<a class="ref" href="./user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>でも最初に実装をお目にかけ、次にそれらの要素を順に解説してきます (<a href="http://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF">スタック</a>に複数の要素を一括でプッシュした後、順にポップするような要領です)。しばらくの間盛り上がりに欠けるかもしれませんが、<a class="ref" href="./user-microposts.html#sec-sample_microposts">10.2.2</a>で一気に取り返しますので、それまでご辛抱願います。</p>

<div class="label" id="sec-augmenting_the_user_show_page"></div>


<h3><a id="sec-10_2_1" href="./user-microposts.html#sec-augmenting_the_user_show_page" class="heading"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></h3>


<p>ユーザーのマイクロポスト表示に対するテスト、すなわちユーザーに対するrequest specを作成するところから始めましょう。ユーザーに関連付けられているマイクロポストのファクトリーを作成し、それから表示ページが各ポストの内容を含んでいるか検証する戦略で進めます。また、<a class="ref" href="./user-microposts.html#fig-user_microposts_mockup">図 10.4</a>で示されているように, マイクロポストの総数が表示されているかどうかも検証します。</p>

<p>ポストは<code>let</code>メソッドで作成できますが、ユーザー表示ページでポストがすぐに表示されるように、<a class="ref" href="./user-microposts.html#code-micropost_ordering_test">リスト10.10</a>と同様に即座に関連付けを作成できるようにしたいと思います。そこで、今回も<code>let!</code>を使います。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のようにマイクロポストを定義したことで、<a class="ref" href="./user-microposts.html#code-user_show_microposts_test">リスト10.16</a>のコードを使って、プロファイルページの外観をテストできるようになります。</p>

<div class="label" id="code-user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.16</span> <span class="description">ユーザーの<code>show</code>ページでマイクロポストが表示されていることをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;microposts&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>count</code>メソッドは、関連付けを<em>経由して</em>使用していることに注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p><code>count</code>関連付けメソッドは賢くできていて、直接データベースでカウントを行います。特に、データベース上のマイクロポストを全部読みだしてから結果の配列に対して<code>length</code>を呼ぶような無駄なことは<em>していません</em>。そんなことをしたら、マイクロポストの数が増加するにつれて効率が低下してしまいます。代わりに、特定<code>user_id</code>に対するマイクロポストの数をデータベースに問い合わせます。それでもcountメソッドがアプリケーションのボトルネックになるようなことがあれば、さらに高速な<a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>を使うこともできます。</p>

<p><a class="ref" href="./user-microposts.html#code-user_show_microposts_test">リスト10.16</a>のテストは<a class="ref" href="./user-microposts.html#code-micropost_partial">リスト10.18</a>まではパスしませんが、<a class="ref" href="./user-microposts.html#code-user_show_microposts">リスト10.17</a>に示したように、まずはユーザープロファイルページにマイクロポストの一覧を挿入するところからアプリケーションコードの実装を開始することにしましょう。</p>

<div class="label" id="code-user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.17</span> <span class="description">ユーザーの<code>show</code>画面にマイクロポストを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>すぐにもマイクロポスト一覧の実装に取りかかりますが、その前に注意すべき点がいくつかあります。<a class="ref" href="./user-microposts.html#code-user_show_microposts">リスト10.17</a>では、<code>if @user.microposts.any?</code>を使用することによって (以前<a class="ref" href="./sign-up.html#code-errors_partial">リスト7.24</a>でも使用した) ユーザーのマイクロポストが1つもない場合に空のリストが表示されないようにしています。</p>

<p><a class="ref" href="./user-microposts.html#code-user_show_microposts">リスト10.17</a>では、以下のようにマイクロポストに対するページネーションのコードを加えていたことに注意してください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./updating-showing-and-deleting-users.html#code-will_paginate_index_view">リスト9.33</a>のユーザーインデックスページのコードと比較すると、以前は以下のように単純なコードでした。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上のコードは引数なしで動作していました。これは<code>will_paginate</code>が、Usersコントローラのコンテキストにおいて、<code>@users</code>インスタンス変数が存在していることを<em>前提としている</em>ためです。このインスタンス変数は、<a class="ref" href="./updating-showing-and-deleting-users.html#sec-pagination">9.3.3</a>でも述べたように<code>ActiveRecord::Relation</code>クラスのインスタンスです。今回の場合は、ユーザーコントローラのコンテキストにおいて、<em>マイクロポスト</em>をページネーションしたいため、明示的に<code>@microposts</code>変数を<code> will_paginate</code>に渡す必要があります。もちろん、そのような変数をユーザー<code>show</code>アクションで定義しなければなりません (<a class="ref" href="./user-microposts.html#code-user_show_microposts_instance">リスト10.19</a>)。</p>

<p>最後に、以下のようにマイクロポストの現在の数のカウントを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>


<p>前述のように、<code>@user.microposts.count</code>は、ユーザー/マイクロポスト関連付けを経由して、あるユーザーに属するマイクロポストをカウントすることを除けば、<code>User.count</code>に似ています。</p>

<p>やっとマイクロポスト一覧のコードそのものにたどり着きました。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>


<p>この<em>順序リスト</em>タグ<code>ol</code>を含むコードがマイクロポストの一覧を生成します。ただしご覧のとおり、実装の厄介な部分をマイクロポストパーシャルに任せています。<a class="ref" href="./updating-showing-and-deleting-users.html#sec-partial_refactoring">9.3.4</a>で見た以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><code>_user.html.erb</code>パーシャルを使って自動的に<code>@users</code>変数内のそれぞれのユーザーを出力します。同様に以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>まったく同じことをマイクロポストで行います。つまり、<a class="ref" href="./user-microposts.html#code-micropost_partial">リスト10.18</a>に示すように、<code>_micropost.html.erb</code>パーシャルを (<code>micropost</code>用のビューのディレクトリの中に) 定義しなければならないことを意味します。</p>

<div class="label" id="code-micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.18</span> <span class="description">1つのマイクロポストを表示するパーシャル。</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>詳細は<a class="ref" href="./user-microposts.html#sec-sample_microposts">10.2.2</a>で述べますが、上のコードでは素晴らしい<code>time_ago_in_words</code>ヘルパーメソッドを使用しています。</p>

<p>これまでのところ、関連するERbテンプレートをすべて定義したにもかかわらず、<a class="ref" href="./user-microposts.html#code-user_show_microposts_test">リスト10.16</a>のテストは、たった１つ、<code>@microposts</code>変数がないために失敗していたはずです。<a class="ref" href="./user-microposts.html#code-user_show_microposts_instance">リスト10.19</a>のように変更することで、テストにパスさせることができます。</p>

<div class="label" id="code-user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.19</span> <span class="description"><code>@microposts</code>インスタンス変数をユーザー<code>show</code>アクションに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>paginate</code>メソッドの素晴らしさに注目してください。マイクロポストの関連付けを経由して<tt>micropost</tt>テーブルに到達し、必要なマイクロポストのページを引き出してくれます。</p>

<p>ここで、今作成した新しいユーザープロファイルページ (<a class="ref" href="./user-microposts.html#fig-user_profile_no_microposts">図10.5</a>) をブラウザで見てみましょう。...何というさみしいページ、がっかりですね。マイクロポストが1つもないのでは無理もありません。ではここでマイクロポストを追加しましょう。</p>

<div class="label" id="fig-user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_profile_no_microposts_bootstrap.png" alt="user_profile_no_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.5</span><span class="description">マイクロポスト用のコードのあるユーザープロファイルページ (ただしマイクロポストがない)。<a href="../images/figures/user_profile_no_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-sample_microposts"></div>


<h3><a id="sec-10_2_2" href="./user-microposts.html#sec-sample_microposts" class="heading"><span class="number">10.2.2</span>マイクロポストのサンプル</a></h3>


<p><a class="ref" href="./user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>のユーザーマイクロポストのテンプレート作成作業の成果は、何とも拍子抜けでした。<a class="ref" href="./updating-showing-and-deleting-users.html#sec-sample_users">9.3.2</a>のサンプル生成にマイクロポストを追加し、この情けない状況を修正しましょう。<em>すべての</em>ユーザーにサンプルマイクロポストを追加しようとすると時間がかかりすぎるので、最初の6人のユーザー<sup class="footnote" id="fnref-10_3"><a href="./user-microposts.html#fn-10_3">3</a></sup>だけを選択しましょう。そのためには、<code>User.all</code>メソッドに<code>:limit</code>オプションを渡します<sup class="footnote" id="fnref-10_4"><a href="./user-microposts.html#fn-10_4">4</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>その後、各ユーザーに50のマイクロポスト (ページネーションが切り替わる30を超える数) を作成し、Faker gemの便利な<a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html">Lorem.sentence</a><tt></tt>メソッドを使って各マイクロポストのサンプルコンテンツを生成します (<code>Faker::Lorem.sentence</code>は、いわゆる<em>lorem ipsum</em>ダミーテキストを返します。<a class="ref" href="./modeling-users.html#top">第6章</a>で述べたように、<em>lorem ipsum</em>には面白い<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">裏話</a>があります)。 変更の結果は、<a class="ref" href="./user-microposts.html#code-sample_microposts">リスト10.20</a>のようなサンプルデータ生成になります。</p>

<div class="label" id="code-sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.20</span> <span class="description">サンプルデータにマイクロポスト用のコードを追加する。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もちろん、新しいサンプルデータを生成するためにはRakeタスクの<code>db:populate</code>を実行する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>それぞれのマイクロポストの情報を表示することによって、<a class="ref" href="./user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>の地道な作業がやっと報われはじめました<sup class="footnote" id="fnref-10_5"><a href="./user-microposts.html#fn-10_5">5</a></sup>。実行結果を<a class="ref" href="./user-microposts.html#fig-user_profile_microposts_no_styling">図10.6</a>に示します。</p>

<div class="label" id="fig-user_profile_microposts_no_styling"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_profile_microposts_no_styling_bootstrap.png" alt="user_profile_microposts_no_styling_bootstrap" /></span></div><div class="caption"><span class="header">図10.6</span><span class="description">ユーザープロファイル <a href="http://localhost:3000/users/1">/users/1</a> とスタイルのないマイクロポスト。<a href="../images/figures/user_profile_microposts_no_styling_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./user-microposts.html#fig-user_profile_microposts_no_styling">図10.6</a>のページにはマイクロポスト固有のスタイルが与えられていないので、<a class="ref" href="./user-microposts.html#code-micropost_css">リスト10.21</a>を追加して、結果のページを見てみましょう<sup class="footnote" id="fnref-10_6"><a href="./user-microposts.html#fn-10_6">6</a></sup>。<a class="ref" href="./user-microposts.html#fig-user_profile_with_microposts">図10.7</a>が1番目の (ログインした) ユーザーのプロファイルページで、<a class="ref" href="./user-microposts.html#fig-other_profile_with_microposts">図10.8</a>が2番目のユーザーのプロファイルページです。最後に<a class="ref" href="./user-microposts.html#fig-user_profile_microposts_page_2_rails_3">図10.9</a>は、1番目のユーザーのためのマイクロポストの<em>2番目</em>のページと、下部に改ページのリンクを表示しています。各マイクロポストの表示には、3つのどの場合にも、それが作成されてからの時間 (&quot;1分​​前に投稿&quot; など) が表示されていることに注目してください。これは<a class="ref" href="./user-microposts.html#code-micropost_partial">リスト10.18</a>の<code>time_ago_in_words</code>メソッドによるものです。数分待ってからページを再度読み込むと、このテキストは自動的に新しい時間に基づいて更新されます。</p>

<div class="label" id="code-micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.21</span> <span class="description">マイクロポスト用のCSS (この章全般にわたって使用するCSSも含む)</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_profile_with_microposts_bootstrap.png" alt="user_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.7</span><span class="description">ユーザープロファイル (<a href="http://localhost:3000/users/1">/users/1</a>) とマイクロポスト。<a href="../images/figures/user_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/other_profile_with_microposts_bootstrap.png" alt="other_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.8</span><span class="description">別ユーザーのプロファイルとマイクロポスト (<a href="http://localhost:3000/users/5">/users/5</a>)。<a href="../images/figures/other_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user_profile_microposts_page_2_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図10.9</span><span class="description">マイクロポストのページネーション用リンク (<a href="http://localhost:3000/users/1?page=2">/users/1?</a></span><span class="description"><a href="http://localhost:3000/users/1?page=2">page=2</a>). <a href="../images/figures/user_profile_microposts_page_2_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-manipulating_microposts"></div>


<h2><a id="sec-10_3" href="./user-microposts.html#sec-manipulating_microposts" class="heading"><span class="number">10.3</span>マイクロポストを操作する</a></h2>


<p>データモデリングとマイクロポスト表示テンプレートの両方が完成したので、次はWeb経由でそれらを作成するためのインターフェイスに取りかかりましょう。HTMLフォームを使用してリソース (今回の場合はMicropostsリソース) を作成する3番目の例になります<sup class="footnote" id="fnref-10_7"><a href="./user-microposts.html#fn-10_7">7</a></sup>。この節では、<em>ステータスフィード</em> (<a class="ref" href="./following-users.html#top">第11章</a>で完成させます) の最初のヒントをお見せします。最後に、ユーザーがマイクロポストをWeb経由で破棄できるようにします。</p>

<p>従来のRails開発の慣習と異なる箇所が1つあります。Micropostsリソースへのインターフェイスは、主にユーザーと静的ページのコントローラを経由して実行されるので、Micropostsコントローラには<code>new</code>や<code>edit</code>のようなアクションは不要ということになります。<code>create</code>と<code>destroy</code>があれば十分です。従って、<a class="ref" href="./user-microposts.html#code-microposts_resource">リスト10.22</a>に示すように、Micropostsリソースへのルーティングは一層シンプルになります。その結果、<a class="ref" href="./user-microposts.html#code-microposts_resource">リスト10.22</a>のコードは、フルセットのルーティング (<a class="ref" href="./a-demo-app.html#table-demo_RESTful_microposts">表2.3</a>) のサブセットであるRESTfulルート (<a class="ref" href="./user-microposts.html#table-RESTful_microposts">表10.2</a>) になります。もちろん、シンプルになったということは完成度が<em>さらに</em>高まったということの証しであり、退化したわけではありません。<a class="ref" href="./a-demo-app.html#top">第2章</a>でscaffoldに頼りきりだった頃からここに至るまでは長い道のりでしたが、今ではscaffoldが生成するような複雑なコードはほとんど不要になりました。</p>

<div class="label" id="code-microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.22</span> <span class="description">Micropostsリソース用のルーティング。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table-RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">新しいマイクロポストを作る</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">id<code>1</code>のマイクロポストを削除する</td></tr></table></div><div class="caption"><span class="header">表10.2</span><span class="description">Micropostsリソースが提供する<a class="ref" href="./user-microposts.html#code-microposts_resource">リスト10.22</a>のRESTfulルート。</span></div></div>




<div class="label" id="sec-access_control"></div>


<h3><a id="sec-10_3_1" href="./user-microposts.html#sec-access_control" class="heading"><span class="number">10.3.1</span>アクセス制御</a></h3>


<p>Micropostsリソースの開発の手始めは、Micropostsコントローラ内のアクセス制御から始めることにしましょう。ここでのアクセス制御のポイントは単純です。<code>create</code>アクションと<code>destory</code>アクションは、いずれもユーザーがサインインしていなければ実行できないものとします。これをテストするためのRSpecコードを<a class="ref" href="./user-microposts.html#code-micropost_access_control">リスト10.23</a>に示します (マイクロポストをポストしたユーザーだけが削除できるようにする3番目の保護は<a class="ref" href="./user-microposts.html#sec-destroying_microposts">10.3.4</a>で追加します)。</p>

<div class="label" id="code-micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.23</span> <span class="description">マイクロポスト用のアクセス制御テスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Microposts controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>未制作のマイクロポストのWebインターフェースと違い、<a class="ref" href="./user-microposts.html#code-micropost_access_control">リスト10.23</a>のコードは、<a class="ref" href="./updating-showing-and-deleting-users.html#code-edit_update_wrong_user_tests">リスト9.13</a>のときの手法と同様に、それぞれのマイクロポストアクションのレベルで動作します。サインインしていないユーザーは、<tt>POST</tt>リクエストを/microposts (<code>post microposts_path</code>、<code>create</code>アクションが呼び出される) に送信した場合、または <tt>DELETE</tt>リクエストを/microposts/1 (<code>delete micropost_path(micropost)</code>、<code>destroy</code>アクションが呼び出される) に送信した場合にリダイレクトされます。</p>

<p><a class="ref" href="./user-microposts.html#code-micropost_access_control">リスト10.23</a>のテストにパスするためのアプリケーションコードを作成する前に、少しリファクタリングを行いましょう。 <a class="ref" href="./updating-showing-and-deleting-users.html#sec-requiring_signed_in_users">9.2.1</a>では、<code>signed_in_user</code>メソッドと呼ばれるbefore_actionを使用して、サインインを必須にしたことを思い出してください (<a class="ref" href="./updating-showing-and-deleting-users.html#code-authorize_before_filter">リスト9.12</a>)。あのときは、このメソッドをUsersコントローラでしか使用しませんでしたが、今回はMicropostsコントローラでもこのメソッドが必要となることがわかったので、<a class="ref" href="./user-microposts.html#code-sessions_helper_authenticate">リスト10.24</a>に示すように、セッションヘルパーに移動します<sup class="footnote" id="fnref-10_8"><a href="./user-microposts.html#fn-10_8">8</a></sup>。</p>

<div class="label" id="code-sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.24</span> <span class="description"><code>signed_in_user</code>メソッドをセッションヘルパーに移動する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コードが重複しないよう、<code>signed_in_user</code>をUsersコントローラからも削除しておきましょう。</p>

<p><a class="ref" href="./user-microposts.html#code-sessions_helper_authenticate">リスト10.24</a>のコードにより、<code>signed_in_user</code> メソッドがMicropostsコントローラで利用可能になりました。これにより、<a class="ref" href="./user-microposts.html#code-microposts_controller_access_control">リスト10.25</a>で示すように<code>create</code>アクションと<code>destroy</code>アクションに対してbefore_actionを使用してアクセス制限をかけることが可能になりました (注意: Micropostsコントローラファイルをコマンドラインで生成していなかったので、このコントローラを手動で作成する必要があります)。</p>

<div class="label" id="code-microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.25</span> <span class="description">Micropostsコントローラのアクションに認証を追加する。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>before_actionはデフォルトで両方のアクションに適用されるため、制限を適用するアクションを明示していないことに注意してください。もし仮に<code>index</code>アクションを追加し、サインインしていないユーザーでもアクセス可能にしたい場合は、以下のようにindexアクション以外のアクションを明示的に指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これでテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-creating_microposts"></div>


<h3><a id="sec-10_3_2" href="./user-microposts.html#sec-creating_microposts" class="heading"><span class="number">10.3.2</span>マイクロポストを作成する</a></h3>


<p><a class="ref" href="./sign-up.html#top">第7章</a>では、HTTP <tt>POST</tt>リクエストをUsersコントローラの<code>create</code>アクションに発行するHTMLフォームを作成することで、ユーザーのサインアップを実装しました。マイクロポスト作成の実装もこれと似ています。主な違いは、別の micropost/new ページを使う代わりに、(Twitterに習って) ホームページ自体 (つまりルートパス) にフォームを置くという点です (<a class="ref" href="./user-microposts.html#fig-home_page_with_micropost_form_mockup">図10.10</a>のモックアップ参照)。</p>

<div class="label" id="fig-home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="home_page_with_micropost_form_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.10</span><span class="description">マイクロポスト作成フォームのあるホームページのモックアップ。<a href="../images/figures/home_page_with_micropost_form_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最後にホームページを実装したときは (<a class="ref" href="./filling-in-the-layout.html#fig-sample_app_logo">図5.6</a>)、[Sign up now!] ボタンが中央にありました。マイクロポスト作成フォームは、サインインしている特定のユーザーのコンテキストでのみ機能するので、この節の一つの目標は、ユーザーのサインインの状態に応じて、ホームページの表示を変更することです。実装は<a class="ref" href="./user-microposts.html#code-microposts_home_page">リスト10.28</a>で行いますが、先にテストを作成しましょう。Usersリソースの場合と同様に、結合テストを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div>
</div>


<p>従って、マイクロポスト作成のテストは、<a class="ref" href="./sign-up.html#code-basic_signup_tests">リスト7.16</a>のユーザー作成用テストと似ています。このテストを<a class="ref" href="./user-microposts.html#code-microposts_create_tests">リスト10.26</a>に示します。</p>

<div class="label" id="code-microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.26</span> <span class="description">マイクロポスト作成のテスト。</span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;micropost creation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;error messages&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">&#39;micropost_content&#39;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Lorem ipsum&quot;</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">&quot;should create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次に、マイクロポストの<code>create</code>アクションを作成しましょう。このアクションも、<a class="ref" href="./sign-up.html#code-user_create_action">リスト7.26</a>のユーザー用アクションと似ています。違いは、新しいマイクロポストを<code>build</code>するためにuser/micropost関連付けを使用している点です (<a class="ref" href="./user-microposts.html#code-microposts_create_action">リスト10.27</a>)。<code>micropost_params</code>でStrong Parametersを使用していることにより、マイクロポストのコンテンツだけがWeb経由で編集可能になっていることに注目してください。</p>

<div class="label" id="code-microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.27</span> <span class="description">Micropostsコントローラの<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイクロポスト作成フォームを構築するために、サイト訪問者がサインインしているかどうかに応じて異なるHTMLを提供するコードを使用します (<a class="ref" href="./user-microposts.html#code-microposts_home_page">リスト10.28</a>)。</p>

<div class="label" id="code-microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.28</span> <span class="description">Homeページ (<a href="http://localhost:3000/">/</a>) にマイクロポスト作成を追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.jp/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span>
                                <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p> <code>if</code>-<code>else</code>分岐を使用してコードを書き分けている点が少し汚いですが、このコードのクリーンアップは演習に回すことにします (<a class="ref" href="./user-microposts.html#sec-micropost_exercises">10.5</a>)。なお、<a class="ref" href="./user-microposts.html#code-microposts_home_page">リスト10.28</a>で使用するパーシャルの実装は必須なので、演習にはしません。新しいホームページのサイドバーは<a class="ref" href="./user-microposts.html#code-user_info">リスト 10.29</a>で、マイクロポストフォームのパーシャルは <a class="ref" href="./user-microposts.html#code-micropost_form">リスト 10.30</a>で実装します。</p>

<div class="label" id="code-user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.29</span> <span class="description">ユーザー情報サイドバーのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_user_info.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;micropost&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./updating-showing-and-deleting-users.html#code-user_index_view">リスト9.24</a>と同様、<a class="ref" href="./user-microposts.html#code-user_info">リスト10.29</a>のコードでも<a class="ref" href="./sign-up.html#code-gravatar_option">リスト7.30</a>で定義した<code>gravatar_for</code>ヘルパーを使用します。</p>

<p>プロファイルサイドバー (<a class="ref" href="./user-microposts.html#code-user_show_microposts">リスト10.17</a>) のときと同様、<a class="ref" href="./user-microposts.html#code-user_info">リスト10.29</a>のユーザー情報にも、そのユーザーが投稿したマイクロポストの総数が表示されていることに注目してください。ただし少し表示に違いがあります。プロファイルサイドバーでは、 “Microposts” をラベルとし、“Microposts (1)” と表示することは問題ありません。しかし今回のように “1 microposts” と表示してしまうと英語の文法上誤りになってしまうので、<code>pluralize</code>メソッドを使用して “1 micropost” や “2 microposts” と表示するように調整します。</p>

<p>次はマイクロポスト作成フォームを定義します (<a class="ref" href="./user-microposts.html#code-micropost_form">リスト10.30</a>)。これはユーザー登録フォームに似ています (<a class="ref" href="./sign-up.html#code-signup_form">リスト7.17</a>)。</p>

<div class="label" id="code-micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.30</span> <span class="description">マイクロポスト作成フォームのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_micropost_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder:</span> <span class="s2">&quot;Compose new micropost...&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Post&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./user-microposts.html#code-micropost_form">リスト10.30</a>のフォームが動くようにするためには、2箇所の変更が必要です。1つは、(以前と同様) 関連付けを使用して以下のように<code>@micropost</code>を定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>変更の結果を<a class="ref" href="./user-microposts.html#code-micropost_instance_variable">リスト10.31</a>に示します。</p>

<div class="label" id="code-micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.31</span> <span class="description"><code>home</code>アクションにマイクロポストのインスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./user-microposts.html#code-micropost_instance_variable">リスト10.31</a>のコードは、ユーザーへのサインイン要求を実装し忘れた場合に、テストが失敗して知らせてくれるので助かります。</p>

<p><a class="ref" href="./user-microposts.html#code-micropost_form">リスト10.30</a>を動かすための第2の変更は、以下のようにエラーメッセージパーシャルを再定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up.html#code-f_error_messages">リスト7.23</a>ではエラーメッセージパーシャルが<code>@user</code>変数を直接参照していたことを思い出してください。今回は代わりに<code>@micropost</code>変数を使う必要があります。どのような種類のオブジェクトを渡されてもエラーメッセージパーシャルが動くようにする必要があります。幸い、フォーム変数<code>f</code>を<code>f.object</code>とすることによって、関連付けられたオブジェクトにアクセスすることができます。従って、以下のコードの場合</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code>は<code>@user</code>となり、以下のコードの場合は</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code>は<code>@micropost</code>となります。</p>

<p>パーシャルにオブジェクトを渡すために、値がオブジェクトで、キーがパーシャルでの変数名と同じハッシュを利用します。これで、以下のコードが完成します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>言い換えると、<code>object: f.object</code>は<code>error_messages</code>パーシャルの中で<code>object</code>という変数名を作成します。<a class="ref" href="./user-microposts.html#code-updated_error_messages_partial">リスト10.32</a>に示すように、このobject変数を使用してカスタムエラーメッセージを作成できます。</p>

<div class="label" id="code-updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.32</span> <span class="description">他のオブジェクトでも動作するように<a class="ref" href="./sign-up.html#code-errors_partial">リスト7.24</a>のエラーメッセージパーシャルを更新する。</span><br /><span class="description"> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>この時点で、<a class="ref" href="./user-microposts.html#code-microposts_create_tests">リスト10.26</a>のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>


<p>残念ながら、サインアップと編集フォームが古いバージョンのメッセージパーシャルを利用しているため、Userのrequest specが壊れてしまいました。これを修正するために、<a class="ref" href="./user-microposts.html#code-signup_errors_updated">リスト10.33</a>および<a class="ref" href="./user-microposts.html#code-edit_errors_updated">リスト10.34</a>で示すように、これらのフォームをより汎用的なバージョンに更新します。(<em>注</em>: もし<a class="ref" href="./updating-showing-and-deleting-users.html#sec-updating_deleting_exercises">9.6</a>の演習で、<a class="ref" href="./updating-showing-and-deleting-users.html#code-new_edit_partial">リスト9.49</a>および<a class="ref" href="./updating-showing-and-deleting-users.html#code-new_user_with_partial">リスト9.50</a>のコードを「<a href="http://ja.wikipedia.org/wiki/%E6%BA%96%E7%94%A8%E3%83%BB%E9%A1%9E%E6%8E%A8%E9%81%A9%E7%94%A8">必要に応じて流用 (<em>Mutatis mutandis</em>)</a>」して実装していた場合、異なるコードを使用する必要があります。)</p>

<div class="label" id="code-signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.33</span> <span class="description">ユーザーサインアップエラーの表示を更新する。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-edit_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.34</span> <span class="description">ユーザー編集のエラーを更新する。</span><br /><span class="description"> <code>app/views/users/edit.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>この時点で、すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>さらに、この章で作成したすべてのHTMLが適切に表示されるようになったはずです。最終的なフォームを<a class="ref" href="./user-microposts.html#fig-home_with_form">図10.11</a>に、投稿エラーが表示されたフォームを<a class="ref" href="./user-microposts.html#fig-home_form_errors">図10.12</a>に示します。この時点で、新しい投稿を自分自身で作成し、すべてが正しく動いていることを確認することもできます。ただし、できれば<a class="ref" href="./user-microposts.html#sec-a_proto_feed">10.3.3</a>が終わってからにしてください。</p>

<div class="label" id="fig-home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_with_form_bootstrap.png" alt="home_with_form_bootstrap" /></span></div><div class="caption"><span class="header">図10.11</span><span class="description">新しいマイクロポストフォームのあるHomeページ (<a href="http://localhost:3000/">/</a>)。<a href="../images/figures/home_with_form_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_form_errors_bootstrap.png" alt="home_form_errors_bootstrap" /></span></div><div class="caption"><span class="header">図10.12</span><span class="description">エラーが表示されたHomeページ。<a href="../images/figures/home_form_errors_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_proto_feed"></div>


<h3><a id="sec-10_3_3" href="./user-microposts.html#sec-a_proto_feed" class="heading"><span class="number">10.3.3</span>フィードの原型</a></h3>


<p><a class="ref" href="./user-microposts.html#sec-creating_microposts">10.3.2</a>の最後のコメントでも言及しましたが、現在のHomeページにはマイクロポストが1つも表示されていません。<a class="ref" href="./user-microposts.html#fig-home_with_form">図10.11</a>のフォームが正しく動作しているかどうかを確認したい場合、正しいエントリーを投稿した後、<a href="http://localhost:3000/users/1">プロファイルページ</a>に移動してポストを表示すればよいのですが、これはかなり面倒な作業です。 <a class="ref" href="./user-microposts.html#fig-proto_feed_mockup">図10.13</a>のモックアップで示したような、ユーザー自身のポストを含むマイクロポスト<em>フィード</em>がないと不便です (<a class="ref" href="./following-users.html#top">第11章</a>ではフィードを汎用化し、現在のユーザーによって<em>フォローされている</em>ユーザーのマイクロポストも一緒に表示するフィードにする予定です)。</p>

<div class="label" id="fig-proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/proto_feed_mockup_bootstrap.png" alt="proto_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.13</span><span class="description"> (プロト)フィードのあるホームページのモックアップ。<a href="../images/figures/proto_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>すべてのユーザーがフィードを持つので、<code>feed</code>メソッドはUserモデルに作るのが自然です。最終的にはそのfeedメソッドが、フォローしているユーザーのマイクロポストも返すことをテストしますが、今は、<code>feed</code>メソッドが自分のマイクロポストは<em>含むが</em>他ユーザーのマイクロポストは<em>含まない</em>ことをテストすることにします。その要件をコード化したものを<a class="ref" href="./user-microposts.html#code-feed_specs">リスト10.35</a>に示します。</p>

<div class="label" id="code-feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.35</span> <span class="description">(プロト) ステータスフィードのテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストでは、与えられた要素が配列に含まれているかどうかをチェックする<code>include?</code>メソッドを使用しています<sup class="footnote" id="fnref-10_9"><a href="./user-microposts.html#fn-10_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">foo&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">baz&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>上の例は、RSpecの論理値変換機能の柔軟性が極めて高いことを示しています。<code>include</code>メソッドは本来、モジュールをインクルードするために使用するRubyキーワードであるにもかかわらず (<a class="ref" href="./sign-in-sign-out.html#code-sessions_helper_include">リスト8.14</a>など)、このRSpecのコンテキストでは配列が要素を含んでいるかどうかをテストしたいという開発者の意図を正確に推測してくれます。</p>

<p><a class="ref" href="./user-microposts.html#code-proto_status_feed">リスト10.36</a>で示すように、<code>user_id</code>が現在のユーザーidと等しいマイクロポストを見つけることによって、適切なマイクロポストの<code>feed</code>メソッドを実装することができます。これは<code>Micropost</code>モデルで<code>where</code>メソッドを使用することで実現できます<sup class="footnote" id="fnref-10_10"><a href="./user-microposts.html#fn-10_10">10</a></sup>。</p>

<div class="label" id="code-proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.36</span> <span class="description">マイクロポストステータスフィードの実装を準備する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># このコードは準備段階です。
    # </span><span class="c1">完全な実装は第11章「ユーザーをフォローする」を参照してください。</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のコードで使用されている疑問符は、セキュリティ上重要な役割を果たしています。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>上の疑問符があることで、SQLクエリにインクルードされる前に<code>id</code>が適切に<em>エスケープ</em>されることを保証してくれるため、<a href="http://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><em>SQLインジェクション</em></a>と呼ばれる深刻なセキュリティホールを避けることができます。この場合の<code>id</code>属性は単なる整数であるため危険はありませんが、SQL文にインクルードされる変数を<em>常に</em>エスケープする習慣はぜひ身につけてください。</p>

<p>注意深い読者は、<a class="ref" href="./user-microposts.html#code-proto_status_feed">リスト10.36</a>のコードは本質的に以下のコードと同等であることに気付くかもしれません。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードを使用せずに<a class="ref" href="./user-microposts.html#code-proto_status_feed">リスト10.36</a>のコードを利用したのは、<a class="ref" href="./following-users.html#top">第11章</a>で必要となるフルステータスフィードで応用が効くためです。</p>

<p>ステータスフィードの表示をテストするために、まずいくつかのマイクロポストを作成し、それぞれのページに表示されるリスト要素 (<code>li</code>)を検証します(<a class="ref" href="./user-microposts.html#code-home_page_feed_test">リスト10.37</a>)。</p>

<div class="label" id="code-home_page_feed_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.37</span> <span class="description">ホームページのフィード表示をテストする。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Dolor sit amet&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./user-microposts.html#code-home_page_feed_test">リスト10.37</a>のコードでは、以下のように各フィード項目が固有のCSS idを持つことを前提にしています。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>


<p>それにより、上のコードが各アイテムに対してマッチするようにするのが目的です (<code>li##{item.id}</code>の最初の<code>#</code> は CSS idを示す Capybara独自の文法で、2番目の<code>#</code>は Rubyの式展開<code>#{}</code>の先頭部分であることに注意してください)。</p>

<p>サンプルアプリケーションでフィードを使うために、カレントユーザーの (ページネーション) フィードに<code>@feed_items</code>インスタンス変数を追加し (<a class="ref" href="./user-microposts.html#code-feed_instance_variable">リスト10.38</a>)、次にフィードパーシャル (<a class="ref" href="./user-microposts.html#code-feed_partial">リスト10.39</a>) をHomeページに追加します (<a class="ref" href="./user-microposts.html#code-home_with_feed">リスト10.41</a>)。(ページネーションのテストは演習に回すことにします。<a class="ref" href="./user-microposts.html#sec-micropost_exercises">10.5</a>参照)。</p>

<div class="label" id="code-feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.38</span> <span class="description"><code>home</code>アクションにフィードのインスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.39</span> <span class="description">ステータスフィードのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_feed.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ステータスフィードのパーシャルは以下のコードを使うという点で、フィードアイテムのパーシャルに表示されるフィードアイテムと異なります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>ここでは、フィードアイテムとして<code>:collection</code>パラメーターを渡しているので、<code>render</code>はコレクションの各アイテムを表示するために与えられたパーシャル (この場合は<code>’feed_item’</code>)を使用してくれます。(以前の表示では、<code>render ’shared/micropost’</code>のように<code>:partial</code>パラメーターを省略していましたが、<code>:collection</code>パラメーターがある場合はこの記法では正常に動作しません。) フィードアイテムのパーシャルを<a class="ref" href="./user-microposts.html#code-feed_item_partial">リスト10.40</a>に示します。</p>

<div class="label" id="code-feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.40</span> <span class="description">単一のフィードアイテム用のパーシャル</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./user-microposts.html#code-feed_item_partial">リスト10.40</a>は、以下のコードを使用して各フィードにCSS idも追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>これは<a class="ref" href="./user-microposts.html#code-home_page_feed_test">リスト10.37</a>のテストで要求されていたものです。</p>

<p>後は、いつものようにフィードパーシャルを表示すればHomeページにフィードを追加できます (<a class="ref" href="./user-microposts.html#code-home_with_feed">リスト10.41</a>)。この結果はホームページのフィードとして表示されます (<a class="ref" href="./user-microposts.html#fig-home_with_proto_feed">図10.14</a>)。</p>

<div class="label" id="code-home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.41</span> <span class="description">Homeページにステータスフィードを追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/feed&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_with_proto_feed_bootstrap.png" alt="home_with_proto_feed_bootstrap" /></span></div><div class="caption"><span class="header">図10.14</span><span class="description"> (プロト) フィードのあるホームページ(<a href="http://localhost:3000/">/</a>)。<a href="../images/figures/home_with_proto_feed-full.png">(拡大)</a></span></div></div>


<p>現時点では、新しいマイクロポストの作成は<a class="ref" href="./user-microposts.html#fig-micropost_created">図10.15</a>で示したように期待どおりに動作しています。ただしささいなことではありますが、マイクロポストの投稿が<em>失敗する</em>と、 Homeページは<code>@feed_items</code>インスタンス変数を期待しているため、現状では壊れてしまいます (このことはテストスイートを実行して確認できます)。最も簡単な解決方法は、<a class="ref" href="./user-microposts.html#code-microposts_create_action_with_feed">リスト10.42</a>のように空の配列を渡しておくことです<sup class="footnote" id="fnref-10_11"><a href="./user-microposts.html#fn-10_11">11</a></sup>。</p>

<div class="label" id="fig-micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/micropost_created_bootstrap.png" alt="micropost_created_bootstrap" /></span></div><div class="caption"><span class="header">図10.15</span><span class="description">新しいマイクロポストを作成後のHomeページ。<a href="../images/figures/micropost_created_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.42</span> <span class="description"><code>create</code>アクションに (空の) <code>@feed_items</code>インスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、(プロト)フィードとそのテストはすべて動くはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_microposts"></div>


<h3><a id="sec-10_3_4" href="./user-microposts.html#sec-destroying_microposts" class="heading"><span class="number">10.3.4</span>マイクロポストを削除する</a></h3>


<p>最後の機能として、マイクロポストリソースにポストを削除する機能を追加します。これはユーザー削除と同様に(<a class="ref" href="./updating-showing-and-deleting-users.html#sec-the_destroy_action">9.4.2</a>)、&quot;delete&quot; リンクで実現します (<a class="ref" href="./user-microposts.html#fig-micropost_delete_links_mockup">図10.16</a>)。ユーザーの削除は管理者ユーザーのみが行えるように制限されていたのに対し、今回の場合はカレントユーザーが作成したマイクロポストに対してのみ削除リンクが動作するようにします。</p>

<div class="label" id="fig-micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/micropost_delete_links_mockup_bootstrap.png" alt="micropost_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.16</span><span class="description">マイクロポストの削除リンクと (プロト) フィードのモックアップ。<a href="../images/figures/micropost_delete_links_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最初のステップとして、<a class="ref" href="./user-microposts.html#code-feed_item_partial">リスト10.40</a>のマイクロポストパーシャルに削除リンクを追加します。同様に、<a class="ref" href="./user-microposts.html#code-feed_item_partial">リスト10.40</a>のフィードアイテムパーシャルにリンクを追加します。追加の結果を<a class="ref" href="./user-microposts.html#code-micropost_partial_with_delete">リスト10.43</a>および<a class="ref" href="./user-microposts.html#code-feed_item_partial_with_delete">リスト10.44</a>に示します (これら2つはほとんど同一です。重複コードの削除は演習に回すことにします (<a class="ref" href="./user-microposts.html#sec-micropost_exercises">10.5</a>))。</p>

<div class="label" id="code-micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.43</span> <span class="description">マイクロポストパーシャルに削除リンクを追加する。</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_item_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.44</span> <span class="description">フィードアイテムパーシャルに削除リンクを追加する。</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>マイクロポスト削除をテストするには、Capybaraを使用して &quot;delete&quot; リンクをクリックし、マイクロポストのカウントが1減っていることを確認します (<a class="ref" href="./user-microposts.html#code-micropost_destroy_specs">リスト10.45</a>)。</p>

<div class="label" id="code-micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.45</span> <span class="description">Micropostsコントローラの<code>destroy</code>アクションをテストする。</span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost destruction&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;as correct user&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should delete a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;delete&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./updating-showing-and-deleting-users.html#code-admin_destroy_before_filter">リスト9.46</a>のユーザー用アプリケーションコードと似ていますが、最も大きく異なるのは、マイクロポストの場合は、カレントユーザーが実際に指定のidのマイクロポストを持っているのかをチェックするのに<code>admin_user</code> before_actionではなく、 <code>correct_user</code> before_actionを使用している点です。コードを<a class="ref" href="./user-microposts.html#code-microposts_destroy_action">リスト10.46</a>に示します。2番目に新しいポストを削除した場合の結果を<a class="ref" href="./user-microposts.html#fig-home_post_delete">図10.17</a>に示します。</p>

<div class="label" id="code-microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.46</span> <span class="description">マイクロポストコントローラの<code>destroy</code>アクション。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>correct_user</code> before_actionでは、マイクロポストを以下のように関連付けを<em>経由して</em>見つけていることに注目してください。
</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>これによって、カレントユーザーに所属するマイクロポストだけが自動的に見つかることが保証されます。この場合、  <code>find</code>ではなく<code>find_by</code>を使用します。これは、前者ではマイクロポストがない場合に例外が発生しますが、後者は<code>nil</code>を返すためです。ところで、Rubyの例外処理に慣れている方なら、<code>correct_user</code>のフィルタを以下のように書くこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div>
</div>


<p><code>Micropost</code>モデルを以下のように直接使用して<code>correct_user</code>フィルタを実装することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>上のコードは<a class="ref" href="./user-microposts.html#code-microposts_destroy_action">リスト10.46</a>のコードと同等だと思うかもしれませんが、<a href="http://www.rubyfocus.biz/">Wolfram Arnold</a>がブログ記事「<a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">RailsにおけるAccess Control 101とシティバンクでのハッキング事件</a> (英語)」で解説しているように、対象を探しだすときには常に関連付けを経由することをセキュリティの観点から強くお勧めいたします。</p>

<div class="label" id="fig-home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_post_delete_bootstrap.png" alt="home_post_delete_bootstrap" /></span></div><div class="caption"><span class="header">図10.17</span><span class="description">2番目に新しいマイクロポストを削除した後のユーザーHomeページ。<a href="../images/figures/home_post_delete_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この節のコードで、Micropostモデルとインターフェイスが完成しました。すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec-10_4" href="./user-microposts.html#sec-10_4" class="heading"><span class="number">10.4</span>最後に</a></h2>


<p>Micropostsリソースの追加によって、サンプルアプリケーションはほぼ完成に近づきました。残すところは、ユーザーをお互いにフォローするソーシャルレイヤーのみとなりました。<a class="ref" href="./following-users.html#top">第11章</a>では、そのようなユーザー同士の関係 (リレーションシップ) をモデリングする方法を学び、それがステータスフィードにどのように関連するかを学びます。</p>

<p>Gitバージョン管理を使用している方は、次に進む前に変更をマージしてコミットすることを忘れないでください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user microposts&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div>
</div>


<p>この時点でHerokuにアプリをプッシュしてもよいでしょう。<code>microposts</code>テーブルを追加するためにデータモデルを変更したので、本番データベースをマイグレートする必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec-micropost_exercises"></div>


<h2><a id="sec-10_5" href="./user-microposts.html#sec-micropost_exercises" class="heading"><span class="number">10.5</span>演習</a></h2>


<p>ここまでに数多くの題材を取り上げてきましたので、今やアプリケーションを拡張する方法は山ほどあります。以下は、その中のごくわずかに過ぎません。</p>

<ol>
<li>サイドバーのマイクロポストカウントのテストを追加してください。このとき、表示に単数形と複数形が正しく表示されているかどうかもテストしてください。</li>
<li>マイクロポストのページネーションのテストを追加してください。</li>
<li><code>if</code>-<code>else</code>文の2つの分岐に対して、それぞれ異なるパーシャルを使用するようにホームページをリファクタリングしてください。</li>
<li>削除リンクが、現在のユーザーによって作成されていないマイクロポストには表示されないことを確認するためのテストを作成してください。</li>
<li>パーシャルを使用して、<a class="ref" href="./user-microposts.html#code-micropost_partial_with_delete">リスト10.43</a>および<a class="ref" href="./user-microposts.html#code-feed_item_partial_with_delete">リスト10.44</a>から削除リンクの重複を削除してください。</li>
<li><a class="ref" href="./user-microposts.html#fig-long_word_micropost">図10.18</a>に示すように、非常に長い単語を入力するとレイアウトが崩れてしまいます。<a class="ref" href="./user-microposts.html#code-wrap">リスト10.47</a>で定義した<code>wrap</code>ヘルパーを使用して、この問題を修正してください。このとき、出力されたHTMLがRailsによってエスケープされるのを防ぐために<code>raw</code>メソッドを使用してください。また、クロスサイトスクリプティング (XSS) を防ぐために<code>sanitize</code>メソッドも使用してください。さらに、このコードでは<em>3項演算子</em> (<a class="ref" href="./user-microposts.html#sidebar-ternary_operator">コラム  10.1</a>) も使用してください。3項演算子は一見奇妙ですが、極めて便利なものです。</li>
<li><strong>(チャレンジ)</strong> 入力できる残り文字数を140 文字からカウントダウンするためのJavaScriptをHomeページに追加してください。</li>
</ol>




<div class="label" id="sidebar-ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 10.1</span><span class="description">10種類の人々</span></span>
<p>この世には10種類の人々がいます。3項演算子を好きな人、嫌いな人、3項演算子を知らない人です。(もし3番目に該当したとしても、すぐそのカテゴリの人ではなくなりますので心配ご無用です。)</p>

<p>プログラミング経験を重ねるうちに、以下のような制御フローが最もよく使用される、ありふれたものであることはすぐにわかると思います。</p>

<pre class="verbatim">  if boolean?
    何かをする
  else
    別のことをする
  end</pre>


<p>Rubyや他の言語 (C/C++、Perl、PHP、Javaなど) では、上のようなフローをよりコンパクトな<em>3項演算子</em>と呼ばれる表現で置き換えることができます (3つの部分から構成されるためそのように呼ばれます)。</p>

<pre class="verbatim">  boolean? ? 何かをする : 別のことをする</pre>


<p>また、3項演算子で代入文を置き換えることもできます。</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
  end</pre>


<p>上のコードは以下のように1行で書けます。</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>他に、関数の戻り値で使用することもよくあります。</p>

<pre class="verbatim">  def foo
    do_stuff
    boolean? ? &quot;bar&quot; : &quot;baz&quot;
  end</pre>


<p>Rubyは暗黙的に関数の最後の式の値を返すので、ここでは<tt>foo</tt>メソッドは<tt>boolean?</tt>の値によって<tt>&quot;bar&quot;</tt>または<tt>&quot;baz&quot;</tt>を返します。この手法は<a class="ref" href="./user-microposts.html#code-wrap">リスト10.47</a>の最後の部分でも使用しています。</p>
</div>




<div class="label" id="fig-long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/long_word_micropost_bootstrap.png" alt="long_word_micropost_bootstrap" /></span></div><div class="caption"><span class="header">図10.18</span><span class="description">非常に長い単語によって崩れたレイアウト。<a href="../images/figures/long_word_micropost_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.47</span> <span class="description">長い単語をラップさせるヘルパー。</span><br /><span class="description"> <code>app/helpers/microposts_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">&quot;&amp;#8203;&quot;</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span>
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="./updating-showing-and-deleting-users.html#top">
</a><a class="prev_page" href="./updating-showing-and-deleting-users.html#top">    « <span class="number">第9章</span> ユーザーの更新・表示・削除
</a><a class="prev_page" href="./updating-showing-and-deleting-users.html#top">  </a>
  <a class="next_page" href="./following-users.html#top">
</a><a class="next_page" href="./following-users.html#top">    <span class="number">第11章</span>ユーザーをフォローする »
</a><a class="next_page" href="./following-users.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-10_1">技術的には、<a class="ref" href="./sign-in-sign-out.html#top">第8章</a>でセッションをリソースとして扱いましたが、セッションはユーザーやマイクロポストと異なり、データベースには保存されません。<a class="arrow" href="./user-microposts.html#fnref-10_1">↑</a></li>
<li id="fn-10_2"><code>content</code>属性は<code>string</code>型になりますが、 <a class="ref" href="./a-demo-app.html#sec-modeling_demo_microposts">2.1.2</a>で簡単に述べたように、長文用のテキストフィールドには<code>text</code>型を使用してください。<a class="arrow" href="./user-microposts.html#fnref-10_2">↑</a></li>
<li id="fn-10_3">(ここではカスタムGravatarを持つ5人のユーザーと、デフォルトGravatarを持つ1人のユーザー) <a class="arrow" href="./user-microposts.html#fnref-10_3">↑</a></li>
<li id="fn-10_4">もしこのメソッドが生成するSQLに興味があるのであれば、<code>log/development.log</code>をtailしてみてください (コマンドラインでファイルにtailコマンドを実行するという意味)。 <a class="arrow" href="./user-microposts.html#fnref-10_4">↑</a></li>
<li id="fn-10_5">Faker gemの<em>lorem ipsum</em>サンプルテキストはランダムに生成される仕様になっているため、サンプルマイクロポストの内容はこの図と違っているはずです。<a class="arrow" href="./user-microposts.html#fnref-10_5">↑</a></li>
<li id="fn-10_6">便宜上、<a class="ref" href="./user-microposts.html#code-micropost_css">リスト10.21</a>はこの章で必要なCSSを<em>すべて</em>含んでいます。<a class="arrow" href="./user-microposts.html#fnref-10_6">↑</a></li>
<li id="fn-10_7">他の2つのリソースとは、<a class="ref" href="./sign-up.html#sec-signup_form">7.2</a>のUsersリソースと<a class="ref" href="./sign-in-sign-out.html#sec-signin_failure">8.1</a>のSessionsリソースです。<a class="arrow" href="./user-microposts.html#fnref-10_7">↑</a></li>
<li id="fn-10_8"><a class="ref" href="./sign-in-sign-out.html#sec-remember_me">8.2.1</a>で、ヘルパーメソッドはデフォルトでは<em>ビュー</em>でのみ利用可能であると説明しましたが、<code>include SessionsHelper</code>をApplicationコントローラに追加してコントローラでも利用できるようにしました (<a class="ref" href="./sign-in-sign-out.html#code-sessions_helper_include">リスト8.14</a>)。<a class="arrow" href="./user-microposts.html#fnref-10_8">↑</a></li>
<li id="fn-10_9"><a class="ref" href="./beginning.html#sec-comments_for_various_readers">1.1.1</a>で、本書を読み終わったら次に純粋なRubyの本を読む事を薦めましたが、これは、<code>include?</code>などのメソッドを学んでいただきたいからというのが理由の一つです。<a class="arrow" href="./user-microposts.html#fnref-10_9">↑</a></li>
<li id="fn-10_10"><code>where</code>やlikeの詳細については、Railsガイドの「<a href="http://railsguides.jp/active_record_querying.html">Active Record クエリインターフェイス</a>」を参照してください。<a class="arrow" href="./user-microposts.html#fnref-10_10">↑</a></li>
<li id="fn-10_11">残念ですが、この場合はページ分割されたフィードを返してもうまく動きません。動かない理由を確認したい方は、実際に実装してページネーションリンクをクリックしてみてください。<a class="arrow" href="./user-microposts.html#fnref-10_11">↑</a></li>
</ol>
</div>




    </div>
  </body>
</html>
