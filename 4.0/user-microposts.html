<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
            




            
            
            <div id="cha-user_microposts" class="chapter" data-tralics-id="cid72" data-number="11" data-chapter="user_microposts">
<h1><a href="#cha-user_microposts" class="heading hyperref"><span class="number">第11章</span>ユーザーのマイクロポスト</a></h1>
<p>サンプルアプリケーションのコア部分を開発するために、これまでにユーザー、セッション、アカウント有効化、パスワードリセットという４つのリソースについて見てきました。そして、これらのうち「ユーザー」というリソースだけが、Active Recordによってデータベース上のテーブルと紐付いています。全ての準備が整った今、ユーザーが短いメッセージを投稿できるようにするためのリソース「<em>マイクロポスト</em>」を追加していきます<sup class="footnote" id="cha-11_footnote-ref-1"><a href="#cha-11_footnote-1">1</a></sup>。<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>で簡易的なマイクロポスト投稿フォームに触れましたが、この章では、<a class="hyperref" href="toy_app?version=4.2#sec-microposts_resource"><span class="ref">2.3</span></a>で記述したMicropostデータモデルを作成し、Userモデルと<code>has_many</code>および<code>belongs_to</code>メソッドを使って関連付けを行い、さらに、結果を処理し表示するために必要なフォームとその部品を作成します (<a class="hyperref" href="#sec-micropost_images"><span class="ref">11.4</span></a>で画像のアップロードも実装します)。<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>では、マイクロポストの<em>フィード</em>を受け取るために、ユーザーを<em>フォロー</em>するという概念を導入し、Twitterのミニクローンを完成させます。</p>
</div><div id="sec-a_micropost_model" class="section" data-tralics-id="cid73" data-number="11.1">
<h2><a href="#sec-a_micropost_model" class="heading hyperref"><span class="number">11.1</span> Micropostモデル</a></h2>
<p>まずはMicropostリソースの最も本質的な部分を表現するMicropostモデルを作成するところから始めましょう。<a class="hyperref" href="toy_app?version=4.2#sec-microposts_resource"><span class="ref">2.3</span></a>で作成したモデルと同様に、この新しいMicropostモデルもデータ検証とUserモデルの関連付けを含んでいます。以前のモデルとは違って、今回のマイクロポストモデルは完全にテストされ、デフォルトの<em>順序</em>を持ち、また親であるユーザーが破棄された場合には自動的に<em>破棄</em>されるようにします。</p>
<p>Git をバージョン管理に使っている場合は、いつものようにトピックブランチを作成しておきましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b user-microposts
</pre></div></div>
<div id="sec-the_basic_model" class="subsection" data-tralics-id="uid1129" data-number="11.1.1">
<h3><a href="#sec-the_basic_model" class="heading hyperref"><span class="number">11.1.1</span> 基本的なモデル</a></h3>
<p>Micropostモデルは、マイクロポストの内容を保存する<code>content</code>属性と、特定のユーザーとマイクロポストを関連付ける<code>user_id</code>属性の2つの属性だけを持ちます。実行した結果のMicropostモデルの構造は<a class="hyperref" href="#fig-micropost_model">図<span class="ref">11.1</span></a>のようになります。</p>
<div class="center figure" id="fig-micropost_model" data-tralics-id="uid1130" data-number="11.1">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_model_3rd_edition.png" alt="images/figures/micropost_model_3rd_edition"></div>
<div class="caption">
<span class="header">図11.1</span> <span class="description">Micropostデータモデル
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-micropost_model">図<span class="ref">11.1</span></a>のモデルでは、マイクロポストの投稿に<code>String</code>型ではなく<code>text</code>型を使っている点に注目してください。これは、ある程度の量のテキストを格納するときに使われる型です。<code>String</code>型でも255文字までは格納できるため、この型でも<a class="hyperref" href="#sec-micropost_validations"><span class="ref">11.1.2</span></a>で実装する140文字制限を満たせるのですが、<code>Text</code>型の方が表現豊かなマイクロポストを実現できます。たとえば、<a class="hyperref" href="#sec-creating_microposts"><span class="ref">11.3.2</span></a>では投稿フォームにString用のテキストフィールドではなくてText用の<em>テキストエリア</em>を使うため、より自然な投稿フォームが実現できます。また、<code>Text</code>型の方が将来における柔軟性に富んでいて、たとえばいつか国際化をするときに、言語に応じて投稿の長さを調節することもできます。さらに、<code>Text</code>型を使っていても本番環境で<a href="http://www.postgresql.org/docs/9.1/static/datatype-character.html" target="_blank">パフォーマンスの差は出ません</a><sup class="footnote" id="cha-11_footnote-ref-2"><a href="#cha-11_footnote-2">2</a></sup>。これらの理由から、デメリットよりもメリットの方が多いので、今回はText型を採用しています。</p>
<p>では、<a class="hyperref" href="modeling_users?version=4.2#code-generate_user_model">リスト<span class="ref">6.1</span></a>でUserモデルを生成したときと同様に、Railsの<code>generate model</code>コマンドを使ってMicropostモデルを生成してみます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:text user:references
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-micropost_migration">リスト<span class="ref">6.2</span></a>でデータベースに<code>users</code>テーブルを作るマイグレーションファイルを生成した時と同様に、この<code>generate</code>コマンドは<code>microposts</code>テーブルを作成するためのマイグレーションファイルを生成します (<a class="hyperref" href="modeling_users?version=4.2#code-users_migration">リスト<span class="ref">11.1</span></a>)。Userモデルとの最大の違いは<code>references</code>型を利用している点です。これを利用すると、自動的にインデックスと外部参照キー付きの<code>user_id</code>カラムが追加され<sup class="footnote" id="cha-11_footnote-ref-3"><a href="#cha-11_footnote-3">3</a></sup>、UserとMicropostを関連付けする下準備をしてくれます。Userモデルのときと同じで、Micropostモデルのマイグレーションファイルでも<code>t.timestamps</code>という行 (マジックカラム) が自動的に生成されています。これにより、 <a class="hyperref" href="modeling_users?version=4.2#sec-database_migrations"><span class="ref">6.1.1</span></a>で説明したように<code>created_at</code>と<code>updated_at</code>というカラムが追加されます (<a class="hyperref" href="#fig-micropost_model">図&nbsp;<span class="ref">11.1</span></a>)。なお、<code>created_at</code>カラムは、<a class="hyperref" href="#sec-ordering_and_dependency"><span class="ref">11.1.4</span></a>や<a class="hyperref" href="#sec-rendering_microposts"><span class="ref">11.2.1</span></a>の実装を進めていく上で必要なカラムです。</p>
<div class="codelisting" id="code-micropost_migration" data-tralics-id="uid1133" data-number="11.1">
<div class="heading">
<span class="number">リスト11.1:</span> 

<span class="description">インデックスが付与されたMicropostのマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_microposts.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="kp">true</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで、<a class="hyperref" href="#code-micropost_migration">リスト<span class="ref">11.1</span></a>では<code>user_id</code>と<code>created_at</code>カラムにインデックスが付与されていることに注目してください (<a class="hyperref" href="modeling_users?version=4.2#aside-database_indices">コラム<span class="ref">6.2</span></a>)。これは、user_idに関連付けられたすべてのマイクロポストを作成時刻の逆順で取り出すためです。</p>
<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div></div>
<p class="noindent"><code>user_id</code>と<code>created_at</code>両方のカラムを1つの配列に含めることで、Active Recordで<em>両方</em>のキーを同時に使用する<em>複合キーインデックス</em>を作成できます。</p>
<p>それでは、<a class="hyperref" href="#code-micropost_migration">リスト<span class="ref">11.1</span></a>をマイグレーション使って、いつものようにデータベースを更新してみましょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
</div>
<div id="sec-micropost_validations" class="subsection" data-tralics-id="uid1134" data-number="11.1.2">
<h3><a href="#sec-micropost_validations" class="heading hyperref"><span class="number">11.1.2 </span>Micropostのバリデーション</a></h3>
<p>基本的なモデルを作成したので、次に要求される制限を実現するためのバリデーションを追加しましょう。Micropostモデルを作成したときに、マイクロポストは投稿したユーザーのid (user_id) を持たせるようにしました。これを使って、慣習的に正しくActive Recordの<em>関連付け</em>を実装していきます (<a class="hyperref" href="#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>) が、まずは<code>Micropost</code>モデル単体を (テスト駆動開発で) 動くようにしてみます。</p>
<p>Micropostの初期テストはUserモデルの初期テスト (<a class="hyperref" href="modeling_users?version=4.2#code-name_presence_test">リスト<span class="ref">6.7</span></a>) と似ています。まずは<code>setup</code>のステップで、fixtureのサンプルユーザーと紐付けた新しいマイクロポストを作成しています。次に、作成したマイクロポストが有効かどうかをチェックしてます。最後に、あらゆるマイクロポストはユーザーのidを持っているべきなので、<code>user_id</code>の存在性のバリデーションに対するテストも追加します。これらの要素を1つにまとめると、<a class="hyperref" href="#code-micropost_validity_test">リスト<span class="ref">11.2</span></a>のようなテストコードになります。</p>
<div class="codelisting" id="code-micropost_validity_test" data-tralics-id="uid1135" data-number="11.2">
<div class="heading">
<span class="number">リスト11.2:</span> 

<span class="description">新しいMicropostの有効性に対するテスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/micropost_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="c1"># 次の行は慣習的に間違っている</span>
</span><span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>setup</code>メソッドの中でコメントしているとおり、マイクロポストを作成するコードは動きますが、慣習的には正しくありません (<a class="hyperref" href="#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>で修正します)。</p>
<p>また、有効性に対するテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>しますが、存在性に対するテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>するはずです。これは、Micropostモデルのバリデーションがまだ何もないことが原因です。</p>
<div class="codelisting" id="uid1136" data-tralics-id="uid1136" data-number="11.3">
<div class="heading">
<span class="number">リスト11.3:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p class="noindent">これを修正するためには、ユーザーidに対するバリデーションを追加する必要があります (<a class="hyperref" href="#code-micropost_user_id_validation">リスト<span class="ref">11.4</span></a>)。なお、<a class="hyperref" href="#code-micropost_user_id_validation">リスト<span class="ref">11.4</span></a>にはすでに<code>belongs_to</code>というコードがありますが、これは<a class="hyperref" href="#code-micropost_migration">リスト<span class="ref">11.1</span></a>のマイグレーションによって自動的に生成されたコードです。この行の意味については、<a class="hyperref" href="#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>で説明します。</p>
<div class="codelisting" id="code-micropost_user_id_validation" data-tralics-id="uid1137" data-number="11.4">
<div class="heading">
<span class="number">リスト11.4:</span> 

<span class="description">マイクロポストの<code>user_id</code>に対する検証 (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
   <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="hll">   <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">これにより、モデルのテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するようになります。</p>
<div class="codelisting" id="uid1138" data-tralics-id="uid1138" data-number="11.5">
<div class="heading">
<span class="number">リスト11.5:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p>次に、マイクロポストの<code>content</code>属性に対するバリデーションを追加しましょう (<a class="hyperref" href="toy_app?version=4.2#sec-putting_the_micro_in_microposts"><span class="ref">2.3.2</span></a>で紹介した例と同じです)。<code>user_id</code>属性と同様に、<code>content</code>属性も存在する必要があり、さらに<em>マイクロ</em>ポストが140文字より長くならないよう制限を加えます。<a class="hyperref" href="modeling_users?version=4.2#sec-user_validations"><span class="ref">6.2</span></a>で使ったUserモデルのバリデーションを参考に、まずはこれらの制限を簡潔にテストしてみます。結果は<a class="hyperref" href="#code-micropost_validations_tests">リスト<span class="ref">11.6</span></a>のとおりです。</p>
<div class="codelisting" id="code-micropost_validations_tests" data-tralics-id="uid1139" data-number="11.6">
<div class="heading">
<span class="number">リスト11.6:</span> 

<span class="description">Micropostモデルのバリデーションに対するテスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/micropost_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"content should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"   "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"content should be at most 140 characters"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="modeling_users?version=4.2#sec-user_validations"><span class="ref">6.2</span></a>と同様で、<a class="hyperref" href="#code-micropost_validations_tests">リスト<span class="ref">11.6</span></a>ではマイクロポストの長さをテストするために、文字列の乗算を使用しています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 10
<span class="go">=&gt; "aaaaaaaaaa"</span>
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 141
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div></div>
<p>これに対応するアプリケーション側の実装は、Userの<code>name</code>用バリデーション (<a class="hyperref" href="modeling_users?version=4.2#code-length_validation">リスト<span class="ref">6.16</span></a>) と全く同じです。<a class="hyperref" href="#code-micropost_validations">リスト<span class="ref">11.7</span></a>に結果を示します。</p>
<div class="codelisting" id="code-micropost_validations" data-tralics-id="uid1140" data-number="11.7">
<div class="heading">
<span class="number">リスト11.7:</span> 

<span class="description">Micropostモデルのバリデーション (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>この時点では、全てのテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid1141" data-tralics-id="uid1141" data-number="11.8">
<div class="heading">
<span class="number">リスト11.8:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-user_micropost_associations" class="subsection" data-tralics-id="uid1142" data-number="11.1.3">
<h3><a href="#sec-user_micropost_associations" class="heading hyperref"><span class="number">11.1.3</span> User/Micropostの関連付け</a></h3>
<p>Webアプリケーション用のデータモデルを構築するにあたって、個々のモデル間での<em>関連付け</em>を十分考えておくことが重要です。今回の場合は、 <a class="hyperref" href="toy_app?version=4.2#sec-demo_user_has_many_microposts"><span class="ref">2.3.3</span></a>でも示したように、それぞれのマイクロポストは１人のユーザーと関連付けられ、それぞれのユーザーは (潜在的に) 複数のマイクロポストと関連付けられます。この関連付けを<a class="hyperref" href="#fig-micropost_belongs_to_user">図<span class="ref">11.2</span></a>と<a class="hyperref" href="#fig-user_has_many_microposts">図<span class="ref">11.3</span></a>に示します。これらの関連付けを実装するための一環として、Micropostモデルに対するテストを作成し、さらにUserモデルにいくつかのテストを追加します。</p>
<div class="center figure" id="fig-micropost_belongs_to_user" data-tralics-id="uid1143" data-number="11.2">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_belongs_to_user.png" alt="images/figures/micropost_belongs_to_user"></div>
<div class="caption">
<span class="header">図11.2</span> <span class="description">MicropostとそのUserは<code>belongs_to</code> (1対1) の関係性がある
</span>
</div>
</div>
<div class="center figure" id="fig-user_has_many_microposts" data-tralics-id="uid1144" data-number="11.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_has_many_microposts.png" alt="images/figures/user_has_many_microposts"></div>
<div class="caption">
<span class="header">図11.3</span> <span class="description">UserとそのMicropostは<code>has_many</code> (1対多) の関係性がある
</span>
</div>
</div>
<p>この節で定義する<code>belongs_to</code>/<code>has_many</code>関連付けを使用することで、<a class="hyperref" href="#table-association_methods">表<span class="ref">11.1</span></a>に示すようなメソッドをRailsで使えるようになります。<a class="hyperref" href="#table-association_methods">表<span class="ref">11.1</span></a>では、以下のメソッドではなく</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div></div>
<p class="noindent">以下のメソッドになっていることに注意してください。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div></div>
<p class="noindent">これらのメソッドは使うと、紐付いているユーザーを<em>通して</em>マイクロポストを作成することができます (慣習的に正しい方法です)。新規のマイクロポストがこの方法で作成される場合、<code>user_id</code>は自動的に正しい値に設定されます。この方法を使うと、たとえば以下のような</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="c1"># 次の行は慣習的に間違っている</span>
<span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">という書き方 (<a class="hyperref" href="#code-micropost_validity_test">リスト<span class="ref">11.2</span></a>) が、以下のように書き換えられます。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">(<code>new</code>メソッドと同様に、<code>build</code>メソッドはオブジェクトを返しますがデータベースには反映されません。) 一度正しい関連付けを定義してしまえば、<code>@micropost</code>変数の<code>user_id</code>には、関連するユーザーのidが自動的に設定されます。</p>
<div class="table" id="table-association_methods" data-tralics-id="uid1145" data-number="11.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>メソッド</strong></td>
<td class="align_left"><strong>用途</strong></td>
</tr>
<tr>
<td class="align_left"><code>micropost.user</code></td>
<td class="align_left">Micropostに紐付いたUserオブジェクトを返す</td>
</tr>
<tr>
<td class="align_left"><code>user.microposts</code></td>
<td class="align_left">Userのマイクロポストの集合を返す</td>
</tr>
<tr>
<td class="align_left"><code>user.microposts.create(arg)</code></td>
<td class="align_left">
<code>user</code>に紐付いたマイクロポストを作成する
</td>
</tr>
<tr>
<td class="align_left"><code>user.microposts.create!(arg)</code></td>
<td class="align_left">
<code>user</code>に紐付いたマイクロポストを作成する (失敗時に例外を発生)</td>
</tr>
<tr>
<td class="align_left"><code>user.microposts.build(arg)</code></td>
<td class="align_left">
<code>user</code>に紐付いた新しいMicropostオブジェクトを返す
</td>
</tr>
<tr>
<td class="align_left"><code>user.microposts.find_by(id: 1)</code></td>
<td class="align_left">
<code>user</code>に紐付いていて、<code>id</code>が<code>1</code>であるマイクロポストを検索する
</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表11.1</span> <span class="description">user/micropost関連メソッドのまとめ
</span>
</div>
</div>
<p><code>@user.microposts.build</code>のようなコードを使うためには、 UserモデルとMicropostモデルをそれぞれ更新して、関連付ける必要があります。Micropostモデルの方では、<code>belongs_to :user</code>というコードが必要になるのですが、これは <a class="hyperref" href="#code-micropost_migration">リスト<span class="ref">11.1</span></a>のマイグレーションによって自動的に生成されているはずです (<a class="hyperref" href="#code-micropost_belongs_to_user">リスト<span class="ref">11.9</span></a>)。一方、Userモデルの方では、<code>has_many :microposts</code>と追加する必要があります。ここは自動的に生成されないので、手動で追加してください (<a class="hyperref" href="#code-user_has_many_microposts">リスト<span class="ref">11.10</span></a>)。</p>
<div class="codelisting" id="code-micropost_belongs_to_user" data-tralics-id="uid1146" data-number="11.9">
<div class="heading">
<span class="number">リスト11.9:</span> 

<span class="description">マイクロポストがユーザーに所属する (<code>belongs_to</code>) 関連付け (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-user_has_many_microposts" data-tralics-id="uid1147" data-number="11.10">
<div class="heading">
<span class="number">リスト11.10:</span> 

<span class="description">ユーザーがマイクロポストを複数所有する (<code>has_many</code>) 関連付け (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:microposts</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">正しく関連付けができたら、<a class="hyperref" href="#code-micropost_validity_test">リスト<span class="ref">11.2</span></a>の<code>setup</code>メソッドを修正して、慣習的に正しくマイクロポストを作成してみます (<a class="hyperref" href="#code-micropost_validity_test_idiomatic">リスト<span class="ref">11.11</span></a>)。</p>
<div class="codelisting" id="code-micropost_validity_test_idiomatic" data-tralics-id="uid1148" data-number="11.11">
<div class="heading">
<span class="number">リスト11.11:</span> 

<span class="description">慣習的に正しくマイクロポストを作成する (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/micropost_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>もちろん、些細なリファクタリングでしかないので、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>したままになっているはずです。</p>
<div class="codelisting" id="uid1149" data-tralics-id="uid1149" data-number="11.12">
<div class="heading">
<span class="number">リスト11.12:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-ordering_and_dependency" class="subsection" data-tralics-id="uid1150" data-number="11.1.4">
<h3><a href="#sec-ordering_and_dependency" class="heading hyperref"><span class="number">11.1.4</span> マイクロポストを改良する</a></h3>
<p>この項では、UserとMicropostの関連付けを改良していきます。具体的には、ユーザーのマイクロポストを特定の<em>順序</em>で取得できるようにしたり、マイクロポストをユーザーに<em>依存させて</em>、ユーザーが削除されたらマイクロポストも自動的に削除されるようにしていきます。</p>
<div id="sec-default_scope" class="subsubsection" data-tralics-id="uid1151" data-number="11.1.4.1">
<h4><a href="#sec-default_scope" class="heading">デフォルトのスコープ</a></h4>
<p><code>user.microposts</code>メソッドはデフォルトでは読み出しの順序に対して何も保証しませんが、 ブログやTwitterの慣習に従って、作成時間の逆順、つまり最も新しいマイクロポストを最初に表示するようにしてみましょう<sup class="footnote" id="cha-11_footnote-ref-4"><a href="#cha-11_footnote-4">4</a></sup>。これを実装するためには、<em>default scope</em>というテクニックを使います。</p>
<p>この機能のテストは、見せかけの成功に陥りやすい部分で、「アプリケーション側の実装が本当は間違っているのにテストが成功してしまう」という罠があります。正しいテストを書くために、ここではテスト駆動開発で進めていきます。具体的には、まずデータベース上の最初のマイクロポストが、fixture内のマイクロポスト (<code>most_recent</code>) と同じであるか検証するテストを書いていきましょう (<a class="hyperref" href="#code-micropost_order_test">リスト<span class="ref">11.13</span></a>)。</p>
<div class="codelisting" id="code-micropost_order_test" data-tralics-id="uid1153" data-number="11.13">
<div class="heading">
<span class="number">リスト11.13:</span> 

<span class="description">マイクロポストの順序付けをテストする (<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/micropost_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"order should be most recent first"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:most_recent</span><span class="p">),</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">first</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-micropost_order_test">リスト<span class="ref">11.13</span></a>では、マイクロポスト用のfixtureファイルからサンプルデータを読み出しているので、次のfixtureファイルも必要になります (<a class="hyperref" href="#code-micropost_fixtures">リスト<span class="ref">11.14</span></a>)。</p>
<div class="codelisting" id="code-micropost_fixtures" data-tralics-id="uid1154" data-number="11.14">
<div class="heading">
<span class="number">リスト11.14:</span> 

<span class="description">マイクロポスト用のfixture <span class="break"></span> <span class="filepath">test/fixtures/microposts.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>

<span class="l-Scalar-Plain">tau_manifesto</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Check</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">@tauday</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">@mhartl:</span><span class="nv"> </span><span class="s">http://tauday.com"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.years.ago %&gt;</span>

<span class="l-Scalar-Plain">cat_video</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Sad</span><span class="nv"> </span><span class="s">cats</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">sad:</span><span class="nv"> </span><span class="s">http://youtu.be/PKffm2uI4dk"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.hours.ago %&gt;</span>

<span class="l-Scalar-Plain">most_recent</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Writing</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">short</span><span class="nv"> </span><span class="s">test"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ここでは、埋め込みRubyを使って<code>created_at</code>カラムに明示的に値をセットしている点に注目してください。このマジックカラムはRailsによって自動的に更新されるため、基本的には手動で更新することはできないのですが、fixtureファイルの中ではそれが可能になっています。また、原理的には必要はないかもしれませんが、ほとんどのシステムでは上から順に作成されるので、fixtureファイルでも意図的に順序をいじっています。たとえば、ファイル内の一番下のサンプルデータは最後に生成されるので、最も新しい投稿になるように修正する、といった感じです。ただ、この振る舞いは恐らくシステムに依存していて崩れやすいので、(本来は) この振る舞いに依存したテストは書くべきでは無いでしょう。</p>
<p><a class="hyperref" href="#code-micropost_order_test">リスト<span class="ref">11.13</span></a>と<a class="hyperref" href="#code-micropost_fixtures">リスト<span class="ref">11.14</span></a>を追加して、このテストを実行すると<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid1155" data-tralics-id="uid1155" data-number="11.15">
<div class="heading">
<span class="number">リスト11.15:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/models/micropost_test.rb \
&gt;                       TESTOPTS="--name test_order_should_be_most_recent_first"
</pre></div></div>
</div>
<p>次に、Railsの<code>default_scope</code>メソッドを使ってこのテストを成功させます。このメソッドは、データベースから要素を取得したときの、デフォルトの順序を指定するメソッドです。特定の順序にしたい場合は、<code>default_scope</code>の引数に<code>order</code>を与えます。たとえば、<code>created_at</code>カラムの順にしたい場合は次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">ただし、残念ながらデフォルトの順序が<em>昇順</em>となっているので、このままでは数の小さい値から大きい値にソートされてしまいます (最も古い投稿が最初に表示されてしまいます)。順序を逆にしたい場合は、一段階低いレベルの技術ではありますが、次のように生のSQLを引数に与える必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">ここで使用した<code>DESC</code>とは、SQLの“降順 (descending)”を指します。したがって、これで新しい投稿から古い投稿の順に並びます<sup class="footnote" id="cha-11_footnote-ref-5"><a href="#cha-11_footnote-5">5</a></sup>。古いバージョンのRailsでは、欲しい振る舞いにするためには生のSQLを書くしか選択肢がなかったのですが、Rails 4.0からは次のようにRubyの文法でも書けるようになりました。</p>
<div class="code"><div class="highlight"><pre><span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このコードを使ってMicropostモデルを更新した結果を、<a class="hyperref" href="#code-micropost_ordering">リスト<span class="ref">11.16</span></a>に示します。</p>
<div class="codelisting" id="code-micropost_ordering" data-tralics-id="uid1157" data-number="11.16">
<div class="heading">
<span class="number">リスト11.16:</span> 

<span class="description"><code>default_scope</code>ででマイクロポストを順序付ける (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="hll">  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-micropost_ordering">リスト<span class="ref">11.16</span></a>では新たに、ラムダ式 (Stabby lambda) という文法を使っています。これは、<em>Proc</em>や<em>lambda</em> (もしくは<em>無名関数</em>)と呼ばれるオブジェクトを作成する文法です。<code>-&gt;</code>というラムダ式は、ブロック (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>) を引数に取り、Procオブジェクトを返します。このオブジェクトは、<code>call</code>メソッドが呼ばれたとき、ブロック内の処理を評価します。この構文をコンソールで確かめてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>
<span class="go">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>.call
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p class="noindent">(ProcやRubyのトピックとしてはやや高度な部類に含まれるので、今すぐわからなくても心配する必要はありません。)</p>
<p><a class="hyperref" href="#code-micropost_ordering">リスト<span class="ref">11.16</span></a>のコードを追加することで、テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するようになります。</p>
<div class="codelisting" id="uid1158" data-tralics-id="uid1158" data-number="11.17">
<div class="heading">
<span class="number">リスト11.17:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-dependent_destroy" class="subsubsection" data-tralics-id="uid1159" data-number="11.1.4.2">
<h4><a href="#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>
<p>順序についてはひとまずここで区切ることにし、今度はマイクロポストに第二の要素を追加してみましょう。<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-deleting_users"><span class="ref">9.4</span></a>で書いたように、サイト管理者はユーザーを<em>破棄する</em>権限を持ちます。ユーザーが破棄された場合、ユーザーのマイクロポストも同様に破棄されるべきです。</p>
<p>この振る舞いは、<code>has_many</code>メソッドにオプションを渡してあげることで実装できます (<a class="hyperref" href="#code-micropost_dependency">リスト<span class="ref">11.18</span></a>)。</p>
<div class="codelisting" id="code-micropost_dependency" data-tralics-id="uid1160" data-number="11.18">
<div class="heading">
<span class="number">リスト11.18:</span> 

<span class="description">のマイクロポストは、その所有者 (ユーザー) と一緒に破棄されることを保証する <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>dependent: :destroy</code>というオプションを使うと、ユーザーが削除されたときに、そのユーザーに紐付いた (そのユーザーが投稿した) マイクロポストも一緒に削除されるようになります。これは、管理者がシステムからユーザーを削除したとき、持ち主の存在しないマイクロポストがデータベースに取り残されてしまう問題を防ぎます。</p>
<p>次に、<a class="hyperref" href="#code-micropost_dependency">リスト<span class="ref">11.18</span></a>が正しく動くかどうか、テストを使ってUserモデルを検証してみます。このテストでは、 (idを紐づけるための) ユーザーを作成することと、そのユーザーに紐付いたマイクロポストを作成する必要があります。その後、ユーザーを削除してみて、マイクロポストの数が1つ減っているかどうかを確認します。これらをコードにすると、結果は<a class="hyperref" href="#code-dependent_destroy_test">リスト<span class="ref">11.19</span></a>のようになります。([delete] リンクの統合テスト (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-delete_link_integration_test">リスト<span class="ref">9.57</span></a>) と比較してみてください。)</p>
<div class="codelisting" id="code-dependent_destroy_test" data-tralics-id="uid1161" data-number="11.19">
<div class="heading">
<span class="number">リスト11.19:</span> 

<span class="description"><code>dependent: :destroy</code>のテスト (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"associated microposts should be destroyed"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-micropost_dependency">リスト<span class="ref">11.18</span></a>のコードが正しく動いていれば、テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span>するようになります。</span></p>
<div class="codelisting" id="uid1162" data-tralics-id="uid1162" data-number="11.20">
<div class="heading">
<span class="number">リスト11.20:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div>
</div><div id="sec-showing_microposts" class="section" data-tralics-id="cid74" data-number="11.2">
<h2><a href="#sec-showing_microposts" class="heading hyperref"><span class="number">11.2</span> マイクロポストを表示する</a></h2>
<p>Web経由でマイクロポストを作成する方法は現時点ではありませんが (<a class="hyperref" href="#sec-creating_microposts"><span class="ref">11.3.2</span></a>から作り始めます)、マイクロポストを表示することと、テストすることならできます。ここでは、Twitterのような独立したマイクロポストの<code>index</code>ページは作らずに、<a class="hyperref" href="#fig-user_microposts_mockup">図<span class="ref">11.4</span></a>のモックアップに示したように、ユーザーの<code>show</code>ページで直接マイクロポストを表示させることにします。ユーザープロフィールにマイクロポストを表示させるため、最初に極めてシンプルなERbテンプレートを作成します。次に、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-sample_users"><span class="ref">9.3.2</span></a>のサンプルデータ生成タスクにマイクロポストのサンプルを追加して、画面にサンプルデータが表示されるようにしてみます。</p>
<div class="center figure" id="fig-user_microposts_mockup" data-tralics-id="uid1163" data-number="11.4">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/user_microposts_mockup_3rd_edition.png" alt="images/figures/user_microposts_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図11.4</span> <span class="description">マイクロポストが表示されたプロフィールページのモックアップ
</span>
</div>
</div>
<div id="sec-rendering_microposts" class="subsection" data-tralics-id="uid1164" data-number="11.2.1">
<h3><a href="#sec-rendering_microposts" class="heading hyperref"><span class="number">11.2.1 </span>マイクロポストの描画</a></h3>
<p>この項では、ユーザーのプロフィール画面 (<code>show.html.erb</code>) でそのユーザーのマイクロポストを表示させ、また、これまでに投稿した総数も表示するようにしていきます。とはいえ、今回必要となるアイデアのほとんどは、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-showing_all_users"><span class="ref">9.3</span></a>で実装したユーザーを表示する部分と似ています。</p>
<p>まずは、Micropostのコントローラとビューを作成するために、コントローラを生成しましょう (今回必要なのはビューだけで、Micropostsコントローラは<a class="hyperref" href="#sec-manipulating_microposts"><span class="ref">11.3</span></a>まで使いません)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Microposts
</pre></div></div>
<p>今回の目的は、ユーザー毎にすべてのマイクロポストを描画できるようにすることです。<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-partial_refactoring"><span class="ref">9.3.5</span></a>で見た次のコードでは、</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div></div>
<p class="noindent"><code>_user.html.erb</code>パーシャルを使って自動的に<code>@users</code>変数内のそれぞれのユーザーを出力していました。これを参考に、<code>_micropost.html.erb</code>パーシャルを使ってマイクロポストのコレクションを表示しようとすると、次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div></div>
<p class="noindent">まずは、順序無しリストの <code>ul</code>タグではなく、<em>順序付き</em>リストの<code>ol</code>タグを使っている点に注目してください。これは、マイクロポストが特定の順序 (新しい→古い) に依存しているためです。次に、対応するパーシャルを<a class="hyperref" href="#code-micropost_partial">リスト<span class="ref">11.21</span></a>に示します。</p>
<div class="codelisting" id="code-micropost_partial" data-tralics-id="uid1165" data-number="11.21">
<div class="heading">
<span class="number">リスト11.21:</span> 

<span class="description">1つのマイクロポストを表示するパーシャル<span class="break"></span> <span class="filepath">app/views/microposts/_micropost.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ここでは<code>time_ago_in_words</code>というヘルパーメソッドを使っています。これはメソッド名の表すとおりですが、「3分前に投稿」といった文字列を出力します。具体的な効果について<a class="hyperref" href="#sec-sample_microposts"><span class="ref">11.2.2</span></a>で説明します。また、<a class="hyperref" href="#code-micropost_partial">リスト<span class="ref">11.21</span></a>では各マイクロポストに対してCSSのidを割り振っています。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
</pre></div></div>
<p class="noindent">これは一般的に良いとされる慣習で、たとえば将来、JavaScriptを使って各マイクロポストを操作したくなったときなどに役立ちます。</p>
<p>次は、一度にすべてのマイクロポストが表示されてしまう潜在的問題に対処します。<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-pagination"><span class="ref">9.3.3</span></a>ではページネーションを使いましたが、今回も同じ方法でこの問題を解決します。前回同様、<code>will_paginate</code>メソッドを使うと次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="updating_and_deleting_users?version=4.2#code-will_paginate_index_view">リスト<span class="ref">9.41</span></a>のユーザー一覧画面のコードと比較すると、少し違っています。。以前は次のように単純なコードでした。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">実は、上のコードは引数なしで動作していました。これは<code>will_paginate</code>が、Usersコントローラのコンテキストにおいて、<code>@users</code>インスタンス変数が存在していることを<em>前提としている</em>ためです。このインスタンス変数は、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-pagination"><span class="ref">9.3.3</span></a>でも述べたように<code>ActiveRecord::Relation</code>クラスのインスタンスです。今回の場合は、ユーザーコントローラのコンテキストにおいて、<em>マイクロポスト</em>をページネーションしたいため、明示的に<code>@microposts</code>変数を<code> will_paginate</code>に渡す必要があります。もちろん、そのような変数をユーザー<code>show</code>アクションで定義しなければなりません (<a class="hyperref" href="#code-user_show_microposts_instance">リスト<span class="ref">11.22</span></a>)。</p>
<div class="codelisting" id="code-user_show_microposts_instance" data-tralics-id="uid1166" data-number="11.22">
<div class="heading">
<span class="number">リスト11.22:</span> 

<span class="description"><code>@microposts</code>インスタンス変数を<code>show</code>アクションに追加する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>paginate</code>メソッドの素晴らしさに注目してください。<em>マイクロポストの関連付けを経由して</em><span class="tt">micropost</span>テーブルに到達し、必要なマイクロポストのページを引き出してくれます。</p>
<p>最後の課題はマイクロポストの投稿数を表示することですが、これは<code>count</code>メソッドを使うことで解決できます。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p class="noindent"><code>paginate</code>と同様に、関連付けをとおして<code>count</code>メソッドを呼び出すことができます。大事なことは、<code>count</code>メソッドではデータベース上のマイクロポストを全部読みだしてから結果の配列に対して<code>length</code>を呼ぶ、といった無駄な処理は<em>していない</em>という点です。そんなことをしたら、マイクロポストの数が増加するにつれて効率が低下してしまいます。そうではなく、(データベース内での計算は高度に最適化されいるので) データベースに代わりに計算してもらい、特定の<code>user_id</code>に紐付いたマイクロポストの数をデータベースに問い合わせています。(それでもcountメソッドがアプリケーションのボトルネックになるようなことがあれば、さらに高速な<a href="http://railscasts.com/episodes/23-counter-cache-column" target="_blank"><em>counter cache</em></a>を使うこともできます。)</p>
<p>これですべての要素が揃ったので、プロフィール画面にマイクロポストを表示させてみましょう (<a class="hyperref" href="#code-user_show_microposts">リスト<span class="ref">11.23</span></a>)。(このとき、<a class="hyperref" href="sign_up?version=4.2#code-errors_partial">リスト<span class="ref">7.19</span></a>と同様に<code>if @user.microposts.any?</code>を使って、ユーザーのマイクロポストが1つもない場合には空のリストを表示させていない点にも注目してください。)</p>
<div class="codelisting" id="code-user_show_microposts" data-tralics-id="uid1167" data-number="11.23">
<div class="heading">
<span class="number">リスト11.23:</span> 

<span class="description">マイクロポストをユーザーの<code>show</code>ページ (プロフィール画面) に追加する<span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="hll">  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</span><span class="hll">      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/ol&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</span><span class="hll">    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span><span class="hll">  <span class="nt">&lt;/div&gt;</span>
</span><span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p>ここで、改良した新しいプロフィール画面をブラウザで見てみましょう (<a class="hyperref" href="#fig-user_profile_no_microposts">図<span class="ref">11.5</span></a>)。...何とも寂しいページで、がっかりですね。マイクロポストが1つもないのでは無理もありません。ではここでマイクロポストを追加しましょう。</p>
<div class="center figure" id="fig-user_profile_no_microposts" data-tralics-id="uid1168" data-number="11.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_profile_no_microposts_3rd_edition.png" alt="images/figures/user_profile_no_microposts_3rd_edition"></div>
<div class="caption">
<span class="header">図11.5</span> <span class="description">マイクロポスト用のコードのあるユーザープロフィールページ (ただしマイクロポストがない)
</span>
</div>
</div>
</div>
<div id="sec-sample_microposts" class="subsection" data-tralics-id="uid1169" data-number="11.2.2">
<h3><a href="#sec-sample_microposts" class="heading hyperref"><span class="number">11.2.2</span> マイクロポストのサンプル</a></h3>
<p><a class="hyperref" href="#sec-rendering_microposts"><span class="ref">11.2.1</span></a>のユーザーマイクロポストのテンプレート作成作業の成果は、何とも拍子抜けでした。<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-sample_users"><span class="ref">9.3.2</span></a>のサンプルデータ生成タスクにマイクロポストも追加して、この情けない状況を修正しましょう。</p>
<p><em>すべての</em>ユーザーにマイクロポストを追加しようとすると時間が掛かり過ぎるので、<code>take</code>メソッドを使って最初の6人だけに追加します。</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">(このとき、<code>order</code>メソッドを経由することで、明示的に最初の (IDが小さい順に) 6人を呼び出すようにしています。)</p>
<p>この6人については、1ページの表示限界数 (30) を越えさせるために、それぞれ50個分のマイクロポストを追加するようにしています。また、各投稿内容についてですが、Faker gemに<a href="http://rubydoc.info/gems/faker/1.3.0/Faker/Lorem" target="_blank"><span class="tt">Lorem.sentence</span></a>という便利なメソッドがあるので、これを使います<sup class="footnote" id="cha-11_footnote-ref-6"><a href="#cha-11_footnote-6">6</a></sup>。変更した結果は<a class="hyperref" href="#code-sample_microposts">リスト<span class="ref">11.24</span></a>のとおりです。(<a class="hyperref" href="#code-sample_microposts">リスト<span class="ref">11.24</span></a>のループの順序に違和感があるかもしれませんが、これは<a class="hyperref" href="following_users?version=4.2#sec-the_status_feed"><span class="ref">12.3</span></a>でステータスフィード (いわゆるタイムライン) を実装するときに役立ちます。というのも、ユーザー毎に50個分のマイクロポストをまとめて作成してしまうと、ステータスフィードに表示される投稿がすべて同じユーザーになってしまい、視覚的な見栄えが悪くなるからです。)</p>
<div class="codelisting" id="code-sample_microposts" data-tralics-id="uid1171" data-number="11.24">
<div class="heading">
<span class="number">リスト11.24:</span> 

<span class="description">サンプルデータにマイクロポストを追加する<span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで、いつものように開発環境用のデータベースで再度サンプルデータを生成します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
$ bundle exec rake db:seed
</pre></div></div>
<p class="noindent">生成し終わったら、Railsサーバーを一度落として、起動し直してください。</p>
<p>それぞれのマイクロポストの情報を表示することによって、<a class="hyperref" href="#sec-rendering_microposts"><span class="ref">11.2.1</span></a>の地道な作業がやっと報われはじめました<sup class="footnote" id="cha-11_footnote-ref-7"><a href="#cha-11_footnote-7">7</a></sup>。実行結果を<a class="hyperref" href="#fig-user_profile_microposts_no_styling">図<span class="ref">11.6</span></a>に示します。</p>
<div class="center figure" id="fig-user_profile_microposts_no_styling" data-tralics-id="uid1173" data-number="11.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_profile_microposts_no_styling_3rd_edition.png" alt="images/figures/user_profile_microposts_no_styling_3rd_edition"></div>
<div class="caption">
<span class="header">図11.6</span> <span class="description">ユーザープロフィールとスタイルのないマイクロポスト
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-user_profile_microposts_no_styling">図<span class="ref">11.6</span></a>のページにはマイクロポスト固有のスタイルが与えられていないので、<a class="hyperref" href="#code-micropost_css">リスト<span class="ref">11.25</span></a>を追加して、結果のページを見てみましょう<sup class="footnote" id="cha-11_footnote-ref-8"><a href="#cha-11_footnote-8">8</a></sup>。</p>
<div class="codelisting" id="code-micropost_css" data-tralics-id="uid1175" data-number="11.25">
<div class="heading">
<span class="number">リスト11.25:</span> 

<span class="description">マイクロポスト用のCSS (本章で利用するCSSのすべて) <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.user</span> <span class="p">{</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">em</span><span class="p">;</span>
    <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.content</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
    <span class="nt">img</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">padding</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nc">.timestamp</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$gray-light</span><span class="p">;</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nt">span</span><span class="nc">.picture</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nt">input</span> <span class="p">{</span>
    <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#fig-user_profile_with_microposts">図<span class="ref">11.7</span></a>では最初のユーザーのプロフィール画面を、<a class="hyperref" href="#fig-other_profile_with_microposts">図<span class="ref">11.8</span></a>では2番目のユーザーのプロフィール画面を表示しています。最後の<a class="hyperref" href="#fig-user_profile_microposts">図<span class="ref">10.9</span></a>では、最初のユーザーの<em>2番目</em>のページと、下部にあるページネーションのリンクを表示しています。各マイクロポストの表示には、3つのどの場合にも、それが作成されてからの時間 ("1分​​前に投稿" など) が表示されていることに注目してください。これは<a class="hyperref" href="#code-micropost_partial">リスト<span class="ref">11.21</span></a>の<code>time_ago_in_words</code>メソッドによるものです。数分待ってからページを再度読み込むと、このテキストは自動的に新しい時間に基づいて更新されます。</p>
<div class="center figure" id="fig-user_profile_with_microposts" data-tralics-id="uid1176" data-number="11.7">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_profile_with_microposts_3rd_edition.png" alt="images/figures/user_profile_with_microposts_3rd_edition"></div>
<div class="caption">
<span class="header">図11.7</span> <span class="description">ユーザープロフィール (<a href="http://localhost:3000/users/1" target="_blank">/users/1</a>) とマイクロポスト
</span>
</div>
</div>
<div class="center figure" id="fig-other_profile_with_microposts" data-tralics-id="uid1177" data-number="11.8">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/other_profile_with_microposts_3rd_edition.png" alt="images/figures/other_profile_with_microposts_3rd_edition"></div>
<div class="caption">
<span class="header">図11.8</span> <span class="description">別ユーザーのプロフィールとマイクロポスト (<a href="http://localhost:3000/users/5" target="_blank">/users/5</a>)
</span>
</div>
</div>
<div class="center figure" id="fig-user_profile_microposts" data-tralics-id="uid1178" data-number="11.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_profile_microposts_page_2_3rd_edition.png" alt="images/figures/user_profile_microposts_page_2_3rd_edition"></div>
<div class="caption">
<span class="header">図11.9</span> <span class="description">マイクロポストのページネーション用リンク (<a href="http://localhost:3000/users/1?page=2" target="_blank">/users/1?page=2</a>)
</span>
</div>
</div>
</div>
<div id="sec-profile_micropost_tests" class="subsection" data-tralics-id="uid1179" data-number="11.2.3">
<h3><a href="#sec-profile_micropost_tests" class="heading hyperref"><span class="number">11.2.3 </span>プロフィール画面におけるマイクロポストのテスト</a></h3>
<p>アカウントを有効化したばかりのユーザーはプロフィール画面にリダイレクトされるので、そのプロフィール画面が正しく描画されていることは、単体テストを通して確認済みです (<a class="hyperref" href="account_activation_password_reset?version=4.2#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>)。この項では、プロフィール画面で表示されるマイクロポストに対して、統合テストを書いていきます。まずは、プロフィール画面用の統合テストを生成してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_profile
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_profile_test.rb</span>
</pre></div></div>
<p>プロフィール画面におけるマイクロポストをテストするためには、ユーザーに紐付いたマイクロポストのテスト用データが必要になります。Railsの慣習に従って、関連付けされたテストデータをfixtureファイルに追加すると、次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span></pre></div></div>
<p class="noindent"><code>user</code>に<code>michael</code>という値を渡すと、Railsはfixtureファイル内の対応するユーザーを探し出して、(もし見つかれば) マイクロポストに関連付けてくれます。</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
</span>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">.</span>
  <span class="l-Scalar-Plain">.</span>
  <span class="l-Scalar-Plain">.</span>
</pre></div></div>
<p class="noindent">また、マイクロポストのページネーションをテストするためには、マイクロポスト用のfixtureにいくつかテストデータを追加する必要がありますが、これは<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-users_fixtures_extra_users">リスト<span class="ref">9.43</span></a>でユーザーを追加したときと同様に、埋め込みRubyを使うと簡単です。</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
<span class="l-Scalar-Plain">micropost_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Faker::Lorem.sentence(5) %&gt;</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 42.days.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
<span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</pre></div></div>
<p class="noindent">これらのコードを1つにまとめると、マイクロポスト用のfixtureファイルは<a class="hyperref" href="#code-updated_micropost_fixtures">リスト<span class="ref">11.26</span></a>のようになります。</p>
<div class="codelisting" id="code-updated_micropost_fixtures" data-tralics-id="uid1180" data-number="11.26">
<div class="heading">
<span class="number">リスト11.26:</span> 

<span class="description">ユーザーと関連付けされたマイクロポストのfixture <span class="break"></span> <span class="filepath">test/fixtures/microposts.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">tau_manifesto</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Check</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">@tauday</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">@mhartl:</span><span class="nv"> </span><span class="s">http://tauday.com"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.years.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">cat_video</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Sad</span><span class="nv"> </span><span class="s">cats</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">sad:</span><span class="nv"> </span><span class="s">http://youtu.be/PKffm2uI4dk"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.hours.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">most_recent</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Writing</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">short</span><span class="nv"> </span><span class="s">test"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="hll"><span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
</span><span class="hll"><span class="l-Scalar-Plain">micropost_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
</span><span class="hll">  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Faker::Lorem.sentence(5) %&gt;</span>
</span><span class="hll">  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 42.days.ago %&gt;</span>
</span><span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span><span class="hll"><span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</span></pre></div></div>
</div>
<p>テストデータの準備は完了したので、これからテストを書いていきますが、今回のテストはやや単純です。今回のテストでは、プロフィール画面にアクセスした後に、ページタイトルとユーザー名、Gravatar、マイクロポストの投稿数、そしてページ分割されたマイクロポスト、といった順でテストしていきます。これらをテストコードにした結果は<a class="hyperref" href="#code-user_profile_test">リスト<span class="ref">11.27</span></a>のとおりです (Applicationヘルパーをインクルードすることで、<a class="hyperref" href="rails_flavored_ruby?version=4.2#code-title_helper">リスト<span class="ref">4.2</span></a>の<code>full_title</code>ヘルパーが利用できている点に注目してください<sup class="footnote" id="cha-11_footnote-ref-9"><a href="#cha-11_footnote-9">9</a></sup>)。</p>
<div class="codelisting" id="code-user_profile_test" data-tralics-id="uid1182" data-number="11.27">
<div class="heading">
<span class="number">リスト11.27:</span> 

<span class="description">A test for the user profile. <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_profile_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersProfileTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
<span class="hll">  <span class="kp">include</span> <span class="no">ApplicationHelper</span>
</span>
  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"profile display"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s1">'title'</span><span class="p">,</span> <span class="n">full_title</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">assert_select</span> <span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_select</span> <span class="s1">'h1&gt;img.gravatar'</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
      <span class="n">assert_match</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-user_profile_test">リスト<span class="ref">11.27</span></a>ではマイクロポストの投稿数をチェックするために、<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>の演習(<a class="hyperref" href="account_activation_password_reset?version=4.2#sec-activation_resets_exercises"><span class="ref">10.5</span></a>)で紹介した<code>response.body</code>を使っています。名前を見ると誤解されがちですが、<code>response.body</code>にはそのページの完全なHTMLが含まれています (HTMLのbodyタグだけではなありません)。したがって、そのページの<em>どこかしらに</em>マイクロポストの投稿数が存在するのであれば、次のように探し出してマッチできるはずです。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</pre></div></div>
<p class="noindent">これは<code>assert_select</code>よりもずっと抽象的なメソッドです。特に、 <code>assert_select</code>ではどのHTMLタグを探すのか伝える必要がありますが、<code>assert_match</code>メソッドではその必要がない点が違います。</p>
<p>また、<a class="hyperref" href="#code-user_profile_test">リスト<span class="ref">11.27</span>の</a><code>assert_select</code>の引数では、ネストした文法を使っている点にも注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s1">'h1&gt;img.gravatar'</span>
</pre></div></div>
<p class="noindent">このように書くことで、<code>h1</code>タグ (トップレベルの見出し) の<em>内側にある</em>、<code>gravatar</code>クラス付きの<code>img</code>タグがあるかどうかをチェックできます。</p>
<p>そして、アプリケーション側のコードは実装済みなので、これらのテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid1183" data-tralics-id="uid1183" data-number="11.28">
<div class="heading">
<span class="number">リスト11.28:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-manipulating_microposts" class="section" data-tralics-id="cid75" data-number="11.3">
<h2><a href="#sec-manipulating_microposts" class="heading hyperref"><span class="number">11.3</span> マイクロポストを操作する</a></h2>
<p>データモデリングとマイクロポスト表示テンプレートの両方が完成したので、次はWeb経由でそれらを作成するためのインターフェイスに取りかかりましょう。この節では、<em>ステータスフィード</em> (<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>で完成させます) の最初のヒントをお見せします。最後に、ユーザーがマイクロポストをWeb経由で破棄できるようにします。</p>
<p>従来のRails開発の慣習と異なる箇所が1つあります。Micropostsリソースへのインターフェイスは、主にProfileページとHomeページのコントローラを経由して実行されるので、Micropostsコントローラには<code>new</code>や<code>edit</code>のようなアクションは不要ということになります。<code>create</code>と<code>destroy</code>があれば十分です。したがって、Micropostsのリソースは<a class="hyperref" href="#code-microposts_resource">リスト<span class="ref">11.29</span></a>のようになります。その結果、<a class="hyperref" href="#code-microposts_resource">リスト<span class="ref">11.29</span></a>のコードは、フルセットのルーティング (<a class="hyperref" href="toy_app?version=4.2#table-demo_RESTful_microposts">表<span class="ref">2.3</span></a>) のサブセットであるRESTfulルート (<a class="hyperref" href="#table-RESTful_microposts">表<span class="ref">11.2</span></a>) になります。もちろん、シンプルになったということは完成度が<em>さらに</em>高まったということの証しであり、退化したわけではありません。<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>でscaffoldに頼りきりだった頃からここに至るまでは長い道のりでしたが、今ではscaffoldが生成するような複雑なコードはほとんど不要になりました。</p>
<div class="codelisting" id="code-microposts_resource" data-tralics-id="uid1184" data-number="11.29">
<div class="heading">
<span class="number">リスト11.29:</span> 

<span class="description">マイクロポストリソースのルーティング<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<div class="table" id="table-RESTful_microposts" data-tralics-id="uid1185" data-number="11.2">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>HTTPリクエスト</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>アクション</strong></td>
<td class="align_left"><strong>用途</strong></td>
</tr>
<tr>
<td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/microposts</td>
<td class="align_left"><code>create</code></td>
<td class="align_left">新しいマイクロポストを作る</td>
</tr>
<tr>
<td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/microposts/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">id<code>1</code>のマイクロポストを削除する
</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表11.2</span> <span class="description">Micropostsリソースが提供する<a class="hyperref" href="#code-microposts_resource">リスト<span class="ref">11.29</span></a>のRESTfulルート
</span>
</div>
</div>
<div id="sec-micropost_access_control" class="subsection" data-tralics-id="uid1186" data-number="11.3.1">
<h3><a href="#sec-micropost_access_control" class="heading hyperref"><span class="number">11.3.1 </span>マイクロポストのアクセス制御</a></h3>
<p>Micropostsリソースの開発では、Micropostsコントローラ内のアクセス制御から始めることにしましょう。関連付けられたユーザーを通してマイクロポストにアクセスするので、<code>create</code>アクションや<code>destroy</code>アクションを利用するユーザーは、ログイン済みでなければなりません。</p>
<p>ログイン済みかどうかを確かめるテストでは、Usersコントローラ用のテストがそのまま役に立ちます (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-edit_update_redirect_tests">リスト<span class="ref">9.17</span></a>、<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-action_tests_admin">リスト<span class="ref">9.56</span></a>)。つまり、正しいリクエストを各アクションに向けて発行し、マイクロポストの数が変化していないかどうか、また、リダイレクトされるかどうかを確かめればよいのです (<a class="hyperref" href="#code-create_destroy_micropost_tests">リスト<span class="ref">11.30</span></a>)。</p>
<div class="codelisting" id="code-create_destroy_micropost_tests" data-tralics-id="uid1187" data-number="11.30">
<div class="heading">
<span class="number">リスト11.30:</span> 

<span class="description">Micropostsコントローラの認可テスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/controllers/microposts_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:orange</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect create when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@micropost</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-create_destroy_micropost_tests">リスト<span class="ref">11.30</span></a>のテストにパスするためには、少しアプリケーション側のコードをリファクタリングしておく必要があります。というのも、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>では、beforeフィルターの<code>logged_in_user</code>メソッドを使って、ログインを要求したことについて思い出してください (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-authorize_before_filter">リスト<span class="ref">9.12</span></a>)。あのときはUsersコントローラ内にこのメソッドがあったので、beforeフィルターで指定していましたが、 このメソッドはMicropostsコントローラでも必要です。そこで、各コントローラが継承するApplicationコントローラに (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_controller_class"><span class="ref">4.4.4</span></a>)、このメソッドを移してしまいましょう。 結果は<a class="hyperref" href="#code-sessions_helper_authenticate">リスト<span class="ref">11.31</span></a>のようになります。</p>
<div class="codelisting" id="code-sessions_helper_authenticate" data-tralics-id="uid1188" data-number="11.31">
<div class="heading">
<span class="number">リスト11.31:</span> 

<span class="description"><code>logged_in_user</code>メソッドをApplicationコントローラに移す<span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>

  <span class="kp">private</span>

    <span class="c1"># ユーザーのログインを確認する</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">store_location</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">コードが重複しないよう、このときUsersコントローラからも<code>logged_in_user</code>を削除しておきましょう。</p>
<p><a class="hyperref" href="#code-sessions_helper_authenticate">リスト<span class="ref">11.31</span></a>のコードによって、Micropostsコントローラからも<code>logged_in_user</code>メソッドを呼び出せるようになりました。これにより、<code>create</code>アクションや<code>destroy</code>アクションに対するアクセス制限が、beforeフィルターで簡単に実装できるようになります (<a class="hyperref" href="#code-microposts_controller_access_control">リスト<span class="ref">11.32</span></a>)。</p>
<div class="codelisting" id="code-microposts_controller_access_control" data-tralics-id="uid1189" data-number="11.32">
<div class="heading">
<span class="number">リスト11.32:</span> 

<span class="description">Micropostsコントローラの各アクションに認可を追加する <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>これでテストにパスするはずです。</p>
<div class="codelisting" id="uid1190" data-tralics-id="uid1190" data-number="11.33">
<div class="heading">
<span class="number">リスト11.33:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-creating_microposts" class="subsection" data-tralics-id="uid1191" data-number="11.3.2">
<h3><a href="#sec-creating_microposts" class="heading hyperref"><span class="number">11.3.2</span> マイクロポストを作成する</a></h3>
<p><a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>では、HTTP <span class="tt">POST</span>リクエストをUsersコントローラの<code>create</code>アクションに発行するHTMLフォームを作成することで、ユーザーのサインアップを実装しました。マイクロポスト作成の実装もこれと似ています。主な違いは、別の micropost/new ページを使う代わりに、ホーム画面 (つまりルートパス) にフォームを置くという点です。<a class="hyperref" href="#fig-home_page_with_micropost_form_mockup">図<span class="ref">11.10</span></a>のモックアップを見てください。</p>
<div class="center figure" id="fig-home_page_with_micropost_form_mockup" data-tralics-id="uid1192" data-number="11.10">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="images/figures/home_page_with_micropost_form_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図11.10</span> <span class="description">マイクロポスト作成フォームのあるホーム画面のモックアップ
</span>
</div>
</div>
<p>最後にホーム画面を実装したときは (<a class="hyperref" href="filling_in_the_layout?version=4.2#fig-sample_app_logo">図<span class="ref">5.6</span></a>)、[Sign up now!] ボタンが中央にありました。マイクロポスト作成フォームは、ログインしている特定のユーザーのコンテキストでのみ機能するので、この節の一つの目標は、ユーザーのログイン状態に応じて、ホーム画面の表示を変更することです。これについては、<a class="hyperref" href="#code-microposts_home_page">リスト<span class="ref">11.35</span></a>で実装します。</p>
<p>次に、マイクロポストの<code>create</code>アクションを作り始めましょう。このアクションも、<a class="hyperref" href="sign_up?version=4.2#code-user_create_action">リスト<span class="ref">7.23</span></a>のユーザー用アクションと似ています。違いは、新しいマイクロポストを<code>build</code>するためにuser/micropost関連付けを使用している点です (<a class="hyperref" href="#code-microposts_create_action">リスト<span class="ref">11.34</span></a>)。<code>micropost_params</code>でStrong Parametersを使用していることにより、マイクロポストの<code>content</code>属性だけがWeb経由で変更可能になっていることに注目してください。</p>
<div class="codelisting" id="code-microposts_create_action" data-tralics-id="uid1193" data-number="11.34">
<div class="heading">
<span class="number">リスト11.34:</span> 

<span class="description">Micropostsコントローラの<code>create</code>アクション<span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>マイクロポスト作成フォームを構築するために、サイト訪問者がログインしているかどうかに応じて異なるHTMLを提供するコードを使用します (<a class="hyperref" href="#code-microposts_home_page">リスト<span class="ref">11.35</span></a>)。</p>
<div class="codelisting" id="code-microposts_home_page" data-tralics-id="uid1194" data-number="11.35">
<div class="heading">
<span class="number">リスト11.35:</span> 

<span class="description">Homeページ (<a href="http://localhost:3000/" target="_blank">/</a>) にマイクロポストの投稿フォームを追加する<span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span><span class="hll">  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
</span><span class="hll">      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/section&gt;</span>
</span><span class="hll">      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"micropost_form"</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/section&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/aside&gt;</span>
</span><span class="hll">  <span class="nt">&lt;/div&gt;</span>
</span><span class="hll"><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-lg btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"Rails logo"</span><span class="p">),</span>
              <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
<span class="hll"><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span></pre></div></div>
</div>
<p class="noindent"><code>if</code>-<code>else</code>分岐を使用してコードを書き分けている点が少し汚いですが、このコードのクリーンアップは演習に回すことにします (<a class="hyperref" href="#sec-micropost_exercises"><span class="ref">11.6</span></a>)。</p>
<p><a class="hyperref" href="#code-microposts_home_page">リスト<span class="ref">11.35</span></a>のコードを動かすためには、いくつかのPartialを作る必要があります。まずはHomeページの新しいサイドバーからです。以下の<a class="hyperref" href="#code-user_info">リスト<span class="ref">11.36</span></a>のようになります。</p>
<div class="codelisting" id="code-user_info" data-tralics-id="uid1195" data-number="11.36">
<div class="heading">
<span class="number">リスト11.36:</span> 

<span class="description">サイドバーで表示するユーザー情報のパーシャル<span class="break"></span> <span class="filepath">app/views/shared/_user_info.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
</pre></div></div>
</div>
<p>プロフィールサイドバー (<a class="hyperref" href="#code-user_show_microposts">リスト<span class="ref">11.23</span></a>) のときと同様、<a class="hyperref" href="#code-user_info">リスト<span class="ref">11.36</span></a>のユーザー情報にも、そのユーザーが投稿したマイクロポストの総数が表示されていることに注目してください。ただし少し表示に違いがあります。プロフィールサイドバーでは、 “Microposts” をラベルとし、“Microposts (1)” と表示することは問題ありません。しかし、今回のように “1 microposts” と表示してしまうと英語の文法上誤りになってしまいます。そこで、<a class="hyperref" href="sign_up?version=4.2#sec-signup_error_messages"><span class="ref">7.3.3</span></a>で紹介した<code>pluralize</code>メソッドを使って “1 micropost” や “2 microposts” と表示するように調整しています。</p>
<p>次はマイクロポスト作成フォームを定義します (<a class="hyperref" href="#code-micropost_form">リスト<span class="ref">11.37</span></a>)。これはユーザー登録フォームに似ています (<a class="hyperref" href="sign_up?version=4.2#code-signup_form">リスト<span class="ref">7.13</span></a>)。</p>
<div class="codelisting" id="code-micropost_form" data-tralics-id="uid1196" data-number="11.37">
<div class="heading">
<span class="number">リスト11.37:</span> 

<span class="description">マイクロポスト投稿フォームのパーシャル<span class="break"></span> <span class="filepath">app/views/shared/_micropost_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-micropost_form">リスト<span class="ref">11.37</span></a>のフォームが動くようにするためには、2箇所の変更が必要です。1つは、(以前と同様) 関連付けを使用して次のように<code>@micropost</code>を定義することです。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div></div>
<p class="noindent">変更の結果を<a class="hyperref" href="#code-micropost_instance_variable">リスト<span class="ref">11.38</span></a>に示します。</p>
<div class="codelisting" id="code-micropost_instance_variable" data-tralics-id="uid1197" data-number="11.38">
<div class="heading">
<span class="number">リスト11.38:</span> 

<span class="description"><code>home</code>アクションにマイクロポストのインスタンス変数を追加する <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
<span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">logged_in?</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">もちろん、<code>current_user</code>メソッドはユーザーがログインしているときしか使えません。したがって、<code>@micropost</code>変数もログインしているときしか定義されません。</p>
<p><a class="hyperref" href="#code-micropost_form">リスト<span class="ref">11.37</span></a>を動かすためのもう1つの変更は、エラーメッセージのパーシャルを再定義することです。でなければ、<a class="hyperref" href="#code-micropost_form">リスト<span class="ref">11.37</span></a>の次のコードが動きません。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="sign_up?version=4.2#code-f_error_messages">リスト<span class="ref">7.18</span></a>ではエラーメッセージパーシャルが<code>@user</code>変数を直接参照していたことを思い出してください。今回は代わりに<code>@micropost</code>変数を使う必要があります。これらのケースをまとめると、フォーム変数<code>f</code>を<code>f.object</code>とすることによって、関連付けられたオブジェクトにアクセスすることができます。したがって、以下のコードの場合</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div></div>
<p class="noindent"><code>f.object</code>は<code>@user</code>となり、以下のコードの場合は</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div></div>
<p class="noindent">ここでいう <code>f.object</code> は、<code>@micropost</code> などになります。</p>
<p>パーシャルにオブジェクトを渡すために、値がオブジェクトで、キーがパーシャルでの変数名と同じハッシュを利用します。これで、<a class="hyperref" href="#code-micropost_form">リスト<span class="ref">11.37</span></a>の2行目のコードが完成します。言い換えると、<code>object: f.object</code>は<code>error_messages</code>パーシャルの中で<code>object</code>という変数名を作成してくれるので、この変数を使ってエラーメッセージを更新すればよいということです (<a class="hyperref" href="#code-updated_error_messages_partial">リスト<span class="ref">11.39</span></a>)。</p>
<div class="codelisting" id="code-updated_error_messages_partial" data-tralics-id="uid1198" data-number="11.39">
<div class="heading">
<span class="number">リスト11.39:</span> 

<span class="description">Userオブジェクト以外でも動作するようにerror_messagesパーシャルを更新する (<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/views/shared/_error_messages.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span>
<span class="hll">      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
</span>    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
<span class="hll">    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p>この時点でテストを走らせてみてください。テストが<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>したままになっています。</p>
<div class="codelisting" id="uid1199" data-tralics-id="uid1199" data-number="11.40">
<div class="heading">
<span class="number">リスト11.40:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">なぜ失敗しているのでしょうか。ヒントはerror_messagesパーシャルの他の出現場所です。このパーシャルは他の場所でも使われていたため、ユーザー登録 (<a class="hyperref" href="sign_up?version=4.2#code-f_error_messages">リスト<span class="ref">7.18</span></a>)、パスワードリセット (<a class="hyperref" href="account_activation_password_reset?version=4.2#code-password_reset_form">リスト<span class="ref">10.50</span></a>)、そしてユーザー編集 (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-user_edit_view">リスト<span class="ref">9.2</span></a>) のそれぞれのビューを更新する必要があったのです。各ビューを更新した結果を、<a class="hyperref" href="#code-signup_errors_updated">リスト<span class="ref">11.41</span></a>、<a class="hyperref" href="#code-password_reset_updated">リスト<span class="ref">11.43</span></a>、<a class="hyperref" href="#code-edit_errors_updated">リスト<span class="ref">11.42</span></a>に示します。</p>
<div class="codelisting" id="code-signup_errors_updated" data-tralics-id="uid1200" data-number="11.41">
<div class="heading">
<span class="number">リスト11.41:</span> 

<span class="description">ユーザー登録時のエラー表示を更新する<span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</span>      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-edit_errors_updated" data-tralics-id="uid1201" data-number="11.42">
<div class="heading">
<span class="number">リスト11.42:</span> 

<span class="description">ユーザー編集時のエラー表示を更新する <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre> <span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gravatar_edit"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-password_reset_updated" data-tralics-id="uid1202" data-number="11.43">
<div class="heading">
<span class="number">リスト11.43:</span> 

<span class="description">パスワードリセット時のエラー表示を更新する <span class="break"></span> <span class="filepath">app/views/password_resets/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Reset password'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Password reset<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Update password"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p>これで、すべてのテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
<p class="noindent">さらに、この章で作成したすべてのHTMLが適切に表示されるようになったはずです。最終的なフォームを<a class="hyperref" href="#fig-home_with_form">図<span class="ref">11.11</span></a>に、投稿エラーが表示されたフォームを<a class="hyperref" href="#fig-home_form_errors">図<span class="ref">11.12</span></a>に示します。</p>
<div class="center figure" id="fig-home_with_form" data-tralics-id="uid1203" data-number="11.11">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_with_form_3rd_edition.png" alt="images/figures/home_with_form_3rd_edition"></div>
<div class="caption">
<span class="header">図11.11</span> <span class="description">新しいマイクロポストフォームのあるHomeページ 
</span>
</div>
</div>
<div class="center figure" id="fig-home_form_errors" data-tralics-id="uid1204" data-number="11.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_form_errors_3rd_edition.png" alt="images/figures/home_form_errors_3rd_edition"></div>
<div class="caption">
<span class="header">図11.12</span> <span class="description">エラーが表示されたHomeページ
</span>
</div>
</div>
</div>
<div id="sec-a_proto_feed" class="subsection" data-tralics-id="uid1205" data-number="11.3.3">
<h3><a href="#sec-a_proto_feed" class="heading hyperref"><span class="number">11.3.3</span> フィードの原型</a></h3>
<p>マイクロポスト投稿フォームが動くようになりましたが、今の段階では投稿した内容をすぐに見ることができません。というのも、Homeページにまだマイクロポストを表示する部分が実装されていないからです。<a class="hyperref" href="#fig-home_with_form">図<span class="ref">11.11</span></a>のフォームが正しく動作しているかどうかを確認したい場合、正しいエントリーを投稿した後、<a href="http://localhost:3000/users/1" target="_blank">プロフィールページ</a>に移動してポストを表示すればよいのですが、これはかなり面倒な作業です。<a class="hyperref" href="#fig-proto_feed_mockup">図<span class="ref">11.13</span></a>のモックアップで示したような、ユーザー自身のポストを含むマイクロポストの<em>フィード</em>がないと不便です (<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>ではフィードを汎用化し、現在のユーザーによって<em>フォローされている</em>ユーザーのマイクロポストも一緒に表示するフィードにする予定です)。</p>
<div class="center figure" id="fig-proto_feed_mockup" data-tralics-id="uid1206" data-number="11.13">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/proto_feed_mockup_3rd_edition.png" alt="images/figures/proto_feed_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図11.13</span> <span class="description">試作フィードがあるHomeページのモックアップ
</span>
</div>
</div>
<p>すべてのユーザーがフィードを持つので、<code>feed</code>メソッドはUserモデルで作るのが自然です。フィードの原型では、まずは現在ログインしているユーザーのマイクロポストをすべて取得してきます。(次章で完全なフィードを実装するため) 今回は<a class="hyperref" href="account_activation_password_reset?version=4.2#sec-activation_resets_exercises"><span class="ref">10.5</span></a>で紹介した<code>where</code>メソッドでこれを実現します。<code>Micropost</code>モデルに変更を加えた結果を、<a class="hyperref" href="#code-proto_status_feed">リスト<span class="ref">11.44</span></a>に示します<sup class="footnote" id="cha-11_footnote-ref-10"><a href="#cha-11_footnote-10">10</a></sup>。</p>
<div class="codelisting" id="code-proto_status_feed" data-tralics-id="uid1208" data-number="11.44">
<div class="heading">
<span class="number">リスト11.44:</span> 

<span class="description">マイクロポストのステータスフィードを実装するための準備<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 試作feedの定義</span>
  <span class="c1"># 完全な実装は第12章「ユーザーをフォローする」を参照してください。</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

    <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">以下のコードで使用されている疑問符は、セキュリティ上重要な役割を果たしています。</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上の疑問符があることで、SQLクエリにインクルードされる前に<code>id</code>が適切に<em>エスケープ</em>されることを保証してくれるため、<a href="http://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3" target="_blank"><em>SQLインジェクション</em></a>と呼ばれる深刻なセキュリティホールを避けることができます。この場合の<code>id</code>属性は単なる整数 (すなわち<code>self.id</code>はユーザーのid) であるため危険はありませんが、SQL文にインクルードされる変数を<em>常に</em>エスケープする習慣はぜひ身につけてください。</p>
<p>注意深い読者は、<a class="hyperref" href="#code-proto_status_feed">リスト<span class="ref">11.44</span></a>のコードは本質的に次のコードと同等であることに気付くかもしれません。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">上のコードを使用せずにあえて<a class="hyperref" href="#code-proto_status_feed">リスト<span class="ref">11.44</span></a>のコードを利用したのは、<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>で必要となる完全なステータスフィードで応用が効くためです。</p>
<p>サンプルアプリケーションでフィードを使うために、カレントユーザーのページ分割されたフィードに<code>@feed_items</code>インスタンス変数を追加し (<a class="hyperref" href="#code-feed_instance_variable">リスト<span class="ref">11.45</span></a>)、次にフィード用のパーシャル (<a class="hyperref" href="#code-feed_partial">リスト<span class="ref">11.46</span></a>) をHomeページに追加します。Homeページに変更を加えた結果は<a class="hyperref" href="#code-home_with_feed">リスト<span class="ref">11.47</span></a>で示します。このとき、ユーザーがログインしているかどうかを調べる後置if文が変化している点に注目してください。すなわち、<a class="hyperref" href="#code-feed_instance_variable">リスト<span class="ref">11.45</span></a>では、次のコードが</p>
<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">logged_in?</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-micropost_instance_variable">リスト<span class="ref">11.38</span></a>のときとは異なり、</p>
<div class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
    <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div></div>
<p class="noindent">といった前置if文に変わっています (訳注: 1行のときは後置if文、2行以上のときは前置if文を使うのがRubyの習慣です)。</p>
<div class="codelisting" id="code-feed_instance_variable" data-tralics-id="uid1209" data-number="11.45">
<div class="heading">
<span class="number">リスト11.45:</span> 

<span class="description"><code>home</code>アクションにフィードのインスタンス変数を追加する<span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
<span class="hll">      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-feed_partial" data-tralics-id="uid1210" data-number="11.46">
<div class="heading">
<span class="number">リスト11.46:</span> 

<span class="description">ステータスフィードのパーシャル<span class="break"></span> <span class="filepath">app/views/shared/_feed.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p>ステータスフィードのパーシャルは、Micropostのパーシャル (<a class="hyperref" href="#code-micropost_partial">リスト<span class="ref">11.21</span></a>) とは異なっている点に注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">このとき、<code>@feed_items</code>の各要素が<code>Micropost</code>クラスを持っていたため、RailsはMicropostのパーシャルの呼び出すことができました。このように、Railsは対応する名前のパーシャルを、与えられたリソースのディレクトリ内から探しにいくことができます。</p>
<div class="code"><div class="highlight"><pre><span class="go">app/views/microposts/_micropost.html.erb</span>
</pre></div></div>
<p>後は、いつものようにフィードパーシャルを表示すればHomeページにフィードを追加できます (<a class="hyperref" href="#code-home_with_feed">リスト<span class="ref">11.47</span></a>)。この結果はHomeページのフィードとして表示されます (<a class="hyperref" href="#fig-home_with_proto_feed">図<span class="ref">11.14</span></a>)。</p>
<div class="codelisting" id="code-home_with_feed" data-tralics-id="uid1211" data-number="11.47">
<div class="heading">
<span class="number">リスト11.47:</span> 

<span class="description">Homeページにステータスフィードを追加する<span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"micropost_form"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
</span>    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-home_with_proto_feed" data-tralics-id="uid1212" data-number="11.14">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_with_proto_feed_3rd_edition.png" alt="images/figures/home_with_proto_feed_3rd_edition"></div>
<div class="caption">
<span class="header">図11.14</span> <span class="description">試作フィードのあるHomeページ
</span>
</div>
</div>
<p>現時点では、新しいマイクロポストの作成は<a class="hyperref" href="#fig-micropost_created">図<span class="ref">11.15</span></a>で示したように期待どおりに動作しています。ただしささいなことではありますが、マイクロポストの投稿が<em>失敗する</em>と、 Homeページは<code>@feed_items</code>インスタンス変数を期待しているため、現状では壊れてしまいます。最も簡単な解決方法は、<a class="hyperref" href="#code-microposts_create_action_with_feed">リスト<span class="ref">11.48</span></a>のように空の配列を渡しておくことです。残念ですが、この場合はページ分割されたフィードを返してもうまく動きません。動かない理由を確認したい方は、実際に実装してページネーションのリンクをクリックしてみてください。</p>
<div class="center figure" id="fig-micropost_created" data-tralics-id="uid1213" data-number="11.15">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_created_3rd_edition.png" alt="images/figures/micropost_created_3rd_edition"></div>
<div class="caption">
<span class="header">図11.15</span> <span class="description">新しいマイクロポストを作成した直後のHomeページ
</span>
</div>
</div>
<div class="codelisting" id="code-microposts_create_action_with_feed" data-tralics-id="uid1214" data-number="11.48">
<div class="heading">
<span class="number">リスト11.48:</span> 

<span class="description"><code>create</code>アクションに空の<code>@feed_items</code>インスタンス変数を追加する <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
<span class="hll">      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
</span>      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div>
<div id="sec-destroying_microposts" class="subsection" data-tralics-id="uid1215" data-number="11.3.4">
<h3><a href="#sec-destroying_microposts" class="heading hyperref"><span class="number">11.3.4</span> マイクロポストを削除する</a></h3>
<p>最後の機能として、マイクロポストリソースにポストを削除する機能を追加します。これはユーザー削除と同様に(<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-the_destroy_action"><span class="ref">9.4.2</span></a>)、"delete" リンクで実現します (<a class="hyperref" href="#fig-micropost_delete_links_mockup">図<span class="ref">11.16</span></a>)。ユーザーの削除は管理者ユーザーのみが行えるように制限されていたのに対し、今回の場合はカレントユーザーが作成したマイクロポストに対してのみ削除リンクが動作するようにします。</p>
<div class="center figure" id="fig-micropost_delete_links_mockup" data-tralics-id="uid1216" data-number="11.16">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_delete_links_mockup_3rd_edition.png" alt="images/figures/micropost_delete_links_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図11.16</span> <span class="description">マイクロポストの削除リンクと試作フィードのモックアップ
</span>
</div>
</div>
<p>最初のステップとして、マイクロポストのパーシャル (<a class="hyperref" href="#code-micropost_partial">リスト<span class="ref">11.21</span></a>) に削除リンクを追加します。変更の結果を<a class="hyperref" href="#code-micropost_partial_with_delete">リスト<span class="ref">11.49</span></a>に示します。</p>
<div class="codelisting" id="code-micropost_partial_with_delete" data-tralics-id="uid1217" data-number="11.49">
<div class="heading">
<span class="number">リスト11.49:</span> 

<span class="description">マイクロポストのパーシャルに削除リンクを追加する<span class="break"></span> <span class="filepath">app/views/microposts/_micropost.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
</span><span class="hll">                                       <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
</span>    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div>
</div>
<p>次に、Micropostsコントローラの<code>destroy</code>アクションを定義しましょう。これも、ユーザーにおける実装 (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-admin_destroy_before_filter">リスト<span class="ref">9.54</span></a>) と大体同じです。大きな違いは、<code>admin_user</code>フィルターで<code>@user</code>変数を使うのではなく、関連付けを使ってマイクロポストを見つけるようにしている点です。これにより、あるユーザーが他のユーザーのマイクロポストを削除しようとすると、自動的に失敗するようになります。具体的には、<code>correct_user</code>フィルター内で<code>find</code>メソッドを呼び出すことで、カレントユーザーが削除対象のマイクロポストを保有しているかどうかを確認します。変更した結果は<a class="hyperref" href="#code-microposts_destroy_action">リスト<span class="ref">11.50</span></a>のようになります。</p>
<div class="codelisting" id="code-microposts_destroy_action" data-tralics-id="uid1218" data-number="11.50">
<div class="heading">
<span class="number">リスト11.50:</span> 

<span class="description">Micropostsコントローラの<code>destroy</code>アクション<span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
</span><span class="hll">    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost deleted"</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="o">||</span> <span class="n">root_url</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>

     <span class="k">def</span> <span class="nf">correct_user</span>
<span class="hll">      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">このとき、 <a class="hyperref" href="#code-microposts_destroy_action">リスト<span class="ref">11.50</span></a>の<code>destroy</code>メソッドではリダイレクトを使っている点に注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="o">||</span> <span class="n">root_url</span>
</pre></div></div>
<p class="noindent">ここでは<code>request.referrer</code>というメソッドを使っています<sup class="footnote" id="cha-11_footnote-ref-11"><a href="#cha-11_footnote-11">11</a></sup>。このメソッドはフレンドリーフォワーディングの<code>request.url</code>変数 (<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-friendly_forwarding"><span class="ref">9.2.3</span></a>) と似ていて、一つ前のURLを返します<sup class="footnote" id="cha-11_footnote-ref-12"><a href="#cha-11_footnote-12">12</a></sup>。このため、マイクロポストがHomeページから削除された場合でもProfileページから削除された場合でも、<code>request.referrer</code>を使うことでDELETEリクエストが発行されたページに戻すことができるので、非常に便利です。ちなみに、元に戻すURLが見つからなかった場合でも (例えばテストでは<code>nil</code>が返ってくることもあります)、<a class="hyperref" href="#code-microposts_destroy_action">リスト<span class="ref">11.50</span></a>の<code>||</code>演算子で<code>root_url</code>をデフォルトに設定しているため、大丈夫です。(<a class="hyperref" href="log_in_log_out?version=4.2#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>で定義したデフォルトオプションと比較してみてください。)</p>
<p>これらのコードにより、上から2番目のマイクロポストを削除すると、<a class="hyperref" href="#fig-home_post_delete">図&nbsp;<span class="ref">11.17</span></a>のようにうまく動くはずです。</p>
<div class="center figure" id="fig-home_post_delete" data-tralics-id="uid1221" data-number="11.17">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_post_delete_3rd_edition.png" alt="images/figures/home_post_delete_3rd_edition"></div>
<div class="caption">
<span class="header">図11.17</span> <span class="description">2番目に新しいマイクロポストを削除した後のユーザーHomeページ
</span>
</div>
</div>
</div>
<div id="sec-micropost_tests" class="subsection" data-tralics-id="uid1222" data-number="11.3.5">
<h3><a href="#sec-micropost_tests" class="heading hyperref"><span class="number">11.3.5 </span>フィード画面におけるマイクロポストのテスト</a></h3>
<p><a class="hyperref" href="#sec-destroying_microposts"><span class="ref">11.3.4</span></a>のコードで、Micropostモデルとそのインターフェースが完成しました。残っている箇所は、Micropostsコントローラの認可をチェックする短いテストと、それらをまとめる統合テストを書くことです。</p>
<p>まずはマイクロポスト用のfixtureに、別々のユーザーに紐付けられたマイクロポストを追加していきます (<a class="hyperref" href="#code-add_micropost_different_owner">リスト<span class="ref">11.51</span></a>)。(今はこのうちの1つしか使いませんが、あとで他のマイクロポストも利用していきます。)</p>
<div class="codelisting" id="code-add_micropost_different_owner" data-tralics-id="uid1223" data-number="11.51">
<div class="heading">
<span class="number">リスト11.51:</span> 

<span class="description">別のユーザーに所属しているマイクロポストを追加する <span class="break"></span> <span class="filepath">test/fixtures/microposts.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">ants</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Oh,</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">that</span><span class="nv"> </span><span class="s">what</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">want?</span><span class="nv"> </span><span class="s">Because</span><span class="nv"> </span><span class="s">that's</span><span class="nv"> </span><span class="s">how</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">get</span><span class="nv"> </span><span class="s">ants!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.years.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>

<span class="l-Scalar-Plain">zone</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Danger</span><span class="nv"> </span><span class="s">zone!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.days.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>

<span class="l-Scalar-Plain">tone</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I'm</span><span class="nv"> </span><span class="s">sorry.</span><span class="nv"> </span><span class="s">Your</span><span class="nv"> </span><span class="s">words</span><span class="nv"> </span><span class="s">made</span><span class="nv"> </span><span class="s">sense,</span><span class="nv"> </span><span class="s">but</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">sarcastic</span><span class="nv"> </span><span class="s">tone</span><span class="nv"> </span><span class="s">did</span><span class="nv"> </span><span class="s">not."</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>

<span class="l-Scalar-Plain">van</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Dude,</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">van's,</span><span class="nv"> </span><span class="s">like,</span><span class="nv"> </span><span class="s">rolling</span><span class="nv"> </span><span class="s">probable</span><span class="nv"> </span><span class="s">cause."</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 4.hours.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>
</pre></div></div>
</div>
<p>次に、自分以外のユーザーのマイクロポストは削除をしようとすると、適切にリダイレクトされることをテストで確認します (<a class="hyperref" href="#code-micropost_user_mismatch_test">リスト<span class="ref">11.52</span></a>)。</p>
<div class="codelisting" id="code-micropost_user_mismatch_test" data-tralics-id="uid1224" data-number="11.52">
<div class="heading">
<span class="number">リスト11.52:</span> 

<span class="description">間違ったユーザーによるマイクロポスト削除に対してテストする (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/controllers/microposts_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:orange</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect create when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@micropost</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect destroy for wrong micropost"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">))</span>
</span><span class="hll">    <span class="n">micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:ants</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
</span><span class="hll">      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>最後に、統合テストを書きます。今回の統合テストでは、ログイン、マイクロポストのページ分割の確認、無効なマイクロポストを投稿、有効なマイクロポストを投稿、マイクロポストの削除、そして他のユーザーのマイクロポストには [delete] リンクが表示されないことを確認、といった順でテストしていきます。いつものように、統合テストを生成するところから始めましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test microposts_interface
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/microposts_interface_test.rb</span>
</pre></div></div>
<p class="noindent">先ほどの順で書いた統合テストは、<a class="hyperref" href="#code-microposts_interface_test">リスト<span class="ref">11.53</span></a>のようになります。<a class="hyperref" href="#code-micropost_validity_test_idiomatic">リスト<span class="ref">11.11</span></a>で書いたコードと、先ほどのステップが結合されている点に注意してください。(<a class="hyperref" href="#code-microposts_interface_test">リスト<span class="ref">11.53</span></a>では、<code>post_via_redirect</code>を<code>post</code>と<code>follow_redirect!</code>に分割している点にも注目してください。これは、画像アップロードのテストを演習 (<a class="hyperref" href="#code-image_upload_test">リスト<span class="ref">11.69</span></a>) でやるための準備です。)</p>
<div class="codelisting" id="code-microposts_interface_test" data-tralics-id="uid1225" data-number="11.53">
<div class="heading">
<span class="number">リスト11.53:</span> 

<span class="description">マイクロポストのUIに対する統合テスト (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/integration/microposts_interface_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostsInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"micropost interface"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="c1"># 無効な送信</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 有効な送信</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">"This micropost really ties the room together"</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="n">content</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_match</span> <span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># 投稿を削除する</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span>
    <span class="n">first_micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="n">first_micropost</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 違うユーザーのプロフィールにアクセスする</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">))</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>既にアプリケーション側のコードは実装してあるので、このテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid1226" data-tralics-id="uid1226" data-number="11.54">
<div class="heading">
<span class="number">リスト11.54:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-micropost_images" class="section" data-tralics-id="cid76" data-number="11.4">
<h2><a href="#sec-micropost_images" class="heading hyperref"><span class="number">11.4 </span>マイクロポストの画像投稿</a></h2>
<p>ここまででマイクロポストに関する基本的な操作はすべて実装できました。この節では、応用編として画像付きマイクロポストを投稿できるようにしてみます。手順としては、まずは開発環境用のβ版を実装し、その後、いくつかの改善をとおして本番環境用の完成版を実装します。</p>
<p>画像アップロード機能を追加するためには、2つの視覚的な要素が必要です。1つは画像をアップロードするためのフォーム、もう1つは投稿された画像そのものです。[Upload image] ボタンと画像付きマイクロポストのモックアップを<a class="hyperref" href="#fig-micropost_image_mockup">図<span class="ref">11.18</span></a>に示します<sup class="footnote" id="cha-11_footnote-ref-13"><a href="#cha-11_footnote-13">13</a></sup>。</p>
<div class="center figure" id="fig-micropost_image_mockup" data-tralics-id="uid1228" data-number="11.18">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_image_mockup.png" alt="images/figures/micropost_image_mockup"></div>
<div class="caption">
<span class="header">図11.18: </span><span class="description">画像付きマイクロポストを投稿したときのモックアップ
</span>
</div>
</div>
<div id="sec-basic_image_upload" class="subsection" data-tralics-id="uid1229" data-number="11.4.1">
<h3><a href="#sec-basic_image_upload" class="heading hyperref"><span class="number">11.4.1 </span>基本的な画像アップロード</a></h3>
<p>投稿した画像を扱ったり、その画像をMicropostモデルと関連付けするために、今回は<a href="https://github.com/carrierwaveuploader/carrierwave" target="_blank">CarrierWave</a>という画像アップローダーを使います。まずは<span class="tt">carrierwave</span> gemを<code>Gemfile</code>に追加しましょう (<a class="hyperref" href="#code-gemfile_carrierwave">リスト<span class="ref">11.55</span></a>)。また<a class="hyperref" href="#code-gemfile_carrierwave">リスト<span class="ref">11.55</span></a>では、あとで必要になる<span class="tt">mini_magick</span> gemと<span class="tt">fog</span> gemsも含めている点に注目してください。これらのgemは画像をリサイズしたり (<a class="hyperref" href="#sec-image_resizing"><span class="ref">11.4.3</span></a>)、本番環境で画像をアップロードする (<a class="hyperref" href="#sec-image_upload_in_production"><span class="ref">11.4.4</span></a>) ために使います。</p>
<div class="codelisting" id="code-gemfile_carrierwave" data-tralics-id="uid1230" data-number="11.55">
<div class="heading">
<span class="number">リスト11.55:</span> 

<span class="description"><code>Gemfile</code>にCarrierWaveを追加する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.7'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.4.2'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'carrierwave'</span><span class="p">,</span>             <span class="s1">'0.10.0'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'mini_magick'</span><span class="p">,</span>             <span class="s1">'3.8.0'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'fog'</span><span class="p">,</span>                     <span class="s1">'1.36.0'</span>
</span><span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.0.7'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div>
</div>
<p class="noindent">次に、いつものようにインストールします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install</pre></div></div>
<p>CarrierWaveを導入すると、Railsのジェネレーターで画像アップローダーが生成できるようになります。早速、次のコマンドを実行してみましょう (画像のことをimageとすると一般的過ぎるので、今回は<code>picture</code>と呼ぶことにします) <sup class="footnote" id="cha-11_footnote-ref-14"><a href="#cha-11_footnote-14">14</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate uploader Picture
</pre></div></div>
<p>CarrierWaveでアップロードされた画像は、Active Recordモデルの属性と関連付けされているべきです。関連付けされる属性には画像のファイル名が格納されるため、String型にしておきます。拡張したマイクロポストのデータモデルを、<a class="hyperref" href="#fig-micropost_model_picture">図<span class="ref">11.19</span></a>に示します。</p>
<div class="center figure" id="fig-micropost_model_picture" data-tralics-id="uid1232" data-number="11.19">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/micropost_model_picture.png" alt="images/figures/micropost_model_picture"></div>
<div class="caption">
<span class="header">図11.19: </span><span class="description"><code>picture</code>属性を追加したマイクロポストのデータモデル
</span>
</div>
</div>
<p>必要となる<code>picture</code>属性をMicropostモデルに追加するために、マイグレーションファイルを生成し、開発環境のデータベースに適用します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_picture_to_microposts picture:string
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div></div>
<p>CarrierWaveに画像と関連付けたモデルを伝えるためには、<code>mount_uploader</code>というメソッドを使います。このメソッドは、引数に属性名のシンボルと生成されたアップローダーのクラス名を取ります。</p>
<div class="code"><div class="highlight"><pre><span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
</pre></div></div>
<p class="noindent">(<code>picture_uploader.rb</code>というファイルで<code>PictureUploader</code>クラスが定義されています。<a class="hyperref" href="#sec-image_validation"><span class="ref">11.4.2</span></a>で修正しますが、今はデフォルトのままで大丈夫です。) Micropostモデルにアップローダーを追加した結果を<a class="hyperref" href="#code-micropost_model_picture">リスト<span class="ref">11.56</span></a>に示します。</p>
<div class="codelisting" id="code-micropost_model_picture" data-tralics-id="uid1233" data-number="11.56">
<div class="heading">
<span class="number">リスト11.56:</span> 

<span class="description">Micropostモデルに画像を追加する<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
<span class="hll">  <span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">システムによっては、ここで一旦Railsサーバーを再起動させる必要があります。再起動させたらテストスイートを走らせてみてください。<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>しているはずです。(ただし、<a class="hyperref" href="static_pages?version=4.2#sec-guard"><span class="ref">3.7.3</span></a>で説明したGuardを使っている場合は、再起動させるだけではうまく動かないかもしれません。その場合はターミナルから一旦抜けて、新しいターミナルでGuardを再実行してみてください。)</p>
<p><a class="hyperref" href="#fig-micropost_image_mockup">図&nbsp;<span class="ref">11.18</span></a>のようにHomeページ常にアップローダーを追加するためには、マイクロポストのフォームに<code>file_field</code>タグを含める必要があります (<a class="hyperref" href="#code-micropost_create_image_upload">リスト<span class="ref">11.57</span></a>)。</p>
<div class="codelisting" id="code-micropost_create_image_upload" data-tralics-id="uid1234" data-number="11.57">
<div class="heading">
<span class="number">リスト11.57:</span> 

<span class="description">マイクロポスト投稿フォームに画像アップローダーを追加する<span class="break"></span> <span class="filepath">app/views/shared/_micropost_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">multipart</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"picture"</span><span class="nt">&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">このとき、</p>
<div class="code"><div class="highlight"><pre>html: { multipart: true }
</pre></div></div>
<p class="noindent"><code>form_for</code>の引数に上のオプションが追加されていることに注目してください。これはファイルをアップロードする際に必要となるオプションです。</p>
<p>最後に、Webから更新できる許可リストに<code>picture</code>属性を追加しましょう。追加すると、<code>micropost_params</code>メソッドは<a class="hyperref" href="#code-micropost_params_picture">リスト<span class="ref">11.58</span></a>のようになります。</p>
<div class="codelisting" id="code-micropost_params_picture" data-tralics-id="uid1235" data-number="11.58">
<div class="heading">
<span class="number">リスト11.58:</span> 

<span class="description"><code>picture</code>を許可された属性のリストに追加する<span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
<span class="hll">      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">,</span> <span class="ss">:picture</span><span class="p">)</span>
</span>    <span class="k">end</span>

     <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>一度画像がアップロードされれば、Micropostパーシャルの<code>image_tag</code>ヘルパーでその画像を描画できるようになります (<a class="hyperref" href="#code-micropost_partial_image_display">リスト<span class="ref">11.59</span></a>)。また、画像の無い (テキストのみの) マイクロポストでは画像を表示させないようにするために、<code>picture?</code>という論理値を返すメソッドを使っている点に注目してください。このメソッドは、画像用の属性名に応じて、CarrierWaveが自動的に生成してくれるメソッドです。手動で画像付きの投稿をしてみると、<a class="hyperref" href="#fig-micropost_with_image">図&nbsp;<span class="ref">11.20</span></a>のようになります。画像アップロードに対するテストは、演習に回します (<a class="hyperref" href="#sec-micropost_exercises"><span class="ref">11.6</span></a>)。</p>
<div class="codelisting" id="code-micropost_partial_image_display" data-tralics-id="uid1236" data-number="11.59">
<div class="heading">
<span class="number">リスト11.59:</span> 

<span class="description">マイクロポストの画像表示画面を追加する<span class="break"></span> <span class="filepath">app/views/microposts/_micropost.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">micropost</span><span class="o">.</span><span class="n">picture</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">micropost</span><span class="o">.</span><span class="n">picture?</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                       <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-micropost_with_image" data-tralics-id="uid1237" data-number="11.20">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/microposts_with_image.png" alt="images/figures/microposts_with_image"></div>
<div class="caption">
<span class="header">図11.20: </span><span class="description">画像付きマイクロポストを投稿した結果
</span>
</div>
</div>
</div>
<div id="sec-image_validation" class="subsection" data-tralics-id="uid1238" data-number="11.4.2">
<h3><a href="#sec-image_validation" class="heading hyperref"><span class="number">11.4.2 </span>画像の検証</a></h3>
<p><a class="hyperref" href="#sec-basic_image_upload"><span class="ref">11.4.1</span></a>のアップローダーも悪くはありませんが、いくつかの目立つ欠点があります。例えば、アップロードされた画像に対する制限がないため、もしユーザーが巨大なファイルを上げたり、無効なファイルを上げると問題が発生してしまいます。この欠点を直すために、画像サイズやフォーマットに対するバリデーションを実装し、サーバー用とクライアント (ブラウザ) 用の両方に追加しましょう。</p>
<p>最初のバリデーションでは、有効な画像の種類を制限していきますが、これはCarrierWaveのアップローダーの中に既にヒントがあります。生成されたアップローダーの中にコメントアウトされたコードがありますが、ここのコメントアウトを取り消すことで、画像のファイル名から有効な拡張子 (PNG/GIF/JPEGなど) を検証することができます (<a class="hyperref" href="#code-validate_picture_format">リスト<span class="ref">11.60</span></a>)。</p>
<div class="codelisting" id="code-validate_picture_format" data-tralics-id="uid1239" data-number="11.60">
<div class="heading">
<span class="number">リスト11.60:</span> 

<span class="description">画像フォーマットのバリデーション<span class="break"></span> <span class="filepath">app/uploaders/picture_uploader.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">storage</span> <span class="ss">:file</span>

  <span class="c1"># アップロードファイルの保存先ディレクトリは上書き可能</span>
  <span class="c1"># 下記はデフォルトの保存先</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># アップロード可能な拡張子のリスト</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
<span class="hll">    <span class="sx">%w(jpg jpeg gif png)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>2つ目のバリデーションでは、画像のサイズを制御します。これはMicropostモデルに書き足していきます。先ほどのバリデーションとは異なり、ファイルサイズに対するバリデーションはRailsの既存のオプション (presenceやlengthなど) にはありません。したがって、今回は手動で<code>picture_size</code>という独自のバリデーションを定義します。結果は<a class="hyperref" href="#code-micropost_model_image_validation">リスト<span class="ref">11.61</span></a>のとおりです。独自のバリデーションを定義するために、今まで使っていた<code>validates</code>メソッドではなく、<code>validate</code>メソッドを使っている点に注目してください。</p>
<div class="codelisting" id="code-micropost_model_image_validation" data-tralics-id="uid1240" data-number="11.61">
<div class="heading">
<span class="number">リスト11.61:</span> 

<span class="description">画像に対するバリデーションを追加する<span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="hll">  <span class="n">validate</span>  <span class="ss">:picture_size</span>
</span>
  <span class="kp">private</span>

<span class="hll">    <span class="c1"># アップロード画像のサイズを検証する</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">picture_size</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">picture</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span>
</span><span class="hll">        <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:picture</span><span class="p">,</span> <span class="s2">"should be less than 5MB"</span><span class="p">)</span>
</span><span class="hll">      <span class="k">end</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">このvalidateメソッドでは、引数にシンボル  (<code>:picture_size</code>) を取り、そのシンボル名に対応したメソッドを呼び出します。また、呼び出された<code>picture_size</code>メソッドでは、5MBを上限として (文法は<a class="hyperref" href="log_in_log_out?version=4.2#aside-time_helpers">コラム<span class="ref">8.2</span></a>を参照)、それを超えた場合はカスタマイズしたエラーメッセージを<code>errors</code>コレクションに追加しています (errorsについては<a class="hyperref" href="modeling_users?version=4.2#sec-presence_validation"><span class="ref">6.2.2</span></a>で紹介しました)。</p>
<p><a class="hyperref" href="#code-validate_picture_format">リスト<span class="ref">11.60</span></a>や<a class="hyperref" href="#code-micropost_model_image_validation">リスト<span class="ref">11.61</span></a>で定義した画像のバリデーションをビューに組み込むために、クライアント側に2つの処理を追加しましょう。まずはフォーマットのバリデーションを反映するためには、<code>file_field</code>タグに<code>accept</code>パラメータを付与して使います。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">accept</span><span class="p">:</span> <span class="s1">'image/jpeg,image/gif,image/png'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">このときacceptパラメータでは、<a class="hyperref" href="#code-validate_picture_format">リスト<span class="ref">11.60</span></a>で許可したファイル形式を、<a href="https://en.wikipedia.org/wiki/Media_type" target="_blank">MIMEタイプ</a>で指定するようにします。</p>
<p>次に、大きすぎるファイルサイズに対して警告を出すために、ちょっとしたJavaScript (正確には<a href="http://jquery.com/" target="_blank">jQuery</a>) を書き加えます。こうすることで、長すぎるアップロード時間を防いだり、サーバーへの負荷を抑えたりすることに繋がります。</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s1">'#micropost_picture'</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">size_in_megabytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">size</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">size_in_megabytes</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">'Maximum file size is 5MB. Please choose a smaller file.'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>
<p class="noindent">jQueryは本書のトピックではないので詳細な解説はしませんが、上のコードでは (ハッシュマーク<code>#</code>から分かるように) CSS idの<code>micropost_picture</code>を含んだ要素を見つけ出し、この要素を監視しています。そしてこのidを持った要素とは、マイクロポストのフォーム<a class="hyperref" href="#code-micropost_create_image_upload">リスト<span class="ref">11.57</span></a>を指します (ブラウザ上で画面を右クリックし、インスペクターで要素を調べると確認できます)。つまり、このCSS idを持つ要素が変化したとき、このjQueryの関数が動き出します。そして、もしファイルサイズが大きすぎた場合、<code>alert</code>メソッドで警告を出すといった仕組みです<sup class="footnote" id="cha-11_footnote-ref-15"><a href="#cha-11_footnote-15">15</a></sup>。</p>
<p>これらの追加的なチェック機能をまとめると、<a class="hyperref" href="#code-_format_jquery_file_test">リスト<span class="ref">11.62</span></a>のようになります。</p>
<div class="codelisting" id="code-_format_jquery_file_test" data-tralics-id="uid1242" data-number="11.62">
<div class="heading">
<span class="number">リスト11.62:</span> 

<span class="description">ファイルサイズをjQueryでチェックする<span class="break"></span> <span class="filepath">app/views/shared/_micropost_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">multipart</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"picture"</span><span class="nt">&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">accept</span><span class="p">:</span> <span class="s1">'image/jpeg,image/gif,image/png'</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="hll"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
</span><span class="hll">  <span class="nx">$</span><span class="p">(</span><span class="s1">'#micropost_picture'</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="hll">    <span class="kd">var</span> <span class="nx">size_in_megabytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">size</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">size_in_megabytes</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">alert</span><span class="p">(</span><span class="s1">'Maximum file size is 5MB. Please choose a smaller file.'</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span><span class="hll"><span class="nt">&lt;/script&gt;</span>
</span></pre></div></div>
</div>
<p>ちなみに、<a class="hyperref" href="#code-_format_jquery_file_test">リスト<span class="ref">11.62</span></a>のようなコードでは大きすぎるファイルのアップロードを完全には阻止できない、という点を覚えておいてください。というのも、このコードは送信フォームを使った投稿は制限できても、インスペクター画面でJavaScriptをいじって投稿したり、<code>curl</code>などを使って直接<span class="tt">POST</span>リクエストを送信する場合には制限できないからです。こういった場合にも対応できるようにするため、<a class="hyperref" href="#code-micropost_model_image_validation">リスト<span class="ref">11.61</span></a>で実装したサーバー側のバリデーションも重要なのです。</p>
</div>
<div id="sec-image_resizing" class="subsection" data-tralics-id="uid1243" data-number="11.4.3">
<h3><a href="#sec-image_resizing" class="heading hyperref"><span class="number">11.4.3 </span>画像のリサイズ</a></h3>
<p>ファイルサイズに対するバリデーション (<a class="hyperref" href="#sec-image_validation"><span class="ref">11.4.2</span></a>) はうまくいきましたが、画像サイズ (縦横の長さ) に対する制限はないので、大きすぎる画像サイズがアップロードされると<a class="hyperref" href="#fig-large_uploaded_image">図<span class="ref">11.21</span></a>のようにレイアウトが壊れてしまいます。とはいえ、ユーザーに手元で画像サイズを変更させるのは不便です。なので、画像を表示させる前にサイズを変更する (リサイズする) ようにしてみましょう<sup class="footnote" id="cha-11_footnote-ref-16"><a href="#cha-11_footnote-16">16</a></sup>。</p>
<div class="center figure" id="fig-large_uploaded_image" data-tralics-id="uid1245" data-number="11.21">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/large_uploaded_image.png" alt="images/figures/large_uploaded_image"></div>
<div class="caption">
<span class="header">図11.21: </span><span class="description">恐ろしく大きなアップロード画像
</span>
</div>
</div>
<p>画像をリサイズするためには、画像を操作するプログラムが必要になります。今回は<a href="http://www.imagemagick.org/" target="_blank">ImageMagick</a>というプログラムを使うので、これを開発環境にインストールしておく必要になります (<a class="hyperref" href="#sec-image_upload_in_production"><span class="ref">11.4.4</span></a>でも説明しますが、本番環境がHerokuであれば、既に本番環境でImageMagickが使えるようになっています)。Cloud IDEでは、次のコマンドでこのプログラムをインストールできます<sup class="footnote" id="cha-11_footnote-ref-17"><a href="#cha-11_footnote-17">17</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo apt-get update
<span class="gp">$</span> sudo apt-get install imagemagick --fix-missing
</pre></div></div>
<p>次に、<a href="https://github.com/minimagick/minimagick" target="_blank">MiniMagick</a>というgemを使って、CarrierWaveからImageMagickを使えるようにします。<a href="http://www.rdoc.info/github/jnicklas/carrierwave/CarrierWave/MiniMagick" target="_blank">MiniMagickのドキュメント</a> (英語) を見るとさまざまな方法でリサイズできることがわかりますが、今回は<code>resize_to_limit: [400, 400]</code>という方法を使います。これは、縦横どちらかが400pxを超えていた場合、適切なサイズに縮小するオプションです (ただし小さい画像であっても拡大はしません)。ちなみに<a href="https://github.com/carrierwaveuploader/carrierwave#using-minimagick" target="_blank">CarrierWaveのMiniMagickの項目</a>を見ると、 小さすぎる画像を<em>引き延ばす</em>こともできるようですが、今回は使いません。したがって、最終的なコードは<a class="hyperref" href="#code-image_uploader_resizing">リスト<span class="ref">11.63</span></a>のようになります。これにより、大きな画像サイズでも適切にリサイズされるようになります (<a class="hyperref" href="#fig-resized_image">図<span class="ref">11.22</span></a>)。</p>
<div class="codelisting" id="code-image_uploader_resizing" data-tralics-id="uid1247" data-number="11.63">
<div class="heading">
<span class="number">リスト11.63:</span> 

<span class="description">画像をリサイズするために画像アップローダーを修正する<span class="break"></span> <span class="filepath">app/uploaders/picture_uploader.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>
</span><span class="hll">  <span class="n">process</span> <span class="ss">resize_to_limit</span><span class="p">:</span> <span class="o">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>
</span>
  <span class="n">storage</span> <span class="ss">:file</span>

  <span class="c1"># アップロードファイルの保存先ディレクトリは上書き可能</span>
  <span class="c1"># 下記はデフォルトの保存先</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># アップロード可能な拡張子のリスト</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
    <span class="sx">%w(jpg jpeg gif png)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-resized_image" data-tralics-id="uid1248" data-number="11.22">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/resized_image.png" alt="images/figures/resized_image"></div>
<div class="caption">
<span class="header">図11.22: </span><span class="description">いい感じにリサイズされた画像
</span>
</div>
</div>
</div>
<div id="sec-image_upload_in_production" class="subsection" data-tralics-id="uid1249" data-number="11.4.4">
<h3><a href="#sec-image_upload_in_production" class="heading hyperref"><span class="number">11.4.4 </span>本番環境での画像アップロード</a></h3>
<p>(訳注: この項はスキップできます。もしうまくいかなければスキップしても大丈夫です) <a class="hyperref" href="#sec-image_resizing"><span class="ref">11.4.3</span></a>で実装した画像アップローダーは、開発環境で動かす分には問題ないのですが、本番環境には適していません。これは<a class="hyperref" href="#code-image_uploader_resizing">リスト<span class="ref">11.63</span></a>の<code>storage :file</code>という行によって、ローカルのファイルシステムに画像を保存するようになっているからです<sup class="footnote" id="cha-11_footnote-ref-18"><a href="#cha-11_footnote-18">18</a></sup> (訳注: ただしHerokuのファイルシステムは一時的にしか使え無いので、本番にデプロイするたびに画像が消えます)。本番環境では、ファイルシステムではなくクラウドストレージサービスに画像を保存するようにしてみましょう<sup class="footnote" id="cha-11_footnote-ref-19"><a href="#cha-11_footnote-19">19</a></sup>。</p>
<p>本番環境でクラウドストレージに保存するためには、<a class="hyperref" href="#code-image_uploader_production">リスト<span class="ref">11.64</span></a>のように<span class="tt">fog</span> gemを使うと簡単です。</p>
<div class="codelisting" id="code-image_uploader_production" data-tralics-id="uid1252" data-number="11.64">
<div class="heading">
<span class="number">リスト11.64:</span> 

<span class="description">本番環境での画像アップロードを調整する<span class="break"></span> <span class="filepath">app/uploaders/picture_uploader.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>
  <span class="n">process</span> <span class="ss">resize_to_limit</span><span class="p">:</span> <span class="o">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>

<span class="hll">  <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
</span><span class="hll">    <span class="n">storage</span> <span class="ss">:fog</span>
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">    <span class="n">storage</span> <span class="ss">:file</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="c1"># アップロードファイルの保存先ディレクトリは上書き可能</span>
  <span class="c1"># 下記はデフォルトの保存先</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># アップロード可能な拡張子のリスト</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
    <span class="sx">%w(jpg jpeg gif png)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-image_uploader_production">リスト<span class="ref">11.64</span></a>では<code>production?</code>という論理値を返すメソッドを使っています。このメソッドは<a class="hyperref" href="sign_up?version=4.2#aside-rails_environments">コラム<span class="ref">7.1</span></a>でも紹介しましたが、これを使うと環境毎に保存先を切り替えることができます。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
  <span class="n">storage</span> <span class="ss">:fog</span>
<span class="k">else</span>
  <span class="n">storage</span> <span class="ss">:file</span>
<span class="k">end</span>
</pre></div></div>
<p>世の中には多くのクラウドストレージサービスがありますが、今回は有名で信頼性も高いアマゾンの「<a href="http://aws.amazon.com/s3/" target="_blank">Simple Storage Service (S3)</a><sup class="footnote" id="cha-11_footnote-ref-20"><a href="#cha-11_footnote-20">20</a></sup>」を使います。セットアップの手順は次のとおりです。</p>
<ol>
<li>
<a href="http://aws.amazon.com/" target="_blank">Amazon Web Services</a>アカウントにサインアップする
</li>
<li>
<a href="http://aws.amazon.com/iam/" target="_blank">AWS Identity and Access Management (IAM)</a>でユーザーを作成し、AccessキーとSecretキーをメモする
</li>
<li>
<a href="https://console.aws.amazon.com/s3" target="_blank">AWS Console</a>からS3 bucketを作成し (bucketの名前はなんでも大丈夫です)、2.で作成したユーザーに対してRead権限とWrite権限を付与する
</li>
</ol>
<p class="noindent">より詳細について知りたい場合は、<a href="http://aws.amazon.com/documentation/s3/" target="_blank">S3のドキュメント</a> (英語) を読んだり、GoogleやStack Overflowで検索してみたりしてください<sup class="footnote" id="cha-11_footnote-ref-21"><a href="#cha-11_footnote-21">21</a></sup> 。</p>
<p>S3アカウントの作成と設定が終わったら、CarrierWaveの設定ファイルを次の<a class="hyperref" href="#code-carrier_wave_configuration">リスト<span class="ref">11.65</span></a>のように修正してください。<br>
<br>
(訳注: fogでリージョンを指定する場合は、 :region =&gt; ENV['S3_REGION'] といったパラメータを渡し、heroku config:set S3_REGION="リージョン名" といったコマンドを実行することで設定できます。なお、東京のリージョン名は "ap-northeast-1" です。詳細はAmazon Web Serviceの<a href="http://docs.aws.amazon.com/ja_jp/general/latest/gr/rande.html#s3_region">リージョンとエンドポイント</a>を参照してください。)</p>
<div class="codelisting" id="code-carrier_wave_configuration" data-tralics-id="uid1258" data-number="11.65">
<div class="heading">
<span class="number">リスト11.65:</span> 

<span class="description">CarrierWaveを通してS3を使うように修正する<span class="break"></span> <span class="filepath">config/initializers/carrier_wave.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
  <span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1"># Amazon S3用の設定</span>
      <span class="ss">:provider</span>              <span class="o">=&gt;</span> <span class="s1">'AWS'</span><span class="p">,</span>
      <span class="ss">:aws_access_key_id</span>     <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_ACCESS_KEY'</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:aws_secret_access_key</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_SECRET_KEY'</span><span class="o">]</span>
    <span class="p">}</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>     <span class="o">=</span>  <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_BUCKET'</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">本番環境のメール設定 (<a class="hyperref" href="account_activation_password_reset?version=4.2#code-sendgrid_config">リスト<span class="ref">10.56</span></a>) と同様に、<a class="hyperref" href="#code-carrier_wave_configuration">リスト<span class="ref">11.65</span></a>ではHerokuの環境変数 <code>ENV</code> を使って、機密情報が漏洩しないようにしています。<a class="hyperref" href="account_activation_password_reset?version=4.2#sec-email_in_production"><span class="ref">10.3</span></a>では、SendGridのアドオンがこれらの環境変数を自動的に設定してくれましたが、今回は手動で設定する必要があります。<code>heroku config:set</code>コマンドを使って、次のようにHeroku上の環境変数を設定してください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku config:set <span class="nv">S3_ACCESS_KEY</span><span class="o">=</span>"ココに先ほどメモしたAccessキーを入力"
<span class="gp">$</span> heroku config:set <span class="nv">S3_SECRET_KEY</span><span class="o">=</span>"同様に、Secretキーを入力"
<span class="gp">$</span> heroku config:set <span class="nv">S3_BUCKET</span><span class="o">=</span>"Bucketの名前を入力"</pre></div></div>
<p>設定が無事に終わったら、これまでの変更をコミットしたりデプロイする準備が整いました。ただし、その前に<code>.gitignore</code>ファイルを<a class="hyperref" href="#code-gitignore_uploads">リスト<span class="ref">11.66</span></a>のように更新しおきましょう。これにより、画像を保存するディレクトリがGitへの保存対象から除かれるので、アプリケーションと関係の無い画像ファイルなどが無視できるようになります。</p>
<div class="codelisting" id="code-gitignore_uploads" data-tralics-id="uid1259" data-number="11.66">
<div class="heading">
<span class="number">リスト11.66:</span> 

<span class="description"><code>.gitignore</code>ファイルに画像用ディレクトリを追加する</span>
</div>

<div class="code"><div class="highlight"><pre># See https://help.github.com/articles/ignoring-files for more about ignoring
# files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore Spring files.
/spring/*.pid

<span class="hll"># Ignore uploaded test images.
</span><span class="hll">/public/uploads
</span></pre></div></div>
</div>
<p>それでは、これまでの変更をトピックブランチにコミットし、masterブランチにmergeしていきましょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Add user microposts"
$ git checkout master
$ git merge user-microposts
$ git push
</pre></div></div>
<p class="noindent">次に、Herokuへのデプロイ、データベースのリセット、サンプルデータの生成を順に実行していきます。</p>
<div class="code"><div class="highlight"><pre>$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rake db:migrate
$ heroku run rake db:seed
</pre></div></div>
<p class="noindent">Herokuには既にImageMagickがインストールされているので、(設定がうまくいっていれば) 画像リサイズや本番での画像アップロードも成功します。次の<a class="hyperref" href="#fig-image_upload_production">図<span class="ref">11.23</span></a>のようになっていれば成功です。</p>
<div class="center figure" id="fig-image_upload_production" data-tralics-id="uid1260" data-number="11.23">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/image_upload_production.png" alt="images/figures/image_upload_production"></div>
<div class="caption">
<span class="header">図11.23: </span><span class="description">本番環境での画像アップロード
</span>
</div>
</div>
</div>
</div><div id="cid77" class="section" data-tralics-id="cid77" data-number="11.5">
<h2><a href="#cid77" class="heading hyperref"><span class="number">11.5</span> 最後に</a></h2>
<p>Micropostsリソースの追加によって、サンプルアプリケーションはほぼ完成に近づきました。残すところは、ユーザーをお互いにフォローするソーシャルな仕組みのみとなります。<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>では、そのようなユーザー同士の関係 (リレーションシップ) をモデリングする方法を学び、それがマイクロポストのフィードにどのように関連するかを学びます。</p>
<p>もし<a class="hyperref" href="#sec-image_upload_in_production"><span class="ref">11.4.4</span></a>をスキップしていたら、ここで今までの変更のコミットとmergeを済ませてください。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Add user microposts"
$ git checkout master
$ git merge user-microposts
$ git push
</pre></div></div>
<p class="noindent">準備ができたら、本番環境へデプロイしてみましょう。</p>
<div class="code"><div class="highlight"><pre>$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rake db:migrate
$ heroku run rake db:seed
</pre></div></div>
<p>なお、必要なgemはここまでですべてインストールしたので、今後の章では新たなgemは追加しません。参考までに、最終状態の<code>Gemfile</code>を<a class="hyperref" href="#code-final_gemfile">リスト<span class="ref">11.67</span></a>に示します。</p>
<div class="codelisting" id="code-final_gemfile" data-tralics-id="uid1261" data-number="11.67">
<div class="heading">
<span class="number">リスト11.67:</span> 

<span class="description">サンプルアプリケーションの<code>Gemfile</code> (完成) </span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.7'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.4.2'</span>
<span class="n">gem</span> <span class="s1">'carrierwave'</span><span class="p">,</span>             <span class="s1">'0.10.0'</span>
<span class="n">gem</span> <span class="s1">'mini_magick'</span><span class="p">,</span>             <span class="s1">'3.8.0'</span>
<span class="n">gem</span> <span class="s1">'fog'</span><span class="p">,</span>                     <span class="s1">'1.26.0'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.0.7'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span>          <span class="s1">'3.2.0.0'</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>              <span class="s1">'5.0.2'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>                <span class="s1">'2.5.3'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span>            <span class="s1">'4.1.0'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span>            <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span>              <span class="s1">'2.3.0'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span>                <span class="s1">'2.2.3'</span>
<span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span>                    <span class="s1">'0.4.0'</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:doc</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span>     <span class="s1">'1.3.9'</span>
  <span class="n">gem</span> <span class="s1">'byebug'</span><span class="p">,</span>      <span class="s1">'3.4.0'</span>
  <span class="n">gem</span> <span class="s1">'web-console'</span><span class="p">,</span> <span class="s1">'2.0.0.beta3'</span>
  <span class="n">gem</span> <span class="s1">'spring'</span><span class="p">,</span>      <span class="s1">'1.1.3'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'minitest-reporters'</span><span class="p">,</span> <span class="s1">'1.0.5'</span>
  <span class="n">gem</span> <span class="s1">'mini_backtrace'</span><span class="p">,</span>     <span class="s1">'0.1.3'</span>
  <span class="n">gem</span> <span class="s1">'guard-minitest'</span><span class="p">,</span>     <span class="s1">'2.3.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span>             <span class="s1">'0.17.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
  <span class="n">gem</span> <span class="s1">'puma'</span><span class="p">,</span>           <span class="s1">'2.11.1'</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div id="sec-user_microposts_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid1262" data-number="11.5.1">
<h3><a href="#sec-user_microposts_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">11.5.1 </span>本章のまとめ</a></h3>
<ul>
<li>Active Recordモデルの力によって、マイクロポストも (ユーザーと同じで) リソースとして扱える
</li>
<li>Railsは複数のキーインデックスをサポートしている
</li>
<li>Userは複数のMicropostsを持っていて (<code>has_many</code>)、Micropostは1人のUserに依存している (<code>belongs_to</code>) といった関係性をモデル化した
</li>
<li>
<code>has_many</code>や<code>belongs_to</code>を利用することで、関連付けを通して多くのメソッドが使えるようになった
</li>
<li>
<code>user.microposts.build(...)</code>というコードは、引数で与えたユーザーに関連付けされたマイクロポストを返す
</li>
<li>
<code>default_scope</code>を使うとデフォルトの順序を変更できる
</li>
<li>default_scopeは引数に無名関数 (-&gt;) を取る
</li>
<li>
<code>dependent: :destroy</code>オプションを使うと、関連付けされたオブジェクトが削除されると同時に、自分自身も削除する
</li>
<li>paginateメソッドやcountメソッドは、どちらも関連付けを通して実行され、効率的にデータベースに問い合わせしている
</li>
<li>fixtureは、関連付けを使ったオブジェクトの作成もサポートとしている
</li>
<li>パーシャルを呼び出すときに、一緒に変数を渡すことができる
</li>
<li>
<code>where</code>メソッドを使うと、Active Recordを通して選択 (部分集合を取り出すこと) ができる
</li>
<li>依存しているオブジェクトを作成/削除するときは、常に関連付けを通すようにすることで、よりセキュアな操作が実現できる
</li>
<li>CarrierWaveを使うと画像アップロードや画像リサイズができる
</li>
</ul>
</div>
</div><div id="sec-micropost_exercises" class="section" data-tralics-id="cid78" data-number="11.6">
<h2><a href="#sec-micropost_exercises" class="heading hyperref"><span class="number">11.6</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で原著を購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>なお、演習とチュートリアル本編の食い違いを避ける方法については、演習用のトピックブランチに追加したメモ (<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>) を参考にしてください。</p>
<ol>
<li>
<code>if</code>-<code>else</code>文の2つの分岐に対して、それぞれ異なるパーシャルを使用するようにホームページをリファクタリングしてください。
</li>
<li>サイドバーにあるマイクロポストの合計投稿数をテストしてください。このとき、単数形 (micropost) と複数形 (microposts) が正しく表示されているかどうかもテストしてください。(<a class="hyperref" href="#code-sidebar_micropost_count">リスト<span class="ref">11.68</span></a>を参考にしてみてください)
</li>
<li>
<a class="hyperref" href="#code-image_upload_test">リスト<span class="ref">11.69</span></a>に示すテンプレートを参考に、<a class="hyperref" href="#sec-micropost_images"><span class="ref">11.4</span></a>で実装した画像アップローダーをテストしてください。テストの準備として、まずはサンプル画像をfixtureディレクトリに追加してください (コマンド例: "<code>cp app/assets/images/rails.png</code> <code>test/fixtures/</code>")。紛らわしいエラーを回避するためには、CarrierWaveの設定を変更し、テスト環境では画像リサイズをしないようにする必要があるので、<a class="hyperref" href="#code-skip_resize_initializer">リスト<span class="ref">11.70</span></a>に示す設定ファイルを使ってください。<a class="hyperref" href="#code-image_upload_test">リスト<span class="ref">11.69</span></a>で追加したテストでは、マイクロポストの投稿フォームやpicture属性をいじって、無効な送信や有効な送信をチェックしています。なお、テスト内にある<code>fixture_file_upload</code>というメソッドは、fixtureで定義されたファイルをアップロードする特別なメソッドです<sup class="footnote" id="cha-11_footnote-ref-22"><a href="#cha-11_footnote-22">22</a></sup>。<em>ヒント</em>: <code>picture</code>属性が有効かどうかを確かめるときは、<a class="hyperref" href="account_activation_password_reset?version=4.2#sec-activation_test_and_refactoring"><span class="ref">10.1.4</span></a>で紹介した<code>assigns</code>メソッドを使ってください。このメソッドを使うと、 投稿に成功した後に<code>create</code>アクション内のマイクロポストにアクセスするようになります。
</li>
</ol>
<div class="codelisting" id="code-sidebar_micropost_count" data-tralics-id="uid1281" data-number="11.68">
<div class="heading">
<span class="number">リスト11.68:</span> 

<span class="description">サイドバーでマイクロポストの投稿数をテストするためのテンプレート<span class="break"></span> <span class="filepath">test/integration/microposts_interface_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"micropost sidebar count"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="s2">"</span><span class="si">#{</span><span class="no">FILL_IN</span><span class="si">}</span><span class="s2"> microposts"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># User with zero microposts</span>
    <span class="n">other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:mallory</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="s2">"0 microposts"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">other_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"A micropost"</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-image_upload_test" data-tralics-id="uid1282" data-number="11.69">
<div class="heading">
<span class="number">リスト11.69:</span> 

<span class="description">画像アップロードをテストするためのテンプレート<span class="break"></span> <span class="filepath">test/integration/microposts_interface_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"micropost interface"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s1">'input[type=FILL_IN]'</span>
</span>    <span class="c1"># Invalid submission</span>
    <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># Valid submission</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">"This micropost really ties the room together"</span>
<span class="hll">    <span class="n">picture</span> <span class="o">=</span> <span class="n">fixture_file_upload</span><span class="p">(</span><span class="s1">'test/fixtures/rails.png'</span><span class="p">,</span> <span class="s1">'image/png'</span><span class="p">)</span>
</span>    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
<span class="hll">      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="ss">picture</span><span class="p">:</span> <span class="no">FILL_IN</span> <span class="p">}</span>
</span>    <span class="k">end</span>
<span class="hll">    <span class="n">assert</span> <span class="no">FILL_IN</span><span class="o">.</span><span class="n">picture?</span>
</span>    <span class="n">follow_redirect!</span>
    <span class="n">assert_match</span> <span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># Delete a post.</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'delete'</span>
    <span class="n">first_micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="n">first_micropost</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># Visit a different user.</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">))</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="p">{</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-skip_resize_initializer" data-tralics-id="uid1283" data-number="11.70">
<div class="heading">
<span class="number">リスト11.70:</span> 

<span class="description">テスト環境で画像のリサイズ処理をスキップする<span class="break"></span> <span class="filepath">config/initializers/skip_image_resizing.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
  <span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">enable_processing</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div><div id="cha-11_footnotes">
  <div class="navigation">
<a class="next_page" href="following_users?version=4.2#cha-following_users"><span class="number">第12章</span>ユーザーをフォローする</a><a class="prev_page" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="number">第10章</span>アカウントの有効化とパスワードのリセット</a>
</div>
<ol class="footnotes">
    <li id="cha-11_footnote-1">この名前はTwitterの<em>マイクロブログ</em>という説明分から着想を得ました。ブログにはポストがあるので、マイクロブログがあればマイクロポストもある、といった具合です。<a class="arrow" href="#cha-11_footnote-ref-1">↑</a>
</li>
    <li id="cha-11_footnote-2">http://www.postgresql.org/docs/9.1/static/datatype-character.html&nbsp;<a class="arrow" href="#cha-11_footnote-ref-2">↑</a>
</li>
    <li id="cha-11_footnote-3">外部参照キーは、データベースレベルでの制約です。これによって、Micropostsテーブルのuser_idは、Usersテーブルのidカラムを参照するようになります。本チュートリアルでこの詳細が重要になることはありません。また、この外部キーによる制約は、すべてのデータベースで使えるわけではありません (たとえばHerokuのPostgreSQLではサポートされていますが、開発用のSQLiteではサポートされていません)。外部キーの詳細は<a class="hyperref" href="following_users?version=4.2#sec-relationship_user_associations"><span class="ref">12.1.2</span></a>で学びます。<a class="arrow" href="#cha-11_footnote-ref-3">↑</a>
</li>
    <li id="cha-11_footnote-4">ユーザー一覧を実装するときも (<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-updating_and_deleting_users_conclusion"><span class="ref">9.5</span></a>)、似たような問題にぶつかりました。<a class="arrow" href="#cha-11_footnote-ref-4">↑</a>
</li>
    <li id="cha-11_footnote-5">SQLは大文字小文字を区別しませんが、慣習的にSQLのキーワード ( <code>DESC</code>など) は大文字で書くことになっています。<a class="arrow" href="#cha-11_footnote-ref-5">↑</a>
</li>
    <li id="cha-11_footnote-6">
(<code>Faker::Lorem.sentence</code>は、いわゆる<em>lorem ipsum</em>ダミーテキストを返します。<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>で述べたように、<em>lorem ipsum</em>には面白い<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean" target="_blank">裏話</a>があります)。<a class="arrow" href="#cha-11_footnote-ref-6">↑</a>
</li>
    <li id="cha-11_footnote-7">Faker gemの<em>lorem ipsum</em>サンプルテキストはランダムに生成される仕様になっているため、サンプルマイクロポストの内容はこの図と違っているはずです。<a class="arrow" href="#cha-11_footnote-ref-7">↑</a>
</li>
    <li id="cha-11_footnote-8">便宜上、<a class="hyperref" href="#code-micropost_css">リスト<span class="ref">11.25</span></a>はこの章で必要なCSSを<em>すべて</em>含んでいます。<a class="arrow" href="#cha-11_footnote-ref-8">↑</a>
</li>
    <li id="cha-11_footnote-9">もし<code>full_title</code>ヘルパーを使って他のテストもリファクタリングしたくなったら (例えば<a class="hyperref" href="static_pages?version=4.2#code-base_title_test">リスト<span class="ref">3.38</span></a>など)、<code>test_helper.rb</code>からApplicationヘルパーをインクルードしてください。<a class="arrow" href="#cha-11_footnote-ref-9">↑</a>
</li>
    <li id="cha-11_footnote-10">
<code>where</code>メソッドや他の関連するメソッドの詳細については、Railsガイドの<a href="http://railsguides.jp/active_record_querying.html" target="_blank">Active Record クエリインターフェイス</a>を読んでください。<a class="arrow" href="#cha-11_footnote-ref-10">↑</a>
</li>
    <li id="cha-11_footnote-11">これは、HTTPの仕様として定義されている<span class="tt">HTTP_REFERER</span>と対応しています。 ちなみに “referer” は誤字ではありません。仕様では確かにこの(間違った)スペルを使っているのです。一方、Railsは “referrer” という正しいスペルで使っています。<a class="arrow" href="#cha-11_footnote-ref-11">↑</a>
</li>
    <li id="cha-11_footnote-12">私もRailsがどうやってこのURLを取得しているのか、パッと思い出すことはできませんでした。そこで、Googleで “rails request previous url” と検索し、<a href="http://stackoverflow.com/questions/4652084/ruby-on-rails-how-do-you-get-the-previous-url" target="_blank">Stack Overflowのスレッド</a>を見つけ、この答えに至りました。<a class="arrow" href="#cha-11_footnote-ref-12">↑</a>
</li>
    <li id="cha-11_footnote-13">ビーチの写真は https://www.flickr.com/photos/grungepunk/14026922186&nbsp;から引用しました。<a class="arrow" href="#cha-11_footnote-ref-13">↑</a>
</li>
    <li id="cha-11_footnote-14">最初は<code>image</code>という属性名を使っていたのですが、この名前だと一般的すぎて、逆に混乱を招いてしまいました。<a class="arrow" href="#cha-11_footnote-ref-14">↑</a>
</li>
    <li id="cha-11_footnote-15">この手のトピックを学ぶには「Googleで “javascript maximum file size”といった関連するキーワードで検索し、Stack Overflowが見つかるまで (検索ワードを調整しながら) 繰り返す」、これが一番です。<a class="arrow" href="#cha-11_footnote-ref-15">↑</a>
</li>
    <li id="cha-11_footnote-16">他の解決策としてCSSで<em>表示</em>サイズを調整する方法もありますが、これだとファイルサイズが変わりません。結果として、ファイルサイズの大きな画像によって、読み込み時間が長くなるといった問題が発生します。たとえば "小さい" 画像を表示するだけなのに、やたらに読み込み時間が長いウェブサイトに訪れたことはありませんか。これがその原因です。<a class="arrow" href="#cha-11_footnote-ref-16">↑</a>
</li>
    <li id="cha-11_footnote-17">
<a href="https://help.ubuntu.com/community/ImageMagick" target="_blank">Ubuntuの公式ドキュメント</a> (英語) でこれを見つけました。もしCloud IDEやLinuxライクなシステム以外で開発しているのであれば、Google で “imagemagick &lt;あなたのプラットフォーム名&gt;” と検索してください。なお、OS&nbsp;Xであれば <code>brew install imagemagick</code> でインストールできます (<a href="http://brew.sh/" target="_blank">Homebrew</a>がインストールされていなければインストールしてください)。<a class="arrow" href="#cha-11_footnote-ref-17">↑</a>
</li>
    <li id="cha-11_footnote-18">特に、Herokuのファイルストレージは一時的なので、アップロードした画像はデプロイする度に削除される仕様になっています (訳注: とはいえ、アプリケーションの動作を本番環境で確認するだけであれば、Herokuのファイルストレージのままでも問題はありません)。<a class="arrow" href="#cha-11_footnote-ref-18">↑</a>
</li>
    <li id="cha-11_footnote-19">この節の内容は必須ではありませんので、スキップしても問題ありません。<a class="arrow" href="#cha-11_footnote-ref-19">↑</a>
</li>
    <li id="cha-11_footnote-20">S3は課金サービスですが、Railsチュートリアルのサンプルアプリケーションをセットアップしたりテストするだけであれば、毎月1円ほどしか課金されません。<a class="arrow" href="#cha-11_footnote-ref-20">↑</a>
</li>
    <li id="cha-11_footnote-21">http://aws.amazon.com/documentation/s3/&nbsp;<a class="arrow" href="#cha-11_footnote-ref-21">↑</a>
</li>
    <li id="cha-11_footnote-22">Windows上で開発している場合は (Cloud IDEで開発してれば大丈夫です)、次のように<code>:binary</code>パラメーターを追加してください。 <code>fixture_file_upload(file, type, :binary)</code><a class="arrow" href="#cha-11_footnote-ref-22">↑</a>
</li>
  </ol>
</div>
          </div>

  </body>
</html>
