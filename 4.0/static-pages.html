<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<div id="top"></div>


          <div id="cha-static_pages" class="chapter" data-tralics-id="cid15" data-number="3" data-chapter="static_pages">
<h1><a href="#cha-static_pages" class="heading hyperref"><span class="number">第3章</span> ほぼ静的なページの作成</a></h1>
<p>本章から、本格的なサンプルアプリケーションの開発を進めていきます。残りのチュートリアルでは、このアプリケーションを例題として扱って学習していくことになります。本書を通して開発するアプリケーションは、最終的にはユーザーやマイクロポスト、ログイン/ログアウトなどの認証機能を持ちますが、まずは簡単なトピックである「静的なページの作成」から始めます。非常に単純なページではありますが、静的なページを自分の手で作成することは良い経験になり、多くの示唆も得られます。私達がこれから開発するアプリケーションにとって最適なスタート地点といえるでしょう。</p>
<p>Rails はデータベースと連携して動的なWebサイトを開発するように設計されていますが、HTMLファイルだけで構成されている静的なページを作ることもできます。実際、Railsであえて静的なページを使用しておいて、後から<em>ほんの少し</em>動的なコンテンツを追加することもできます。本章では、このような静的なページの作成について学んでいきます。本章ではそれと平行して、近年のプログラミングで不可欠となっている「<em>自動化テスト</em>」の雰囲気を掴んでいただきます。自動化テストを作成することで、コードが正しく動いていることが裏付けられます。さらに、良いテストを書くことで、自信をもって<em>リファクタリング</em>を行うことができます。たとえば、フォームの振る舞いを変更せずに、フォーム内で使われている関数を書き換えたいときに有用です。</p>
</div><div id="sec-sample_app_setup" class="section" data-tralics-id="cid16" data-number="3.1">
<h2><a href="#sec-sample_app_setup" class="heading hyperref"><span class="number">3.1 </span>セットアップ</a></h2>
<p><a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app">第<span class="ref">2</span>章</a>と同様に、新しいRailsプロジェクトを作成するところから始めます。今回は<code>sample_app</code>という名前にします (<a class="hyperref" href="#code-rails_new_sample_app">リスト<span class="ref">3.1</span></a>)<sup class="footnote" id="cha-3_footnote-ref-1"><a href="#cha-3_footnote-1">1</a></sup>。<a class="hyperref" href="#code-rails_new_sample_app">リスト<span class="ref">3.1</span></a>のコマンドを実行したときに「Could not find ’railties'」のようなエラーが発生した場合は、Railsのバージョンが正しくない可能性がありますので、<a class="hyperref" href="beginning?version=4.2#code-installing_rails">リスト<span class="ref">1.1</span></a>のとおりに正しくコマンドを入力したかどうかを確認してください。</p>
<div class="codelisting" id="code-rails_new_sample_app" data-tralics-id="uid223" data-number="3.1">
<div class="heading">
<span class="number">リスト3.1:</span> 

<span class="description">サンプルアプリケーションを生成する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/workspace
<span class="gp">$</span> rails _4.2.2_ new sample_app
<span class="gp">$</span> <span class="nb">cd </span>sample_app/
</pre></div></div>
</div>
<p class="noindent">(<a class="hyperref" href="toy_app?version=4.2#sec-planning_the_application"><span class="ref">2.1</span></a>でも説明したとおり、クラウドIDEをご利用の方は、このプロジェクトをこれまでの2つの章で作成したプロジェクトと同じワークスペースに置くことができます。このプロジェクトで特に新しいワークスペースを作成する必要はありません)。</p>
<p>次は、<a class="hyperref" href="toy_app?version=4.2#sec-planning_the_application"><span class="ref">2.1</span></a>と同じように、テキストエディタを使って<code>Gemfile</code>に必要なgemを書き足していきます。<a class="hyperref" href="#code-gemfile_sample_app">リスト<span class="ref">3.2</span></a>は<a class="hyperref" href="beginning?version=4.2#code-gemfile_sqlite_version">リスト<span class="ref">1.5</span></a>や<a class="hyperref" href="toy_app?version=4.2#code-demo_gemfile_sqlite_version_redux">リスト<span class="ref">2.1</span></a>は基本的にまったく同じですが、<code>test</code>グループ内のgemだけが若干異なっています。ここではもう少し高度なテスト用オプションを設定しています (<a class="hyperref" href="#sec-advanced_testing_setup"><span class="ref">3.7</span></a>) (<em>注</em>: もしサンプルアプリケーションの開発で必要になるgemを<em>すべて</em>知りたい場合は、<a class="hyperref" href="user_microposts?version=4.2#code-final_gemfile"><span class="ref">リスト11.67</span></a>を参照してください。これが最終的なGemfileになります)。</p>
<div class="codelisting" id="code-gemfile_sample_app" data-tralics-id="uid224" data-number="3.2">
<div class="heading">
<span class="number">リスト3.2:</span> 

<span class="description">サンプルアプリケーション用の<code>Gemfile</code></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>        <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'5.0.2'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'2.5.3'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.1.0'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span>   <span class="s1">'2.3.0'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span>     <span class="s1">'2.2.3'</span>
<span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span>         <span class="s1">'0.4.0'</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:doc</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span>     <span class="s1">'1.3.9'</span>
  <span class="n">gem</span> <span class="s1">'byebug'</span><span class="p">,</span>      <span class="s1">'3.4.0'</span>
  <span class="n">gem</span> <span class="s1">'web-console'</span><span class="p">,</span> <span class="s1">'2.0.0.beta3'</span>
  <span class="n">gem</span> <span class="s1">'spring'</span><span class="p">,</span>      <span class="s1">'1.1.3'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'minitest-reporters'</span><span class="p">,</span> <span class="s1">'1.0.5'</span>
  <span class="n">gem</span> <span class="s1">'mini_backtrace'</span><span class="p">,</span>     <span class="s1">'0.1.3'</span>
  <span class="n">gem</span> <span class="s1">'guard-minitest'</span><span class="p">,</span>     <span class="s1">'2.3.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span>             <span class="s1">'0.17.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>前の2つの章と同様に<code>bundle install</code>を実行して、<code>Gemfile</code>で指定したgemをインストール、インクルードします。ただし、「<span class="inline_verbatim">--without</span> <span class="inline_verbatim">production</span>」オプション<sup class="footnote" id="cha-3_footnote-ref-2"><a href="#cha-3_footnote-2">2</a></sup>を指定して、productionでしか使わないgemをインストールしないようにしておきます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production</pre></div></div>
<p class="noindent">上のオプションを指定することで、PostgreSQL用の<span class="tt">pg</span> gemをdevelopment環境にインストールせず、代わりにSQLiteがdevelopment環境testing環境で使用されるようになります。Herokuでは、development環境とproduction環境とで異なるデータベースを使用することを非推奨としていますが、幸いにもこのサンプルアプリケーションでは両者の違いは生じません。また、SQLiteの方がPostgreSQLよりもローカルでのインストールや設定が<em>ずっと楽</em>なので<sup class="footnote intersentence" id="cha-3_footnote-ref-3"><a href="#cha-3_footnote-3">3</a></sup>、今回はことなるデータベースを使うことにします。ここで使用する<code>Gemfile</code>で指定されているのと異なるバージョンのgem (Rails自身のgemを含む) をこれまでにインストールしていた場合は、以下のように<code>bundle update</code>を実行してgemを<em>更新</em>し、gemのバージョンを合わせておくとよいでしょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle update</pre></div></div>
<p class="noindent">ここまで進めたら、後はGitリポジトリを初期化するだけです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Initialize repository"</span>
</pre></div></div>
<p>最初のアプリケーションのときと同様に、まずはアプリケーションのルートディレクトリにある<code>README</code>ファイルを更新して、具体的な作業内容をわかりやすく記入しておくことをおすすめします。最初にGitのコマンドでREADMEのファイル形式をRDocからMarkdownに変更します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md</pre></div></div>
<p class="noindent">続いて<a class="hyperref" href="#code-sample_app_readme">リスト<span class="ref">3.3</span></a>の内容をREADMEに記入します。</p>
<div class="codelisting" id="code-sample_app_readme" data-tralics-id="uid227" data-number="3.3">
<div class="heading">
<span class="number">リスト3.3:</span> 

<span class="description">サンプルアプリケーション向けに書き換えた<code>README</code></span>
</div>

<div class="code"><div class="highlight"><pre># Ruby on Railsチュートリアル: サンプルアプリケーション

これは以下に基づいたサンプル・アプリケーションです
[*Ruby on Railsチュートリアル:
実例を使ってRailsを学ぼう*](http://railstutorial.jp/)
[Michael Hartl](http://www.michaelhartl.com/)著
</pre></div></div>
</div>
<p class="noindent">最後に、変更をコミットします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -am <span class="s2">"Improve the README"</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="beginning?version=4.2#sec-git_commands"><span class="ref">1.4.4</span></a>で<code>git commit -a -m "Message"</code>というGitコマンドを実行したことを思い出してください。あのときは “すべてを変更” (<code>-a</code>) オプションとコミットメッセージを追加するオプション (<code>-m</code>) を使用しました。上で実行したコマンドで示したように、実はこれらの2つのオプションを1つにまとめて<code>git commit -am "Message"</code>と実行することができます。</p>
<p>本書では今後もこのサンプルアプリケーションを使い続けるので、<a href="https://bitbucket.org/repo/create" target="_blank">Bitbucket上にリポジトリを作成してプッシュしておく</a>とよいでしょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@bitbucket.org:&lt;username&gt;/sample_app.git
<span class="gp">$</span> git push -u origin --all <span class="c"># リポジトリと参照を初めてプッシュする</span>
</pre></div></div>
<p>後で統合時に悩まずにすむよう、アプリをなるべく早い段階でHerokuにデプロイしておくとよいでしょう。<a class="hyperref" href="beginning?version=4.2#cha-beginning">第<span class="ref">1</span>章</a>や<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app">第<span class="ref">2</span>章</a>と同様に、<a class="hyperref" href="beginning?version=4.2#code-hello_action">リスト<span class="ref">1.8</span></a>や<a class="hyperref" href="beginning?version=4.2#code-default_root_route"><span class="ref">1.9</span></a>の「Hello, world」の手順に従うことをお勧めします<sup class="footnote" id="cha-3_footnote-ref-4"><a href="#cha-3_footnote-4">4</a></sup>。終わったら以下のように変更をコミットしてHerokuにプッシュします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -am <span class="s2">"Add hello"</span>
<span class="gp">$</span> heroku create
<span class="gp">$</span> git push heroku master
</pre></div></div>
<p>(<a class="hyperref" href="beginning?version=4.2#sec-deploying"><span class="ref">1.5</span></a>のときと同じように警告メッセージが表示されることがありますが、無視して構いません。この警告は<a class="hyperref" href="sign_up?version=4.2#sec-professional_grade_deployment"><span class="ref">7.5</span></a>で解決する予定です)。これで、Herokuアプリのアドレス以外は<a class="hyperref" href="beginning?version=4.2#fig-heroku_app">図<span class="ref">1.18</span></a>のとおりに表示されるはずです。</p>
<p>この後も、本チュートリアルを進めながらアプリケーションをこまめにプッシュ/デプロイすることをおすすめします。こうすることでリモートバックアップにもなり、production環境でのエラーを早めに確認することもできます (訳注: 最後にまとめてプッシュ/デプロイすると問題が同時多発して解決に手間取ることが考えられます)。なお、Herokuに展開するときにエラーが発生した場合は、以下のコマンドを実行して本番環境のログを取得してください。このログは、問題を特定するときに役立ちます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs</pre></div></div>
<p class="noindent"><em>注</em>: 今後Herokuで何らかの本番アプリケーションを運用する予定があるなら、<a class="hyperref" href="sign_up?version=4.2#sec-professional_grade_deployment"><span class="ref">7.5</span></a>のproduction用Webサーバーの設定に必ず従ってください。</p>
</div><div id="sec-static_pages" class="section" data-tralics-id="cid17" data-number="3.2">
<h2><a href="#sec-static_pages" class="heading hyperref"><span class="number">3.1</span> 静的ページ</a></h2>
<p><a class="hyperref" href="#sec-sample_app_setup"><span class="ref">3.1</span></a>の準備がすべて完了したら、いよいよサンプルアプリケーションの開発に取りかかりましょう。この節では、Railsの<em>アクション</em>や<em>ビュー</em>を作成して、静的なHTMLのみのページを動的なページに作り変えるための最初の手順を進めます<sup class="footnote" id="cha-3_footnote-ref-5"><a href="#cha-3_footnote-5">5</a></sup>。Railsのアクションは<em>コントローラ</em> (<a class="hyperref" href="beginning?version=4.2#sec-mvc"><span class="ref">1.3.3</span></a>で言うMVCの「C」) の中に置かれます。コントローラには、目的に沿って互いに関連したアクションが置かれます。コントローラについては<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app">第<span class="ref">2</span>章</a>でも簡単に触れましたが、<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users">第<span class="ref">6</span>章</a>で説明する<a href="http://ja.wikipedia.org/wiki/Representational_State_Transfer" target="_blank">REST アーキテクチャ</a>を読むと理解が深まります。一言で言うと、コントローラとは (基本的に動的な) Webページの集合を束ねるコンテナのことです。現在どのディレクトリで作業しているかがわからなくなった場合は、<a class="hyperref" href="beginning?version=4.2#sec-the_hello_application"><span class="ref">1.3</span></a> (<a class="hyperref" href="beginning?version=4.2#fig-directory_structure_rails"><span class="ref">図 1.4</span></a>)を再度参照して、Rails のディレクトリ構造を確認してください。この節では、主に<code>app/controllers</code>ディレクトリや<code>app/views</code>ディレクトリ内で作業を進めます。</p>
<p><a class="hyperref" href="beginning?version=4.2#sec-git_commands"><span class="ref">1.4.4</span></a>で学んだことを思い出しましょう。Gitを使用する場合は、masterブランチでずっと作業するのではなく、その都度トピックブランチを作成して作業するのがよい習慣です。Gitでバージョン管理を行っているのであれば、以下のコマンドを実行して、静的なページ用のトピックブランチをチェックアウトしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b static-pages
</pre></div></div>
<p class="noindent">(1行目は、確実にmasterブランチに切り替えるために行っています。これにより、2行目の<code>static-pages</code>トピックブランチが<code>master</code>から作成されるようになります。もしすでにmasterブランチにいる場合は、1行目のコマンドを実行する必要はありません)。</p>
<div id="sec-generated_static_pages" class="subsection" data-tralics-id="uid230" data-number="3.2.1">
<h3><a href="#sec-generated_static_pages" class="heading hyperref"><span class="number">3.2.1 </span>静的なページの生成</a></h3>
<p>静的なページの作成は、<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app">第<span class="ref">2</span>章</a>でscaffold生成に使用した<code>generate</code>スクリプトで、コントローラを生成することから始めます。このコントローラは静的なページを扱うためにしか使わないので、コントローラ名を「Static Pages」に決め、表記を<a href="https://ja.wikipedia.org/wiki/%E3%82%AD%E3%83%A3%E3%83%A1%E3%83%AB%E3%82%B1%E3%83%BC%E3%82%B9" target="_blank">キャメルケース</a>の<code>StaticPages</code>にします。続いて、Homeページ、Helpページ、Aboutページに使用するアクションもそれぞれ作成することにし、アクション名はすべて小文字の<code>home</code>、<code>help</code>、<code>about</code>にします。<code>generate</code>スクリプトではアクション名をまとめて指定することもできるので、コマンドラインでHomeページとHelpページ用のアクションもまとめて生成することにします。なお、Aboutページだけは学習のため、あえてコマンドラインでは作成せず、<a class="hyperref" href="#sec-getting_started_with_testing"><span class="ref">3.3</span></a>で手動で追加することにします。これらの要素を盛り込んだStaticPagesコントローラ生成コマンドと実行結果を<a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>に示します。</p>
<div class="codelisting" id="code-generating_pages" data-tralics-id="uid231" data-number="3.4">
<div class="heading">
<span class="number">リスト3.4:</span> 

<span class="description">StaticPagesコントローラを生成する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll">$ rails generate controller StaticPages home help
</span>      create  app/controllers/static_pages_controller.rb
       route  get 'static_pages/help'
       route  get 'static_pages/home'
      invoke  erb
      create    app/views/static_pages
      create    app/views/static_pages/home.html.erb
      create    app/views/static_pages/help.html.erb
      invoke  test_unit
      create    test/controllers/static_pages_controller_test.rb
      invoke  helper
      create    app/helpers/static_pages_helper.rb
      invoke    test_unit
      create      test/helpers/static_pages_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/static_pages.js.coffee
      invoke    scss
      create      app/assets/stylesheets/static_pages.css.scss
</pre></div></div>
</div>
<p class="noindent">追伸: <code>rails g</code>は <code>rails generate</code>コマンドの短縮形であり、Railsでサポートされている多数の短縮形のひとつです (<a class="hyperref" href="#table-shortcuts">表<span class="ref">3.1</span></a>)。本チュートリアルではわかりやすさを重んじているため、こうしたコマンドは短縮せずに表記していますが、現実のRails開発者はほぼ間違いなく<a class="hyperref" href="#table-shortcuts">表<span class="ref">3.1</span></a>の短縮形を常用しています。</p>
<div class="table" id="table-shortcuts" data-tralics-id="uid232" data-number="3.1">
<table class="tabular">
<tr class="bottom_border">
<td class="align_left right_border"><strong>完全なコマンド</strong></td>
<td class="align_left"><strong>短縮形</strong></td>
</tr>
<tr>
<td class="align_left right_border"><code>$ rails server</code></td>
<td class="align_left"><code>$ rails s</code></td>
</tr>
<tr>
<td class="align_left right_border"><code>$ rails console</code></td>
<td class="align_left"><code>$ rails c</code></td>
</tr>
<tr>
<td class="align_left right_border"><code>$ rails generate</code></td>
<td class="align_left"><code>$ rails g</code></td>
</tr>
<tr>
<td class="align_left right_border"><code>$ bundle install</code></td>
<td class="align_left"><code>$ bundle</code></td>
</tr>
<tr>
<td class="align_left right_border"><code>$ rake test</code></td>
<td class="align_left"><code>$ rake</code></td>
</tr>
</table>
<div class="caption">
<span class="header">表3.1: </span><span class="description">Railsで使える短縮形の例
</span>
</div>
</div>
<p>次に進む前に、StaticPagesコントローラファイルをGitリポジトリに追加しておきましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Add a Static Pages controller"</span>
<span class="gp">$</span> git push -u origin static-pages
</pre></div></div>
<p class="noindent">最後のコマンドでは、<code>static-pages</code>トピックブランチをBitbucketにプッシュしています。以後は、単に以下を実行するだけで同じプッシュが行われるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push</pre></div></div>
<p class="noindent">上のコミット〜プッシュの流れは、著者が実際の開発でよく使っていたパターンに基づいていますが、ここから先は途中でこのような指示をいちいち書くことはしませんので、各自こまめにプッシュするようにしてください。</p>
<p><a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>では、コントローラ名をキャメルケース (訳注: 単語の頭文字を大文字にしてつなぎ合わせた名前) で渡していることに注目してください。こうすると、StaticPagesコントローラ名を<a href="https://ja.wikipedia.org/wiki/%E3%82%AD%E3%83%A3%E3%83%A1%E3%83%AB%E3%82%B1%E3%83%BC%E3%82%B9%23.E3.81.9D.E3.81.AE.E4.BB.96.E3.81.AE.E7.B6.B4.E3.82.8A.E6.96.B9" target="_blank">スネークケース</a> (訳注: 単語間にアンダースコアを加えて繋ぎ合わせた名前) にしたファイル <code>static_pages_controller.rb</code> を自動的に生成します。ただし、上のような命名は単なる慣習に過ぎません。実際、コマンドライン上で以下のようなスネークケースのコントローラ名を入力しても、</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller static_pages ...
</pre></div></div>
<p class="noindent">先ほどと同様に<code>static_pages_controller.rb</code>というコントローラが生成されます。これは、Rubyがクラス名にキャメルケースを使う慣習があり (詳細は<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-ruby_classes"><span class="ref">4.4</span></a>で説明します)、また、キャメルケースの名前を使うことが好まれているためです。これらの慣習に必ず従わなければいけないということではありません。(同様にRubyでは、ファイル名をスネークケースで記述する慣習があります。このため Railsのgenerateスクリプトでは、 <a href="http://www.google.com/url?q=http%3A%2F%2Fapi.rubyonrails.org%2Fclasses%2FActiveSupport%2FInflector.html%23method-i-underscore&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEXlQHwplyXw62X6eM34Pe9__H4MA"><span class="tt">underscore</span></a>メソッドを使ってキャメルケースをスネークケースに変換しています。)</p>
<p>ところで、自動生成に失敗するようなことがあれば、元に戻す処理を学ぶ良い機会になります。以下の<a class="hyperref" href="#aside-undoing_things"><span class="ref">コラム3.1</span></a>で元に戻す方法を紹介しています。</p>
<div class="aside" id="aside-undoing_things" data-tralics-id="uid233" data-number="3.1">
<div class="heading">
<span class="number">コラム3.1</span> 

<span class="description">元に戻す方法</span>
</div>
<p>どれほど十分に気を付けていたとしても、Railsアプリケーションの開発中に何か失敗してしまうことはありえます。ありがたいことに、Railsにはそのような失敗をカバーする機能がいくつもあります。</p>
<p>一般的なシナリオの1つは、生成したコードを元に戻したい場合です。たとえば、コントローラを生成した後で、もっといいコントローラ名を思い付き、生成したコードを削除したくなった場合などです。<a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>のように、Railsはコントローラ以外にも関連ファイルを大量に生成するので、生成されたコントローラファイルを削除するだけでは元に戻りません。自動生成されたコードを完全に元に戻すには、新規作成されたファイルを削除するほかに、既存のファイルに挿入されたコードも削除する必要があります (実際、<a class="hyperref" href="toy_app?version=4.2#sec-demo_users_resource"><span class="ref">2.2</span></a>や<a class="hyperref" href="toy_app?version=4.2#sec-microposts_resource"><span class="ref">2.3</span></a>でも説明したように、<span class="tt">rails generate</span>を実行するとルーティングの<span class="tt">routes.rb</span>ファイルも自動的に変更されるので、これも元に戻さなくてはなりません)。このようなときは、「generate」という言葉に因んで、<span class="tt">rails destroy</span>というコマンドを実行することで元に戻すことができます。たとえば次の2つのコマンドは、自動生成と、それに対応する取り消し処理の例です。</p>
<pre class="verbatim">  $ rails generate controller StaticPages home help
  $ rails destroy  controller StaticPages home help</pre>
<p>なお<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>でも、以下のように<em>モデル</em>を自動生成する方法を紹介します。</p>
<pre class="verbatim">  $ rails generate model User name:string email:string</pre>
<p class="noindent">モデルの自動生成についても、同様の方法で元に戻すことができます。</p>
<pre class="verbatim">  $ rails destroy model User</pre>
<p class="noindent">(上のコマンドからわかるように、モデル名以外の引数は不要です。その理由については<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>で説明します)。</p>
<p>また、<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>でも簡単に紹介しましたが、<em>マイグレーション</em>の変更を元に戻す方法も用意されています。詳細は<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>で説明します。簡単に言うと、まず以下のコマンドでデータベースのマイグレーションを変更できます。</p>
<pre class="verbatim">  $ bundle exec rake db:migrate</pre>
<p class="noindent">以下のコマンドで1つ前の状態に戻すこともできます。</p>
<pre class="verbatim">  $ bundle exec rake db:rollback</pre>
<p class="noindent">最初の状態に戻したい場合は、以下のコマンドを使います。</p>
<pre class="verbatim">  $ bundle exec rake db:migrate VERSION=0</pre>
<p class="noindent">既にお気付きの方もいると思いますが、マイグレーションは逐次的に実行され、それぞれのマイグレーションに対してバージョン番号が付与されます。したがって、上記の<span class="tt">0</span>を別の数字に置き換えることによって、指定したバージョンの状態に戻すことができます。</p>
<p>開発中に<a href="http://en.wikipedia.org/wiki/Military_slang#SNAFU" target="_blank">袋小路</a>に迷い込んでしまった場合でも、これらの機能を使えば元の状態を復元できます。</p>

</div>
<p><a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>のようにStaticPagesコントローラを生成すると、(<code>config/routes.rb</code>)ファイルが自動的に更新されます (<a class="hyperref" href="beginning?version=4.2#sec-hello_world"><span class="ref">1.3.4</span></a>のときと同様です)。このルーティングファイルはルーターの実装を受け持ち (<a class="hyperref" href="toy_app?version=4.2#fig-mvc_detailed">図<span class="ref">2.11</span></a>)、URLとWebページの対応関係を定義します。このルーティングファイルはRailsの<code>config</code>ディレクトリの下に置かれます。このディレクトリには、Railsの設定ファイルがまとめて置かれます (<a class="hyperref" href="#fig-config_directory_rails">図<span class="ref">3.1</span></a>)。</p>
<div class="center figure" id="fig-config_directory_rails" data-tralics-id="uid234" data-number="3.1">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/config_directory_3rd_edition.png" alt="images/figures/config_directory_3rd_edition"></div>
<div class="caption">
<span class="header">図3.1</span> <span class="description">サンプルアプリケーションの<code>config</code>ディレクトリの内容
</span>
</div>
</div>
<p>先ほど<a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>のように<code>home</code>アクションと<code>help</code>アクションを生成したので、routesファイルにはそれぞれのアクションで使用されるルールが定義されています (<a class="hyperref" href="#code-pages_routes">リスト<span class="ref">3.5</span></a>)。</p>
<div class="codelisting" id="code-pages_routes" data-tralics-id="uid235" data-number="3.5">
<div class="heading">
<span class="number">リスト3.5:</span> 

<span class="description">StaticPagesコントローラ内の<code>home</code>アクションと<code>help</code>アクションで使用するルーティング<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
<span class="hll">  <span class="n">get</span> <span class="s1">'static_pages/home'</span>
</span><span class="hll">  <span class="n">get</span> <span class="s1">'static_pages/help'</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで以下のルールに注目してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">'static_pages/home'</span>
</pre></div></div>
<p class="noindent">このルールは、/static_pages/homeというURLに対するリクエストを、StaticPagesコントローラの<code>home</code>アクションと結びつけています。具体的には、<code>get</code>と書くことで、<span class="tt">GET</span>リクエストに対して該当するアクションを結びつけています。なお、ここでいう GETリクエストとは、<em>HTTP (HyperText Transfer Protocol)</em> (<a class="hyperref" href="#aside-get_etc"><span class="ref">コラム3.2</span></a>) が対応しているメソッドの1つです。今回の場合は、StaticPagesコントローラ内に<code>home</code>アクションを追加したので、/static_pages/homeにアクセスすることでページを取得 (GET) できるようになりました。結果を確認するには、<a class="hyperref" href="beginning?version=4.2#sec-rails_server"><span class="ref">1.3.2</span></a>に従って以下のようにRailsのdevelopmentサーバーを起動します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server -b <span class="nv">$IP</span> -p <span class="nv">$PORT</span>    <span class="c"># ローカルサーバーの場合は`rails server`だけを実行する</span>
</pre></div></div>
<p class="noindent"><a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a>にアクセスして結果を表示します (<a class="hyperref" href="#fig-raw_home_view">図<span class="ref">3.2</span></a>)。</p>
<div class="center figure" id="fig-raw_home_view" data-tralics-id="uid236" data-number="3.2">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/raw_home_view_3rd_edition.png" alt="images/figures/raw_home_view_3rd_edition"></div>
<div class="caption">
<span class="header">図3.2</span> <span class="description"><a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a>にアクセスした結果
</span>
</div>
</div>
<div class="aside" id="aside-get_etc" data-tralics-id="uid237" data-number="3.2">
<div class="heading">
<span class="number">コラム3.2</span> 

<span class="description"><span class="tt">GET</span>やその他のHTTPメソッドについて</span>
</div>
<p><a href="http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol%23.E3.83.A1.E3.82.BD.E3.83.83.E3.83.89#Request_methods" target="_blank">HTTP</a> (HyperText Transfer Protocol) には4つの基本的な操作があり、それぞれ<span class="tt">GET</span>、<span class="tt">POST</span>、<span class="tt">PATCH</span>、<span class="tt">DELETE</span>という4つの動詞に対応づけられています。<em>クライアント</em> (通常、FirefoxやSafariなどのWebブラウザ) と<em>サーバー</em> (ApacheやNginxなどのWebサーバー) は、上で述べた4つの基本操作を互いに認識できるようになっています(ローカル環境でRailsアプリケーションを開発しているときは、クライアントとサーバーが同じコンピュータ上で動いていますが、一般的には、それぞれ別のコンピュータで動作しているという点を理解しておいてください)。Railsを含む多くのWebフレームワークは、HTTPの各操作を発展させた<em>REST アーキテクチャ</em>の影響を受けています。<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>でも簡単に触れましたが、<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>では、より深い内容について学びます。</p>
<p><span class="tt">GET</span> は、最も頻繁に使用されるHTTP操作で、主にWeb上のデータを<em>読み取る</em>際に使われます。「ページを取得する」という意味のとおり、ブラウザは<a href="http://www.google.com/" target="_blank">google.com</a>や<a href="http://www.wikipedia.org/" target="_blank">wikipedia.org</a>などのWebサイトを開くたびに<span class="tt">GET</span>リクエストをサイトに送信します。Railsアプリケーションでは、<span class="tt">POST</span>リクエストは何かを<em>作成する</em>ときによく使われます (なお本来のHTTPでは、<span class="tt">POST</span>を更新に使ってもよいとしています)。たとえば、ユーザー登録フォームで新しいユーザーを作成するときは、<span class="tt">POST</span>リクエストを送信します。他にも、<span class="tt">PATCH</span>と <span class="tt">DELETE</span>という2つの操作があり、それぞれサーバー上の何かを<em>更新</em>したり<em>削除</em>したりするときに使われます。これら2つの操作は、<span class="tt">GET</span>や<span class="tt">POST</span>ほどは使用されていません。これは、ブラウザがPATCHとDELETEをネイティブでは送信しないからです。しかし、Ruby on Railsなどの多くのWebフレームワークは、ブラウザがこれらの操作のリクエストを<em>送信しているかのように見せかける</em>技術 (偽装) を駆使して、PATCHとDELETEという操作を実現しています。結果として、Railsはこの4つのHTTPリクエスト (<span class="tt">GET</span>・<span class="tt">POST</span>・<span class="tt">PATCH</span>・<span class="tt">DELETE</span>) を全てサポートできるようになりました。</p>

</div>
<p>このページがどのようにして表示されるのかを理解するために、まずはテキストエディタでStaticPagesコントローラを開いてみましょう。<a class="hyperref" href="#code-static_pages_controller">リスト<span class="ref">3.6</span></a>のような内容になっているはずです。ここで、<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>のUsersコントローラやMicropostsコントローラとは異なり、StaticPagesコントローラは一般的なRESTアクションに対応していないことに注意してください。これは、静的なページの集合に対しては、適切なアクションと言えます。言い換えると、RESTアーキテクチャは、あらゆる問題に対して最適な解決方法であるとは限らないということです。</p>
<div class="codelisting" id="code-static_pages_controller" data-tralics-id="uid238" data-number="3.6">
<div class="heading">
<span class="number">リスト3.6:</span> 

<span class="description"><a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>で生成されるStaticPagesコントローラ<span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-static_pages_controller"><span class="ref">リスト 3.6</span></a>の<code>class</code>というキーワードから、<code>static_pages_controller.rb</code>は<code>StaticPagesController</code>という<em>クラス</em>を定義していることがわかります。クラスは、<em>関数</em> (<em>メソッド</em>とも呼ばれます) をまとめるときに便利な手法です。今回の例では、<code>def</code>というキーワードを使って、<code>home</code>アクションや<code>help</code>アクションを定義しています。<a class="hyperref" href="toy_app?version=4.2#sec-inheritance_hierarchies"><span class="ref">2.3.4</span></a>で説明したように、山括弧<code>&lt;</code>は、<code>StaticPagesController</code>が<code>ApplicationController</code>というRailsのクラスを<em>継承</em>していることを示しています。この後も説明しますが、今回作成したページには、Rails特有の機能が多数使用されています (具体的なクラスや継承については、<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-ruby_classes"><span class="ref">4.4</span></a>で詳しく説明します)。</p>
<p>今回のStaticPagesコントローラにあるメソッドは、以下のようにどちらも最初は空になっています。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">help</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">純粋なRuby言語であれば、これらのメソッドは何も実行しません。しかし、Railsでは動作が異なります。<code>StaticPagesController</code>はRuby のクラスですが、<code>ApplicationController</code>クラスを継承しているため、StaticPagesControllerのメソッドは (たとえ何も書かれていなくても) Rails特有の振る舞いをします。具体的には、/static_pages/homeというURLにアクセスすると、RailsはStaticPagesコントローラを参照し、<code>home</code>アクションに記述されているコードを実行します。その後、そのアクションに対応する<em>ビュー</em> (<a class="hyperref" href="beginning?version=4.2#sec-mvc"><span class="ref">1.3.3</span></a>で説明したMVCのVに相当) を出力します。今回の場合、<code>home</code>アクションが空になっているので、/static_pages/homeにアクセスしても、単に対応するビューが出力されるだけです。では、ビューはどのように出力されるのでしょうか。また、どのビューが表示されるのでしょうか。</p>
<p><a class="hyperref" href="#code-generating_pages"><span class="ref">リスト3.4</span></a>をもう一度注意深く読んでみると、アクションとビューの関係性について理解できるでしょう。<code>home</code>アクションは、<code>home.html.erb</code>というビューに対応しています。<code>.erb</code>の詳細については<a class="hyperref" href="#sec-slightly_dynamic_pages"><span class="ref">3.4</span></a>で説明しますが、ファイル名に<code>.html</code>が含まれていることからわかるように、基本的にはHTMLと同じような構造になっています (<a class="hyperref" href="#code-raw_home_view"><span class="ref">リスト3.7</span></a>)。</p>
<div class="codelisting" id="code-raw_home_view" data-tralics-id="uid239" data-number="3.7">
<div class="heading">
<span class="number">リスト3.7:</span> 

<span class="description">Homeページ用に生成されたビュー<span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#home<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/home.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p><code>help</code>アクションに対応するビューも、上のコードと似ています (<a class="hyperref" href="#code-raw_help_view"><span class="ref">リスト3.8</span></a>)。</p>
<div class="codelisting" id="code-raw_help_view" data-tralics-id="uid240" data-number="3.8">
<div class="heading">
<span class="number">リスト3.8:</span> 

<span class="description">Helpページ用に生成されたビュー<span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/help.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p class="noindent">どちらのビューも単なるプレースホルダになっています。トップレベルの見出しが<code>h1</code>タグの中にあり、関連するファイルへの絶対パスが<code>p</code>タグの中に書かれています。</p>
</div>
<div id="sec-custom_static_pages" class="subsection" data-tralics-id="uid241" data-number="3.2.2">
<h3><a href="#sec-custom_static_pages" class="heading hyperref"><span class="number">3.2.2 </span>静的なページの調整</a></h3>
<p><a class="hyperref" href="#sec-slightly_dynamic_pages"><span class="ref">3.4</span></a>からは (ほんの少しだけ) 動的なコンテンツを追加しますが、<a class="hyperref" href="#code-raw_home_view">リスト<span class="ref">3.7</span></a>や<a class="hyperref" href="#code-raw_help_view">リスト<span class="ref">3.8</span></a>で見たように、重要なのは「Railsのビューの中には静的なHTMLがある」という点です。</p>
<div class="codelisting" id="code-custom_home_page" data-tralics-id="uid242" data-number="3.9">
<div class="heading">
<span class="number">リスト3.9:</span> 

<span class="description">HomeページのHTMLを修正する<span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-custom_help_page" data-tralics-id="uid243" data-number="3.10">
<div class="heading">
<span class="number">リスト3.10:</span> 

<span class="description">HelpページのHTMLを修正する<span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp/help"</span><span class="nt">&gt;</span>Rails Tutorial help section<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/em&gt;</span>
  book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-custom_home_page">リスト<span class="ref">3.9</span></a>と<a class="hyperref" href="#code-custom_help_page">リスト<span class="ref">3.10</span></a>の結果をそれぞれ<a class="hyperref" href="#fig-custom_home_page">図<span class="ref">3.3</span></a>と<a class="hyperref" href="#fig-custom_help_page">図<span class="ref">3.4</span></a>に示します。</p>
<div class="center figure" id="fig-custom_home_page" data-tralics-id="uid244" data-number="3.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/custom_home_page.png" alt="images/figures/custom_home_page"></div>
<div class="caption">
<span class="header">図3.3</span> <span class="description">修正されたHomeページ
</span>
</div>
</div>
<div class="center figure" id="fig-custom_help_page" data-tralics-id="uid245" data-number="3.4">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/custom_help_page_3rd_edition.png" alt="images/figures/custom_help_page_3rd_edition"></div>
<div class="caption">
<span class="header">図3.4</span> <span class="description">修正されたHelpページ
</span>
</div>
</div>
</div>
</div><div id="sec-getting_started_with_testing" class="section" data-tralics-id="cid18" data-number="3.3">
<h2><a href="#sec-getting_started_with_testing" class="heading hyperref"><span class="number">3.3 </span>テストから始める</a></h2>
<p><a class="hyperref" href="#sec-custom_static_pages"><span class="ref">3.2.2</span></a>でサンプルアプリのHomeページとHelpページを作成して中身も書き加えたので、今度はAboutページを同様に追加します。何らかの変更を行う際には、常に「<em>自動化テスト</em>」を作成して、機能が正しく実装されたことを確認する習慣をぜひ身に付けましょう。アプリケーションを開発しながら<em>テストスイート</em>をみっちり作成しておけば、いざというときのセーフティネットにもなり、それ自体がアプリケーションのソースコードの「実行可能なドキュメント」にもなります。テストを作成するということは、その分コードを余分に書くことになりますが、正しく行えば、むしろテストがないときよりも確実に開発速度が<em>アップ</em>します。テストが揃っていれば、バグを追うために余分な時間を使わずに済むためです。そんなふうにうまくいくとは信じられない人もいるかもしれませんが、一度でもテスト作成が上達すれば間違いなくこのとおりになります。だからこそ、テスト作成の習慣をできるだけ早いうちに身につけることが重要なのです。</p>
<p>テストが重要であるという点ではRails開発者の意見はほぼ一致していますが、細かい点では異論が生じているのも確かです。特に、テスト駆動開発 (TDD)<sup class="footnote" id="cha-3_footnote-ref-6"><a href="#cha-3_footnote-6">6</a></sup> (テストの手法のひとつ: 最初に「正しいコードがないと失敗するテスト」を書き、次に本編のコードを書いてそのテストがパスするようにする) の是非については、当分議論が終わりそうにありません。筆者も悩んだ末、<em>Ruby on Railsチュートリアル</em>ではこの点について「とにかく〜すべし」的な原理主義を避けることにしました。テストに関しては、原則として手軽かつ直感的なアプローチを採用し、必要に応じてTDDに切り替えるようにしています (<a class="hyperref" href="#aside-when_to_test">コラム<span class="ref">3.3</span></a>)。</p>
<div class="aside" id="aside-when_to_test" data-tralics-id="uid247" data-number="3.3">
<div class="heading">
<span class="number">コラム 3.3</span> 

<span class="description">結局テストはいつ行えばよいのか</span>
</div>
<p>それではいつ、どんなふうにテストを行えばよいのでしょうか。この点を理解するために、テストを行う<em>目的</em>をもう一度確認してみましょう。著者は、テストには以下の3つのメリットがあると考えます。</p>
<ol>
<li>テストが揃っていれば、機能停止に陥るような<em>回帰バグ</em> (regression: 以前のバグが再発したり機能追加/変更の副作用が生じたりすること、先祖返りとも言う) を防止できる。
</li>
<li>テストが揃っていれば、コードを安全に<em>リファクタリング</em> (機能を変更せずにコードを改善すること) できる。
</li>
<li>テストコードは、アプリケーションコードから見れば<em>クライアント</em>として動作するので、アプリケーションの設計やシステムの他の部分とのインターフェイスを決めるときにも役に立つ。
</li>
</ol>
<p>上の3つのメリットは、テストを先に書かなくても<em>得ることができます</em>が、それでもテスト駆動開発 (TDD) という手法をいつでも使えるようにしておけば、間違いなく多くの場面で役に立ちます。テストの手法やタイミングは、ある意味テストをどのぐらいすらすら書けるかで決まると言ってよいでしょう。たいていの開発者は、テストを書くのに慣れてくるとテストを先に書くようになります。その他にも、アプリケーションのコードと比べてテストがどのぐらい書きにくいか、必要な機能をどのぐらい正確に把握しているか、その機能が将来廃止される可能性がどのぐらいあるかによっても異なってくるでしょう。</p>
<p>こういうときのために、「テスト駆動」にするか「一括テスト」にするかを決める目安となるガイドラインがあると便利です。著者の経験を元に、以下のようにまとめてみました。</p>
<ul>
<li>アプリケーションのコードよりも明らかにテストコードの方が短くシンプルになる (=簡単に書ける) のであれば、テストを先に書けるようになることを目指す。
</li>
<li>期待している動作がまだ固まりきっていないのであれば、先にアプリケーションのコードを書き上げ、続いて期待する動作をテストコードで記述することを目指す。
</li>
<li>セキュリティが最重要課題であれば、セキュリティモデルでエラーが発生した場合のテストを最初に書くべき。
</li>
<li>バグを見つけたら、そのバグを再現するテストを真っ先に書き、回帰バグを防ぐ体制を整えてからアプリケーションのコードの修正に取りかかる。
</li>
<li>将来変更の可能性が少しでもあるコード (HTML構造の細部など) があれば必ずテストを書く。
</li>
<li>リファクタリングの前には必ずテストを書き、エラーを起こしそうなコードや、特に止まってしまいそうなコードを集中的にテストする。
</li>
</ul>
<p>上のガイドラインに従う場合、現実には最初にコントローラやモデルのテストを書き、続いて統合テスト (モデル/ビュー/コントローラにまたがる機能テスト) を書く、ということになります。また、不安定な要素が特に見当たらないアプリケーションや、(主にビューが) 頻繁に改定される可能性の高いアプリケーションのコードを書くときには、思い切ってテストを省略してしまうこともないわけではありません。</p>

</div>
<p>本書における主要なテストは、<em>コントローラテスト</em> (この節より)、<em>モデルテスト</em> (<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users">第<span class="ref">6</span>章</a>より)、<em>統合テスト</em> (<a class="hyperref" href="sign_up?version=4.2#cha-sign_up">第<span class="ref">7</span>章</a>より) の3つです。統合テストでは、ユーザーがWebブラウザでアプリケーションとやりとりする操作をシミュレートできるので特に強力です。統合テストは最終的にテスティングにおける最も主要な武器となりますが、まずは取っ付きやすいコントローラテストから始めることにしましょう。</p>
<div id="sec-our_first_test" class="subsection" data-tralics-id="uid257" data-number="3.3.1">
<h3><a href="#sec-our_first_test" class="heading hyperref"><span class="number">3.3.1</span> 最初のテスト</a></h3>
<p>それではサンプルアプリケーションのAboutページの作成に取りかかります。やってみるとわかりますが、このページでは大したことは行わないので、このテストは驚くほど短く単純です。早速<a class="hyperref" href="#aside-when_to_test">コラム<span class="ref">3.3</span></a>のガイドラインに沿って、テストを先に書くことにしましょう。続いてそのテストを実行して「失敗」することを確認し、実際のアプリケーションコードを書きます。</p>
<p>初めて書くテストがいきなり「テスト先行」というのは、Ruby on Railsの知識がある程度以上必要なため、少々敷居が高い面もあります。今の段階でテストを書かせようとすると、尻込みしてしまう人もいるかもしれません。しかしご心配なく。面倒な部分は既にRailsが全部面倒を見てくれています。<code>rails generate controller</code> (<a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>) を実行した時点でテストファイルがちゃんと作成されているので、それを利用しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls <span class="nb">test</span>/controllers/
<span class="go">static_pages_controller_test.rb</span>
</pre></div></div>
<p class="noindent">生成されたテストを見てみましょう (<a class="hyperref" href="#code-default_controller_test">リスト<span class="ref">3.11</span></a>)。</p>
<div class="codelisting" id="code-default_controller_test" data-tralics-id="uid258" data-number="3.11">
<div class="heading">
<span class="number">リスト3.11:</span> 

<span class="description">StaticPagesコントローラのデフォルトのテスト <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/static_pages_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">StaticPagesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:home</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get help"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:help</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">現時点では、上の<a class="hyperref" href="#code-default_controller_test">リスト<span class="ref">3.11</span></a>の文法をいきなり理解する必要はありません。今は「このファイルにはテストが2つ書かれている」ことを認識していただければ十分です。その2つのテストは、<a class="hyperref" href="#code-generating_pages">リスト<span class="ref">3.4</span></a>で生成したコントローラの2つのアクションであるHomeとHelpに対応して生成されたものです。それぞれのテストでは、アクションをgetして正常に動作することを確認します。この確認は「<em>アサーション</em>」(assertion: 主張、断言) と呼ばれる手法で行います。<code>get</code>は、HomeページやHelpページがいわゆる「<span class="tt">GET</span>リクエストを受け付ける」普通のWebページであるということを示します (<a class="hyperref" href="#aside-get_etc">コラム<span class="ref">3.2</span></a>)。その次の「response<code>:success</code>」は、実際にはHTTP の<a href="http://ja.wikipedia.org/wiki/HTTP%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89" target="_blank">ステータスコード</a> (ここでは<a href="http://ja.wikipedia.org/wiki/HTTP%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89#2xx_Success" target="_blank">200 OK</a>) を表します。つまり、以下のようなテストは</p>
<div class="code"><div class="highlight"><pre><span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
  <span class="n">get</span> <span class="ss">:home</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">言葉で表すと「Homeページのテスト。<span class="tt">GET</span>リクエストを<code>home</code>アクションに対して発行 (=送信) せよ。そうすれば、リクエストに対するレスポンスは[成功]になるはず。」となります。</p>
<p>テスティングサイクルの最初の一回しに取りかかる前に、まずは現在のテストスイートをそのまま実行して、問題なくパスすることを確認しておきます。テストの実行には、以下のように<code>rake</code>ユーティリティを使用します (<a class="hyperref" href="toy_app?version=4.2#aside-rake">コラム<span class="ref">2.1</span></a>)<sup class="footnote" id="cha-3_footnote-ref-7"><a href="#cha-3_footnote-7">7</a></sup>。</p>
<div class="codelisting" id="uid260" data-tralics-id="uid260" data-number="3.12">
<div class="heading">
<span class="number">リスト 3.12:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
2 tests, 2 assertions, 0 failures, 0 errors, 0 skips
</pre></div></div>
</div>
<p class="noindent">テストスイートは期待どおりパス GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span> します (パスしたときにも色を表示できるようにするには、<a class="hyperref" href="#sec-minitest_reporters"><span class="ref">3.7.1</span></a>のminitestレポーターをオプションで追加する必要があります)。ところで、テストの実行にはある程度時間がかかります。これには2つの要因が絡んでいます: (1) <em>Spring server</em>を起動してRails環境を事前読み込みするのに時間がかかる。ただしこれは最初の1回だけです。(2) Rubyそのものの起動に時間がかかる (2番目の要因については、<a class="hyperref" href="#sec-guard"><span class="ref">3.7.3</span></a>で紹介するGuardを導入することで改善できます)。</p>
</div>
<div id="sec-red" class="subsection" data-tralics-id="uid261" data-number="3.3.2">
<h3><a href="#sec-red" class="heading hyperref"><span class="number">3.3.2 </span>Red</a></h3>
<p><a class="hyperref" href="#aside-when_to_test">コラム<span class="ref">3.3</span></a>で解説したように、テスト駆動開発のサイクルは「失敗するテストを最初に書く」「次にアプリケーションのコードを書いてパスさせる」「必要ならリファクタリングする」のように進みます。多くのテストツールでは、テストの失敗を「レッド」、成功したときを「グリーン」で表します。ここから、このサイクルを「レッド・グリーン・リファクタリング」と呼ぶこともあります。これに従って最初のサイクルを完了させましょう。まず失敗するテストを書いて<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になるようにします。テストを<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>にするのは<a class="hyperref" href="#sec-green"><span class="ref">3.3.3</span></a>、リファクタリングは<a class="hyperref" href="#sec-layouts_and_embedded_ruby"><span class="ref">3.4.3</span></a>で行います<sup class="footnote" id="cha-3_footnote-ref-8"><a href="#cha-3_footnote-8">8</a></sup>。</p>
<p>サイクルの記念すべき第一歩はAboutページ用の失敗するテストを書くことです。<a class="hyperref" href="#code-default_controller_test">リスト<span class="ref">3.11</span></a>を参考にすれば、正しいテストコードを何となく想像できると思います。正しいテストコードを<a class="hyperref" href="#code-about_test">リスト<span class="ref">3.13</span></a>に示します。</p>
<div class="codelisting" id="code-about_test" data-tralics-id="uid263" data-number="3.13">
<div class="heading">
<span class="number">リスト3.13:</span> 

<span class="description">Aboutページのテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/static_pages_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">StaticPagesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:home</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get help"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:help</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should get about"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="ss">:about</span>
</span><span class="hll">    <span class="n">assert_response</span> <span class="ss">:success</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-about_test">リスト<span class="ref">3.13</span></a>のハイライト行を見ると、他のHomeページ用テストやHelpページ用テストとほとんど同じであることがわかります。違いは「home」や「help」の部分が「about」に変わっている点だけです。</p>
<p>テストを実行すると、期待どおり失敗します。</p>
<div class="codelisting" id="uid264" data-tralics-id="uid264" data-number="3.14">
<div class="heading">
<span class="number">リスト3.14:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 2 assertions, 0 failures, 1 errors, 0 skips
</pre></div></div>
</div>
</div>
<div id="sec-green" class="subsection" data-tralics-id="uid265" data-number="3.3.3">
<h3><a href="#sec-green" class="heading hyperref"><span class="number">3.3.3 </span>Green</a></h3>
<p>テストがめでたく失敗した (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>) ので、今度はこのテストのエラーメッセージを頼りにテストがパスする (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>) ようにコードを書くことで、Aboutページを実装します。 </p>
<p>失敗したテストのエラーメッセージをもっと詳しく見ていきましょう<sup class="footnote" id="cha-3_footnote-ref-9"><a href="#cha-3_footnote-9">9</a></sup>。</p>
<div class="codelisting" id="uid267" data-tralics-id="uid267" data-number="3.15">
<div class="heading">
<span class="number">リスト3.15:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
ActionController::UrlGenerationError:
No route matches {:action=&gt;"about", :controller=&gt;"static_pages"}
</pre></div></div>
</div>
<p class="noindent">このエラーメッセージによれば、「指定されたアクション/コントローラの組み合わせに一致するルーティングが見当たらない」とあります。つまりルーティングファイルを修正する必要があるということです。<a class="hyperref" href="#code-pages_routes">リスト<span class="ref">3.5</span></a>のときと同じ要領で変更を行った結果を<a class="hyperref" href="#code-about_route">リスト<span class="ref">3.16</span></a>に示します。</p>
<div class="codelisting" id="code-about_route" data-tralics-id="uid268" data-number="3.16">
<div class="heading">
<span class="number">リスト3.16:</span> 

<span class="description"><code>about</code>用のルートを追加する RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s1">'static_pages/home'</span>
  <span class="n">get</span> <span class="s1">'static_pages/help'</span>
<span class="hll">  <span class="n">get</span> <span class="s1">'static_pages/about'</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-about_route">リスト<span class="ref">3.16</span></a>のハイライト行では、/static_pages/aboutというURLへの<span class="tt">GET</span>リクエストが来たら、StaticPagesコントローラの<code>about</code>アクションに渡すようRailsに指示しています。</p>
<p>修正が終わったらテストスイートを再度実行します。まだ<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>のままです。しかし今度はメッセージが少し変わりました。</p>
<div class="codelisting" id="uid269" data-tralics-id="uid269" data-number="3.17">
<div class="heading">
<span class="number">リスト3.17:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
AbstractController::ActionNotFound:
The action 'about' could not be found for StaticPagesController
</pre></div></div>
</div>
<p class="noindent">このエラーメッセージから、「StaticPagesコントローラに<code>about</code>アクションがない」ということがわかります。<a class="hyperref" href="#code-static_pages_controller">リスト<span class="ref">3.6</span></a>の<code>home</code>や<code>help</code>と同じようにaboutアクションを追加します (<a class="hyperref" href="#code-adding_the_about_page">リスト<span class="ref">3.18</span></a>)。</p>
<div class="codelisting" id="code-adding_the_about_page" data-tralics-id="uid270" data-number="3.18">
<div class="heading">
<span class="number">リスト3.18:</span> 

<span class="description"><code>about</code>アクションが追加されたStaticPagesコントローラ RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

<span class="hll">  <span class="k">def</span> <span class="nf">about</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>今度はどうでしょう。まだ<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>ですが、エラーメッセージがまた少し変わりました。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
ActionView::MissingTemplate: Missing template static_pages/about
</pre></div></div>
<p class="noindent">今度はテンプレートがないようです。Railsではテンプレートといえばすなわち「ビュー」のことです。<a class="hyperref" href="#sec-generated_static_pages"><span class="ref">3.2.1</span></a>で説明したように、<code>home</code>というアクションは<code>home.html.erb</code>というビューに関連付けられます。このビューは<code>app/views/static_pages</code>にあるので、ここに<code>about.html.erb</code>というファイルを作ればよさそうです。</p>
<p>ファイルの作成方法はシステムの設定によってさまざまですが、たいていのテキストエディタでは、ディレクトリをCtrl+クリックすればコンテキストメニューに「New File」のようなメニューが表示されます。あるいはエディタの[File]メニューでファイルを作成して、このディレクトリに保存しても構いません。個人的には<a href="http://ja.wikipedia.org/wiki/Touch_(Unix)" target="_blank">Unixのtouchコマンド</a>でファイルを作成するのがかっこいいと思います。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch app/views/static_pages/about.html.erb
</pre></div></div>
<p class="noindent"><code>touch</code>コマンドは本来ファイルやディレクトリのタイムスタンプだけを更新するためのコマンドなのですが、ファイルが存在しない場合には空ファイルを作成するという一種の副作用があります (クラウドIDEをご利用の場合は、touchでファイル作成後に<a class="hyperref" href="beginning?version=4.2#sec-bundler"><span class="ref">1.3.1</span></a>のようにファイルツリーの更新が必要な場合があります)。</p>
<p>とにかく<code>about.html.erb</code>を正しいディレクトリに作成できたので、<a class="hyperref" href="#code-custom_about_page">リスト<span class="ref">3.19</span></a>のとおりにコードを入力します。</p>
<div class="codelisting" id="code-custom_about_page" data-tralics-id="uid271" data-number="3.19">
<div class="heading">
<span class="number">リスト3.19:</span> 

<span class="description">Aboutページのコード GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>About<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
  Tutorial<span class="nt">&lt;/em&gt;&lt;/a&gt;</span> is a
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;</span>book<span class="nt">&lt;/a&gt;</span> and
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://screencasts.railstutorial.org/"</span><span class="nt">&gt;</span>screencast series<span class="nt">&lt;/a&gt;</span>
  to teach web development with
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>.
  This is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p>今度は<code>rake test</code>の結果は<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid272" data-tralics-id="uid272" data-number="3.20">
<div class="heading">
<span class="number">リスト3.20:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 3 assertions, 0 failures, 0 errors, 0 skips
</pre></div></div>
</div>
<p class="noindent">もちろん、実際にブラウザを起動して、テストが正しく動いているかどうかを確かめることもできます (<a class="hyperref" href="#fig-about_us"><span class="ref">図3.5</span></a>)。</p>
<div class="center figure" id="fig-about_us" data-tralics-id="uid273" data-number="3.5">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/about_us_3rd_edition.png" alt="images/figures/about_us_3rd_edition"></div>
<div class="caption">
<span class="header">図3.5</span> <span class="description">作成したAboutページ (<a href="http://localhost:3000/static_pages/about" target="_blank">/static_pages/about</a>)
</span>
</div>
</div>
</div>
<div id="sec-refactor" class="subsection" data-tralics-id="uid274" data-number="3.3.4">
<h3><a href="#sec-refactor" class="heading hyperref"><span class="number">3.3.4 </span>リファクタリング</a></h3>
<p>テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になったので、安心してコードをリファクタリングできるようになりました。アプリケーションの開発が進むと、コードのどこからともなく「腐敗臭」が漂い始めます。コードや記法の統一が崩れて読みづらくなる、クラスやメソッドが何百行にも膨れ上がって読む気を削がれる、なぜこのコードがここにあるのか最早誰もその理由を思い出せなくなる、同じコードがあちこちにコピペされて少しずつ書き換えられ手に負えなくなる、などです。コンピュータにしてみればどんなに汚らしいコードであろうと、そこにあるがままに実行するだけですが、人間はそういうわけにはいきません。こまめにリファクタリングを繰り返してコードを常にすみずみまで美しくコンパクトに保ち、他の開発者や未来の自分の開発意欲を阻喪することのないようにしなければなりません。このサンプルアプリは生まれたてなので、今のところリファクタリングの必要な箇所はほぼどこにも見当たりません。しかし「一匹いれば30匹いると思え」、<a href="https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E8%87%AD%E3%81%84" target="_blank">コードの腐敗臭</a>はどんな小さな隙間からも忍び寄ってきます。こまめなリファクタリングの習慣をできるだけ早いうちに身につけるためにも、少々無理やりに<a class="hyperref" href="#sec-layouts_and_embedded_ruby"><span class="ref">3.4.3</span></a>から始めることにします。</p>
</div>
</div><div id="sec-slightly_dynamic_pages" class="section" data-tralics-id="cid19" data-number="3.4">
<h2><a href="#sec-slightly_dynamic_pages" class="heading hyperref"><span class="number">3.4</span> 少しだけ動的なページ</a></h2>
<p>静的なページのアクションやビューをいくつか作成できたので、今度はそれを<em>ほんの少しだけ</em>動的にしてみましょう。ページの内容に応じて、ページのタイトルを自ら書き換えて表示するようにします。タイトルを自動で変えるぐらいのことが<em>真の</em>動的コンテンツと呼べるかどうかは議論の余地があると思いますが、いずれにしろこのページは、<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>で紹介する本格的な動的コンテンツの基礎となります。</p>
<p>ここでの目標は、Homeページ、Helpページ、Aboutページをそれぞれ編集し、最終的にページごとに異なるタイトルを表示することです。ここではビューの<code>&lt;title&gt;</code>タグの内容を変更します。多くのブラウザでは、titleタグの内容をブラウザウィンドウの上部にウィンドウタイトルとして表示します。titleタグは、いわゆるSEO (search engine optimization: 検索エンジン最適化) においても重要な役割を果たします。今度は「レッド・グリーン・リファクタリング」のサイクルをすべて行うことにします。ページタイトルの簡単なテストを書き (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>)、3つのページにタイトルを追加し (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>)、<em>レイアウト</em>ファイルを活用してコードの重複を解決します (リファクタリング)。本節の終わりまでに、3つの静的ページのタイトルを「&lt;ページ名&gt; | Ruby on Rails Tutorial Sample App」という形式に変更します。「&lt;ページ名&gt;」の部分がページに応じて変わります (<a class="hyperref" href="#table-static_pages">表<span class="ref">3.2</span></a>)。</p>
<p>前述の<code>rails new</code>コマンド (<a class="hyperref" href="#code-rails_new_sample_app">リスト<span class="ref">3.1</span></a>) を実行すると、レイアウトもデフォルトで作成されます。ここでは学習のため、一時的に以下のようにファイル名を変更します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv app/views/layouts/application.html.erb layout_file   <span class="c"># temporary change</span>
</pre></div></div>
<p class="noindent">普通は、実際のアプリケーション開発時に上のような操作を行うことはありません。ここでは、レイアウトファイルの役割をよりわかりやすく説明するために、最初にレイアウトファイルを無効にしています。</p>
<div class="table" id="table-static_pages" data-tralics-id="uid275" data-number="3.2">
<table class="tabular">
<tr class="bottom_border">
<td class="align_center"><strong>ページ</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>基本タイトル</strong></td>
<td class="align_left"><strong>追加タイトル</strong></td>
</tr>
<tr>
<td class="align_center">Home</td>
<td class="align_left">/static_pages/home</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"Home"</code></td>
</tr>
<tr>
<td class="align_center">Help</td>
<td class="align_left">/static_pages/help</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"Help"</code></td>
</tr>
<tr>
<td class="align_center">About</td>
<td class="align_left">/static_pages/about</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"About"</code></td>
</tr>
</table>
<div class="caption">
<span class="header">表3.2</span> <span class="description">サンプルアプリケーションの (ほぼ) 静的なページ。
</span>
</div>
</div>
<div id="sec-testing_titles" class="subsection" data-tralics-id="uid276" data-number="3.4.1">
<h3><a href="#sec-testing_titles" class="heading hyperref"><span class="number">3.4.1 </span>タイトルをテストする (Red)</a></h3>
<p>ページタイトルを追加するために、典型的なWebページの構造を今一度おさらいしておきましょう (<a class="hyperref" href="#code-html_structure">リスト<span class="ref">3.21</span></a>)。</p>
<div class="codelisting" id="code-html_structure" data-tralics-id="uid277" data-number="3.21">
<div class="heading">
<span class="number">リスト3.21:</span> 

<span class="description">Webページの典型的なHTML構造</span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Greeting<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Hello, world!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-html_structure">リスト<span class="ref">3.21</span></a>の構造には次のものが含まれています。1) <em>document type</em> (doctype) は使用するHTMLのバージョン (ここでは<a href="http://ja.wikipedia.org/wiki/HTML5" target="_blank">HTML5</a><sup class="footnote" id="cha-3_footnote-ref-10"><a href="#cha-3_footnote-10">10</a></sup>) をブラウザに対して宣言します。2) <code>head</code>セクション。ここでは<code>title</code>タグに囲まれた「Greeting」(=あいさつ) という文字があります。3) <code>body</code>セクション。ここには「Hello, world!」という文字列があります。「Hello, world!」は<code>p</code> (paragraph) タグの中にあります (HTMLではスペースやタブは無視されるので、インデントはあってもなくても大丈夫ですが、インデントがある方がHTMLのデータ構造を理解しやすくなります)。</p>
<p><a class="hyperref" href="#table-static_pages">表<span class="ref">3.2</span></a>の各タイトルについて簡単なテストを書きます (<a class="hyperref" href="#code-about_test">リスト<span class="ref">3.13</span></a>)。このテストで使用している<code>assert_select</code>メソッドでは、特定のHTMLタグが存在するかどうかをテストします (この種のアサーションメソッドはその名から「セレクタ」と呼ばれることもあります)<sup class="footnote" id="cha-3_footnote-ref-11"><a href="#cha-3_footnote-11">11</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Home | Ruby on Rails Tutorial Sample App"</span>
</pre></div></div>
<p class="noindent">上のセレクタは、<code>&lt;title&gt;</code>タグ内に「Home | Ruby on Rails Tutorial Sample App」という文字列があるかどうかをチェックします。同じ要領で3つの静的ページを書き換えます (<a class="hyperref" href="#code-title_tests">リスト<span class="ref">3.22</span></a>)。</p>
<div class="codelisting" id="code-title_tests" data-tralics-id="uid280" data-number="3.22">
<div class="heading">
<span class="number">リスト3.22:</span> 

<span class="description">StaticPagesコントローラのタイトルをテストする RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/static_pages_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">StaticPagesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:home</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Home | Ruby on Rails Tutorial Sample App"</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get help"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:help</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Help | Ruby on Rails Tutorial Sample App"</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get about"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:about</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"About | Ruby on Rails Tutorial Sample App"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">(上のテストコードで繰り返し使われている「Ruby on Rails Tutorial Sample App」という文字列を一刻も早くリファクタリングしたくてたまらない方には、<a class="hyperref" href="#sec-static_pages_exercises"><span class="ref">3.6</span></a>の演習をおすすめします。)</p>
<p><a class="hyperref" href="#code-title_tests">リスト<span class="ref">3.22</span></a>どおりにテストを作成すると、テストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になります。</p>
<div class="codelisting" id="uid281" data-tralics-id="uid281" data-number="3.23">
<div class="heading">
<span class="number">リスト3.23:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 6 assertions, 3 failures, 0 errors, 0 skips
</pre></div></div>
</div>
</div>
<div id="sec-adding_page_titles" class="subsection" data-tralics-id="uid282" data-number="3.4.2">
<h3><a href="#sec-adding_page_titles" class="heading hyperref"><span class="number">3.4.2 </span>タイトルを追加する (Green)</a></h3>
<p>今度は各ページにタイトルを追加して、<a class="hyperref" href="#sec-testing_titles"><span class="ref">3.4.1</span></a>のテストがパスするようにしましょう。<a class="hyperref" href="#code-html_structure">リスト<span class="ref">3.21</span></a>の基本HTML構造をカスタムのHomeページ (<a class="hyperref" href="#code-custom_home_page">リスト<span class="ref">3.9</span></a>) に追加すると (<a class="hyperref" href="#code-home_view_full_html">リスト<span class="ref">3.24</span></a>のようになります。</p>
<div class="codelisting" id="code-home_view_full_html" data-tralics-id="uid283" data-number="3.24">
<div class="heading">
<span class="number">リスト3.24:</span> 

<span class="description">完全なHTML構造を備えたHomeページのビュー<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Home | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p class="noindent">このページの表示を<a class="hyperref" href="#fig-home_view_full_html">図<span class="ref">3.6</span></a>に示します<sup class="footnote" id="cha-3_footnote-ref-12"><a href="#cha-3_footnote-12">12</a></sup>。</p>
<div class="center figure" id="fig-home_view_full_html" data-tralics-id="uid285" data-number="3.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_view_full_html.png" alt="images/figures/home_view_full_html"></div>
<div class="caption">
<span class="header">図3.6 </span><span class="description">タイトルが付いたHomeページ
</span>
</div>
</div>
<p>Helpページ (<a class="hyperref" href="#code-custom_help_page">リスト<span class="ref">3.10</span></a>) やAboutページ (<a class="hyperref" href="#code-custom_about_page">リスト<span class="ref">3.19</span></a>) についても、同じ要領で<a class="hyperref" href="#code-help_view_full_html">リスト<span class="ref">3.25</span></a> や <a class="hyperref" href="#code-about_view_full_html">リスト<span class="ref">3.26</span></a>のようなコードに変更します。</p>
<div class="codelisting" id="code-help_view_full_html" data-tralics-id="uid286" data-number="3.25">
<div class="heading">
<span class="number">リスト 3.25:</span> 

<span class="description">完全なHTML構造を備えたHelpページのビュー RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Help | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp/help"</span><span class="nt">&gt;</span>Rails Tutorial help
      section<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
      Tutorial<span class="nt">&lt;/em&gt;</span> book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-about_view_full_html" data-tralics-id="uid287" data-number="3.26">
<div class="heading">
<span class="number">リスト3.26:</span> 

<span class="description">完全なHTML構造を備えたAboutページのビュー GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>About | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
      Tutorial<span class="nt">&lt;/em&gt;&lt;/a&gt;</span> is a
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;</span>book<span class="nt">&lt;/a&gt;</span> and
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://screencasts.railstutorial.org/"</span><span class="nt">&gt;</span>screencast series<span class="nt">&lt;/a&gt;</span>
      to teach web development with
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>.
      This is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p>これでテストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid288" data-tralics-id="uid288" data-number="3.27">
<div class="heading">
<span class="number">リスト3.27:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 6 assertions, 0 failures, 0 errors, 0 skips
</pre></div></div>
</div>
</div>
<div id="sec-layouts_and_embedded_ruby" class="subsection" data-tralics-id="uid289" data-number="3.4.3">
<h3><a href="#sec-layouts_and_embedded_ruby" class="heading hyperref"><span class="number">3.4.3 </span>レイアウトと埋め込みRuby (Refactor)</a></h3>
<p>この節では、Railsのコントローラとアクションを使って3つの有効なページを生成することでさまざまなことを達成しました。しかしそれらは単純な静的ページであり、またRailsの能力を十分に発揮できていません。しかも、コードが甚だしく重複しています。</p>
<ul>
<li>ページのタイトルがどれもほぼ同じ (完全にではないが)。
</li>
<li>「Ruby on Rails Tutorial Sample App」という文字が3つのタイトルで繰り返し使われている。
</li>
<li>HTMLの構造全体が各ページで重複している。
</li>
</ul>
<p class="noindent">同じコードを繰り返すことはRubyの「DRY」(Don't Repeat Yourself: 繰り返すべからず) という原則に反します。この節では、繰り返しを追放してコードをDRY (=よく乾かす) にしましょう。最後に<a class="hyperref" href="#sec-adding_page_titles"><span class="ref">3.4.2</span></a>のテストを実行して、タイトルを壊していないことを確認します。</p>
<p>上の話と一見矛盾するようですが、最初にコードを若干追加して、現在は「ほぼ」同じになっているページのタイトルを「<em>完全に</em>」同じにしておきます。この方が、コードの重複を一括で取り除けるからです。</p>
<p>重複を取り除くテクニックのひとつとして、ビューで「<em>埋め込みRuby</em>」(Embedded Ruby) を使用できます。Home、Help、Aboutページには可変要素があるので、Railsの<code>provide</code>関数を使用してタイトルをページごとに変更します。それでは、<code>home.html.erb</code>ビューのコードを、<a class="hyperref" href="#code-home_view_erb_title"><span class="ref">リスト3.28</span></a>のように、タイトルに含まれる"Home"という文字を置き換え、動作を確認しましょう。</p>
<div class="codelisting" id="code-home_view_erb_title" data-tralics-id="uid293" data-number="3.28">
<div class="heading">
<span class="number">リスト3.28:</span> 

<span class="description">タイトルにERBコードを使用したHomeページのビュー GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Home"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
<span class="hll">    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</span>  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-home_view_erb_title"><span class="ref">リスト3.28</span></a>は、<em>ERB</em>と呼ばれている、Rubyの埋め込みコードの最初の例です (これで、HTMLビューのファイルの拡張子が<code>.html.erb</code>となっている理由をおわかりいただけたと思います)。ERBはWebページに動的な要素を加えるときに使うテンプレートシステムです<sup class="footnote" id="cha-3_footnote-ref-13"><a href="#cha-3_footnote-13">13</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Home"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">上のコードでは<span class="inline_verbatim">&lt;% ... %&gt;</span>という記法が使用されており、その中からRailsの<code>provide</code>関数を呼び出しています。関数の引数では、<code>"Home"</code>という文字列と<code>:title</code>というラベルを関連付けています<sup class="footnote" id="cha-3_footnote-ref-14"><a href="#cha-3_footnote-14">14</a></sup>。そしてタイトルの部分では、上の記法と連携する「<span class="inline_verbatim">&lt;%= ... %&gt;</span>」というよく似た記法を使用し、その中でRubyの<code>yield</code>関数を呼び出しています<sup class="footnote" id="cha-3_footnote-ref-15"><a href="#cha-3_footnote-15">15</a></sup>。この関数によって、テンプレートのその部分に実際のタイトルが挿入されます。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p class="noindent">この2つのERBの違いは次のとおりです。<span class="inline_verbatim">&lt;% ... %&gt;</span>と書くと、中に書かれたコードを<em>単に実行する</em>だけで何も出力しません。<span class="inline_verbatim">&lt;%= ... %&gt;</span>のように等号を追加すると、中のコードの実行結果がテンプレートのその部分に<em>挿入され</em>ます。ERBでビューをこのように書き換えても、ページの表示結果は以前とまったく同じです。タイトルの可変部分がERBによって動的に生成されている点だけが異なります。</p>
<p><a class="hyperref" href="#sec-adding_page_titles"><span class="ref">3.4.2</span></a>のテストを実行してこの改修を確認すれば、今度も<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid297" data-tralics-id="uid297" data-number="3.29">
<div class="heading">
<span class="number">リスト3.29:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 6 assertions, 0 failures, 0 errors, 0 skips
</pre></div></div>
</div>
<p class="noindent">続いて、HelpページとAboutページも同様に変更します (<a class="hyperref" href="#code-help_view_erb_title"><span class="ref">リスト3.30</span></a>、<a class="hyperref" href="#code-about_view_erb_title"><span class="ref">リスト3.31</span></a>)。</p>
<div class="codelisting" id="code-help_view_erb_title" data-tralics-id="uid298" data-number="3.30">
<div class="heading">
<span class="number">リスト3.30:</span> 

<span class="description">タイトルにERBコードを使用したHelpページのビュー GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Help"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
<span class="hll">    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</span>  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp/help"</span><span class="nt">&gt;</span>Rails Tutorial help
      section<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
      Tutorial<span class="nt">&lt;/em&gt;</span> book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-about_view_erb_title" data-tralics-id="uid299" data-number="3.31">
<div class="heading">
<span class="number">リスト3.31:</span> 

<span class="description">タイトルにERBコードを使用したAboutページのビュー GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"About"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
<span class="hll">    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</span>  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
      Tutorial<span class="nt">&lt;/em&gt;&lt;/a&gt;</span> is a
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;</span>book<span class="nt">&lt;/a&gt;</span> and
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://screencasts.railstutorial.org/"</span><span class="nt">&gt;</span>screencast series<span class="nt">&lt;/a&gt;</span>
      to teach web development with
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>.
      This is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p>タイトルの可変部分をERBを使って置き換えたので、現在それぞれのページはだいたい以下のような構造になっています。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"The Title"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    Contents
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
<p class="noindent">こうして見ると、HTMLの構造はtitleタグの内容も含めてどのページも完全に同じです。異なる点があるとすれば、<code>body</code>タグの内側のコンテンツだけです。</p>
<p>これはもうリファクタリングしてHTMLの重複した構造をDRYにするしかないでしょう。ご想像のとおり、Railsにはそのために<code>application.html.erb</code>という名前の<em>レイアウト</em>ファイルがあります。最初<a class="hyperref" href="#sec-slightly_dynamic_pages"><span class="ref">3.4</span></a>でこのレイアウトファイルの名前をわざわざ変えておきましたが、いよいよ以下のコマンドでファイル名を元に戻すことにしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv layout_file app/views/layouts/application.html.erb
</pre></div></div>
<p>このレイアウトファイルを有効にするには、前述のデフォルトのタイトル部分を以下のERBコードに差し替えます。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p class="noindent">変更の結果、レイアウトファイルは<a class="hyperref" href="#code-application_layout"><span class="ref">リスト3.32</span></a>のようになります。</p>
<div class="codelisting" id="code-application_layout" data-tralics-id="uid300" data-number="3.32">
<div class="heading">
<span class="number">リスト3.32:</span> 

<span class="description">サンプルアプリケーションのレイアウト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
<span class="hll">    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</span>    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                              <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p class="noindent">上のコードにある、以下の特殊なコードにご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">このコードは、各ページの内容をレイアウトに挿入するためのものです。ここでは、このコードの詳細な動作を正確に理解することは重要ではありません。レイアウトを使用するうえでは、/static_pages/homeにアクセスすると、<code>home.html.erb</code>の内容がHTMLに変換され、<span class="inline_verbatim">&lt;%= yield %&gt;</span>の位置に挿入されるということだけ理解しておけば問題ありません。</p>
<p>Railsのデフォルトのレイアウトには、以下の行が追加されていることにもご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">上の3つのERBは、それぞれスタイルシート、JavaScript、<code>csrf_meta_tags</code>メソッドをページ内で展開するためのものです。スタイルシートとJavaScriptは、Asset Pipeline (<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-the_asset_pipeline"><span class="ref">5.2.1</span></a>) の一部です。csrf_meta_tagsは、Web攻撃手法のひとつである<a href="http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA" target="_blank">クロスサイトリクエストフォージェリー</a> (cross-site request forgery: CSRF)を防ぐために使われるRailsのメソッドです。</p>
<p>もちろん、<a class="hyperref" href="#code-home_view_erb_title"><span class="ref">リスト3.28</span></a>、<a class="hyperref" href="#code-help_view_erb_title"><span class="ref">リスト3.30</span></a>、 <a class="hyperref" href="#code-about_view_erb_title"><span class="ref">リスト3.31</span></a>のビューには、レイアウトと重複するHTMLがまだ残っているので、それらを削除して、内部のコンテンツだけ残します。この改修が終わると、 <a class="hyperref" href="#code-home_view_interior"><span class="ref">リスト3.33</span></a>、<a class="hyperref" href="#code-help_view_interior"><span class="ref">リスト3.34</span></a>、<a class="hyperref" href="#code-about_view_interior"><span class="ref">リスト3.35</span></a>のように実に簡潔で美しいコードになります。</p>
<div class="codelisting" id="code-home_view_interior" data-tralics-id="uid301" data-number="3.33">
<div class="heading">
<span class="number">リスト3.33:</span> 

<span class="description">HTML構造を削除したHomeページ GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Home"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-help_view_interior" data-tralics-id="uid302" data-number="3.34">
<div class="heading">
<span class="number">リスト3.34:</span> 

<span class="description">HTML構造を削除したHelpページ GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Help"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp/help"</span><span class="nt">&gt;</span>Rails Tutorial help section<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/em&gt;</span>
  book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-about_view_interior" data-tralics-id="uid303" data-number="3.35">
<div class="heading">
<span class="number">リスト3.35:</span> 

<span class="description">HTML構造を削除したAboutページ GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"About"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>About<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;&lt;em&gt;</span>Ruby on Rails
  Tutorial<span class="nt">&lt;/em&gt;&lt;/a&gt;</span> is a
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.jp"</span><span class="nt">&gt;</span>book<span class="nt">&lt;/a&gt;</span> and
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://screencasts.railstutorial.org/"</span><span class="nt">&gt;</span>screencast series<span class="nt">&lt;/a&gt;</span>
  to teach web development with
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>.
  This is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p class="noindent">上のように定義されたビューは、Home、Help、Aboutページの表示は以前と変わりませんが、コードの重複が大きく削減されました。</p>
<p>この節で行ったようなちっぽけなリファクタリングですら、実際にやってみると大小さまざまなエラーが発生します。ベテラン開発者ほどこのことを骨の髄まで理解しており、どんな小さなリファクタリングでもあなどったりしません。テストスイートをきちんと整備しておくことがいかに重要であるか、皆さんにもご理解いただけると思います。開発のごく初期の段階なら全ページを目視でひとつひとつ確認して回ることもできるかもしれませんが、そんな方法ではじきに手に負えなくなります。このアプリでは必要なテストスイートが整備されているので、今度も<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になることを確認するだけでOKです。</p>
<div class="codelisting" id="uid304" data-tralics-id="uid304" data-number="3.36">
<div class="heading">
<span class="number">リスト3.36:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 6 assertions, 0 failures, 0 errors, 0 skips
</pre></div></div>
</div>
<p class="noindent">もちろん厳密に言えば、テストがパスしたというだけではそのコードが本当に正しいのかどうかの<em>証明</em>にはなりません。しかし正しいコードに確実に近づくことができ、正しい可能性も上がります。何よりも、テストがあれば今後発生するバグを防ぐためのセーフティネットになります。</p>
</div>
<div id="sec-setting_the_root_route" class="subsection" data-tralics-id="uid305" data-number="3.4.4">
<h3><a href="#sec-setting_the_root_route" class="heading hyperref"><span class="number">3.4.4 </span>ルーティングの設定</a></h3>
<p>サイトのページのカスタマイズが終わって、テストスイートも軌道に乗ってきたので、今のうちにアプリケーションルートのルーティングを設定しておきましょう。<a class="hyperref" href="beginning?version=4.2#sec-hello_world"><span class="ref">1.3.4</span></a>と<a class="hyperref" href="toy_app?version=4.2#sec-mvc_in_action"><span class="ref">2.2.2</span></a>でやったように、ルーティングを設定するには<code>routes.rb</code>ファイルを編集して、ルート「/」とWebページを結び付けます。結び付ける相手はHomeページです (<a class="hyperref" href="#sec-sample_app_setup"><span class="ref">3.1</span></a>でApplicationコントローラに<code>hello</code>アクションを追加した場合は、今のうちにアクションを削除しておくことをおすすめします)。変更結果を<a class="hyperref" href="#code-home_root_route">リスト<span class="ref">3.37</span></a>に示します。ここでは、<a class="hyperref" href="#code-pages_routes">リスト<span class="ref">3.5</span></a>の<code>get</code>ルールを以下のコードに置き換えています。</p>
<div class="code"><div class="highlight"><pre><span class="n">root</span> <span class="s1">'static_pages#home'</span>
</pre></div></div>
<p class="noindent">上のルールに置き換えると、<code>static_pages/home</code>というURLから<code>static_pages#home</code>というコントローラ/アクションへの対応付けが変わり、ルート「/」への<span class="tt">GET</span>リクエストがStaticPagesコントローラの<code>home</code>アクションにルーティングされます。変更後のルーティングファイルを<a class="hyperref" href="#fig-home_root_route">図<span class="ref">3.7</span></a>に示します。<a class="hyperref" href="#code-home_root_route">リスト<span class="ref">3.37</span></a>のコードにすると、<code>static_pages/home</code>にアクセスしても動作しなくなります。</p>
<div class="codelisting" id="code-home_root_route" data-tralics-id="uid306" data-number="3.37">
<div class="heading">
<span class="number">リスト3.37:</span> 

<span class="description">HomeページをルートURLに設定する<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
<span class="hll">  <span class="n">root</span> <span class="s1">'static_pages#home'</span>
</span>  <span class="n">get</span>  <span class="s1">'static_pages/help'</span>
  <span class="n">get</span>  <span class="s1">'static_pages/about'</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-home_root_route" data-tralics-id="uid307" data-number="3.7">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_root_route.png" alt="images/figures/home_root_route"></div>
<div class="caption">
<span class="header">図3.7 </span><span class="description">ルートURLにアクセスするとHomeページが表示される
</span>
</div>
</div>
</div>
</div><div id="sec-static_pages_conclusion" class="section" data-tralics-id="cid20" data-number="3.5">
<h2><a href="#sec-static_pages_conclusion" class="heading hyperref"><span class="number">3.5</span> 最後に</a></h2>
<p>はたから見れば、皆さんがこの章で結局どんなことを達成できたのかさっぱりわからないかもしれません。静的なページをあれこれ作り替えて、<em>ほぼ</em>静的なページにしただけなのでしょうか。もちろんそんなことはありません。皆さんはこの章でRailsのコントローラ、アクション、ビューの開発をひととおり行ったことで、これから動的なコンテンツをどしどしサイトに追加するための準備がすっかり整ったのです。残る課題は、皆さんがこのチュートリアルをいかに最後までやりぬくか、それだけであると言ってよいでしょう。</p>
<p>次の章に進む前に、差分をコミットしてmasterブランチにマージしておきましょう。<a class="hyperref" href="#sec-static_pages"><span class="ref">3.1</span></a>では、静的ページの開発のためのGitブランチを用意しました。ここまでの作業内容をコミットしていない場合、作業の区切りをつけるためにもコミットしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Finish static pages"</span>
</pre></div></div>
<p class="noindent">次にmasterブランチに移動し、<a class="hyperref" href="beginning?version=4.2#sec-git_commands"><span class="ref">1.4.4</span></a><sup class="footnote" id="cha-3_footnote-ref-16"><a href="#cha-3_footnote-16">16</a></sup>と同じ要領で差分をマージします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge static-pages
</pre></div></div>
<p>このように中継点まで達したら、コードをリモートリポジトリにアップロードしておくとよいでしょう (<a class="hyperref" href="beginning?version=4.2#sec-bitbucket"><span class="ref">1.4.3</span></a>の手順に従っていれば、リモートリポジトリはBitBucketを使用することになるでしょう)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push</pre></div></div>
<p class="noindent">また、この時点でHerokuにデプロイしてみてもよいでしょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push heroku
</pre></div></div>
<p class="noindent">デプロイする前にテストを走らせていますが、こういった習慣を身につけておくと開発に役立ちます。</p>
<div id="sec-static_pages_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid309" data-number="3.5.1">
<h3><a href="#sec-static_pages_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">3.5.1 </span>本章のまとめ</a></h3>
<ul>
<li>新しいRailsアプリケーションをゼロから作成したのはこれで3度目。今回も必要なgemのインストール、リモートリポジトリへのプッシュ、production環境まで行った。
</li>
<li>コントローラを新規作成するための<code>rails</code>のスクリプトは<code>rails generate controller ControllerName &lt;action name (省略可)&gt;</code>。訳注: コントローラ名はキャメルケース、アクション名はスネークケースにする。
</li>
<li>新しいルーティングは<code>config/routes.rb</code>ファイルで定義する。
</li>
<li>Railsのビューでは、静的HTMLの他にERB (埋め込みRuby: Embedded RuBy) も使用できる。
</li>
<li>常に自動化テストを使用して新機能開発を進めることで、自信を持ってリファクタリングできるようになり、回帰バグもいちはやくキャッチできるようになる。
</li>
<li>テスト駆動開発では「レッド・グリーン・リファクタリング」サイクルを繰り返す。
</li>
<li>Railsのレイアウトでは、アプリケーションのページの共通部分をテンプレートに置くことでコードの重複を解決することができる。
</li>
</ul>
</div>
</div><div id="sec-static_pages_exercises" class="section" data-tralics-id="cid21" data-number="3.6">
<h2><a href="#sec-static_pages_exercises" class="heading hyperref"><span class="number">3.6</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で原著を購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>以後本チュートリアルの演習を解く際には、以下のように演習用トピックブランチを別途作成してそこで行うことをおすすめします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout static-pages
<span class="gp">$</span> git checkout -b static-pages-exercises
</pre></div></div>
<p class="noindent">トピックブランチを分けておくことで、チュートリアル本編との食い違いを避けることができます。</p>
<p>満足のゆく解ができたら、リモートリポジトリにプッシュしてもよいでしょう (リモートリポジトリがある場合)。</p>
<div class="code"><div class="highlight"><pre><span class="go">&lt;solve first exercise&gt;</span>
<span class="gp">$</span> git commit -am <span class="s2">"Eliminate repetition (solves exercise 3.1)"</span>
<span class="go">&lt;solve second exercise&gt;</span>
<span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Add a Contact page (solves exercise 3.2)"</span>
<span class="gp">$</span> git push -u origin static-pages-exercises
<span class="gp">$</span> git checkout master
</pre></div></div>
<p class="noindent">(最後の行では、この後の開発準備のためにmasterブランチをチェックアウトしていますが、チュートリアル本編への影響を避けるため、演習で行った変更はmasterにマージ<em>していません</em>)。今後の章では、ブランチやコミットメッセージはもちろん異なりますが、基本的なアイディアは同じです。</p>
<ol>
<li>StaticPagesコントローラのテスト (<a class="hyperref" href="#code-title_tests">リスト<span class="ref">3.22</span></a>) にも重複があることにお気付きでしょうか。特に「Ruby on Rails Tutorial Sample App」を全てのタイトルテストでそのまま使っています。専用の<code>setup</code>関数 (テストの設定用関数、個別のテストの前に必ず毎回実行される) を使用してこの重複を解消し、テスト修正後も<a class="hyperref" href="#code-base_title_test">リスト<span class="ref">3.38</span></a>のテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になることを確認します (なお、<a class="hyperref" href="#code-base_title_test">リスト<span class="ref">3.38</span></a>では<em>インスタンス変数</em> (<a class="hyperref" href="toy_app?version=4.2#sec-mvc_in_action"><span class="ref">2.2.2</span></a>と<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>) と<em>文字列の式展開</em> (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-strings"><span class="ref">4.2.2</span></a>を使用しています)。
</li>
<li>サンプルアプリケーションにContact (問い合わせ先) ページを作成してください<sup class="footnote" id="cha-3_footnote-ref-17"><a href="#cha-3_footnote-17">17</a></sup>。<a class="hyperref" href="#code-about_test">リスト<span class="ref">3.13</span></a>を参考にして、/static_pages/contactというURLのページに「Contact | Ruby on Rails Tutorial Sample App」というタイトルが存在するかどうかを確認するテストを最初に作成しましょう。<a class="hyperref" href="#sec-green"><span class="ref">3.3.3</span></a>でAboutページにやったのと同じように、Contactページにも<a class="hyperref" href="#code-proposed_contact_page">リスト<span class="ref">3.39</span></a>のコンテンツを表示しましょう (<a class="hyperref" href="#code-proposed_contact_page">リスト<span class="ref">3.39</span></a>には<a class="hyperref" href="#code-base_title_test">リスト<span class="ref">3.38</span></a>のような修正は行われていないので、そのままコピペしても動きません)。
</li>
</ol>
<div class="codelisting" id="code-base_title_test" data-tralics-id="uid320" data-number="3.38">
<div class="heading">
<span class="number">リスト3.38:</span> 

<span class="description">基本タイトルを含めたStaticPagesコントローラのテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/static_pages_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">StaticPagesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="vi">@base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:home</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Home | </span><span class="si">#{</span><span class="vi">@base_title</span><span class="si">}</span><span class="s2">"</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get help"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:help</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Help | </span><span class="si">#{</span><span class="vi">@base_title</span><span class="si">}</span><span class="s2">"</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get about"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:about</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"About | </span><span class="si">#{</span><span class="vi">@base_title</span><span class="si">}</span><span class="s2">"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-proposed_contact_page" data-tralics-id="uid321" data-number="3.39">
<div class="heading">
<span class="number">リスト3.39:</span> 

<span class="description">Contactページで使用するコード<span class="break"></span> <span class="filepath">app/views/static_pages/contact.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Contact"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact the Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/#contact"</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
</div><div id="sec-advanced_testing_setup" class="section" data-tralics-id="cid22" data-number="3.7">
<h2><a href="#sec-advanced_testing_setup" class="heading hyperref"><span class="number">3.7 </span>高度なセットアップ</a></h2>
<p>この追加の節は、<a href="http://screencasts.railstutorial.org/" target="_blank">Ruby on Railsチュートリアルスクリーンキャストシリーズ</a> (原著者の主催する有料スクリーンキャスト: 英語のみ) で使用するテスト用設定について解説します。大きく3つに分かれます: 高度なパス/失敗表示 (<a class="hyperref" href="#sec-minitest_reporters"><span class="ref">3.7.1</span></a>)、テスト失敗時の大量のバックトレースメッセージをフィルタするユーティリティ (<a class="hyperref" href="#sec-backtrace_silencer"><span class="ref">3.7.2</span></a>)、ファイルの変更を検出して、必要なテストだけを自動実行してくれる「自動テスト実行ユーティリティ」(<a class="hyperref" href="#sec-guard"><span class="ref">3.7.3</span></a>)。この節で参考までに示したコードはそれなりに高度なので、今すぐ理解できるようになる必要はありません。</p>
<p>この節の変更はmasterブランチで行う必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
</pre></div></div>
<div id="sec-minitest_reporters" class="subsection" data-tralics-id="uid322" data-number="3.7.1">
<h3><a href="#sec-minitest_reporters" class="heading hyperref"><span class="number">3.7.1 </span>minitestレポーター</a></h3>
<p>Railsのデフォルトのテストで、必要なときに<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>や<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>を表示できるようにするには、<a class="hyperref" href="#code-minitest_reporters">リスト<span class="ref">3.40</span></a>のテストヘルパーファイル<sup class="footnote" id="cha-3_footnote-ref-18"><a href="#cha-3_footnote-18">18</a></sup>をコードに追加し、<a href="https://github.com/kern/minitest-reporters" target="_blank"><span class="tt">minitest-reporters</span></a> gem (<a class="hyperref" href="#code-gemfile_sample_app">リスト<span class="ref">3.2</span></a>) </p>
<div class="codelisting" id="code-minitest_reporters" data-tralics-id="uid324" data-number="3.40">
<div class="heading">
<span class="number">リスト3.40:</span> 

<span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>や<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span>を表示できるようにする</span><span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../../config/environment'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">'rails/test_help'</span>
<span class="hll"><span class="nb">require</span> <span class="s2">"minitest/reporters"</span>
</span><span class="hll"><span class="no">Minitest</span><span class="o">::</span><span class="no">Reporters</span><span class="o">.</span><span class="n">use!</span>
</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical</span>
  <span class="c1"># order.</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Add more helper methods to be used by all tests here...</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">この変更により、Cloud IDE上の表示が<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>から<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>に変わります (<a class="hyperref" href="#fig-red_to_green">図<span class="ref">3.8</span></a>)。</p>
<div class="center figure" id="fig-red_to_green" data-tralics-id="uid325" data-number="3.8">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/red_to_green.png" alt="images/figures/red_to_green"></div>
<div class="caption">
<span class="header">図3.8: </span><span class="description">Cloud IDE上で表示を<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>から<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>に変える
</span>
</div>
</div>
</div>
<div id="sec-backtrace_silencer" class="subsection" data-tralics-id="uid326" data-number="3.7.2">
<h3><a href="#sec-backtrace_silencer" class="heading hyperref"><span class="number">3.7.2 </span>Backtrace silencer</a></h3>
<p>テストが失敗した時に、テスト失敗の道筋をアプリケーション全体にわたってたどるスタックトレース (バックトレース) が表示されます。バックトレースは問題を追跡するうえでは非常に便利なのですが、クラウドIDEなど一部のシステムでは、このトレースがgemの依存関係やRails自身にまで及ぶことがあります。そうなると大量のスタックトレースが出力されて非常に不便です。gemの依存関係を調べているのでもなければ、開発しているアプリケーションで問題の原因を追跡中に大量のメッセージが出力されても、邪魔なだけです。</p>
<p>こうした不要な出力行を除去するために、バックトレースをフィルタしますこれを行うには<a href="https://github.com/metaskills/mini_backtrace" target="_blank"><span class="tt">mini_backtrace</span></a> gem (<a class="hyperref" href="#code-gemfile_sample_app">リスト<span class="ref">3.2</span></a>) と<em>backtrace silencer</em>を組み合わせます。クラウドIDEの場合、そうした不要な行ではほとんどの場合<code>rvm</code> (=Ruby Version Manager) という文字がパスに含まれているので、これを利用してフィルタします (<a class="hyperref" href="#code-backtrace_silencer">リスト<span class="ref">3.41</span></a>)。</p>
<div class="codelisting" id="code-backtrace_silencer" data-tralics-id="uid327" data-number="3.41">
<div class="heading">
<span class="number">リスト3.41:</span> 

<span class="description">RVMをフィルタするbacktrace silencerを追加する <span class="break"></span> <span class="filepath">config/initializers/backtrace_silencers.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Be sure to restart your server when you modify this file.</span>

<span class="c1"># You can add backtrace silencers for libraries that you're using but don't</span>
<span class="c1"># wish to see in your backtraces.</span>
<span class="hll"><span class="no">Rails</span><span class="o">.</span><span class="n">backtrace_cleaner</span><span class="o">.</span><span class="n">add_silencer</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/rvm/</span> <span class="p">}</span>
</span>
<span class="c1"># You can also remove all the silencers if you're trying to debug a problem</span>
<span class="c1"># that might stem from framework code.</span>
<span class="c1"># Rails.backtrace_cleaner.remove_silencers!</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-backtrace_silencer">リスト<span class="ref">3.41</span></a>のコメント冒頭にあるように、backtrace silencerを追加した後は必ずRails webサーバーを再起動してください。</p>
</div>
<div id="sec-guard" class="subsection" data-tralics-id="uid328" data-number="3.7.3">
<h3><a href="#sec-guard" class="heading hyperref"><span class="number">3.7.3</span> Guardによるテストの自動化</a></h3>
<p><code>rake test</code>コマンドは、テストをする度にコマンドラインに移動して手動でコマンドを実行しなければならない点が面倒です。この不便さを取り除くために、<a href="https://github.com/guard/guard" target="_blank"><em>Guard</em></a>を使ってテストを自動的に実行させるようにしてみましょう。Guardは、ファイルシステムの変更を監視し、たとえば<code>static_pages_test.rb</code>ファイルなどを変更すると自動的にテストを実行してくれるツールです。また、テストファイルだけでなく、<code>home.html.erb</code>ファイルが変更されると<code>static_pages_test.rb</code>が自動的に実行されるようにGuardを設定することもできます。</p>
<p>実はすでに、<code>リスト<a class="hyperref" href="#code-gemfile_sample_app">3.2</a></code>の<span class="ref">Gemfile</span>で<span class="tt">guard</span> gemをアプリケーション内に取り込んでいます。したがって、あとは初期化するだけで動かすことができます。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec guard init
Writing new Guardfile to /home/ubuntu/workspace/sample_app/Guardfile
00:51:32 - INFO - minitest guard added to Guardfile, feel free to edit it
</pre></div></div>
<p class="noindent">統合テストとビューが更新されたら自動的に適切なテストが実行されるように、生成された<code>Guardfile</code>を編集します (<a class="hyperref" href="#code-guardfile">リスト<span class="ref">3.42</span></a>)。(やや長くて応用的な設定なので、<a class="hyperref" href="#code-guardfile">リスト<span class="ref">3.42</span></a>をコピペしてしまった方がよいでしょう)</p>
<div class="codelisting" id="code-guardfile" data-tralics-id="uid329" data-number="3.42">
<div class="heading">
<span class="number">リスト3.42:</span> 

<span class="description">カスタマイズした<code>Guardfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Defines the matching rules for Guard.</span>
<span class="hll"><span class="n">guard</span> <span class="ss">:minitest</span><span class="p">,</span> <span class="ss">spring</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">all_on_start</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
</span>  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^test/(.*)/?(.*)_test\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'test/test_helper.rb'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'test'</span> <span class="p">}</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'config/routes.rb'</span><span class="p">)</span>    <span class="p">{</span> <span class="n">integration_tests</span> <span class="p">}</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/models/(.*?)\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">matches</span><span class="o">|</span>
    <span class="s2">"test/models/</span><span class="si">#{</span><span class="n">matches</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_test.rb"</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/(.*?)_controller\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">matches</span><span class="o">|</span>
    <span class="n">resource_tests</span><span class="p">(</span><span class="n">matches</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/views/([^/]*?)/.*\.html\.erb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">matches</span><span class="o">|</span>
    <span class="o">[</span><span class="s2">"test/controllers/</span><span class="si">#{</span><span class="n">matches</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_controller_test.rb"</span><span class="o">]</span> <span class="o">+</span>
    <span class="n">integration_tests</span><span class="p">(</span><span class="n">matches</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/helpers/(.*?)_helper\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">matches</span><span class="o">|</span>
    <span class="n">integration_tests</span><span class="p">(</span><span class="n">matches</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'app/views/layouts/application.html.erb'</span><span class="p">)</span> <span class="k">do</span>
    <span class="s1">'test/integration/site_layout_test.rb'</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'app/helpers/sessions_helper.rb'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">integration_tests</span> <span class="o">&lt;&lt;</span> <span class="s1">'test/helpers/sessions_helper_test.rb'</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'app/controllers/sessions_controller.rb'</span><span class="p">)</span> <span class="k">do</span>
    <span class="o">[</span><span class="s1">'test/controllers/sessions_controller_test.rb'</span><span class="p">,</span>
     <span class="s1">'test/integration/users_login_test.rb'</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'app/controllers/account_activations_controller.rb'</span><span class="p">)</span> <span class="k">do</span>
    <span class="s1">'test/integration/users_signup_test.rb'</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{app/views/users/*}</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">resource_tests</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span> <span class="o">+</span>
    <span class="o">[</span><span class="s1">'test/integration/microposts_interface_test.rb'</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Returns the integration tests corresponding to the given resource.</span>
<span class="k">def</span> <span class="nf">integration_tests</span><span class="p">(</span><span class="n">resource</span> <span class="o">=</span> <span class="ss">:all</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="ss">:all</span>
    <span class="no">Dir</span><span class="o">[</span><span class="s2">"test/integration/*"</span><span class="o">]</span>
  <span class="k">else</span>
    <span class="no">Dir</span><span class="o">[</span><span class="s2">"test/integration/</span><span class="si">#{</span><span class="n">resource</span><span class="si">}</span><span class="s2">_*.rb"</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Returns the controller tests corresponding to the given resource.</span>
<span class="k">def</span> <span class="nf">controller_test</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
  <span class="s2">"test/controllers/</span><span class="si">#{</span><span class="n">resource</span><span class="si">}</span><span class="s2">_controller_test.rb"</span>
<span class="k">end</span>

<span class="c1"># Returns all tests for the given resource.</span>
<span class="k">def</span> <span class="nf">resource_tests</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
  <span class="n">integration_tests</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">controller_test</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードにある以下の行にご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="n">guard</span> <span class="ss">:minitest</span><span class="p">,</span> <span class="ss">spring</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">all_on_start</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
</pre></div></div>
<p class="noindent">この行ではGuardからSpringサーバーを使用して読み込み時間を短縮しています (SpringはRailsの機能のひとつです)。また、開始時にテストスイートをフルで実行しないようGuardに指示しています。</p>
<p>Guard使用時のSpringとGitの競合を防ぐには、<code>.gitignore</code>ファイルに<code>spring/</code>ディレクトリを追加します。.gitignoreはGitの設定ファイルのひとつで、ここで指定されたファイルはGitレポジトリに追加されなくなります。クラウドIDEでは以下の操作を行います。</p>
<ol>
<li>ナビゲーションパネルの右上のにある歯車アイコンをクリックします (<a class="hyperref" href="#fig-file_navigator_gear_icon">図<span class="ref">3.9</span></a>)。
</li>
<li>[Show hidden files] を選択して、アプリケーションのルートディレクトリにある<code>.gitignore</code>ファイルを表示します (<a class="hyperref" href="#fig-show_hidden_files">図<span class="ref">3.10</span></a>).
</li>
<li>
<code>.gitignore</code>ファイル (<a class="hyperref" href="#fig-gitignore">図<span class="ref">3.11</span></a>) をダブルクリックして開き、<a class="hyperref" href="#code-gitignore_spring">リスト<span class="ref">3.43</span></a>のように更新します。
</li>
</ol>
<div class="center figure" id="fig-file_navigator_gear_icon" data-tralics-id="uid333" data-number="3.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/file_navigator_gear_icon.png" alt="images/figures/file_navigator_gear_icon"></div>
<div class="caption">
<span class="header">図3.9</span> <span class="description">ファイルナビゲーターにある (あまり目立たない) ギアのアイコン
</span>
</div>
</div>
<div class="center figure" id="fig-show_hidden_files" data-tralics-id="uid334" data-number="3.10">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/show_hidden_files.png" alt="images/figures/show_hidden_files"></div>
<div class="caption">
<span class="header">図3.10 </span><span class="description">ファイルナビゲーター内の隠しファイルを表示する
</span>
</div>
</div>
<div class="center figure" id="fig-gitignore" data-tralics-id="uid335" data-number="3.11">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/gitignore.png" alt="images/figures/gitignore"></div>
<div class="caption">
<span class="header">図3.11 </span><span class="description">隠れている<code>.gitignore</code>ファイルを表示する
</span>
</div>
</div>
<div class="codelisting" id="code-gitignore_spring" data-tralics-id="uid336" data-number="3.43">
<div class="heading">
<span class="number">リスト3.43:</span> 

<span class="description"><code>.gitignore</code>にSpringを追加する</span>
</div>

<div class="code"><div class="highlight"><pre># See https://help.github.com/articles/ignoring-files for more about ignoring
# files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

<span class="hll"># Ignore Spring files.
</span><span class="hll">/spring/*.pid
</span></pre></div></div>
</div>
<p>Springサーバーは本節の執筆時点では若干不安定な点が残っていて、Springの<em>プロセス</em>が起動したまま多数残留すると、テストのパフォーマンスが低下してしまうことがあります。テストの実行が異常に遅くなってきたと感じたら、システムプロセスをチェックしてSpringを必要に応じてkillするとよいでしょう (<a class="hyperref" href="#aside-processes">コラム<span class="ref">3.4</span></a>)。</p>
<div class="aside" id="aside-processes" data-tralics-id="uid337" data-number="3.4">
<div class="heading">
<span class="number">コラム3.4</span> 

<span class="description">Unixのプロセス</span>
</div>
<p>LinuxやOS XなどのUnix系システムは、ユーザータスクやシステムタスクは<em>プロセス (process)</em> と呼ばれる一種のコンテナの内部で実行されます。システム上で動いているすべてのプロセスは、<span class="tt">ps</span>コマンドに<span class="tt">aux</span>オプションを付けて実行することで確認できます。</p>
<pre class="verbatim">  $ ps aux</pre>
<p class="noindent">プロセスの種類を指定してフィルタするには、<span class="tt">ps</span>の結果をUnixの「パイプ」<span class="tt">|</span>でつないで、パターンマッチャーである<span class="tt">grep</span>に渡します。</p>
<pre class="verbatim">  $ ps aux | grep spring
  ubuntu 12241 0.3 0.5 589960 178416 ? Ssl Sep20 1:46
  spring app | sample_app | started 7 hours ago</pre>
<p class="noindent">表示結果の中で重要なのは最初の列の数値です。これは<em>プロセスid</em>、略してpidと呼ばれるものです。不要なプロセスを排除するには、<span class="tt">kill</span>コマンドでpidを指定し、Unixのkillコード (<a href="https://ja.wikipedia.org/wiki/%E3%82%B7%E3%82%B0%E3%83%8A%E3%83%AB_(%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2)" target="_blank">ここでは9ですがシステムによって異なります</a>) を発行します。</p>
<pre class="verbatim">  $ kill -15 12241</pre>
<p class="noindent">行儀の悪いRailsサーバーなどのプロセスをkillする際には、上のようにひとつずつkillすることをおすすめします。Railsサーバーのpidを知るには、<span class="tt">ps aux | grep server</span>)などと実行します。しかし時には特定の名前を持つプロセスをまとめてkillしたいこともあります。しつこい<span class="tt">spring</span>プロセスたちをひとつずつkillするのは大変面倒です。一括killを行うには、最初に<span class="tt">spring</span>コマンドそのものでプロセスを停止しておく必要があります。</p>
<pre class="verbatim">  $ spring stop</pre>
<p class="noindent">このコマンドが効かないことも多いので、そのときはいよいよ<span class="tt">pkill</span>コマンドで<span class="tt">spring</span>の名前を指定してkillします。</p>
<pre class="verbatim">  $ pkill -15 -f spring</pre>
<p class="noindent">開発中に動作がおかしくなったりプロセスがフリーズしていると思えたら、すぐに<span class="tt">ps aux</span>で状態を確認し、<span class="tt">kill -15 &lt;pid&gt;</span>や<span class="tt">pkill -15 -f &lt;プロセス名&gt;</span>でクリーンアップしましょう。</p>

</div>
<p>Guardの設定が完了したら、新しいターミナルを開き (<a class="hyperref" href="beginning?version=4.2#sec-rails_server"><span class="ref">1.3.2</span></a>でやったようにRailsサーバーのターミナルと別にするのがポイントです)、以下をコマンドラインで実行します</p>
<div class="code"><div class="highlight"><pre>$ bundle exec guard
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-guardfile">リスト<span class="ref">3.42</span></a>のルールは本チュートリアルに最適化したものなので、たとえばコントローラのファイルを変更すると、Guardは即座にそれを検出して、そのコントローラの統合テストを自動実行します。テストを変更ファイルだけではなく、<em>フル</em>で実行したい場合は、<code>guard&gt;</code>プロンプトでReturnキーを押します (このとき、Springサーバーに接続できないなどのエラーが表示されることがあります。問題を修正するには、もう一度Returnキーを押します)。</p>
<p>Guardを終了するにはCtrl-Dキーを押します。Guardに他のマッチャーを追加する方法については、<a class="hyperref" href="#code-guardfile">リスト<span class="ref">3.42</span></a>の例、<a href="https://github.com/guard/guard" target="_blank">Guard README</a>、<a href="https://github.com/guard/guard/wiki" target="_blank">Guard wiki</a>を参照してください。</p>
</div>
</div><div id="cha-3_footnotes">
  <div class="navigation">
<a class="next_page" href="rails_flavored_ruby?version=4.2#cha-rails_flavored_ruby">« <span class="number">第4章</span> Rails風味のRuby</a><a class="prev_page" href="toy_app?version=4.2#cha-a_toy_app"> <span class="number">第2章</span> Toyアプリ</a>
</div>
<ol class="footnotes">
    <li id="cha-3_footnote-1">クラウドIDEをお使いの場合は「Goto Anything」コマンド (ファイル名の一部を入力するだけでその場所にジャンプする) が重宝します。「hello」アプリ「toy」アプリ「sample」アプリには同じファイル名が多数あるため、これらのアプリを同じプロジェクトに置くとファイルを見つけにくくなることがあります。たとえば「Gemfile」というファイル名を検索すると、<code>Gemfile</code>と<code>Gemfile.lock</code>を含め、候補が6つも表示されてしまいます。そこで、この先に進む前に先の2つのアプリを思い切って削除しておくとよいでしょう。アプリを削除するには、<code>workspace</code>ディレクトリに移動して<code>rm -rf hello_app/ toy_app/</code>コマンドを実行します(<a class="hyperref" href="beginning?version=4.2#table-unix_commands">表<span class="ref">1.1</span></a>)。これらのアプリを既にBitbucketのリポジトリにプッシュしてあるなら、それを利用していつでもアプリを復元できます (その必要があればですが)。<a class="arrow" href="#cha-3_footnote-ref-1">↑</a>
</li>
    <li id="cha-3_footnote-2">この<span class="inline_verbatim">--without</span> <span class="inline_verbatim">production</span>オプションを一度実行すると「記憶される」ことにご注意ください。つまり、次回以降<code>bundle install</code>を実行すると、このオプションが暗黙で自動適用されます。<a class="arrow" href="#cha-3_footnote-ref-2">↑</a>
</li>
    <li id="cha-3_footnote-3">最終的には皆さんがPostgreSQLをdevelopment環境にインストールして設定できるようになるのが理想ですが、今は時期尚早であると考えます。実際に必要が生じたときは「install configure postgresql &lt;自分のシステム&gt;」や「rails postgresql setup」でググって各自挑戦してみてください (クラウドIDEの場合は&lt;自分のシステム&gt;にUbuntuと指定します)。<a class="arrow" href="#cha-3_footnote-ref-3">↑</a>
</li>
    <li id="cha-3_footnote-4">
<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app">第<span class="ref">2</span>章</a>でも指摘したとおり、主な理由は、デフォルトのRailsページはHerokuで破損してしまうことが多く、そのままだとデプロイが成功したのか失敗したのかがわかりにくいためです。<a class="arrow" href="#cha-3_footnote-ref-4">↑</a>
</li>
    <li id="cha-3_footnote-5">ここで静的なページを作るために採用した方法は、おそらく最もシンプルな方法です。ただし他にも方法はあります。最適な方法は状況によって異なり、たとえば<em>極めて多数</em>の静的なページを1つのStaticPagesコントローラだけまかなおうとすると重荷になる可能性があります。今回はいくつかの静的なページを作るだけなので、重荷にはなりません。もし多数の静的なページが必要になる場合は、<a href="https://github.com/thoughtbot/high_voltage" target="_blank"><span class="tt">high_voltage</span></a> gem を調べてみてください。なお、この問題には (やや古いですが) 有益な議論があります。 詳しくは <a href="http://blog.hasmanythrough.com/2008/4/2/simple-pages" target="_blank">hasmanythroughに投稿された記事「simple pages」</a> (英語) を読んでみてください。<a class="arrow" href="#cha-3_footnote-ref-5">↑</a>
</li>
    <li id="cha-3_footnote-6">Rails生みの親であるDavid Heinemeier Hansson (通称DHH) の有名な記事『<a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html" target="_blank">TDDは死んだ。テスティングに栄光あれ</a>』(英語) を参照。<a class="arrow" href="#cha-3_footnote-ref-6">↑</a>
</li>
    <li id="cha-3_footnote-7">
<a class="hyperref" href="toy_app?version=4.2#sec-demo_users_resource"><span class="ref">2.2</span></a>でも説明したように、システム環境によっては<code>bundle exec</code>が追加不要なこともあります。クラウドIDE (<a class="hyperref" href="beginning?version=4.2#sec-development_environment"><span class="ref">1.2.1</span></a>) も追加不要なシステムのひとつです。しかしここでは省略せずにコマンドを記述しています。著者の場合、原則として<code>bundle exec</code>は追加せずに実行し、うまくいかないときだけ<code>bundle exec</code>を追加して様子を見る、ということをよく行っています。<a class="arrow" href="#cha-3_footnote-ref-7">↑</a>
</li>
    <li id="cha-3_footnote-8">
<code>rake test</code>はデフォルトで、テストの失敗を赤色で表示しますが、テストがパスしても緑色で表示しません。色もちゃんと表示したい場合は<a class="hyperref" href="#sec-minitest_reporters"><span class="ref">3.7.1</span></a>をご覧ください。<a class="arrow" href="#cha-3_footnote-ref-8">↑</a>
</li>
    <li id="cha-3_footnote-9">システムによっては、ソースコードのエラーパスを追跡する「スタックトレース」または「バックトレース」と呼ばれるメッセージが大量に表示されることがあります。この場合、かなり上にスクロールする必要があるかもしれません。バックトレース出力を絞り込んで不要な行が表示されないようにしたい場合は、<a class="hyperref" href="#sec-backtrace_silencer"><span class="ref">3.7.2</span></a>をご覧ください。<a class="arrow" href="#cha-3_footnote-ref-9">↑</a>
</li>
    <li id="cha-3_footnote-10">HTMLの仕様は時とともに変わる可能性があると思っておく方がよいでしょう。今後もブラウザでなるべく正しくページを表示できるように、doctypeを明示的に宣言しています。追加属性がまったくないシンプルな「<code>&lt;!DOCTYPE html&gt;</code>」は、最新標準であるHTML5の特徴です。<a class="arrow" href="#cha-3_footnote-ref-10">↑</a>
</li>
    <li id="cha-3_footnote-11">minitestで利用できるアサーションのリストについては、Railsガイドの<a href="http://railsguides.jp/testing.html#available-assertions" target="_blank">「Rails テスティングガイド」</a>をご覧ください。<a class="arrow" href="#cha-3_footnote-ref-11">↑</a>
</li>
    <li id="cha-3_footnote-12">本書のスクリーンショットでは原則としてGoogle Chromeを使用していますが、Chromeのタブはタイトルを表示しきれないので、<a class="hyperref" href="#fig-home_view_full_html">図<span class="ref">3.6</span></a>では代わりにSafariを使用しています。<a class="arrow" href="#cha-3_footnote-ref-12">↑</a>
</li>
    <li id="cha-3_footnote-13">2番目に人気のテンプレートとして<a href="http://haml.info/" target="_blank">Haml</a>があり (注意: "HAML"ではありません) 、筆者は個人的にHamlの方が気に入っています。残念ながら<em>十分に</em>普及していないため、初級者向けチュートリアルの採用は見送りました。<a class="arrow" href="#cha-3_footnote-ref-13">↑</a>
</li>
    <li id="cha-3_footnote-14">Railsでの開発経験者であれば、この時点で<code>content_for</code>の使用を検討すると思いますが、残念ながらAsset Pipelineと併用すると正常に動作しないことがあります。<code>provide</code>関数はcontent_forの代替です。<a class="arrow" href="#cha-3_footnote-ref-14">↑</a>
</li>
    <li id="cha-3_footnote-15">Rubyを勉強したことのある方であれば、Railsはブロックの内容を<em>yield</em>していると推測することでしょう。そして、その推測はおそらく正しいでしょう。しかし、Rails開発のためにこれらの詳細を知る必要はありません。<a class="arrow" href="#cha-3_footnote-ref-15">↑</a>
</li>
    <li id="cha-3_footnote-16">コミット時に「マージするとSpringのプロセスID (pid) ファイルが上書きされる可能性があります」のようなエラーメッセージが表示される場合は、コマンドラインで<code>rm -f *.pid</code>を実行してpidファイルを削除してください。<a class="arrow" href="#cha-3_footnote-ref-16">↑</a>
</li>
    <li id="cha-3_footnote-17">この演習は<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-contact_page"><span class="ref">5.3.1</span></a>の節に解答があります。<a class="arrow" href="#cha-3_footnote-ref-17">↑</a>
</li>
    <li id="cha-3_footnote-18">
<a class="hyperref" href="#code-minitest_reporters">リスト<span class="ref">3.40</span></a>のコードには、シングルクオーテーション (') とダブルクオーテーション (") の両方が含まれています。これは、<code>rails new</code>で生成されたコードはシングルクオーテーションを使っていますが、<a href="https://github.com/kern/minitest-reporters" target="_blank">minitestレポーターのドキュメント</a>ではダブルクオーテーションを使っていることが原因です。Rubyでは、この2つのクオーテーションを併用することが一般的です。詳しくは<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-strings"><span class="ref">4.2.2</span></a>で解説します。 <a class="arrow" href="#cha-3_footnote-ref-18">↑</a>
</li>
  </ol>
</div>
          </div>
          <div id="book_bottom"></div>
          <div id="last-thoughts" class="announce">
  Railsチュートリアルは，リモートワークを推進する<a href="http://yasslab.jp/ja/">ヤスラボ</a>によって運営・保守されております.<br />
  スポンサードや<a href="/seminars">解説セミナー</a>に関するご要望がありましたら，<a href="/contact">お問い合わせ</a>ページからお気軽にご連絡ください :)
</div>

        </div>

        <div id="container-bottom"></div>
      </div>
    </div>
    <div id="footer">
  <!--<a href="https://mixpanel.com/f/partner"><img src="//cdn.mxpnl.com/site_media/images/partner/badge_light.png" alt="Mobile Analytics" /></a>-->
</div>
<div class="menu">
  <div class='links'>
    <div class='box'>
      <span>
	<a href="/">ホーム</a>
      </span>
      <span class='division'>|</span>
      <span>
	<a href="/help">ヘルプ</a>
      </span>
            <span class='division'>|</span>
      <span>
	<a href="/contact">お問い合わせ</a>
      </span>
      <span class='division'>|</span>
      <span>
	<a href="/seminars">解説セミナー</a>
      </span>
      <span class='division'>|</span>
      <span style="padding-top:6px">
	<a href="http://b.hatena.ne.jp/entry/railstutorial.jp/" class="hatena-bookmark-button"
	   data-hatena-bookmark-title="Rails チュートリアル" data-hatena-bookmark-layout="standard-balloon"
	   data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加">
	  <img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png"
	       alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
	</a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
      </span>
    </div>
  </div>
</div>
<br />
<br />
<br />

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=144878509039953&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

</body>

</html>
