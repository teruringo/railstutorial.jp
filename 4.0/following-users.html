<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
            




            
            
            <div id="cha-following_users" class="chapter" data-tralics-id="cid79" data-number="12" data-chapter="following_users">
<h1><a href="#cha-following_users" class="heading hyperref"><span class="number">第12章</span> ユーザーをフォローする</a></h1>
<p>この章では、他のユーザーをフォロー (およびフォロー解除) できるソーシャルレイヤーを追加し、各ユーザーのHomeページに、現在フォロー中のユーザーのステータスフィードを表示できるようにして、サンプルアプリケーションのコアを完成させます。まずは、ユーザー間の関係性をどうモデリングするかについて学びます (<a class="hyperref" href="#sec-the_relationship_model"><span class="ref">12.1</span></a>)。その後、 Aモデリング結果に対応するWebインターフェースを実装していきます (<a class="hyperref" href="#sec-a_web_interface_for_following_and_followers"><span class="ref">12.2</span></a>)。このとき、Webインターフェースの例としてAjaxについても紹介します。最後に、ステータスフィードの完成版を実装します (<a class="hyperref" href="#sec-the_status_feed"><span class="ref">12.3</span></a>)。</p>
<p>この最終章では、本書の中で最も難易度の高い手法をいくつか使用しています。その中には、ステータスフィード作成のためにRuby/SQLを「だます」テクニックも含まれます。この章の例全体にわたって、これまでよりも複雑なデータモデルを使用しています。ここで学んだデータモデルは、今後自分用のWebアプリケーションを開発するときに必ず役に立ちます。また、本書を卒業して実際の開発に携わるときのために、<a class="hyperref" href="#sec-following_conclusion"><span class="ref">12.4</span></a>で役立つリソース集 (読み物ガイド) についても紹介します。</p>
<p>この章で扱っている手法は本書全体の中で最も難易度が高いので、理解を助けるため、コードを書く前にはいったん立ち止まってインターフェイスを探検することにします。これまでの章と同様、最初にモックアップを示します<sup class="footnote" id="cha-12_footnote-ref-1"><a href="#cha-12_footnote-1">1</a></sup>。ページ操作の全体的なフローは次のようになります。あるユーザー (John Calvin) は自分のプロファイルページを最初に表示し (<a class="hyperref" href="#fig-page_flow_profile_mockup">図<span class="ref">12.1</span></a>)、フォローするユーザーを選択するためにUsersページ (<a class="hyperref" href="#fig-page_flow_user_index_mockup">図<span class="ref">12.2</span></a>) に移動します。Calvinは2番目のユーザーThomas Hobbes (<a class="hyperref" href="#fig-page_flow_other_profile_follow_button">図<span class="ref">12.3</span></a>) を表示し、[Follow] ボタンを押してフォローします。これにより、[Follow] ボタンが [Unfollow] に変わり、Hobbes の [followers] カウントが1人増えます (<a class="hyperref" href="#fig-page_flow_other_profile_unfollow_button_mockup">図<span class="ref">12.4</span></a>)。CalvinがHomeページに戻ると、[following] カウントが1人増え、Hobbesのマイクロポストがステータスフィードに表示されるようになっていることがわかります (<a class="hyperref" href="#fig-page_flow_home_page_feed_mockup">図<span class="ref">12.5</span></a>)。この節では、以後このフローの実現に専念します。</p>
<div class="center figure" id="fig-page_flow_profile_mockup" data-tralics-id="uid1285" data-number="12.1">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_profile_mockup_3rd_edition.png" alt="images/figures/page_flow_profile_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図12.1: </span><span class="description">現在のプロフィールページ
</span>
</div>
</div>
<div class="center figure" id="fig-page_flow_user_index_mockup" data-tralics-id="uid1286" data-number="12.2">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_user_index_mockup_bootstrap.png" alt="images/figures/page_flow_user_index_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図12.2</span> <span class="description">フォローする相手を見つける
</span>
</div>
</div>
<div class="center figure" id="fig-page_flow_other_profile_follow_button" data-tralics-id="uid1287" data-number="12.3">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_other_profile_follow_button_mockup_3rd_edition.png" alt="images/figures/page_flow_other_profile_follow_button_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図12.3</span> <span class="description">ユーザーのプロフィール画面に [Follow] ボタンが表示されている
</span>
</div>
</div>
<div class="center figure" id="fig-page_flow_other_profile_unfollow_button_mockup" data-tralics-id="uid1288" data-number="12.4">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_other_profile_unfollow_button_mockup_3rd_edition.png" alt="images/figures/page_flow_other_profile_unfollow_button_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図12.4</span> <span class="description">プロフィールに [Unfollow] ボタンが表示され、フォロワーのカウントが1つ増えた
</span>
</div>
</div>
<div class="center figure" id="fig-page_flow_home_page_feed_mockup" data-tralics-id="uid1289" data-number="12.5">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_home_page_feed_mockup_3rd_edition.png" alt="images/figures/page_flow_home_page_feed_mockup_3rd_edition"></div>
<div class="caption">
<span class="header">図12.5</span> <span class="description">Homeページにステータスフィードが表示され、フォローのカウントが1増えた
</span>
</div>
</div>
</div><div id="sec-the_relationship_model" class="section" data-tralics-id="cid80" data-number="12.1">
<h2><a href="#sec-the_relationship_model" class="heading hyperref"><span class="number">12.1</span> Relationshipモデル</a></h2>
<p>ユーザーをフォローする機能を実装する第一歩は、データモデルを構成することです。ただし、これは見た目ほど単純ではありません。素朴に考えれば、<code>has_many</code> (1対多) リレーションシップはこんな感じでできそうな気がします。1人のユーザーが複数のユーザーを<code>has_many</code>としてフォローし 、1人のユーザーに複数のフォロワーがいることを<code>has_many</code>で表す、という具合です。この後で説明しますが、この方法ではたちまち壁に突き当たってしまいます。これを解決するための<code>has_many through</code> (多対多の関係を表すのに使用) についてもこの後で説明します。</p>
<p>Gitユーザーはこれまで同様新しいトピックブランチを作成してください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b following-users
</pre></div></div>
<div id="sec-a_problem_with_the_data_model" class="subsection" data-tralics-id="uid1290" data-number="12.1.1">
<h3><a href="#sec-a_problem_with_the_data_model" class="heading hyperref"><span class="number">12.1.1</span> データモデルの問題 (および解決策)</a></h3>
<p>ユーザーをフォローするデータモデル構成のための第一歩として、典型的な場合を検討してみましょう。あるユーザーが、別のユーザーをフォローしているところを考えてみましょう。具体例を挙げると、CalvinはHobbesをフォローしています。これを逆から見れば、HobbesはCalvinからフォローされています。CalvinはHobbesから見れば<em>フォロワー (follower)</em>であり、HobbesはCalvinによって<em>フォローされている (followed) </em>ことになります。Railsにおけるデフォルトの複数形の慣習に従えば、あるユーザーをフォローしているすべてのユーザーの集合は<em>followers</em>となり、<code>user.followers</code>はそれらのユーザーの配列を表すことになります。残念なことに、この名前付けは逆についてはうまくいきません (Railsのというより英語の都合ですが)。フォローされているすべてのユーザーの集合は、このままでは<em>followeds</em>となってしまい、英語の文法からも外れるうえに非常に見苦しいものになってしまいます。そこで、今Twitterの慣習にならい、本チュートリアルでは<em>following</em>という呼称を採用します (例: “50 following, 75 followers”)。したがって、あるユーザーがフォローしているすべてのユーザーの集合は<code>calvin.following</code>となります。</p>
<p>これにより、<a class="hyperref" href="#fig-naive_user_has_many_following">図<span class="ref">12.6</span></a>のように<code>following</code>テーブルと <code>has_many</code>関連付けを使用して、フォローしているユーザーのモデリングができます。<code>user.following</code>はユーザーの集合でなければならないため、<code>following</code>テーブルのそれぞれの行は、<code>followed_id</code>で識別可能なユーザーでなければなりません (これは<code>follower_id</code>の関連付けについても同様です)<sup class="footnote" id="cha-12_footnote-ref-2"><a href="#cha-12_footnote-2">2</a></sup>。さらに、それぞれの行はユーザーなので、これらのユーザーに名前やパスワードなどの属性も追加する必要があるでしょう。</p>
<div class="center figure" id="fig-naive_user_has_many_following" data-tralics-id="uid1292" data-number="12.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/naive_user_has_many_following.png" alt="images/figures/naive_user_has_many_following"></div>
<div class="caption">
<span class="header">図12.6</span> <span class="description">フォローしているユーザーの素朴な実装例
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-naive_user_has_many_following">図<span class="ref">12.6</span></a>のデータモデルの問題点は、非常に無駄が多いことです。各行には、フォローしているユーザーのidのみならず、名前やメールアドレスまであります。これらはいずれも<em>users</em>テーブルに<code>既にある</code>ものばかりです。さらによくないことに、<em>フォロワー (followers) </em>の方をモデリングするときにも、同じぐらい無駄の多い<code>followers</code>テーブルを別に作成しなければならなくなってしまいます。結論としては、このデータモデルはメンテナンスの観点から見て悪夢です。ユーザー名を変更するたびに、<code>users</code>テーブルのそのレコードだけでなく、<code>following</code>テーブルと<code>followers</code>テーブルの両方について、<em>そのユーザーを含むすべての行</em>を更新しなければならなくなります。</p>
<p>この問題の根本は、必要な抽象化を行なっていないことです。正しいモデルを見つけ出す方法の1つは、Webアプリケーションにおける<em>following</em>の動作をどのように実装するかをじっくり考えることです。<a class="hyperref" href="sign_up?version=4.2#sec-a_users_resource"><span class="ref">7.1.2</span></a>において、RESTアーキテクチャは、作成されたり削除されたりする<em>リソース</em>に関連していたことを思い出してください。ここから、2つの疑問が生じます。1. あるユーザーが別のユーザーをフォローするとき、何が作成されるのでしょうか。2. あるユーザーが別のユーザーをフォロー<em>解除</em>するとき、何が削除されるのでしょうか。この点を踏まえて考えると、この場合アプリケーションによって作成または削除されるのは、つまるところ2人のユーザーの「<em>関係 (リレーションシップ)</em>」であることがわかります。つまり、1人のユーザーは1対多の関係を持つことができ、さらにユーザーはリレーションシップ<em>を経由して</em>多くの<code>following</code> (または<code>followers</code>) と関係を持つことができるということです。</p>
<p>このデータモデルには他にも解決しなくてはいけない問題があります。Facebookのような友好関係 (Friendships) では本質的に左右対称のデータモデルが成り立ちますが、Twitterのようなフォロー関係では<em>左右非対称</em>の性質があります。すなわち、CalvinはHobbesをフォローしていても、HobbesはCalvinをフォローしていないといった関係性が成り立つのです。このような左右非対称な関係性を見分けるために、それぞれを<em>能動的関係 (Active Relationship)</em>と<em>受動的関係 (Passive Relationship)</em>と呼ぶことにします。たとえば先ほどの事例のような、CalvinがHobbesをフォローしているが、HobbesはCalvinをフォローしていない場合では、CalvinはHobbesに対して「能動的関係」を持っていることになります。逆に、HobbesはCalvinに対して「受動的関係」を持っていることになります<sup class="footnote" id="cha-12_footnote-ref-3"><a href="#cha-12_footnote-3">3</a></sup>。</p>
<p>まずは、フォローしているユーザーを生成するために、能動的関係に焦点を当てていきます (受動的関係については<a class="hyperref" href="#sec-followers"><span class="ref">12.1.5</span></a>で考えていきます)。先ほどの<a class="hyperref" href="#fig-naive_user_has_many_following">図<span class="ref">12.6</span></a>は実装のヒントになりました。フォローしているユーザーは<code>followed_id</code>があれば識別することができるので、先ほどの<code>following</code>テーブルを<code>active_relationships</code>テーブルと見立ててみましょう。ただしユーザー情報は無駄なので、ユーザーid以外の情報は削除します。そして、<code>followed_id</code>をとおして、<code>users</code>テーブルのフォローされているユーザーを見つけるようにします。このデータモデルの模式図にすると、<a class="hyperref" href="#fig-user_has_many_following">図<span class="ref">12.7</span></a>のようになります。</p>
<div class="center figure" id="fig-user_has_many_following" data-tralics-id="uid1294" data-number="12.7">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_has_many_following_3rd_edition.png" alt="images/figures/user_has_many_following_3rd_edition"></div>
<div class="caption">
<span class="header">図12.7</span> <span class="description">能動的関係をとおしてフォローしているユーザーを取得する模式図
</span>
</div>
</div>
<p>能動的関係も受動的関係も、最終的にはデータベースの同じテーブルを使うことになります。したがって、テーブル名にはこの「関係」を表す「<em>relationship</em>」を使いましょう。モデル名も同様にして、Relationshipモデルとします。作成したRelationshipデータモデルを<a class="hyperref" href="#fig-relationship_model">図<span class="ref">12.8</span></a>に示します。1つのrelationshipテーブルを使って2つのモデル (能動的関係と受動的関係) をシミュレートする方法については、<a class="hyperref" href="#sec-following"><span class="ref">12.1.4</span></a>で説明します。</p>
<div class="center figure" id="fig-relationship_model" data-tralics-id="uid1295" data-number="12.8">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/relationship_model.png" alt="images/figures/relationship_model"></div>
<div class="caption">
<span class="header">図12.8</span> <span class="description">Relationshipデータモデル
</span>
</div>
</div>
<p>このデータモデルを実装するために、まずは次のように<a class="hyperref" href="#fig-relationship_model">図<span class="ref">12.8</span></a>に対応したマイグレーションを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div></div>
<p>このリレーションシップは今後<code>follower_id</code>と<code>followed_id</code>で頻繁に検索することになるので、<a class="hyperref" href="#code-relationships_migration">リスト<span class="ref">12.1</span></a>に示したように、それぞれのカラムにインデックスを追加します。</p>
<div class="codelisting" id="code-relationships_migration" data-tralics-id="uid1296" data-number="12.1">
<div class="heading">
<span class="number">リスト12.1:</span> 

<span class="description"><code>relationships</code>テーブルにインデックスを追加する<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_relationships.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
</span><span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
</span><span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-relationships_migration">リスト<span class="ref">12.1</span></a>では複合キーインデックスという行もあることに注目してください。これは、<code>follower_id</code>と<code>followed_id</code>の組み合わせが必ずユニークであることを保証する仕組みです。これにより、あるユーザーが同じユーザーを2回以上フォローすることを防ぎます。(<a class="hyperref" href="modeling_users?version=4.2#code-email_uniqueness_index">リスト<span class="ref">6.28</span></a>でメールアドレスの一意性を保証したり、<a class="hyperref" href="user_microposts?version=4.2#code-micropost_migration">リスト<span class="ref">11.1</span></a>で使った複合キーインデックスと比較してみてください。) もちろん、このような重複 (2回以上フォローすること) が起きないよう、インターフェイス側の実装でも注意を払います(<a class="hyperref" href="#sec-following"><span class="ref">12.1.4</span></a>)。しかし、ユーザーが何らかの方法で (たとえば<code>curl</code>などのコマンドラインツールを使用して) Relationshipのデータを操作するようなことも起こり得ます。そのような場合でも、一意なインデックスを追加していれば、エラーを発生させて重複を防ぐことができます。</p>
<p><code>relationships</code>テーブルを作成するために、いつものようにデータベースのマイグレーションを行います。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
</div>
<div id="sec-relationship_user_associations" class="subsection" data-tralics-id="uid1297" data-number="12.1.2">
<h3><a href="#sec-relationship_user_associations" class="heading hyperref"><span class="number">12.1.2</span> User/Relationshipの関連付け</a></h3>
<p>フォローしているユーザーとフォロワーを実装する前に、UserとRelationshipの関連付けを行います。1人のユーザーには<code>has_many</code> (1対多) のリレーションシップがあり、このリレーションシップは<em>2人</em>のユーザーの間の関係なので、フォローしているユーザーとフォロワーの両方に属します (<code>belongs_to</code>)。</p>
<p><a class="hyperref" href="user_microposts?version=4.2#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>のマイクロポストのときと同様、以下のようなユーザー関連付けのコードを使用して新しいリレーションシップを作成します。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">この時点で、アプリケーションコードは<a class="hyperref" href="user_microposts?version=4.2#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>のようになるのではないかと予測した方もいるかもしれません。実際似ているのですが、2つの大きな違いがあります。</p>
<p>まずは1つ目の違いについてです。以前、ユーザーとマイクロポストの関連付けをしたときは、次のように書きました。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">引数の<code>:microposts</code>シンボルから、Railsはこれに対応するMicropostモデルを探し出し、見つけることができました<sup class="footnote" id="cha-12_footnote-ref-4"><a href="#cha-12_footnote-4">4</a></sup>。しかし今回のケースで同じように書くと、</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:active_relationships</span>
</pre></div></div>
<p class="noindent">となってしまい、(ActiveRelationshipモデルを探してしまい) Relationshipモデルを見つけることができません。このため、今回のケースでは、Railsに探して欲しいモデルのクラス名を明示的に伝える必要があります。</p>
<p>2つ目の違いは、先ほどの逆のケースについてです。以前はMicropostモデルで</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">このように書きました。<code>microposts</code>テーブルには<code>user_id</code>属性があるので、これを辿って対応する所有者 (ユーザー) を特定することができました (<a class="hyperref" href="user_microposts?version=4.2#sec-the_basic_model"><span class="ref">11.1.1</span></a>)。データベースの2つのテーブルを繋ぐとき、このようなidは<em>外部キー (foreign key)</em>と呼びます。すなわち、Userモデルに繋げる外部キーが、Micropostモデルの<code>user_id</code>属性ということです。この外部キーの名前を使って、Railsは関連付けの推測をしています。具体的には、Railsはデフォルトでは外部キーの名前を<code>&lt;class&gt;_id</code>といったパターンとして理解し、 <code>&lt;class&gt;</code>に当たる部分からクラス名 (正確には小文字に変換されたクラス名) を推測します<sup class="footnote" id="cha-12_footnote-ref-5"><a href="#cha-12_footnote-5">5</a></sup>。ただし、先ほどはユーザーを例として扱いましたが、今回のケースではフォローしているユーザーを<code>follower_id</code>という外部キーを使って特定しなくてはなりません。また、followerというクラス名は存在しないので、ここでもRailsに正しいクラス名を伝える必要が発生します。</p>
<p>先ほどの説明をコードにまとめると、UserとRelationshipの関連付けは<a class="hyperref" href="#code-user_relationships_association">リスト<span class="ref">12.2</span></a>と<a class="hyperref" href="#code-relationship_belongs_to">リスト<span class="ref">12.3</span></a>のようになります。</p>
<div class="codelisting" id="code-user_relationships_association" data-tralics-id="uid1300" data-number="12.2">
<div class="heading">
<span class="number">リスト12.2:</span> 

<span class="description">能動的関係に対して1対多 (<code>has_many</code>) の関連付けを実装する <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">(ユーザーを削除したら、ユーザーのリレーションシップも同時に削除される必要があります。そのため、関連付けに<code>dependent: :destroy</code>も追加しています。)</p>
<div class="codelisting" id="code-relationship_belongs_to" data-tralics-id="uid1301" data-number="12.3">
<div class="heading">
<span class="number">リスト12.3:</span> 

<span class="description">リレーションシップ/フォロワーに対して<code>belongs_to</code>の関連付けを追加する<span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
</span><span class="hll">  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">なお、<code>follower</code>の関連付けについては、<a class="hyperref" href="#sec-followers"><span class="ref">12.1.5</span></a>に入るまでは使いません。しかしfollowerとfollowedを対称的に実装しておくことで、構造に対する理解は容易になるはずです。</p>
<p><a class="hyperref" href="#code-user_relationships_association">リスト<span class="ref">12.2</span></a>と<a class="hyperref" href="#code-relationship_belongs_to">リスト<span class="ref">12.3</span></a>で定義した関連付けにより、<a class="hyperref" href="user_microposts?version=4.2#table-association_methods">表<span class="ref">11.1</span></a>で以前紹介したような多くのメソッドが使えるようになりました。今回使えるようになったメソッドを<a class="hyperref" href="#table-association_methods_relationships">表<span class="ref">12.1</span></a>に示します。</p>
<div class="table" id="table-association_methods_relationships" data-tralics-id="uid1302" data-number="12.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>メソッド</strong></td>
<td class="align_left"><strong>用途</strong></td>
</tr>
<tr>
<td class="align_left"><code>active_relationship.follower</code></td>
<td class="align_left">フォロワーを返します</td>
</tr>
<tr>
<td class="align_left"><code>active_relationship.followed</code></td>
<td class="align_left">フォローしているユーザーを返します</td>
</tr>
<tr>
<td class="align_left"><code>user.active_relationships.create(followed_id: user.id)</code></td>
<td class="align_left">
<code>user</code>を紐付けて能動的関係を作成/登録する
</td>
</tr>
<tr>
<td class="align_left"><code>user.active_relationships.create!(followed_id: user.id)</code></td>
<td class="align_left">
<code>user</code>を紐付けて能動的関係を作成/登録する (失敗時にエラーを出力)</td>
</tr>
<tr>
<td class="align_left"><code>user.active_relationships.build(followed_id: user.id)</code></td>
<td class="align_left">
<code>user</code>と紐付けた新しいRelationshipオブジェクトを返す
</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表12.1</span> <span class="description">ユーザーと能動的関係の関連付けによって使えるようになったメソッドのまとめ (
</span>
</div>
</div>
</div>
<div id="sec-relationship_validations" class="subsection" data-tralics-id="uid1303" data-number="12.1.3">
<h3><a href="#sec-relationship_validations" class="heading hyperref"><span class="number">12.1.3 </span>Relationshipのバリデーション</a></h3>
<p>先に進む前に、Relationshipモデルの検証を追加して完全なものにしておきましょう。テスト (<a class="hyperref" href="#code-relationship_validation_tests">リスト<span class="ref">12.4</span></a>)とアプリケーションコード (<a class="hyperref" href="#code-relationship_validations">リスト<span class="ref">12.5</span></a>) は素直な作りです。ただし、ユーザー用のfixtureファイル (<a class="hyperref" href="modeling_users?version=4.2#code-default_fixtures">リスト<span class="ref">6.29</span></a>) と同じように、生成されたリレーションシップ用のfixtureでは、マイグレーション (<a class="hyperref" href="#code-relationships_migration">リスト<span class="ref">12.1</span></a>) で制約させた一意性を満たすことができません。ということで、ユーザーのときと同じで (<a class="hyperref" href="modeling_users?version=4.2#code-empty_fixtures">リスト<span class="ref">6.30</span></a>でfixtureの内容を削除したように)、今の時点では生成されたリレーションシップ用のfixtureファイルも空にしておきましょう (<a class="hyperref" href="#code-empty_relationship_fixture">リスト<span class="ref">12.6</span></a>)。</p>
<div class="codelisting" id="code-relationship_validation_tests" data-tralics-id="uid1304" data-number="12.4">
<div class="heading">
<span class="number">Listing 12.4:</span> 

<span class="description">Relationshipモデルのバリデーションをテストする<span class="break"></span> <span class="filepath">test/models/relationship_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@relationship</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">follower_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a follower_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a followed_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-relationship_validations" data-tralics-id="uid1305" data-number="12.5">
<div class="heading">
<span class="number">リスト12.5:</span> 

<span class="description">Relationshipモデルに対してバリデーションを追加する<span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="hll">  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-empty_relationship_fixture" data-tralics-id="uid1306" data-number="12.6">
<div class="heading">
<span class="number">リスト12.6:</span> 

<span class="description">Relationship用のfixtureを空にする<span class="break"></span> <span class="filepath">test/fixtures/relationships.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># empty</span>
</pre></div></div>
</div>
<p>これにより、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1307" data-tralics-id="uid1307" data-number="12.7">
<div class="heading">
<span class="number">リスト12.7:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-following" class="subsection" data-tralics-id="uid1308" data-number="12.1.4">
<h3><a href="#sec-following" class="heading hyperref"><span class="number">12.1.4</span> フォローしているユーザー</a></h3>
<p>いよいよRelationshipの関連付けの核心、<code>following</code>と<code>followers</code>に取りかかります。今回は<code>has_many through</code>を使用します。<a class="hyperref" href="#fig-user_has_many_following">図<span class="ref">11.7</span></a>のように、1人のユーザーにはいくつもの「フォロー<em>する/される</em> (多対多)」のリレーションシップがあります。デフォルトの<code>has_many through</code>という関連付けでは、Railsはモデル名(単数形)に対応する外部キーを探します。つまり、次のコードでは、</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span>
</pre></div></div>
<p class="noindent">Railsは“followeds”というシンボル名を見て、これを“followed”という単数形の変え、 <code>relationships</code>テーブルの<code>followed_id</code>を使って対象のユーザーを取得してきます。しかし、<a class="hyperref" href="#sec-a_problem_with_the_data_model"><span class="ref">12.1.1</span></a>で指摘したように、<code>user.followeds</code>という名前は英語として不適切です。代わりに、<code>user.following</code>という名前を使いましょう。そのためには、Railsのデフォルトを上書きする必要があります。ここでは<code>:source</code>パラメーター (<a class="hyperref" href="#code-has_many_following_through_active_relationships">リスト<span class="ref">12.10</span></a>) を使用し、「<code>following</code>配列の元は<code>followed</code> idの集合である」ということを明示的にRailsに伝えます。</p>
<div class="codelisting" id="code-has_many_following_through_active_relationships" data-tralics-id="uid1309" data-number="12.8">
<div class="heading">
<span class="number">リスト12.8:</span> 

<span class="description">Userモデルに<code>following</code>の関連付けを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                  <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
                                  <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p> <a class="hyperref" href="#code-has_many_following_through_active_relationships">リスト<span class="ref">12.8</span></a>で定義した関連付けにより、フォローしているユーザーを配列の様に扱えるようになりました。たとえば、<code>include?</code>メソッド (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-arrays_and_ranges"><span class="ref">4.3.1</span></a>) を使ってフォローしているユーザーの集合を調べてみたり、関連付けを通してオブジェクトを探しだせるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</pre></div></div>
<p><code>following</code>メソッドで配列のように扱えるだけでも便利ですが、Railsは単純な配列ではなく、もっと賢くこの集合を扱っています。たとえば、次のようなコードでは</p>
<div class="code"><div class="highlight"><pre><span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">フォローしている全てのユーザーをデータベースから取得し、その集合に対して<code>include?</code>メソッドを実行しているように見えますが、しかし実際にはデータベースの中で直接比較をするように配慮しています。(<a class="hyperref" href="user_microposts?version=4.2#sec-rendering_microposts"><span class="ref">11.2.1</span></a>でも説明したように、次のようなコードは</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p class="noindent">データベースの中で合計を計算したほうが高速になることを思い出してください。)</p>
<p>次に、followingで取得した集合をより簡単に取り扱うために、<code>follow</code>や<code>unfollow</code>といった便利メソッドを追加しましょう。これらのメソッドは、たとえば<code>user.follow(other_user)</code>といった具合に使います。さらに、これに関連する<code>following?</code>論理値メソッドも追加し、あるユーザーが誰かをフォローしているかどうかを確認できるようにします<sup class="footnote" id="cha-12_footnote-ref-6"><a href="#cha-12_footnote-6">6</a></sup>。</p>
<p>今回は、こういったメソッドはテストから先に書いていきます。というのも、Webインターフェイスなどで便利メソッドを使うのはまだ先なので、すぐに<em>使える場面</em>がなく、実装した手応えを得にくいからです。一方で、Userモデルに対するテストを書くのは簡単かつ今すぐできます。そのテストの中で、これらのメソッドを使っていきます。具体的には、<code>following?</code>メソッドであるユーザーをまだフォローしていないことを確認、<code>follow</code>メソッドを使ってそのユーザーをフォロー、  <code>following?</code>メソッドを使ってフォロー中になったことを確認、 最後に<code>unfollow</code>メソッドでフォロー解除できたことを確認、といった具合でテストをしてきます。このテストをコードにすると、<a class="hyperref" href="#code-utility_method_tests">リスト<span class="ref">12.9</span></a>のようになります。</p>
<div class="codelisting" id="code-utility_method_tests" data-tralics-id="uid1311" data-number="12.9">
<div class="heading">
<span class="number">リスト12.9:</span> 

<span class="description">“following” 関連のメソッドをテストする RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
<span class="hll">    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
</span><span class="hll">    <span class="n">michael</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
</span><span class="hll">    <span class="n">michael</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#table-association_methods_relationships">表<span class="ref">12.1</span></a>のメソッドを参考にしながら、<code>following</code>による関連付けを使って<code>follow</code>、<code>unfollow</code>、<code>following?</code>メソッドを実装していきましょう (<a class="hyperref" href="#code-follow_unfollow_following">リスト<span class="ref">12.10</span></a>)。このとき、可能な限り<code>self</code> (user自身を表すオブジェクト) を省略している点に注目してください。</p>
<div class="codelisting" id="code-follow_unfollow_following" data-tralics-id="uid1312" data-number="12.10">
<div class="heading">
<span class="number">リスト12.10:</span> 

<span class="description">"following" 関連のメソッド GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーをフォローする</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">active_relationships</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># ユーザーをアンフォローする</span>
  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</span>  <span class="k">end</span>

  <span class="c1"># 現在のユーザーがフォローしてたらtrueを返す</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-follow_unfollow_following">リスト<span class="ref">12.10</span></a>のコードを追加することで、テストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1313" data-tralics-id="uid1313" data-number="12.11">
<div class="heading">
<span class="number">リスト12.11:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-followers" class="subsection" data-tralics-id="uid1314" data-number="12.1.5">
<h3><a href="#sec-followers" class="heading hyperref"><span class="number">12.1.5</span> フォロワー</a></h3>
<p>リレーションシップというパズルの最後の一片は、<code>user.followers</code>メソッドを追加することです。これは上の<code>user.following</code>メソッドと対になります。<a class="hyperref" href="#fig-user_has_many_following">図<span class="ref">12.7</span></a>を見ていて気付いた方もいると思いますが、フォロワーの配列を展開するために必要な情報は、<code>relationships</code>テーブルに既にあります (<a class="hyperref" href="#code-user_relationships_association">リスト<span class="ref">12.2</span></a>コードをとおして<code>active_relationships</code>テーブルを扱っています)。実は、<code>follower_id</code>と<code>followed_id</code>を入れ替えるだけで、フォロワーについてもユーザーのフォローのときとまったく同じ方法が使用できます。これは<code>passive_relationships</code>と<code>active_relationships</code>についても同じです。したがって、データモデルは<a class="hyperref" href="#fig-user_has_many_followers">図<span class="ref">12.9</span></a>のようになります。</p>
<div class="center figure" id="fig-user_has_many_followers" data-tralics-id="uid1315" data-number="12.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_has_many_followers_3rd_edition.png" alt="images/figures/user_has_many_followers_3rd_edition"></div>
<div class="caption">
<span class="header">図12.9</span> <span class="description">Relationshipモデルのカラムを入れ替えて作った、フォロワーのモデル
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-user_has_many_followers">図<span class="ref">12.9</span></a>を参考にしたデータモデルの実装を<a class="hyperref" href="#code-has_many_following_through_passive_relationships">リスト<span class="ref">12.12</span></a>に示しますが、この実装は<a class="hyperref" href="#code-has_many_following_through_active_relationships">リスト<span class="ref">12.8</span></a>とまさに類似しています。</p>
<div class="codelisting" id="code-has_many_following_through_passive_relationships" data-tralics-id="uid1316" data-number="12.12">
<div class="heading">
<span class="number">リスト12.12:</span> 

<span class="description">受動的関係を使って<code>user.followers</code>を実装する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                   <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
</span><span class="hll">                                   <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
</span><span class="hll">                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
</span>  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:follower</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>一点、<a class="hyperref" href="#code-has_many_following_through_passive_relationships">リスト<span class="ref">12.12</span></a>で注意すべき箇所は、次のように参照先 (<code>followers</code>) を指定するための<code>:source</code>キーを省略してもよかったという点です。</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:passive_relationships</span>
</pre></div></div>
<p class="noindent">これは<code>:followers</code>属性の場合、Railsが “followers” を単数形にして自動的に外部キー<code>follower_id</code>を探してくれるからです。<a class="hyperref" href="#code-has_many_following_through_active_relationships">リスト<span class="ref">12.8</span></a>と違って必要のない<code>:source</code>キーをそのまま残しているのは、<code>has_many :following</code>との類似性を強調させるためです。</p>
<p>次に、<code>followers.include?</code>メソッドを使って先ほどのデータモデルをテストしていきます。テストコードは<a class="hyperref" href="#code-followers_test">リスト<span class="ref">12.13</span></a>のとおりです。(<a class="hyperref" href="#code-followers_test">リスト<span class="ref">12.13</span></a>では、<code>following?</code>と対照的な<code>followed_by?</code>メソッドを使ってもよかったのですが、サンプルアプリケーションで実際に使う場面がなかったので省略しました。)</p>
<div class="codelisting" id="code-followers_test" data-tralics-id="uid1317" data-number="12.13">
<div class="heading">
<span class="number">リスト12.13:</span> 

<span class="description"><code>followers</code>に対するテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>   <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
<span class="hll">    <span class="n">assert</span> <span class="n">archer</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">michael</span><span class="p">)</span>
</span>    <span class="n">michael</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-followers_test">リスト<span class="ref">12.13</span></a>では<a class="hyperref" href="#code-utility_method_tests">リスト<span class="ref">12.9</span></a>に1行だけ追加していますが、実際には多くの処理が正しく動いていなければパスしません。つまり、<a class="hyperref" href="#code-has_many_following_through_passive_relationships">リスト<span class="ref">12.12</span></a>の実装に対するテストは、実装の影響を受けやすいテストだといえます。</p>
<p>この時点で、全てのテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div><div id="sec-a_web_interface_for_following_and_followers" class="section" data-tralics-id="cid81" data-number="12.2">
<h2><a href="#sec-a_web_interface_for_following_and_followers" class="heading hyperref"><span class="number">12.2</span> フォローしているユーザー用のWebインターフェイス</a></h2>
<p><a class="hyperref" href="#sec-the_relationship_model"><span class="ref">12.1</span></a>ではやや複雑なデータモデリングの技術を説明しました。理解するのに時間がかかってしまっても大丈夫なので、安心してください。実際、使用されたさまざまな関連付けを理解するのに一番良いのは、Webインターフェイスで使用してみることです。</p>
<p>この章の最初に、フォローしているユーザーのページ表示の流れについて説明しました。この節では、モックアップで示したようにフォロー/フォロー解除の基本的なインターフェイスを実装します。また、フォローしているユーザーと、フォロワーにそれぞれ表示用のページを作成します。<a class="hyperref" href="#sec-the_status_feed"><span class="ref">12.3</span></a>では、ユーザーのステータスフィードを追加して、サンプルアプリケーションを完成させます。</p>
<div id="sec-sample_following_data" class="subsection" data-tralics-id="uid1318" data-number="12.2.1">
<h3><a href="#sec-sample_following_data" class="heading hyperref"><span class="number">12.2.1</span> フォローしているユーザーのサンプルデータ</a></h3>
<p>1つ前の章のときと同じように、サンプルデータを自動作成するRakeタスクを使用して、データベースに実際のデータを登録するのがやはり便利です。先にサンプルデータを自動作成しておけば、Webページの見た目のデザインから先にとりかかることができ、バックエンドの機能の実装をこの節の後に回すことができます。</p>
<p><a class="hyperref" href="#code-sample_relationships">リスト<span class="ref">12.14</span></a>は、リレーションシップのサンプルデータを生成するためのコードですここでは、最初のユーザーにユーザー3からユーザー51までをフォローさせ、それから逆にユーザー4からユーザー41に最初のユーザーをフォローさせます。ソースを見るとわかるように、このような設定を自由に行うことができます。こうしてリレーションシップを作成しておけば、アプリケーションのインターフェイスを開発するには十分です。</p>
<div class="codelisting" id="code-sample_relationships" data-tralics-id="uid1319" data-number="12.14">
<div class="heading">
<span class="number">リスト12.14:</span> 

<span class="description">サンプルデータにfollowing/followerの関係性を追加する<span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># ユーザー</span>
<span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">admin</span><span class="p">:</span>     <span class="kp">true</span><span class="p">,</span>
             <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
             <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
              <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
              <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
              <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
              <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># マイクロポスト</span>
<span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="hll"><span class="c1"># リレーションシップ</span>
</span><span class="hll"><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span><span class="hll"><span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll"><span class="n">following</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
</span><span class="hll"><span class="n">followers</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
</span><span class="hll"><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
</span><span class="hll"><span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</span></pre></div></div>
</div>
<p><a class="hyperref" href="#code-sample_relationships">リスト<span class="ref">12.14</span></a>を実行してデータベース上のサンプルデータを作り直すために、いつものコマンドを実行しましょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
$ bundle exec rake db:seed
</pre></div></div>
</div>
<div id="sec-stats_and_a_follow_form" class="subsection" data-tralics-id="uid1320" data-number="12.2.2">
<h3><a href="#sec-stats_and_a_follow_form" class="heading hyperref"><span class="number">12.2.2</span> 統計とフォロー用フォーム</a></h3>
<p>これでサンプルユーザーに、フォローしているユーザーとフォロワーができました。ユーザープロファイルページとHomeページを更新してこれを反映しましょう。最初に、プロファイルページとHomeページに、フォローしているユーザーとフォロワーの統計情報を表示するためのパーシャルを作成します。次に、フォロー用とフォロー解除用のフォームを作成します。それから、フォローしているユーザーの一覧 ("following") とフォロワーの一覧 ("followers") を表示する専用のページを作成します。</p>
<p><a class="hyperref" href="#sec-a_problem_with_the_data_model"><span class="ref">12.1.1</span></a>で指摘したように、Twitterの慣習にしたがってフォロー数の単位には“following”を使い、たとえば“50 following”といった具合に表示します。この単位は<a class="hyperref" href="#fig-page_flow_profile_mockup">図<span class="ref">12.1</span></a>のモックアップの一部でも既に使われていました。該当箇所を拡大して<a class="hyperref" href="#fig-stats_partial_mockup">図<span class="ref">12.10</span></a>に再掲します。</p>
<div class="center figure" id="fig-stats_partial_mockup" data-tralics-id="uid1321" data-number="12.10">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/stats_partial_mockup.png" alt="stats_partial_mockup"></span>
<div class="caption">
<span class="header">図12.10</span> <span class="description">統計情報パーシャルのモックアップ
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-stats_partial_mockup">図<span class="ref">12.10</span></a>の統計情報には、現在のユーザーがフォローしている人数と、現在のフォロワーの人数が表示されています。それぞれの表示はリンクになっており、専用の表示ページに移動できます。<a class="hyperref" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="ref">第5章</span></a>では、これらのリンクはダミーテキスト<code>’#’</code>を使用して無効にしていました。しかしルーティングについての知識もだいぶ増えてきたので、今回は実装することにしましょう。実際のページ作成は<a class="hyperref" href="#sec-following_and_followers_pages"><span class="ref">12.2.3</span></a>まで行いませんが、ルーティングは今実装します (<a class="hyperref" href="#code-following_followers_actions_routes">リスト<span class="ref">12.15</span></a>)。このコードでは、<code>resources</code><em>ブロック</em>の内側で<code>:member</code>メソッドを使用しています。これは初登場ですので、どんな動作をするのか推測してみてください。 </p>
<div class="codelisting" id="code-following_followers_actions_routes" data-tralics-id="uid1322" data-number="12.15">
<div class="heading">
<span class="number">リスト12.15:</span> 

<span class="description">Usersコントローラに<code>following</code>アクションと<code>followers</code>アクションを追加する<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">member</span> <span class="k">do</span>
</span><span class="hll">      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>この場合のURLは/users/1/followingや/users/1/followersのようになるのではないかと推測した方もいると思います。そして、<a class="hyperref" href="#code-following_followers_actions_routes">リスト<span class="ref">12.15</span></a>のコードはまさにそれを行なっているのです。また、どちらもデータを<em>表示する</em>ページなので、適切なHTTPメソッドは<span class="tt">GET</span>リクエストになります。したがって、<code>get</code>メソッドを使って適切なレスポンスを返すようにします。ちなみに、<code>member</code>メソッドを使うとユーザーidが含まれているURLを扱うようになりますが、idを指定せずにすべてのメンバーを表示するには、以下のように<code>collection</code>メソッドを使用します。</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">このコードは/users/tigersというURLに応答します (アプリケーションにあるすべてのtigerのリストを表示します)<sup class="footnote" id="cha-12_footnote-ref-7"><a href="#cha-12_footnote-7">7</a></sup>。</p>
<p><a class="hyperref" href="#code-following_followers_actions_routes">リスト<span class="ref">12.15</span></a>によって生成されるルーティングテーブルを<a class="hyperref" href="#table-following_routes">表<span class="ref">12.2</span></a>に示します。ここにある、フォローしているユーザー用とフォロワー用の名前付きルートをこの後使用します。</p>
<div class="table" id="table-following_routes" data-tralics-id="uid1324" data-number="12.2">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>HTTPリクエスト</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>アクション</strong></td>
<td class="align_left"><strong>名前付きルート</strong></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/following</td>
<td class="align_left"><code>following</code></td>
<td class="align_left"><code>following_user_path(1)</code></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/followers</td>
<td class="align_left"><code>followers</code></td>
<td class="align_left"><code>followers_user_path(1)</code></td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表12.2</span> <span class="description">カスタムルールで提供する<a class="hyperref" href="#code-following_followers_actions_routes">リスト<span class="ref">12.15</span></a>のRESTfulルート
</span>
</div>
</div>
<p>ルーティングを定義したので、統計情報のパーシャルを実装する準備が整いました。このパーシャルでは、divタグの中に2つのリンクを含めるようにします (<a class="hyperref" href="#code-stats_partial">リスト<span class="ref">12.16</span></a>)。</p>
<div class="codelisting" id="code-stats_partial" data-tralics-id="uid1325" data-number="12.16">
<div class="heading">
<span class="number">リスト12.16:</span> 

<span class="description">フォロワーの統計情報を表示するパーシャル<span class="break"></span> <span class="filepath">app/views/shared/_stats.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"followers"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p>このパーシャルはユーザー表示ページとHomeページの両方に表示されるので、<a class="hyperref" href="#code-stats_partial">リスト<span class="ref">12.16</span></a>の最初の行では、以下のコードを使用して適切な方を選択しています。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="log_in_log_out?version=4.2#aside-or_equals">コラム<span class="ref">8.1</span></a>でも説明したとおり、<code>@user</code>が <code>nil</code>でない場合 (つまりプロファイルページの場合) は何もせず、nilの場合 (つまりHomeページの場合) には<code>@user</code>にカレントユーザーを設定します。フォローしているユーザーの人数と、フォロワーの人数は、以下の関連付けを使用して計算されます。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p class="noindent">さらに、以下のコードは</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="user_microposts?version=4.2#code-user_show_microposts">リスト<span class="ref">11.23</span></a>のマイクロポストのコードと比較してみましょう。あのときは次のように書きました。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p class="noindent">このコードを使用してマイクロポストの合計数を表示します。(以前同様、高速化のためにRailsはデータベースの中で合計を計算するようにしています。)</p>
<p>一部の要素で、以下のようにCSS idを指定していることにもぜひ注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div></div>
<p class="noindent">こうしておくと、<a class="hyperref" href="#sec-a_working_follow_button_with_ajax"><span class="ref">12.2.5</span></a>でAjaxを実装するときに便利です。そこでは、一意のidを指定してページ要素にアクセスしています。</p>
<p>統計情報パーシャルができあがりました。Homeページにこの統計情報を表示するのは、<a class="hyperref" href="#code-home_page_stats">リスト<span class="ref">12.17</span></a>のように簡単にできます。</p>
<div class="codelisting" id="code-home_page_stats" data-tralics-id="uid1326" data-number="12.17">
<div class="heading">
<span class="number">リスト12.17:</span> 

<span class="description">Homeページにフォロワーの統計情報を追加する<span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
<span class="hll">      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/section&gt;</span>
</span>      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"micropost_form"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p>統計情報にスタイルを与えるために、<a class="hyperref" href="#code-stats_css">リスト<span class="ref">12.18</span></a>のようにSCSSを追加しましょう (なお、このSCSSにはこの章で使用するスタイルがすべて含まれています)。変更の結果、Homeページは<a class="hyperref" href="#fig-home_page_follow_stats">図<span class="ref">12.11</span></a>のようになります。</p>
<div class="codelisting" id="code-stats_css" data-tralics-id="uid1327" data-number="12.18">
<div class="heading">
<span class="number">リスト12.18:</span> 

<span class="description">Homeページのサイドバー用のSCSS<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.gravatar_edit</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.stats</span> <span class="p">{</span>
</span>  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$gray-lighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.user_avatars</span> <span class="p">{</span>
</span>  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.users.follow</span> <span class="p">{</span>
</span>  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forms */</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-home_page_follow_stats" data-tralics-id="uid1328" data-number="12.11">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_page_follow_stats_3rd_edition.png" alt="images/figures/home_page_follow_stats_3rd_edition"></div>
<div class="caption">
<span class="header">図12.11</span> <span class="description">Homeページにフォロー関連の統計情報を表示する
</span>
</div>
</div>
<p>この後すぐ、プロファイルにも統計情報パーシャルを表示しますが、今のうちに<a class="hyperref" href="#code-follow_form_partial">リスト<span class="ref">11.23</span></a>のようにフォロー/フォロー解除ボタン用のパーシャルも作成しましょう。</p>
<div class="codelisting" id="code-follow_form_partial" data-tralics-id="uid1329" data-number="12.19">
<div class="heading">
<span class="number">リスト12.19:</span> 

<span class="description">follow/unfollowフォームのパーシャル <span class="break"></span> <span class="filepath">app/views/users/_follow_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"follow_form"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'unfollow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">このコードは、<code>follow</code>と<code>unfollow</code>のパーシャルに作業を振っているだけです。パーシャルでは、Relationshipsリソース用の新しいルーティングが必要です。これを、<a class="hyperref" href="user_microposts?version=4.2#code-microposts_resource">リスト<span class="ref">11.29</span></a>のMicropostsリソースの例に従って作成しましょう (<a class="hyperref" href="#code-relationships_resource">リスト<span class="ref">12.20</span></a>)。</p>
<div class="codelisting" id="code-relationships_resource" data-tralics-id="uid1330" data-number="12.20">
<div class="heading">
<span class="number">リスト12.20:</span> 

<span class="description">Relationshipリソース用のルーティングを追加する<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span>       <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">follow/unfollowパーシャル自体は、<a class="hyperref" href="#code-follow_form">リスト<span class="ref">12.21</span></a>と<a class="hyperref" href="#code-unfollow_form">リスト<span class="ref">12.22</span></a>に示します。</p>
<div class="codelisting" id="code-follow_form" data-tralics-id="uid1331" data-number="12.21">
<div class="heading">
<span class="number">リスト12.21:</span> 

<span class="description">ユーザーをフォローするためのフォーム<span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-unfollow_form" data-tralics-id="uid1332" data-number="12.22">
<div class="heading">
<span class="number">リスト12.22:</span> 

<span class="description">ユーザーのアンフォローするフォーム<span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p>これらの2つのフォームでは、いずれも<code>form_for</code>を使用してRelationshipモデルオブジェクトを操作しています。これらの2つのフォームの主な違いは、<a class="hyperref" href="#code-follow_form">リスト<span class="ref">12.21</span></a>は<em>新しい</em>リレーションシップを作成するのに対し、<a class="hyperref" href="#code-unfollow_form">リスト<span class="ref">12.22</span></a>は既存のリレーションシップを見つけ出すという点です。すなわち、前者は<span class="tt">POST</span>リクエストを Relationshipsコントローラに送信してリレーションシップを<code>create</code> (作成) し、後者は<span class="tt">DELETE</span>リクエストを送信してリレーションシップを<code>destroy</code> (削除) するということです(これらのアクションは<a class="hyperref" href="#sec-a_working_follow_button_the_standard_way"><span class="ref">12.2.4</span></a>で実装します)。最終的に、このfollow/unfollowフォームにはボタンしかないことを理解していただけたと思います。しかし、それでもこのフォームは<code>followed_id</code>をコントローラに送信する必要があります。これを行うために、<a class="hyperref" href="#code-follow_form">リスト<span class="ref">12.21</span></a>の<code>hidden_field_tag</code>メソッドを使用します。このメソッドは 以下のフォームのHTMLを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"followed_id"</span> <span class="na">name=</span><span class="s">"followed_id"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="account_activation_password_reset?version=4.2#sec-resetting_the_password"><span class="ref">10.2.4</span></a>の<a class="hyperref" href="account_activation_password_reset?version=4.2#code-password_reset_form">リスト<span class="ref">10.50</span></a>で見たように、隠しフィールドの<code>input</code>タグを使うことで、ブラウザ上に表示させずに適切な情報を含めることができます。</p>
<p>これで、<a class="hyperref" href="#code-user_follow_form_profile_stats"><span class="ref">12.23</span></a>のようにフォロー用のフォームをユーザープロファイルページにインクルードしてパーシャルを出力できるようになりました。プロファイルには、<a class="hyperref" href="#fig-profile_follow_button">図<span class="ref">12.12</span></a>および<a class="hyperref" href="#fig-profile_unfollow_button">図<span class="ref">12.13</span></a>のようにそれぞれ [Follow]、[Unfollow] ボタンが表示されます。</p>
<div class="codelisting" id="code-user_follow_form_profile_stats" data-tralics-id="uid1333" data-number="12.23">
<div class="heading">
<span class="number">リスト12.23:</span> 

<span class="description">プロフィールページにフォロー用のフォームと、フォロワーの統計情報を追加する<span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
<span class="hll">    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/section&gt;</span>
</span>  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow_form'</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span>    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-profile_follow_button" data-tralics-id="uid1334" data-number="12.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_follow_button_3rd_edition.png" alt="images/figures/profile_follow_button_3rd_edition"></div>
<div class="caption">
<span class="header">図12.12: </span><span class="description">プロフィール画面 (<a href="http://localhost:3000/users/2" target="_blank">/users/2</a>) に [Follow] ボタンが表示されている
</span>
</div>
</div>
<div class="center figure" id="fig-profile_unfollow_button" data-tralics-id="uid1335" data-number="12.13">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_unfollow_button_3rd_edition.png" alt="images/figures/profile_unfollow_button_3rd_edition"></div>
<div class="caption">
<span class="header">図12.13</span> <span class="description">プロフィール画面 (<a href="http://localhost:3000/users/5" target="_blank">/users/5</a>) に [Unfollow] ボタンが表示されている
</span>
</div>
</div>
<p>これらのボタンはもうすぐ動作するようになります。実はこのボタンの実装には2とおりの方法があります。1つは標準的な方法 (<a class="hyperref" href="#sec-a_working_follow_button_the_standard_way"><span class="ref">12.2.4</span></a>)、もう1つはAjaxを使用する方法 (<a class="hyperref" href="#sec-a_working_follow_button_with_ajax"><span class="ref">12.2.5</span></a>) です。でもその前に、フォローしているユーザーとフォロワーを表示するページをそれぞれ作成してHTMLインターフェイスを完成させてしまいましょう。</p>
</div>
<div id="sec-following_and_followers_pages" class="subsection" data-tralics-id="uid1336" data-number="12.2.3">
<h3><a href="#sec-following_and_followers_pages" class="heading hyperref"><span class="number">12.2.3</span>「フォローしているユーザー」ページと「フォロワー」ページ</a></h3>
<p>フォローしているユーザーを表示するページと、フォロワーを表示するページは、いずれもユーザープロファイルページとユーザーインデックスページ (<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-users_index"><span class="ref">9.3.1</span></a>) を合わせたような作りになるという点で似ています。どちらにもフォローの統計情報などのユーザー情報を表示するサイドバーと、ユーザーのリストがあります。さらに、サイドバーには小さめのユーザープロフィール画像のリンクを格子状に並べて表示する予定です。この要求に合うモックアップを<a class="hyperref" href="#fig-following_mockup">図<span class="ref">12.14</span></a> (フォローしているユーザー用) および <a class="hyperref" href="#fig-followers_mockup">図<span class="ref">12.15</span></a> (フォロワー用) に示します。</p>
<div class="center figure" id="fig-following_mockup" data-tralics-id="uid1337" data-number="12.14">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/following_mockup_bootstrap.png" alt="images/figures/following_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図12.14</span> <span class="description">フォローしているユーザー用ページのモックアップ
</span>
</div>
</div>
<div class="center figure" id="fig-followers_mockup" data-tralics-id="uid1338" data-number="12.15">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/followers_mockup_bootstrap.png" alt="images/figures/followers_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図12.15</span> <span class="description">ユーザーのフォロワー用ページのモックアップ
</span>
</div>
</div>
<p>ここでの最初の作業は、フォローしているユーザーのリンクとフォロワーのリンクを動くようにすることです。Twitterにならい、どちらのページでもユーザーのログインを要求します。前回のアクセス制御と同様に、まずはテストから書いていきます。今回使うテストは<a class="hyperref" href="#code-following_followers_authorization_test">リスト<span class="ref">12.24</span></a>のとおりです。</p>
<div class="codelisting" id="code-following_followers_authorization_test" data-tralics-id="uid1339" data-number="12.24">
<div class="heading">
<span class="number">リスト12.24:</span> 

<span class="description">フォロー/フォロワーページの認可をテストする RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect following when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect followers when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:followers</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>この実装には1つだけトリッキーな部分があります。それはUsersコントローラに2つの新しいアクションを追加する必要があるということです。これは<a class="hyperref" href="#code-following_followers_actions_routes">リスト<span class="ref">12.15</span></a>で定義した2つのルーティングにもとづいており、これらはそれぞれ<code>following</code>および<code>followers</code>と呼ぶ必要があります。それぞれのアクションでは、タイトルを設定し、ユーザーを検索し、<code>@user.following</code>または<code>@user.followers</code>からデータを取り出し、ページネーションを行なって、ページを出力する必要があります。変更した結果は<a class="hyperref" href="#code-following_followers_actions">リスト<span class="ref">12.25</span></a>のようになります。</p>
<div class="codelisting" id="code-following_followers_actions" data-tralics-id="uid1340" data-number="12.25">
<div class="heading">
<span class="number">リスト12.25:</span> 

<span class="description"><code>following</code>アクションと<code>followers</code>アクション<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span>
</span><span class="hll">                                        <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Following"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Followers"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">本チュートリアルのいたるところで見てきたように、Railsは慣習に従って、アクションに対応するビューを暗黙的に呼び出します。たとえば、<code>show</code>アクションの最後で<code>show.html.erb</code>を呼び出すといった具合です。一方で、<a class="hyperref" href="#code-following_followers_actions">リスト<span class="ref">12.25</span></a>のいずれのアクションも、<code>render</code>を<em>明示的に</em>呼び出し、<code>show_follow</code>という同じビューを出力しています。したがって、作成が必要なビューはこれ1つです。renderで呼び出しているビューが同じである理由は、このERbはどちらの場合でもほぼ同じであり、<a class="hyperref" href="#code-show_follow_view">リスト<span class="ref">12.26</span></a>で両方の場合をカバーできるためです。</p>
<div class="codelisting" id="code-show_follow_view" data-tralics-id="uid1341" data-number="12.26">
<div class="heading">
<span class="number">リスト12.26:</span> 

<span class="description">フォローしているユーザーとフォロワーの両方を表示する<code>show_follow</code>ビュー<span class="break"></span> <span class="filepath">app/views/users/show_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_avatars"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users follow"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-following_followers_actions">リスト<span class="ref">12.25</span></a>にあるアクションは、2通りの方法で<a class="hyperref" href="#code-show_follow_view">リスト<span class="ref">12.26</span></a>のビューを呼び出します。“following”をとおって描画したビューを<a class="hyperref" href="#fig-user_following">図<span class="ref">12.16</span></a>に、“followers”をとおって描画したビューを<a class="hyperref" href="#fig-user_followers">図<span class="ref">12.17</span></a>に示します。このとき、上のコードではカレントユーザーを一切使っていない点に注目してください。したがって、他のユーザーのフォロワー一覧ページもうまく動きます (<a class="hyperref" href="#fig-different_user_followers">図<span class="ref">12.18</span></a>)。</p>
<div class="center figure" id="fig-user_following" data-tralics-id="uid1342" data-number="12.16">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_following_3rd_edition.png" alt="images/figures/user_following_3rd_edition"></div>
<div class="caption">
<span class="header">図12.16</span> <span class="description">現在のユーザーにフォローされているユーザーを表示する
</span>
</div>
</div>
<div class="center figure" id="fig-user_followers" data-tralics-id="uid1343" data-number="12.17">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_followers_3rd_edition.png" alt="images/figures/user_followers_3rd_edition"></div>
<div class="caption">
<span class="header">図12.17</span> <span class="description">ユーザーのフォロワーを表示する
</span>
</div>
</div>
<div class="center figure" id="fig-different_user_followers" data-tralics-id="uid1344" data-number="12.18">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/diferent_user_followers_3rd_edition.png" alt="images/figures/diferent_user_followers_3rd_edition"></div>
<div class="caption">
<span class="header">図12.18</span> <span class="description">別のユーザーのフォロワーを表示する
</span>
</div>
</div>
<p>フォロー一覧もフォロワー一覧も動くようになったので、この振る舞いを検証するための2つの統合テストを書いていきましょう。これらの統合テストを基本的なテストに留め、網羅的なテストではありません。<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-layout_link_tests"><span class="ref">5.3.4</span></a>でも指摘したように、HTML構造を網羅的にチェックするテストは壊れやすく、生産性を逆に落としかねないからです。したがって今回は、正しい数が表示されているかどうかと、正しいURLが表示されているかどうかの2つのテストを書きます。</p>
<p>いつものように、統合テストを生成するところから始めます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test following
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/following_test.rb</span>
</pre></div></div>
<p>次に、テストデータをいくつか揃えます。リレーションシップ用のfixtureにデータを追加しましょう。<a class="hyperref" href="user_microposts?version=4.2#sec-profile_micropost_tests"><span class="ref">11.2.3</span></a>では、次のように書くことで</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div>
<p class="noindent">ユーザーとマイクロポストを関連付けできたことを思い出してください。また、上のコードではユーザー名を書いていましたが、</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div>
<p class="noindent">次のようにユーザーidでも関連付けできます。</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">user_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</pre></div></div>
<p class="noindent">この例を参考にしてリレーションシップ用のfixtureにテストデータを追加すると、<a class="hyperref" href="#code-relationships_fixtures">リスト<span class="ref">12.27</span></a>のようになります。</p>
<div class="codelisting" id="code-relationships_fixtures" data-tralics-id="uid1345" data-number="12.27">
<div class="heading">
<span class="number">リスト12.27:</span> 

<span class="description">following/followerをテストするためのリレーションシップ用fixture<span class="break"></span> <span class="filepath">test/fixtures/relationships.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">one</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>

<span class="l-Scalar-Plain">two</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mallory</span>

<span class="l-Scalar-Plain">three</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>

<span class="l-Scalar-Plain">four</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div>
</div>
<p> <a class="hyperref" href="#code-relationships_fixtures">リスト<span class="ref">12.27</span></a>のfixtureでは、前半の2つでMichaelがLanaとMalloryをフォローし、後半の2つでLanaとArcherがMichaelをフォローしています。あとは、正しい数かどうかを確認するために、<code>assert_match</code>メソッド (<a class="hyperref" href="user_microposts?version=4.2#code-user_profile_test">リスト<span class="ref">11.27</span></a>) を使ってプロフィール画面のマイクロポスト数をテストします。さらに、正しいURLかどうかをテストするコードも加えると、<a class="hyperref" href="#code-following_tests">リスト<span class="ref">12.28</span></a>のようになります。</p>
<div class="codelisting" id="code-following_tests" data-tralics-id="uid1346" data-number="12.28">
<div class="heading">
<span class="number">リスト12.28:</span> 

<span class="description">following/followerページのテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"following page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"followers page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">なお、<a class="hyperref" href="#code-following_tests">リスト<span class="ref">12.28</span></a>では、次のコードを加えていますが</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">empty?</span>
</pre></div></div>
<p class="noindent">このコードは次のコードを確かめるためのテストなので、</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><a href="https://en.wikipedia.org/wiki/Vacuous_truth" target="_blank">無意味なテスト</a>ではないことに注意してください (<code>followers</code>についても同様です)。</p>
<p>これで、テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1347" data-tralics-id="uid1347" data-number="12.29">
<div class="heading">
<span class="number">リスト12.29:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-a_working_follow_button_the_standard_way" class="subsection" data-tralics-id="uid1348" data-number="12.2.4">
<h3><a href="#sec-a_working_follow_button_the_standard_way" class="heading hyperref"><span class="number">12.2.4</span> [フォローする] ボタン (標準的な方法)</a></h3>
<p>ビューが整ってきました。いよいよ [フォローする] [フォロー解除する] ボタンを動作させましょう。フォローとフォロー解除はそれぞれリレーションシップの作成と削除に対応しているため、まずはRelationshipsコントローラが必要です。いつものようにコントローラを生成しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Relationships
</pre></div></div>
<p><a class="hyperref" href="#code-relationships_controller">リスト<span class="ref">12.31</span></a>でも説明しますが、Relationshipsコントローラのアクションでアクセス制御することはそこまで難しくありません。しかし、前回のアクセス制御のときと同様に最初にテストを書き、それをパスするように実装することでセキュリティモデルを確立させていきましょう。今回はまず、コントローラのアクションにアクセスするとき、ログイン済みにユーザーであるかどうかをチェックします。 もしログインしていなければ、ログインページにリダイレクトさせ、Relationshipのカウントが変わっていないことを確認します (<a class="hyperref" href="#code-relationships_access_control">リスト<span class="ref">12.30</span></a>)。</p>
<div class="codelisting" id="code-relationships_access_control" data-tralics-id="uid1349" data-number="12.30">
<div class="heading">
<span class="number">リスト12.30:</span> 

<span class="description">リレーションシップの基本的なアクセス制御に対するテスト RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/relationships_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"create should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"destroy should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationships</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">次に、<a class="hyperref" href="#code-relationships_access_control">リスト<span class="ref">12.30</span></a>のテストをパスさせるために、<code>logged_in_user</code>フィルターをRelationshipsコントローラのアクションに対して追加します (<a class="hyperref" href="#code-relationships_controller">リスト<span class="ref">12.31</span></a>)。</p>
<div class="codelisting" id="code-relationships_controller" data-tralics-id="uid1350" data-number="12.31">
<div class="heading">
<span class="number">リスト12.31:</span> 

<span class="description">リレーションシップのアクセス制御 GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>フォロー/フォロー解除ボタンを動かすためには、フォーム (<a class="hyperref" href="#code-follow_form">リスト<span class="ref">12.21</span></a>/<a class="hyperref" href="#code-unfollow_form">リスト<span class="ref">12.22</span></a>) から送信されたパラメータを使って、<code>followed_id</code>に対応するユーザーを見つけてくる必要があります 。その後、見つけてきたユーザーに対して適切に<code>follow</code>/<code>unfollow</code>メソッド (<a class="hyperref" href="#code-follow_unfollow_following">リスト<span class="ref">12.10</span></a>) を使います。このすべてを実装した結果を、<a class="hyperref" href="#code-relationships_controller_following">リスト<span class="ref">12.32</span></a>に示します。</p>
<div class="codelisting" id="code-relationships_controller_following" data-tralics-id="uid1351" data-number="12.32">
<div class="heading">
<span class="number">リスト12.32:</span> 

<span class="description">Relationshipsコントローラ<span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">    <span class="n">current_user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
</span><span class="hll">    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-relationships_controller_following">リスト<span class="ref">12.32</span></a>を見てみれば、先ほどのセキュリティ問題が実はそれほど重大なものではないことを理解いただけると思います。もしログインしていないユーザーが (<code>curl</code>などのコマンドラインツールなどを使用して) これらのアクションに直接アクセスするようなことがあれば、<code>current_user</code>は<code>nil</code>になり、どちらのメソッドでも2行目で例外が発生します。エラーにはなりますが、アプリケーションやデータに影響は生じません。このままでも支障はありませんが、やはりこのような例外には頼らない方がよいので、上ではひと手間かけてセキュリティのためのレイヤーを追加しました。</p>
<p>これで、フォロー/フォロー解除の機能が完成しました。どのユーザーも、他のユーザーをフォローしたり、フォロー解除したりできます。ブラウザ上でボタンをクリックして、確かめてみてください。(振る舞いを検証する統合テストは<a class="hyperref" href="#sec-following_tests"><span class="ref">12.2.6</span></a>で実装します。) 2番目のユーザーをフォローする前の状態を<a class="hyperref" href="#fig-unfollowed_user">図<span class="ref">12.19</span></a>に、フォローした結果を<a class="hyperref" href="#fig-followed_user">図<span class="ref">12.20</span></a>にそれぞれ示します。</p>
<div class="center figure" id="fig-unfollowed_user" data-tralics-id="uid1352" data-number="12.19">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/unfollowed_user.png" alt="images/figures/unfollowed_user"></div>
<div class="caption">
<span class="header">図12.19: </span><span class="description">フォローしていないユーザーの画面
</span>
</div>
</div>
<div class="center figure" id="fig-followed_user" data-tralics-id="uid1353" data-number="12.20">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/followed_user.png" alt="images/figures/followed_user"></div>
<div class="caption">
<span class="header">図12.20: </span><span class="description">ユーザーをフォローした結果
</span>
</div>
</div>
</div>
<div id="sec-a_working_follow_button_with_ajax" class="subsection" data-tralics-id="uid1354" data-number="12.2.5">
<h3><a href="#sec-a_working_follow_button_with_ajax" class="heading hyperref"><span class="number">12.2.5</span> [フォローする] ボタン (Ajax)</a></h3>
<p>フォロー関連の機能の実装はこのとおり完了しましたが、ステータスフィードに取りかかる前にもう一つだけ機能を洗練させてみたいと思います。<a class="hyperref" href="#sec-a_working_follow_button_the_standard_way"><span class="ref">12.2.4</span></a>では、Relationshipsコントローラの<code>create</code>アクションと <code>destroy</code>アクションを単に<em>元の</em>プロファイルにリダイレクトしていました。つまり、ユーザーはプロファイルページを最初に表示し、それからユーザーをフォローし、その後すぐ元のページにリダイレクトされるという流れになります。ユーザーをフォローした後、本当にそのページから離れて元のページに戻らないといけないのでしょうか。この点を考えなおしてみましょう。</p>
<p>これは<em>Ajax</em>を使用することで解決できます。Ajaxを使用すれば、Webページからサーバーに「非同期」で、ページを移動することなくリクエストを送信することができます<sup class="footnote" id="cha-12_footnote-ref-8"><a href="#cha-12_footnote-8">8</a></sup>。WebフォームにAjaxを採用するのは今や当たり前になりつつあるので、RailsでもAjaxを簡単に実装できるようになっています。フォロー用とフォロー解除用のフォームパーシャルをこれに沿って更新するのは簡単です。以下のコードがあるとします。</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div></div>
<p class="noindent">上を以下のように置き換えます。</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p class="noindent">たったこれだけで、Railsは<a href="http://catb.org/jargon/html/A/automagically.html" target="_blank">自動的</a>にAjaxを使用します。更新の結果を<a class="hyperref" href="#code-follow_form_ajax">リスト<span class="ref">12.33</span></a>と<a class="hyperref" href="#code-unfollow_form_ajax">リスト<span class="ref">12.34</span></a>に示します。</p>
<div class="codelisting" id="code-follow_form_ajax" data-tralics-id="uid1356" data-number="12.33">
<div class="heading">
<span class="number">リスト12.33:</span> 

<span class="description">Ajaxを使ったフォローフォーム<span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-unfollow_form_ajax" data-tralics-id="uid1357" data-number="12.34">
<div class="heading">
<span class="number">リスト12.34:</span> 

<span class="description">Ajaxを使ったフォロー解除フォーム<span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
<span class="hll">             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p>ERbによって実際に生成されるHTMLはそれほど重要ではありませんが、興味がある方のために、次にその核心部分をお見せします。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/relationships/117"</span> <span class="na">class=</span><span class="s">"edit_relationship"</span> <span class="na">data-remote=</span><span class="s">"true"</span>
      <span class="na">id=</span><span class="s">"edit_relationship_117"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
<p class="noindent">ここでは、formタグの内部で<code>data-remote="true"</code>変数を設定しています。これは、JavaScriptによるフォーム操作を許可することをRailsに知らせるためのものです。以前のRailsでは完全なJavaScriptコードを挿入していましたが、Rails 3からこのようにHTMLプロパティを使用して簡単にJavaScriptを使用できます。これは、<a href="http://railscasts.com/episodes/205-unobtrusive-javascript" target="_blank"><em>JavaScriptを前面に出すべからず</em></a>という哲学に従っています。</p>
<p>フォームの更新が終わったので、今度はこれに対応するRelationshipsコントローラを改造して、Ajaxリクエストに応答できるようにしましょう。こういったリクエストの種類によって応答を場合分けするときは、<code>respond_to</code>というメソッドを使います。一般的な使い方は、次のような具合です。</p>
<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">この文法は少々変わっていて混乱を招く可能性がありますが、上の (ブロック内の) コードのうち、<em>いずれかの1行</em>が実行されるという点が重要です (このため<code>respond_to</code>メソッドは、上から順に実行する逐次処理というより、if文を使った分岐処理に近いイメージです)。RelationshipsコントローラでAjaxに対応させるために、<code>respond_to</code>メソッドを<code>create</code>アクションと<code>destroy</code>アクション (<a class="hyperref" href="#code-relationships_controller_following">リスト<span class="ref">12.32</span></a>) にそれぞれ追加してみましょう。変更の結果を<a class="hyperref" href="#code-relationships_controller_ajax">リスト<span class="ref">12.35</span></a>に示します。このとき、ユーザーのローカル変数 (<code>user</code>) をインスタンス変数 (<code>@user</code>) に変更した点に注目してください。これは、<a class="hyperref" href="#code-relationships_controller_following">リスト<span class="ref">12.32</span></a>のときはインスタンス変数は必要なかったのですが、<a class="hyperref" href="#code-follow_form_ajax">リスト<span class="ref">12.33</span></a>や<a class="hyperref" href="#code-unfollow_form_ajax">リスト<span class="ref">12.34</span></a>を実装したことにより、インスタンス変数が必要になったためです。</p>
<div class="codelisting" id="code-relationships_controller_ajax" data-tralics-id="uid1358" data-number="12.35">
<div class="heading">
<span class="number">リスト12.35:</span> 

<span class="description">RelationshipsコントローラでAjaxリクエストに対応する<span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-relationships_controller_ajax">リスト<span class="ref">12.35</span></a>でAjaxリクエストに対応したので、今度はブラウザ側でJavaScriptが無効になっていた場合 (Ajaxリクエストが送れない場合) でもうまく動くようにします (<a class="hyperref" href="#code-degrade_gracefully">リスト<span class="ref">12.36</span></a>)。</p>
<div class="codelisting" id="code-degrade_gracefully" data-tralics-id="uid1359" data-number="12.36">
<div class="heading">
<span class="number">リスト12.36:</span> 

<span class="description">JavaScriptが無効になっていたときのための設定<span class="break"></span> <span class="filepath">config/application.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># 認証トークンをremoteフォームに埋め込む</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">action_view</span><span class="o">.</span><span class="n">embed_authenticity_token_in_remote_forms</span> <span class="o">=</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">一方で、JavaScriptが有効になっていても、まだ十分に対応できていない部分があります。というのも、Ajaxリクエストを受信した場合は、Railsが自動的にアクションと同じ名前を持つ<em>JavaScript用の埋め込みRuby</em> (<code>.js.erb</code>) ファイル (<code>create.js.erb</code>や<code>destroy.js.erb</code>など) を呼び出すからです。ご想像のとおり、これらのファイルではJavaScriptと埋め込みRuby (ERb) をミックスして現在のページに対するアクションを実行することができます。ユーザーをフォローしたときやフォロー解除したときにプロフィールページを更新するために、私たちがこれから作成および編集しなければならないのは、まさにこれらのファイルです。</p>
<p>JS-ERbファイルの内部では、Railsが自動的に<a href="http://www.google.com/url?q=http%3A%2F%2Fjquery.com%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGtx3hYIQpONgUoQvrnRm8YULAPpA">jQuery</a> JavaScriptヘルパーを提供します。これにより、<a href="http://www.google.com/url?q=http%3A%2F%2Fwww.w3.org%2FDOM%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHVQjySXT64x5ZMGb6z_QawAarBPQ">DOM (Document Object Model)</a> を使用してページを操作できます。<a class="hyperref" href="user_microposts?version=4.2#sec-image_validation"><span class="ref">11.4.2</span></a>で見たように、jQueryライブラリにはDOM操作用の膨大なメソッドが提供されていますが、ここで使用するのはわずか2つです。それにはまず、ドル記号 ($) とCSS idを使用してDOM要素にアクセスする文法について知る必要があります。たとえば、<code>follow_form</code>要素を操作するには、以下の文法を使用します。</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">)</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-follow_form_partial">リスト<span class="ref">12.19</span></a>では、これはフォームを囲む<code>div</code>タグであり、フォームそのものではなかったことを思い出してください。jQueryの文法はCSSの記法から影響を受けており、<code>#</code>シンボルを使用してCSSのidを指定します。ご想像のとおり、jQueryはCSSと同様、ドット<code>.</code>を使用してCSSクラスを操作できます。</p>
<p>次に必要なメソッドは<code>html</code>です。これは、引数の中で指定された要素の内側にあるHTMLを更新します。たとえば、フォロー用フォーム全体を<code>"foobar"</code>という文字列で置き換えるには、以下を使用します。</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</pre></div></div>
<p>純粋なJavaScriptと異なり、JS-ERbファイルでは組み込みRuby (ERb) を使用できます。<code>create.js.erb</code>ファイルでは、フォロー用のフォームを<code>unfollow</code>パーシャルで更新し、フォロワーのカウントを更新するのにERbを使用しています (もちろんこれは、フォローに成功した場合の動作です)。変更の結果を<a class="hyperref" href="#code-create_js_erb">リスト<span class="ref">12.37</span></a>に示します。このコードでは<code>escape_javascript</code>メソッドを使用していることに注目してください。この関数は、JavaScriptファイル内にHTMLを挿入するときに実行結果をエスケープする (画面に表示しない) ために必要です。</p>
<div class="codelisting" id="code-create_js_erb" data-tralics-id="uid1360" data-number="12.37">
<div class="heading">
<span class="number">リスト12.37:</span> 

<span class="description">JavaScriptと埋め込みRubyを使ってフォローの関係性を作成する<span class="break"></span> <span class="filepath">app/views/relationships/create.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/unfollow')) %&gt;"</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">);</span>
</pre></div></div>
</div>
<p class="noindent">各行の末尾にセミコロン ; があることに注目してください。 これはプログラミング言語によくある文法で、古くは1950年代中ごろに開発された<a href="https://ja.wikipedia.org/wiki/ALGOL" target="_blank">ALGOL</a>まで遡ります。</p>
<p><code>destroy.js.erb</code>ファイルの方も同様です (<a class="hyperref" href="#code-destroy_js_erb">リスト<span class="ref">12.38</span></a>)。</p>
<div class="codelisting" id="code-destroy_js_erb" data-tralics-id="uid1361" data-number="12.38">
<div class="heading">
<span class="number">リスト12.38:</span> 

<span class="description">Ruby JavaScript (RJS) を使ってフォローの関係性を削除する<span class="break"></span> <span class="filepath">app/views/relationships/destroy.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/follow')) %&gt;"</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">);</span>
</pre></div></div>
</div>
<p class="noindent">これらのコードにより、ユーザープロファイルを表示して、ページを更新せずにフォローまたはフォロー解除ができるようになったはずです。</p>
</div>
<div id="sec-following_tests" class="subsection" data-tralics-id="uid1362" data-number="12.2.6">
<h3><a href="#sec-following_tests" class="heading hyperref"><span class="number">12.2.6 </span>フォローをテストする</a></h3>
<p>フォローボタンが動くようになったので、バグを検知するためのシンプルなテストを書いていきましょう。ユーザーのフォローに対するテストでは、 /relationshipsに対してPOSTリクエストを送り、フォローされたユーザーが1人増えたことをチェックします。具体的なコードは次のとおりです。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">これは標準的なフォローに対するテストではありますが、Ajax版もやり方は大体同じです。Ajaxのテストでは、<code>post</code>の代わりに<code>xhr :post</code>を使うだけです。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">ここで使っている<code>xhr</code> (XmlHttpRequest) というメソッドは、Ajaxでリクエストを発行するします。したがって、<a class="hyperref" href="#code-relationships_controller_ajax">リスト<span class="ref">12.35</span></a>の<code>respond_to</code>では、JavaScriptに対応した行が実行されるようになります。</p>
<p>また、ユーザーをアンフォローするときも構造はほとんど同じで、<code>post</code>メソッドを<code>delete</code>メソッドに置き換えてテストします。つまり、そのユーザーのidとリレーションシップのidを使ってDELETEリクエストを送信し、フォローしている数が1つ減ることを確認します。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span>
         <span class="ss">relationship</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">Ajaxの場合は次のとおりです。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span>
               <span class="ss">relationship</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div></div>
<p>これらのテストをまとめた結果を、<a class="hyperref" href="#code-follow_button_tests">リスト<span class="ref">12.39</span></a>に示します。</p>
<div class="codelisting" id="code-follow_button_tests" data-tralics-id="uid1363" data-number="12.39">
<div class="heading">
<span class="number">リスト12.39:</span> 

<span class="description">Follow/Unfollowボタンをテストする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@other</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
</span>    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow a user the standard way"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should follow a user with Ajax"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user the standard way"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user with Ajax"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>この時点では、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1364" data-tralics-id="uid1364" data-number="12.40">
<div class="heading">
<span class="number">リスト12.40:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-the_status_feed" class="section" data-tralics-id="cid82" data-number="12.3">
<h2><a href="#sec-the_status_feed" class="heading hyperref"><span class="number">12.3</span> ステータスフィード</a></h2>
<p>ついに、サンプルアプリケーションの山頂が目の前に現れました。最後の難関、ステータスフィードの実装に取りかかりましょう。この節で扱われている内容は、本書の中でも最も高度なものです。完全なステータスフィードは、<a class="hyperref" href="user_microposts?version=4.2#sec-a_proto_feed"><span class="ref">11.3.3</span></a>で扱ったプロトフィードをベースにします。現在のユーザーにフォローされているユーザーのマイクロポストの配列を作成し、現在のユーザー自身のマイクロポストと合わせて表示します。このセクションを通して、複雑さを増したフィードの実装に進んでいきます。これ実現するためには、RailsとRubyの高度な機能の他に、SQLプログラミングの技術も必要です。</p>
<p>手強い課題に挑むのですから、ここで実装すべき内容を慎重に見直すことが重要です。<a class="hyperref" href="#fig-page_flow_home_page_feed_mockup">図<span class="ref">12.5</span></a>でお見せしたステータスフィードの最終形を<a class="hyperref" href="#fig-home_page_feed_mockup">図<span class="ref">12.21</span></a>に再度掲載します。</p>
<div class="center figure" id="fig-home_page_feed_mockup" data-tralics-id="uid1365" data-number="12.21">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図12.21</span> <span class="description">ステータスフィード付きのHomeページのモックアップ
</span>
</div>
</div>
<div id="sec-motivation_and_strategy" class="subsection" data-tralics-id="uid1366" data-number="12.3.1">
<h3><a href="#sec-motivation_and_strategy" class="heading hyperref"><span class="number">12.3.1</span> 動機と計画</a></h3>
<p>ステータスフィードの基本的なアイディアはシンプルです。<a class="hyperref" href="#fig-user_feed">図<span class="ref">12.22</span></a>に、サンプルの<code>microposts</code>データベーステーブルと、それをフィードした結果を示します。図の矢印で示されているように、この目的は、現在のユーザーによってフォローされているユーザーに対応するユーザーidを持つマイクロポストを取り出し、同時に現在のユーザー自身のマイクロポストも一緒に取り出すことです。</p>
<div class="center figure" id="fig-user_feed" data-tralics-id="uid1367" data-number="12.22">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_feed.png" alt="images/figures/user_feed"></div>
<div class="caption">
<span class="header">図12.22:</span> <span class="description">id 1のユーザーがid 2、7、8、10をフォローしているときのフィード
</span>
</div>
</div>
<p>どのようにフィードを実装するのかはまだ明確ではありませんが、テストについてはやや明確そうなので、(<a class="hyperref" href="static_pages?version=4.2#aside-when_to_test">コラム<span class="ref">3.3</span></a>のガイドラインに従って) まずはテストから書いていきます。このテストで重要なことは、フィードに必要な3つの条件を満たすことです。1) フォローしているユーザーのマイクロポストがフィードに含まれていること。2) 自分自身のマイクロポストもフィードに含まれていること。3) <em>フォローしていない</em>ユーザーのマイクロポストがフィードに含まれていないこと。そして<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-users_fixtures_extra_users">リスト<span class="ref">9.43</span></a>と<a class="hyperref" href="user_microposts?version=4.2#code-add_micropost_different_owner">リスト<span class="ref">11.51</span></a>のfixtureファイルから、MichaelのフィードではLanaと自分自身の投稿が見えていて、Archerの投稿は見えないことがわかります。先ほどの3つの条件をアサーションに変換して、Userモデル (<a class="hyperref" href="user_microposts?version=4.2#code-proto_status_feed">リスト<span class="ref">11.44</span></a>) <code>feed</code>メソッドがあることに注意しながら、更新したUserモデルに対するテストを書いてみましょう。結果を<a class="hyperref" href="#code-full_feed_test">リスト<span class="ref">12.41</span></a>に示します。</p>
<div class="codelisting" id="code-full_feed_test" data-tralics-id="uid1368" data-number="12.41">
<div class="heading">
<span class="number">リスト12.41:</span> 

<span class="description">ステータスフィードのテスト RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"feed should have the right posts"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">lana</span>    <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:lana</span><span class="p">)</span>
    <span class="c1"># フォローしているユーザーの投稿を確認</span>
    <span class="n">lana</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_following</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_following</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 自分自身の投稿を確認</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_self</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_self</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># フォローしていないユーザーの投稿を確認</span>
    <span class="n">archer</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_unfollowed</span><span class="o">|</span>
      <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_unfollowed</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>もちろん、現在のフィードはただのプロトタイプなので、このテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1369" data-tralics-id="uid1369" data-number="12.42">
<div class="heading">
<span class="number">リスト12.42:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-a_first_feed_implementation" class="subsection" data-tralics-id="uid1370" data-number="12.3.2">
<h3><a href="#sec-a_first_feed_implementation" class="heading hyperref"><span class="number">12.3.2</span> フィードを初めて実装する</a></h3>
<p>ステータスフィードで要求される設計は<a class="hyperref" href="#code-full_feed_test">リスト<span class="ref">12.41</span></a>のテストで明確になったので (このテストにパスすれば良いので)、早速フィードの実装に着手してみましょう。最終的なフィードの実装はやや込み入っているため、細かい部品を1つずつ確かめながら導入していきます。最初に、このフィードで必要なクエリについて考えましょう。ここで必要なのは、<code>microposts</code>テーブルから、あるユーザー (つまり自分自身) がフォローしているユーザーに対応するidを持つマイクロポストをすべて選択 (select) することです。このクエリを模式的に書くと以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div></div>
<p class="noindent">上のコードを書く際に、SQLが<code>IN</code>というキーワードをサポートしていることを前提にしています (大丈夫、実際にサポートされています)。このキーワードを使用することで、idの集合の内包 (set inclusion) に対してテストを行えます。</p>
<p><a class="hyperref" href="user_microposts?version=4.2#sec-a_proto_feed"><span class="ref">11.3.3</span></a>のプロトフィードでは、上のような選択を行うためにActive Recordで<code>リスト<span class="ref">11.44</span></code>のように<a class="hyperref" href="user_microposts?version=4.2#code-proto_status_feed">where</a>メソッドを使用していたことを思い出してください。このときは、選択する対象はシンプルでした。現在のユーザーに対応するユーザーidを持つマイクロポストをすべて選択すればよかったのでした。</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">ここで行いたい選択は、上よりももう少し複雑で、たとえば以下のような感じになります。</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>これらの条件から、フォローされているユーザーに対応するidの配列が必要であることがわかってきました。これを行う方法の1つは、Rubyの<code>map</code>メソッドを使用することです。このメソッドはすべての "列挙可能 (enumerable)" オブジェクト (配列やハッシュなど、要素の集合で構成されるあらゆるオブジェクト<sup class="footnote" id="cha-12_footnote-ref-9"><a href="#cha-12_footnote-9">9</a></sup>) で使用できます。なお、このメソッドは<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>でも出てきました。他の例題として、<code>map</code>メソッドを使って配列を文字列に変換すると、次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p class="noindent">上に示したような状況では、各要素に対して同じメソッド が実行されます。これは非常によく使われる方法であり、次のように<em>アンパサンド</em> <code>&amp;</code>と、メソッドに対応するシンボルを使用した短縮表記 (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>) も可能です。この短縮表記なら変数iを使用せずに済みます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p class="noindent"><code>join</code>メソッド (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-arrays_and_ranges"><span class="ref">4.3.1</span></a>) を使用すれば、idを集めた文字列を以下のようにカンマ区切りでつなげることもできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "1, 2, 3, 4"</span>
</pre></div></div>
<p>上のメソッドを使用すれば、<code>user.following</code>にある各要素の<code>id</code>を呼び出し、フォローしているユーザーのidの配列を構成することができます。たとえば、データベースの最初のユーザーの場合は、以下の配列になります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p class="noindent">実際、この手法は実に便利なので、Active Recordは以下でもデフォルトで同じ結果を返します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p class="noindent">この<code>following_ids</code>メソッドは、実はActive Recordによって<code>has_many :following</code>関連付けから自動生成されたものです (<a class="hyperref" href="#code-has_many_following_through_active_relationships">リスト<span class="ref">12.8</span></a>)。これにより、<code>user.following</code>コレクションに対応するidを得るための<code>_ids</code>を、関連付けの名前に追加するだけで済みます。
フォローしているユーザーidの文字列は以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51"</span>
</pre></div></div>
<p class="noindent">なお、以上は説明のためのコードであり、実際にSQL文字列に挿入するときは、このように記述する必要はありません。実は、<code>?</code>を内挿すると自動的にこの辺りの面倒を見てくれます。さらに、データベースに依存する一部の非互換性まで解消してくれます。つまり、ここでは<code>following_ids</code>メソッドをそのまま使えばよいだけなのです。</p>
<p>結果、最初に想像していたとおり</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">が無事に動きました! 変更の結果を<a class="hyperref" href="#code-initial_working_feed">リスト<span class="ref">12.43</span></a>に示します。</p>
<div class="codelisting" id="code-initial_working_feed" data-tralics-id="uid1372" data-number="12.43">
<div class="heading">
<span class="number">リスト12.43:</span> 

<span class="description">とりあえず動くフィードの実装 GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># パスワードリセットが期限切れならtrueを返す</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーのステータスフィードを返す</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># ユーザーをフォローする</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">active_relationships</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>これでテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1373" data-tralics-id="uid1373" data-number="12.44">
<div class="heading">
<span class="number">リスト12.44:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">いくつかのアプリケーションにおいては、この初期実装だけで目的が達成され、十分に思えるかもしれません。しかし<a class="hyperref" href="#code-initial_working_feed">リスト<span class="ref">12.43</span></a>にはまだ足りないものがあります。それが何なのか、次の節に進む前に考えてみてください(<em>ヒント:</em>フォローしているユーザーが5000人もいたらどうなるでしょうか)。</p>
</div>
<div id="sec-scopes_subselects_and_a_lambda" class="subsection" data-tralics-id="uid1374" data-number="12.3.3">
<h3><a href="#sec-scopes_subselects_and_a_lambda" class="heading hyperref"><span class="number">12.3.3</span> サブセレクト</a></h3>
<p>前節のヒントでおわかりのように、<a class="hyperref" href="#sec-a_first_feed_implementation"><span class="ref">12.3.2</span></a>のフィードの実装は、投稿されたマイクロポストの数が膨大になったときにうまくスケールアップできません。フォローしているユーザーが5000人程度になるとこういうことが起きる可能性があります。この節では、フォローしているユーザー数に応じてスケーリングできるように、ステータスフィードを再度実装します。</p>
<p><a class="hyperref" href="#sec-a_first_feed_implementation"><span class="ref">12.3.2</span></a>で示したコードの問題は、<code>following_ids</code>でフォローしている<em>すべての</em>ユーザーをメモリーから一気に取り出し、フォローしているユーザーの完全な配列を作り出したことです。<a class="hyperref" href="#code-initial_working_feed">リスト<span class="ref">12.43</span></a>の条件では、集合に内包されているかどうかだけしかチェックされていないため、この部分をもっと効率的なコードにできるはずです。そして、SQLは本来このような集合の操作に最適化されています。これを解決する方法は、フォローしているユーザーのidの検索をデータベースに保存するときに<em>サブセレクト (subselect) </em>を使用することです。</p>
<p><a class="hyperref" href="#code-feed_second_cut">リスト<span class="ref">12.45</span></a>でコードを若干修正し、フィードをリファクタリングすることから始めましょう。</p>
<div class="codelisting" id="code-feed_second_cut" data-tralics-id="uid1375" data-number="12.45">
<div class="heading">
<span class="number">リスト12.45:</span> 

<span class="description"><code>where</code>メソッド内の変数に、キーと値のペアを使う GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># ユーザーのステータスフィードを返す</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span>
</span><span class="hll">                    <span class="ss">following_ids</span><span class="p">:</span> <span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">次の段階の準備として、以下のコードを</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">以下の同等のコードに置き換えました。</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span>
                <span class="ss">following_ids</span><span class="p">:</span> <span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">前者の疑問符を使用した文法も便利ですが、<em>同じ</em>変数を複数の場所に挿入したい場合は、後者の置き換え後の文法を使用するのがより便利です。</p>
<p>上の説明が暗に示すように、これからSQLクエリに<em>もう1つ</em>の<code>user_id</code>を追加します。特に、以下のRubyコードは、</p>
<div class="code"><div class="highlight"><pre><span class="n">following_ids</span>
</pre></div></div>
<p class="noindent">以下のSQLスニペットと置き換えることができます。</p>
<div class="code"><div class="highlight"><pre><span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                 WHERE  follower_id = :user_id"</span>
</pre></div></div>
<p class="noindent">このコードではSQLサブセレクトが使用されています。ユーザー1についてすべてを選択することは、内部的には以下のような感じになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span>  <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div></div>
<p class="noindent">このサブセレクトは、集合のロジックを (Railsではなく) データベースに保存するので、より効率が高まります。</p>
<p>これで基礎を固めることができましたので、<a class="hyperref" href="#code-feed_final">リスト<span class="ref">12.46</span></a>のようにもっと効率なフィードを実装する準備ができました。ここに記述されているのは生のSQLなので、<code>following_ids</code>という文字列はエスケープされているのではなく、<em>式展開</em>されることに注意してください</p>
<div class="codelisting" id="code-feed_final" data-tralics-id="uid1376" data-number="12.46">
<div class="heading">
<span class="number">リスト12.46:</span> 

<span class="description">フィードの最終的な実装 GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># ユーザーのステータスフィードを返す</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE  follower_id = :user_id"</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (</span><span class="si">#{</span><span class="n">following_ids</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                     OR user_id = :user_id"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">このコードはRailsとRubyとSQLが複雑に絡み合っていて厄介ですが、ちゃんと動作します。</p>
<div class="codelisting" id="uid1377" data-tralics-id="uid1377" data-number="12.47">
<div class="heading">
<span class="number">リスト12.47:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">もちろん、サブセレクトを使用すればいくらでもスケールアップできるなどということはありません。大規模なWebサイトでは、バックグラウンドジョブを使用して、フィードを非同期で生成するなどの対策が必要でしょう。Webサイトのスケーリングのようなデリケートな問題は本書の範疇を超えます。</p>
<p><a class="hyperref" href="#code-feed_final">リスト<span class="ref">12.46</span></a>をもって、ステータスフィードの実装は完了です。<a class="hyperref" href="user_microposts?version=4.2#sec-a_proto_feed"><span class="ref">11.3.3</span></a>でHomeページには既にフィードを追加していたことを思い出してください。 思い出すキッカケとして、<code>home</code>アクションは<a class="hyperref" href="#code-real_feed_instance_variable">リスト<span class="ref">12.48</span></a>に再掲します。<a class="hyperref" href="user_microposts?version=4.2#cha-user_microposts"><span class="ref">第11章</span></a>ではただのプロトタイプでしたが (<a class="hyperref" href="user_microposts?version=4.2#fig-home_with_proto_feed">図<span class="ref">11.14</span></a>)、<a class="hyperref" href="#code-feed_final">リスト<span class="ref">12.46</span></a>の実装によって、Homeページで完全なフィードが表示できていることがわかります (<a class="hyperref" href="#fig-home_page_with_feed">図<span class="ref">12.23</span></a>)。</p>
<div class="codelisting" id="code-real_feed_instance_variable" data-tralics-id="uid1378" data-number="12.48">
<div class="heading">
<span class="number">リスト12.48:</span> 

<span class="description"><code>home</code>アクション内で、フィードにもページネーションを適用する<span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
<span class="hll">      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-home_page_with_feed" data-tralics-id="uid1379" data-number="12.23">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_page_with_feed_3rd_edition.png" alt="images/figures/home_page_with_feed_3rd_edition"></div>
<div class="caption">
<span class="header">図12.23:</span> <span class="description">Homeページで動作するステータスフィード
</span>
</div>
</div>
<p>この時点で、masterブランチに変更を取り込む準備ができました。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Add user following"
$ git checkout master
$ git merge following-users
</pre></div></div>
<p class="noindent">コードをリポジトリにpushして、本番環境にデプロイしてみましょう。</p>
<div class="code"><div class="highlight"><pre>$ git push
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rake db:migrate
$ heroku run rake db:seed
</pre></div></div>
<p class="noindent">本番環境で動作するステータスフィードは以下のようになります (<a class="hyperref" href="#fig-live_status_feed">図<span class="ref">12.24</span></a>)。</p>
<div class="center figure" id="fig-live_status_feed" data-tralics-id="uid1380" data-number="12.24">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/live_status_feed.png" alt="images/figures/live_status_feed"></div>
<div class="caption">
<span class="header">図12.24:</span> <span class="description">本番環境で動作するステータスフィード
</span>
</div>
</div>
</div>
</div><div id="sec-following_conclusion" class="section" data-tralics-id="cid83" data-number="12.4">
<h2><a href="#sec-following_conclusion" class="heading hyperref"><span class="number">12.4</span> 最後に</a></h2>
<p>ステータスフィードが追加され、<em>Ruby on Railsチュートリアル</em>のサンプルアプリケーションがとうとう完成しました。このサンプルアプリケーションには、Railsの主要な機能 (モデル、ビュー、コントローラ、テンプレート、パーシャル、フィルタ、検証、コールバック、<code>has_many</code>/<code>belongs_to</code>/<code>has_many through</code>関連付け、セキュリティ、テスティング、展開) が多数含まれています。</p>
<p>これだけでもかなりの量ですが、 Web開発ついて学ぶべきことはまだまだたくさんあります。今後の学習の手始めとするために、この節では、より踏み込んだ学習をするための方法を紹介します。</p>
<div id="sec-guide_to_further_resources" class="subsection" data-tralics-id="uid1381" data-number="12.4.1">
<h3><a href="#sec-guide_to_further_resources" class="heading hyperref"><span class="number">12.4.2</span> 読み物ガイド</a></h3>
<p>読むに値するRails関連の書籍やドキュメントは書店やWebでいくらでも見つけられます。正直、あまりの多さに閉口するほどです。幸い、それらのほとんどが現在でも入手/アクセス可能です。より高度な技術を身に付けるためのお勧めリソースをいくつかリストアップします。

<br><br>(訳注: 日本語の読み物ガイドとしては、<a href="https://twitter.com/zyunnosuke">@zyunnosuke</a>さんの記事「<a href="http://morizyun.github.io/blog/ruby-rails-non-beginner-guide-book/">Ruby on Railsを仕事にしていくための第一歩</a>」がよくまとまっています。「Railsチュートリアルを読み終わった後はどうすれば良い?」とお悩みの方は、是非ご参考にしてみてください。)</p>
<ul>
<li>
<a href="http://screencasts.railstutorial.org/" target="_blank">Railsスクリーンキャスト</a>: 本書に合わせて、完全版のスクリーンキャスト (現在は英語版のみ) を用意してあります。このスクリーンキャストでは、本書の話題をすべてカバーしているだけでなく、さまざまなコツや秘訣も満載されており、スクリーンショットだけでは捉えにくい実際の動作を動画で視聴することもできます。スクリーンキャスト (英語) は <a href="http://www.railstutorial.org/" target="_blank">Ruby on RailsチュートリアルWebサイト</a>(英語版)で購入できます。
</li>
<li>
<a href="http://railscasts.com/" target="_blank">RailsCasts</a>: 最初に<a href="http://railscasts.com/episodes/archive" target="_blank">RailsCastsエピソードアーカイブ</a>を開いて、目についたトピックを適当に開くところから始めてみるとよいでしょう。
</li>
<li>
<a href="http://www.gotealeaf.com/railstutorial" target="_blank">Tealeaf Academy</a>: 開発者自身による新人向けトレーニング講座が最近増えてきました。身の回りのそういった人がいればよいのですが、そうでない場合はオンラインでどこからでも受講できる<a href="http://www.gotealeaf.com/railstutorial" target="_blank">Tealeaf Academy</a>があります。もし体系化されたカリキュラムやインストラクターによるフィードバックが欲しければ、Tealeafは良い選択肢となり得るでしょう。
</li>
<li>
<a href="http://turing.io/friends/tutorial" target="_blank">Turing School of Software &amp; Design</a>: コロラド州デンバーで27週間 (約半年)、フルタイムでRuby/Rails/JavaScripを学ぶプログラムです (訳注: プログラミング留学ってイメージですね)。ほとんどの生徒はプログラミング経験が乏しい時点からスタートしていますが、強い意志と高いモチベーションをもっています (上達にはこれらが必要です)。Turingスクールでは、生徒が卒業後に職を見つけることを保証していて、見つからなければ授業料を返還しています。Railsチュートリアルの読者は<a href="http://turing.io/friends/tutorial" target="_blank">$500の割引クーポン</a>が使えます。興味ある方は<span class="sc">RAILSTUTORIAL500</span>というクーポンコードを使ってください。

</li>
<li>
<a href="http://bloc.io/" target="_blank">Bloc</a>: 体系化されたカリキュラムを使った、オンライン上のブートキャンプで、参加者に応じて適切なメンターを配置したり、プロジェクトを通した学習に特化している点が特長です。<span class="sc">RAILSTUTORIAL500</span>というクーポンコードを使うと、入会費を500ドル割引できます。
</li>
<li>
<a href="http://www.thinkful.com/a/railstutorial" target="_blank">Thinkful</a>: プロのエンジニアとペアを組んで、プロジェクト実践型のカリキュラムで進んでいくオンライン講座です。対応している科目はRuby on Rails、フロントエンド開発、Webデザイン、データサイエンスです。
</li>
<li>
<a href="https://pragmaticstudio.com/refs/railstutorial" target="_blank">Pragmatic Studio</a>: Mike ClarkとNicole Clarkが教鞭を執っているオンラインのRailsクラスです。
</li>
<li>
<a href="https://tutorials.railsapps.org/hartl" target="_blank">RailsApps</a>: 教育目的の、Railsアプリケーションのサンプル集です。</li>
<li>
<a href="http://mbsy.co/6VQ8l" target="_blank">Code School</a>: 非常に多種多様なプログラミングを対話的に学習できるコース</li>
<li>
<a href="https://www.udemy.com/learn-test-driven-development-in-ruby/couponCode=hartl" target="_blank">Bala Paranj’s Test Driven Development in Ruby</a>: Rubyを使ってテスト駆動開発を学ぶ、上級者向けのオンライン講座です。</li>
<li>RubyやRailsのお勧め書籍: 「<a href="http://www.amazon.com/gp/product/1430223634" target="_blank"><em>Beginning Ruby</em></a>」(Peter Cooper 著)、「<a href="http://www.amazon.com/gp/product/1933988657" target="_blank"><em>The Well-Grounded Rubyist</em></a>」(David A. Black著)、「<a href="http://www.amazon.com/Eloquent-Ruby-Addison-Wesley-Professional-Series/dp/0321584104/" target="_blank"><em>Eloquent Ruby</em></a>」(Russ Olsen著)、Rubyをさらに深く学ぶのであれば 「<a href="http://www.amazon.com/gp/product/0672328844" target="_blank"><em>The Ruby Way</em></a>」(Hal Fulton著) がお勧めです。Railsをさらに深く学ぶのであれば「<a href="https://pragprog.com/book/rails4/agile-web-development-with-rails-4" target="_blank">Agile Web Development with Rails</a>」(Sam Ruby / Dave Thomas / David Heinemeier Hansson著)、「<a href="http://www.amazon.com/Rails-Edition-Addison-Wesley-Professional-Series/dp/0321944275" target="_blank"><em>The Rails&nbsp;4 Way</em></a>」(Obie Fernandez / Kevin Faustino著)、「<a href="http://www.amazon.com/Rails-4-Action-Ryan-Bigg/dp/1617291099" target="_blank"><em>Rails&nbsp;4 in Action</em></a>」 (Ryan Bigg / Yehuda Katz著)がお勧めです。

</li>
<li>
<a href="http://railsguides.jp/" target="_blank">Railsガイド</a>: トピック毎に分類された最新のRailsリファレンスです (訳注: RailsGuidesの日本語版を「Railsガイド」と呼んでいます)。
</li>
</ul>
</div>
<div id="sec-following_users_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid1392" data-number="12.4.2">
<h3><a href="#sec-following_users_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">12.4.2 </span>本章のまとめ</a></h3>
<ul>
<li>
<code>has_many :through</code>を使うと、複雑なデータ関係をモデリングできる
</li>
<li>
<code>has_many</code>メソッドには、クラス名や外部キーなど、いくつものオプションを渡すことができる
</li>
<li>適切なクラス名と外部キーと一緒に<code>has_many</code>/<code>has_many :through</code>を使うことで、能動的関係 (フォローする) や受動的関係 (フォローされる) がモデリングできた
</li>
<li>ルーティングは、ネストさせて使うことができる
</li>
<li>
<code>where</code>メソッドを使うと、柔軟で強力なデータベースへの問い合わせが作成できる
</li>
<li>Railsは (必要に応じて) 低級なSQLクエリを呼び出すことができる
</li>
<li>本書で学んだすべてを駆使することで、フォローしているユーザーのマイクロポスト一覧をステータスフィードに表示させることができた
</li>
</ul>
</div>
</div><div id="sec-following_exercises" class="section" data-tralics-id="cid84" data-number="12.5">
<h2><a href="#sec-following_exercises" class="heading hyperref"><span class="number">12.5</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で原著を購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>なお、演習とチュートリアル本編の食い違いを避ける方法については、演習用のトピックブランチに追加したメモ (<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>) を参考にしてください。</p>
<ol>
<li>HomeページとProfileページにある統計情報のテストを書いてみてください。<em>ヒント</em>: <a class="hyperref" href="user_microposts?version=4.2#code-user_profile_test">リスト<span class="ref">11.27</span></a>のテストに追加してください。(Homeページの統計情報は別のテストにしてみませんか。)
</li>
<li>Homeページに表示されている1ページ目のフィードをテストしてください。<a class="hyperref" href="#code-home_feed_test">リスト<span class="ref">12.49</span></a>はそのテンプレートです。<code>CGI.escapeHTML</code>でHTMLのエスケープ処理を使っている点に注目して、なぜこれが必要なのか考えてみてください。(試しにエスケープ処理を外して、HTMLのソースコードを注意深く調べてください。マイクロポストの内容がおかしいはずです。)
</li>
</ol>
<div class="codelisting" id="code-home_feed_test" data-tralics-id="uid1402" data-number="12.49">
<div class="heading">
<span class="number">リスト12.49:</span> 

<span class="description">フィードのHTMLをテストする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"feed on Home page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
      <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escapeHTML</span><span class="p">(</span><span class="no">FILL_IN</span><span class="p">),</span> <span class="no">FILL_IN</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div><div id="cha-12_footnotes">
  <div class="navigation"><a class="prev_page" href="user_microposts?version=4.2#cha-user_microposts">«&nbsp;<span class="number">第11章</span>ユーザーのマイクロポスト</a></div>
<ol class="footnotes">
    <li id="cha-12_footnote-1">モックアップツアーの写真は、それぞれ http://www.flickr.com/photos/john_lustig/2518452221/ と https://www.flickr.com/photos/renemensen/9187111340 から引用しました。&nbsp;<a class="arrow" href="#cha-12_footnote-ref-1">↑</a>
</li>
    <li id="cha-12_footnote-2">見えやすくするため、<a class="hyperref" href="#fig-naive_user_has_many_following">図<span class="ref">12.6</span></a>から<code>following</code>テーブルの<code>id</code>カラムを省略しました。<a class="arrow" href="#cha-12_footnote-ref-2">↑</a>
</li>
    <li id="cha-12_footnote-3">読者のPaul Fioravantiがこの用語を提案してくれました。ありがとうございます。<a class="arrow" href="#cha-12_footnote-ref-3">↑</a>
</li>
    <li id="cha-12_footnote-4">技術的には、Railsは<code>has_many</code>に与えられた引数を、<code>classify</code>メソッドを使ってクラス名に変換しています。このメソッドは、たとえば<code>"foo_bars"</code>であれば<code>"FooBar"</code>に変換します。<a class="arrow" href="#cha-12_footnote-ref-4">↑</a>
</li>
    <li id="cha-12_footnote-5">技術的には、Railsは<code>underscore</code>メソッドを使用してクラス名をidに変換しています。たとえば、<code>"FooBar".underscore</code>を実行すると<code>"foo_bar"</code>に変換されます。従って、 <code>FooBar</code>オブジェクトの外部キーは<code>foo_bar_id</code>になるでしょう<a class="arrow" href="#cha-12_footnote-ref-5">↑</a>
</li>
    <li id="cha-12_footnote-6">特定の分野でモデリングの経験を多く積めば、このようなユーティリティメソッドが必要になることを事前に思い付けるようになるでしょう。たとえ思い付けないことがあったとしても、明確なテストを書こうとするときに、いつの間にかこういうメソッドを自分が作成していることに気付くことでしょう。だからというわけではありませんが、今はこのようなメソッドが必要であるということに気付けなくても問題ありません。ソフトウェアの開発は、繰りかえしに次ぐ繰り返しです。読みづらくなるまでコードを書き足し、そのコードをリファクタリングする、その繰り返しです。そして、より簡潔なコードを書くために、本書が少しでもお役に立てばと思います。<a class="arrow" href="#cha-12_footnote-ref-6">↑</a>
</li>
    <li id="cha-12_footnote-7">Railsにはさまざまなルーティングオプションがありますが、詳細についてはRailsガイドの記事「<a href="http://railsguides.jp/routing.html" target="_blank">Railsルーティング</a>」を参照してください。<a class="arrow" href="#cha-12_footnote-ref-7">↑</a>
</li>
    <li id="cha-12_footnote-8">
<em>Asynchronous (非同期の) JavaScript And XML</em>の
それぞれの頭文字をとっています。Ajaxはしばしば “AJAX” と大文字で書かれますが、<a href="http://www.adaptivepath.com/ideas/ajax-new-approach-web-applications/" target="_blank">Ajaxの起源となる記事</a>では一貫して “Ajax” となっています。<a class="arrow" href="#cha-12_footnote-ref-8">↑</a>
</li>
    <li id="cha-12_footnote-9">列挙可能 (enumerable) オブジェクトであることの主な条件は、<code>each</code>メソッドを実装していることです。このメソッドはコレクションを列挙します。<a class="arrow" href="#cha-12_footnote-ref-9">↑</a>
</li>
  </ol>
</div>
          </div>
  </body>
</html>
