<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<div id="top"></div>


<h1 class="chapter"><a id="sec-11" href="./following-users.html#top" class="heading"><span class="number">第11章</span>ユーザーをフォローする</a></h1>


<p>この章では、他のユーザーをフォロー (およびフォロー解除) できるソーシャルレイヤーを追加し、各ユーザーのHomeページに、現在フォロー中のユーザーのステータスフィードを表示できるようにして、サンプルアプリケーションのコアを完成させます。また、自分をフォローしているユーザーと、自分がフォローしているユーザーを同時に表示できるようにします。ユーザー間のリレーションをモデリングする方法については<a class="ref" href="./following-users.html#sec-the_relationship_model">11.1</a>で説明します。続いてWebインターフェイスの作成方法について、Ajaxの紹介と合わせて<a class="ref" href="./following-users.html#sec-a_web_interface_for_following_and_followers">11.2</a>で説明します。最終的に、完全に動作するステータスフィードの開発は<a class="ref" href="./following-users.html#sec-the_status_feed">11.3</a>で完了します。</p>

<p>この最終章では、本書の中で最も難易度の高い手法をいくつか使用しています。その中には、ステータスフィード作成のためにRuby/SQLを「だます」テクニックも含まれます。この章の例全体にわたって、これまでよりも複雑なデータモデルを使用しています。ここで学んだデータモデルは、今後自分用のWebアプリケーションを開発するときに必ず役に立ちます。本書を卒業して実際の開発に携わるときのために、<a class="ref" href="./following-users.html#sec-following_conclusion">11.4</a>にサンプルアプリケーションのコア部分を拡張する際のお勧めの方法を記しました。そのための高度な資料への参照も含まれています。</p>

<p>Gitユーザーはこれまで同様新しいトピックブランチを作成してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div>
</div>


<p>この章で扱っている手法は本書全体の中で最も難易度が高いので、理解を助けるため、コードを書く前にはいったん立ち止まってインターフェイスを探検することにします。これまでの章と同様、最初にモックアップを示します<sup class="footnote" id="fnref-11_1"><a href="./following-users.html#fn-11_1">1</a></sup>。ページ操作の全体的なフローは次のようになります。あるユーザー (John Calvin) は自分のプロファイルページを最初に表示し (<a class="ref" href="./following-users.html#fig-page_flow_profile_mockup">図11.1</a>)、フォローするユーザーを選択するためにUsersページ (<a class="ref" href="./following-users.html#fig-page_flow_user_index_mockup">図11.2</a>) に移動します。Calvinは2番目のユーザーThomas Hobbes (<a class="ref" href="./following-users.html#fig-page_flow_other_profile_follow_button_mockup">図11.3</a>) を表示し、[Follow] ボタンを押してフォローします。これにより、[Follow] ボタンが [Unfollow] に変わり、Hobbes の [followers]  カウントが1人増えます (<a class="ref" href="./following-users.html#fig-page_flow_other_profile_unfollow_button_mockup">図11.4</a>)。CalvinがHomeページに戻ると、[following] カウントが1人増え、Hobbesのマイクロポストがステータスフィードに表示されるようになっていることがわかります (<a class="ref" href="./following-users.html#fig-page_flow_home_page_feed_mockup">図11.5</a>)。この節では、以後このフローの実現に専念します。</p>

<div class="label" id="fig-page_flow_profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_profile_mockup_bootstrap.png" alt="page_flow_profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.1</span><span class="description">現在のユーザーのプロファイル。<a href="../images/figures/page_flow_profile_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_user_index_mockup_bootstrap.png" alt="page_flow_user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.2</span><span class="description">フォローする相手を見つける。<a href="../images/figures/page_flow_user_index_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_other_profile_follow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_other_profile_follow_button_mockup_bootstrap.png" alt="page_flow_other_profile_follow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.3</span><span class="description">フォローするユーザーのプロファイルに [Follow] ボタンが表示されている。<a href="../images/figures/page_flow_other_profile_follow_button_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_other_profile_unfollow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap.png" alt="page_flow_other_profile_unfollow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.4</span><span class="description">プロファイルに [Unfollow] ボタンが表示され、フォロワーのカウントが1つ増えた。<a href="../images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.5</span><span class="description">Homeページにステータスフィードが表示され、フォローのカウントが1増えた。<a href="../images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_relationship_model"></div>


<h2><a id="sec-11_1" href="./following-users.html#sec-the_relationship_model" class="heading"><span class="number">11.1</span>Relationshipモデル</a></h2>


<p>ユーザーをフォローする機能を実装する第一歩は、データモデルを構成することです。ただし、これは見た目ほど単純ではありません。素朴に考えれば、<code>has_many</code> (1対多) リレーションシップはこんな感じでできそうな気がします。1人のユーザーが複数のユーザーを<code>has_many</code>としてフォローし 、1人のユーザーに複数のフォロワーがいることを<code>has_many</code>で表す、という具合です。この後で説明しますが、この方法ではたちまち壁に突き当たってしまいます。これを解決するための<code>has_many through</code> (多対多の関係を表すのに使用) についてもこの後で説明します。この節で説明するアイディアの多くは、最初なかなか意図が読み取れないこともあると思います。複雑なデータモデルも、腑に落ちるまで時間がかかることでしょう。もし自分が混乱し始めていると感じたら、まずはこの章の最後まで進め、それからもう一度この章全体を読み返してみてください。読み返すことでよりよく理解できると思います。</p>

<div class="label" id="sec-a_problem_with_the_data_model"></div>


<h3><a id="sec-11_1_1" href="./following-users.html#sec-a_problem_with_the_data_model" class="heading"><span class="number">11.1.1</span>データモデルの問題 (および解決策)</a></h3>


<p>ユーザーをフォローするデータモデル構成のための第一歩として、典型的な場合を検討してみましょう。あるユーザーが、別のユーザーをフォローしているところを考えてみましょう。具体例を挙げると、CalvinはHobbesをフォローしています。これを逆から見れば、HobbesはCalvinからフォローされています。CalvinはHobbesから見れば<em>フォロワー (follower)</em>であり、HobbesはCalvinによって<em>フォローされている (followed) </em>ことになります。Railsにおけるデフォルトの複数形の慣習に従えば、あるユーザーをフォローしているすべてのユーザーの集合は<em>followers</em>となり、<code>user.followers</code>はそれらのユーザーの配列を表すことになります。残念なことに、この名前付けは逆についてはうまくいきません (Railsのというより英語の都合ですが)。フォローされているすべてのユーザーの集合は、このままでは<em>followeds</em>となってしまい、英語の文法からも外れるうえに非常に見苦しいものになってしまいます。followedに代えて<em>following</em>とすれば、followingsのように複数形にも対応できるのではないでしょうか。しかし今度は意味が曖昧になってしまいます。この文脈で “following” と書くと、英語では<em>あなたを</em>フォローする人々の集合、つまりあなたのフォロワーを指します。これでは意味が正反対になってしまいます。“following”は表示で “50 following, 75 followers” のように使用することはありますが、データモデルとしては違う名前を使用することにしましょう。ここでは、フォローしているユーザーたち自体を表すのに “followed users” を採用することにし、これに<code>user.followed_users</code>配列が対応します<sup class="footnote" id="fnref-11_2"><a href="./following-users.html#fn-11_2">2</a></sup>。</p>

<p>これにより、<a class="ref" href="./following-users.html#fig-naive_user_has_many_following">図11.6</a>のように<code>followed_users</code>テーブルと <code>has_many</code>関連付けを使用して、フォローしているユーザー (followed users) のモデリングができます。<code>user.followed_users</code>はユーザーの配列でなければならないため、<code>followed_users</code>テーブルのそれぞれの行は、<code>followed_id</code>で識別可能なユーザーである必要があります。この行には<code>follower_id</code>もあり、これで関連付けを行います<sup class="footnote" id="fnref-11_3"><a href="./following-users.html#fn-11_3">3</a></sup>。さらに、それぞれの行はユーザーなので、これらのユーザーに名前やパスワードなどの属性も追加する必要があるでしょう。</p>

<div class="label" id="fig-naive_user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/naive_user_has_many_followed_users.png" alt="naive_user_has_many_followed_users" /></span></div><div class="caption"><span class="header">図11.6</span><span class="description">フォローしているユーザーの素朴な実装例。</span></div></div>


<p><a class="ref" href="./following-users.html#fig-naive_user_has_many_following">図11.6</a>のデータモデルの問題点は、非常に無駄が多いことです。各行には、フォローしているユーザーのidのみならず、名前やメールアドレスまであります。これらはいずれも <code>users</code>テーブルに<em>既にある</em>ものばかりです。さらによくないことに、<em>followers</em>の方をモデリングするときにも、同じぐらい無駄の多い<code>followers</code>テーブルを別に作成しなければならなくなってしまいます。結論としては、このデータモデルはメンテナンスの観点から見て悪夢です。ユーザー名を変更するたびに、<code>users</code>テーブルのそのレコードだけでなく、<code>followed_users</code>テーブルと<code>followers</code>テーブルの両方について、<em>そのユーザーを含むすべての行</em>を更新しなければならなくなります。</p>

<p>この問題の根本は、必要な抽象化を行なっていないことです。正しい抽象化の方法を見つけ出す方法の1つは、Webアプリケーションにおける<em>following</em>の動作をどのように実装するかをじっくり考えることです。<a class="ref" href="./sign-up.html#sec-a_users_resource">7.1.2</a>において、RESTアーキテクチャは、作成されたり削除されたりする<em>リソース</em>に関連していたことを思い出してください。ここから、2つの疑問が生じます。1. あるユーザーが別のユーザーをフォローするとき、何が作成されるのでしょうか。2. あるユーザーが別のユーザーをフォロー<em>解除</em>するとき、何が削除されるのでしょうか。</p>

<p>この点を踏まえて考えると、この場合アプリケーションによって作成または削除されるのは、つまるところ2人のユーザーの「<em>関係 (リレーションシップ)</em>」であることがわかります。つまり、1人のユーザーは「<code>has_many :relationships</code>」、つまり1対多の関係を持つことができ、さらにユーザーはリレーションシップ<em>を経由して</em>多くの<code>followed_users</code> (または<code>followers</code>) と関係を持つことができるということです。実際、<a class="ref" href="./following-users.html#fig-naive_user_has_many_following">図11.6</a>には必要なものがほぼあります。それぞれの「フォローしているユーザー」は<code>followed_id</code>で一意に特定できるので、<code>followed_users</code>テーブルを<code>Relationships</code>テーブルに変換します。続いて、ユーザーの詳細情報 (名前とメールアドレス) は Relationshipテーブルから削除してしまいます。そして<code>followed_id</code>を使用して「フォローしているユーザー」を<code>users</code>テーブルから取り出します。今度は<em>逆の</em>関係を考えます。<code>follower_id</code>カラムを使用して、ユーザーのフォロワーの配列を取り出すことができます。</p>

<p>ユーザーの<code>followed_users</code>の配列を作成するには、<code>followed_id</code>の配列を取り出し、それぞれのidごとに対応するユーザーを見つけ出します。皆様の期待どおり、Railsにはこのような手続きを簡単に行うための方法があります。多対多の関係を表現するこの手法は<code>has_many through</code>として知られています。<a class="ref" href="./following-users.html#sec-following">11.1.4</a>でも説明しますが、Railsは、以下のような簡潔なコードを使用することで、1人のユーザーが多数のユーザーとRelationshipテーブル<em>経由で</em>フォローしている/されている関係を記述することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
</pre></div>
</div>


<p>このコードは自動的に、<code>user.followed_users</code>を「フォローしているユーザー」の配列を使用してデプロイします。このデータモデルの模式図を<a class="ref" href="./following-users.html#fig-user_has_many_following">図11.7</a>に示します。</p>

<div class="label" id="fig-user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_has_many_followed_users.png" alt="user_has_many_followed_users" /></span></div><div class="caption"><span class="header">図11.7</span><span class="description">ユーザーのリレーションシップで表される、フォローしている/されているユーザーのモデル。</span></div></div>


<p>このデータモデルを実装するには、最初に以下のようにRelationshipモデルを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div>
</div>


<p>上のコマンドを実行するとRelationshipファクトリーも生成されるので、以下を実行してファクトリーを削除してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -f spec/factories/relationship.rb
</pre></div>
</div>


<p>このリレーションシップは今後<code>follower_id</code>と<code>followed_id</code>で頻繁に検索することになるので、<a class="ref" href="./following-users.html#code-relationships_migration">リスト11.1</a>に示したように、それぞれのカラムにインデックスを追加します。</p>

<div class="label" id="code-relationships_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.1</span> <span class="description"><code>relationships</code>テーブルにインデックスを追加する。</span><br /><span class="description"> <code>db/migrate/[timestamp]_create_relationships.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./following-users.html#code-relationships_migration">リスト11.1</a>には<em>複合 (composite) </em>インデックスが使用されていることに注目してください。これは<code>follower_id</code>と<code>followed_id</code>を組み合わせたときの一意性 (uniquenes: 重複がないこと) を強制するもので、これにより、あるユーザーは別のユーザーを2度以上フォローすることはできなくなります。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>(<a class="ref" href="./modeling-users.html#code-email_uniqueness_index">リスト6.19</a>のメールアドレスの一意インデックスと比較してみてください)。<a class="ref" href="./following-users.html#sec-following">11.1.4</a>でも説明しますが、このような重複はインターフェイスレベルでも起きることのないようにします。しかし、一意 (ユニーク) インデックスを追加することで、ユーザーが何らかの方法で (<tt>curl</tt>などのコマンドラインツールを使用して) リレーションシップを重複させてしまうようなことがあればエラーが発生するようになります。さらに、このRelationshipモデルには今後一意性検証を追加する予定です。しかし、一意インデックスを使用していればリレーションシップが重複したときに<em>必ず</em>エラーになるので、現時点では一意インデックスで十分です。</p>

<p><code>relationships</code>テーブルを作成するために、いつものようにデータベースのマイグレーションを行なってテストデータベースを準備しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>作成したRelationshipデータモデルを<a class="ref" href="./following-users.html#fig-relationship_model">図11.8</a>に示します。</p>

<div class="label" id="fig-relationship_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/relationship_model.png" alt="relationship_model" /></span></div><div class="caption"><span class="header">図11.8</span><span class="description">Relationshipデータモデル。</span></div></div>




<div class="label" id="sec-relationship_user_associations"></div>


<h3><a id="sec-11_1_2" href="./following-users.html#sec-relationship_user_associations" class="heading"><span class="number">11.1.2</span>User/relationshipの関連付け</a></h3>


<p>フォローしているユーザーとフォロワーを実装する前に、ユーザーとリレーションシップの関連付けを行います。1人のユーザーには<code>has_many</code> (1対多) リレーションシップがあり、このリレーションシップは<em>2人</em>のユーザーの間の関係なので、フォローしているユーザーとフォロワーの両方に属します (<code>belongs_to</code>)。</p>

<p><a class="ref" href="./user-microposts.html#sec-user_micropost_associations">10.1.3</a>のマイクロポストのときと同様、以下のようなユーザー関連付けのコードを使用して新しいリレーションシップを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>基本的な検証テストから始めることにします。 このテストを<a class="ref" href="./following-users.html#code-relationship_create_test">リスト11.2</a>に示します。</p>

<div class="label" id="code-relationship_create_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.2</span> <span class="description">リレーションシップの作成と属性をテストする。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">relationship</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ところで、<a class="ref" href="./following-users.html#code-relationship_create_test">リスト11.2</a>では<code>let</code>を使用してインスタンス変数にアクセスしていることに注目してください。UserモデルやMicropostモデルのテストのときは、それぞれ<code>@user</code>や<code>@micropost</code>を使用していました。この違いが問題になることはほとんどありません<sup class="footnote" id="fnref-11_4"><a href="./following-users.html#fn-11_4">4</a></sup>が、動作をよりはっきりとさせるために、インスタンス変数を使用する際には<code>let</code>を使用することをお勧めします。これまで通常のインスタンス変数を使用してきたのは、インスタンス変数を早い段階で紹介しておきたかったのと、<code>let</code>がやや高度であるためです。</p>

<p>今度はUserモデルの<code>relationships</code>属性を<a class="ref" href="./following-users.html#code-user_relationships_method_test">リスト11.3</a>のようにテストしましょう。</p>

<div class="label" id="code-user_relationships_method_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.3</span> <span class="description"><code>user.relationships</code>属性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、アプリケーションコードは<a class="ref" href="./user-microposts.html#sec-user_micropost_associations">10.1.3</a>のようになるのではないかと予測した方もいるかもしれません。実際似ているのですが、1つ大きな違いがあります。Micropostモデルの場合、以下のように書くことができました。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>および以下です。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このように書くことができたのは、<code>microposts</code>テーブルにはユーザーを特定するための<code>user_id</code>属性があるからです (<a class="ref" href="./user-microposts.html#sec-the_basic_model">10.1.1</a>)。2つのデータベーステーブルを結合するために使用されるidは、<em>外部キー</em>と呼ばれます。Userモデルオブジェクトの外部キーが<code>user_id</code>の場合、Railsは自動的に関連付けを推測します。つまり、Railsはデフォルトで、<code>&lt;クラス&gt;_id</code>という形式の外部キーがあることを期待します。ここで<code>&lt;クラス&gt;</code>は小文字のクラス名です<sup class="footnote" id="fnref-11_5"><a href="./following-users.html#fn-11_5">5</a></sup>。ここではユーザー (users) を扱っていますが、このユーザーは (user_idではなく) 外部キーである<code>follower_id</code>によって特定されるので、<a class="ref" href="./following-users.html#code-user_relationships_association">リスト11.4</a>のようにそのことを明示的にRailsに伝える必要があります<sup class="footnote" id="fnref-11_6"><a href="./following-users.html#fn-11_6">6</a></sup>。</p>

<div class="label" id="code-user_relationships_association"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.4</span> <span class="description">ユーザー/リレーションシップの<code>has_many</code>の関連付けを実装する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(ユーザーを削除したら、ユーザーのリレーションシップも同時に削除される必要があります。そのため、関連付けに<code>dependent: :destroy</code>を追加してあります。この部分のテストは演習に回します (<a class="ref" href="./following-users.html#sec-following_exercises">11.5</a>)。)</p>

<p>Micropostモデルの場合と同様、Relationshipモデルはユーザーと<code>belongs_to</code> (属する) の関係を持ちます。この場合、リレーションシップのオブジェクトは<code>follower</code>と<code>followed user</code>の両方に「属します」。<a class="ref" href="./following-users.html#code-relationships_belongs_to_test">リスト11.5</a>でこれをテストします。</p>

<div class="label" id="code-relationships_belongs_to_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.5</span> <span class="description">ユーザー/リレーションシップの<code>belongs_to</code>関連付けをテストする。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;follower methods&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">follower</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">followed</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これに対応するアプリケーションコードを作成するには、<code>belongs_to</code>リレーションシップを普段と同様に作成します。Railsは外部キーを、それに対応するシンボルから推測します。たとえば、<code>:follower</code>から<code>follower_id</code>を推測し、<code>:followed</code>から<code>followed_id</code>を推測するという具合です。しかし、FollowedモデルもFollowerモデルも実際にはないので、クラス名<code>User</code>を提供する必要があります。結果を<a class="ref" href="./following-users.html#code-relationship_belongs_to">リスト11.6</a>に示します。デフォルトで作成されるRelationshipモデルとは異なり、<code>followed_id</code>のみアクセス可能となっている点に注意してください。</p>

<div class="label" id="code-relationship_belongs_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.6</span> <span class="description"><code>belongs_to</code>関連付けを Relationshipモデルに追加する。</span><br /><span class="description"> <code>app/models/relationship.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>実際には、<code>followed</code>の関連付けは<a class="ref" href="./following-users.html#sec-followers">11.1.5</a>まで使用しません。しかしfollower/followed構造を両方作り、これらを同時に実装する方が理解しやすくなります。</p>

<p>この時点で、<a class="ref" href="./following-users.html#code-relationship_create_test">リスト11.2</a>のテストと<a class="ref" href="./following-users.html#code-user_relationships_method_test">リスト11.3</a>のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-relationship_validations"></div>


<h3><a id="sec-11_1_3" href="./following-users.html#sec-relationship_validations" class="heading"><span class="number">11.1.3</span>検証</a></h3>


<p>先に進む前に、Relationshipモデルの検証を追加して完全なものにしておきましょう。テスト (<a class="ref" href="./following-users.html#code-relationship_validation_tests">リスト11.7</a>)とアプリケーションコード (<a class="ref" href="./following-users.html#code-relationship_validations">リスト11.8</a>) は素直な作りです。</p>

<div class="label" id="code-relationship_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.7</span> <span class="description">Relationshipモデル検証のテスト。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when followed id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when follower id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-relationship_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.8</span> <span class="description">Relationshipモデルの検証を追加する。</span><br /><span class="description"> <code>app/models/relationship.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-following"></div>


<h3><a id="sec-11_1_4" href="./following-users.html#sec-following" class="heading"><span class="number">11.1.4</span>フォローしているユーザー </a></h3>


<p>いよいよRelationship関連付けの核心、<code>followed_users</code>と<code>followers</code>に取りかかります。まずは<code>followed_users</code>から始めます (<a class="ref" href="./following-users.html#code-user_following_test">リスト11.9</a>)。</p>

<div class="label" id="code-user_following_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.9</span> <span class="description"><code>user.followed_users</code>属性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この実装では、最初から<code>has_many through</code>を使用します。<a class="ref" href="./following-users.html#fig-user_has_many_following">図11.7</a>のように、1人のユーザーにはいくつもの「フォロー<em>する/される</em> (多対多)」のリレーションシップがあります。デフォルトの<code>has_many through</code>関連付けでは、Railsは単一バージョンの関連付けに対応する外部キーを探します。つまり以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span>
</pre></div>
</div>


<p><code>relationships</code>テーブルの<code>followed_id</code>を使用して配列を作成します。ただし、<a class="ref" href="./following-users.html#sec-a_problem_with_the_data_model">11.1.1</a>でも指摘したとおり、<code>user.followeds</code>とすると英語の感覚として非常に見苦しくなってしまいますので、&quot;followed&quot;を複数形にするには “followed users” とuserを追加してそれを複数形にする方がずっと自然です。従って、フォローしているユーザーの配列を表すために<code>user.followed_users</code>と書くことにします。Railsではデフォルトをオーバーライドすることができるので、ここでは<code>:source</code>パラメーター (<a class="ref" href="./following-users.html#code-has_many_following_through_relationships">リスト11.10</a>) を使用し、<code>followed_users</code>配列の元は<code>followed</code> idの集合であることを明示的にRailsに伝えます。</p>

<div class="label" id="code-has_many_following_through_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.10</span> <span class="description">Userモデルの<code>followed_users</code>関連付けを追加する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザーをフォローするというリレーションシップを作成するために、<code>follow!</code>ユーティリティメソッドを導入し、<code>user.follow!(other_user)</code>と書けるようにしましょう (この<code>follow!</code>メソッドは常に正常に動作しなければなりません。従って、<code>create!</code>メソッドや<code>save!</code>メソッドと同様、末尾に感嘆符を置いて、作成に失敗した場合には例外を発生することを示します) 。さらに、これに関連する<code>following?</code>論理値メソッドも追加し、あるユーザーが誰かをフォローしているかどうかを確認できるようにします<sup class="footnote" id="fnref-11_7"><a href="./following-users.html#fn-11_7">7</a></sup>。これらのメソッドの実際の使用例を<a class="ref" href="./following-users.html#code-utility_method_tests">リスト11.11</a>に示します。</p>

<div class="label" id="code-utility_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.11</span> <span class="description">“フォロー用の” ユーティリティメソッドをいくつかテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このアプリケーションコードでは、<code>following?</code>メソッドは<code>other_user</code>という1人のユーザーを引数にとり、フォローする相手のユーザーがデータベース上に存在するかどうかをチェックします。<code>follow!</code>メソッドは、<code>relationships</code>関連付けを経由して<code>create!</code>を呼び出すことで、「フォローする」のリレーションシップを作成します。このコードを<a class="ref" href="./following-users.html#code-following_p_follow_bang">リスト11.12</a>に示します。</p>

<div class="label" id="code-following_p_follow_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.12</span> <span class="description"><code>following?</code>ユーティリティメソッド</span><span class="description">と<code>follow!</code></span><span class="description"> </span><span class="description">ユーティリティメソッド</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./following-users.html#code-following_p_follow_bang">リスト11.12</a>では、ユーザー自身を明示的には書かず、単に以下のように書いています。</p>

<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>以下は、上と同等のコードです。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p><code>self</code>を明示的に書くかどうかは好みの問題です。</p>

<p>ユーザーは他のユーザーをフォローできるだけでなく、フォロー解除もできる必要があります。当然、<a class="ref" href="./following-users.html#code-user_unfollow_test">リスト11.13</a>に示したような<code>unfollow!</code>メソッドが必要になります<sup class="footnote" id="fnref-11_8"><a href="./following-users.html#fn-11_8">8</a></sup>。</p>

<div class="label" id="code-user_unfollow_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.13</span> <span class="description">ユーザーのフォロー解除をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;and unfollowing&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>unfollow!</code>のコードは実に簡単です。フォローしているユーザーのidでリレーションシップを検索し、それを削除すればよいのです (<a class="ref" href="./following-users.html#code-user_unfollow">リスト11.14</a>)。</p>

<div class="label" id="code-user_unfollow"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.14</span> <span class="description">ユーザーのリレーションシップを削除してフォロー解除する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-followers"></div>


<h3><a id="sec-11_1_5" href="./following-users.html#sec-followers" class="heading"><span class="number">11.1.5</span>フォロワー</a></h3>


<p>リレーションシップというパズルの最後の一片は、<code>user.followers</code>メソッドを追加することです。これは上の<code>user.followed_users</code>メソッドと対になります。<a class="ref" href="./following-users.html#fig-user_has_many_following">図11.7</a>を見ていて気付いた方もいると思いますが、フォロワーの配列をデプロイするために必要な情報は、<code>relationships</code>テーブルに既にあります。実は、<code>follower_id</code>と<code>followed_id</code>を入れ替えるだけで、フォロワーについてもユーザーのフォローのときとまったく同じ方法が使用できます。ということは、何らかの方法で2つのカラムを入れ替えた<code>reverse_relationships</code>テーブルを用意することができれば (<a class="ref" href="./following-users.html#fig-user_has_many_followers">図11.9</a>)、<code>user.followers</code>を最小限の手間で実装できることになります。</p>

<div class="label" id="fig-user_has_many_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_has_many_followers_2nd_ed.png" alt="user_has_many_followers_2nd_ed" /></span></div><div class="caption"><span class="header">図11.9</span><span class="description">Relationshipモデルのカラムを入れ替えて作った、フォロワーのモデル。</span></div></div>


<p>Railsが魔法で何とかしてくれることを期待して、このテストを作成しましょう (<a class="ref" href="./following-users.html#code-reverse_relationships_test">リスト11.15</a>)。</p>

<div class="label" id="code-reverse_relationships_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.15</span> <span class="description">逆リレーションシップをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed user&quot;</span> <span class="k">do</span>
      <span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>subject</code>メソッドを使用して<code>@user</code>から<code>other_user</code>に対象を切り替えていることで、フォロワーのリレーションシップのテストを自然に実行できていることに注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>もちろん、逆リレーションシップのためにわざわざデータベーステーブルを1つ余分に作成するようなことはしません。代わりに、フォロワーとフォローしているユーザーの関係が対称的であることを利用し、単に<code>followed_id</code>を主キーとして渡すことで<code>reverse_relationships</code>をシミュレートすればよいのです。つまり、この<code>relationships</code>関連付けでは以下のように<code>follower_id</code>を外部キーとして使用し、</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span>
</pre></div>
</div>


<p><code>reverse_relationships</code>では以下のように<code>followed_id</code>を外部キーとして使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span>
</pre></div>
</div>


<p>これにより、<a class="ref" href="./following-users.html#code-user_reverse_relationships">リスト11.16</a>に示したように逆リレーションシップを経由して<code>followers</code>の関連付けを得ることができます。</p>

<div class="label" id="code-user_reverse_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.16</span> <span class="description">逆リレーションシップを使用して<code>user.followers</code>を実装する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                   <span class="ss">class_name:</span>  <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span>
                                   <span class="ss">dependent:</span>   <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(<a class="ref" href="./following-users.html#code-user_relationships_association">リスト11.4</a>のときと同様、<code>dependent :destroy</code>のテストは演習に回します (<a class="ref" href="./following-users.html#sec-following_exercises">11.5</a>)。) 実際には、この関連付けでは以下のように<em>クラス</em>名を明示的に含める必要があることに注意してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                 <span class="ss">class_name:</span> <span class="s2">&quot;Relationship&quot;</span>
</pre></div>
</div>


<p>これを指定しないと、Railsは実在しない<code>ReverseRelationship</code>クラスを探しに行ってしまいます。</p>

<p>ここでは、以下のように<code>:source</code>キーを省略してもよいことにも注意してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span>
</pre></div>
</div>


<p><code>:followers</code>属性の場合、Railsが “followers” を単数形にして自動的に外部キー<code>follower_id</code>を探してくれるからです (:followedではこうはいきません)。上のコードでは、関連付けが<code>has_many :followed_users</code>と同じ形式になることを強調するために、あえて<code>:source</code>キーを付けてありますが、もちろん省略しても構いません。</p>

<p><a class="ref" href="./following-users.html#code-user_reverse_relationships">リスト11.16</a>のコードによって、フォローしているユーザーとフォロワーの関連付けの実装は完了しました。テストもすべてパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>この節は、データモデリングのスキルを向上させるという強い要請に基いて書かれました。時間をかけて身に付けていただければ幸いです。この節で使用されたさまざまな関連付けを理解するのに一番良いのは、次の節で行なっているように実際のWebインターフェイスで使用することです。</p>

<div class="label" id="sec-a_web_interface_for_following_and_followers"></div>


<h2><a id="sec-11_2" href="./following-users.html#sec-a_web_interface_for_following_and_followers" class="heading"><span class="number">11.2</span>フォローしているユーザー用のWebインターフェイス</a></h2>


<p>この章の最初に、フォローしているユーザーのページ表示の流れについて説明しました。この節では、モックアップで示したようにフォロー/フォロー解除の基本的なインターフェイスを実装します。また、フォローしているユーザーと、フォロワーにそれぞれ表示用のページを作成します。<a class="ref" href="./following-users.html#sec-the_status_feed">11.3</a>では、ユーザーのステータスフィードを追加して、サンプルアプリケーションを完成させます。</p>

<div class="label" id="sec-sample_following_data"></div>


<h3><a id="sec-11_2_1" href="./following-users.html#sec-sample_following_data" class="heading"><span class="number">11.2.1</span>フォローしているユーザーのサンプルデータ</a></h3>


<p>1つ前の章のときと同じように、サンプルデータを自動作成するRakeタスクを使用してデータベースにサンプルリレーションシップを登録するのがやはり便利です。先にサンプルデータを自動作成しておけば、Webページの見た目のデザインから先にとりかかることができ、バックエンドの機能の実装をこの節の後に回すことができます。</p>

<p>前回<a class="ref" href="./user-microposts.html#code-sample_microposts">リスト10.20</a>,で自動生成したサンプルデータは少々いい加減でしたので、今回はまずユーザーとマイクロポストを作成するためのメソッドをそれぞれ別々に定義し、それから新しく<code>make_relationships</code>メソッドを作成してサンプルリレーションシップを追加することにしましょう。作成したRakeファイルを<a class="ref" href="./following-users.html#code-sample_relationships">リスト11.17</a>に示します。</p>

<div class="label" id="code-sample_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.17</span> <span class="description">フォローしている、またはフォローされている関係を表すリレーションシップをサンプルデータに追加する。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                       <span class="ss">email:</span>    <span class="s2">&quot;example@railstutorial.jp&quot;</span><span class="p">,</span>
                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                       <span class="ss">admin:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.jp&quot;</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">email:</span>    <span class="n">email</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードのうち、サンプルリレーションシップを作成する部分は以下です。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>ここでは、最初のユーザーにユーザー3からユーザー51までをフォローさせ、それから逆にユーザー4からユーザー41に最初のユーザーをフォローさせます。ソースを見るとわかるように、このような設定を自由に行うことができます。こうしてリレーションシップを作成しておけば、アプリケーションのインターフェイスを開発するには十分です。</p>

<p><a class="ref" href="./following-users.html#code-sample_relationships">リスト11.17</a>を実行するために、いつものように以下を実行してデータベース上にデータを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>




<div class="label" id="sec-stats_and_a_follow_form"></div>


<h3><a id="sec-11_2_2" href="./following-users.html#sec-stats_and_a_follow_form" class="heading"><span class="number">11.2.2</span>統計とフォロー用フォーム</a></h3>


<p>これでサンプルユーザーに、フォローしているユーザーの配列とフォロワーの配列ができました。ユーザープロファイルページとHomeページを更新してこれを反映しましょう。最初に、プロファイルページとHomeページに、フォローしているユーザーとフォロワーの統計情報を表示するためのパーシャルを作成します。次に、フォロー用とフォロー解除用のフォームを作成します。それから、フォローしているユーザーとフォロワーの一覧を表示する専用のページを作成します。</p>

<p><a class="ref" href="./following-users.html#sec-a_problem_with_the_data_model">11.1.1</a>でも述べたとおり、英語の “following” は、属性として使用すると意味が曖昧になります。<code>user.following</code>は、フォローしているユーザーとも、フォロワーとも受け取れてしまいます。しかし、フォローしているユーザーをページに表示するときの “50 following” というラベルになら問題なく使用できます。実際、これはTwitterでも使用されている表示です。<a class="ref" href="./following-users.html#fig-page_flow_profile_mockup">図11.1</a>のモックアップおよび<a class="ref" href="./following-users.html#fig-stats_partial_mockup">図11.10</a>の拡大図を参照してください。</p>

<div class="label" id="fig-stats_partial_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/stats_partial_mockup.png" alt="stats_partial_mockup" /></span></div><div class="caption"><span class="header">図11.10</span><span class="description">統計情報パーシャルのモックアップ。</span></div></div>


<p><a class="ref" href="./following-users.html#fig-stats_partial_mockup">図11.10</a>の統計情報には、現在のユーザーがフォローしている人数と、現在のフォロワーの人数が表示されています。それぞれの表示はリンクになっており、専用の表示ページに移動できます。<a class="ref" href="./filling-in-the-layout.html#top">第5章</a>では、これらのリンクはダミーテキスト<code>’#’</code>を使用して無効にしていました。しかしルーティングについての知識もだいぶ増えてきたので、今回は実装することにしましょう。実際のページ作成は<a class="ref" href="./following-users.html#sec-following_and_followers_pages">11.2.3</a>まで行いませんが、ルーティングは今実装します (<a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>)。このコードでは、<code>resources</code><em>ブロック</em>の内側で<code>:member</code>メソッドを使用しています。これは初登場ですので、どんな動作をするのか推測してみてください。 (<em>注</em>: <a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>のコードは <code>resources :users</code>を<em>置き換えます</em>)</p>

<div class="label" id="code-following_followers_actions_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.18</span> <span class="description"><code>following</code>および<code>followers</code>アクションをUsersコントローラに追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この場合のURLは/users/1/followingや/users/1/followersのようになるのではないかと推測した方もいると思います。そして、<a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>のコードはまさにそれを行なっているのです。どちらのページもデータを表示するものなので、(RESTの慣習に基いて) <tt>GET</tt>リクエストに応答するために<code>get</code>を使用してURLを生成します。<code>member</code>メソッドは、ユーザーidを含むURLにそのルート (route) が応答できるようにするものです。idを指定せずにすべてのメンバーを表示するには、以下のように<code>collection</code>を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコードは/users/tigersというURLに応答します (アプリケーションにあるすべてのtigerのリストを表示します)。 Railsにはさまざまなルーティングオプションがありますが、詳細についてはRailsガイドの記事「<a href="http://railsguides.jp/routing.html">Rails ルーティング</a>」を参照してください。<a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>によって生成されるルーティングテーブルを<a class="ref" href="./following-users.html#table-following_routes">表11.1</a>に示します。ここにある、フォローしているユーザー用とフォロワー用の名前付きルートをこの後使用します。曖昧さのない「フォローしているユーザー (followed users)」と、Twitter式の「フォローしている (following)」表示を両方採用しましたが、このルーティングでは仕組み上残念ながら曖昧な方の &quot;following&quot; を使用せざるを得ません。曖昧でない &quot;followed users&quot; のままだと、ルートは<code>followed_users_user_path</code>という英語として見苦しいものになるため、<a class="ref" href="./following-users.html#table-following_routes">表11.1</a>で<code>following_user_path</code>が生成されるように調整しました。</p>

<div class="label" id="table-following_routes"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>名前付きルート</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/following</td><td class="align_left"><code>following</code></td><td class="align_left"><code>following_user_path(1)</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/followers</td><td class="align_left"><code>followers</code></td><td class="align_left"><code>followers_user_path(1)</code></td></tr></table></div><div class="caption"><span class="header">表11.1</span><span class="description"><a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>のリソースのカスタムルールで提供されるRESTfulなルート</span></div></div>


<p>ルーティングが定義されたことで、統計情報パーシャルをテストできる状態になりました (最初にテストを書いてもよかったのですが、ルーティングを更新しておかないと名前付きルートの説明がしにくかったので、テストを後にしました) 。この統計情報パーシャルはプロファイルページとHomeページの両方に表示されます。<a class="ref" href="./following-users.html#code-stats_view_test">リスト11.19</a>では、後者のHomeページの方でテストしています。</p>

<div class="label" id="code-stats_view_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.19</span> <span class="description">Homeページ上の、フォローしているユーザー/フォロワーの統計情報をテストする。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Ipsum&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;follower/following counts&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">root_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストの中心となるのは、フォローしているユーザーとフォロワーのカウントがページに表示され、それぞれに正しいURLが設定されていることを確認することです。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>ここでは、<a class="ref" href="./following-users.html#table-following_routes">表11.1</a>の名前付きルートを使用して、正しいアドレスへのリンクを確認していることに注目してください。また、ここでは “followers” という語は<em>ラベル</em>として使用しているので、フォロワーが1人の場合にも複数形のままとします。</p>

<p>統計情報パーシャルのアプリケーションコードは、<a class="ref" href="./following-users.html#code-stats_partial">リスト11.20</a>に示したとおり、単なる divタグ内のリンクです。</p>

<div class="label" id="code-stats_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.20</span> <span class="description">フォローしているユーザーとフォロワーの統計情報を表示するパーシャル。</span><br /><span class="description"> <code>app/views/shared/_stats.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;stats&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;followers&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>このパーシャルはユーザー表示ページとHomeページの両方に表示されるので、<a class="ref" href="./following-users.html#code-stats_partial">リスト11.20</a>の最初の行では、以下のコードを使用して適切な方を選択しています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-in-sign-out.html#sidebar-or_equals">コラム 8.2</a>でも説明したとおり、<code>@user</code>が <code>nil</code>でない場合 (つまりプロファイルページの場合) は何もせず、nilの場合 (つまりHomeページの場合) には<code>@user</code>にカレントユーザーを設定します。</p>

<p>フォローしているユーザーの人数と、フォロワーの人数は、以下の関連付けを使用して計算されます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>上と、以下を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p><a class="ref" href="./user-microposts.html#code-user_show_microposts">リスト10.17</a>のマイクロポストのコードと比較してみましょう。あのときは以下のように書きました。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>このコードを使用してマイクロポストをカウントします。</p>

<p>一部の要素で、以下のようにCSS idを指定していることにもぜひ注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div>
</div>


<p>こうしておくと、<a class="ref" href="./following-users.html#sec-a_working_follow_button_with_ajax">11.2.5</a>でAjaxを実装するときに便利です。そこでは、一意のidを指定してページ要素にアクセスしています。</p>

<p>統計情報パーシャルができあがりました。Homeページにこの統計情報を表示するのは、<a class="ref" href="./following-users.html#code-home_page_stats">リスト11.21</a>のように簡単にできます (これにより、<a class="ref" href="./following-users.html#code-stats_view_test">リスト11.19</a>のテストにもパスするようになります)。</p>

<div class="label" id="code-home_page_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.21</span> <span class="description">フォロワーの統計情報をHomeページに追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>統計情報にスタイルを与えるために、<a class="ref" href="./following-users.html#code-stats_css">リスト11.22</a>のようにSCSSを追加しましょう (なお、このSCSSにはこの章で使用するスタイルがすべて含まれています)。スタイル追加の結果を<a class="ref" href="./following-users.html#fig-home_page_follow_stats">図11.11</a>に示します。</p>

<div class="label" id="code-stats_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.22</span> <span class="description">Homeページのサイドバー用SCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.stats</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.user_avatars</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_page_follow_stats"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_page_follow_stats_bootstrap.png" alt="home_page_follow_stats_bootstrap" /></span></div><div class="caption"><span class="header">図11.11</span><span class="description">Homeページ (<a href="http://localhost:3000/">/</a>) にフォロー関連の統計情報を表示する。<a href="../images/figures/home_page_follow_stats_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この後すぐ、プロファイルにも統計情報パーシャルを表示しますが、今のうちに<a class="ref" href="./following-users.html#code-follow_form_partial">リスト11.23</a>のようにフォロー/フォロー解除ボタン用のパーシャルも作成しましょう。</p>

<div class="label" id="code-follow_form_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.23</span> <span class="description">フォロー/フォロー解除ボタン用のパーシャル。</span><br /><span class="description"> <code>app/views/users/_follow_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;follow_form&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;unfollow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>このコードは、<code>follow</code>と<code>unfollow</code>のパーシャルに作業を振っているだけです。パーシャルでは、Relationshipsリソース用のルールを含む新しいルートが必要です。これを、<a class="ref" href="./user-microposts.html#code-microposts_resource">リスト10.22</a>のMicropostsリソースの例に従って作成しましょう (<a class="ref" href="./following-users.html#code-relationships_resource">リスト11.24</a>)。</p>

<div class="label" id="code-relationships_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.24</span> <span class="description">ユーザーのリレーションシップ用のルートを追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>follow/unfollowパーシャル自体は、<a class="ref" href="./following-users.html#code-follow_form">リスト11.25</a>と<a class="ref" href="./following-users.html#code-unfollow_form">リスト11.26</a>に示します。</p>

<div class="label" id="code-follow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.25</span> <span class="description">ユーザーをフォローするフォーム。</span><br /><span class="description"> <code>app/views/users/_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-unfollow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.26</span> <span class="description">ユーザーをフォロー解除するフォーム。</span><br /><span class="description"> <code>app/views/users/_unfollow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span>.id<span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>これらの2つのフォームでは、いずれも<code>form_for</code>を使用してRelationshipモデルオブジェクトを操作しています。これらの2つのフォームの主な違いは、<a class="ref" href="./following-users.html#code-follow_form">リスト11.25</a>は<em>新しい</em>リレーションシップを作成するのに対し、<a class="ref" href="./following-users.html#code-unfollow_form">リスト11.26</a>は既存のリレーションシップを見つけ出すという点です。すなわち、前者は<tt>POST</tt>リクエストを Relationshipsコントローラに送信してリレーションシップを<code>create</code> (作成) し、後者は<tt>DELETE</tt>リクエストを送信してリレーションシップを<code>destroy</code> (削除) するということです (これらのアクションは<a class="ref" href="./following-users.html#sec-a_working_follow_button_the_standard_way">11.2.4</a>で実装します)。最終的に、このfollow/unfollowフォームにはボタンしかないことを理解していただけたと思います。しかし、それでもこのフォームは<code>followed_id</code>をコントローラに送信する必要があります。これを行うために、<a class="ref" href="./following-users.html#code-follow_form">リスト11.25</a>の<code>hidden_field</code>メソッドを使用します。このメソッドは 以下のフォームのHTMLを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;followed_relationship_followed_id&quot;</span>
<span class="na">name=</span><span class="s">&quot;followed_relationship[followed_id]&quot;</span>
<span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>この「隠れた」<code>input</code>タグは、関連する情報をページに置きながら、それらをブラウザ上で非表示にします。</p>

<p>これで、<a class="ref" href="./following-users.html#code-user_follow_form_profile_stats">11.27</a>のようにフォロー用のフォームをユーザープロファイルページにインクルードしてパーシャルを出力できるようになりました。 プロファイルには、<a class="ref" href="./following-users.html#fig-profile_follow_button">図11.12</a>および<a class="ref" href="./following-users.html#fig-profile_unfollow_button">図11.13</a>のようにそれぞれ [Follow]、[Unfollow] ボタンが表示されます。</p>

<div class="label" id="code-user_follow_form_profile_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.27</span> <span class="description">ユーザープロファイルページにフォロー用のフォームとフォロワーの統計情報を追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow_form&#39;</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig-profile_follow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_follow_button_bootstrap.png" alt="profile_follow_button_bootstrap" /></span></div><div class="caption"><span class="header">図11.12</span><span class="description">あるユーザープロファイル (<a href="http://localhost:3000/users/2">/users/2</a>) に [Follow] ボタンが表示されている。 <a href="../images/figures/profile_follow_button_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-profile_unfollow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_unfollow_button_bootstrap.png" alt="profile_unfollow_button_bootstrap" /></span></div><div class="caption"><span class="header">図11.13</span><span class="description">あるユーザープロファイル (<a href="http://localhost:3000/users/8">/users/6</a>) に [Unfollow] ボタンが表示されている。<a href="../images/figures/profile_unfollow_button_bootstrap-full.png">(拡大)</a></span></div></div>


<p>これらのボタンはもうすぐ動作するようになります。実はこのボタンの実装には2とおりの方法があります。1つは標準的な方法 (<a class="ref" href="./following-users.html#sec-a_working_follow_button_the_standard_way">11.2.4</a>)、もう1つはAjaxを使用する方法 (<a class="ref" href="./following-users.html#sec-a_working_follow_button_with_ajax">11.2.5</a>) です。でもその前に、フォローしているユーザーとフォロワーを表示するページをそれぞれ作成してHTMLインターフェイスを完成させてしまいましょう。</p>

<div class="label" id="sec-following_and_followers_pages"></div>


<h3><a id="sec-11_2_3" href="./following-users.html#sec-following_and_followers_pages" class="heading"><span class="number">11.2.3</span>「フォローしているユーザー」ページと「フォロワー」ページ</a></h3>


<p>フォローしているユーザーを表示するページと、フォロワーを表示するページは、いずれもユーザープロファイルページとユーザーインデックスページ (<a class="ref" href="./updating-showing-and-deleting-users.html#sec-user_index">9.3.1</a>) を合わせたような作りになるという点で似ています。どちらにもフォローの統計情報などのユーザー情報を表示するサイドバーと、ユーザーのリストがあります。さらに、サイドバーにはユーザープロファイル画像のリンクを格子状に並べて表示する予定です。この要求に合うモックアップを<a class="ref" href="./following-users.html#fig-following_mockup">図11.14</a> (フォローしているユーザー用) および <a class="ref" href="./following-users.html#fig-followers_mockup">図 11.15</a> (フォロワー用) に示します。</p>

<div class="label" id="fig-following_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/following_mockup_bootstrap.png" alt="following_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.14</span><span class="description">フォローしているユーザー用ページのモックアップ。<a href="../images/figures/following_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-followers_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/followers_mockup_bootstrap.png" alt="followers_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.15</span><span class="description">ユーザーのフォロワー用ページのモックアップ。<a href="../images/figures/followers_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>ここでの最初の作業は、フォローしているユーザーのリンクとフォロワーのリンクを動くようにすることです。Twitterにならい、どちらのページでもユーザーのサインインを要求します。 このテストは<a class="ref" href="./following-users.html#code-following_followers_authorization_test">11.28</a>のように行います。ユーザーがサインインしたら、どちらのページにもフォローしているユーザー用リンクとフォロワー用リンクを表示します。このテストは<a class="ref" href="./following-users.html#code-following_followers_tests">リスト11.29</a>のように行います。</p>

<div class="label" id="code-following_followers_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.28</span> <span class="description">フォローしているユーザー用ページとフォロワー用ページでの認可をテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the following page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the followers page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-following_followers_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.29</span> <span class="description"><code>followed_users</code>ページと<code>followers</code>ページをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following/followers&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed users&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Following&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Following&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;followers&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">other_user</span>
        <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Followers&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Followers&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この実装には1つだけトリッキーな部分があります。Usersコントローラに2つの新しいアクションを追加する必要があるのですが、これは<a class="ref" href="./following-users.html#code-following_followers_actions_routes">リスト11.18</a>で定義した2つのルートにもとづいており、これらはそれぞれ<code>following</code>および<code>followers</code>と呼ぶ必要があります。それぞれのアクションでは、タイトルを設定し、ユーザーを検索し、<code>@user.followed_users</code>または<code>@user.followers</code>からデータを取り出し、ページネーションを行なって、ページを出力する必要があります。作成したアクションを<a class="ref" href="./following-users.html#code-following_followers_actions">リスト11.30</a>に示します。</p>

<div class="label" id="code-following_followers_actions"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.30</span> <span class="description"><code>following</code>アクションと<code>followers</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span>
                <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Following&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Followers&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これらのアクションでは、<code>render</code>を<em>明示的に</em>呼び出していることに注意してください。ここでは、作成の必要な<code>show_follow</code>というビューを出力しています。renderで呼び出しているビューが同じである理由は、このERbはどちらの場合でもほぼ同じであり、<a class="ref" href="./following-users.html#code-show_follow_view">リスト11.31</a>で両方の場合をカバーできるためです。</p>

<div class="label" id="code-show_follow_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.31</span> <span class="description">フォローしているユーザーの表示とフォロワーの表示の両方に使用する<code>show_follow</code>ビュー。</span><br /><span class="description"> <code>app/views/users/show_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;user_avatars&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。画面も、<a class="ref" href="./following-users.html#fig-user_following">図11.16</a> (フォローしているユーザー) および <a class="ref" href="./following-users.html#fig-user_followers">図11.17</a> (フォロワー) のようになるはずです。</p>

<div class="label" id="fig-user_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_following_bootstrap.png" alt="user_following_bootstrap" /></span></div><div class="caption"><span class="header">図11.16</span><span class="description">現在のユーザーにフォローされているユーザーを表示する。<a href="../images/figures/user_following_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-user_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_followers_bootstrap.png" alt="user_followers_bootstrap" /></span></div><div class="caption"><span class="header">図11.17</span><span class="description">現在のユーザーのフォロワーを表示する。<a href="../images/figures/user_followers_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_working_follow_button_the_standard_way"></div>


<h3><a id="sec-11_2_4" href="./following-users.html#sec-a_working_follow_button_the_standard_way" class="heading"><span class="number">11.2.4</span>[フォローする] ボタン (標準的な方法)</a></h3>


<p>ビューが整ってきました。いよいよ [フォローする] [フォロー解除する] ボタンを動作させましょう。これらのボタンのテストには、本書で扱ったさまざまなテスティングの技法が集約されています。このテストコードを読むのはよい練習になります。<a class="ref" href="./following-users.html#code-follow_unfollow_button_tests">リスト11.32</a>の内容をじっくり勉強し、テスト内容とその目的をすべて理解できるようにしてください (<a class="ref" href="./following-users.html#code-follow_unfollow_button_tests">リスト11.32</a>のコードには実は若干のセキュリティ上の抜けがあります。皆さんは見つけることができるでしょうか。この点についてはこの後でカバーします)。このコードにおける<code>have_xpath</code>メソッドの使用法に注目してください。 これは、<a href="http://ja.wikipedia.org/wiki/XPath">XPath</a>を使用してHTML5を含むXMLドキュメントを自在にナビゲートすることのできる、極めて高度かつパワフルなテクニックです。Web検索でXPathを使用する方法の詳細については<a href="http://www.w3schools.com/xpath/xpath_syntax.asp">XPath構文</a> (英語) を参照してください。</p>

<div class="label" id="code-follow_unfollow_button_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.32</span> <span class="description">Follow/Unfollowボタンをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;follow/unfollow buttons&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;following a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">&quot;//input[@value=&#39;Unfollow&#39;]&quot;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;unfollowing a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">&quot;//input[@value=&#39;Follow&#39;]&quot;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./following-users.html#code-follow_unfollow_button_tests">リスト11.32</a>は、これらのボタンをクリックし、そのときの正しい動作を指定することによりテストを行います。この実装を書くには、正しい動作をより深く理解する必要があります。フォローすることとフォロー解除することは、それぞれリレーションシップを<em>作成</em>することと<em>削除</em>することです。これはつまり、Relationshipsコントローラで<code>create</code>アクションと<code>destroy</code>を定義するということであり、このコントローラを作成する必要があります。これらのボタンはユーザーがサインインしていないと表示されないので一見セキュリティを満たしているように見えますが、<a class="ref" href="./following-users.html#code-follow_unfollow_button_tests">リスト11.32</a>には、ある低レベルの問題が抜けています。つまり、<code>create</code>アクションと<code>destroy</code>アクションはサインインしているユーザーのみがアクセスできることを確認するテストがありません (これが上で述べたセキュリティホールです) 。<a class="ref" href="./following-users.html#code-relationships_controller_authorization_test">リスト11.33</a>では、<code>post</code>メソッドと<code>delete</code>メソッドを使用してこれらのアクションに直接アクセスすることによって、この要求を満たすようにしました。</p>

<div class="label" id="code-relationships_controller_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.33</span> <span class="description">Relationshipsコントローラの認可をテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Relationships controller&quot;</span> <span class="k">do</span>
        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">relationships_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>すぐ削除されるので事実上意味のないRelationshipオブジェクトをわざわざ作成することによるオーバーヘッドを回避するために、<code>delete</code>テストでは名前付きルートにid <code>1</code>をハードコードしてあります。</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>ユーザーがリダイレクトされた後で、アプリケーションがこのidでリレーションシップを取り出すので、このコードは動作します。</p>

<p>上のテストにパスするための以下のコントローラのコードは、驚くほど簡潔です。単に、フォローしているユーザーまたはこれからフォローするユーザーを取り出し、関連するユーティリティメソッドを使用してそれらをフォローまたはフォロー解除しているだけです。すべての実装を<a class="ref" href="./following-users.html#code-relationships_controller">リスト11.34</a>に示します。</p>

<div class="label" id="code-relationships_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.34</span> <span class="description">Relationshipsコントローラ。</span><br /><span class="description"> <code>app/controllers/relationships_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./following-users.html#code-relationships_controller">リスト11.34</a>を見てみれば、先ほどのセキュリティ問題が実はそれほど重大なものではないことを理解いただけると思います。もしサインインしていないユーザーが (<tt>curl</tt>などのコマンドラインツールなどを使用して) これらのアクションに直接アクセスするようなことがあれば、<code>current_user</code>は<code>nil</code>になり、どちらのメソッドでも2行目で例外が発生します。エラーにはなりますが、アプリケーションやデータに影響は生じません。このままでも支障はありませんが、やはりこのような例外には頼らない方がよいので、上ではひと手間かけてセキュリティのためのレイヤーを追加しました。</p>

<p>これで、フォロー/フォロー解除の機能が完成しました。どのユーザーも、他のユーザーをフォローしたり、フォロー解除したりできます。サンプルアプリケーションを実際に動かしてみたり、以下のようにテストスイートを実行することで動作を確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-a_working_follow_button_with_ajax"></div>


<h3><a id="sec-11_2_5" href="./following-users.html#sec-a_working_follow_button_with_ajax" class="heading"><span class="number">11.2.5</span>[フォローする] ボタン (Ajax)</a></h3>


<p>フォロー関連の機能の実装はこのとおり完了しましたが、ステータスフィードに取りかかる前にもう一つだけ機能を洗練させてみたいと思います。<a class="ref" href="./following-users.html#sec-a_working_follow_button_the_standard_way">11.2.4</a>では、Relationshipsコントローラの<code>create</code>アクションと <code>destroy</code>アクションを単に<em>元の</em>プロファイルにリダイレクトしていました。つまり、ユーザーはプロファイルページを最初に表示し、それからユーザーをフォローし、その後すぐ元のページにリダイレクトされるという流れになります。ユーザーをフォローした後、本当にそのページから離れて元のページに戻らないといけないのでしょうか。この点を考えなおしてみましょう。</p>

<p>これは<em>Ajax</em>を使用することで解決できます。Ajaxを使用すれば、Webページからサーバーに「非同期」で、ページを移動することなくリクエストを送信することができます<sup class="footnote" id="fnref-11_9"><a href="./following-users.html#fn-11_9">9</a></sup>。WebフォームにAjaxを採用するのは今や当たり前になりつつあるので、RailsでもAjaxを簡単に実装できるようになっています。フォロー用とフォロー解除用のフォームパーシャルをこれに沿って更新するのは簡単です。以下のコードがあるとします。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>たったこれだけで、Railsは<a href="http://catb.org/jargon/html/A/automagically.html">自動的に</a>Ajaxを使用します<sup class="footnote" id="fnref-11_10"><a href="./following-users.html#fn-11_10">10</a></sup>。更新の結果を<a class="ref" href="./following-users.html#code-follow_form_ajax">リスト11.35</a>と<a class="ref" href="./following-users.html#code-unfollow_form_ajax">リスト11.36</a>に示します。</p>

<div class="label" id="code-follow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.35</span> <span class="description">フォロー用のフォームでAjaxを使用する。</span><br /><span class="description"> <code>app/views/users/_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-unfollow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.36</span> <span class="description">フォロー解除用のフォームでAjaxを使用する。</span><br /><span class="description"> <code>app/views/users/_unfollow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span>.id<span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ERbによって実際に生成されるHTMLはそれほど重要ではありませんが、興味がある方のために、以下の核心部分をお見せします。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/relationships/117&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_relationship&quot;</span> <span class="na">data-remote=</span><span class="s">&quot;true&quot;</span>
      <span class="na">id=</span><span class="s">&quot;edit_relationship_117&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>


<p>ここでは、formタグの内部で<code>data-remote=&quot;true&quot;</code>変数を設定しています。これは、JavaScriptによるフォーム操作を許可することをRailsに知らせるためのものです。以前のRailsでは完全なJavaScriptコードを挿入していましたが、Rails 3からは、このようにHTMLプロパティを使用して簡単にJavaScriptを使用できます。これは、<a href="http://railscasts.com/episodes/205-unobtrusive-javascript"><em>JavaScriptを前面に出すべからず</em></a>という哲学に従っています。</p>

<p>フォームの更新が終わったので、今度はこれに対応するRelationshipsコントローラを改造して、Ajaxリクエストに応答できるようにしましょう。実は、Ajaxを使用するとテスティングがかなりトリッキーになってしまいます。Ajaxのテストはそれだけで大きなテーマなので、本格的に説明しようとすると本書の範囲を超えてしまいます。ここでは<a class="ref" href="./following-users.html#code-relationships_controller_spec_ajax">リスト11.37</a>のテストを使用しましょう。ここでは<code>xhr</code>メソッド (“XmlHttpRequest” の略です) を使用してAjaxリクエストを発行しています。以前の、<code>get</code>、<code>post</code>、<code>patch</code>、<code>delete</code>メソッドを使用したテストと比べてみてください。それから、Ajaxリクエストを受信したときに<code>create</code>アクションと<code>destroy</code>アクションが正常に動作することを確認します (Ajaxを多用するアプリケーションを徹底的にテストしたい方は、<a href="http://seleniumhq.org/">Selenium</a>と<a href="http://watir.com/">Watir</a>を参照してみてください)。</p>

<div class="label" id="code-relationships_controller_spec_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.37</span> <span class="description">RelationshipsコントローラがAjaxリクエストに応答することをテストする。</span><br /><span class="description"> <code>spec/controllers/relationships_controller_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">no_capybara:</span> <span class="kp">true</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;creating a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should increment the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;destroying a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span>.id<span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should decrement the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./following-users.html#code-relationships_controller_spec_ajax">リスト11.37</a>のコードは、実は<em>コントローラ</em>用テストとしては初めてのものです。本書の以前の版ではコントローラ用のテストを多用していましたが、現在は結合テストの観点からコントローラ向けのテストは控えています。ただし、どういうわけかこの場合<code>xhr</code>メソッドを結合テストで使用することができないために、このコントローラでのテストを行なっています。<code>xhr</code>は先ほど登場したばかりですが、本書ではひとまずコードの文脈から以下のコードの動作を推測していただくようお願いします。</p>

<div class="code"><div class="highlight"><pre><span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</pre></div>
</div>


<p><code>xhr</code>が取る引数は、関連するHTTPメソッドを指すシンボル、アクションを指すシンボル、またはコントローラ自身にある<code>params</code>の内容を表すハッシュのいずれかです。これまでの例と同様、<code>expect</code>を使用してブロック内の操作をまとめ、関連するカウントを1増やしたり減らしたりするテストを行なっています。</p>

<p>このテストが暗に示しているように、実はこのアプリケーションコードがAjaxリクエストへの応答に使用する<code>create</code>アクションと<code>destroy</code>アクションは、通常のHTTP <tt>POST</tt>リクエストと<tt>DELETE</tt>リクエストに応答するのに使用されるのと同じものです。これらのアクションは、<a class="ref" href="./following-users.html#sec-a_working_follow_button_the_standard_way">11.2.4</a>のようにリダイレクトを伴う通常のHTTPリクエストと、JavaScriptを使用するAjaxリクエストの両方に応答できればよいのです。実際のコントローラのコードを<a class="ref" href="./following-users.html#code-relationships_controller_ajax">リスト11.38</a>に示します。(練習のため、<a class="ref" href="./following-users.html#sec-following_exercises">11.5</a>のコードも見てみてください。このコードは動作は同じですが、よりコンパクトになっています。)</p>

<div class="label" id="code-relationships_controller_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.38</span> <span class="description">RelationshipsコントローラでAjaxリクエストに応答する。</span><br /><span class="description"> <code>app/controllers/relationships_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードでは、リクエストの種類に応じたアクションを実行するために<code>respond_to</code>を使用しています。(注意: ここで使用している<code>respond_to</code>は、RSpecの例で使用している<code>respond_to</code>とは別物です)。この文法は少々変わっていて、混乱を招く可能性があるため、以下のコードの動作を理解するようにしてください。</p>

<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードでは、リクエストの種類に応じて、続く行の中から<em>1つだけ</em>が実行されることに注意してください。</p>

<p>Ajaxリクエストを受信した場合は、Railsが自動的にアクションと同じ名前を持つ<em>JavaScript組み込みRuby</em> (<code>.js.erb</code>) ファイル (<code>create.js.erb</code>や<code>destroy.js.erb</code>など) を呼び出します。ご想像のとおり、これらのファイルではJavaScriptと組み込みRuby (ERb) をミックスして現在のページに対するアクションを実行することができます。ユーザーをフォローしたときやフォロー解除したときにユーザープロファイルページを更新するために、私たちがこれから作成および編集しなければならないのは、まさにこれらのファイルです。</p>

<p>JS-ERbファイルの内部では、Railsが自動的に<a href="http://jquery.com/">jQuery</a> JavaScriptヘルパーを提供します。これにより、<a href="http://www.w3.org/DOM/">DOM (Document Object Model)</a> を使用してページを操作できます。jQueryライブラリにはDOM操作用の膨大なメソッドが提供されていますが、ここで使用するのはわずか2つです。それにはまず、ドル記号 ($) を使用してDOM要素に一意のCSS idでアクセスする文法について知る必要があります。たとえば、<code>follow_form</code>要素を操作するには、以下の文法を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>(<a class="ref" href="./following-users.html#code-follow_form_partial">リスト11.23</a>では、これはフォームを囲む<code>div</code>タグであり、フォームそのものではなかったことを思い出してください。) jQueryの文法はCSSの記法から影響を受けており、<code>#</code>シンボルを使用してCSSのidを指定します。ご想像のとおり、jQueryはCSSと同様、ドット<code>.</code>を使用してCSSクラスを操作できます。</p>

<p>次に必要なメソッドは<code>html</code>です。これは、引数の中で指定された要素の内側にあるHTMLを更新します。たとえば、フォロー用フォーム全体を<code>&quot;foobar&quot;</code>という文字列で置き換えるには、以下を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>純粋なJavaScriptと異なり、JS-ERbファイルでは組み込みRuby (ERb) を使用できます。<code>create.js.erb</code>ファイルでは、フォロー用のフォームを<code>unfollow</code>パーシャルで更新し、フォロワーのカウントを更新するのにERbを使用しています (もちろんこれは、フォローに成功した場合の動作です)。変更の結果を<a class="ref" href="./following-users.html#code-create_js_erb">リスト11.39</a>に示します。このコードでは<code>escape_javascript</code>関数を使用していることに注目してください。この関数は、JavaScriptファイル内にHTMLを挿入するときに実行結果をエスケープする (画面に表示しない) ために必要です。</p>

<div class="label" id="code-create_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.39</span> <span class="description">JavaScript組み込みRubyを使用してフォローのリレーションシップを作成する。</span><br /><span class="description"> <code>app/views/relationships/create.js.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/unfollow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p><code>destroy.js.erb</code>ファイルの方も同様です (<a class="ref" href="./following-users.html#code-destroy_js_erb">リスト11.40</a>)。</p>

<div class="label" id="code-destroy_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.40</span> <span class="description">Ruby JavaScript (RJS) を使用してフォローのリレーションシップを削除する。</span><br /><span class="description"> <code>app/views/relationships/destroy.js.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/follow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>これらのコードにより、ユーザープロファイルを表示して、ページを更新せずにフォローまたはフォロー解除ができるようになったはずです。テストスイートもパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>RailsでAjaxを使用するというテーマは奥が深く、かつ進歩が早いので、本書ではほんの表面をなぞったに過ぎません。しかし、本書の他の題材と同様、今後より高度な資料にあたる際に必要な基礎となるはずです。</p>

<div class="label" id="sec-the_status_feed"></div>


<h2><a id="sec-11_3" href="./following-users.html#sec-the_status_feed" class="heading"><span class="number">11.3</span>ステータスフィード</a></h2>


<p>ついに、サンプルアプリケーションの山頂が目の前に現れました。最後の難関、ステータスフィードの実装に取りかかりましょう。この節で扱われている内容は、本書の中でも最も高度なものです。完全なステータスフィードは、<a class="ref" href="./user-microposts.html#sec-a_proto_feed">10.3.3</a>で扱ったプロトフィードをベースにします。現在のユーザーにフォローされているユーザーのマイクロポストの配列を作成し、現在のユーザー自身のマイクロポストと合わせて表示します。この機能を実現するには、RailsとRubyの高度な機能の他に、SQLプログラミングの技術も必要です。</p>

<p>手強い課題に挑むのですから、ここで実装すべき内容を慎重に見直すことが重要です。<a class="ref" href="./following-users.html#fig-page_flow_home_page_feed_mockup">図11.5</a>でお見せしたステータスフィードの最終形を<a class="ref" href="./following-users.html#fig-home_page_feed_mockup">図11.18</a>に再度掲載します。</p>

<div class="label" id="fig-home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.18</span><span class="description">ステータスフィードが表示されたHomeページのモックアップ。<a href="../images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-motivation_and_strategy"></div>


<h3><a id="sec-11_3_1" href="./following-users.html#sec-motivation_and_strategy" class="heading"><span class="number">11.3.1</span>動機と計画</a></h3>


<p>ステータスフィードの基本的なアイディアはシンプルです。<a class="ref" href="./following-users.html#fig-user_feed">図11.19</a>に、サンプルの<code>microposts</code>データベーステーブルと、それをフィードした結果を示します。図の矢印で示されているように、この目的は、現在のユーザーによってフォローされているユーザーに対応するユーザーidを持つマイクロポストを取り出し、同時に現在のユーザー自身のマイクロポストも一緒に取り出すことです。</p>

<div class="label" id="fig-user_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_feed.png" alt="user_feed" /></span></div><div class="caption"><span class="header">図11.19: </span><span class="description">id 1のユーザーがid 2、7、8、10をフォローしているときのフィード。</span></div></div>


<p>あるユーザーによってフォローされているユーザーのマイクロポストをすべて見つけ出すために、<code>from_users_followed_by</code>というメソッドを実装することを考えてみましょう。このメソッドは、以下のように使用します。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>この時点ではもちろん実装はありませんが、機能を確認するためのテストは作成できます。このテストで重要なことは、フィードに必要な3つの条件を満たすことです。1) フォローしているユーザーのマイクロポストがフィードに含まれていること。2) 自分自身のマイクロポストもフィードに含まれていること。3) <em>フォローしていない</em>ユーザーのマイクロポストがフィードに含まれていないこと。このうち2つについては、<a class="ref" href="./user-microposts.html#code-feed_specs">リスト10.35</a>のテストで既に確認できるようになっています。このテストでは、ユーザー自身のマイクロポストがフィードに含まれ、フォローしていないユーザーのマイクロポストがフィードに含まれていないことを確認します。既にユーザーをフォローできるようになっているので、3番目のテスト、つまりフォローしているユーザーのマイクロポストがフィードに含まれていることを確認するテストを<a class="ref" href="./following-users.html#code-full_feed_specs">リスト11.41</a>のように追加できます。</p>

<div class="label" id="code-full_feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.41</span> <span class="description">ステータスフィードの最終テスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:followed_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed_user</span><span class="p">)</span>
        <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
          <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ステータスフィードのモデルのコードは、<a class="ref" href="./following-users.html#code-user_feed">リスト11.42</a>に示したように、面倒な部分を<code>Micropost.from_users_followed_by</code>に任せてしまっています。この内容は後で実装しなければなりません。</p>

<div class="label" id="code-user_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.42</span> <span class="description">Userモデルに完全なフィードを追加する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-a_first_feed_implementation"></div>


<h3><a id="sec-11_3_2" href="./following-users.html#sec-a_first_feed_implementation" class="heading"><span class="number">11.3.2</span>フィードを初めて実装する</a></h3>


<p>では、その面倒な<code>Micropost.from_users_followed_by</code>を実装しましょう。簡単のため、以後このメソッドを単に “フィード” と呼びます。最終的な表示がやや込み入っているため、欲張らずに細かい部品を1つずつ確かめながら導入することで最終的なフィードを実装します。</p>

<p>最初に、このフィードで必要なクエリについて考えましょう。ここで必要なのは、<code>microposts</code>テーブルから、あるユーザー (つまり自分自身) がフォローしているユーザーに対応するidを持つマイクロポストをすべて選択 (select) することです。このクエリを模式的に書くと以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div>
</div>


<p>上のコードを書く際に、SQLが<code>IN</code>というキーワードをサポートしていることを前提にしています (大丈夫、実際にサポートされています)。このキーワードを使用することで、idの集合の内包 (set inclusion) に対してテストを行えます。</p>

<p><a class="ref" href="./user-microposts.html#sec-a_proto_feed">10.3.3</a>のプロトフィードでは、上のような選択を行うためにActive Recordで<a class="ref" href="./user-microposts.html#code-proto_status_feed">リスト10.36</a>のように<code>where</code>メソッドを使用していたことを思い出してください。このときは、選択する対象はシンプルでした。現在のユーザーに対応するユーザーidを持つマイクロポストをすべて選択すればよかったのでした。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>ここで行いたい選択は、上よりももう少し複雑で、たとえば以下のような感じになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id in (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>(上のコードでは、条件部分に<code>user.id</code>の代わりにRailsの習慣である<code>user</code>を使用していることに注意してください。Railsはこのような場合に自動的に<code>id</code>を使用します。また、冒頭の<code>Micropost.</code>が省略されていることにも注意してください。このコードはMicropostモデル自身の中に置かれることを前提としています。)</p>

<p>これらの条件から、フォローされているユーザーに対応するidの配列が必要であることがわかってきました。これを行う方法の1つは、Rubyの<code>map</code>メソッドを使用することです。このメソッドはすべての &quot;列挙可能 (enumerable)&quot; オブジェクト (配列やハッシュなど、要素の集合で構成されるあらゆるオブジェクト<sup class="footnote" id="fnref-11_11"><a href="./following-users.html#fn-11_11">11</a></sup>) で使用できます。このメソッドの使用法については<a class="ref" href="./rails-flavored-ruby.html#sec-blocks">4.3.2</a>でも説明しました。以下のように使用します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>上に示したような状況では、各要素に対して同じメソッド (この場合<code>to_s</code>) が実行されます。これは非常によく使われる方法であり、以下のように<em>アンパサンド</em> <code>&amp;</code>と、メソッドに対応するシンボルを使用した短縮表記も可能です<sup class="footnote" id="fnref-11_12"><a href="./following-users.html#fn-11_12">12</a></sup>。この短縮表記なら変数iを使用せずに済みます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p><code>join</code>メソッド (<a class="ref" href="./rails-flavored-ruby.html#sec-arrays_and_ranges">4.3.1</a>) を使用すれば、idを集めた文字列を以下のようにカンマ区切りでつなげることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1, 2, 3, 4&quot;</span>
</pre></div>
</div>


<p>上のメソッドを使用すれば、<code>user.followed_users</code>にある各要素の<code>id</code>を呼び出し、フォローしているユーザーのidの配列を構成することができます。たとえば、データベースの最初のユーザーの場合は、以下の配列になります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>実際、この手法は実に便利なので、Active Recordは以下でもデフォルトで同じ結果を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>この<code>followed_user_ids</code>メソッドは、実はActive Recordによって<code>has_many :followed_users</code>関連付けから自動生成されたものです (<a class="ref" href="./following-users.html#code-has_many_following_through_relationships">リスト11.10</a>)。これにより、<code>user.followed_users</code>コレクションに対応するidを得るための<code>_ids</code>を、関連付けの名前に追加するだけで済みます。フォローしているユーザーidの文字列は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51</span>
</pre></div>
</div>


<p>なお、以上は説明のためのコードであり、実際にSQL文字列に挿入するときは、このように記述する必要はありません。実は、<code>?</code>を内挿すると自動的にこの辺りの面倒を見てくれます。さらに、データベースに依存する一部の非互換性まで解消してくれます。つまり、ここでは以下をそのまま使えばよいだけなのです。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>それ以外の追加は不要です。</p>

<p>ここで、以下のコードを見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>このコードは<code>Micropost</code>クラスのクラスメソッド (<a class="ref" href="./rails-flavored-ruby.html#sec-constructors">4.4.1</a>で簡単に説明したコンストラクタ) に関連するのではないかと推測した方もいると思います。 これに沿って実装した推奨コードを<a class="ref" href="./following-users.html#code-from_users_followed_by_first_cut">リスト11.43</a>に示します。</p>

<div class="label" id="code-from_users_followed_by_first_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.43</span> <span class="description"><code>from_users_followed_by</code>の最初の実装。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上の<a class="ref" href="./following-users.html#code-from_users_followed_by_first_cut">リスト11.43</a>まで述べてきたことは仮説に過ぎませんでしたが、それを実装したコードは確かに動きます。テストスイートを実行して確認することもできます。このテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>簡単なアプリケーションであれば、この最初の実装だけでほとんどの目的を達成できるでしょう。しかし、私たちのサンプルアプリケーションの実装にはまだ足りないものがあります。それが何なのか、次の節に進む前に考えてみてください (<em>ヒント:</em>フォローしているユーザーが5000人もいたらどうなるでしょうか)。</p>

<div class="label" id="sec-scopes_subselects_and_a_lambda"></div>


<h3><a id="sec-11_3_3" href="./following-users.html#sec-scopes_subselects_and_a_lambda" class="heading"><span class="number">11.3.3</span>サブセレクト</a></h3>


<p>前節のヒントでおわかりのように、<a class="ref" href="./following-users.html#sec-a_first_feed_implementation">11.3.2</a>のフィードの実装は、投稿されたマイクロポストの数が膨大になったときにうまくスケールアップできません。フォローしているユーザーが5000人程度になるとこういうことが起きる可能性があります。この節では、フォローしているユーザー数に応じてスケーリングできるように、ステータスフィードを再度実装します。</p>

<p><a class="ref" href="./following-users.html#sec-a_first_feed_implementation">11.3.2</a>で問題となるのは、以下のコードです。</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>このコードは、フォローしている<em>すべての</em>ユーザーをメモリーから一気に取り出し、フォローしているユーザーの完全な配列を作り出します。<a class="ref" href="./following-users.html#code-from_users_followed_by_first_cut">リスト11.43</a>の条件では、集合に内包されているかどうかだけしかチェックされていないため、この部分をもっと効率的なコードにできるはずです。そして、SQLは本来このような集合の操作に最適化されています。これを解決する方法は、フォローしているユーザーのidの検索をデータベースに保存するときに<em>サブセレクト (subselect) </em>を使用することです。</p>

<p><a class="ref" href="./following-users.html#code-from_users_followed_by_second_cut">リスト11.44</a>でコードを若干修正し、フィードをリファクタリングすることから始めましょう。</p>

<div class="label" id="code-from_users_followed_by_second_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.44</span> <span class="description"><code>from_users_followed_by</code>を改良する。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 与えられたユーザーがフォローしているユーザー達のマイクロポストを返す。</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
          <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次の段階の準備として、以下のコードを</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>以下の同等のコードに置き換えました。</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
      <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>前者の疑問符を使用した文法も便利ですが、<em>同じ</em>変数を複数の場所に挿入したい場合は、後者の置き換え後の文法を使用するのがより便利です。</p>

<p>上の説明が暗に示すように、これからSQLクエリに<em>もう1つ</em>の<code>user_id</code>を追加します。特に、以下のRubyコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>以下のSQLスニペットと置き換えることができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE follower_id = :user_id&quot;</span>
</pre></div>
</div>


<p>このコードではSQLサブセレクトが使用されています。ユーザー1についてすべてを選択することは、内部的には以下のような感じになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>


<p>このサブセレクトは、集合のロジックを (Railsではなく) データベースに保存するので、より効率が高まります<sup class="footnote" id="fnref-11_13"><a href="./following-users.html#fn-11_13">13</a></sup>。</p>

<p>これで基礎を固めることができましたので、<a class="ref" href="./following-users.html#code-from_users_followed_by_final">リスト11.45</a>のように効率のよいフィードを実装する準備ができました。ここに記述されているのはナマのSQLなので、<code>followed_user_ids</code>はエスケープではなく<em>内挿 (interpolate) </em>されることに注意してください (実際はどちらでも動作しますが、この文脈では内挿と考える方が筋が通っています)。</p>

<div class="label" id="code-from_users_followed_by_final"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.45</span> <span class="description"><code>from_users_followed_by</code>の最終的な実装。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>

  <span class="c1"># 与えられたユーザーがフォローしているユーザー達のマイクロポストを返す。</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                         WHERE follower_id = :user_id&quot;</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_user_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span>
          <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードはRailsとRubyとSQLが複雑に絡み合っていて厄介ですが、ちゃんと動作します。(もちろん、サブセレクトを使用すればいくらでもスケールアップできるなどということはありません。大規模なWebサイトでは、バックグラウンドジョブを使用して、フィードを非同期で生成するなどの対策が必要でしょう。Webサイトのスケーリングのようなデリケートな問題は本書の範疇を超えます)。</p>

<div class="label" id="sec-the_new_status_feed"></div>


<h3><a id="sec-11_3_4" href="./following-users.html#sec-the_new_status_feed" class="heading"><span class="number">11.3.4</span>新しいステータスフィード</a></h3>


<p>ステータスフィードのコードは<a class="ref" href="./following-users.html#code-from_users_followed_by_final">リスト11.45</a>で完成しました。確認のため、Homeページ用のコードも<a class="ref" href="./following-users.html#code-real_feed_instance_variable">リスト11.46</a>に示します。このコードは、<a class="ref" href="./following-users.html#fig-home_page_with_feed">図11.20</a>に示したように、ビューで使用するマイクロポストに関連するフィードをページネーションして作成します<sup class="footnote" id="fnref-11_14"><a href="./following-users.html#fn-11_14">14</a></sup>。この<code>paginate</code>メソッドは、データベースから一度に30ずつマイクロポストを取り出しますが、実はこのメソッドが<a class="ref" href="./following-users.html#code-from_users_followed_by_final">リスト11.45</a>のMicropostモデルのメソッドにまではるばる到達して動作することに注目してください (開発サーバーのログ・ファイルに出力されたSQL文を調べることで、このことを確認できます)。</p>

<div class="label" id="code-real_feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.46</span> <span class="description"><code>home</code>アクションのページネーション付きフィード (再掲)。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_page_with_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_page_with_feed_bootstrap.png" alt="home_page_with_feed_bootstrap" /></span></div><div class="caption"><span class="header">図11.20</span><span class="description">Homeページで動作するステータスフィード。<a href="../images/figures/home_page_with_feed_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-following_conclusion"></div>


<h2><a id="sec-11_4" href="./following-users.html#sec-following_conclusion" class="heading"><span class="number">11.4</span>最後に</a></h2>


<p>ステータスフィードが追加され、<em>Ruby on Railsチュートリアル</em>の中心となるサンプルアプリケーションがとうとう完成しました。このサンプルアプリケーションには、Railsの主要な機能 (モデル、ビュー、コントローラ、テンプレート、パーシャル、フィルタ、検証、コールバック、<code>has_many</code>/<code>belongs_to</code>/<code>has_many through</code>関連付け、セキュリティ、テスティング、デプロイ) が多数含まれています。これだけでもかなりの量ですが、Railsについて学ぶべきことはまだまだたくさんあります。今後の学習の手始めとするために、この節ではサンプルアプリケーションのコア部分のさまざまな拡張方法を提案し、それぞれに必要な学習内容についても示します。</p>

<p>アプリケーションの拡張に取りかかる前に、まずは現状の変更をマージしておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user following&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
</pre></div>
</div>


<p>必要であれば、いつものようにコードをプッシュしてデプロイします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec-extensions_to_the_sample_application"></div>


<h3><a id="sec-11_4_1" href="./following-users.html#sec-extensions_to_the_sample_application" class="heading"><span class="number">11.4.1</span>サンプルアプリケーションの機能を拡張する</a></h3>


<p>この節で提案するさまざまな拡張 (パスワードリマインダ、メールによる確認、サンプルアプリケーション向けには検索、返信、メッセージングなど) は、ほとんどがWebアプリケーションで一般的な機能です。これらの拡張を1つか2つでも実装してみることで、本書から巣立って自分のアプリケーションを書くときにきっと役に立つことでしょう。</p>

<p>いざ実装し始めてみると思ったよりずっと難しく感じるかもしれませんが、それも当然です。新しい機能という真っ白なキャンバスを目の前にすれば、気後れしてしまうのも無理はありません。皆さんが拡張を始めるにあたり、ささやかながら私から2つほど一般的なアドバイスをしてみたいと思います。1) Railsアプリケーションに何らかの機能を追加するときには、ぜひ<a href="http://railscasts.com/episodes/archive">RailsCastsアーカイブ</a>をチェックしてみてください。今自分がやろうとしていることは、既にRyan Batesが取り上げたトピックにあるかもしれません<sup class="footnote" id="fnref-11_15"><a href="./following-users.html#fn-11_15">15</a></sup>。もし手頃なトピックがあれば、関連するRailsCastをウォッチすることで、時間を大幅に節約できることでしょう。2) できるだけ念入りにGoogleで検索し、自分が調べようとしているトピックに言及しているブログやチュートリアルがないかどうか、よく探すことです。Webアプリケーションの開発には常に困難がつきまといます。他人の経験と失敗から学ぶことも重要です。</p>

<p>以下の機能はどれも難易度がそれなりに高いので、実装に必要となるかもしれないツールについてのヒントも書いておきました。たとえヒントがあったとしても、以下の機能が本書の最終章の演習よりも<em>ずっと</em>難易度が高いことは変わりません。相当頑張ったにもかかわらず挫折することも当然あると思いますので、どうかそんなときには落ち込まないでください。私の時間にも限りがありますので、皆さんに個別のお手伝いをすることはできそうにありません。しかし、これらの拡張のいくつかについてなら、今後単発の記事やスクリーンキャストバンドルを公開することがあると思います。「Railsチュートリアル」<a href="http://railstutorial.jp">http://railstutorial.jp/</a>のメインページを参照し、ニュースフィードを購読して最新情報をチェックしてみてください。</p>

<div class="label" id="sec-replies"></div>


<h4><a id="sec-11_4_1_1" href="./following-users.html#sec-replies" class="heading">返信機能</a></h4>


<p>Twitterには、マイクロポスト入力中に<tt>@</tt>記号に続けてユーザーのログイン名を入力するとそのユーザーに返信できる機能があります。このポストは、宛先のユーザーのフィードと、自分をフォローしているユーザーにのみ表示されます。この返信機能の簡単なバージョンを実装してみましょう。具体的には、@replyは受信者のフィードと送信者のフィードにのみ表示されるようにします。これを行うには、<code>microposts</code>テーブルの<code>in_reply_to</code>カラムと、追加の<code>including_replies</code>スコープをMicropostモデルに追加する必要があるとおもいます</p>

<p>このサンプルアプリケーションには独自のユーザーログインがないので、ユーザーを一意に表す方法も考えなければならないでしょう。1つの方法は、idと名前を組み合わせて<code>@1-michael-hartl</code>のようにすることです。もう1つの方法は、ユーザー登録の項目に一意のユーザー名を<em>追加</em>し、@repliesで使えるようにすることです。</p>

<div class="label" id="sec-messaging"></div>


<h4><a id="sec-11_4_1_2" href="./following-users.html#sec-messaging" class="heading">メッセージ機能</a></h4>


<p>Twitterでは、マイクロポストの入力時に最初に “d” キーを押すとダイレクト (プライベート) メッセージを行える機能がサポートされています。この機能をサンプルアプリケーションに実装してみましょう。ヒントは、Messageモデルと、新規マイクロポストにマッチする正規表現です。</p>

<div class="label" id="sec-follower_notifications"></div>


<h4><a id="sec-11_4_1_3" href="./following-users.html#sec-follower_notifications" class="heading">フォロワーの通知</a></h4>


<p>ユーザーに新しくフォロワーが増えたときにメールで通知する機能を実装してみましょう。続いて、メールでの通知機能をオプションとして選択可能にし、不要な場合は通知をオフにできるようにしてみましょう。この機能を追加するには、Railsからメールを送信する機能を追加する必要があります。最初にRailsCast「<a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">Rails 3のAction Mailer</a>」を参照してください。</p>

<div class="label" id="sec-password_reminders"></div>


<h4><a id="sec-11_4_1_4" href="./following-users.html#sec-password_reminders" class="heading">パスワードリマインダー</a></h4>


<p>現状のサンプルアプリケーションには、ユーザーがパスワードを忘れてしまったときの復旧手段がありません。<a class="ref" href="./modeling-users.html#top">第6章</a>で一方向セキュアパスワードハッシュを実装したため、パスワードをメールで送信することは不可能ですが、パスワードをリセットするリンクをメールで送信することなら可能です。必要な知識については、RailsCast「<a href="http://railscasts.com/episodes/274-remember-me-reset-password">パスワード保存機能とパスワードリセット機能について</a> (英語)」を参照してください。</p>

<div class="label" id="sec-signup_confirmation"></div>


<h4><a id="sec-11_4_1_5" href="./following-users.html#sec-signup_confirmation" class="heading">ユーザー登録の確認</a></h4>


<p>現在のサンプルアプリケーションには、正規表現による最小限の確認以外に、メールアドレスを検証する手段がありません。ユーザー登録時にメールアドレスを検証する手順を追加してください。この新機能では、ユーザー作成時に「仮のユーザーアカウント」を作成し、アクティベーション用のURLをメールで送信し、URLにユーザーがアクセスしたらユーザーアカウントを有効にするという手順が必要です。ユーザーアカウントを有効/無効にする方法については、「<a href="http://www.google.com/search?q=state+machines+in+rails">Rails ステートマシン</a>」でネットを検索してみてください。</p>

<div class="label" id="sec-rss_feed"></div>


<h4><a id="sec-11_4_1_6" href="./following-users.html#sec-rss_feed" class="heading">RSSフィード</a></h4>


<p>ユーザーごとのマイクロポストをRSSフィードする機能を実装してください。次にステータスフィードをRSSフィードする機能も実装し、余裕があればフィードに認証スキームも追加してアクセスを制限してみてください。ヒントについてはRailsCast「<a href="http://railscasts.com/episodes/87-generating-rss-feeds">RSSフィードの生成</a> (英語)」を参照してください。</p>

<div class="label" id="sec-rest_api"></div>


<h4><a id="sec-11_4_1_7" href="./following-users.html#sec-rest_api" class="heading">REST API</a></h4>


<p>多くのWebサイトはAPI (Application Programmer Interface) を公開しており、第三者のアプリケーションからリソースのget/post/put/deleteが行えるようになっています。サンプルアプリケーションにもこのようなREST APIを実装してください。解決のヒントは、<code>respond_to</code>ブロック (<a class="ref" href="./following-users.html#sec-a_working_follow_button_with_ajax">11.2.5</a>) をアプリケーションのコントローラの多くのアクションに追加することです。このブロックはXMLをリクエストされたときに応答します。セキュリティには十分注意してください。認可されたユーザーにのみAPIアクセスを許可する必要があります。</p>

<div class="label" id="sec-search"></div>


<h4><a id="sec-11_4_1_8" href="./following-users.html#sec-search" class="heading">検索機能</a></h4>


<p>現在のサンプルアプリケーションには、ユーザーインデックスページを端から探すか、他のユーザーのフィードを表示する以外に、他のユーザーを検索する手段がありません。この点を強化するために、検索機能を実装してください。続いて、マイクロポストを検索する機能も追加してください。あらかじめRailsCast「<a href="http://railscasts.com/episodes/37-simple-search-form">簡単な検索フォーム</a> (英語)」を参照しておくとよいでしょう。このアプリケーションを共有ホストか専用のサーバーにデプロイするのであれば、<a href="http://freelancing-god.github.com/ts/en/">Thinking Sphinx</a>の導入をお勧めします (RailsCast「<a href="http://railscasts.com/episodes/120-thinking-sphinx">Thinking Sphinx</a> (英語)」も参照してください)。Herokuでデプロイするのであれば、「<a href="http://devcenter.heroku.com/articles/full-text-search">Heroku全文検索機能</a>」マニュアル (英語) に従う必要があります。(訳注: @budougumi0617 さんがRails 4.0版における<a href='http://qiita.com/budougumi0617/items/d98fc15adea4dab438e7'>簡単な検索フォームの実装例</a>を公開してくれました。Thx!)</p>

<div class="label" id="sec-guide_to_further_resources"></div>


<h3><a id="sec-11_4_2" href="./following-users.html#sec-guide_to_further_resources" class="heading"><span class="number">11.4.2</span>読み物ガイド</a></h3>


<p>読むに値するRails関連の書籍やドキュメントは書店やWebでいくらでも見つけられます。正直、あまりの多さに閉口するほどです。幸い、それらのほとんどが現在でも入手/アクセス可能です。より高度な技術を身に付けるためのお勧めリソースをいくつかリストアップします (訳注: 日本語の読み物ガイドは、<a href='/help#japanese_refs'>本書のWebサイトのヘルプページ</a>にリストアップしてあります)。</p>

<ul>
<li><a href="https://www.railstutorial.org">Ruby><em>Ruby on Railsチュートリアル</em>スクリーンキャスト</a>。本書に合わせて、完全版のスクリーンキャストを用意してあります。このスクリーンキャストでは、本書の話題をすべてカバーしているだけでなく、さまざまなコツや秘訣も満載されており、スクリーンショットだけでは捉えにくい実際の動作を動画で視聴することもできます。スクリーンキャストは<a href="http://railstutorial.jp">Ruby on RailsチュートリアルWebサイト</a>で購入できます。</li>

<li><a href="http://railscasts.com/">RailsCasts</a>。強く推奨します。このRailsCastsの素晴らしさについては、どれほど言葉を尽くしても足りません。最初に<a href="http://railscasts.com/episodes/archive">RailsCastsエピソードアーカイブ</a>を開いて、目についたトピックを適当に開くところから始めてみるとよいでしょう。</li>

<li>RubyとRailsのお勧め書籍。「<a href="http://amzn.to/1k4KqxP"><em>Beginning Ruby</em></a>」(Peter Cooper 著)、「<a href="http://amzn.to/1sRt1LK"><em>The Well-Grounded Rubyist</em></a>」(David A. Black著)、「<a href="http://amzn.to/1sRyT7D"><em>Eloquent Ruby</em></a>」(Russ Olsen著)、Rubyをさらに深く学ぶのであれば 「<a href="http://amzn.to/1g8yQCl"><em>The Ruby Way</em></a>」(Hal Fulton著) がお勧めです。Railsをさらに深く学ぶのであれば、「<a href="http://amzn.to/1ljfOH0"><em>The Rails 3 Way</em></a>」(Obie Fernandez著)と「<em>Rails 3 in Action</em> (第2版待ち)」(Ryan Bigg、Yehuda Katz著) がお勧めです。</li>

<li><a href="http://peepcode.com/">PeepCode</a>と<a href="http://codeschool.com/">Code School</a>。PeepCodeのスクリーンキャストとCode Schoolのインタラクティブコースは品質が高いことで知られており、強くお勧めいたします。</li>

</ul>




<div class="label" id="sec-following_exercises"></div>


<h2><a id="sec-11_5" href="./following-users.html#sec-following_exercises" class="heading"><span class="number">11.5</span>演習</a></h2>




<ol>
<li>特定のユーザーに関連付けられたrelationshipの削除をテストするコードを追加してください (対応する実装は<a class="ref" href="./following-users.html#code-user_relationships_association">リスト11.4</a>および<a class="ref" href="./following-users.html#code-user_reverse_relationships">リスト11.16</a>の<code>dependent :destroy</code>です)。<em>ヒント</em>: <a class="ref" href="./user-microposts.html#code-micropost_dependency_test">リスト10.12</a>の例に従ってみましょう。</li>
<li><a class="ref" href="./following-users.html#code-relationships_controller_ajax">リスト11.38</a>の<code>respond_to</code>メソッドは、そのアクションから出発してRelationshipsコントローラ自身に到達します。そして、<code>respond_to</code>ブロックは、<code>respond_with</code>というRailsのメソッドと置き換え可能です。<a class="ref" href="./following-users.html#code-compact_respond_to">リスト11.47</a>はこの置き換えを行ったものですが、このコードもテストスイートにパスすることを確認することで、このコードが正しく動作することを証明してください (このメソッドの詳細については、Googleで “rails respond_with” と検索してください)。</li>

<li><a class="ref" href="./following-users.html#code-show_follow_view">リスト11.31</a>をリファクタリングしてください。具体的には、フォローしているユーザーページ、フォロワーページ、Homeページ、ユーザー表示ページで共通して使用されているコードをパーシャルとして追加します。</li>
<li><a class="ref" href="./following-users.html#code-stats_view_test">リスト11.19</a>のモデルに従って、プロファイルページの統計情報のテストを作成してください。</li>
</ol>




<div class="label" id="code-compact_respond_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.47</span> <span class="description"><a class="ref" href="./following-users.html#code-relationships_controller_ajax">リスト11.38</a>をコンパクトにリファクタリングしたもの。</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="./user-microposts.html#top">
</a><a class="prev_page" href="./user-microposts.html#top">    « <span class="number">第10章</span>ユーザーのマイクロポスト
</a><a class="prev_page" href="./user-microposts.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-11_1">モックアップツアーの写真は、それぞれ
<a href="http://www.flickr.com/photos/john_lustig/2518452221/">http://www.flickr.com/photos/john_lustig/2518452221/</a>と
<a href="http://www.flickr.com/photos/30775272@N05/2884963755/">http://www.flickr.com/photos/30775272@N05/2884963755/</a>より引用しました。<a class="arrow" href="./following-users.html#fnref-11_1">↑</a></li>
<li id="fn-11_2">本書の最初の版では<code>user.following</code>としていましたが、結局これも混乱を招くことに気付きました。私にこの用語を変更する決心をさせてくれ、よりわかりやすいアドバイスを提供してくれた読者、Cosmo Leeに感謝いたします (なお、彼のアドバイスをそのまま採用したわけではありませんので、もし本書にまだわかりにくい部分があったとしても、彼には一切の責任がないことをここに申し伝えておきます) 。<a class="arrow" href="./following-users.html#fnref-11_2">↑</a></li>
<li id="fn-11_3">簡単のため、<a class="ref" href="./following-users.html#fig-naive_user_has_many_following">図11.6</a>では <code>followed_users</code>テーブルの<code>id</code>カラムを省略してあります。<a class="arrow" href="./following-users.html#fnref-11_3">↑</a></li>
<li id="fn-11_4">詳細については、Stack Overflowの「<a href="http://stackoverflow.com/questions/5359558/when-to-use-rspec-let">どんなときにletを使用すべきか</a> (英語)」を参照してください。<a class="arrow" href="./following-users.html#fnref-11_4">↑</a></li>
<li id="fn-11_5">技術的には、Railsは<code>underscore</code>メソッドを使用してクラス名をidに変換しています。たとえば、<code>&quot;FooBar&quot;.underscore</code>を実行すると<code>&quot;foo_bar&quot;</code>に変換されます。従って、 <code>FooBar</code>オブジェクトの外部キーは<code>foo_bar_id</code>になるでしょう (なお、<code>underscore</code>と逆の働きをする<code>camelize</code>というメソッドもあります。これは<code>&quot;camel_case&quot;</code>を<code>&quot;CamelCase&quot;</code>のように変換します) 。<a class="arrow" href="./following-users.html#fnref-11_5">↑</a></li>
<li id="fn-11_6"><code>followed_id</code>でもユーザーを特定できることに気付き、フォローしているユーザーとフォロワーの扱いが対称的でないことをよく考えてみれば、もうゲームに勝ったようなものです。これについては<a class="ref" href="./following-users.html#sec-followers">11.1.5</a>でも扱います。<a class="arrow" href="./following-users.html#fnref-11_6">↑</a></li>
<li id="fn-11_7">特定の分野でモデリングの経験を多く積めば、このようなユーティリティメソッドが必要になることを事前に思い付けるようになるでしょう。たとえ思い付けないことがあったとしても、明確なテストを書こうとするときに、いつの間にかこういうメソッドを自分が作成していることに気付くことでしょう。だからというわけではありませんが、今はこのようなメソッドが必要であるということに気付けなくても問題ありません。ソフトウェアの開発は、繰りかえしに次ぐ繰り返しです。読みづらくなるまでコードを書き足し、そのコードをリファクタリングする、その繰り返しです。そして、より簡潔なコードを書くために、本書が少しでもお役に立てばと思います。<a class="arrow" href="./following-users.html#fnref-11_7">↑</a></li>
<li id="fn-11_8"><code>unfollow!</code>は、失敗したときに例外を発生<em>しない</em>ことに注意してください。正直に書くと、削除に失敗したことをRailsがどうやって検出しているのか、著者にもわかりません。<code>follow!</code>に感嘆符が付いているので、それに合わせてこのメソッドにも感嘆符を追加しているに過ぎません。<a class="arrow" href="./following-users.html#fnref-11_8">↑</a></li>
<li id="fn-11_9">Ajaxは、名目上<em>asynchronous JavaScript and XML</em>の略ということになっています。<a href="http://www.adaptivepath.com/ideas/essays/archives/000385.php">最も初期のAjaxに関する記事</a>でも &quot;Ajax&quot; で統一されていますが、ときどき “AJAX” と誤ったスペルが使用されていることがあります。<a class="arrow" href="./following-users.html#fnref-11_9">↑</a></li>
<li id="fn-11_10">Ajaxが動作するためには、ブラウザでJavaScriptが有効になっている必要がありますが、実際にはJavaScriptが無効になっている場合でも<a class="ref" href="./following-users.html#sec-a_working_follow_button_the_standard_way">11.2.4</a>のようにまったく同じ動作になるようにしてあります。<a class="arrow" href="./following-users.html#fnref-11_10">↑</a></li>
<li id="fn-11_11">列挙可能 (enumerable) オブジェクトであることの主な条件は、<code>each</code>メソッドを実装していることです。このメソッドはコレクションを列挙します。<a class="arrow" href="./following-users.html#fnref-11_11">↑</a></li>
<li id="fn-11_12">この記法は、実際にはRailsによるコアRuby言語の拡張として行われたのが始まりです。この記法があまりに便利なので、後にRuby自身にまで取り入れられたほどです。実にクールだと思いますが、いかがでしょうか。<a class="arrow" href="./following-users.html#fnref-11_12">↑</a></li>
<li id="fn-11_13">必要なサブセレクトを作成するための、より高度な方法については、「<a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord">ActiveRecordのサブセレクトをハックする</a> (英語)」というブログ記事を参照してください。 <a class="arrow" href="./following-users.html#fnref-11_13">↑</a></li>
<li id="fn-11_14">実際は、<a class="ref" href="./following-users.html#fig-home_page_with_feed">図11.20</a>の見栄えを良くするために、Railsコンソールを使用してマイクロポストをいくつか手動で投稿しています。<a class="arrow" href="./following-users.html#fnref-11_14">↑</a></li>
<li id="fn-11_15">RailsCastsではテストを省略していることが多いので、その点には注意してください。1回のエピソードを短くまとめるためにテストを省略しているのですが、それに釣られてテスティングの重要性を軽く考えることのないようにしてください。RailsCastでアイディアやヒントを得たら、新機能の実装はぜひともテスト駆動開発で進めることをお勧めいたします。(その意味でも、RailsCast「<a href="http://railscasts.com/episodes/275-how-i-test">テスティングの方法</a> (英語)」をぜひ一度参照してください。Ryan Bates自身も、現実にはテスト駆動開発を採用していることが多くありますし、彼のテスティングスタイルは本書のものと基本的に同じです。)<a class="arrow" href="./following-users.html#fnref-11_15">↑</a></li>
</ol>
</div>



    </div>
  </body>
</html>
