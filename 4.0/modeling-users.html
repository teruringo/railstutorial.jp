<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
            




            
            
            <div id="cha-modeling_users" class="chapter" data-tralics-id="cid37" data-number="6" data-chapter="modeling_users">
<h1><a href="#cha-modeling_users" class="heading hyperref"><span class="number">第6章</span> ユーザーのモデルを作成する</a></h1>
<p><a class="hyperref" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="ref">第5章</span></a>では、新しいユーザーを作成するためのスタブページを作ったところで終わりました (<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-user_signup"><span class="ref">5.4</span></a>)。これから5つの章を通して、ユーザー登録ページを作っていくことにしましょう。本章では、一番重要なステップであるユーザー用の<em>データモデル</em>の作成と、データを保存する手段の確保について学んでいきます。<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>では、ユーザーがサイトにユーザー登録できるようにし、ユーザープロファイルのためのページを作成します。ユーザー登録できるようになったら、ログインやログアウトをできる仕組みを作り (<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>)、<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="ref">第9章</span></a>からは不正なアクセスを取り扱う方法について学んでいきます (<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>) 。最後に、<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>でメールアドレスを使ってアカウントを有効化する方法と、パスワードをリセットする方法について学びます。まとめると、<a class="hyperref" href="#cha-modeling_users"><span class="ref">第6章</span></a>から<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>を通して、Railsのログインと認証システムをひととおり開発します。ご存知の方もいると思いますが、Railsでは既にさまざまな認証方法が利用可能です。<a class="hyperref" href="#aside-roll_your_own">コラム<span class="ref">6.1</span></a>では、最初に少なくとも一度は自分で認証システムを作ってみることをお勧めする理由について説明しています。</p>
<div class="aside" id="aside-roll_your_own" data-tralics-id="uid505" data-number="6.1">
<div class="heading">
<span class="number">コラム6.1</span> 

<span class="description">自分で認証システムを作ってみる</span>
</div>
<p>事実上、すべてのWebアプリケーションは何らかのログイン/認証システムを必要とします。そのため、多くのWebフレームワークではこのようなログイン/認証システムを実装するための選択肢が多数提供されています。Railsもまた例外ではありません。認証 (authentication) と認可 (authorization) のシステムの例だと、<a href="http://www.google.com/url?q=http%3A%2F%2Fgithub.com%2Fthoughtbot%2Fclearance&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFeiHjHTInectgmaUFFSFZt_4VMlQ">Clearance</a>、<a href="http://www.google.com/url?q=http%3A%2F%2Fgithub.com%2Fbinarylogic%2Fauthlogic&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGraKntRclN_Nhlz-Tex61OaUnGaw">Authlogic</a>、<a href="http://www.google.com/url?q=http%3A%2F%2Fgithub.com%2Fplataformatec%2Fdevise&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNG2jcHRoPvpDssIAKJnYyRn4mWd2g">Devise</a>、<a href="http://www.google.com/url?q=http%3A%2F%2Frailscasts.com%2Fepisodes%2F192-authorization-with-cancan&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNG15ulSYkZiYnzoJ4bTRYt8u18L6A">CanCan</a>などがあります (Railsに限らなければ<a href="http://www.google.com/url?q=http%3A%2F%2Fja.wikipedia.org%2Fwiki%2FOpenID&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNH77dKC5Yae7oWSc2aCI0-sjZ3A0g">OpenID</a>や<a href="http://www.google.com/url?q=http%3A%2F%2Fja.wikipedia.org%2Fwiki%2FOauth&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEuCiUYnf65V3rcSfq_WLd5WS9moA">OAuth</a>の上に構築する方法もあります)。なぜ車輪の再発明をするのか、という質問があるのも当然です。自分でわざわざ作らなくても、いつも使える方法をただ利用するだけではいけないのでしょうか。</p>
<p>ある実践的な実験によると、多くのサイトの認証システムは膨大なカスタマイズを必要とするため、サードパーティ製品を変更して導入する場合にはシステムをゼロから作成するよりも多くの仕事を要するという結果が出ています。加えて、既成品のシステムは内部がわかりづらいことが多く、ブラックボックスになっています。自分で作成したシステムであれば、それをとてもよく理解しているはずです。さらに言えば、最近のRailsへの変更 (<a class="hyperref" href="#sec-adding_a_secure_password"><span class="ref">6.3</span></a>) により、カスタム認証システムを容易に作成できるようになりました。最後に、<em>あえて</em>最終的にサードパーティの認証システムを導入することになったとしても、自分自身で認証システムを構築した経験があれば、サードパーティ製品を理解して変更することがずっと容易になるはずです。</p>

</div>
</div><div id="sec-user_model" class="section" data-tralics-id="cid38" data-number="6.1">
<h2><a href="#sec-user_model" class="heading hyperref"><span class="number">6.1</span> Userモデル</a></h2>
<p>ここから3つの章にわたる最終目標はユーザー登録ページ (<a class="hyperref" href="#fig-signup_mockup_preview">図<span class="ref">6.1</span></a>のモックアップ) を作成することですが、今のままでは新しいユーザーの情報を受け取っても保存する場所がないので、いきなりページを作成するわけにはいきません。ユーザー登録でまず初めにやることは、それらの情報を保存するためのデータ構造を作成することです。</p>
<div class="center figure" id="fig-signup_mockup_preview" data-tralics-id="uid506" data-number="6.1">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_mockup_bootstrap.png" alt="images/figures/signup_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図7.1</span> <span class="description">ユーザー登録ページのモックアップ
</span>
</div>
</div>
<p>Railsでは、データモデルで使用するデフォルトのデータ構造のことを<em>モデル</em>と呼びます (<a class="hyperref" href="beginning?version=4.2#sec-mvc"><span class="ref">1.3.3</span></a>で言うMVCのMのことです)。Railsでは、データを永続化するデフォルトの解決策として、<em>データベース</em>を使用してデータを長期間保存します。また、データベースとやりとりするデフォルトのRailsライブラリは<em>Active Record</em>と呼ばれます<sup class="footnote" id="cha-6_footnote-ref-1"><a href="#cha-6_footnote-1">1</a></sup>。Active Recordは、データオブジェクトの作成/保存/検索のためのメソッドを持っています。これらのメソッドを使用するのに、<a href="http://ja.wikipedia.org/wiki/%E9%96%A2%E4%BF%82%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9" target="_blank">リレーショナルデータベース</a>で使うSQL (Structured Query Language)<sup class="footnote" id="cha-6_footnote-ref-2"><a href="#cha-6_footnote-2">2</a></sup>を意識する必要はありません。さらに、Railsには<em>マイグレーション</em>という機能があります。データの定義をRubyで記述することができ、SQLのDDL (Data Definition Language)を新たに学ぶ必要がありません。Railsは、データストアの詳細からほぼ完全に私たちを切り離してくれます。本書では、SQLiteを開発 (development) 環境で使い、またPostgreSQLを (Herokuでの) 本番環境で使います (<a class="hyperref" href="beginning?version=4.2#sec-deploying"><span class="ref">1.5</span></a>)。Railsは、本番 (production) アプリケーションですら、データの保存方法の詳細についてほとんど考える必要がないくらいよくできています。</p>
<p>Gitでバージョン管理を行なっているのであれば、このタイミングでユーザーをモデリングするためのトピックブランチを作成しておいてください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div></div>
<div id="sec-database_migrations" class="subsection" data-tralics-id="uid509" data-number="6.1.1">
<h3><a href="#sec-database_migrations" class="heading hyperref"><span class="number">6.1.1</span> データベースの移行</a></h3>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>で扱ったカスタムビルドクラスの<code>User</code>を思い出してください。このクラスは、<code>name</code>と<code>email</code>を属性に持つユーザーオブジェクトでした。このクラスは役に立つ例として提供されましたが、Railsにとって極めて重要な部分である<em>永続性</em>という要素が欠けていました。RailsコンソールでUserクラスのオブジェクトを作っても、コンソールからexitするとそのオブジェクトはすぐに消えてしまいました。この節での目的は、簡単に消えることのないユーザーのモデルを構築することです。</p>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>のユーザークラスと同様に、<code>name</code>と<code>email</code>の2つの属性からなるユーザーをモデリングするところから始めましょう。後者のemailを一意のユーザー名として使用します<sup class="footnote" id="cha-6_footnote-ref-3"><a href="#cha-6_footnote-3">3</a></sup> (パスワードのための属性は<a class="hyperref" href="#sec-adding_a_secure_password"><span class="ref">6.3</span></a>で扱います)。<a class="hyperref" href="rails_flavored_ruby?version=4.2#code-example_user">リスト<span class="ref">4.13</span></a>では、以下のようにRubyの<code>attr_accessor</code>メソッドを使用しました。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>それとは対照的に、Railsでユーザーをモデリングするときは、属性を明示的に識別する必要がありません。上で簡潔に述べたように、Railsはデータを保存する際にデフォルトでリレーショナルデータベースを使用します。リレーショナルデータベースは、データ<em>行</em>で構成される<em>テーブル</em>からなり、各行はデータ属性の<em>カラム</em> (列) を持ちます。たとえば、nameとemailを持つユーザーを保存するのであれば、<code>name</code>と<code>email</code>のカラムを持つ<code>users</code>テーブルを作成します (各行は1人のユーザーを表します)。テーブルに格納されるデータの例を<a class="hyperref" href="#fig-users_table">図<span class="ref">6.2</span></a>に、対応するデータモデルを<a class="hyperref" href="#fig-user_model_sketch">図<span class="ref">6.3</span></a>に示します (なお、<a class="hyperref" href="#fig-user_model_sketch">図<span class="ref">6.3</span></a>は草案です。実際のデータモデルは<a class="hyperref" href="#fig-user_model_initial">図<span class="ref">6.4</span></a>のようになります)。<code>name</code>や<code>email</code>といったカラム名を今のうちに考えておくことで、後ほどUserオブジェクトの各属性をActiveRecordに伝えるときに楽になります。</p>
<div class="center figure" id="fig-users_table" data-tralics-id="uid511" data-number="6.2">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/users_table.png" alt="images/figures/users_table"></div>
<div class="caption">
<span class="header">図6.2: </span><span class="description"><code>users</code>テーブルに含まれるデータのサンプル
</span>
</div>
</div>
<div class="center figure" id="fig-user_model_sketch" data-tralics-id="uid512" data-number="6.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_sketch.png" alt="images/figures/user_model_sketch"></div>
<div class="caption">
<span class="header">図6.3: </span><span class="description">Userのデータモデルのスケッチ
</span>
</div>
</div>
<p><a class="hyperref" href="filling_in_the_layout?version=4.2#code-generate_users_controller">リスト<span class="ref">5.28</span></a>で、ユーザーコントローラ (と<code>new</code>アクション) を作ったときに使った以下のコマンドを思い出してみてください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new
</pre></div></div>
<p class="noindent">モデルを作成するときは、上と似たようなパターンで<code>generate model</code>というコマンドを使います。さらに、今回は<code>name</code>や<code>email</code>といった属性を付けたUserモデルを使いたいので、実際に打つコマンドは<a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>になります。</p>
<div class="codelisting" id="code-generate_user_model" data-tralics-id="uid513" data-number="6.1">
<div class="heading">
<span class="number">リスト6.1:</span> 

<span class="description">Userモデルを生成する</span>
</div>

<div class="code"><div class="highlight"><pre>$ rails generate model User name:string email:string
      invoke  active_record
      create    db/migrate/20140724010738_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/models/user_test.rb
      create      test/fixtures/users.yml
</pre></div></div>
</div>
<p class="noindent">(コントローラ名には複数形を使い、モデル名には単数形を用いるという慣習を頭に入れておいてください。コントローラは<em>Users</em>でモデルは<em>User</em>です)。<code>name:string</code>や<code>email:string</code>オプションのパラメータを渡すことによって、データベースで使用したい2つの属性をRailsに伝えます。このときに、これらの属性の型情報も一緒に渡します (この場合は<code>string</code>)。<a class="hyperref" href="static_pages?version=4.2#code-generating_pages">リスト<span class="ref">3.4</span></a>や<a class="hyperref" href="filling_in_the_layout?version=4.2#code-generate_users_controller">リスト<span class="ref">5.28</span></a>でアクション名を使用して生成した例と比較してみてください。</p>
<p><a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>にある<code>generate</code>コマンドの結果のひとつとして、<em>マイグレーション</em>と呼ばれる新しいファイルが生成されます。マイグレーションは、データベースの構造をインクリメンタルに変更する手段を提供します。それにより、要求が変更された場合にデータモデルを適合させることができます。このUserモデルの例の場合、マイグレーションはモデル生成スクリプトによって自動的に作られました。<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>に示したように<code>name</code>と<code>email</code>の2つのカラムを持つ<code>users</code>テーブルを作成します (<a class="hyperref" href="#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>で、マイグレーションを一から手動で作成する方法について説明します)。</p>
<div class="codelisting" id="code-users_migration" data-tralics-id="uid514" data-number="6.2">
<div class="heading">
<span class="number">リスト6.2:</span> 

<span class="description">(<code>users</code>テーブルを作るための) Userモデルのマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">マイグレーションファイル名の先頭には、それが生成された時間の<em>タイムスタンプ</em>が追加されます。以前はインクリメンタルな整数が追加されましたが、複数の開発者によるチームでは、複数のプログラマが同じ整数を持つマイグレーションを生成してしまい、コンフリクトを引き起こしていました。現在のタイムスタンプによる方法であれば、まったく同時にマイグレーションが生成されるという通常ではありえないことが起きない限り、そのようなコンフリクトは避けられます。</p>
<p>マイグレーション自体は、データベースに与える変更を定義した<code>change</code>メソッドの集まりです。<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>の場合、<code>change</code>メソッドは<code>create_table</code>というRailsのメソッドを呼び、ユーザーを保存するためのテーブルをデータベースに作成します。<code>create_table</code>メソッドはブロック変数を1つ持つブロック (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>) を受け取ります。ここでは (“table”の頭文字を取って) <code>t</code>です。そのブロックの中で<code>create_table</code>メソッドは<code>t</code>オブジェクトを使って、<code>name</code>と<code>email</code>カラムをデータベースに作ります。型はどちらも<code>string</code>です<sup class="footnote" id="cha-6_footnote-ref-4"><a href="#cha-6_footnote-4">4</a></sup>。モデル名は単数形 (User) ですが、テーブル名は複数形 (<code>users</code>) です。これはRailsで用いられる言葉の慣習を反映しています。モデルはひとりのユーザーを表すのに対し、データベースのテーブルは複数のユーザーから構成されます。ブロックの最後の行<code>t.timestamps</code>は特別なコマンドで、<code>created_at</code>と<code>updated_at</code>という2つの「<em>マジックカラム</em>」を作成します。これらは、あるユーザーが作成または更新されたときに、その時刻を自動的に記録するタイムスタンプです (このマジックカラムの使用例を<a class="hyperref" href="#sec-creating_user_objects"><span class="ref">6.1.3</span></a>から具体的に見ていきます)。<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>のマイグレーテョンによって作成された完全なデータモデルを<a class="hyperref" href="#fig-user_model_initial">図<span class="ref">6.4</span></a>に示します (<a class="hyperref" href="#fig-user_model_sketch">図<span class="ref">6.3</span></a>のスケッチには無かったマジックカラムが追加されています)。</p>
<div class="center figure" id="fig-user_model_initial" data-tralics-id="uid516" data-number="6.4">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_initial_3rd_edition.png" alt="user_model_initial_3rd_edition"></span>
<div class="caption">
<span class="header">図6.4</span> <span class="description"><a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>で生成されたUserのデータモデル
</span>
</div>
</div>
<p>マイグレーションは、以下のように<code>rake</code>コマンド (<a class="hyperref" href="toy_app?version=4.2#aside-rake">コラム<span class="ref">2.1</span></a>) を使って実行することができます。これを「マイグレーションの適用 (migrating up)」と呼びます。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate</pre></div></div>
<p class="noindent">(<a class="hyperref" href="toy_app?version=4.2#sec-demo_users_resource"><span class="ref">2.2</span></a>で、このコマンドを似たような状況で実行したことを思い出してみてください) 。初めて<code>db:migrate</code>が実行されると、<code>db/development.sqlite3</code>という名前のファイルが生成されます。これは<a href="http://www.google.com/url?q=http%3A%2F%2Fsqlite.org%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFc4x3Ju4XfHDiEgCbapjdU8noL_A">SQLite</a><sup id="cha-6_footnote-ref-5" class="footnote"><a href="http://www.google.com/url?q=http%3A%2F%2Frailstutorial.jp%2Fbooks%2F4.2%2Fmodeling_users.html%23cha-6_footnote-5&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNG39SC9WeSw0RKBLwoc1wRqyGZRBw">5</a></sup>データベースです。<code>db/development.sqlite3</code>ファイルを開くための<a href="http://sqlitebrowser.org/" target="_blank">DB Browser for SQLite</a>という素晴らしいツールを使うと、データベースの構造を見ることができます (Cloud IDEを使っている場合は、<a class="hyperref" href="#fig-sqlite_download">図<span class="ref">6.5</span></a>のようにまずはファイルをお手元にダウンロードする必要があります)。結果は<a class="hyperref" href="#fig-sqlite_database_browser">図<span class="ref">6.6</span></a>のようになるので、<a class="hyperref" href="#fig-user_model_initial">図<span class="ref">6.4</span></a>と比べてみてください。<a class="hyperref" href="#fig-sqlite_database_browser">図<span class="ref">6.6</span></a>の中に<code>id</code>というマイグレーションのときに説明されなかったカラムの存在に気づいたかもしれません。<a class="hyperref" href="toy_app?version=4.2#sec-demo_users_resource"><span class="ref">2.2</span></a>で簡単に説明したとおり、このカラムは自動的に作成され、Railsが各行を一意に識別するために使用します。</p>
<div class="center figure" id="fig-sqlite_download" data-tralics-id="uid518" data-number="6.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/sqlite_download.png" alt="images/figures/sqlite_download"></div>
<div class="caption">
<span class="header">図6.5: </span><span class="description">Cloud IDEからファイルをダウンロードする
</span>
</div>
</div>
<div class="center figure" id="fig-sqlite_database_browser" data-tralics-id="uid519" data-number="6.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/sqlite_database_browser_3rd_edition.png" alt="images/figures/sqlite_database_browser_3rd_edition"></div>
<div class="caption">
<span class="header">図6.6: </span><span class="description"><a href="http://sqlitebrowser.org/" target="_blank">DB Browser for SQLite</a>で作成した<code>users</code>テーブルを確認する
</span>
</div>
</div>
<p>Railsチュートリアルで使用されているものすべてを含め、ほとんどのマイグレーションが<em>可逆</em>です。これは、<code>db:rollback</code>というRakeタスクで変更を取り消せることを意味します。これを“マイグレーションの取り消し (migrate down) と呼びます。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:rollback
</pre></div></div>
<p class="noindent">(<a class="hyperref" href="static_pages?version=4.2#aside-undoing_things">コラム<span class="ref">3.1</span></a>では、マイグレーションを元に戻すための便利なテクニックを他にも紹介しています)。上のコマンドでは、データベースからusersテーブルを削除するために<code>drop_table</code>コマンドを内部で呼び出しています。これがうまくいくのは、<code>change</code>メソッドは<code>drop_table</code>が<code>create_table</code>の逆であることを知っているからです。つまり、ロールバック用の逆方向マイグレーションを簡単に導くことができるのです。あるカラムを削除するような不可逆なマイグレーションの場合は、<code>change</code>メソッドの代わりに、<code>up</code>と<code>down</code>のメソッドを別々に定義する必要があります。詳細については、Railsガイドの「<a href="http://railsguides.jp/active_record_migrations.html" target="_blank">Active Record マイグレーション</a>」を参照してください。</p>
<p>もし今の時点でデータベースのロールバックを実行していた場合は、先に進む前にもう一度以下のようにマイグレーションを適用して元に戻してください。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
</div>
<div id="sec-the_model_file" class="subsection" data-tralics-id="uid520" data-number="6.1.2">
<h3><a href="#sec-the_model_file" class="heading hyperref"><span class="number">6.1.2</span> modelファイル</a></h3>
<p>これまで、<a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>のUserモデルの作成によってどのように (<a class="hyperref" href="#code-users_migration"><span class="ref">リスト6.2</span></a>の) マイグレーションファイルが作成されるかを見てきました。そして<a class="hyperref" href="#fig-sqlite_database_browser">図<span class="ref">6.3</span></a>でこのマイグレーションを実行した結果を見ました。<code>users</code>テーブルを作成することで、<code>development.sqlite3</code>という名のファイルを更新し、<code>id</code>、<code>name</code>、<code>email</code>、<code>created_at</code>、<code>updated_at</code>を作成しました。また、<a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>ではモデル用のuser.rbも作られました。この節では、以後このモデル用ファイルを理解することに専念します。</p>
<p>まずは、<code>app/models/</code>ディレクトリにある、<code>user.rb</code>ファイルに書かれたUserモデルのコードを見てみましょう。これは控えめに言ってもとてもよくまとまっています (<a class="hyperref" href="#code-raw_user_model">リスト<span class="ref">6.3</span></a>)</p>
<div class="codelisting" id="code-raw_user_model" data-tralics-id="uid521" data-number="6.3">
<div class="heading">
<span class="number">リスト6.3:</span> 

<span class="description">生成されたばかりのUserモデル<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_class_of_our_own"><span class="ref">4.4.2</span></a>で行ったことを思い出してみましょう。<code>class User &lt; ActiveRecord::Base</code>という構文で、<code>User</code>クラスは<code>ActiveRecord::Base</code>を<em>継承</em>するので、Userモデルは自動的に<code>ActiveRecord::Base</code>クラスのすべての機能を持ちます。もちろん、継承されていることが分かっても、<code>ActiveRecord::Base</code>に含まれるメソッドなどについて知らなければ何の役にも立ちません。それらの知識の一部についてこれから説明します。</p>
</div>
<div id="sec-creating_user_objects" class="subsection" data-tralics-id="uid522" data-number="6.1.3">
<h3><a href="#sec-creating_user_objects" class="heading hyperref"><span class="number">6.1.3</span> ユーザーオブジェクトを作成する</a></h3>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#cha-rails_flavored_ruby"><span class="ref">第4章</span></a>と同じく、Railsコンソールを使用してデータモデルを調べてみましょう。現時点ではデータベースを変更したくないので、コンソールを<em>サンドボックス</em>モードで起動します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console --sandbox
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;</span>&gt;
</pre></div></div>
<p class="noindent">"Any modifications you make will be rolled back on exit" (ここで行ったすべての変更は終了時にロールバックされます) というメッセージにわかりやすく示されているように、コンソールをサンドボックスで起動すると、そのセッションで行ったデータベースへの変更をコンソールの終了時にすべて “ロールバック” (取り消し) してくれます。</p>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>のコンソールセッションでは<code>User.new</code>で新しいユーザーオブジェクトを生成しましたが、<a class="hyperref" href="rails_flavored_ruby?version=4.2#code-example_user">リスト<span class="ref">4.13</span></a>のexample_userファイルを明示的にrequireするまでこのオブジェクトにはアクセスできませんでした。しかし、モデルを使うと状況は異なります。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_controller_class"><span class="ref">4.4.4</span></a>で見たように、Railsコンソールは起動時にRailsの環境を自動的に読み込み、その環境にはモデルも含まれます。つまり、新しいユーザーオブジェクトを作成するときに余分な作業を行わずに済むということです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p class="noindent">上の出力は、ユーザーオブジェクトをコンソール用に出力したものです。</p>
<p><code>User.new</code>を引数なしで呼んだ場合は、すべての属性が<code>nil</code>のオブジェクトを返します。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>では、オブジェクトの属性を設定するための<em>初期化ハッシュ (hash) </em>を引数に取るように、Userクラスの例 (user_example.rb) を設計しました。この設計は、同様の方法でオブジェクトを初期化するActive Recordの設計に基づいています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p class="noindent">上のように、nameとemail属性が期待どおり設定されていることがわかります。</p>
<p>また、Active Recordを理解する上で、「<em>有効性 (Validity)</em>」という概念も重要です。<a class="hyperref" href="#sec-user_validations"><span class="ref">6.2</span></a>で詳細について解説しますが、今はまず先ほどの<code>user</code>オブジェクトが有効かどうか確認してみましょう。確認するためには<code>valid?</code>メソッドを使います。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">true</span>
</pre></div></div>
<p>現時点ではまだデータベースにデータは格納されていません。つまり、<code>User.new</code>は<em>メモリ上で</em>オブジェクトを作成しただけで、<code>user.valid?</code>という行はただオブジェクトが有効かどうかを確認しただけとなります (データベースにデータがあるかどうかは有効性には関係ありません)。データベースにUserオブジェクトを保存するためには、<code>user</code>オブジェクトから<code>save</code>メソッドを呼び出す必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">   (0.2ms)  begin transaction</span>
<span class="go">  User Exists (0.2ms)  SELECT  1 AS one FROM "users"  WHERE LOWER("users".</span>
<span class="go">  "email") = LOWER('mhartl@example.com') LIMIT 1</span>
<span class="go">  SQL (0.5ms)  INSERT INTO "users" ("created_at", "email", "name", "updated_at)</span>
<span class="go">   VALUES (?, ?, ?, ?)  [["created_at", "2014-09-11 14:32:14.199519"],</span>
<span class="go">   ["email", "mhartl@example.com"], ["name", "Michael Hartl"], ["updated_at",</span>
<span class="go">  "2014-09-11 14:32:14.199519"]]</span>
<span class="go">   (0.9ms)  commit transaction</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent"><code>save</code>メソッドは、成功すれば<code>true</code>を、失敗すれば<code>false</code>を返します (現状では、保存はすべて成功するはずです。失敗する場合については<a class="hyperref" href="#sec-user_validations"><span class="ref">6.2</span></a>で説明します)。また、Railsコンソール上では<code>user.save</code>に対応するSQLコマンドやその結果 (<code>INSERT INTO "users"</code>...) も表示するようになっています。なお、本書では生のSQLが必要になる場面がほとんどないので<sup class="footnote" id="cha-6_footnote-ref-6"><a href="#cha-6_footnote-6">6</a></sup>、SQLコマンドに関する解説は省略します。とはいえ、Active Recordに対応するSQLコマンドをザッと眺めるおくだけでも勉強にはなるはずです。</p>
<p>作成した時点でのユーザーオブジェクトは、<code>id</code>属性、マジックカラムである<code>created_at</code>属性と<code>updated_at</code>属性の値がいずれも<code>nil</code>であったことを思い出してください。<code>save</code>メソッドを実行した後に何が変更されたのかを確認してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-24 00:57:46", updated_at: "2014-07-24 00:57:46"&gt;</span>
</pre></div></div>
<p class="noindent"><code>id</code>には<code>1</code>という値が代入され、一方でマジックカラムには現在の日時が代入されているのがわかります<sup class="footnote" id="cha-6_footnote-ref-7"><a href="#cha-6_footnote-7">7</a></sup>。現在、作成と更新のタイムスタンプは同一ですが、<a class="hyperref" href="#sec-updating_user_objects"><span class="ref">6.1.5</span></a>では異なる値になります。</p>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>のUserクラスと同様に、Userモデルのインスタンスはドット記法を用いてその属性にアクセスすることができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Thu, 24 Jul 2014 00:57:46 UTC +00:00</span>
</pre></div></div>
<p>詳細は<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>でも説明しますが、上で見たようにモデルの生成と保存を2つのステップに分けておくと何かと便利です。しかし、Active Recordでは<code>User.create</code>でモデルの生成と保存を同時におこなう方法も提供されています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"A Nother"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"another@example.org"</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: "A Nother", email: "another@example.org", created_at:</span>
<span class="go">"2014-07-24 01:05:24", updated_at: "2014-07-24 01:05:24"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@bar.com"</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2014-07-24</span>
<span class="go">01:05:42", updated_at: "2014-07-24 01:05:42"&gt;</span>
</pre></div></div>
<p class="noindent"><code>User.create</code>は、<code>true</code>か<code>false</code>を返す代わりに、ユーザーオブジェクト自身を返すことに注目してください。返されたユーザーオブジェクトは (上の2つ目のコマンドにある<code>foo</code>のように) 変数に代入することもできます。</p>
<p><code>destroy</code>は<code>create</code>の逆です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2014-07-24</span>
<span class="go">01:05:42", updated_at: "2014-07-24 01:05:42"&gt;</span>
</pre></div></div>
<p class="noindent"><code>create</code>と同じように、<code>destroy</code>はそのオブジェクト自身を返しますが、その返り値を使用しても、もう一度<code>destroy</code>を呼ぶことはできません。さらに、削除されたオブジェクトは、以下のようにまだメモリ上に残っています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2014-07-24</span>
<span class="go">01:05:42", updated_at: "2014-07-24 01:05:42"&gt;</span>
</pre></div></div>
<p class="noindent">では、オブジェクトが本当に削除されたかどうかをどのようにして知ればよいのでしょうか。そして、保存して削除されていないオブジェクトの場合、どうやってデータベースからユーザーを取得するのでしょうか。これらの問いに答えるためには、Active Recordを使ってUserオブジェクトを検索する方法について学ぶ必要があります。</p>
</div>
<div id="sec-finding_user_objects" class="subsection" data-tralics-id="uid525" data-number="6.1.4">
<h3><a href="#sec-finding_user_objects" class="heading hyperref"><span class="number">6.1.4</span> ユーザーオブジェクトを検索する</a></h3>
<p>Active Recordには、オブジェクトを検索するための方法がいくつもあります。これらの機能を使用して、過去に作成した最初のユーザーを探してみましょう。また、3番目のユーザー (<code>foo</code>) が削除されていることを確認しましょう。まずは存在するユーザーから探してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-24 00:57:46", updated_at: "2014-07-24 00:57:46"&gt;</span>
</pre></div></div>
<p class="noindent">ここでは、<code>User.find</code>にユーザーのidを渡しています。その結果、Active Recordはそのidのユーザーを返します。</p>
<p>次に、<code>id</code>=<code>3</code>のユーザーがまだデータベースに存在するかどうかを確認してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn't find User with ID=3</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#sec-creating_user_objects"><span class="ref">6.1.3</span></a>で3番目のユーザーを削除したので、Active Recordはこのユーザーをデータベースの中から見つけることができませんでした。代わりに、<code>find</code>メソッドは<em>例外 (exception) </em>を発生します。例外はプログラムの実行時に何か例外的なイベントが発生したことを示すために使われます。この場合、存在しないActive Recordのidによって、<code>find</code>で<code>ActiveRecord::RecordNotFound</code>例外<sup id="cha-6_footnote-ref-8" class="footnote"><a href="http://www.google.com/url?q=http%3A%2F%2Frailstutorial.jp%2Fbooks%2F4.2%2Fmodeling_users.html%23cha-6_footnote-8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNErucWm4lsLgPkzCqO5co-u-NystA">8</a></sup>が発生しました。</p>
<p>一般的な<code>find</code>メソッド以外に、Active Recordには特定の属性でユーザーを検索する方法もあります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-24 00:57:46", updated_at: "2014-07-24 00:57:46"&gt;</span>
</pre></div></div>
<p class="noindent">これまでメールアドレスをユーザー名として使用してきたので、このような<code>find</code>関連メソッドは、ユーザーをサイトにログインさせる方法を学ぶときに役に立ちます (<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>)。ユーザー数が膨大になると<code>find_by</code>では検索効率が低下するのではないかと心配する方もいるかもしれませんが、あせる必要はありません。この問題およびデータベースのインデックスを使った解決策については<a class="hyperref" href="#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>で扱います。</p>
<p>ユーザーを検索する一般的な方法をあと少しだけご紹介して、この節を終わりにすることにしましょう。まず初めに<code>first</code>メソッドです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-24 00:57:46", updated_at: "2014-07-24 00:57:46"&gt;</span>
</pre></div></div>
<p class="noindent">読んで字のごとく、<code>first</code>は単にデータベースの最初のユーザーを返します。次は<code>all</code>メソッドです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1, name: "Michael Hartl",</span>
<span class="go">email: "mhartl@example.com", created_at: "2014-07-24 00:57:46",</span>
<span class="go">updated_at: "2014-07-24 00:57:46"&gt;, #&lt;User id: 2, name: "A Nother",</span>
<span class="go">email: "another@example.org", created_at: "2014-07-24 01:05:24",</span>
<span class="go">updated_at: "2014-07-24 01:05:24"&gt;]&gt;</span>
</pre></div></div>
<p class="noindent">コンソールの出力結果を見ると、<code>User.all</code>でデータベースのすべてのUserオブジェクトが返ってくることがわかります。また、返ってきたオブジェクトのクラスが <code>ActiveRecord::Relation</code>となっています。これは、各オブジェクトを配列として効率的にまとめてくれるクラスです(<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-arrays_and_ranges"><span class="ref">4.3.1</span></a>)。</p>
</div>
<div id="sec-updating_user_objects" class="subsection" data-tralics-id="uid527" data-number="6.1.5">
<h3><a href="#sec-updating_user_objects" class="heading hyperref"><span class="number">6.1.5</span> ユーザーオブジェクトを更新する</a></h3>
<p>いったんオブジェクトを作成すれば、今度は何度でも更新したくなるものです。基本的な更新の方法は2つです。ひとつは、<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>でやったように属性を個別に代入する方法です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user's attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-24 00:57:46", updated_at: "2014-07-24 00:57:46"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"mhartl@example.net"</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">変更をデータベースに保存するために最後にsaveを実行する必要があることを忘れないでください。保存を行わずに<code>reload</code>を実行すると、データベースの情報を元にオブジェクトを再読み込みするので、以下のように変更が取り消されます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
<span class="go">=&gt; "foo@bar.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
</pre></div></div>
<p><code>user.save</code>を実行したことでユーザーが更新できました。<a class="hyperref" href="#sec-creating_user_objects"><span class="ref">6.1.3</span></a>で約束したように、マジックカラムの更新日時も更新されています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; "2014-07-24 00:57:46"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; "2014-07-24 01:37:32"</span>
</pre></div></div>
<p>属性を更新するもうひとつの方法は、<code>update_attributes</code>を使うものです<sup class="footnote" id="cha-6_footnote-ref-9"><a href="#cha-6_footnote-9">9</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"The Dude"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"dude@abides.org"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "The Dude"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "dude@abides.org"</span>
</pre></div></div>
<p class="noindent"><code>update_attributes</code>メソッドは属性のハッシュを受け取り、成功時には更新と保存を続けて同時に行います (保存に成功した場合は<code>true</code>を返します)。ただし、検証に1つでも失敗すると、<code>update_attributes</code>の呼び出しは失敗します。たとえば、<a class="hyperref" href="#sec-adding_a_secure_password"><span class="ref">6.3</span></a>で実装する、パスワードをレコードに保存することを要求すると検証は失敗します。特定の属性のみを更新したい場合は、以下のように<code>update_attribute</code>を使います。なお、update_attributeには検証を回避するといった効果もあります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"The Dude"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "The Dude"</span>
</pre></div></div>
</div>
</div><div id="sec-user_validations" class="section" data-tralics-id="cid39" data-number="6.2">
<h2><a href="#sec-user_validations" class="heading hyperref"><span class="number">6.2</span> ユーザーを検証する</a></h2>
<p>ついに、<a class="hyperref" href="#sec-user_model"><span class="ref">6.1</span></a>で作成したUserモデルに、アクセス可能な<code>name</code>と<code>email</code>属性が与えられました。しかし、これらの属性はどんな値でも取ることができてしまいます。現在は (空文字を含む) あらゆる文字列が有効です。名前とメールアドレスには、もう少し何らかの制限があってよいはずです。たとえば、<code>name</code>は空であってはならず、<code>email</code>はメールアドレスのフォーマットに従う必要があります。さらに、メールアドレスをユーザーがログインするときの一意のユーザー名として使おうとしているので、メールアドレスがデータベース内で重複することのないようにする必要もあります。</p>
<p>要するに、<code>name</code>と<code>email</code>にあらゆる文字列を許すのは避けるべきです。これらの属性値には、何らかの制約を与える必要があります。Active Record では<em>検証 (Validation)</em> という機能を通して、こういった制約を課すことができるようになっています (実は<a class="hyperref" href="toy_app?version=4.2#sec-putting_the_micro_in_microposts"><span class="ref">2.3.2</span></a>で少しだけ使っていました)。ここでは、よく使われるケースのうちのいくつかについて説明します。それらは<em>存在性 (presence)</em>の検証、<em>長さ (length)</em>の検証、<em>フォーマット (format)</em>の検証、<em>一意性 (uniqueness)</em>の検証です。<a class="hyperref" href="#sec-has_secure_password"><span class="ref">6.3.2</span></a>では、よく使われる最終検証として<em>確認 (confirmation)</em>を追加します。<a class="hyperref" href="sign_up?version=4.2#sec-unsuccessful_signups"><span class="ref">7.3</span></a>では、ユーザーが制約に違反したときに、検証機能によって自動的に表示される有用なエラーメッセージをお見せします。</p>
<div id="sec-a_validity_test" class="subsection" data-tralics-id="uid529" data-number="6.2.1">
<h3><a href="#sec-a_validity_test" class="heading hyperref"><span class="number">6.2.1 </span>有効性のテスト</a></h3>
<p><a class="hyperref" href="static_pages?version=4.2#aside-when_to_test">コラム<span class="ref">3.3</span></a>で言及したとおり、テスト駆動開発は仕事で常に正しく適用できるとは限りませんが、モデルのバリデーション機能は、テスト駆動開発とまさにピッタシの機能と言えます。バリデーション機能は強力ですが、うまく動いている自信を持つのが難しいです。しかし、(テスト駆動開発のように) まず失敗するテストを書き、次にテストを成功させるように実装すると、期待した通りに動いている自信を持てるようになります。</p>
<p>具体的なテスト方法についてですが、まず<em>有効な</em>モデルのオブジェクトを作成し、その属性のうちの1つを有効でない属性に意図的に変更します。そして、バリデーションで失敗するかどうかをテストする、といった方針で進めていきます。念のため、最初に作成時の状態に対してもテストを書いておき、最初のモデルが有効であるかどうかも確認しておきます。このようにテストすることで、バリデーションのテストが失敗したとき、バリデーションの実装に問題があったのか、オブジェクトそのものに問題があったのかを確認することができます。</p>
<p><a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>のコマンドを実行してUser用テストの原型ができているはずなので、まずはその中身から見ていきましょう (<a class="hyperref" href="#code-default_user_test">リスト<span class="ref">6.4</span></a>)。</p>
<div class="codelisting" id="code-default_user_test" data-tralics-id="uid530" data-number="6.4">
<div class="heading">
<span class="number">リスト6.4:</span> 

<span class="description">デフォルトのUserテスト (モックのみ) <span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>有効なオブジェクトに対してテストを書くために、<code>setup</code>という特殊なメソッドを使って有効なUserオブジェクト (<code>@user</code>) を作成します (このメソッドは<a class="hyperref" href="static_pages?version=4.2#cha-static_pages"><span class="ref">第3章</span></a>の演習でも少し取り上げました)。setupメソッド内に書かれた処理は、各テストが走る直前に実行されます。<code>@user</code>はインスタンス変数ですが、setupメソッド内で宣言しておけば、すべてのテスト内でこのインスタンス変数が使えるようになります。したがって、<code>valid?</code>メソッドを使ってUserオブジェクトの有効性をテストすることができます (<a class="hyperref" href="#sec-creating_user_objects"><span class="ref">6.1.3</span></a>).。これをコードにすると、<a class="hyperref" href="#code-valid_user_test">リスト<span class="ref">6.5</span></a>のようになります。</p>
<div class="codelisting" id="code-valid_user_test" data-tralics-id="uid531" data-number="6.5">
<div class="heading">
<span class="number">リスト6.5:</span> 

<span class="description">有効なUserかどうかをテストする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-valid_user_test">リスト<span class="ref">6.5</span></a>では、シンプルな<code>assert</code>メソッドを使ってテストします。<code>@user.valid?</code>が<code>true</code>を返すと成功し、<code>false</code>を返すと失敗します。</p>
<p>とはいえ、Userモデルにはまだバリデーションがないので、このテストは成功するはずです。</p>
<div class="codelisting" id="uid532" data-tralics-id="uid532" data-number="6.6">
<div class="heading">
<span class="number">リスト6.6:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p class="noindent">上では<code>rake test:models</code>というコマンドを実行していますが、これはモデルに関するテストだけを走らせるコマンドです (<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-layout_link_tests"><span class="ref">5.3.4</span></a>で使った<code>rake test:integration</code>と似ていることに注目してください)。</p>
</div>
<div id="sec-presence_validation" class="subsection" data-tralics-id="uid533" data-number="6.2.2">
<h3><a href="#sec-presence_validation" class="heading hyperref"><span class="number">6.2.2</span> 存在性を検証する</a></h3>
<p>おそらく最も基本的なバリデーションは「<em>存在性 (Presence)</em>」です。これは単に、与えられた属性が存在することを検証します。たとえばこの節では、ユーザーがデータベースに保存される前にnameとemailフィールドの両方が存在することを保証します。<a class="hyperref" href="sign_up?version=4.2#sec-signup_error_messages"><span class="ref">7.3.3</span></a>では、この要求を新しいユーザーを作るためのユーザー登録フォームにまで徹底させる方法を確認します。</p>
<p>まずは<a class="hyperref" href="#code-valid_user_test">リスト<span class="ref">6.5</span></a>に、<code>name</code>属性の存在性に関するテストを追加します。具体的には<a class="hyperref" href="#code-name_presence_test">リスト<span class="ref">6.7</span></a>のように、まず<code>@user</code>変数の<code>name</code>属性に対して空白の文字列をセットします。そして、<code>assert_not</code>メソッドを使って Userオブジェクトが有効でなくなったことを確認します。</p>
<div class="codelisting" id="code-name_presence_test" data-tralics-id="uid534" data-number="6.7">
<div class="heading">
<span class="number">リスト6.7:</span> 

<span class="description"><code>name</code>属性にバリデーションに対するテスト <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"name should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"     "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>この時点では、モデルのテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid535" data-tralics-id="uid535" data-number="6.8">
<div class="heading">
<span class="number">リスト6.8:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p><a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>の演習で少し触れましたが、name属性の存在を検査する方法は、<a class="hyperref" href="#code-validates_presence_of_name">リスト<span class="ref">6.9</span></a>に示したとおり、<code>validates</code>メソッドに<code>presence: true</code>という引数を与えて使うことです。<code>presence: true</code>という引数は、要素がひとつの<em>オプションハッシュ</em>です。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-css_revisited"><span class="ref">4.3.4</span></a>のようにメソッドの最後の引数としてハッシュを渡す場合、波括弧を付けなくても問題ありません(<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-adding_to_the_layout"><span class="ref">5.1.1</span></a>でも説明したように、Railsのオプションハッシュは繰り返し登場するテーマです)。</p>
<div class="codelisting" id="code-validates_presence_of_name" data-tralics-id="uid536" data-number="6.9">
<div class="heading">
<span class="number">リスト6.9:</span> 

<span class="description"><code>name</code>属性の存在性を検証する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-validates_presence_of_name">リスト<span class="ref">6.9</span></a>は一見魔法のように見えるかもしれませんが、<code>validates</code>は単なるメソッドです。括弧を使用して<a class="hyperref" href="#code-validates_presence_of_name">リスト<span class="ref">6.9</span></a>を同等のコードに書き換えたものを以下に示します。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>コンソールを起動して、Userモデルに検証を追加した効果を見てみましょう<sup class="footnote" id="cha-6_footnote-ref-10"><a href="#cha-6_footnote-10">10</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p class="noindent">このように、<code>user</code>変数が有効かどうかを<code>valid?</code>メソッドでチェックすることができます。もしオブジェクトがひとつ以上の検証に失敗したときは、<code>false</code>を返します。 また、すべてのバリデーションに通ったときに<code>true</code>を返します。今回の場合、検証が1つしかないので、どの検証が失敗したかわかります。しかし、失敗したときに作られる<code>errors</code>オブジェクトを使って確認すれば、さらに便利です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; ["Name can't be blank"]</span>
</pre></div></div>
<p class="noindent">(Railsが属性の存在性を検査するときに、エラーメッセージはヒントになります。これには<code>blank?</code> メソッドを用います。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-modifying_built_in_classes"><span class="ref">4.4.3</span></a>の終わりに見ました)。</p>
<p>Userオブジェクトは有効ではなくなったので、データベースに保存しようとすると自動的に失敗するはずです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p class="noindent">この変更により<a class="hyperref" href="#code-name_presence_test">リスト<span class="ref">6.7</span></a>のテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>しているはずです。</p>
<div class="codelisting" id="uid538" data-tralics-id="uid538" data-number="6.10">
<div class="heading">
<span class="number">リスト6.10:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-name_presence_test">リスト<span class="ref">6.7</span></a>のモデルに倣って、<code>email</code>属性の存在性についてもテストを書いてみましょう (<a class="hyperref" href="#code-email_presence_test">リスト<span class="ref">6.11</span></a>)。最初は失敗しますが、<a class="hyperref" href="#code-validates_presence_of_email">リスト<span class="ref">6.12</span></a>のコードを追加することで成功するようになります。</p>
<div class="codelisting" id="code-email_presence_test" data-tralics-id="uid539" data-number="6.11">
<div class="heading">
<span class="number">リスト6.11:</span> 

<span class="description"><code>email</code>属性の検証に対するテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"name should be present"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"email should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"     "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-validates_presence_of_email" data-tralics-id="uid540" data-number="6.12">
<div class="heading">
<span class="number">リスト6.12:</span> 

<span class="description"><code>email</code>属性の存在性を検証する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>これですべての存在性がチェックされたので、テストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid541" data-tralics-id="uid541" data-number="6.13">
<div class="heading">
<span class="number">リスト6.13:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-length_validation" class="subsection" data-tralics-id="uid542" data-number="6.2.3">
<h3><a href="#sec-length_validation" class="heading hyperref"><span class="number">6.2.3</span> 長さを検証する</a></h3>
<p>各ユーザーは、Userモデル上に名前を持つことを強制されるようになりました。しかし、これだけでは十分ではありません。ユーザーの名前はサンプルWebサイトに表示されるものなので、名前の長さにも制限を与える必要があります。<a class="hyperref" href="#sec-presence_validation"><span class="ref">6.2.2</span></a>で既に同じような作業を行ったので、この実装は簡単です。</p>
<p>最長のユーザー名の長さに科学的な根拠はありませんので、単に<code>50</code>を上限として手頃な値を使うことにします。つまりここでは、<code>51</code>文字の名前は長すぎることを検証します。また、実際に問題になることはほとんどありませんが、問題になる可能性もあるので長すぎるメールアドレスに対してもバリデーションを掛けましょう。ほとんどのデータベースでは文字列の上限を255としているので、それに合わせて255文字を上限とします。<a class="hyperref" href="#sec-format_validation"><span class="ref">6.2.4</span></a>で説明するメールアドレスのフォーマットに関するバリデーションでは、こういった長さの検証はできないので、本節で長さに関するバリデーションを事前に追加しておきます。結果を<a class="hyperref" href="#code-length_validation_test">リスト<span class="ref">6.14</span></a>に示します。</p>
<div class="codelisting" id="code-length_validation_test" data-tralics-id="uid543" data-number="6.14">
<div class="heading">
<span class="number">リスト6.14:</span> 

<span class="description"><code>name</code>の長さの検証に対するテスト <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"name should not be too long"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"email should not be too long"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-length_validation_test">リスト<span class="ref">6.14</span></a>では、51文字の文字列を簡単に作るために “文字列のかけ算” を使いました。結果をコンソール上で確認できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div></div>
<p class="noindent">メールアドレスの長さに対するバリデーションも、次のように長い文字列を作成して検証します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaa@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 256</span>
</pre></div></div>
<p>この時点では、<a class="hyperref" href="#code-length_validation_test">リスト<span class="ref">6.14</span></a>のテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>しているはずです。</p>
<div class="codelisting" id="uid544" data-tralics-id="uid544" data-number="6.15">
<div class="heading">
<span class="number">リスト 6.15:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>これをパスさせるためには、長さを強制するための検証の引数を使う必要があります。<code>:maximum</code>パラメータと共に用いられる<code>:length</code>は、長さの上限を強制します (<a class="hyperref" href="#code-length_validation">リスト<span class="ref">6.16</span></a>)。</p>
<div class="codelisting" id="code-length_validation" data-tralics-id="uid545" data-number="6.16">
<div class="heading">
<span class="number">リスト6.16:</span> 

<span class="description"> <code>name</code>属性に長さの検証を追加する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">これでテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid546" data-tralics-id="uid546" data-number="6.17">
<div class="heading">
<span class="number">リスト 6.17:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">成功したテストスイートを流用して、今度は少し難しい、メールアドレスのフォーマット検証作業に取りかかりましょう。</p>
</div>
<div id="sec-format_validation" class="subsection" data-tralics-id="uid547" data-number="6.2.4">
<h3><a href="#sec-format_validation" class="heading hyperref"><span class="number">6.2.4</span> フォーマットを検証する</a></h3>
<p><code>name</code>属性の検証には、空文字でない、名前が51文字未満であるという最小限の制約しか与えていませんでした。<code>email</code>属性の場合は、有効なメールアドレスかどうかを判定するために、もっと厳重な要求を満たさなければなりません。これまでは空のメールアドレスのみを禁止してきましたが、ここではメールアドレスにおなじみのパターン<code>user@example.com</code>に合っているかどうかも確認することを要求します。</p>
<p>なお、ここで使用するテストや検証は、形式がひとまず有効なメールアドレスを受け入れ、形式があからさまに無効なものを拒否するだけであり、すべての場合を網羅したものではないという点に注意してください。最初に、有効なメールアドレスと無効なメールアドレスのコレクションに対するテストを行いましょう。このコレクションを作るために、以下のコンソールセッションに示したような、文字列の配列を簡単に作れる<code>%w[]</code>という便利なテクニックを知っておくと良いでしょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[USER@foo.COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; ["USER@foo.COM", "THE_US-ER@foo.bar.org", "first.last@foo.jp"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">USER@foo.<span class="go">COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</span></pre></div></div>
<p class="noindent"><code>each</code>メソッドを使って<code>addresses</code>配列の各要素を繰り返し取り出しました (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>)。このテクニックを学んだことで、基本となるメールアドレスフォーマット検証のテストを書く準備が整いました。</p>
<p>メールアドレスのバリデーションは扱いが難しく、エラーが発生しやすい部分なので、<em>有効な</em>メールアドレスと無効なメールアドレスをいくつか用意して、バリデーション内のエラーを検知していきます。具体的には、<em>user@example,com</em>のような無効なメールアドレスが弾かれることと、<em>user@example.com</em>のような有効なメールアドレスが通ることを確認しながら、バリデーションを実装していきます (ちなみに今の状態では、空でないメールアドレスであれば全て通ってしまいます) 。まずは、有効なメールアドレスを<a class="hyperref" href="#code-email_format_valid_tests">リスト<span class="ref">6.18</span></a>に示します。</p>
<div class="codelisting" id="code-email_format_valid_tests" data-tralics-id="uid548" data-number="6.18">
<div class="heading">
<span class="number">リスト6.18:</span> 

<span class="description">有効なメールフォーマットをテストする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email validation should accept valid addresses"</span> <span class="k">do</span>
    <span class="n">valid_addresses</span> <span class="o">=</span> <span class="sx">%w[user@example.com USER@foo.COM A_US-ER@foo.bar.org</span>
<span class="sx">                         first.last@foo.jp alice+bob@baz.cn]</span>
    <span class="n">valid_addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
      <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">valid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be valid"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここでは、assertメソッドの第2引数にエラーメッセージを追加していることに注目してください。これによって、どのメールアドレスでテストが失敗したのかを特定できるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">valid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be valid"</span>
</pre></div></div>
<p class="noindent">(詳細な文字列を調べるために<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>で紹介した<code>inspect</code>メソッドを使っています。) どのメールアドレスで失敗したのかを知ることは非常に便利です。そこで<a class="hyperref" href="#code-email_format_valid_tests">リスト<span class="ref">6.18</span></a>では、<code>each</code>メソッドを使って各メールアドレスを順にテストしています。ループさせずにテストすると、失敗した行番号からとメールアドレスの行数を照らし合わせて、失敗したメールアドレスを特定するといった作業が発生してしまいます。</p>
<p>次に、 <em>user@example,com</em> (ドットではなくカンマになっている) や<em>user_at_foo.org</em> (アットマーク ‘@’ がない) といった無効なメールアドレスを使って 「<em>無効性 (Invalidity)</em>」についてテストしていきます。<a class="hyperref" href="#code-email_format_valid_tests">リスト<span class="ref">6.18</span></a>と同様に、<a class="hyperref" href="#code-email_format_validation_tests">リスト<span class="ref">6.19</span></a>でもエラーメッセージをカスタマイズして、どのメールアドレスで失敗したのかすぐに特定できるようにしておきます。</p>
<div class="codelisting" id="code-email_format_validation_tests" data-tralics-id="uid549" data-number="6.19">
<div class="heading">
<span class="number">リスト6.19:</span> 

<span class="description">メールフォーマットの検証に対するテスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email validation should reject invalid addresses"</span> <span class="k">do</span>
    <span class="n">invalid_addresses</span> <span class="o">=</span> <span class="sx">%w[user@example,com user_at_foo.org user.name@example.</span>
<span class="sx">                           foo@bar_baz.com foo@bar+baz.com]</span>
    <span class="n">invalid_addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
      <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">invalid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be invalid"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">この時点では、テストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid550" data-tralics-id="uid550" data-number="6.20">
<div class="heading">
<span class="number">リスト6.20:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>メールアドレスのフォーマットを検証するためには、次のように<code>format</code>というオプションを使います。</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="sr">/&lt;regular expression&gt;/</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">このオプションは引数に<em>正規表現 (Regular Expression)</em> (<em>regex</em>とも呼ばれます) を取ります。正規表現は一見謎めいて見えますが、文字列のパターンマッチングにおいては非常に強力な言語です。つまり、有効なメールアドレスだけにマッチして、無効なメールアドレスには<em>マッチしない</em>正規表現を組み立てる必要があります。</p>
<p>メールアドレス標準を定める公式サイトに完全な正規表現があるのですが、非常に巨大かつ意味不明で、場合によっては逆効果になりかねるので<sup class="footnote" id="cha-6_footnote-ref-11"><a href="#cha-6_footnote-11">11</a></sup>、本チュートリアルではもっと実用的で、堅牢であることが実戦で保証されている正規表現を採用します。 これが、その正規表現です。</p>
<div class="code"><div class="highlight"><pre><span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
</pre></div></div>
<p class="noindent">この正規表現を理解するために、お手頃なサイズに分割して<a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>にまとめました<sup class="footnote" id="cha-6_footnote-ref-12"><a href="#cha-6_footnote-12">12</a></sup>。</p>
<div class="table" id="table-valid_email_regex" data-tralics-id="uid553" data-number="6.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>表現</strong></td>
<td class="align_left"><strong>意味</strong></td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></td>
<td class="align_left">(完全な正規表現)</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">正規表現の開始を示す</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">\A</span></td>
<td class="align_left">文字列の先頭</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">[\w+\-.]+</span></td>
<td class="align_left">英数字、アンダースコア (_)、プラス (+)、ハイフン (-)、ドット (.) のいずれかを少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">@</span></td>
<td class="align_left">アットマーク</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">[a-z\d\-.]+</span></td>
<td class="align_left">英小文字、数字、ハイフン、ドットのいずれかを少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">\.</span></td>
<td class="align_left">ドット</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">[a-z]+</span></td>
<td class="align_left">英小文字を少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">\z</span></td>
<td class="align_left">文字列の末尾</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">正規表現の終わりを示す</td>
</tr>
<tr>
<td class="align_left"><span class="inline_verbatim">i</span></td>
<td class="align_left">大文字小文字を無視するオプション</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表6.1</span> <span class="description">メールの正規表現を分解した結果
</span>
</div>
</div>
<p><a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>からも多くのことを学べるとは思いますが、正規表現を本当に理解するためには実際に使って見るのが一番です。たとえば<a href="http://www.rubular.com/" target="_blank">Rubular</a>という対話的に正規表現を試せるWebサイトがあります (<a class="hyperref" href="#fig-rubular">図<span class="ref">6.7</span></a>)<sup class="footnote" id="cha-6_footnote-ref-13"><a href="#cha-6_footnote-13">13</a></sup>。このWebサイトはインタラクティブ性に富んだインターフェイスを持っていて、また、正規表現のクイックリファレンスも兼ね備えています。Rubularをブラウザで開き、<a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>の内容を実際に試してみることを強くお勧めします。正規表現は、読んで学ぶより対話的に学んだほうが早いです。(<em>注</em>: <a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>の正規表現をRubularで使う場合、冒頭の<span class="inline_verbatim">\A</span>と末尾の<span class="inline_verbatim">\z</span>の文字は含めないでください)。</p>
<div class="center figure" id="fig-rubular" data-tralics-id="uid555" data-number="6.7">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/rubular.png" alt="images/figures/rubular"></div>
<div class="caption">
<span class="header">図6.4</span> <span class="description">素晴らしい正規表現エディタ<a href="http://www.rubular.com/" target="_blank">Rubular</a>
</span>
</div>
</div>
<p><a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>の正規表現を適用して<code>email</code>のフォーマットを検証した結果を、<a class="hyperref" href="#code-validates_format_of_email">リスト<span class="ref">6.21</span></a>に示します。</p>
<div class="codelisting" id="code-validates_format_of_email" data-tralics-id="uid556" data-number="6.21">
<div class="heading">
<span class="number">リスト6.21:</span> 

<span class="description">メールフォーマットを正規表現で検証する (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span>)</span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="hll">  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
</span>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
<span class="hll">                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">正規表現<code>VALID_EMAIL_REGEX</code>は<em>定数</em>です。大文字で始まる名前はRubyでは定数を意味します。以下のコードは、</p>
<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">このパターンに一致するメールアドレスだけが有効であることをチェックします上の正規表現には少しだけ残念な点があります。<code>foo@bar..com</code>のようなドットの連続を誤りとして検出できません。この問題の修正するにはとてつもなく複雑な正規表現を使う必要がありますが、これは演習問題に回します (<a class="hyperref" href="#sec-modeling_users_exercises"><span class="ref">6.</span>5</a>)。</p>
<p>この時点で、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>しているはずです。</p>
<div class="codelisting" id="uid557" data-tralics-id="uid557" data-number="6.22">
<div class="heading">
<span class="number">リスト6.22:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
<p class="noindent">残る制約は、メールアドレスが一意であることを強制するだけとなりました。</p>
</div>
<div id="sec-uniqueness_validation" class="subsection" data-tralics-id="uid558" data-number="6.2.5">
<h3><a href="#sec-uniqueness_validation" class="heading hyperref"><span class="number">6.2.5</span> 一意性を検証する</a></h3>
<p>メールアドレスの一意性を強制するために (ユーザー名として使うために)、<code>validates</code>メソッドの<code>:unique</code>オプションを使います。ただしここで<em>重大な</em>警告があります。以下の文面は流し読みせず、必ず注意深く読んでください。</p>
<p>まずは小さなテストから書いていきます。モデルのテストではこれまで、主に<code>User.new</code>を使ってきました。このメソッドは単にメモリ上にRubyのオブジェクトを作るだけです。しかし、一意性のテストのためには、メモリ上だけではなく、実際にレコードをデータベースに登録する必要があります<sup class="footnote" id="cha-6_footnote-ref-14"><a href="#cha-6_footnote-14">14</a></sup>。そのため、まずは重複したメールアドレスからテストしていきます (<a class="hyperref" href="#code-validates_uniqueness_of_email_test">リスト<span class="ref">6.23</span></a>)。</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_test" data-tralics-id="uid560" data-number="6.23">
<div class="heading">
<span class="number">リスト6.23:</span> 

<span class="description">重複するメールアドレス拒否のテスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>) <span class="break"></span><span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードでは、<code>@user</code>と同じメールアドレスのユーザーは作成できないことを、<code>@user.dup</code>を使ってテストしています。dupは、同じ属性を持つデータを複製するためのメソッドです。<code>@user</code>を保存した後では、複製されたユーザーのメールアドレスが既にデータベース内に存在するため、ユーザの作成は無効になるはずです。</p>
<p><a class="hyperref" href="#code-validates_uniqueness_of_email_test">リスト<span class="ref">6.23</span></a>のテストをパスさせるために、<code>email</code>のバリデーションに<code>uniqueness: true</code>というオプションを追加します <a class="hyperref" href="#code-validates_uniqueness_of_email">リスト<span class="ref">6.24</span></a>。</p>
<div class="codelisting" id="code-validates_uniqueness_of_email" data-tralics-id="uid561" data-number="6.24">
<div class="heading">
<span class="number">リスト6.24:</span> 

<span class="description">メールアドレスの一意性を検証する (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>) <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
<span class="hll">                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>実装の途中ですが、ここでひとつ補足します。通常、メールアドレスでは大文字小文字が区別されません。すなわち、<code>foo@bar.com</code>は<code>FOO@BAR.COM</code>や<code>FoO@BAr.coM</code>と書いても扱いは同じです。従って、メールアドレスの検証ではこのような場合も考慮する必要があります<sup class="footnote" id="cha-6_footnote-ref-15"><a href="#cha-6_footnote-15">15</a></sup> 。このため、大文字を区別しないでテストすることが肝要になり、実際のコードは<a class="hyperref" href="#code-validates_uniqueness_of_email_case_insensitive_test">リスト&nbsp;<span class="ref">6.25</span></a>のようになります。</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_case_insensitive_test" data-tralics-id="uid563" data-number="6.25">
<div class="heading">
<span class="number">リスト6.25:</span> 

<span class="description">大文字小文字を区別しない、一意性のテスト (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
<span class="hll">    <span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
</span>    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードではStringの<code>upcase</code>メソッドを使っています (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-blocks"><span class="ref">4.3.2</span></a>)。このテストは最初のメールアドレスの重複テストと同じことをしていますが、大文字に変換したメールアドレスを使っている点が異なります。もしこのテストが少し抽象的すぎると感じるなら、Railsコンソールを起動して確認しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; "USER@EXAMPLE.COM"</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>現在の一意性検証では大文字小文字を区別しているため、<code>duplicate_user.valid?</code>は<code>true</code>になります。しかし、ここでは<code>false</code>になる必要があります。幸い、<code>:uniquenessでは<code>:case_sensitive</code>という打ってつけのオプションが使用できます (<a class="hyperref" href="#code-validates_uniqueness_of_email_case_insensitive">リスト<span class="ref">6.26</span></a></code>)。</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_case_insensitive" data-tralics-id="uid564" data-number="6.26">
<div class="heading">
<span class="number">リスト6.26:</span> 

<span class="description">メールアドレスの大文字小文字を無視した一意性の検証 (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
<span class="hll">                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで、<a class="hyperref" href="#code-validates_uniqueness_of_email">リスト<span class="ref">6.24</span></a>の<code>true</code>を<code>case_sensitive: false</code>に置き換えただけであることに注目してください (<a class="hyperref" href="#code-validates_uniqueness_of_email_case_insensitive">リスト<span class="ref">6.26</span></a>)。Railsはこの場合、<code>:uniqueness</code>を<code>true</code>と判断します。</p>
<p>この時点で、アプリケーションは重要な警告と共にメールアドレスの一意性を強制し、テストスイートもパスするはずです。</p>
<div class="codelisting" id="uid565" data-tralics-id="uid565" data-number="6.27">
<div class="heading">
<span class="number">リスト 6.27:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>しかし、依然としてここには1つの問題が残っています。それは<em>Active Recordはデータベースのレベルでは一意性を保証していない</em>という問題です。具体的なシナリオを使ってその問題を説明します。</p>
<ol>
<li>アリスはサンプルアプリケーションにユーザー登録します。メールアドレスはalice@wonderland.comです。
</li>
<li>アリスは誤って “Submit” を素早く<em>2回</em>クリックしてしまいます。そのためリクエストが2つ連続で送信されます。
</li>
<li>次のようなことが順に発生します。リクエスト1は、検証にパスするユーザーをメモリー上に作成します。リクエスト2でも同じことが起きます。リクエスト1のユーザーが保存され、リクエスト2のユーザーも保存されます。
</li>
<li>この結果、一意性の検証が行われているにもかかわらず、同じメールアドレスを持つ2つのユーザーレコードが作成されてしまいます。</li>
</ol>
<p class="noindent">上のシナリオが信じがたいもののように思えるかもしれませんが、どうか信じてください。RailsのWebサイトでは、トラフィックが多いときにこのような問題が発生する可能性があるのです (筆者もこれを理解するのに苦労しました)。幸い、解決策の実装は簡単です。実は、この問題はデータベースレベルでも一意性を強制するだけで解決します。具体的にはデータベース上のemailのカラムに<em>インデックス (index)</em>を追加し (<a class="hyperref" href="#aside-database_indices">コラム<span class="ref">6.2</span></a>)、そのインデックスが一意であるようにすれば解決します。</p>
<div class="aside" id="aside-database_indices" data-tralics-id="uid570" data-number="6.2">
<div class="heading">
<span class="number">コラム6.2</span> 

<span class="description">データベースのインデックス</span>
</div>
<p>データベースにカラムを作成するとき、そのカラムでレコードを<em>検索する (find) </em>必要があるかどうかを考えることは重要です。たとえば、<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>のマイグレーションによって作成された<span class="tt">email</span>属性について考えてみましょう。<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>ではユーザーをサンプルアプリにログインできるようにしますが、このとき、送信されたものと一致するメールアドレスのユーザーのレコードをデータベースの中から探しだす必要があります。残念なことに、(インデックスなどの機能を持たない) 素朴なデータモデルにおいてユーザーをメールアドレスで検索するには、データベースの<em>ひとりひとりの</em>ユーザーの行を端から順に読み出し、そのemail属性と与えられたメールアドレスを比較するという非効率的な方法しかありません。つまり、たとえばデータベース上の最後のユーザを探す場合でも、すべてのユーザーを最初から順に<em>一人ずつ</em>探していくことになります。これは、データベースの世界では<em>全表スキャン</em>として知られており、数千のユーザーがいる実際のサイトでは<a href="http://catb.org/jargon/html/B/Bad-Thing.html" target="_blank">極めて不都合</a>です。</p>
<p>emailカラムにインデックスを追加することで、この問題を解決することができます。データベースのインデックスを理解するためには、本の索引との類似性を考えるとよいでしょう。索引のない本では、与えられた言葉 (例えば、“foobar”) が出てくる箇所をすべて見つけるためには、ページを端から順にめくって最後まで探す必要があります (紙バージョンの全表スキャン)。しかし索引のある本であれば、“foobar”を含むすべてのページを索引の中から探すだけで済みます。データベースのインデックスも本質的には本の索引と同じように動作します。</p>

</div>
<p>emailインデックスを追加すると、データモデリングの変更が必要になります。Railsでは (<a class="hyperref" href="#sec-database_migrations"><span class="ref">6.1.1</span></a>で見たように) マイグレーションでインデックスを追加します。<a class="hyperref" href="#sec-database_migrations"><span class="ref">6.1.1</span></a>で、Userモデルを生成すると自動的に新しいマイグレーションが作成されたことを思い出してください (<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>)。今回の場合は、既に存在するモデルに構造を追加するので、以下のように<code>migration</code>ジェネレーターを使用してマイグレーションを直接作成する必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div></div>
<p>ユーザー用のマイグレーションと異なり、メールアドレスの一意性のマイグレーションは未定義になっています。<a class="hyperref" href="#code-email_uniqueness_index">リスト<span class="ref">6.28</span></a>のように定義を記述する必要があります<sup class="footnote" id="cha-6_footnote-ref-16"><a href="#cha-6_footnote-16">16</a></sup>。</p>
<div class="codelisting" id="code-email_uniqueness_index" data-tralics-id="uid572" data-number="6.28">
<div class="heading">
<span class="number">リスト6.28:</span> 

<span class="description">メールアドレスの一意性を強制するためのマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_index_to_users_email.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードでは、<code>users</code>テーブルの<code>email</code>カラムにインデックスを追加するために<code>add_index</code>というRailsのメソッドを使っています。インデックス自体は一意性を強制しませんが、オプションで<code>unique: true</code>を指定することで強制できるようになります。</p>
<p>最後に、データベースをマイグレートします。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p class="noindent">(上のコマンドが失敗した場合は、実行中のサンドボックスのコンソールセッションを終了してみてください。そのセッションがデータベースをロックしてマイグレーションを妨げている可能性があります)。</p>
<p>この時点では、(テストDB用のサンプルデータが含まれている) <em>fixtures</em>内で一意性の制限が保たれていないため、テストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>します。<a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>でユーザー用のfixtureが自動的に生成されていますが、メールアドレスが一意になっていません (<a class="hyperref" href="#code-default_fixtures">リスト<span class="ref">6.29</span></a>)。(このデータはいずれも<em>有効では</em>ありませんが、fixture内のサンプルデータはバリデーションを通っていなかったので今まで問題にはなりませんでした。)</p>
<div class="codelisting" id="code-default_fixtures" data-tralics-id="uid573" data-number="6.29">
<div class="heading">
<span class="number">リスト6.29:</span> 

<span class="description">Userのデフォルトfixture (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span>)</span><span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Read about fixtures at http://api.rubyonrails.org/classes/ActiveRecord/</span>
<span class="c1"># FixtureSet.html</span>

<span class="l-Scalar-Plain">one</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>

<span class="l-Scalar-Plain">two</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
</pre></div></div>
</div>
<p class="noindent">また、このfixtureは<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>になるまで使わない予定なので、今のところはこれらのデータを削除しておき、ユーザー用のfixtureファイルを空にしておきましょう (<a class="hyperref" href="#code-empty_fixtures">リスト<span class="ref">6.30</span></a>)。</p>
<div class="codelisting" id="code-empty_fixtures" data-tralics-id="uid574" data-number="6.30">
<div class="heading">
<span class="number">リスト6.30:</span> 

<span class="description">空のfixtureファイル GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># empty</span>
</pre></div></div>
</div>
<p>これで1つの問題が解決されましたが、メールアドレスの一意性を保証するためには、もう1つやらなければならないことがあります。それは、「いくつかのデータベースのアダプタは大文字小文字を区別するインデックスを使っている」という問題への対処です。例えば“Foo@ExAMPle.Com”と“foo@example.com”が別々の文字列だと解釈してしまうデータベースがありますが、私達のアプリケーションではこれらの文字列は同一であると解釈されるべきです。この問題を避けるために、今回は「データベースに保存される直前にすべての文字列を小文字に変換する」という対策を採ります。例えば“Foo@ExAMPle.CoM”という文字列が与えられたら、保存する直前に“foo@example.com”に変換してしまいます。これを実装するためにActive Recordの<a href="http://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF_(%E6%83%85%E5%A0%B1%E5%B7%A5%E5%AD%A6)" target="_blank"><em>コールバック (callback)</em></a> メソッドを利用します。このメソッドは、ある特定の時点で呼び出されるメソッドです。今回の場合は、オブジェクトが保存される時点で処理を実行したいので、<code>before_save</code>というコールバックを使います。これを使って、ユーザーをデータベースに保存する前にemail属性を強制的に小文字に変換します<sup class="footnote" id="cha-6_footnote-ref-17"><a href="#cha-6_footnote-17">17</a></sup>。これをコードにすると、<a class="hyperref" href="#code-email_downcase">リスト<span class="ref">6.31</span></a>のようになります。(本チュートリアルで初めて紹介したテクニックですが、このテクニックについては第10章でもう一度取り上げます。そこではコールバックを定義するときに<em>メソッドを参照する</em>という慣習について説明します。)<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref"></span></a></p>
<div class="codelisting" id="code-email_downcase" data-tralics-id="uid576" data-number="6.31">
<div class="heading">
<span class="number">リスト6.31:</span> 

<span class="description">email属性を小文字に変換してメールアドレスの一意性を保証する (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span>)</span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-email_downcase">リスト<span class="ref">6.31</span></a>のコードは、<code>before_save</code>コールバックにブロックを渡してユーザーのメールアドレスを設定します。設定されるメールアドレスは、現在の値をStringクラスの<code>downcase</code>メソッドを使って小文字バージョンにしたものです。メールアドレスの小文字変換に対するテストは演習として残しておきます (<a class="hyperref" href="#sec-modeling_users_exercises"><span class="ref">6.5</span></a>)。</p>
<p><a class="hyperref" href="#code-email_downcase">リスト<span class="ref">6.31</span></a>では、次のように代入をしていましたが、</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p class="noindent">Userモデルの中では、右式で<code>self</code>というキーワードは省略できます (ちなみにここの<code>self</code>は現在のユーザーを指します)。したがって、次のように書くこともできます。</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p class="noindent">実は<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_class_of_our_own"><span class="ref">4.4.2</span></a>の<code>palindrome</code>内で<code>reverse</code> メソッドを使っていたときも、同様のケースであったことを思い出してください。そのときと同様で、左式では<code>self</code>を省略することは<em>できません</em>。したがって、</p>
<div class="code"><div class="highlight"><pre><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p class="noindent">と書くとうまく動きません。(このトピックについては、<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>でより深く解説していきます。)</p>
<p>これで、先に述べたアリスのシナリオはうまくいくようになります。データベースは、最初のリクエストに基づいてユーザーのレコードを保存しますが、2度目の保存は一意性の制約に反するので拒否します(Railsのログにエラーが出力されますが、害は生じません)。さらに、インデックスをemail属性に追加したことで、<a class="hyperref" href="#sec-finding_user_objects"><span class="ref">6.1.4</span></a>で挙げた2番目の目標である「多数のデータがあるときでの検索効率を向上させる」も達成されました。これは、<code>email</code>属性にインデックスを付与したことによって、メールアドレスからユーザーを引くときに全表スキャンを使わずに済むようになったためです (<a class="hyperref" href="#aside-database_indices">コラム<span class="ref">6.2</span></a>)。

</p>
</div>
</div><div id="sec-adding_a_secure_password" class="section" data-tralics-id="cid40" data-number="6.3">
<h2><a href="#sec-adding_a_secure_password" class="heading hyperref"><span class="number">6.3</span> セキュアなパスワードを追加する</a></h2>
<p>ユーザー属性の「名前」と「メールアドレス」に対してバリデーションを追加したので、最後の砦である「セキュアなパスワード」に取り掛かります。セキュアパスワードという手法では、各ユーザーにパスワードとパスワードの確認を入力させ、それを (そのままではなく) <em>ハッシュ化</em>したものをデータベースに保存します。(ハッシュ化というと少し困惑してしまうかもしれません。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>では<em>ハッシュ</em>とはRubyのデータ構造であると説明しましたが、今回の「ハッシュ化」とはそういった構造ではなく、<a href="http://ja.wikipedia.org/wiki/%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E9%96%A2%E6%95%B0" target="_blank">ハッシュ関数</a>を使って入力されたデータを元に戻せない (不可逆な) データにする処理を指します。) また、入力されたパスワードを使用してユーザーを<em>認証</em>する手段と、<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>で使用する、ユーザーがサイトにログインできるようにする手段も提供します。</p>
<p>ユーザーの認証は、パスワードの送信、ハッシュ化、データベース内のハッシュ化された値との比較、という手順で進んでいきます。比較の結果が一致すれば、送信されたパスワードは正しいと認識され、そのユーザーは認証されます。ここで、生のパスワードではなく、ハッシュ化されたパスワード同士を比較していることに注目してください。こうすることで、生のパスワードをデータベースに保存するという危険なことをしなくてもユーザーを認証できます。これで、仮にデータベースの内容が盗まれたり覗き見されるようなことがあっても、パスワードの安全性が保たれます。</p>
<div id="sec-a_hashed_password" class="subsection" data-tralics-id="uid577" data-number="6.3.1">
<h3><a href="#sec-a_hashed_password" class="heading hyperref"><span class="number">6.3.1 </span>ハッシュ化されたパスワード</a></h3>
<p>セキュアなパスワードの実装は、<code>has_secure_password</code>というRailsのメソッドを呼び出すだけでほとんど終わってしまいます。このメソッドは、Userモデルで次のように呼び出せます。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">上のようにモデルにこのメソッドを追加すると、次のような機能が使えるようになります。</p>
<ul>
<li>セキュアにハッシュ化したパスワードを、データベース内の<code>password_digest</code>という属性に保存できるようになる。</li>
<li>2つのペアの仮想的な属性<sup class="footnote" id="cha-6_footnote-ref-18"><a href="#cha-6_footnote-18">18</a></sup> (<code>password</code>と<code>password_confirmation</code>)が使えるようになる。また、存在性と値が一致するかどうかのバリデーションも追加される。
</li>
<li>
<code>authenticate</code>メソッドが使えるようになる (引数の文字列がパスワードと一致するとUserオブジェクトを、間違っていると<code>false</code>返すメソッド)。</li>
</ul>
<p>この魔術的な<code>has_secure_password</code>機能を使えるようにするには、1つだけ条件があります。それは、モデル内に<code>password_digest</code>という属性が含まれていることです。ちなみに<em>digest</em>という言葉は、<a href="http://ja.wikipedia.org/wiki/%E6%9A%97%E5%8F%B7%E5%AD%A6%E7%9A%84%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E9%96%A2%E6%95%B0" target="_blank">暗号化用ハッシュ関数</a>という用語が語源です。したがって、今回の文脈では<em>ハッシュ化されたパスワード</em>と<em>暗号化されたパスワード</em>は似た表現となります<sup class="footnote" id="cha-6_footnote-ref-19"><a href="#cha-6_footnote-19">19</a></sup>。今回はUserモデルで使うので、Userのデータモデルは以下の図のようになります (<a class="hyperref" href="#fig-user_model_password_digest">図<span class="ref">6.8</span></a>)。</p>
<div class="center figure" id="fig-user_model_password_digest" data-tralics-id="uid583" data-number="6.8">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_password_digest_3rd_edition.png" alt="user_model_password_digest_3rd_edition"></span>
<div class="caption">
<span class="header">図6.8</span> <span class="description">Userモデルに<code>password_digest</code>属性を追加する
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-user_model_password_digest">図<span class="ref">6.8</span></a>のようなデータモデルにするために、まずは<code>password_digest</code>カラム用の適切なマイグレーションを生成します。マイグレーション名は自由に指定できますが、上のように末尾を<code>to_users</code>にしておくことをお勧めします。こうしておくと、<code>users</code>テーブルにカラムを追加するマイグレーションがRailsによって自動的に作成されるからです。<code>add_password_digest_to_users</code>というマイグレーションファイルを生成するためには、以下のコマンドを実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration \
add_password_digest_to_users password_digest:string</pre></div></div>
<p class="noindent">上のコマンドでは<code>password_digest:string</code>という引数を与えて、今回必要になる属性名と型情報を渡しています。<a class="hyperref" href="#code-generate_user_model">リスト<span class="ref">6.1</span></a>で<code>users</code>テーブルを最初に生成するとき、<code>name:string</code>や<code>email:string</code>といった引数を与えていたことを思い出してください。そのときと同様に<code>password_digest:string</code>という引数を与えることで、完全なマイグレーションを生成するための十分な情報をRailsに与えることができます (<a class="hyperref" href="#code-password_migration">リスト<span class="ref">6.32</span></a>)。</p>
<div class="codelisting" id="code-password_migration" data-tralics-id="uid584" data-number="6.32">
<div class="heading">
<span class="number">リスト6.32:</span> 

<span class="description"><code>users</code>テーブルに<code>password_digest</code>カラムを追加するマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_password_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-password_migration">リスト<span class="ref">6.32</span></a>では、<code>add_column</code>メソッドを使って<code>users</code>テーブル<code>password_digest</code>カラムを追加しています。これを適用させるには、データベースでマイグレーションを実行します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p>また、<code>has_secure_password</code>を使ってパスワードをハッシュ化するためには、最先端のハッシュ関数である<a href="http://en.wikipedia.org/wiki/Bcrypt" target="_blank">bcrypt</a>が必要になります。パスワードを適切にハッシュ化することで、たとえ攻撃者によってデータベースからパスワードが漏れてしまった場合でも、Webサイトにログインされないようにできます。サンプルアプリケーションでbcryptを使用するために、<code>bcrypt-ruby</code> gemを<code>Gemfile</code>に追加します (<a class="hyperref" href="#code-bcrypt_ruby">リスト<span class="ref">6.33</span></a>)。</p>
<div class="codelisting" id="code-bcrypt_ruby" data-tralics-id="uid585" data-number="6.33">
<div class="heading">
<span class="number">リスト6.33:</span> 

<span class="description"><code>bcrypt</code>をt<code>Gemfile</code>に追加する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>               <span class="s1">'3.1.7'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div>
</div>
<p class="noindent">次に、いつものように<code>bundle install</code>を実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install</pre></div></div>
</div>
<div id="sec-has_secure_password" class="subsection" data-tralics-id="uid586" data-number="6.3.2">
<h3><a href="#sec-has_secure_password" class="heading hyperref"><span class="number">6.3.2</span> ユーザーがセキュアなパスワードを持っている</a></h3>
<p>Userモデルに<code>password_digest</code>属性を追加し、Gemfileにbcryptを追加したことで、ようやくUserモデル内で<code>has_secure_password</code>が使えるようになりました (<a class="hyperref" href="#code-has_secure_password">リスト<span class="ref">6.34</span></a>)。</p>
<div class="codelisting" id="code-has_secure_password" data-tralics-id="uid587" data-number="6.34">
<div class="heading">
<span class="number">リスト6.34:</span> 

<span class="description">Userモデルに<code>has_secure_password</code>を追加する (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="hll">  <span class="n">has_secure_password</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-has_secure_password">リスト<span class="ref">6.34</span></a>で<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>と記しておいたように、まだテストは落ちたままにになっているはずです。コマンドラインで以下を実行して確認してください。</p>
<div class="codelisting" id="uid588" data-tralics-id="uid588" data-number="6.35">
<div class="heading">
<span class="number">リスト6.35:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">テストが失敗する理由は、<a class="hyperref" href="#sec-a_hashed_password"><span class="ref">6.3.1</span></a>で触れたように<code>has_secure_password</code>には、仮想的な<code>password</code>属性と<code>password_confirmation</code>属性に対してバリデーションをする機能も(強制的に)追加されているからです。しかし<a class="hyperref" href="#code-validates_uniqueness_of_email_case_insensitive_test">リスト<span class="ref">6.25</span></a>のテストでは、<code>@user</code> 変数にこのような値がセットされておりません。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setup</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">テストをパスさせるために、<a class="hyperref" href="#code-test_with_password_confirmation">リスト<span class="ref">6.36</span></a>のようにパスワードとパスワード確認の値を追加します。</p>
<div class="codelisting" id="code-test_with_password_confirmation" data-tralics-id="uid589" data-number="6.36">
<div class="heading">
<span class="number">リスト6.36:</span> 

<span class="description">パスワードとパスワード確認を追加する (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
<span class="hll">                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>これでテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するようになります。</p>
<div class="codelisting" id="uid590" data-tralics-id="uid590" data-number="6.37">
<div class="heading">
<span class="number">リスト6.37:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">Userモデルに対して<code>has_secure_password</code>を追加する利点は<a class="hyperref" href="#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>で少しだけ説明しますが、 その前に、パスワードの最小文字数を設定する方法について説明します。</p>
</div>
<div id="sec-minimum_password_standards" class="subsection" data-tralics-id="uid591" data-number="6.3.3">
<h3><a href="#sec-minimum_password_standards" class="heading hyperref"><span class="number">6.3.3 </span>パスワードの最小文字数</a></h3>
<p>パスワードを簡単に当てられないようにするために、パスワードの最小文字数を設定しておくことは一般に実用的です。<a href="http://lmgtfy.com/?q=rails+enforce+password+strength" target="_blank">Railsでパスワードの長さを設定する方法</a>はたくさんありますが、今回は簡潔にパスワードが空でないことと最小文字数 (6文字) の2つを設定しましょう。パスワードの長さが6文字以上であることを検証するテストを、以下の<a class="hyperref" href="#code-minimum_password_length_test">Lリスト<span class="ref">6.38</span></a>に示します。</p>
<div class="codelisting" id="code-minimum_password_length_test" data-tralics-id="uid592" data-number="6.38">
<div class="heading">
<span class="number">リスト6.38:</span> 

<span class="description">パスワードの最小文字数をテストする (<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"password should be present (nonblank)"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="mi">6</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"password should have a minimum length"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで、以下のような多重代入 (Multiple Assignment) を使っていることに注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-minimum_password_length_test">リスト<span class="ref">6.38</span></a>のこの行では、パスワードとパスワード確認に対して同時に代入をしています (このケースでは、<a class="hyperref" href="#code-length_validation_test">リスト<span class="ref">6.14</span></a>と同じように、文字列の乗算を利用して5文字の文字列を代入しています)。</p>
<p><a class="hyperref" href="#code-length_validation">リスト<span class="ref">6.16</span></a>では<code>maximum</code>を使ってユーザー名の最大文字数を制限していましたが、これと似たような形式の<code>minimum</code>というオプションを使って、最小文字数のバリデーションを実装することができます。</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">また、空のパスワードを入力させないために、<code>存在性</code>のバリデーション (<a class="hyperref" href="#sec-presence_validation"><span class="ref">6.2.2</span></a>) も一緒に追加します。結果として、Userモデルのコードは<a class="hyperref" href="#code-password_implementation">リスト<span class="ref">6.39</span></a>のようになります。(<code></code>has_secure_passwordメソッドは存在性のバリデーションもしてくれるのですが、これは新しくレコードが追加されたときだけに適用されます。したがって、たとえばユーザーが "      " (6文字分の空白スペース) といった文字列をパスワード欄に入力して更新しようとすると、バリデーションが適用されずに更新されてしまう問題が発生してしまいます。)</p>
<div class="codelisting" id="code-password_implementation" data-tralics-id="uid593" data-number="6.39">
<div class="heading">
<span class="number">リスト6.39:</span> 

<span class="description">セキュアパスワードの完全な実装 (<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>)<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>この時点で、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid594" data-tralics-id="uid594" data-number="6.40">
<div class="heading">
<span class="number">リスト6.40:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:models
</pre></div></div>
</div>
</div>
<div id="sec-creating_and_authenticating_a_user" class="subsection" data-tralics-id="uid595" data-number="6.3.4">
<h3><a href="#sec-creating_and_authenticating_a_user" class="heading hyperref"><span class="number">6.3.4 </span>ユーザーの作成と認証</a></h3>
<p>以上でUserモデルの基本部分が完了しましたので、今度は<a class="hyperref" href="sign_up?version=4.2#sec-showing_users"><span class="ref">7.1</span></a>でユーザー情報表示ページを作成するときに備えて、データベースに新規ユーザーを1人作成しましょう。また、Userモデルに<code>has_secure_password</code>を追加した効果についても (たとえば<code>authenticate</code>メソッドの効果なども) 具体的に見ていきます。</p>
<p>ただしWebからのユーザー登録はまだできない (<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>で完成させます) ので、今回はRailsコンソールを使ってユーザーを手動で作成することにしましょう。<a class="hyperref" href="#sec-creating_user_objects"><span class="ref">6.1.3</span></a>で説明した<code>create</code>を使いますが、後々実際のユーザーを作成する必要が出てくるので、今回はサンドボックス環境は<em>使いません</em>。したがって、今回作成したユーザーを保存すると、データベースに反映されます。それでは、まず<code>rails console</code>コマンドを実行してセッションを開始し、次に有効な名前・メールアドレス・パスワード・パスワード確認を渡してユーザーを作成してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-09-11 14:26:42", updated_at: "2014-09-11 14:26:42",</span>
<span class="go">password_digest: "$2a$10$sLcMI2f8VglgirzjSJOln.Fv9NdLMbqmR4rdTWIXY1G..."&gt;</span>
</pre></div></div>
<p class="noindent">うまくデータベースに保存されたかどうかを確認するためには、開発環境用のデータベースをDB Browser for SQLiteで開き、 <code>users</code>テーブルの中身を見ます (<a class="hyperref" href="#fig-sqlite_user_row">図<span class="ref">6.9</span></a>)<sup class="footnote intersentence" id="cha-6_footnote-ref-20"><a href="#cha-6_footnote-20">20</a></sup>。もしCloud IDEを使っている場合は、データベースのファイルをダウンロードして開いてください (<a class="hyperref" href="#fig-sqlite_download">図<span class="ref">6.5</span></a>)。このとき、先ほど定義したUserモデルの属性 (<a class="hyperref" href="#fig-user_model_password_digest">図<span class="ref">6.8</span></a>) に対応したカラムがあることにも注目しておいてください </p>
<div class="center figure" id="fig-sqlite_user_row" data-tralics-id="uid601" data-number="6.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/sqlite_user_row_with_password_3rd_edition.png" alt="images/figures/sqlite_user_row_with_password_3rd_edition"></div>
<div class="caption">
<span class="header">図6.9</span> <span class="description">SQLiteデータベース<code>db/development.sqlite3</code>に登録されたユーザーの行
</span>
</div>
</div>
<p>コンソールに戻って<code>password_digest</code>属性を参照してみると、<a class="hyperref" href="#code-password_implementation">リスト<span class="ref">6.39</span></a>の<code>has_secure_password</code>の効果を確認できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; "$2a$10$YmQTuuDNOszvu5yi7auOC.F4G//FGhyQSWCpghqRWQWITUYlG3XVy"</span>
</pre></div></div>
<p class="noindent">これは、Userオブジェクトを作成したときに、<code>"foobar"</code>という文字列がハッシュ化された結果です。bcryptを使って生成されているので、この文字列から元々のパスワードを導出することは、コンピュータを使っても非現実的です<sup class="footnote" id="cha-6_footnote-ref-21"><a href="#cha-6_footnote-21">21</a></sup>。</p>
<p>また<a class="hyperref" href="#sec-a_hashed_password"><span class="ref">6.3.1</span></a>で説明したように、<code>has_secure_password</code>をUserモデルに追加したことで、そのオブジェクト内で<code>authenticate</code>メソッドが使えるようになっています。このメソッドは、引数に与えられた文字列 (パスワード) をハッシュ化した値と、データベース内にある<code>password_digest</code>カラムの値を比較します。試しに、先ほど作成したuserオブジェクトに対して間違ったパスワードを与えてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"not_the_right_password"</span><span class="p">)</span>
<span class="go">false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobaz"</span><span class="p">)</span>
<span class="go">false</span>
</pre></div></div>
<p class="noindent">間違ったパスワードを与えた結果、<code>user.authenticate</code>が<code>false</code>を返したことがわかります。次に、正しいパスワードを与えてみましょう。今度は<code>authenticate</code>がそのユーザーオブジェクトを返すようになります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-07-25 02:58:28", updated_at: "2014-07-25 02:58:28",</span>
<span class="go">password_digest: "$2a$10$YmQTuuDNOszvu5yi7auOC.F4G//FGhyQSWCpghqRWQW..."&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>では、この<code>authenticate</code>メソッドを使ってログインする方法を解説します。なお、<code>authenticate</code>がUserオブジェクトを返すことは重要ではなく、返ってきた値の論理値が<code>true</code>であることが重要です。Userオブジェクトは<code>nil</code>でも<code>false</code>でもないので、いい感じに仕事をしてくれています<sup class="footnote" id="cha-6_footnote-ref-22"><a href="#cha-6_footnote-22">22</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">!!</span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
</div>
</div><div id="sec-modeling_users_conclusion" class="section" data-tralics-id="cid41" data-number="6.4">
<h2><a href="#sec-modeling_users_conclusion" class="heading hyperref"><span class="number">6.4</span> 最後に</a></h2>
<p>この章では、ゼロからUserモデルを作成し、そこにname属性やemail属性、パスワード属性を加えました。また、それぞれの値を制限する多くの重要なバリデーションも追加しました。さらに、与えられたパスワードをセキュアに認証できる機能も実装しました。たった12行でここまでの機能が実装できたことは、(Railsの) 注目に値する点でもあります。</p>
<p>次の<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>では、ユーザーを作成するためのユーザー登録フォームを作成し、各ユーザーの情報を表示するためのページも作成します。<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>では、<a class="hyperref" href="#sec-adding_a_secure_password"><span class="ref">6.3</span></a>の認証システムを利用して、ユーザーが実際にWebサイトにログインできるようにします。</p>
<p>Gitを使用している方は、しばらくコミットしていなかったのであれば、この時点でコミットしておくのがよいでしょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Make a basic User model (including secure passwords)"
</pre></div></div>
<p class="noindent">次にmasterブランチにマージして、リモートにあるリポジトリに対してpushします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
<span class="gp">$</span> git push
</pre></div></div>
<p>なお、本番環境でUserモデルを使うためには、<code>heroku run</code>コマンドを使ってHeroku上でもマイグレーションを走らせる必要があります。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push heroku
$ heroku run rake db:migrate
</pre></div></div>
<p class="noindent">うまくできたかどうかは、本番環境のコンソールに接続することで確認できます。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ heroku run console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="go">created_at: "2014-08-29 03:27:50", updated_at: "2014-08-29 03:27:50",</span>
<span class="go">password_digest: "$2a$10$IViF0Q5j3hsEVgHgrrKH3uDou86Ka2lEPz8zkwQopwj..."&gt;</span>
</pre></div></div>
<div id="sec-modeling_users_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid604" data-number="6.4.1">
<h3><a href="#sec-modeling_users_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">6.4.1 </span>本章のまとめ</a></h3>
<ul>
<li>マイグレーションを使うことで、アプリケーションのデータモデルを修正することができる
</li>
<li>Active Recordを使うと、データモデルを作成したり操作したりするための多数のメソッドが使えるようになる
</li>
<li>Active Recordのバリデーションを使うと、モデルに対して制限を追加することができる
</li>
<li>よくあるバリデーションには、存在性・長さ・フォーマットなどがある
</li>
<li>正規表現は謎めいて見えるが非常に強力である
</li>
<li>データベースにインデックスを追加することで検索効率が向上する。また、データベースレベルでの一意性を保証するためにも使われる
</li>
<li>
<code>has_secure_password</code>メソッドを使うことで、モデルに対してセキュアなパスワードを追加することができる
</li>
</ul>
</div>
</div><div id="sec-modeling_users_exercises" class="section" data-tralics-id="cid42" data-number="6.5">
<h2><a href="#sec-modeling_users_exercises" class="heading hyperref"><span class="number">6.5</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>ブックのすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で本書ルを購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>演習とチュートリアル本編の食い違いを避ける方法については、<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>のトピックブランチの演習に追加したメモをご覧ください。</p>
<ol>
<li>
<a class="hyperref" href="#code-email_downcase">リスト<span class="ref">6.31</span></a>の、メールアドレスを小文字に変換するコードに対するテストを、<a class="hyperref" href="#code-email_downcase_test">リスト<span class="ref">6.41</span></a>に示されているように作成してください。このテストでは、<code>reload</code>メソッドを使用してデータベースから値を再度読み込み、<code>assert_equal</code>メソッドを使用して同値であるかどうかをテストしてください。<a class="hyperref" href="#code-email_downcase_test">リスト<span class="ref">6.41</span></a>のテストが正しいかどうか検証するために、<code>before_save</code>の行をコメントアウトするとテストが<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>し、元に戻すと<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>することを確認してください。
</li>
<li>
<code>before_save</code>コールバック内で<code>email.downcase!</code>と書き、<code>email</code>属性を直接変更してもよいことを、テストスイートを走らせて確認してください (<a class="hyperref" href="#code-downcase_bang">リスト<span class="ref">6.42</span></a>のように書いてもよいことを、テストスイートを実行して確認してください。
</li>
<li>
<a class="hyperref" href="#sec-format_validation"><span class="ref">6.2.4</span></a>で説明したように、 <a class="hyperref" href="#code-validates_format_of_email">リスト<span class="ref">6.21</span></a>のメールアドレスチェックする正規表現は、“<em>foo@bar..com”</em>のようにドットが連続した無効なメールアドレスを許容してしまいます。このメールアドレスを<a class="hyperref" href="#code-email_format_validation_tests">リスト<span class="ref">6.19</span></a>の無効なメールアドレスリストに追加し、これによってテストが失敗することを確認してください。次に、<a class="hyperref" href="#code-better_email_regex">リスト<span class="ref">6.43</span></a>に示したもう少し複雑な正規表現を使用して、このテストがパスするようにしてください。
</li>
</ol>
<div class="codelisting" id="code-email_downcase_test" data-tralics-id="uid615" data-number="6.41">
<div class="heading">
<span class="number">リスト6.41:</span> 

<span class="description"><a class="hyperref" href="#code-email_downcase">リスト<span class="ref">6.31</span></a>のメールアドレス小文字変換をテストする <span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
    <span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"email addresses should be saved as lower-case"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">mixed_case_email</span> <span class="o">=</span> <span class="s2">"Foo@ExAMPle.CoM"</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class="hll">    <span class="n">assert_equal</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="nb">test</span> <span class="s2">"password should have a minimum length"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-downcase_bang" data-tralics-id="uid616" data-number="6.42">
<div class="heading">
<span class="number">リスト6.42:</span> 

<span class="description"><code>before_save</code>コールバックの別の実装 <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">, <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
<span class="k">end</span></span>
</pre></div></div>
</div>
<div class="codelisting" id="code-better_email_regex" data-tralics-id="uid617" data-number="6.43">
<div class="heading">
<span class="number">リスト6.43:</span> 

<span class="description">有効なメールアドレスかどうか (ドットが２つ以上連続するかどうか) を検証する正規表現 <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="hll">  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-]+(\.[a-z\d\-]+)*\.[a-z]+\z/i</span>
</span>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span>   <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">}</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div><div id="cha-6_footnotes">
  <div class="navigation">
<a class="next_page" href="sign_up?version=4.2#cha-sign_up"><span class="number">第7章</span>ユーザー登録</a><a class="prev_page" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="number">第5章</span>レイアウトを作成する</a>
</div>
<ol class="footnotes">
    <li id="cha-6_footnote-1">この名前の由来は “<a href="http://ja.wikipedia.org/wiki/Active_Record" target="_blank">active record pattern</a>” です。Martin Fowler著「<em>エンタープライズ アプリケーションアーキテクチャパターン </em>」で特定および命名されました。<a class="arrow" href="#cha-6_footnote-ref-1">↑</a>
</li>
    <li id="cha-6_footnote-2">「エスキューエル」と発音しますが、「スィークゥエル」もよく使われます。<a class="arrow" href="#cha-6_footnote-ref-2">↑</a>
</li>
    <li id="cha-6_footnote-3">メールアドレスをユーザー名にしたことで、ユーザー同士で通信できるように拡張できる可能性が開かれます (<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>)。<a class="arrow" href="#cha-6_footnote-ref-3">↑</a>
</li>
    <li id="cha-6_footnote-4">
<code>t</code>オブジェクトが具体的に何をしているのかを正確に知る必要はありませんので、どうか心配しないでください。<em>抽象化レイヤ</em>の素晴らしい点は、それが何であるかを知る必要がないという点です。安心して<code>t</code>オブジェクトに仕事を任せればよいのです。<a class="arrow" href="#cha-6_footnote-ref-4">↑</a>
</li>
    <li id="cha-6_footnote-5">公式には「エスキューエライト (ess-cue-ell-ite)」と発音しますが、(本来は誤りとされている)「スィークゥエライト (sequel-ite)」もよく使われています。<a class="arrow" href="#cha-6_footnote-ref-5">↑</a>
</li>
    <li id="cha-6_footnote-6">この唯一の例外が<a class="hyperref" href="following_users?version=4.2#sec-scopes_subselects_and_a_lambda"><span class="ref">12.3.3</span></a>に記されています。<a class="arrow" href="#cha-6_footnote-ref-6">↑</a>
</li>
    <li id="cha-6_footnote-7">
<code>"2014-07-24 00:57:46"</code>というタイムスタンプが気になった方もいると思いますが、著者はこの箇所を真夜中過ぎに書いたわけではありません。実はこのタイムスタンプは<a href="http://ja.wikipedia.org/wiki/%E5%8D%94%E5%AE%9A%E4%B8%96%E7%95%8C%E6%99%82" target="_blank">協定世界時 (UTC)</a> に合わせてあります。これは<a href="http://ja.wikipedia.org/wiki/Greenwich_Mean_Time" target="_blank">グリニッジ標準時 (GMT)</a> と同様、標準時間として使用されます。「<a href="http://tf.nist.gov/general/misc.htm" target="_blank">NIST時刻と周波数FAQ</a>」によると、<strong>問:</strong> 協定世界時 (Coordinated Universal Time) の略称がCUTではなくUTCなのはなぜですか 。<strong>答え:</strong> 協定世界時システムは、1970年に国際電気通信連合 (ITU) の技術専門家の国際諮問グループによって考案されました。このときITUは、混乱を最小限にとどめるために、略称を1つだけにしたいと考えました。このとき、英語式のCUTもフランス式のTUCも満場一致とならず、両者の妥協案としてUTCという略語が採用されました。<a class="arrow" href="#cha-6_footnote-ref-7">↑</a>
</li>
    <li id="cha-6_footnote-8">例外と例外ハンドリングは、ある意味でRubyの高度なテーマです。本書では例外についてこれ以上言及しません。しかし例外が重要なものであることも確かなので、<a class="hyperref" href="following_users?version=4.2#sec-guide_to_further_resources"><span class="ref">12.4.1</span></a>で推薦したRuby本で例外について詳しく学ぶことをおすすめします<a class="arrow" href="#cha-6_footnote-ref-8">↑</a>
</li>
    <li id="cha-6_footnote-9">
<code>update_attributes</code>メソッドは<code>update</code>メソッドのエイリアスですが、単一属性を変更する<code>update_attribute</code>メソッドとの違いを明確にするために、筆者は長いメソッド名の方を好んで使っています。<a class="arrow" href="#cha-6_footnote-ref-9">↑</a>
</li>
    <li id="cha-6_footnote-10">今後、コンソールコマンドの出力は、特に教育的効果が高いと思える場合 (ここでの<code>User.new</code>の場合など) を除いて省略いたします。<a class="arrow" href="#cha-6_footnote-ref-10">↑</a>
</li>
    <li id="cha-6_footnote-11">驚いたことに、公式標準によると、たとえば<code>"Michael Hartl"example.com</code>のようなクォートとスペースを使用したメールアドレスも有効なのだそうです。まったく馬鹿げています。<a class="arrow" href="#cha-6_footnote-ref-11">↑</a>
</li>
    <li id="cha-6_footnote-12">
<a class="hyperref" href="#table-valid_email_regex">表<span class="ref">6.1</span></a>の正規表現の説明における「文字」は、実は「小文字のみ」が対象になっていることに注意してください。ただし、正規表現の末尾に<code>i</code>オプションを追加してあるので、大文字小文字が区別されずにマッチするようになっています。<a class="arrow" href="#cha-6_footnote-ref-12">↑</a>
</li>
    <li id="cha-6_footnote-13">もしRubularのサービスが便利だと思ったら、素晴らしい功績を残した開発者である<a href="http://lovitt.net/" target="_blank">Michael Lovitt</a>さんに報いるために<a href="http://bit.ly/donate-to-rubular" target="_blank">Rubularへの寄付</a>をお勧めします.。<a class="arrow" href="#cha-6_footnote-ref-13">↑</a>
</li>
    <li id="cha-6_footnote-14">この節の冒頭で簡単に紹介したように、この目的に使用できる専用のテストデータベース<code>db/test.sqlite3</code>があります。<a class="arrow" href="#cha-6_footnote-ref-14">↑</a>
</li>
    <li id="cha-6_footnote-15">技術的には、メールアドレスのうちドメイン名部分だけが (本当は) 大文字小文字を区別しません。<em>foo@bar.com</em>は、本来は<em>Foo@bar.com</em>とは別のアドレスです。ただし現実的には、<a href="http://www.google.com/url?q=http%3A%2F%2Femail.about.com%2Fod%2Femailbehindthescenes%2Ff%2Femail_case_sens.htm&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFsOIZg6iqOmUM904TdpqZOQdeRXA">about.com</a>でも指摘されているように、メールアドレスの大文字小文字を区別することを前提にするのはまずい方法です。「メールアドレスの大文字小文字を区別すると、果てしない混乱と相互運用性の問題とひどい頭痛が発生する。メールアドレスの入力時に大文字小文字の区別を要求するのは賢い方法とは言えない。現実には、メールアドレスの大文字小文字の区別を強制するメールサービスやISPはめったに存在しない。メールアドレスのすべての文字を大文字にするなど、受信者のメールアドレスが誤って入力されていれば、メールは返送されるだけだ。」Riley Mosesによるご指摘に感謝いたします。<a class="arrow" href="#cha-6_footnote-ref-15">↑</a>
</li>
    <li id="cha-6_footnote-16">もちろん、<a class="hyperref" href="#code-users_migration">リスト<span class="ref">6.2</span></a>の<code>users</code>テーブル用のマイグレーションファイルを単に編集することも可能なのですが、その場合ロールバックが必要となり、マイグレーションが戻ってしまいます。データモデルの変更が必要になったらその都度マイグレーションを行うのがRails流です。<a class="arrow" href="#cha-6_footnote-ref-16">↑</a>
</li>
    <li id="cha-6_footnote-17">他にどんなコールバックがあるのか知りたい場合は、<a href="http://api.rubyonrails.org/v4.2.2/classes/ActiveRecord/Callbacks.html" target="_blank">Rails APIのコールバック</a> (英語) を読んでみてください。<a class="arrow" href="#cha-6_footnote-ref-17">↑</a>
</li>
    <li id="cha-6_footnote-18">ここでいう「<em>仮想的 (Virtual)</em>」とは、Userモデルのオブジェクトからは存在しているように見えるが、データベースには対応するカラムが存在しない、という意味です。<a class="arrow" href="#cha-6_footnote-ref-18">↑</a>
</li>
    <li id="cha-6_footnote-19">ハッシュ化されたパスワードは、<em>暗号化されたパスワード</em>とよく誤解されがちです。たとえば、(実は本書の第1版や第2版でも間違っていたのですが) <code>has_secure_password</code>の<a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">ソースコード</a>でもこの手の間違いがあります。というのも、専門用語としての「暗号」というのは、設計上<em>元に戻す</em>ことができることを指します (暗号化できるという文には、<em>復号もできる</em>というニュアンスが含まれます)。一方、「パスワードのハッシュ化」では<em>元に戻せない (不可逆)</em> という点が重要になります。したがって、 「計算量的に元のパスワードを復元するのは困難である」という点を強調するために、暗号化ではなくハッシュ化という用語を使っています。(この間違った用語について指摘してくれたAndy Philipsに感謝します。)<a class="arrow" href="#cha-6_footnote-ref-19">↑</a>
</li>
    <li id="cha-6_footnote-20">
<p>もしうまくいかなくても、いつでもデータベースの中身をリセットできるので安心してください。リセットしたい場合は、以下の手順を踏んでください。</p>
<ol>
<li>まずはコンソールから脱出してください (Ctrl-C)
</li>
<li>次に、コマンドラインから<code>$ rm -f development.sqlite3</code>を実行してデータベースの中身を削除してください(<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>でもっと便利なメソッドを紹介します)
</li>
<li>
<code>$ bundle exec rake db:migrate</code>コマンドを実行して、もう一度マイグレーションを走らせてください
</li>
<li>再度Railsコンソールを開き、コンソール上での作業をもう一度やり直してみてください
</li>
</ol>
&nbsp;<a class="arrow" href="#cha-6_footnote-ref-20">↑</a>
</li>
    <li id="cha-6_footnote-21">設計上、bcryptアルゴリズムではハッシュ化する前に<a href="https://en.wikipedia.org/wiki/Salt_(cryptography)" target="_blank">ソルト</a>を追加しています。これにより、<a href="https://ja.wikipedia.org/wiki/%E8%BE%9E%E6%9B%B8%E6%94%BB%E6%92%83" target="_blank">辞書攻撃 (Dictionary Attacks)</a> や<a href="https://ja.wikipedia.org/wiki/%E3%83%AC%E3%82%A4%E3%83%B3%E3%83%9C%E3%83%BC%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB" target="_blank">レインボーテーブル攻撃 (Rainbow Table Attacks)</a> といったタイプの攻撃を防ぐことができます。<a class="arrow" href="#cha-6_footnote-ref-21">↑</a>
</li>
    <li id="cha-6_footnote-22">
<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>で、<code>!!</code> という式が対応する論理値オブジェクト (!!nil =&gt; false) に変換されていたことを思い出してください。<a class="arrow" href="#cha-6_footnote-ref-22">↑</a>
</li>
  </ol>
</div>
          </div>

</body>
</html>
