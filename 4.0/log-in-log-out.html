<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
            




            
            
            <div id="cha-log_in_log_out" class="chapter" data-tralics-id="cid51" data-number="8" data-chapter="log_in_log_out">
<h1><a href="#cha-log_in_log_out" class="heading hyperref"><span class="number">第8章</span> ログイン、ログアウト</a></h1>
<p><a class="hyperref" href="sign_up?version=4.2#cha-sign_up">第<span class="ref">7</span>章</a>でWebサイトでの新規ユーザー登録が行えるようになりましたので、今度はユーザーがログインやログアウトを行えるようにしましょう。ここでは、Webのログインやログアウトで一般的に実装される、以下の3種類の動作をすべて実装することにします。1: ブラウザを閉じるとログインを破棄する (<a class="hyperref" href="#sec-sessions_and_failed_login"><span class="ref">8.1</span></a>と<a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>)。2: ユーザーのログインを<em>自動で</em>保存する (<a class="hyperref" href="#sec-remember_me"><span class="ref">8.4</span></a>)。3: ユーザーが「パスワードを保存する (remember me)」チェックボックスをオンにした<em>場合のみ</em>ログインを保存する (<a class="hyperref" href="#sec-remember_me_checkbox"><span class="ref">8.4.5</span></a>)<sup class="footnote" id="cha-8_footnote-ref-1"><a href="#cha-8_footnote-1">1</a></sup>。</p>
<p>本章で開発する認証 (authentication) システムによって、サイトをカスタマイズして現在のユーザーの「ログインステータス」と「ID」に基づいた認可 (authorization) モデルを実装することができます。たとえば、本章ではサイトヘッダーのログイン/ログアウトリンクやプロフィールリンクを改造します。次の<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users">第<span class="ref">9</span>章</a>で使用するセキュリティモデルでは、ログインしたユーザーだけが自分のindexページに移動できるようにしたり、正当なユーザーだけが自分のページのプロフィール情報を編集できるようにしたり、管理者だけが他のユーザーをデータベースから削除できるようにしたりします。最終的に、<a class="hyperref" href="user_microposts?version=4.2#cha-user_microposts">第<span class="ref">11</span>章</a>でマイクロポスト作成時にログイン済みユーザーのIDを使用してマイクロポストとユーザーを関連付け、<a class="hyperref" href="following_users?version=4.2#cha-following_users">第<span class="ref">12</span>章</a>で現在のユーザーが他のユーザーをアプリケーション上でフォローできるようにし、それによって相手のマイクロポストのフィードを自分のページに表示できるようにします。</p>
<p>本章では、アプリケーション全体で共通するログインシステムの細かい部分を多数扱うので、その分他の章に比べて長く、難易度も高くなっています。細部にとらわれると苦しくなるばかりなので、この章を完了するためにも、完璧に理解しようとするよりも、とにかく辛抱強く節をひとつずつ終わらせることを優先してください。なお、多くの読者が「この章を2回通して完了すると学習効果が非常に高まった」との報告を寄せてくれています。皆さんも、可能であればこの章を2回通して行うことをおすすめいたします。</p>
</div><div id="sec-sessions_and_failed_login" class="section" data-tralics-id="cid52" data-number="8.1">
<h2><a href="#sec-sessions_and_failed_login" class="heading hyperref"><span class="number">8.1 </span>セッション</a></h2>
<p><a href="http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">HTTP</a>は<a href="https://ja.wikipedia.org/wiki/Stateless_protocol" target="_blank"><em>ステートレスなプロトコル</em></a>です。文字通り「ステート (state)」が「ない (less)」ので、HTTPのリクエストひとつひとつは、それより前のリクエストの情報をまったく利用できない、独立したトランザクションとして扱われます。HTTPは言ってみれば、リクエストが終わると何もかも忘れて次回最初からやり直す健忘症的なプロトコルであり、過去を捨てた旅から旅の流れ者的なプロトコルです (しかし、だからこそこのプロトコルは非常に頑丈なのです)。この本質的な特性のため、ブラウザのあるページから別のページに移動したときに、ユーザーのIDを保持しておく手段が<a href="http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state" target="_blank">HTTPプロトコル内「には」</a>まったくありません。ユーザーログインの必要なWebアプリケーションでは、<a href="http://ja.wikipedia.org/wiki/Session_(computer_science)" target="_blank"><em>セッション</em></a>と呼ばれる半永続的な接続をコンピュータ間 (ユーザーのパソコンのWebブラウザとRailsサーバーなど) に別途設定します。セッションはHTTPプロトコルと階層が異なる (上の階層にある) ので、HTTPの特性とは別に (若干影響は受けるものの) 接続を確保できます。(訳注: 昔は離れた相手と一手ずつ葉書をやりとりしてのんびりと将棋を指す酔狂な人がときどきいましたが、将棋の対戦をひとつのセッションと考えれば、その下の郵便システムはHTTP同様ステートレスであり、対戦者同士が盤の状態を保持していれば、郵便システムや郵便配達夫が対戦の進行や内容に一切かかわらなくてもゲームは成立します)。</p>
<p>Railsでセッションを実装する方法として最も一般的なのは、<a href="http://ja.wikipedia.org/wiki/HTTP_cookie" target="_blank"><em>cookies</em></a>を使用する方法です。cookiesとは、ユーザーのブラウザに保存される小さなテキストデータです。cookiesは、あるページから別のページに移動した時にも破棄されないので、ここにユーザーIDなどの情報を保存できます。アプリケーションはcookies内のデータを使用して、たとえばログイン中のユーザーが所有する情報をデータベースから取り出すことができます。本節および<a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>では、その名も<code>session</code>というRailsのメソッドを使用して一時セッションを作成します。この一時セッションは、ブラウザを閉じると自動的に終了します<sup class="footnote" id="cha-8_footnote-ref-2"><a href="#cha-8_footnote-2">2</a></sup>。続いて<a class="hyperref" href="#sec-remember_me"><span class="ref">8.4</span></a>では、Railsの別の<code>cookies</code>メソッドを使用して、もう少し長続きするセッションを追加します。</p>
<p>セッションをRESTfulなリソースとしてモデリングできると、他のRESTfulリソースと統一的に理解できて便利です。ログインページでは<em>new</em>で新しいセッションを出力し、そのページでログインすると<em>create</em>でセッションを実際に作成して保存し、ログアウトすると<em>destroy</em>でセッションを破棄する、といった具合です。ただしUsersリソースと異なるのは、UsersリソースではバックエンドでUserモデルを介してデータベース上の永続的データにアクセスするのに対し、Sessionリソースでは代わりにcookiesを保存場所として使用する点です。ログインのしくみの大半は、cookiesを使用した認証メカニズムによって構築されています。本節と次の節では、セッション機能を作成する準備として、Sessionコントローラ、ログイン用のフォーム、両者に関連するコントローラのアクションを作成します。<a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>では、セッションを操作するために必要なコードをいくつか追加し、ユーザーログインを完成させる予定です。</p>
<p>前章同様に、トピックブランチで作業してから、最後に更新をマージします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b log-in-log-out
</pre></div></div>
<div id="sec-sessions_controller" class="subsection" data-tralics-id="uid727" data-number="8.1.1">
<h3><a href="#sec-sessions_controller" class="heading hyperref"><span class="number">8.1.1</span> Sessionsコントローラ</a></h3>
<p>ログインとログアウトの要素を、Sessionsコントローラの特定のRESTアクションにそれぞれ対応付けることにします。ログインのフォームは、この節で扱う<code>new</code>アクションで処理します。<code>create</code>アクションに<span class="tt">POST</span>リクエストを送信すると、実際にログインします (<a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>)。<code>destroy</code>アクションに<span class="tt">DELETE</span>リクエストを送信すると、ログアウトします (<a class="hyperref" href="#sec-logging_out"><span class="ref">8.3</span></a>) (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>のHTTPメソッドとRESTアクションの関連付けを思い出しましょう)。</p>
<p>最初に、Sessionsコントローラと<code>new</code>アクションを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions new
</pre></div></div>
<p class="noindent"><code>new</code>アクションを生成すると、それに対応する<em>ビュー</em>も生成されます。<code>create</code>や<code>destroy</code>には対応するビューがない (=不要) なので、無駄なビューを作成しないためにここではnewだけを指定しています。<a class="hyperref" href="sign_up?version=4.2#sec-signup_form"><span class="ref">7.2</span></a>のユーザー登録ページのときと同様に、<a class="hyperref" href="#fig-login_mockup">図<span class="ref">8.1</span></a>モックアップを元にセッション新規開始用のログインフォームを作成します。</p>
<div class="center figure" id="fig-login_mockup" data-tralics-id="uid728" data-number="8.1">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_mockup.png" alt="images/figures/login_mockup"></div>
<div class="caption">
<span class="header">図8.1: </span><span class="description">ログインフォームのモックアップ
</span>
</div>
</div>
<p>Usersリソースのときは専用の<code>resources</code>メソッドを使用してRESTfulなルーティングを自動的にフルセットで利用できるようにしました (<a class="hyperref" href="sign_up?version=4.2#code-users_resource">リスト<span class="ref">7.3</span></a>) が、Sessionリソースではフルセットはいらないので、「名前付きルーティング」だけを使用します。この名前付きルーティングでは、<span class="tt">GET</span>リクエストや<span class="tt">POST</span>リクエストを<code>login</code>ルーティングで、<span class="tt">DELETE</span>リクエストを<code>logout</code>ルーティングで扱います。このルーティングを反映したものを<a class="hyperref" href="#code-sessions_resource">リスト<span class="ref">8.1</span></a>に示します。なお、<code>rails generate controller</code>で生成された不要なルートは、このリストから削除してあります。</p>
<div class="codelisting" id="code-sessions_resource" data-tralics-id="uid729" data-number="8.1">
<div class="heading">
<span class="number">リスト8.1:</span> 

<span class="description">リソースを追加して標準的なRESTfulアクションをgetできるようにする <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
<span class="hll">  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
</span><span class="hll">  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
</span><span class="hll">  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
</span>  <span class="n">resources</span> <span class="ss">:users</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-sessions_resource">リスト<span class="ref">8.1</span></a>で定義したルーティングのURLやアクション (<a class="hyperref" href="#table-RESTful_sessions">表<span class="ref">8.1</span></a>) は、ユーザー用のURLやアクション (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>) とだいたい似ています。</p>
<div class="table" id="table-RESTful_sessions" data-tralics-id="uid730" data-number="8.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>HTTPリクエスト</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>名前付きルート</strong></td>
<td class="align_left"><strong>アクション</strong></td>
<td class="align_left"><strong>用途</strong></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>new</code></td>
<td class="align_left">新しいセッションのページ (ログイン)</td>
</tr>
<tr>
<td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>create</code></td>
<td class="align_left">新しいセッションの作成 (ログイン)</td>
</tr>
<tr>
<td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/logout</td>
<td class="align_left"><code>logout_path</code></td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">セッションの削除 (ログアウト)</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表8.1</span> <span class="description"><a class="hyperref" href="#code-sessions_resource">リスト<span class="ref">8.1</span></a>のセッションルールによって提供されるルーティング
</span>
</div>
</div>
<p>これまでに名前付きルーティングをだいぶ追加してきたので、ここでアプリケーションの全ルーティングを表示できると便利です。<code>rake routes</code>コマンドを実行すればいつでもルーティングのリストを表示できます。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake routes
 Prefix Verb   URI Pattern               Controller#Action
     root GET    /                         static_pages#home
     help GET    /help(.:format)           static_pages#help
    about GET    /about(.:format)          static_pages#about
  contact GET    /contact(.:format)        static_pages#contact
   signup GET    /signup(.:format)         users#new
    login GET    /login(.:format)          sessions#new
          POST   /login(.:format)          sessions#create
   logout DELETE /logout(.:format)         sessions#destroy
    users GET    /users(.:format)          users#index
          POST   /users(.:format)          users#create
 new_user GET    /users/new(.:format)      users#new
edit_user GET    /users/:id/edit(.:format) users#edit
     user GET    /users/:id(.:format)      users#show
          PATCH  /users/:id(.:format)      users#update
          PUT    /users/:id(.:format)      users#update
          DELETE /users/:id(.:format)      users#destroy
</pre></div></div>
<p class="noindent">今はこのルーティングを完全に理解できる必要はありません。それでもこのリストを何となく眺めてみれば、アプリケーションでサポートされている全アクションがこのリストにあることに気付くと思います。</p>
</div>
<div id="sec-login_form" class="subsection" data-tralics-id="uid731" data-number="8.1.2">
<h3><a href="#sec-login_form" class="heading hyperref"><span class="number">8.1.2 </span>ログインフォーム</a></h3>
<p>コントローラとルーティングを定義したので、今度は新しいセッションで使用するビュー、つまりログインフォームを整えましょう。<a class="hyperref" href="#fig-login_mockup">図<span class="ref">8.1</span></a>と<a class="hyperref" href="sign_up?version=4.2#fig-signup_mockup">図<span class="ref">7.11</span></a>を比較してみると、ログインフォームとユーザー登録フォームにはほとんど違いがないことがわかります。違いは、4つあったフィールドが [Email] と [Password] の2つに減っていることだけです。</p>
<p>ログインフォームで入力した情報に誤りがあったときは、ログインページをもう一度表示してエラーメッセージを出力します (<a class="hyperref" href="#fig-login_failure_mockup">図<span class="ref">8.2</span></a>)。<a class="hyperref" href="sign_up?version=4.2#sec-signup_error_messages"><span class="ref">7.3.3</span></a>では、エラーメッセージの表示にエラーメッセージ用パーシャル (部分テンプレート) を使用しましたが、そのエラーメッセージはActive Recordによって自動的に表示されていたことを思い出しましょう。セッションはActive Recordオブジェクトではないので、上のようにActive Recordがよしなにエラーメッセージを表示してくれるということは期待できません。そこで、ここではフラッシュメッセージでエラーを表示します。</p>
<div class="center figure" id="fig-login_failure_mockup" data-tralics-id="uid732" data-number="8.2">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_failure_mockup.png" alt="images/figures/login_failure_mockup"></div>
<div class="caption">
<span class="header">図8.2</span> <span class="description">ログイン失敗時のモックアップ
</span>
</div>
</div>
<p><a class="hyperref" href="sign_up?version=4.2#code-signup_form">リスト<span class="ref">7.13</span></a>のときは、以下のようにユーザー登録フォームで<code>form_for</code>ヘルパーを使用し、ユーザーのインスタンス変数<code>@user</code>を引数にとっていました。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">セッションフォームとユーザー登録フォームの最大の違いは、セッションにはSessionモデルというものがなく、そのため<code>@user</code>のようなインスタンス変数に相当するものもない点です。従って、新しいセッションフォームを作成するときには、<code>form_for</code>ヘルパーに追加の情報を独自に渡さなければなりません。</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">Railsでは上のように書くだけで、「フォームの<code>action</code>は/usersというURLへの<span class="tt">POST</span>である」と自動的に判定しますが、セッションの場合はリソースの<em>名前</em>とそれに対応するURLを具体的に指定する必要があります<sup class="footnote" id="cha-8_footnote-ref-3"><a href="#cha-8_footnote-3">3</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span>
</pre></div></div>
<p>適切な<code>form_for</code>を使用することで、<a class="hyperref" href="sign_up?version=4.2#code-signup_form">リスト<span class="ref">7.13</span></a>のユーザー登録フォームを参考にして、<a class="hyperref" href="#code-login_form">リスト<span class="ref">8.2</span></a>に示したようなモックアップに従ったログインフォームを簡単に作成できます (<a class="hyperref" href="#fig-login_mockup">図<span class="ref">8.1</span></a>)。</p>
<div class="codelisting" id="code-login_form" data-tralics-id="uid734" data-number="8.2">
<div class="heading">
<span class="number">リスト8.2:</span> 

<span class="description">ログインフォームのコード <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ユーザーがすぐクリックできるように、ユーザー登録ページのリンクを追加してあることにご注目ください。<a class="hyperref" href="#code-login_form">リスト<span class="ref">8.2</span></a>のコードを使用すると、<a class="hyperref" href="#fig-login_form">図<span class="ref">8.3</span></a>のようにログインフォームが表示されます ([Log in] リンクがまだ効かないので、自分でブラウザのアドレスバーに「/login」とURLを直接入力してください。ログインリンクは<a class="hyperref" href="#sec-changing_the_layout_links"><span class="ref">8.2.3</span></a>で動くようにします)。</p>
<div class="center figure" id="fig-login_form" data-tralics-id="uid735" data-number="8.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/login_form.png" alt="images/figures/login_form"></div>
<div class="caption">
<span class="header">図8.3: </span><span class="description">ログインフォーム
</span>
</div>
</div>
<p>生成されたHTMLフォームを<a class="hyperref" href="#code-login_form_html">リスト<span class="ref">8.3</span></a>に示します。</p>
<div class="codelisting" id="code-login_form_html" data-tralics-id="uid736" data-number="8.3">
<div class="heading">
<span class="number">リスト8.3:</span> 

<span class="description"><a class="hyperref" href="#code-login_form">リスト<span class="ref">8.2</span></a>で生成したログインフォームのHTML
</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"utf8"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"&amp;#x2713;"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span>
         <span class="na">value=</span><span class="s">"NNb6+J/j46LcrgYUC60wQ2titMuJQ5lLqyAbnbAUkdo="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"session_email"</span>
         <span class="na">name=</span><span class="s">"session[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_password"</span> <span class="na">name=</span><span class="s">"session[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
       <span class="na">value=</span><span class="s">"Log in"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-login_form_html">リスト<span class="ref">8.3</span></a>と<a class="hyperref" href="sign_up?version=4.2#code-signup_form_html">リスト<span class="ref">7.15</span></a>を比較することで、フォーム送信後に<code>params</code>ハッシュに入る値が、メールアドレスとパスワードのフィールドにそれぞれ対応した<code>params[:session][:email]</code>と<code>params[:session][:password]</code>になることが推測できると思います。</p>
</div>
<div id="sec-finding_and_authenticating_a_user" class="subsection" data-tralics-id="uid737" data-number="8.1.3">
<h3><a href="#sec-finding_and_authenticating_a_user" class="heading hyperref"><span class="number">8.1.3 </span>ユーザーの検索と認証</a></h3>
<p>ユーザー登録では最初にユーザーを作成しましたが、ログインでセッションを作成する場合に最初に行うのは、入力が<em>無効な</em>場合の処理です。最初に、フォームが送信されたときの動作を順を追って理解します。次に、ログインが失敗した場合に表示されるエラーメッセージを配置します (モックアップを<a class="hyperref" href="#fig-login_failure_mockup">図<span class="ref">8.2</span></a>に示します)。次に、ログインに成功した場合 (<a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>) に使用する土台部分を作成します。ここでは、ログインが送信されるたびに、パスワードとメールアドレスの組み合わせが有効かどうかを判定します。</p>
<p>それでは、最初に最小限の<code>create</code>アクションをSessionsコントローラで定義し、空の<code>new</code>アクションと<code>destroy</code>アクションもついでに作成しておきましょう (<a class="hyperref" href="#code-initial_create_session">リスト<span class="ref">8.4</span></a>)。<a class="hyperref" href="#code-initial_create_session">リスト<span class="ref">8.4</span></a>の<code>create</code>アクションの中では何も行われませんが、アクションを実行すると<code>new</code>ビューが出力されるのでこれで十分です。<a href="http://localhost:3000/sessions/new" target="_blank">/sessions/new</a>フォームを送信すると<a class="hyperref" href="#fig-initial_failed_login_rails_3">図<span class="ref">8.4</span></a>のようになります。</p>
<div class="codelisting" id="code-initial_create_session" data-tralics-id="uid738" data-number="8.4">
<div class="heading">
<span class="number">リスト8.4:</span> 

<span class="description">Sessionsコントローラの<code>create</code>アクション (暫定版)<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">render</span> <span class="s1">'new'</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-initial_failed_login_rails_3" data-tralics-id="uid739" data-number="8.4">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/initial_failed_login_3rd_edition.png" alt="images/figures/initial_failed_login_3rd_edition"></div>
<div class="caption">
<span class="header">図8.4: </span><span class="description"><a class="hyperref" href="#code-initial_create_session">リスト<span class="ref">8.4</span></a>の<code>create</code>で最初に失敗したログイン
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-initial_failed_login_rails_3">図<span class="ref">8.4</span></a>に表示されているデバッグ情報にご注目ください。<a class="hyperref" href="#sec-login_form"><span class="ref">8.1.2</span></a>の終わりでも簡単に触れましたが、<code>params</code>ハッシュでは、以下のように<code>session</code>キーの下にメールアドレスとパスワードがあります。</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">'user@example.com'</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">'foobar'</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Log in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div></div>
<p class="noindent">ユーザー登録の場合 (<a class="hyperref" href="sign_up?version=4.2#fig-signup_failure">図<span class="ref">7.15</span></a>) と同様、これらのパラメータは<a class="hyperref" href="rails_flavored_ruby?version=4.2#code-nested_hashes">リスト<span class="ref">4.10</span></a>に示したように<em>ネストした (入れ子になった) </em>ハッシュになっていました。特に、<code>params</code>は以下のような入れ子ハッシュになっています。ハッシュの中にハッシュがある構造です。</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">これはつまり、</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">上自体もハッシュであり、以下の要素を含んでいます。</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">その結果、</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">上はフォームから送信されたメールアドレスであり、</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">上はフォームから送信されたパスワードです。</p>
<p>要するに<code>create</code>アクションの中では、ユーザーの認証に必要なあらゆる情報を<code>params</code>ハッシュから簡単に取り出せるということです。そして、認証に必要なすべてのメソッドもここまでに学んであります (そうなるように本書を書いたのです)。ここでは、Active Recordが提供する<code>User.find_by</code>メソッド (<a class="hyperref" href="modeling_users?version=4.2#sec-finding_user_objects"><span class="ref">6.1.4</span></a>) と、<code>has_secure_password</code>が提供する<code>authenticate</code>メソッド (<a class="hyperref" href="modeling_users?version=4.2#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>) を使用します。<code>authenticate</code>メソッドは認証に失敗したときに<code>false</code>を返す (<a class="hyperref" href="modeling_users?version=4.2#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>) ことを思い出しましょう。以上をまとめてユーザーログインを実装したものを<a class="hyperref" href="#code-find_authenticate_user">リスト<span class="ref">8.5</span></a>に示します。</p>
<div class="codelisting" id="code-find_authenticate_user" data-tralics-id="uid740" data-number="8.5">
<div class="heading">
<span class="number">リスト8.5:</span> 

<span class="description">ユーザーをデータベースから見つけて検証する<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="c1"># ユーザーログイン後にユーザー情報のページにリダイレクトする</span>
    <span class="k">else</span>
      <span class="c1"># エラーメッセージを作成する</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ハイライト部分の最初の行 (<a class="hyperref" href="#code-find_authenticate_user">リスト<span class="ref">8.5</span></a>) では、送信されたメールアドレスを使用して、データベースからユーザーを取り出しています (<a class="hyperref" href="modeling_users?version=4.2#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>ではメールアドレスをすべて小文字で保存していたことを思い出しましょう。そこでここでは<code>downcase</code>メソッドを使用して、有効なメールアドレスが入力されたときに確実にマッチするようにしています)。次の行は少しわかりにくいかもしれませんが、Railsプログラミングでは定番の手法です。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent"><code>&amp;&amp;</code> (<em>論理積</em>) は、取得したユーザーが有効かどうかを決定するのに使用します。Rubyでは<code>nil</code>と<code>false</code>以外のすべてのオブジェクトは、真偽値では<code>true</code>になる (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>) という性質を考慮すると、&amp;&amp;の前後の値の組み合わせは<a class="hyperref" href="#table-user_and_and">表<span class="ref">8.2</span></a>のようになります。<a class="hyperref" href="#table-user_and_and">表<span class="ref">8.2</span></a>を見ると、入力されたメールアドレスを持つユーザーがデータベースに存在し、かつ入力されたパスワードがそのユーザーのパスワードである場合のみ、<code>if</code>文が<code>true</code>になることがわかります。言葉でまとめると「ユーザーがデータベースにあり、かつ、認証に成功した場合にのみ」となります。</p>
<div class="table" id="table-user_and_and" data-tralics-id="uid741" data-number="8.2">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>ユーザー</strong></td>
<td class="align_left"><strong>パスワード</strong></td>
<td class="align_left"><strong>a &amp;&amp; b</strong></td>
</tr>
<tr>
<td class="align_left">存在しない</td>
<td class="align_left"><em>何でもよい</em></td>
<td class="align_left"><code>(nil &amp;&amp; [anything]) == false</code></td>
</tr>
<tr>
<td class="align_left">有効なユーザー</td>
<td class="align_left">誤ったパスワード</td>
<td class="align_left"><code>(true &amp;&amp; false) == false</code></td>
</tr>
<tr>
<td class="align_left">有効なユーザー</td>
<td class="align_left">正しいパスワード</td>
<td class="align_left"><code>(true &amp;&amp; true) == true</code></td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表8.2</span> <span class="description"><code>user &amp;&amp; user.authenticate(…)</code>の結果の組み合わせ
</span>
</div>
</div>
</div>
<div id="sec-rendering_with_a_flash_message" class="subsection" data-tralics-id="uid742" data-number="8.1.4">
<h3><a href="#sec-rendering_with_a_flash_message" class="heading hyperref"><span class="number">8.1.4</span> フラッシュメッセージを表示する</a></h3>
<p><a class="hyperref" href="sign_up?version=4.2#sec-signup_error_messages"><span class="ref">7.3.2</span></a>では、ユーザー登録のエラーメッセージ表示にUserモデルのエラーメッセージをうまく利用したことを思い出しましょう。ユーザー登録の場合、エラーメッセージは特定のActive Recordオブジェクトに関連付けられていたのでその手が使えました。しかしセッションではActive Recordのモデルを使用していないため、その手が通用しません。そこで、ログインに失敗したときには代わりにフラッシュメッセージを表示することにします。最初のコードを<a class="hyperref" href="#code-failed_login_attempt">リスト<span class="ref">8.6</span></a>に示します (このコードはわざと少し間違えてあります)。</p>
<div class="codelisting" id="code-failed_login_attempt" data-tralics-id="uid743" data-number="8.6">
<div class="heading">
<span class="number">リスト8.6:</span> 

<span class="description">ログイン失敗時の処理を扱う (誤りあり)<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーログイン後にユーザー情報のページにリダイレクトする</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span> <span class="c1"># 本当は正しくない</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">フラッシュメッセージはWebサイトのレイアウトに表示される (<a class="hyperref" href="sign_up?version=4.2#code-layout_flash">リスト<span class="ref">7.25</span></a>) ので、<code>flash[:danger]</code>で設定したメッセージは自動的に表示されます。Bootstrap CSSのおかげで適切なスタイルも与えられます (<a class="hyperref" href="#fig-failed_login_flash">図<span class="ref">8.5</span></a>)。</p>
<div class="center figure" id="fig-failed_login_flash" data-tralics-id="uid744" data-number="8.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/failed_login_flash_3rd_edition.png" alt="images/figures/failed_login_flash_3rd_edition"></div>
<div class="caption">
<span class="header">図8.5: </span><span class="description">ログインに失敗したときのフラッシュメッセージ
</span>
</div>
</div>
<p>本文および<a class="hyperref" href="#code-failed_login_attempt">リスト<span class="ref">8.6</span></a>のコメントで述べたように、このコードには誤りがあります。ページにはちゃんとエラーメッセージが表示されていますが、どこが問題なのでしょうか。実は上のコードのままでは、<em>リクエスト</em>のフラッシュメッセージが一度表示されると消えずに残ってしまいます。<a class="hyperref" href="sign_up?version=4.2#code-signup_flash">リスト<span class="ref">7.24</span></a>でリダイレクトを使用したときとは異なり、表示したテンプレートを<code>render</code>メソッドで強制的に再レンダリングしてもリクエストと見なされないため、リクエストのメッセージが消えません。たとえば、わざと無効な情報を入力して送信してエラーメッセージを表示してから、Homeページをクリックして移動すると、そこでもフラッシュメッセージが表示されたままになっています (<a class="hyperref" href="#fig-flash_persistence">図<span class="ref">8.6</span></a>)。この問題は<a class="hyperref" href="#sec-a_flash_test"><span class="ref">8.1.5</span></a>で修正します。</p>
<div class="center figure" id="fig-flash_persistence" data-tralics-id="uid745" data-number="8.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/flash_persistence_3rd_edition.png" alt="images/figures/flash_persistence_3rd_edition"></div>
<div class="caption">
<span class="header">図8.6</span> <span class="description">フラッシュメッセージが消えずに残っている例
</span>
</div>
</div>
</div>
<div id="sec-a_flash_test" class="subsection" data-tralics-id="uid746" data-number="8.1.5">
<h3><a href="#sec-a_flash_test" class="heading hyperref"><span class="number">8.1.5 </span>フラッシュのテスト</a></h3>
<p>フラッシュメッセージが消えない問題は、このアプリケーションの小さなバグです。<a class="hyperref" href="static_pages?version=4.2#aside-when_to_test">コラム<span class="ref">3.3</span></a>で解説したテストガイドラインの教えに従えば、これはまさに「エラーをキャッチするテストを先に書いて、そのエラーが解決するようにコードを書く」に該当する状況です。さっそく、ログインフォームの送信について簡単な統合テストを作成することから始めましょう。この統合テストは、そのままバグのドキュメントにもなり、今後の回帰バグ発生を防止する効能もあります。さらに、今後この統合テストを土台として、より本格的な統合テストを作成するときにも便利です。</p>
<p>アプリケーションのログインの挙動をテストするために、最初に統合テストを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="gp">$</span> rails generate integration_test users_login
</span><span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_login_test.rb</span>
</pre></div></div>
<p class="noindent">次に、<a class="hyperref" href="#fig-failed_login_flash">図<span class="ref">8.5</span></a>と<a class="hyperref" href="#fig-flash_persistence">図<span class="ref">8.6</span></a>の手順をテストコードで再現する必要があります。基本的な流れを以下に示します。</p>
<ol>
<li>ログイン用のパスを開く
</li>
<li>新しいセッションのフォームが正しく表示されたことを確認する
</li>
<li>わざと無効な<code>params</code>ハッシュを使用してセッション用パスにPOSTする
</li>
<li>新しいセッションのフォームが再度表示され、フラッシュメッセージが追加されることを確認する
</li>
<li>別のページ (Homeページなど) にいったん移動する
</li>
<li>移動先のページでフラッシュメッセージが表示<em>されていない</em>ことを確認する
</li>
</ol>
<p class="noindent">上のテスト手順の実装を<a class="hyperref" href="#code-flash_persistence_test">リスト<span class="ref">8.7</span></a>に示します。</p>
<div class="codelisting" id="code-flash_persistence_test" data-tralics-id="uid753" data-number="8.7">
<div class="heading">
<span class="number">リスト8.7:</span> 

<span class="description">フラッシュメッセージの残留をキャッチするテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"login with invalid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-flash_persistence_test">リスト<span class="ref">8.7</span></a>のテストを追加すると、このログインテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid754" data-tralics-id="uid754" data-number="8.8">
<div class="heading">
<span class="number">リスト8.8:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb
</pre></div></div>
</div>
<p class="noindent">上のように、引数で<code>TEST</code>にテストファイルのフルパスを与えると、そのテストファイルだけを実行できます。</p>
<p><a class="hyperref" href="#code-flash_persistence_test">リスト<span class="ref">8.7</span></a>の失敗するテストをパスさせるには、本編のコードで<code>flash</code>を<code>flash.now</code>に置き換えます。後者は、レンダリングが終わっているページで特別にフラッシュメッセージを表示することができます。<code>flash</code>のメッセージとは異なり、<code>flash.now</code>のメッセージはその後リクエストが発生したときに消滅します (<a class="hyperref" href="#code-flash_persistence_test">リスト<span class="ref">8.7</span></a>ではまさにその手順を再現しています)。置き換えの終わった正しいアプリケーションコードを<a class="hyperref" href="#code-correct_login_failure">リスト<span class="ref">8.9</span></a>に示します。</p>
<div class="codelisting" id="code-correct_login_failure" data-tralics-id="uid755" data-number="8.9">
<div class="heading">
<span class="number">リスト8.9:</span> 

<span class="description">ログイン失敗時の正しい処理<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーログイン後にユーザー情報のページにリダイレクトする</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>続いて、ログインの統合テストを含む全テストスイートを実行してみると、<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になることを確認できます。</p>
<div class="codelisting" id="uid756" data-tralics-id="uid756" data-number="8.10">
<div class="heading">
<span class="number">リスト8.10:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb
$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-logging_in" class="section" data-tralics-id="cid53" data-number="8.2">
<h2><a href="#sec-logging_in" class="heading hyperref"><span class="number">8.2 </span>ログイン</a></h2>
<p>無効な値の送信をログインフォームで正しく処理できるようになったので、次は、実際にログイン中の状態での有効な値の送信を、フォームで正しく扱えるようにします。この節では、cookiesを使用する一時セッションでユーザーをログインできるようにします。このcookiesは、ブラウザを閉じると自動的に有効期限が切れるものを使用します。<a class="hyperref" href="#sec-remember_me"><span class="ref">8.4</span></a>では、ブラウザを閉じても保持されるセッションを追加します。</p>
<p>セッションを実装するには、様々なコントローラやビューでおびただしい数の関数を定義する必要があります。Rubyの<em>モジュール</em>という機能を使用すると、そうした関数を一箇所にパッケージ化できることを<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-back_to_the_title_helper"><span class="ref">4.2.5</span></a>で学びました。ありがたいことに、Sessionsコントローラ (<a class="hyperref" href="#sec-sessions_controller"><span class="ref">8.1.1</span></a>) を生成した時点で既にセッション用ヘルパーモジュールも (密かに) 自動生成されています。さらに、Railsのセッション用ヘルパーはビューにも自動でインクルードされます。Railsの全コントローラのベースクラス (=Application コントローラ) にこのモジュールをインクルードすれば、このアプリケーションのコントローラでも使えるようになります (<a class="hyperref" href="#code-sessions_helper_include">リスト<span class="ref">8.11</span></a>)。</p>
<div class="codelisting" id="code-sessions_helper_include" data-tralics-id="uid757" data-number="8.11">
<div class="heading">
<span class="number">リスト8.11:</span> 

<span class="description">ApplicationコントローラにSessionヘルパーモジュールをインクルードする<span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
<span class="hll">  <span class="kp">include</span> <span class="no">SessionsHelper</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">設定が完了したら、いよいよユーザーログインのコードを書き始めましょう。</p>
<div id="sec-a_working_log_in_method" class="subsection" data-tralics-id="uid758" data-number="8.2.1">
<h3><a href="#sec-a_working_log_in_method" class="heading hyperref"><span class="number">8.2.1 </span><span class="tt">log_in</span>メソッド</a></h3>
<p>Railsで事前定義済みの<code>session</code>メソッドを使用して、単純なログインを行えるようにします (なお、これは<a class="hyperref" href="#sec-sessions_controller"><span class="ref">8.1.1</span></a>で生成したSessionsコントローラとは無関係ですのでご注意ください)。この<code>session</code>メソッドはハッシュのように扱えるので、以下のように代入します。</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p class="noindent">上のコードを実行すると、ユーザーのブラウザ内の一時cookiesに暗号化済みのユーザーIDが自動で作成されます。この後のページで、<code>session[:user_id]</code>を使用してユーザーIDを元通りに取り出すことができます。一方、<code>cookies</code>メソッド (<a class="hyperref" href="#sec-remember_me"><span class="ref">8.4</span></a>) の場合は、<code>session</code>メソッドで作成された一時cookiesは、ブラウザを閉じた瞬間に有効期限が終了します。</p>
<p>同じログイン手法を様々な場所で使い回せるようにするために、Sessionsヘルパーに<code>log_in</code>という名前のメソッドを定義することにします (<a class="hyperref" href="#code-log_in_function">リスト<span class="ref">8.12</span></a>)</p>
<div class="codelisting" id="code-log_in_function" data-tralics-id="uid759" data-number="8.12">
<div class="heading">
<span class="number">リスト8.12:</span> 

<span class="description"><code>log_in</code>関数 <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><code>session</code>メソッドで作成した一時cookiesは自動的に暗号化され、<a class="hyperref" href="#code-log_in_function">リスト<span class="ref">8.12</span></a>のコードは保護されます。そしてここが重要なのですが、攻撃者がたとえこの情報をcookiesから盗み出すことができたとしても、それを使って本物のユーザーとしてログインすることはできないのです。ただし今述べたことは、<code>session</code>メソッドで作成した「一時セッション」にしか該当しません。<code>cookies</code>メソッドで作成した「永続的セッション」ではそこまで断言は<em>できません</em>。永続的なcookiesには、<em>セッションハイジャック</em>という攻撃を受ける可能性が常につきまといます。ユーザーのブラウザ上に保存される情報については、<a class="hyperref" href="#sec-remember_me"><span class="ref">8.4</span></a>でもう少し注意深く扱うことにします。</p>
<p><a class="hyperref" href="#code-log_in_function">リスト<span class="ref">8.12</span></a>で<code>log_in</code>というヘルパーメソッドを定義できたので、やっと、ユーザーログインを行ってセッションの<code>create</code>アクションを完了し、ユーザーのプロフィールページにリダイレクトする準備ができました。作成したコードを<a class="hyperref" href="#code-log_in_success">リスト<span class="ref">8.13</span></a>に示します<sup class="footnote" id="cha-8_footnote-ref-4"><a href="#cha-8_footnote-4">4</a></sup>。</p>
<div class="codelisting" id="code-log_in_success" data-tralics-id="uid761" data-number="8.13">
<div class="heading">
<span class="number">リスト8.13:</span> 

<span class="description">ユーザーにログインする<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">以下の簡単なリダイレクトは、</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">user</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="sign_up?version=4.2#sec-the_finished_signup_form"><span class="ref">7.4.1</span></a>でも使用しました。Railsでは、自動的に上のコードを変換して、以下のようなユーザープロフィールページへのルーティングします。</p>
<div class="code"><div class="highlight"><pre><span class="n">user_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p><a class="hyperref" href="#code-log_in_success">リスト<span class="ref">8.13</span></a>で<code>create</code>アクションを定義できたので、<a class="hyperref" href="#code-login_form"><span class="ref">8.2</span></a>で定義したログインフォームも正常に動作するようになったはずです。今はログインしても画面表示が何も変わらないので、ユーザーがログイン中かどうかは、ブラウザセッションを直接確認しない限りわかりません。このままでは困るので、ログインしていることがはっきりわかるようにします。そこで<a class="hyperref" href="#sec-current_user"><span class="ref">8.2.2</span></a>では、セッションに含まれるIDを利用して、データベースから現在のユーザー名を取り出して画面で表示する予定です。<a class="hyperref" href="#sec-changing_the_layout_links"><span class="ref">8.2.3</span></a>では、アプリケーションのレイアウト上のリンクを変更する予定です。このリンクをクリックすると、現在ログオンしているユーザーのプロフィールが表示されます。</p>
</div>
<div id="sec-current_user" class="subsection" data-tralics-id="uid762" data-number="8.2.2">
<h3><a href="#sec-current_user" class="heading hyperref"><span class="number">8.2.2</span> 現在のユーザー</a></h3>
<p>ユーザーIDを一時セッションの中に安全に置けるようになったので、今度はそのユーザーIDを別のページで取り出すことにしましょう。そのためには、<code>current_user</code>メソッドを定義して、セッションIDに対応するユーザー名をデータベースから取り出せるようにします。<code>current_user</code>メソッドの目的は、以下のようなコードを書けるようにすることです。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">以下も同様です。</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div></div>
<p>現在のユーザーを検索する方法のひとつとして思い付くのは、ユーザープロフィールページ (<a class="hyperref" href="sign_up?version=4.2#code-user_show_action">リスト<span class="ref">7.5</span></a>) と同様に、以下の<code>find</code>メソッドを使用することです。</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">しかし<a class="hyperref" href="modeling_users?version=4.2#sec-finding_user_objects"><span class="ref">6.1.4</span></a>で既に経験済みのとおり、ユーザーIDが存在しない状態で<code>find</code>を使用すると例外が発生してしまいます。findのこの動作は、ユーザープロフィールページでは完全に適切です。IDが無効の場合は例外を発生してくれなければ困るからです。しかし、ユーザーがログインしていないなど多くの状況では、<code>session[:user_id]</code>の値は<code>nil</code>になります。この状態を修正するために、<code>create</code>メソッド内でメールアドレスの検索に使ったのと同じ<code>find_by</code>メソッドを使うことにします。ただし今度は<code>email</code>ではなく<code>id</code>で検索します。</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">今度はIDが無効な場合 (=ユーザーが存在しない場合) にもメソッドは例外を発生せず、<code>nil</code>を返します。</p>
<p>今度は<code>current_user</code>を以下のように定義し直します。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">current_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">これは正常に動作します。しかし少し残念なのは、<code>current_user</code>がページ内で複数使用されていると、同じ回数だけデータベースも呼び出されてしまうことです。そこで、Rubyの慣習に従って、<code>User.find_by</code>の実行結果をインスタンス変数に保存することにします。こうすることで、データベースの読み出しは最初の一回だけになり、以後の呼び出しではインスタンス変数を返すようになります<sup class="footnote" id="cha-8_footnote-ref-5"><a href="#cha-8_footnote-5">5</a></sup>。地味なようですが、Railsの高速化のために重要なテクニックです。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">else</span>
  <span class="vi">@current_user</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><em>or</em>演算子「<span class="tt">||</span>」(<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>) を使用すれば、上の「メモ化」コードを以下のようにたった1行で書けます。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">=</span> <span class="vi">@current_user</span> <span class="o">||</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">ここで重要なのは、Userオブジェクトそのものの論理値は常にtrueになることです。そのおかげで、<code>@current_user</code>に何も代入されていないときだけ<code>find_by</code>呼び出しが実行され、無駄なデータベース読み出しが行われなくなります。</p>
<p>上のコードはひとまず動作しますが、実はまだ「Ruby的に」正しいコードではありません。<code>@current_user</code>への代入は、Rubyでは以下のような短縮形で書くのが王道です。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">初めてこの記法を見た方はとまどうかもしれません。しかしRubyではこの「<code>||=</code>」記法は広く使用されています (<a class="hyperref" href="#aside-or_equals">コラム<span class="ref">8.1</span></a>)。</p>
<div class="aside" id="aside-or_equals" data-tralics-id="uid764" data-number="8.1">
<div class="heading">
<span class="number">コラム8.1</span> 

<span class="description">「<span class="tt">||=</span>」とは何なのか</span>
</div>
<p>この「<span class="tt">||=</span>」(or equals) という代入演算子はRubyで広く使用されているイディオムであり、Ruby開発者を志すならこの演算子に習熟することが重要です。<em>or equals</em>という概念は一見神妙不可思議に見えますが、他のものになぞらえて考えれば難しくありません。</p>
<p>多くのコンピュータプログラムでは、以下のような記法で変数の値を1つ増やすことができます。</p>
<pre class="verbatim">x = x + 1</pre>
<p class="noindent">そして、Ruby (およびC、C++、Perl、Python、Javaなどの多くのプログラミング言語) では、上の演算を以下のような短縮形で表記することもできます。</p>
<pre class="verbatim">x += 1</pre>
<p class="noindent">他の演算子についても同様の短縮形が利用できます。</p>
<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 8
  =&gt; -2
  &gt;&gt; x /= 2
  =&gt; -1</pre>
<p class="noindent">いずれの場合も、<span class="tt">●</span>という演算子があるときの「<span class="tt">x = x ● y</span>」と「<span class="tt">x ●= y</span>」の動作は同じです。</p>
<p>Rubyでは、「変数の値が<span class="tt">nil</span>なら変数に代入するが、nilでなければ代入しない (変数の値を変えない)」という操作が非常によく使われます。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>で説明した<em>or</em>演算子<span class="tt">||</span>を使用すれば、以下のように書くことができます。</p>
<pre class="verbatim">  &gt;&gt; @foo
  =&gt; nil
  &gt;&gt; @foo = @foo || "bar"
  =&gt; "bar"
  &gt;&gt; @foo = @foo || "baz"
  =&gt; "bar"</pre>
<p class="noindent"><span class="tt">nil</span>の論理値はfalseになるので、<span class="tt">@foo</span>への最初の代入「<span class="tt">nil || "bar"</span>」の評価値は<span class="tt">"bar"</span>になります。同様に、2つ目の代入「<span class="tt">@foo || "baz"</span>」(<span class="tt">"bar" || "baz"</span>など) の評価値は<span class="tt">"bar"</span>になります。Rubyでは、<span class="tt">nil</span>と<span class="tt">false</span>を除いて、あらゆるオブジェクトの論理値が<span class="tt">true</span>になるように設計されています。さらにRubyでは、<span class="tt">||</span>演算子をいくつも連続して式の中で使用する場合、項を左から順に評価し、最初にtrueになった時点で処理を終えるように設計されています (なお、このように<span class="tt">||</span>式を左から右に評価し、演算子の左の値が最初にtrueになった時点で処理を終了するという評価法を<em>短絡評価 (short-circuit evaluation)</em> と呼びます。論理積の<span class="tt">&amp;&amp;</span>演算子も似たような設計になっていますが、項を左から評価して、最初に<em>false</em>になった時点で処理を終了する点が異なります)。</p>
<p>上記の演算子をコンソールセッション上で実際に実行して比較してみると、<span class="tt">@foo = @foo || "bar"</span>は<span class="tt">x = x O y</span>に該当し、<span class="tt">O</span>が<span class="tt">||</span>に置き換わっただけであることがわかります。</p>
<pre class="verbatim">  x    =   x   +   1      -&gt;     x     +=   1
  x    =   x   *   3      -&gt;     x     *=   3
  x    =   x   -   8      -&gt;     x     -=   8
  x    =   x   /   2      -&gt;     x     /=   2
  @foo = @foo || "bar"    -&gt;     @foo ||= "bar"</pre>
<p class="noindent">これで、「<span class="inline_verbatim">@foo = @foo || "bar"</span>」は「<span class="inline_verbatim">@foo ||= "bar"</span>」と完全に等しいことが理解できました。この記法を現在のユーザーのコンテキストで使用すると以下のように簡潔なコードで表現できるようになります。</p>
<pre class="verbatim">@current_user ||= User.find_by(id: session[:user_id])</pre>
<p class="noindent">お試しあれ。</p>
<p>追記: <span class="tt">@foo || @foo = "bar"</span>と書いた場合 (||が左辺にある点に注意)、Rubyの内部では実際にすべての項が評価されます。これは、<span class="tt">@foo</span>が<span class="tt">nil</span>や<span class="tt">false</span>の場合に無駄な代入を避ける必要があるためです。しかしこの式の動作では<span class="tt">||=</span>記法の動作と同じにならず、説明上不都合なので、上の解説では<span class="tt">@foo = @foo || "bar"</span> (||が右辺にある点に注意) という式を用いて説明しました。</p>

</div>
<p>前述の簡潔な記法を<code>current_user</code>メソッドに適用した結果を<a class="hyperref" href="#code-current_user">リスト<span class="ref">8.14</span></a>に示します。</p>
<div class="codelisting" id="code-current_user" data-tralics-id="uid765" data-number="8.14">
<div class="heading">
<span class="number">リスト8.14:</span> 

<span class="description">セッションに含まれる現在のユーザーを検索する<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># 現在ログインしているユーザーを返す (ユーザーがログイン中の場合のみ)</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-current_user">リスト<span class="ref">8.14</span></a>の<code>current_user</code>メソッドが動作するようになったので、ユーザーがログインしているかどうかに応じてアプリケーションの動作を変更するための準備が整いました。</p>
</div>
<div id="sec-changing_the_layout_links" class="subsection" data-tralics-id="uid766" data-number="8.2.3">
<h3><a href="#sec-changing_the_layout_links" class="heading hyperref"><span class="number">8.2.3</span> レイアウトリンクを変更する</a></h3>
<p>ログイン機能の最初の具体的な応用として、ユーザーがログインしているときとそうでないときでレイアウトを変更してみましょう。特に、<a class="hyperref" href="#fig-login_success_mockup">図<span class="ref">8.7</span></a>のモックアップ<sup class="footnote" id="cha-8_footnote-ref-6"><a href="#cha-8_footnote-6">6</a></sup>に示したように、「ログアウト」リンク、「ユーザー設定」リンク、「ユーザーリストを表示」リンク、「現在のユーザープロフィールを表示」リンクも追加します。<a class="hyperref" href="#fig-login_success_mockup">図<span class="ref">8.7</span></a>では、ログアウトのリンクとプロフィールのリンクは [Account] メニューの項目として表示されている点にご注目ください。<a class="hyperref" href="#code-layout_login_logout_links">リスト<span class="ref">8.16</span></a>では、Bootstrapを使用してこのようなメニューを実現する方法を示します。</p>
<div class="center figure" id="fig-login_success_mockup" data-tralics-id="uid768" data-number="8.7">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_success_mockup.png" alt="images/figures/login_success_mockup"></div>
<div class="caption">
<span class="header">図8.7: </span><span class="description">ログイン成功後のユーザープロフィール画面のモックアップ
</span>
</div>
</div>
<p>筆者なら即、この時点で上のメニューを記述する統合テストを書くでしょう。<a class="hyperref" href="static_pages?version=4.2#aside-when_to_test">コラム<span class="ref">3.3</span></a>でも解説したように、Railsのテストツールに習熟するにつれ、何も指示されなくても、筆者のようにこの時点でテストを書きたくなると思います。とはいうものの今は無理は禁物です。このテストではまたいくつか新しいアイディアを投入する必要もあるので、テスト作成は<a class="hyperref" href="#sec-testing_layout_changes"><span class="ref">8.2.4</span></a>に回すことにします。</p>
<p>サイトレイアウトのリンクを変更する方法のひとつとして考えられるのは、ERBコードの中でif-elseを使用し、条件に応じてリンクを表示し分けることです。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  # ログインユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # ログインしていないユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">このコードを書くためには、論理値を返す<code>logged_in?</code>メソッドが必要なので、まずそれを定義します。</p>
<p>ユーザーがログイン中の状態とは、セッションにユーザーが存在する、つまり<code>current_user</code>が<code>nil</code>でないということです。これをチェックするには否定演算子 (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>)が必要なので、<code>!</code> (参考: 英語ではbangと読みます) を使用します。作成した<code>logged_in?</code>メソッドを<a class="hyperref" href="#code-logged_in_p">リスト<span class="ref">8.15</span></a>に示します。</p>
<div class="codelisting" id="code-logged_in_p" data-tralics-id="uid769" data-number="8.15">
<div class="heading">
<span class="number">リスト8.15:</span> 

<span class="description"><code>logged_in?</code>ヘルパーメソッド<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># 現在ログインしているユーザーを返す (ユーザーがログイン中の場合のみ)</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーがログインしていればtrue、その他ならfalseを返す</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
<span class="hll">    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-logged_in_p">リスト<span class="ref">8.15</span></a>を追加したので、ユーザーのログイン時にレイアウトを変えられるようにする準備ができました。なお、新しく作るリンクは4つですが、そのうち以下の2つのリンクは当面の間未実装のままとします (<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="ref">第9章</span></a>で完成の予定)。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">ログアウト用リンクでは、<a class="hyperref" href="#code-sessions_resource">リスト<span class="ref">8.1</span></a>で定義したログアウト用パスを使用します。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">上のコードでは、ログアウト用リンクの引数としてハッシュを渡している点にご注目ください。このハッシュでは、HTTPの<span class="tt">DELETE</span>リクエスト<sup class="footnote" id="cha-8_footnote-ref-7"><a href="#cha-8_footnote-7">7</a></sup>を使用するよう指示しています。プロフィール用リンクについても同様に以下のようにします。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">なお、上のコードは以下のように書くこともできます。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">しかしこの状況では<code>current_user</code>を使う方が、Railsによって<code>user_path(current_user)</code>され、ユーザープロフィールへのリンクが自動的に実現できるのでずっと便利です。そしてユーザーがログイン<em>していない</em>場合は、<a class="hyperref" href="#code-sessions_resource">リスト<span class="ref">8.1</span></a>のログイン用パスを使用して、以下のようにログインフォームへのリンクを作成します。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">以上をすべてヘッダーのパーシャル部分に適用して更新したものを<a class="hyperref" href="#code-layout_login_logout_links">リスト<span class="ref">8.16</span></a>に示します。</p>
<div class="codelisting" id="code-layout_login_logout_links" data-tralics-id="uid771" data-number="8.16">
<div class="heading">
<span class="number">リスト8.16:</span> 

<span class="description">ログイン中のユーザー用のレイアウトのリンクを変更する<span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
<span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
<span class="hll">                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
</span>              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div>
</div>
<p>レイアウトに新しいリンクを追加したので、<a class="hyperref" href="#code-layout_login_logout_links">リスト<span class="ref">8.16</span></a>にBootstrapのドロップダウンメニュー機能<sup class="footnote" id="cha-8_footnote-ref-8"><a href="#cha-8_footnote-8">8</a></sup>を適用できる状態になりました。具体的には、BootstrapのCSSの<code>dropdown</code>クラスや<code>dropdown-menu</code>などをインクルードします。ドロップダウンを実際に有効にするには、Railsのアセットパイプライン用の<code>application.js</code>ファイルでBootstrapのカスタムJavaScriptライブラリをインクルードします (<a class="hyperref" href="#code-bootstrap_js">リスト<span class="ref">8.17</span></a>)。</p>
<div class="codelisting" id="code-bootstrap_js" data-tralics-id="uid773" data-number="8.17">
<div class="heading">
<span class="number">リスト8.17:</span> 

<span class="description"><code>application.js</code>にBootstrapのJavaScriptライブラリを追加する<span class="break"></span> <span class="filepath">app/assets/javascripts/application.js</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="hll"><span class="c1">//= require bootstrap</span>
</span><span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</pre></div></div>
</div>
<p>この時点で、ログインパスにアクセスして有効なユーザーとしてログインできるようになっているので、これまでの3つの節<sup class="footnote intersentence" id="cha-8_footnote-ref-9"><a href="#cha-8_footnote-9">9</a></sup>のコードを効率よくテストできるようになります。<a class="hyperref" href="#code-layout_login_logout_links">リスト<span class="ref">8.16</span></a>や<a class="hyperref" href="#code-bootstrap_js">リスト<span class="ref">8.17</span></a>のコードにより、<a class="hyperref" href="#fig-profile_with_logout_link">図<span class="ref">8.8</span></a>のようにドロップダウンメニューとログイン中ユーザー用のリンクが表示されます。ブラウザを完全に終了すると、期待どおりアプリケーションのログインステータスが消去され、再びログインを要求されるようになったことを確認できます。</p>
<div class="center figure" id="fig-profile_with_logout_link" data-tralics-id="uid775" data-number="8.8">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_with_logout_link_3rd_edition.png" alt="images/figures/profile_with_logout_link_3rd_edition"></div>
<div class="caption">
<span class="header">図8.8: </span><span class="description">ドロップダウンメニューと新しいリンクが表示されたログイン中のユーザー
</span>
</div>
</div>
</div>
<div id="sec-testing_layout_changes" class="subsection" data-tralics-id="uid776" data-number="8.2.4">
<h3><a href="#sec-testing_layout_changes" class="heading hyperref"><span class="number">8.2.4 </span>レイアウトの変更をテストする</a></h3>
<p>アプリケーションでのログイン成功を手動で確認したので、先に進む前に統合テストを書いてこの動作をテストで表現し、今後の回帰バグの発生をキャッチできるようにしましょう。<a class="hyperref" href="#code-flash_persistence_test">リスト<span class="ref">8.7</span></a>を元にテストを作成し、以下の操作手順をテストで記述して確認できるようにします。</p>
<ol>
<li>ログイン用のパスを開く
</li>
<li>セッション用パスに有効な情報をpostする
</li>
<li>ログイン用リンクが表示されなくなったことを確認する
</li>
<li>ログアウト用リンクが表示されていることを確認する</li>
<li>プロフィール用リンクが表示されていることを確認する
</li>
</ol>
<p>上の変更を確認するためには、テスト時に登録済みユーザーとしてログインしておく必要があります。当然ながら、データベースにそのためのユーザーが登録されていなければなりません。Railsでは、このようなテスト用データを<em>フィクスチャ</em>で作成できます。フィクスチャを使用して、テストに必要なデータをtestデータベースに読み込んでおくことができます。<a class="hyperref" href="modeling_users?version=4.2#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>では、メールの一意性テスト (<a class="hyperref" href="modeling_users?version=4.2#code-empty_fixtures">リスト<span class="ref">6.30</span></a>) がパスするためにデフォルトのフィクスチャを削除する必要がありました。今度は自分で空のフィクスチャファイルを作成してデータを追加しましょう。</p>
<p>現時点のテストでは、ユーザーはひとりいれば十分です。そのユーザーには有効な名前と有効なメールアドレスを設定しておきます。テスト中にそのユーザーとして自動ログインするために、そのユーザーの有効なパスワードも用意して、Sessionsコントローラの<code>create</code>アクションに送信されたパスワードと比較できるようにする必要があります。<a class="hyperref" href="modeling_users?version=4.2#fig-user_model_password_digest">図<span class="ref">6.8</span></a>のデータモデルをもう一度見てみると、<code>password_digest</code>属性をユーザーのフィクスチャに追加すればよいことがわかります。そのために、<code>digest</code>メソッドを独自に定義することにします。</p>
<p><a class="hyperref" href="modeling_users?version=4.2#sec-a_hashed_password"><span class="ref">6.3.1</span></a>で説明したように、<code>has_secure_password</code>でbcryptパスワードが作成されるので、同じ方法でフィクスチャ用パスワードを作成します。Railsの<a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">secure_passwordのソースコード</a>を調べてみると、以下のメソッドがあります。</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</pre></div></div>
<p class="noindent"><code>string</code>はハッシュ化する文字列、<code>cost</code>は<em>コストパラメータ</em>と呼ばれる値です。コストパラメータでは、ハッシュを算出するための計算コストを指定します。コストパラメータの値を高くすれば、ハッシュからオリジナルのパスワードを計算で推測することが困難になりますので、production環境ではセキュリティ上重要です。しかしテスト中はコストを高くする意味はないので、<code>digest</code>メソッドの計算はなるべく軽くしておきます。secure_passwordのソースコードには以下の行があります。</p>
<div class="code"><div class="highlight"><pre><span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                              <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</pre></div></div>
<p class="noindent">少々込み入っていますが、コストパラメータをテスト中は最小にし、production環境ではnormal (high) にする方法がわかれば十分です。「<code>?</code>」〜「<code>:</code>」という記法については<a class="hyperref" href="#sec-remember_me_checkbox"><span class="ref">8.4.5</span></a>で解説します。</p>
<p><code>digest</code>メソッドは他にも様々な場所で使用できます。<a class="hyperref" href="#sec-remember_token"><span class="ref">8.4.1</span></a>では<code>digest</code>をUserモデルで再利用します。そこでは、digestメソッドを<code>user.rb</code>に置くことをすすめています。ダイジェストの計算はユーザーごとに行わなければならないものではないので、フィクスチャファイルなどでわざわざユーザーオブジェクトにアクセスする必然性はありません。そこで、<code>digest</code>メソッドをUserクラス自身に配置してクラスメソッドにすることにしましょう (<em>クラスメソッド</em>の作り方については<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-constructors"><span class="ref">4.4.1</span></a>で簡単に説明しました)。変更の結果を<a class="hyperref" href="#code-digest_method">リスト<span class="ref">8.18</span></a>に示します。</p>
<div class="codelisting" id="code-digest_method" data-tralics-id="uid782" data-number="8.18">
<div class="heading">
<span class="number">リスト8.18:</span> 

<span class="description">フィクスチャ向けのdigestメソッドを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># 与えられた文字列のハッシュ値を返す</span> 
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="hll">    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
</span><span class="hll">                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</span><span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-digest_method">リスト<span class="ref">8.18</span></a>の<code>digest</code>メソッドができたので、有効なユーザーを表すユーザーフィクスチャを作成できるようになりました (<a class="hyperref" href="#code-real_user_fixture">リスト<span class="ref">8.19</span></a>)。</p>
<div class="codelisting" id="code-real_user_fixture" data-tralics-id="uid783" data-number="8.19">
<div class="heading">
<span class="number">リスト8.19:</span> 

<span class="description">ユーザーログインのテストで使用するフィクスチャ<span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
</pre></div></div>
</div>
<p class="noindent">フィクスチャではERBを利用できる点にご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="o">&lt;%=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)</span> <span class="o">%&gt;</span>
</pre></div></div>
<p class="noindent">上のERBコードでテストユーザー用の有効なパスワードを作成できます。</p>
<p><code>has_secure_password</code>で必要となる<code>password_digest</code>属性はこれで準備できましたが、ハッシュ化されていない生のパスワードも参照できると便利です。しかし残念なことに、フィクスチャではこのようなことはできません。さらに、<a class="hyperref" href="#code-real_user_fixture">リスト<span class="ref">8.19</span></a>に<code>password</code>属性を追加すると、そのようなカラムはデータベースに存在しないというエラーが発生します。実際、データベースにはそんなカラムはありません。この状況を切り抜けるために、テスト用のフィクスチャユーザーでは全員同じパスワード「<code>password</code>」を使用することにします。これはフィクスチャでよく使われる手法です。</p>
<p>有効なユーザーのフィクスチャを作成できたので、テストで以下のようにフィクスチャデータを参照できます。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上の<code>users</code>はフィクスチャのファイル名<code>users.yml</code>を表し、<code>:michael</code>というシンボルは<a class="hyperref" href="#code-real_user_fixture">リスト<span class="ref">8.19</span></a>のユーザーを参照するためのキーを表します。</p>
<p>フィクスチャのユーザーにアクセスできるようになったので、レイアウトのリンクをテストできる状態になりました。レイアウトのリンクをテストするには、前述の操作手順をテストコードに書き換えます (<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>)。</p>
<div class="codelisting" id="code-user_login_test_valid_information" data-tralics-id="uid784" data-number="8.20">
<div class="heading">
<span class="number">リスト8.20:</span> 

<span class="description">有効な情報を使用してユーザーログインをテストする<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードのうち、以下の行は</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_redirected_to</span> <span class="vi">@user</span>
</pre></div></div>
<p class="noindent">リダイレクト先が正しいかどうかをチェックします。</p>
<div class="code"><div class="highlight"><pre><span class="n">follow_redirect!</span>
</pre></div></div>
<p class="noindent">上の行では、実際にそのページに移動します。<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>では、ログイン用リンクが表示されなくなったことも確認しています。このチェックは、ログインパスのリンクがページに<em>ない</em>かどうかで判定しています。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</pre></div></div>
<p class="noindent"><code>count: 0</code>というオプションをアサーションに追加すると、渡したパターンに一致するリンクがゼロになっているかどうかを確認するよう<code>assert_select</code>に指示します。なお、<a class="hyperref" href="filling_in_the_layout?version=4.2#code-layout_links_test">リスト<span class="ref">5.25</span></a>では、<code>count: 2</code>を使用してリンクが2つあるかどうかを確認しているので、比較してみるとよいでしょう。</p>
<p>アプリケーションのコードは既に動作するようになっているので、ここでテストを実行すると<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid785" data-tralics-id="uid785" data-number="8.21">
<div class="heading">
<span class="number">リスト8.21:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/integration/users_login_test.rb \
&gt;                       TESTOPTS="--name test_login_with_valid_information"
</pre></div></div>
</div>
<p class="noindent">上のコマンドでは、指定したテストファイル内にある特定のテストだけを実行するために、以下のオプションを追加してあります。</p>
<div class="code"><div class="highlight"><pre><span class="go">TESTOPTS="--name test_login_with_valid_information"</span>
</pre></div></div>
<p class="noindent">(上記の2行目にある '&gt;' という文字は、改行を示すためにシェルが自動的に挿入する文字です。手動で入力しないよう、注意してください。) 上のオプションは、テスト名を指定するときに使うオプションです。なお、指定するテスト名は、接頭語の「test_」と、テストの説明文の単語をアンダースコアでつないだ文字列で表します。</p>
</div>
<div id="sec-login_upon_signup" class="subsection" data-tralics-id="uid786" data-number="8.2.5">
<h3><a href="#sec-login_upon_signup" class="heading hyperref"><span class="number">8.2.5 </span>ユーザー登録時にログイン</a></h3>
<p>以上で認証システムが動作するようになりましたが、今のままでは、登録の終わったユーザーがデフォルトではログインしていないので、ユーザーがとまどう可能性があります。ユーザー登録が終わってからユーザーに手動ログインを促すと、ユーザーに余分な手順を強いることになるので、ユーザー登録中にログインを済ませておくことにします。ユーザー登録中にログインするには、Usersコントローラの<code>create</code>アクションに<code>log_in</code>を追加するだけで済みます (<a class="hyperref" href="#code-login_upon_signup">リスト<span class="ref">8.22</span></a>)<sup class="footnote" id="cha-8_footnote-ref-10"><a href="#cha-8_footnote-10">10</a></sup>。</p>
<div class="codelisting" id="code-login_upon_signup" data-tralics-id="uid788" data-number="8.22">
<div class="heading">
<span class="number">リスト8.22:</span> 

<span class="description">ユーザー登録中にログインする<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="n">log_in</span> <span class="vi">@user</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-login_upon_signup">リスト<span class="ref">8.22</span></a>の動作をテストするために、<a class="hyperref" href="sign_up?version=4.2#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>のテストに1行追加して、ユーザーがログイン中かどうかをチェックします。そのために、<a class="hyperref" href="#code-logged_in_p">リスト<span class="ref">8.15</span></a>で定義した<code>logged_in?</code>ヘルパーメソッドとは別に、<code>is_logged_in?</code>ヘルパーメソッドを定義しておくと便利です。このヘルパーメソッドは、テストのセッションにユーザーがあれば<code>true</code>を返し、それ以外の場合はfalseを返します (<a class="hyperref" href="#code-test_helper_sessions">リスト<span class="ref">8.23</span></a>)。残念ながらヘルパーメソッドはテストから呼び出せないので、<a class="hyperref" href="#code-logged_in_p">リスト<span class="ref">8.15</span></a>のように<code>current_user</code>を呼び出せません。<code>session</code>メソッドはテストでも利用できるので、これを代わりに使用します。ここでは取り違えを防ぐため、<code>logged_in?</code>の代わりに<code>is_logged_in?</code>を使用して、ヘルパーメソッド名がテストヘルパーとSessionヘルパーで同じにならないようにしておきます<sup class="footnote" id="cha-8_footnote-ref-11"><a href="#cha-8_footnote-11">11</a></sup>。</p>
<div class="codelisting" id="code-test_helper_sessions" data-tralics-id="uid790" data-number="8.23">
<div class="heading">
<span class="number">リスト8.23:</span> 

<span class="description">テスト中のログインステータスを論理値で返すメソッド<span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># テストユーザーがログインしていればtrueを返す</span>
<span class="hll">  <span class="k">def</span> <span class="nf">is_logged_in?</span>
</span><span class="hll">    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-test_helper_sessions">リスト<span class="ref">8.23</span></a>のコードを使用すると、ユーザー登録の終わったユーザーがログイン状態になっているかどうかを確認できます (<a class="hyperref" href="#code-login_after_signup_test">リスト<span class="ref">8.24</span></a>)。</p>
<div class="codelisting" id="code-login_after_signup_test" data-tralics-id="uid791" data-number="8.24">
<div class="heading">
<span class="number">リスト8.24:</span> 

<span class="description">ユーザー登録後のログインのテスト<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>これで、テストを実行すると<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid792" data-tralics-id="uid792" data-number="8.25">
<div class="heading">
<span class="number">リスト 8.25:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-logging_out" class="section" data-tralics-id="cid54" data-number="8.3">
<h2><a href="#sec-logging_out" class="heading hyperref"><span class="number">8.3 </span>ログアウト</a></h2>
<p><a class="hyperref" href="#sec-sessions_and_failed_login"><span class="ref">8.1</span></a>で解説したように、このアプリケーションで使用する認証モデルでは、ユーザーが明示的にログアウトするまではログイン状態を保てなくてはなりません。この節では、そのために必要なログアウト機能を追加することにします。ログアウト用リンクは<a class="hyperref" href="#code-layout_login_logout_links">リスト<span class="ref">8.16</span></a>で既に作成済みなので、ユーザーセッションを破棄するための有効なアクションをコントローラで作成するだけで済みます。</p>
<p>これまで、SessionsコントローラのアクションはRESTfulルールに従っていました。<code>new</code>でログインページを表示し、<code>create</code>でログインを完了するといった具合です。セッションを破棄する<code>destroy</code>アクションも、引き続き同じ要領で作成することにします。ただし、ログインの場合 (<a class="hyperref" href="#code-log_in_success">リスト<span class="ref">8.13</span></a>と<a class="hyperref" href="#code-login_upon_signup">リスト<span class="ref">8.22</span></a>) と異なり、ログアウト処理は1か所で行えるので、<code>destroy</code>アクションに直接ログアウト処理を書くことにします。<a class="hyperref" href="#sec-remember_tests"><span class="ref">8.4.6</span></a>でも説明しますが、この設計 (および若干のリファクタリング) のおかげで認証メカニズムのテストが行い易くなります。</p>
<p>ログアウト処理では、<a class="hyperref" href="#code-log_in_function">リスト<span class="ref">8.12</span></a>の<code>log_in</code>メソッドの実行結果を取り消します。つまり、セッションからユーザーIDを削除します<sup class="footnote" id="cha-8_footnote-ref-12"><a href="#cha-8_footnote-12">12</a></sup>。そのためには、以下のように<code>delete</code>メソッドを実行します。</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">現在のユーザーも<code>nil</code>に設定します。今回は上のコードにより、即座にルートURLにリダイレクトされるので、それほど重要ではありません<sup class="footnote" id="cha-8_footnote-ref-13"><a href="#cha-8_footnote-13">13</a></sup>。<code>log_in</code>および関連メソッドのときと同様に、Sessionヘルパーモジュールに配置する<code>log_out</code>メソッドを<a class="hyperref" href="#code-log_out_method">リスト<span class="ref">8.26</span></a>に示します。</p>
<div class="codelisting" id="code-log_out_method" data-tralics-id="uid795" data-number="8.26">
<div class="heading">
<span class="number">リスト8.26:</span> 

<span class="description"><code>log_out</code>メソッド<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 現在のユーザーをログアウトする</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><code>log_out</code>メソッドをSessionsコントローラの<code>destroy</code>アクションでも同様に使用します (<a class="hyperref" href="#code-destroy_session">リスト<span class="ref">8.27</span></a>)。</p>
<div class="codelisting" id="code-destroy_session" data-tralics-id="uid796" data-number="8.27">
<div class="heading">
<span class="number">リスト8.27:</span> 

<span class="description">セッションを破棄する (ユーザーログアウト)<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>ログアウト機能をテストするために、<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>のユーザーログインのテストに手順を若干追加します。ログイン後、<code>delete</code>メソッドで<span class="tt">DELETE</span>リクエストをログアウト用パス (<a class="hyperref" href="#table-RESTful_sessions">表<span class="ref">8.1</span></a>) に発行し、ユーザーがログアウトしてルートURLにリダイレクトされたことを確認します。ログイン用リンクが再度表示されること、ログアウト用リンクとプロフィール用リンクが非表示になることも確認します。手順を追加したテストを<a class="hyperref" href="#code-user_logout_test">リスト<span class="ref">8.28</span></a>に示します。</p>
<div class="codelisting" id="code-user_logout_test" data-tralics-id="uid797" data-number="8.28">
<div class="heading">
<span class="number">リスト8.28:</span> 

<span class="description">ユーザーログアウトのテスト<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">    <span class="n">follow_redirect!</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">テストで<code>is_logged_in?</code>ヘルパーメソッドを利用できるようにしてあったおかげで、有効な情報をセッション用パスにpostした直後に<code>assert is_logged_in?</code>で簡単にテストできました。</p>
<p>セッションの<code>destroy</code>アクションの定義とテストが完成したので、ついに3大機能である「ユーザー登録/ログイン/ログアウト」がすべて完成しました。テストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid798" data-tralics-id="uid798" data-number="8.29">
<div class="heading">
<span class="number">リスト 8.29:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div><div id="sec-remember_me" class="section" data-tralics-id="cid55" data-number="8.4">
<h2><a href="#sec-remember_me" class="heading hyperref"><span class="number">8.4</span> [このアカウント設定を保存する]</a></h2>
<p><a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>で完了したログインシステムは、それ自体で十分完結した機能です。しかし多くのWebサイトでは、ブラウザを閉じた後にもセッションを継続する機能などを追加しているのが普通です。本節では、ユーザーログインをデフォルトで保持するように変更し、ユーザーが明示的にログアウトするまではセッションを期限切れにしないようにします。この後<a class="hyperref" href="#sec-remember_me_checkbox"><span class="ref">8.4.5</span></a>では、別の方法として、ログインを保存する「remember-me」チェックボックスを追加して、ログインを継続するかどうかをユーザーが選択できるようにする予定です。どちらの方式も商用に利用できる品質を備えています。前者は<a href="http://github.com/" target="_blank">GitHub</a>や<a href="http://bitbucket.org/" target="_blank">Bitbucket</a>で、後者は<a href="http://www.facebook.com/" target="_blank">Facebook</a>や<a href="http://twitter.com/" target="_blank">Twitter</a>でそれぞれ採用されています。</p>
<div id="sec-remember_token" class="subsection" data-tralics-id="uid799" data-number="8.4.1">
<h3><a href="#sec-remember_token" class="heading hyperref"><span class="number">8.4.1 </span>記憶トークンと暗号化</a></h3>
<p><a class="hyperref" href="#sec-logging_in"><span class="ref">8.2</span></a>では、Railsの<code>session</code>メソッドを使用してユーザーIDを保存しましたが、この情報はブラウザを閉じると消えてしまいます。本節では、セッションの永続化の第一歩として<em>記憶トークン (remember token) </em>を生成し、<code>cookies</code>メソッドによる永続的cookiesの作成や、安全性の高い<em>記憶ダイジェスト (remember digest) </em>によるトークン認証にこの記憶トークンを活用します。</p>
<p><a class="hyperref" href="#sec-a_working_log_in_method"><span class="ref">8.2.1</span></a>で解説したように、<code>session</code>メソッドで保存した情報は自動的に安全が保たれますが、<code>cookies</code>メソッドに保存する情報は残念ながらそのようにはなっていません。特に、cookiesを永続化すると<a href="http://ja.wikipedia.org/wiki/%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%8F%E3%82%A4%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AF" target="_blank">セッションハイジャック</a>という攻撃を受ける可能性があります。この攻撃は、記憶トークンを奪って、特定のユーザーになりすましてログインするというものです。cookiesを盗み出す有名な方法は4とおりあります。(1) 管理の甘いネットワークを通過するネットワークパケットから<a href="https://ja.wikipedia.org/wiki/LAN%E3%82%A2%E3%83%8A%E3%83%A9%E3%82%A4%E3%82%B6" target="_blank">パケットスニッファ</a>という特殊なソフトウェアで直接cookieを取り出す<sup class="footnote" id="cha-8_footnote-ref-14"><a href="#cha-8_footnote-14">14</a></sup>。(2) データベースから記憶トークンを取り出す。(3) <a href="http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0" target="_blank">クロスサイトスクリプティング (XSS)</a> を使う。(4) ユーザーがログインしているパソコンやスマホを直接操作してアクセスを奪い取る。<a class="hyperref" href="sign_up?version=4.2#sec-professional_grade_deployment"><span class="ref">7.5</span></a>では、最初の問題を防止するために<a href="https://ja.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">Secure Sockets Layer</a> (SSL) をサイト全体に適用して、ネットワークデータを暗号化で保護し、パケットスニッファから読み取られないようにしています。2番目の問題の対策としては、記憶トークンをそのままデータベースに保存するのではなく、記憶トークンのハッシュ値を保存するようにします。これは、<a class="hyperref" href="modeling_users?version=4.2#sec-adding_a_secure_password"><span class="ref">6.3</span></a>で生のパスワードをデータベースに保存する代わりにパスワードのダイジェストを保存したのと同じコンセプトです。3 番目の問題については、Railsによって自動的に対策が行われます。具体的には、ビューテンプレートで入力した内容をすべて自動的にエスケープします。4番目のログイン中のコンピュータへの物理アクセスによる攻撃については、さすがにシステム側での根本的な防衛手段を講じることは不可能なのですが、ユーザーがログアウトしたときにトークンを必ず変更し、機密上重要になる可能性のある情報をブラウザに表示するときには<em>暗号による署名</em>を行うようにすることで、物理アクセスによる攻撃を最小限に留めるようにします。</p>
<p>上で説明した設計やセキュリティ上の考慮事項を元に、以下の方針で永続的セッションを作成することにします。</p>
<ol>
<li>記憶トークンにはランダムな文字列を生成して用いる。
</li>
<li>ブラウザのcookiesにトークンを保存するときには、有効期限を設定する。
</li>
<li>トークンはハッシュ値に変換してからデータベースに保存する。
</li>
<li>ブラウザのcookiesに保存するユーザーIDは暗号化しておく。
</li>
<li>永続ユーザーIDを含むcookiesを受け取ったら、そのIDでデータベースを検索し、記憶トークンのcookiesがデータベース内のハッシュ値と一致することを確認する。
</li>
</ol>
<p class="noindent">上の最後の手順が、ユーザーログインのときの手順と似ていることにご注目ください。ユーザーログインでは、メールアドレスをキーにしてユーザーを取り出し、送信されたパスワードがパスワードダイジェストと一致することを (<code>authenticate</code>メソッドで) 確認します (<a class="hyperref" href="#code-find_authenticate_user">リスト<span class="ref">8.5</span></a>)。つまり、ここでの実装は<code>has_secure_password</code>と似た側面を持ちます。</p>
<p>それでは最初に、必要となる<code>remember_digest</code>属性をUserモデルに追加します (<a class="hyperref" href="#fig-user_model_remember_digest">図<span class="ref">8.9</span></a>)。</p>
<div class="center figure" id="fig-user_model_remember_digest" data-tralics-id="uid806" data-number="8.9">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_remember_digest.png" alt="user_model_remember_digest"></span>
<div class="caption">
<span class="header">図8.9: </span><span class="description"><code>remember_digest</code>属性を追加したUserモデル
</span>
</div>
</div>
<p class="noindent"><a class="hyperref" href="#fig-user_model_remember_digest">図<span class="ref">8.9</span></a>のデータモデルをアプリケーションに追加するために、以下のマイグレーションを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_digest_to_users remember_digest:string
</pre></div></div>
<p class="noindent">(<a class="hyperref" href="modeling_users?version=4.2#sec-a_hashed_password"><span class="ref">6.3.1</span></a>のパスワードダイジェストのときのマイグレーションと比較してみましょう)。前回のマイグレーションと同様、今回のマイグレーション名も<code>_to_users</code>で終わっています。これは、マイグレーションの対象がデータベースの<code>users</code>テーブルであることをRailsに指示するためのものです。今回は種類=<code>string</code>の<code>remember_digest</code>属性を追加しているので、いつものようにRailsによってデフォルトのマイグレーションが作成されます (<a class="hyperref" href="#code-add_remember_digest_to_users_generated">リスト<span class="ref">8.30</span></a>)。</p>
<div class="codelisting" id="code-add_remember_digest_to_users_generated" data-tralics-id="uid807" data-number="8.30">
<div class="heading">
<span class="number">リスト8.30:</span> 

<span class="description">記憶ダイジェスト用に生成したマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_remember_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>記憶ダイジェストはユーザーが直接読み出すことはないので (かつ、そうさせてはならないので)、<code>remember_digest</code>カラムにインデックスを追加する必要はありません。従って、上のマイグレーションは変更せずにそのまま使用します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p>ここで、記憶トークンとして何を使用するかを決める必要があります。有力な候補として様々なものが考えられますが、基本的には長くてランダムな文字列であればどんなものでも構いません。Ruby標準ライブラリの<code>SecureRandom</code>モジュールにある<code>urlsafe_base64</code>メソッドならこの用途にぴったりです<sup class="footnote" id="cha-8_footnote-ref-15"><a href="#cha-8_footnote-15">15</a></sup>。このメソッドは、A–Z、a–z、0–9、“-”、“_”のいずれかの文字 (64種類) からなる長さ22のランダムな文字列を返します (そのため<a href="http://ja.wikipedia.org/wiki/Base64" target="_blank">base64</a>と呼ばれています)。典型的なbase64の文字列は、次のようなものです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; SecureRandom.urlsafe_base64
<span class="go">=&gt; "q5lt38hQDc_959PVoo6b7A"</span>
</pre></div></div>
<p>2人のユーザーのパスワードが完全に同じであれば<sup class="footnote" id="cha-8_footnote-ref-16"><a href="#cha-8_footnote-16">16</a></sup>、記憶トークンが一意である必然性はなくなりますが、現実にはそんなことはないので、記憶トークンによってセキュリティが高められます<sup class="footnote" id="cha-8_footnote-ref-17"><a href="#cha-8_footnote-17">17</a></sup>。上のbase64文字列では、22個の文字でそれぞれ64種類の文字が使用される可能性があり、2つの記憶トークンがたまたま完全に一致する (=衝突する) 確率は<span class="inline_math">64のマイナス16乗、2のマイナス96乗 (10のマイナス29乗) にほぼ等しく</span>、トークンが衝突することはまずありません。さらにありがたいことに、base64はURLを安全にエスケープするためにも用いられる (<code>urlsafe_base64</code>という名前のメソッドがあることからもわかります) ので、base64を採用すれば、<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset">第<span class="ref">10</span>章</a>でアカウントの有効化のリンクやパスワードリセットのリンクでも同じトークンジェネレータを使用できるようになります。</p>
<p>ユーザーを記憶するには、記憶トークンを作成して、そのトークンをダイジェストに変換したものをデータベースに保存します。フィクスチャをテストするときに<code>digest</code>メソッドを既に作成してあったので (<a class="hyperref" href="#code-digest_method">リスト<span class="ref">8.18</span></a>)、上の結論に従って、新しいトークンを作成するための<code>new_token</code>メソッドを作成できます。この新しい<code>digest</code>メソッドではユーザーオブジェクトが不要なので、このメソッドもUserモデルのクラスメソッドとして作成することにします<sup class="footnote" id="cha-8_footnote-ref-18"><a href="#cha-8_footnote-18">18</a></sup>。以上を反映したUserモデルを<a class="hyperref" href="#code-token_method">リスト<span class="ref">8.31</span></a>に示します。</p>
<div class="codelisting" id="code-token_method" data-tralics-id="uid812" data-number="8.31">
<div class="heading">
<span class="number">リスト8.31:</span> 

<span class="description">トークン生成用メソッドを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ランダムなトークンを返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
<span class="hll">    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>さしあたっての実装計画としては、<code>user.remember</code>メソッドを作成することにします。このメソッドは、記憶トークンをユーザーと関連付け、トークンに対応する記憶ダイジェストをデータベースに保存します。<a class="hyperref" href="#code-add_remember_digest_to_users_generated">リスト<span class="ref">8.30</span></a>のマイグレーションを行ってあるので、Userモデルには既に<code>remember_digest</code>属性が追加されていますが、<code>remember_token</code>属性はまだ追加されていません。そこで、<code>user.remember_token</code>メソッド (cookiesの保存場所です) を使用してトークンにアクセスできるようにする必要があります。しかも、トークンをデータベースに<em>保存せずに</em>実装する必要があります。そのためには、<a class="hyperref" href="modeling_users?version=4.2#sec-adding_a_secure_password"><span class="ref">6.3</span></a>の安全なパスワードの問題のときと同様の手法でこれを解決します。あのときは、「仮想の」<code>password</code>属性と、データベース上のセキュアな<code>password_digest</code>属性を使用しました。仮想の<code>password</code>属性は<code>has_secure_password</code>メソッドで自動的に作成できましたが、今回は<code>remember_token</code>のコードを自分で書く必要があります。これを行うには、<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>で行ったように<code>attr_accessor</code>を使用してアクセス可能な属性を作成します。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><code>remember</code>メソッドの1行目の代入にご注目ください。<code>self</code>というキーワードを使用しないと、Rubyによって<code>remember_token</code>という名前の<em>ローカル</em>変数が作成されてしまいます。この動作は、Rubyにおけるオブジェクト内部への要素代入の仕様によるものです。今欲しいのはローカル変数ではありません。<code>self</code>キーワードを与えると、この代入によってユーザーの<code>remember_token</code>属性が期待どおりに設定されます (<a class="hyperref" href="modeling_users?version=4.2#code-email_downcase">リスト<span class="ref">6.31</span></a>の他の<code>before_save</code>コールバックで、<code>email</code>ではなく<code>self.email</code>と記述していた理由が、これでおわかりいただけたと思います)。<code>remember</code>メソッドの次の行では、<code>update_attribute</code>メソッドで記憶ダイジェストを更新しています (<a class="hyperref" href="modeling_users?version=4.2#sec-updating_user_objects"><span class="ref">6.1.5</span></a>で説明したように、このメソッドはバリデーションを素通りさせます。ここではユーザーのパスワードやパスワード確認にアクセスできないので、バリデーションを素通りさせなければなりません)。</p>
<p>以上の点を考慮して、有効なトークンとそれに関連するダイジェストを作成できるようにします。具体的には、最初に<code>User.new_token</code>で記憶トークンを作成し、続いて<code>User.digest</code>を適用した結果で記憶ダイジェストを更新します。<code>remember</code>メソッドの更新結果を<a class="hyperref" href="#code-user_model_remember">リスト<span class="ref">8.32</span></a>に示します。</p>
<div class="codelisting" id="code-user_model_remember" data-tralics-id="uid813" data-number="8.32">
<div class="heading">
<span class="number">リスト8.32:</span> 

<span class="description"><code>remember</code>メソッドをUserモデルに追加する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ランダムなトークンを返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># 永続的セッションで使用するユーザーをデータベースに記憶する</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div>
<div id="sec-login_with_remembering" class="subsection" data-tralics-id="uid814" data-number="8.4.2">
<h3><a href="#sec-login_with_remembering" class="heading hyperref"><span class="number">8.4.2 </span>ログイン状態の保持</a></h3>
<p><code>user.remember</code>メソッドが動作するようになったので、ユーザーの暗号化済みIDと記憶トークンをブラウザの永続cookiesに保存して、永続セッションを作成する準備ができました。これを実際に行うには<code>cookies</code>メソッドを使用します。このメソッドは、<code>session</code>のときと同様にハッシュとして扱えます。個別のcookiesは、ひとつの<code>value</code> (値) と、オプションの<code>expires</code> (有効期限) からできています。有効期限は省略可能です。たとえば以下のように、20年後に期限切れになる記憶トークンと同じ値をcookieに保存することで、永続的なセッションを作ることができます。</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value</span><span class="p">:</span>   <span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires</span><span class="p">:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">(上のコードではRailsの便利なtimeヘルパーを使用しています。<a class="hyperref" href="#aside-time_helpers">コラム<span class="ref">8.2</span></a>を参照してください)。上のように20年で期限切れになるcookies設定はよく使われるようになり、今ではRailsにも特殊な<code>permanent</code>という専用のメソッドが追加されたほどです。このメソッドを使用すると、コードは以下のようにシンプルになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
</pre></div></div>
<p class="noindent">上のコードによって、Railsは自動的に期限を<code>20.years.from_now</code>に設定します。</p>
<div class="aside" id="aside-time_helpers" data-tralics-id="uid815" data-number="8.2">
<div class="heading">
<span class="number">コラム 8.2</span> 

<span class="description">cookiesは今から20年後に切れる (<span class="tt">20.years.from_now</span>)</span>
</div>
<p>Rubyは組み込みクラスを含む<em>あらゆる</em>クラスにメソッドを追加できることを<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_class_of_our_own"><span class="ref">4.4.2</span></a>で学びました。あのときは、<span class="tt">palindrome?</span>メソッドを<span class="tt">String</span>クラスに追加しました (ついでに<span class="tt">"deified"</span>も回文になっていることを発見しました)。また、Railsが実は<span class="tt">blank?</span>メソッドを<span class="tt">Object</span>クラスに追加していることも判明しました (これにより、<span class="tt">"".blank?</span>、<span class="tt">"&nbsp;".blank?</span>、<span class="tt">nil.blank?</span>はいずれも<span class="tt">true</span>になります)。この<span class="tt">cookies.permanent</span>メソッドでは、cookiesが20年後に期限切れになる (<span class="tt">20.years.from_now</span>) ように指定していますが、これはRailsの<em>timeヘルパー</em>を使用した格好の例題になります。timeヘルパーはRailsによって、数値関連の基底クラスである<span class="tt">Fixnum</span>クラスに追加されます。</p>
<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 09 Aug 2015 16:48:17 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 31 May 2014 16:48:45 UTC +00:00</pre>
<p class="noindent">Railsは以下のようなヘルパーも追加しています。</p>
<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>
<p class="noindent">上のヘルパーは、ファイルのアップロードに<span class="tt">5.megabytes</span>などの制限を与えるのに便利です。</p>
<p>メソッドを組み込みクラスに追加できる柔軟性の高さのおかげで、純粋なRubyを極めて自然に拡張することができます (もちろん注意して使う必要はありますが)。実際、Railsのエレガントな仕様の多くは、背後にあるRubyの高い拡張性によって実現されているのです。</p>

</div>
<p>ユーザーIDをcookiesに保存するには、<code>session</code>メソッドで使用したのと同じパターン (<a class="hyperref" href="#code-log_in_function">リスト<span class="ref">8.12</span></a>) を使用します。具体的には以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p class="noindent">しかしこのままではIDが生のテキストとしてcookiesに保存されてしまうので、アプリケーションのcookiesの形式が見え見えになってしまい、攻撃者がユーザーアカウントを奪い取ることを助けてしまう可能性があります。これを避けるために、<em>署名付き</em>cookieを使用します。これは、cookieをブラウザに保存する前に安全に暗号化するためのものです。</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p class="noindent">ユーザーIDと永続記憶トークンはペアで扱う必要があるので、cookieも永続化しなくてはなりません。そこで、以下のように<code>signed</code>メソッドと<code>permanent</code>メソッドをチェイン (連鎖) して使用します。</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>cookiesを設定すると、以後のページのビューで以下のようにしてcookiesからユーザーを取り出せるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent"><code>cookies.signed[:user_id]</code>では自動的にユーザーIDのcookiesの暗号が解除され、元に戻ります。続いてbcryptを使用し、<code>cookies[:remember_token]</code>が<code>remember_digest</code>と一致することを確認します (<a class="hyperref" href="#code-user_model_remember">リスト<span class="ref">8.32</span></a>)。ところで、署名されたユーザーIDがあれば記憶トークンは不要なのではないかと疑問に思う方もいるかもしれません。しかし記憶トークンがなければ、暗号化されたIDを奪った攻撃者は、暗号化IDをそのまま使ってお構いなしにログインしてしまうでしょう。現在の設計では、攻撃者が仮に両方のcookiesを奪い取ることに成功したとしても、本物のユーザーがログアウトするとログインできないようになっています。</p>
<p>パズルもいよいよ最後のピースを残すだけとなりました。渡されたトークンがユーザーの記憶ダイジェストと一致することを確認します。この一致をbcryptで確認するための様々な方法があります。<a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">secure_passwordのソースコード</a>を調べてみると、以下のような比較を行っている箇所があります<sup class="footnote" id="cha-8_footnote-ref-19"><a href="#cha-8_footnote-19">19</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">password_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">unencrypted_password</span>
</pre></div></div>
<p class="noindent">今回の場合、上のコードを参考に下のようなコードを使用します。</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">remember_token</span>
</pre></div></div>
<p class="noindent">このコードをじっくり調べてみると、実に奇妙なつくりになっています。bcryptで暗号化されたパスワードを、トークンと直接比較しています。ということは、<code>==</code>で比較する際にダイジェストを<em>復号化</em>しているのでしょうか。しかし、bcryptのハッシュは復号化できないはずなので、復号化しているはずはありません。そこで<a href="https://github.com/codahale/bcrypt-ruby/blob/master/lib/bcrypt/password.rb" target="_blank">bcrypt gemのソースコード</a>を詳しく調べてみると、なんと、比較に使用している<code>==</code>演算子が<em>再定義</em>されています。実際の比較をコードで表すと、以下のようになっています。</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">実際の比較では、<code>==</code>の代わりに<code>is_password?</code>という論理値メソッドが使用されています。これで少し見えてきました。今から書くアプリケーションコードでもこれと同じ方法を使用することにしましょう。</p>
<p>以上の説明を元に、ダイジェストトークンの比較をUserモデルの<code>authenticated?</code>メソッドの中に置けばよいのではないかと推測できます。このメソッドは、<code>has_secure_password</code>で提供されるユーザー認証用の<code>authenticate</code>メソッドと似ています (<a class="hyperref" href="#code-log_in_success">リスト<span class="ref">8.13</span></a>)。この実装結果を<a class="hyperref" href="#code-authenticated_p">リスト<span class="ref">8.33</span></a>に示します。ところで、この<code>authenticated?</code>メソッド (<a class="hyperref" href="#code-authenticated_p">リスト<span class="ref">8.33</span></a>) は記憶ダイジェストと強く結びついていますが、実は他の様々な用途にも応用できます。<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset">第<span class="ref">10</span>章</a>ではこのメソッドを一般化してみます。</p>
<div class="codelisting" id="code-authenticated_p" data-tralics-id="uid817" data-number="8.33">
<div class="heading">
<span class="number">リスト8.33:</span> 

<span class="description"><code>authenticated?</code>メソッドをUserモデルに追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ランダムなトークンを返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># 永続的セッションで使用するユーザーをデータベースに記憶する</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># 渡されたトークンがダイジェストと一致したらtrueを返す</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-authenticated_p">リスト<span class="ref">8.33</span></a>で定義されている<code>authenticated?</code>メソッド内の<code>remember_token</code>の引数は、<a class="hyperref" href="#code-user_model_remember">リスト<span class="ref">8.32</span></a>の<code>attr_accessor :remember_token</code>で定義されているアクセサと同じではない点にご注意ください。引数は、メソッド内ローカルな変数になっていますが、記憶トークンを参照しているので問題ありません。メソッドの引数と同じ名前を使用することはよくあります。もうひとつ、<code>remember_digest</code>の属性の使用法にご注目ください。この使用法は<code>self.remember_digest</code>と同じであり、<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users">第<span class="ref">6</span>章</a>の<code>name</code>や<code>email</code>の使用法とも似ています。remember_digestの属性は、データベースのカラムに対応してActive Recordによって自動的に作成されます (<a class="hyperref" href="#code-add_remember_digest_to_users_generated">リスト<span class="ref">8.30</span></a>)。</p>
<p>これで、ログインユーザーの記憶処理を作る準備が整いました。<code>remember</code>ヘルパーメソッドを追加して、<code>log_in</code>と連携させます (<a class="hyperref" href="#code-log_in_with_remember">リスト<span class="ref">8.34</span></a>)。</p>
<div class="codelisting" id="code-log_in_with_remember" data-tralics-id="uid818" data-number="8.34">
<div class="heading">
<span class="number">リスト8.34:</span> 

<span class="description">ログインしてユーザーを保持する<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">remember</span> <span class="n">user</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>log_in</code>のときと同様に、<a class="hyperref" href="#code-log_in_with_remember">リスト<span class="ref">8.34</span></a>では実際のSessionsヘルパーの動作は、<code>remember</code>メソッド定義の<code>user.remember</code>を呼び出すまで遅延され、そこで記憶トークンを生成してトークンのダイジェストをデータベースに保存します。続いて上と同様に、<code>cookies</code>メソッドでユーザーIDと記憶トークンの永続cookiesを作成します。変更結果を<a class="hyperref" href="#code-remember_method">リスト<span class="ref">8.35</span></a>に示します。</p>
<div class="codelisting" id="code-remember_method" data-tralics-id="uid819" data-number="8.35">
<div class="heading">
<span class="number">リスト8.35:</span> 

<span class="description">ユーザーを記憶する<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーを永続的セッションに記憶する</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</span>  <span class="k">end</span>

  <span class="c1"># 現在ログインしているユーザーを返す (ユーザーがログイン中の場合のみ)</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーがログインしていればtrue、その他ならfalseを返す</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># 現在のユーザーをログアウトする</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-remember_method">リスト<span class="ref">8.35</span></a>のコードでは、ログインするユーザーはブラウザで有効な記憶トークンを得られるように記憶されますが、<a class="hyperref" href="#code-current_user">リスト<span class="ref">8.14</span></a>で定義した<code>current_user</code>メソッドでは一時セッションしか扱っていないので、このままでは正常に動作しません。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">永続セッションの場合は、<code>session[:user_id]</code>が存在すれば一時セッションからユーザーを取り出し、それ以外の場合は<code>cookies[:user_id]</code>からユーザーを取り出すして、対応する永続セッションにログインする必要があります。これを行うには、以下のように記述します。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">上のコードでも<code>user &amp;&amp; user.authenticated</code> (<a class="hyperref" href="#code-find_authenticate_user">リスト<span class="ref">8.5</span></a>) を使用している点にご注目ください。上のコードは動作しますが、今のままでは<code>session</code>も<code>cookies</code>もそれぞれ2回使用されてしまい、無駄です。これを解消するには、次のようにします。</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll"><span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">上のコードでは、よく使われる以下のような構造が使用されていますが、少し紛らわしい点があります。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">一見、上のコードは比較を行っているように見えますが、これは比較では<em>ありません</em>。比較であれば<code>==</code>を使用するはずですが、ここでは<em>代入</em>を行っています。このコードを言葉で表すと、「ユーザーIDがユーザーIDのセッションと等しければ...」ではなく、「(ユーザーIDにユーザーIDのセッションを代入した結果) ユーザーIDのセッションが存在すれば」となります<sup class="footnote" id="cha-8_footnote-ref-20"><a href="#cha-8_footnote-20">20</a></sup>。</p>
<p>前述のように<code>current_user</code>ヘルパーを定義すると、<a class="hyperref" href="#code-persistent_current_user">リスト<span class="ref">8.36</span></a>のようになります。</p>
<div class="codelisting" id="code-persistent_current_user" data-tralics-id="uid821" data-number="8.36">
<div class="heading">
<span class="number">リスト8.36:</span> 

<span class="description">永続的セッションの<code>current_user</code>を更新する<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーを永続的セッションに記憶する</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
  <span class="k">end</span>

  <span class="c1"># 記憶トークンcookieに対応するユーザーを返す</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">end</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

  <span class="c1"># ユーザーがログインしていればtrue、その他ならfalseを返す</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># 現在のユーザーをログアウトする</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-persistent_current_user">リスト<span class="ref">8.36</span></a>のコードでは、新しくログインしたユーザーは正しく記憶されます。実際にログインしてからブラウザを閉じ、アプリケーションを再起動してからもう一度ブラウザでアプリケーションを開いてみると、期待どおり動作していることを確認できます。その気になれば、ブラウザのcookiesをブラウザで直接調べて結果を確認することもできます (<a class="hyperref" href="#fig-cookie_in_browser">図<span class="ref">8.10</span></a>)<sup class="footnote" id="cha-8_footnote-ref-21"><a href="#cha-8_footnote-21">21</a></sup>。</p>
<div class="center figure" id="fig-cookie_in_browser" data-tralics-id="uid823" data-number="8.10">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/cookie_in_browser_chrome.png" alt="images/figures/cookie_in_browser_chrome"></div>
<div class="caption">
<span class="header">図8.10: </span><span class="description">ブラウザに記憶トークンのcookiesを表示する
</span>
</div>
</div>
<p>アプリケーションに現在残された問題はあと1つだけです。ブラウザのcookiesを削除する手段が未実装なので (20年待てば消えますが)、ユーザーがログアウトできません。これは当然テストスイートでキャッチすべき問題であり、<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>にならなければなりません。</p>
<div class="codelisting" id="uid824" data-tralics-id="uid824" data-number="8.37">
<div class="heading">
<span class="number">リスト8.37:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-forgetting_users" class="subsection" data-tralics-id="uid825" data-number="8.4.3">
<h3><a href="#sec-forgetting_users" class="heading hyperref"><span class="number">8.4.3 </span>ユーザーを忘れる</a></h3>
<p>ユーザーがログアウトできるようにするために、ユーザーを記憶するためのメソッドと同様の方法で、ユーザーを忘れるためのメソッドを定義します。この<code>user.forget</code>メソッドによって、<code>user.remember</code>が取り消されます。具体的には、記憶ダイジェストを<code>nil</code>で更新します (<a class="hyperref" href="#code-user_model_forget">リスト<span class="ref">8.38</span></a>)。</p>
<div class="codelisting" id="code-user_model_forget" data-tralics-id="uid826" data-number="8.38">
<div class="heading">
<span class="number">リスト8.38:</span> 

<span class="description"><code>forget</code>メソッドをUserモデルに追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ランダムなトークンを返す</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># 永続的セッションで使用するユーザーをデータベースに記憶する</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># 渡されたトークンがダイジェストと一致したらtrueを返す</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ユーザーログインを破棄する</span>
  <span class="k">def</span> <span class="nf">forget</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-user_model_forget">リスト<span class="ref">8.38</span></a>のコードを使用すると、永続セッションを終了できるようになる準備が整います。終了するには、<code>forget</code>ヘルパーメソッドを追加して<code>log_out</code>ヘルパーメソッドから呼び出します (<a class="hyperref" href="#code-log_out_with_forget">リスト<span class="ref">8.39</span></a>)。<a class="hyperref" href="#code-log_out_with_forget">リスト<span class="ref">8.39</span></a>を見ると、<code>forget</code>ヘルパーメソッドでは<code>user.forget</code>を呼んでから<code>user_id</code>と<code>remember_token</code> cookiesを削除していることがわかります。</p>
<div class="codelisting" id="code-log_out_with_forget" data-tralics-id="uid827" data-number="8.39">
<div class="heading">
<span class="number">リスト8.39:</span> 

<span class="description">永続セッションからログアウトする<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># 渡されたユーザーでログインする</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 永続的セッションを破棄する</span>
  <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">forget</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 現在のユーザーがログアウトする</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">forget</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span>    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div>
<div id="sec-two_subtle_bugs" class="subsection" data-tralics-id="uid828" data-number="8.4.4">
<h3><a href="#sec-two_subtle_bugs" class="heading hyperref"><span class="number">8.4.4 </span>２つの目立たないバグ</a></h3>
<p>実は小さなバグが2つ残っています。2つのバグは互いに強く関連しています。1つ目の地味な問題です。ユーザーは場合によっては、同じサイトを複数のウィンドウ (あるいはタブ) で開いていることもあります。ログアウト用リンクはログイン中には表示されませんが、現在の<code>current_user</code>の使用法では、ユーザーが1つのウィンドウでログアウトすると、もう1つのウィンドウでログアウトしたときにエラーになります <a class="hyperref" href="#code-log_out_with_forget">リスト<span class="ref">8.39</span></a>)<sup class="footnote" id="cha-8_footnote-ref-22"><a href="#cha-8_footnote-22">22</a></sup>。これは、もう1つのウィンドウにある "Log out" リンクをクリックすると、current_userが既にnilとなってしまうため、log_outメソッド内のforget(current_user)が失敗してしまうからです。この問題を回避するためには、ユーザーがログイン中の場合にのみログアウトさせる必要があります。</p>
<p>2番目の地味な問題は、ユーザーが複数のブラウザ (ChromeやFirefoxなど) でログインしていたときに生じます。具体的には、一方のブラウザではログアウトし、もう一方のブラウザではログアウトせずに、一度ブラウザを終了させ、再度同じページを開くと、この問題が発生します<sup class="footnote" id="cha-8_footnote-ref-23"><a href="#cha-8_footnote-23">23</a></sup>。FirefoxとChromeを使った具体例で考えてみましょう。ユーザーがFirefoxからログアウトすると、<code>user.forget</code>メソッドによって記憶ダイジェストが<code>nil</code>になります (<a class="hyperref" href="#code-user_model_forget">リスト<span class="ref">8.38</span></a>)。この時点では、アプリケーションはFirefoxでまだ正常に動作するはずです。つまり、<a class="hyperref" href="#code-log_out_with_forget">リスト<span class="ref">8.39</span></a>では<code>log_out</code>メソッドによってユーザーIDが削除されるため、ハイライトされている2つの条件が<code>false</code>になります。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># 記憶トークンcookieに対応するユーザーを返す</span>
<span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">結果として、<code>current_user</code>メソッドの最終的な評価結果は、期待どおり<code>nil</code>になります。</p>
<p>一方、Chromeを閉じたとき、<code>session[:user_id]</code>は<code>nil</code>になります (これはブラウザが閉じたときに、全てのセッション変数の有効期限が切れるためです)。しかし、<code>cookies</code>はブラウザの中に残り続けているため、データベースからそのユーザーを見つけることができてしまいます。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># 記憶トークンcookieに対応するユーザーを返す</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">結果として、次の<code>if</code>文の条件式が評価されます。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このときに<code>user</code>が<code>nil</code>であれば、1番目の条件式で評価は終了するのですが、実際にはnilではないので、<em>2番目の</em>条件式まで評価が進み、そのときにエラーが発生します。これは、Firefoxでログアウトしたときに (<a class="hyperref" href="#code-user_model_forget">リスト<span class="ref">8.38</span></a>) ユーザーの記憶ダイジェストが削除されているので、Chromeでアプリケーションにアクセスしたとき、最終的に次の文を実行するからです。</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">つまり、上の式が評価されるとき、記憶ダイジェストが既に<code>nil</code>になっているため、bcryptライブラリ内部で例外が発生します。この問題を修正するには、<code>authenticated?</code>が<code>false</code>を返すようにする必要があります。</p>
<p>テスト駆動開発は、この種の地味なバグ修正にはうってつけです。そこで、2つのエラーをキャッチするテストを書くことにします。<a class="hyperref" href="#code-user_logout_test">リスト<span class="ref">8.28</span></a>を元に、<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>になるテストを作成します (<a class="hyperref" href="#code-test_double_logout">リスト<span class="ref">8.40</span></a>)。</p>
<div class="codelisting" id="code-test_double_logout" data-tralics-id="uid831" data-number="8.40">
<div class="heading">
<span class="number">リスト8.40:</span> 

<span class="description">ユーザーログアウトのテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">delete</span> <span class="n">logout_path</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
<span class="hll">    <span class="c1"># 2番目のウィンドウでログアウトをクリックするユーザーをシミュレートする</span>
</span><span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span>    <span class="n">follow_redirect!</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-test_double_logout">リスト<span class="ref">8.40</span></a>では、<code>current_user</code>がないために2回目の<code>delete logout_path</code>の呼び出しでエラーが発生し、テストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>になります。</p>
<div class="codelisting" id="uid832" data-tralics-id="uid832" data-number="8.41">
<div class="heading">
<span class="number">リスト 8.41:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-destroy_forget">リスト<span class="ref">8.42</span></a>のアプリケーションコードでは、<code>logged_in?</code>がtrueの場合に限って<code>log_out</code>を呼び出すように変更しました。</p>
<div class="codelisting" id="code-destroy_forget" data-tralics-id="uid833" data-number="8.42">
<div class="heading">
<span class="number">リスト8.42:</span> 

<span class="description">ログイン中の場合のみログアウトする<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
</span>    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>2番目の問題についてですが、統合テストで2種類のブラウザをシミュレートするのは正直かなり困難です。その代わり、同じ問題をUserモデルで直接テストするだけなら簡単に行えます。記憶ダイジェストを持たないユーザーを用意し (<code>setup</code>メソッドで定義した<code>@user</code>インスタンス変数ではtrueになります)、続いて<code>authenticated?</code>を呼び出します (<a class="hyperref" href="#code-test_authenticated_invalid_token">Listing&nbsp;<span class="ref">8.43</span></a>)。この中で、記憶トークンを空欄のままにしていることにご注目ください。記憶トークンが使用される前にエラーが発生するので、記憶トークンの値は何でも構わないのです。</p>
<div class="codelisting" id="code-test_authenticated_invalid_token" data-tralics-id="uid834" data-number="8.43">
<div class="heading">
<span class="number">リスト8.43:</span> 

<span class="description">ダイジェストが存在しない場合の<code>authenticated?</code>のテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><code>BCrypt::Password.new(nil)</code>でエラーが発生し、テストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>になります。</p>
<div class="codelisting" id="uid835" data-tralics-id="uid835" data-number="8.44">
<div class="heading">
<span class="number">リスト 8.44:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>エラーを修正してテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるようにするには、記憶ダイジェストが<code>nil</code>の場合に<code>false</code>を返すようにすればよいのです (<a class="hyperref" href="#code-authenticated_p_fixed">リスト<span class="ref">8.45</span></a>)。</p>
<div class="codelisting" id="code-authenticated_p_fixed" data-tralics-id="uid836" data-number="8.45">
<div class="heading">
<span class="number">リスト8.45:</span> 

<span class="description"><code>authenticated?</code>を更新してダイジェストが存在しない場合に対応する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 渡されたトークンがダイジェストと一致したらtrueを返す</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
</span>    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここでは、記憶ダイジェストが<code>nil</code>の場合には<code>return</code>キーワードで即座にメソッドを終了しています。処理を中途で終了する場合によく使われるテクニックです。以下のコードでもよいのですが、</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="kp">false</span>
<span class="k">else</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">筆者は<a class="hyperref" href="#code-authenticated_p_fixed">リスト<span class="ref">8.45</span></a>のように明示的にreturnする方が、コードが若干短くなることもあって好みです。</p>
<p><a class="hyperref" href="#code-authenticated_p_fixed">リスト<span class="ref">8.45</span></a>のコードを使用すると、テストスイート全体が<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になり、サブタイトルは両方とも修正されるはずです。</p>
<div class="codelisting" id="uid837" data-tralics-id="uid837" data-number="8.46">
<div class="heading">
<span class="number">リスト 8.46:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-remember_me_checkbox" class="subsection" data-tralics-id="uid838" data-number="8.4.5">
<h3><a href="#sec-remember_me_checkbox" class="heading hyperref"><span class="number">8.4.5 </span>“Remember me” チェックボックス</a></h3>
<p><a class="hyperref" href="#sec-forgetting_users"><span class="ref">8.4.3</span></a>のコードで、アプリケーションにプロ仕様の完全な認証システムが導入されました。本章の最後に、[remember me] チェックボックスでログインを保持する方法を解説します。チェックボックスを追加したモックアップを<a class="hyperref" href="#fig-login_remember_me_mockup">図<span class="ref">8.11</span></a>に示します。</p>
<div class="center figure" id="fig-login_remember_me_mockup" data-tralics-id="uid839" data-number="8.11">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_remember_me_mockup.png" alt="images/figures/login_remember_me_mockup"></div>
<div class="caption">
<span class="header">図8.11: </span><span class="description">[remember me] チェックボックスのモックアップ
</span>
</div>
</div>
<p>今回の実装は、<a class="hyperref" href="#code-login_form">リスト<span class="ref">8.2</span></a>のログインフォームにチェックボックスを追加するところから始めます。チェックボックスは、他のラベル、テキストフィールド、パスワードフィールド、送信ボタンと同様にヘルパーメソッドで作成できます。ただし、チェックボックスが正常に動作するためには、以下のようにラベルの<em>内側</em>に配置する必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">上をログインフォームに反映したコードを<a class="hyperref" href="#code-remember_me_checkbox">リスト<span class="ref">8.47</span></a>に示します。</p>
<div class="codelisting" id="code-remember_me_checkbox" data-tralics-id="uid840" data-number="8.47">
<div class="heading">
<span class="number">リスト8.47:</span> 

<span class="description">[remember me] チェックボックスをログインフォームに追加する<span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-remember_me_checkbox">リスト<span class="ref">8.47</span></a>では、2つのCSSクラス<code>checkbox</code>と<code>inline</code>をインクルードしています。Bootstrapではこれらをチェックボックスとテキスト「Remember me on this computer”」として同じ行に配置します。スタイルを整えるため、もう少しCSSルールを追加します (<a class="hyperref" href="#code-remember_me_css">リスト<span class="ref">8.48</span></a>)。表示されるログインフォームを<a class="hyperref" href="#fig-login_form_remember_me">図<span class="ref">8.12</span></a>に示します。</p>
<div class="codelisting" id="code-remember_me_css" data-tralics-id="uid841" data-number="8.48">
<div class="heading">
<span class="number">リスト8.48:</span> 

<span class="description">[remember me] チェックボックスのCSS<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.checkbox</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">-10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nt">span</span> <span class="p">{</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nn">#session_remember_me</span> <span class="p">{</span>
  <span class="na">width</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-login_form_remember_me" data-tralics-id="uid842" data-number="8.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/login_form_remember_me.png" alt="images/figures/login_form_remember_me"></div>
<div class="caption">
<span class="header">図8.12</span> <span class="description">"remember_token" チェックボックスを追加したloginフォーム
</span>
</div>
</div>
<p>ログインフォームの編集が終わったので、チェックボックスがオンのときにユーザーを記憶し、オフのときには記憶しないようにします。信じられないかもしれませんが、必要な準備はすべて終わっているので、実装はわずか1行で終わります。ログインフォームから送信された<code>params</code>ハッシュには既にチェックボックスの値が含まれています。<a class="hyperref" href="#code-remember_me_checkbox">リスト<span class="ref">8.47</span></a>のフォームに無効な値を入力して実際に送信すれば、ページのデバッグ情報で値を確認することもできます。特に、以下の値は、</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">チェックボックスがオンのときに<code>’1’</code>になり、オフのときに<code>’0’</code>になります。</p>
<p><code>params</code>ハッシュのこの値を調べれば、送信された値に基いてユーザーを記憶したり忘れたりできるようになります<sup class="footnote" id="cha-8_footnote-ref-24"><a href="#cha-8_footnote-24">24</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span>
  <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#aside-ternary_operator">コラム<span class="ref">8.3</span></a>で解説したように、以下のような「<em>三項演算子</em>」を使用すると、このような<code>if</code>-<code>then</code>分岐構造を1行で表すことができます<sup class="footnote" id="cha-8_footnote-ref-25"><a href="#cha-8_footnote-25">25</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">Sessionsコントローラの<code>create</code>に上の行を追加した結果を<a class="hyperref" href="#code-remember_me_ternary">リスト<span class="ref">8.49</span></a>に示します。驚くほどコンパクトなコードになりました。既に読者の皆様は、<code>cost</code>変数の定義に三項演算子を使用した<a class="hyperref" href="#code-digest_method">リスト<span class="ref">8.18</span></a>のコードも理解できるようになったことでしょう。</p>
<div class="codelisting" id="code-remember_me_ternary" data-tralics-id="uid845" data-number="8.49">
<div class="heading">
<span class="number">リスト8.49:</span> 

<span class="description">[remember me] チェックボックスの送信結果を処理する<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-remember_me_ternary">リスト<span class="ref">8.49</span></a>の実装によって、ログインシステムの実装がついに完了しました。ブラウザでこのチェックボックスを実際にオンにしたりオフにしたりして、動作を確認してみましょう。</p>
<div class="aside" id="aside-ternary_operator" data-tralics-id="uid846" data-number="8.3">
<div class="heading">
<span class="number">コラム8.3</span> 

<span class="description">10種類の人々</span>
</div>
<p>「この世には10種類の人間がいる。三項演算子を理解できる奴と、三項演算子を理解できない奴だ。」は、この業界に古くから伝わるジョークです。なお、「10種類」は2進法なので10進法で書けば「2種類」になります。上のジョークに倣えば、この世には10種類の人々がいます。三項演算子を好きな人、嫌いな人、三項演算子を知らない人です。もし3番目に該当したとしても、すぐそのカテゴリの人ではなくなりますのでご心配なく。</p>
<p>プログラミング経験を重ねるうちに、以下のように論理値に応じて分岐する制御フローが実によく出現することがすぐにわかると思います。</p>
<pre class="verbatim">  if boolean?
    do_one_thing
  else
    do_something_else
  end</pre>
<p class="noindent">Rubyや他の言語 (C/C++、Perl、PHP、Javaなど) では、上のようなフローをよりコンパクトな<em>三項演算子 (ternary operator)</em> と呼ばれる表現で置き換えることができます (3つの部分から構成されるためそのように呼ばれます)。</p>
<pre class="verbatim">  論理値? ?  何かをする : 別のことをする</pre>
<p class="noindent">以下のような代入文を三項演算子で置き換えることもできます。</p>
<pre class="verbatim">  if boolean?
    var = foo
  else
    var = bar
  end</pre>
<p class="noindent">上のコードは以下のように1行で書けます。</p>
<pre class="verbatim">var = boolean? ?foo : bar</pre>
<p class="noindent">最後に、三項演算子を関数の戻り値として使用することもよくあります。</p>
<pre class="verbatim">  def foo
    do_stuff
    boolean? ? "bar" : "baz"
  end</pre>
<p class="noindent">Rubyでは暗黙的に関数の最後の式の値を返すので、上の<span class="tt">foo</span>メソッドは、<span class="tt">boolean?</span>が<span class="tt">true</span>であるか<span class="tt">false</span>であるかに応じて、<span class="tt">"bar"</span>または<span class="tt">"baz"</span>をそれぞれ返します。</p>

</div>
</div>
<div id="sec-remember_tests" class="subsection" data-tralics-id="uid847" data-number="8.4.6">
<h3><a href="#sec-remember_tests" class="heading hyperref"><span class="number">8.4.6 </span>Rememberのテスト</a></h3>
<p>[remember me] 機能は既に快調に動作していますが、ここで終わらせずにテストをちゃんと書き、動作をテストで確認できるようにしておくことが重要です。テストを書く理由のひとつは、今行った実装のエラーをキャッチできるようにすることです。しかしもっと重要な理由は、ユーザーを永続化するコードの中心部分が、実はまだまったくテストされていないからです。これらの課題を達成するには、もう少し新しいテストのテクニックを覚える必要がありますが、それによりテストスイートが一段と強力になります。</p>
<div id="sec-testing_the_remember_me_box" class="subsubsection" data-tralics-id="uid848" data-number="8.4.6.1">
<h4><a href="#sec-testing_the_remember_me_box" class="heading">[remember me] ボックスをテストする</a></h4>
<p>恥を忍んで申し上げると、筆者が自分自身で<a class="hyperref" href="#code-remember_me_ternary">リスト<span class="ref">8.49</span></a>でチェックボックスの処理を実装したときは、</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">最初は上のコードではなく、以下のコードを使用していました。</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">この流れでは、<code>params[:session][:remember_me]</code>の値は<code>’0’</code>または<code>’1’</code>のいずれかになりますが、そこに罠がありました。0も1もRubyの論理値では<code>true</code>であることを思い出してください。従って、値は<em>常にtrue</em>になってしまい、チェックボックスは常にオンになっているのと同じ動作になってしまいました。この種のミスはまさに、テストでキャッチすべきエラーです。</p>
<p>ユーザーが記憶されるにはログインが必要です。そこで、テスト内でユーザーがログインできるようにするためのヘルパーメソッドを定義することから始めます。<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>では、<code>post</code>メソッドと有効な<code>session</code>ハッシュを使用してログインしましたが、毎回このようなことをするのは面倒です。そこで、<code>log_in_as</code>というヘルパーメソッドを作成してテスト用にログインできるようにし、無駄な繰り返しを排除します。</p>
<p>ログインに使用するメソッドは、テストの種類によって異なります。統合テストの内部では、<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>のようにセッションパスをpostしますが、コントローラやモデルなどの単体テストでは同じ方法が使えません (セッションがないからです)。後者の場合は<code>session</code>メソッドを人為的に操作して回避しなければなりません。このため、<code>log_in_as</code>ではテストの種類を検出して、それに応じたログインを行えるようにする必要があります。統合テストとその他のテストを区別するには、Rubyの定番である<code>defined?</code>メソッドを使用します。このメソッドは、引数の内容が定義されている場合はtrueを、その他の場合はfalseを返します。この場合は、<code>post_via_redirect</code>メソッド (<a class="hyperref" href="sign_up?version=4.2#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>) が統合テストの場合にのみアクセス可能であることを利用し、以下のようなコードを使用します。</p>
<div class="code"><div class="highlight"><pre><span class="n">defined?</span><span class="p">(</span><span class="n">post_via_redirect</span><span class="p">)</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div></div>
<p class="noindent">上のコードは、統合テストの実行中には<code>true</code>を返し、その他の場合にはfalseを返します。せっかくなので、統合テストを実行中かどうかを論理値で返す<code>integration_test?</code>メソッドを定義し、以下のようにif-thenステートメントをわかりやすく書くことにしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">integration_test?</span>
  <span class="c1"># セッション用パスにpostしてログインする</span>
<span class="k">else</span>
  <span class="c1"># sessionメソッドでログインする</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">コメント部分にコードを書けば、<code>log_in_as</code>ヘルパーメソッドができあがります (<a class="hyperref" href="#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>)。注: このコメント部分に書くコードはそれなりに込み入っています。可能であれば、一行ずつ読んで完全に理解しておくことをおすすめします。(訳注: テストのコードでは、操作を実現するためにこのようなトリッキーなコードを使わざるを得ないときがあります。)</p>
<div class="codelisting" id="code-test_helper_log_in" data-tralics-id="uid849" data-number="8.50">
<div class="heading">
<span class="number">リスト8.50:</span> 

<span class="description"><code>log_in_as</code>ヘルパーを追加する<span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># テストユーザーがログイン中の場合にtrueを返す</span>
  <span class="k">def</span> <span class="nf">is_logged_in?</span>
    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># テストユーザーとしてログインする</span>
  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">password</span>    <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>    <span class="o">||</span> <span class="s1">'password'</span>
    <span class="n">remember_me</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">||</span> <span class="s1">'1'</span>
<span class="hll">    <span class="k">if</span> <span class="n">integration_test?</span>
</span>      <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span>       <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                  <span class="ss">password</span><span class="p">:</span>    <span class="n">password</span><span class="p">,</span>
                                  <span class="ss">remember_me</span><span class="p">:</span> <span class="n">remember_me</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># 統合テスト内ではtrueを返す</span>
    <span class="k">def</span> <span class="nf">integration_test?</span>
<span class="hll">      <span class="n">defined?</span><span class="p">(</span><span class="n">post_via_redirect</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">テストコードを最大限に柔軟にするため、<code>log_in_as</code>メソッド (<a class="hyperref" href="#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>) では<code>options</code>ハッシュ (<a class="hyperref" href="sign_up?version=4.2#code-gravatar_option">リスト<span class="ref">7.31</span></a>) を引数に取り、パスワードと [remember me] チェックボックスのデフォルト値をそれぞれ<code>’password’</code>と<code>’1’</code>に設定します。特に、キーが存在しない場合はハッシュが<code>nil</code>を返すので、</p>
<div class="code"><div class="highlight"><pre><span class="n">remember_me</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">||</span> <span class="s1">'1'</span>
</pre></div></div>
<p class="noindent">上のようなコードでは、渡されたオプションが存在すれば評価し、それ以外の場合はデフォルトのオプションを使用します (このテクニックは<a class="hyperref" href="#aside-or_equals">コラム<span class="ref">8.1</span></a>でご紹介した「短絡評価」の応用です)。</p>
<p>[remember me] チェックボックスの動作を確認するために、2つのテストを作成します。チェックボックスがオンになっている場合とオフになっている場合のテストです。<a class="hyperref" href="#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>でログインヘルパーメソッドを定義しておいたので、このテストは簡単に書くことができます。2つのテストはそれぞれ以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">および</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上のコードの<code>’1’</code>は<code>remember_me</code>のデフォルト値なので、1つ目のテストでは省略してもよいのですが、2つのコードを見比べやすいようにあえて省略しませんでした。</p>
<p>ログインに成功すれば、<code>cookies</code>内部の<code>remember_token</code>キーを調べることで、ユーザーが保存されたかどうかをチェックできるようになります。cookiesの値がユーザーの記憶トークンと一致することを確認できれば理想的なのですが、現在の設計ではテストでこの確認を行うことはできません。コントローラ内の<code>user</code>変数には記憶トークンの属性が含まれていますが、<code>remember_token</code>は実在しない「仮想」のものなので、<code>@user</code>インスタンス変数の方には含まれていません。この課題は大して難しくないので、<a class="hyperref" href="#sec-log_in_out_exercises"><span class="ref">8.6</span></a>の演習に回すことにします。さしあたって、今は関連するcookiesが<code>nil</code>であるかどうかだけをチェックすればよいことにします。</p>
<p>実はもうひとつ地味な問題があります。ある理由によって、テスト内では<code>cookies</code>メソッドにシンボルを使用できないのです。そのため、</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">上のコードは常に<code>nil</code>になってしまいます。ありがたいことに、文字列キーなら<code>cookies</code>で<em>使用できる</em>ので、</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</pre></div></div>
<p class="noindent">上のように書けば期待どおりに値が返されます。以上の結果を反映したテストコードを<a class="hyperref" href="#code-remember_me_test">リスト<span class="ref">8.51</span></a>に示します (<a class="hyperref" href="#code-user_login_test_valid_information">リスト<span class="ref">8.20</span></a>で<code>users(:michael)</code>と書くと、<a class="hyperref" href="#code-real_user_fixture">リスト<span class="ref">8.19</span></a>のフィクスチャユーザーを参照していたことを思い出しましょう)。</p>
<div class="codelisting" id="code-remember_me_test" data-tralics-id="uid850" data-number="8.51">
<div class="heading">
<span class="number">リスト8.51:</span> 

<span class="description">[remember me] チェックボックスのテスト<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">皆さんが著者と同じ間違いをしていなければ、このテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid851" data-tralics-id="uid851" data-number="8.52">
<div class="heading">
<span class="number">リスト8.52:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-testing_the_remember_branch" class="subsubsection" data-tralics-id="uid852" data-number="8.4.6.2">
<h4><a href="#sec-testing_the_remember_branch" class="heading">記憶ブランチをテストする</a></h4>
<p><a class="hyperref" href="#sec-login_with_remembering"><span class="ref">8.4.2</span></a>では、それまでの節で実装した永続的セッションが動作するかどうかを手動で確認していました。しかし実は、<code>current_user</code>内のある分岐部分については、これまでまったくテストが行われていないのです。筆者はこのことに気付いた場合に、テストを忘れている疑いのあるコードブロック内にわざと例外発生を仕込むという手法を好んで使います。そのコードブロックがテストから漏れていれば、テストはパスしてしまうはずです。コードブロックがテストから漏れていなければ、例外が発生してテストが中断するはずです。現在のコードでこれを行ってみた結果を<a class="hyperref" href="#code-branch_raise">リスト<span class="ref">8.53</span></a>に示します。</p>
<div class="codelisting" id="code-branch_raise" data-tralics-id="uid853" data-number="8.53">
<div class="heading">
<span class="number">リスト8.53:</span> 

<span class="description">テストされていないブランチで例外を発生する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 記憶トークンcookieに対応するユーザーを返す</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">raise</span>       <span class="c1"># テストがパスすれば、この部分がテストされていないことがわかる</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">この段階でテストを実行してみると、<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になります。</p>
<div class="codelisting" id="uid854" data-tralics-id="uid854" data-number="8.54">
<div class="heading">
<span class="number">リスト8.54:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-branch_raise">リスト<span class="ref">8.53</span></a>のコードが正常でないことがわかった以上、これはもちろん問題です。さらに申し上げると、この種の永続的セッションを手動で確認するのは非常に面倒なので、<code>current_user</code>をリファクタリングするのであれば (<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset">第<span class="ref">10</span>章</a>で行う予定です) 同時にテストも作成しておくことが重要です。</p>
<p><a class="hyperref" href="#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>で定義した<code>log_in_as</code>ヘルパーメソッドでは、<code>session[:user_id]</code>が自動的に定義されます。従って、<code>current_user</code>メソッドで今問題になっている「記憶」ブランチを統合テストでテストするのは非常に困難です。ありがたいことに、以前作成した以下のSessionsヘルパーのテストで<code>current_user</code>を直接テストすれば、この制約を突破できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch <span class="nb">test</span>/helpers/sessions_helper_test.rb
</pre></div></div>
<p class="noindent">テスト手順はシンプルです。</p>
<ol>
<li>フィクスチャで<code>user</code>変数を定義する
</li>
<li>渡されたユーザーを<code>remember</code>メソッドで記憶する
</li>
<li>
<code>current_user</code>が、渡されたユーザーと同じであることを確認します。
</li>
</ol>
<p class="noindent">上の手順では<code>remember</code>メソッドでは<code>session[:user_id]</code>が設定されないので、問題の「記憶」ブランチをこれでテストできるようになります。修正の結果を<a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>に示します。</p>
<div class="codelisting" id="code-persistent_sessions_test" data-tralics-id="uid858" data-number="8.55">
<div class="heading">
<span class="number">リスト8.55:</span> 

<span class="description">永続的セッションのテスト<span class="break"></span> <span class="filepath">test/helpers/sessions_helper_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">SessionsHelperTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">remember</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns right user when session is nil"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns nil when remember digest is wrong"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_token</span><span class="p">))</span>
    <span class="n">assert_nil</span> <span class="n">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">テストをもうひとつ追加していることにご注目ください。この追加テストでは、ユーザーの記憶ダイジェストが記憶トークンと正しく対応していない場合に現在のユーザーが<code>nil</code>になるかどうかをチェックしています。これによって、以下のネストした<code>if</code>ステートメン内の<code>authenticated?</code>の式をテストします。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>ところで、<a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>では以下のように書いてもよいように思えるかもしれません。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="n">current_user</span><span class="p">,</span> <span class="vi">@user</span>
</pre></div></div>
<p class="noindent">実際、上のように書いても動作します。しかし、<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-layout_exercises"><span class="ref">5.6</span></a>で簡単に触れたように、アサーション<code>assert_equal</code>の引数は、<em>期待する値</em>、<em>実際の値</em>の順序で書くのがルールになっています。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="o">&lt;</span><span class="n">期待する値</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">実際の値</span><span class="o">&gt;</span>
</pre></div></div>
<p class="noindent">上の原則に従って、<a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>のコードは以下のように書かれています。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
</pre></div></div>
<p><a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>のコードを実行すると、今度は期待どおり<span style="color:red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid859" data-tralics-id="uid859" data-number="8.56">
<div class="heading">
<span class="number">リスト8.56:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test TEST=test/helpers/sessions_helper_test.rb
</pre></div></div>
</div>
<p>ここまでできれば、<code>current_user</code>メソッドに仕込んだ<code>raise</code>を削除して元に戻す (<a class="hyperref" href="#code-branch_no_raise">リスト<span class="ref">8.57</span></a>) ことで、<a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>のテストがパスするはずです (<a class="hyperref" href="#code-branch_no_raise">リスト<span class="ref">8.57</span></a>から<code>authenticated?</code>の式を削除すると<a class="hyperref" href="#code-persistent_sessions_test">リスト<span class="ref">8.55</span></a>の2番目のテストが失敗することも確認できます。つまりこのテストが正しいものであるということです)。</p>
<div class="codelisting" id="code-branch_no_raise" data-tralics-id="uid860" data-number="8.57">
<div class="heading">
<span class="number">リスト8.57:</span> 

<span class="description">例外発生部分を削除する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 記憶トークンcookieに対応するユーザーを返す</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">これでテストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid861" data-tralics-id="uid861" data-number="8.58">
<div class="heading">
<span class="number">リスト8.58:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent"><code>current_user</code>の「記憶」ブランチをテストできたので、今後は手動でひとつひとつ確認しなくても、自信を持って回帰バグをキャッチできます。</p>
</div>
</div>
</div><div id="cid56" class="section" data-tralics-id="cid56" data-number="8.5">
<h2><a href="#cid56" class="heading hyperref"><span class="number">8.5</span> 最後に</a></h2>
<p>この章とひとつ前の章では、実に多くの作業をこなしました。かつては未熟そのものだったアプリケーションを、約束通り、ユーザー登録機能やログイン機能を完全に備えた立派なアプリケーションへと変身させることができたのです。認証機能の完成に必要なのは、一口に言えばログインステータスとユーザーIDに基いてページへのアクセスを制限することだけです。次は、ユーザーが自分のプロフィール情報を編集できるようにする予定です。これは<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users">第<span class="ref">9</span>章</a>の最終目標でもあります。</p>
<p>次の章に進む前に、変更をmasterブランチにマージしておきましょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Finish log in/log out"
$ git checkout master
$ git merge log-in-log-out
</pre></div></div>
<p class="noindent">続いて、リモートリポジトリとproductionサーバーにもプッシュします。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push
$ git push heroku
$ heroku run rake db:migrate
</pre></div></div>
<p class="noindent">プッシュした後、マイグレーションが完了するまでの間、一時的にステータスが無効 (invalid) になりますので、ご注意ください。トラフィックの多い本番サイトでは、変更を行う前に以下のように<a href="https://devcenter.heroku.com/articles/maintenance-mode" target="_blank"><em>メンテナンスモード</em></a>をオンにしておくとよいでしょう。</p>
<div class="code"><div class="highlight"><pre>$ heroku maintenance:on
$ git push heroku
$ heroku run rake db:migrate
$ heroku maintenance:off
</pre></div></div>
<p class="noindent">上の操作でデプロイとマイグレーションを行うと、その間に標準のエラーページが出力されます (この作業で煩わされることは今後ありませんが、一度はこのエラーページを目にしておくのもよいでしょう)。詳しくは、Herokuの<a href="https://devcenter.heroku.com/articles/error-pages" target="_blank">エラーに関するページ</a> (英語) にあるドキュメントを参照してください。</p>
<div id="sec-log_in_out_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid862" data-number="8.5.1">
<h3><a href="#sec-log_in_out_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">8.5.1 </span>本章のまとめ</a></h3>
<ul>
<li>Railsでは、あるページから別のページに移動するときに状態を保持することができます。ページの状態の保存には、一時cookiesと永続cookiesのどちらも使用できます。
</li>
<li>ログインフォームは、ユーザーがログインするための新しいセッションを作成するように設計されています。
</li>
<li>
<code>flash.now</code>メソッドを使用すると、レンダリング済みのページにもフラッシュメッセージを表示できます。
</li>
<li>テスト駆動開発は、テストでバグを再現してからデバッグしたい場合に便利です。</li>
<li>
<code>session</code>メソッドを使用すると、ユーザーIDを安全にブラウザに保存して一時セッションを作成できます。
</li>
<li>ログインの状態に応じて、レイアウト上のリンクなどの機能を変更できます。
</li>
<li>統合テストでは、ルーティング、データベースの更新、レイアウトの変更が正しく行われているかどうかを確認できます。
</li>
<li>記憶トークンやそれと対応する記憶ダイジェストをユーザーごとに関連付けて、永続的セッションで使用できます。
</li>
<li>
<code>cookies</code>メソッドを使用すると、永続的な記憶トークンのcookiesをブラウザに保存して、永続的セッションを作成できます。
</li>
<li>ログイン状態 (ログインしているかどうか) は、一時セッションのユーザーIDか、永続的セッションの一意な記憶トークンに基いた現在のユーザーが存在しているかどうかで決定されます。
</li>
<li>セッションのユーザーIDを削除し、ブラウザの永続的cookiesを削除すると、アプリケーションからユーザーがログアウトします。
</li>
<li>三項演算子を使用すると、単純なif-thenステートメントをコンパクトに記述することができます。
</li>
</ul>
</div>
</div><div id="sec-log_in_out_exercises" class="section" data-tralics-id="cid57" data-number="8.6">
<h2><a href="#sec-log_in_out_exercises" class="heading hyperref"><span class="number">8.6</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で原著を購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>なお、演習とチュートリアル本編の食い違いを避ける方法については、演習用のトピックブランチに追加したメモ (<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>) を参考にしてください。</p>
<ol>
<li>
<a class="hyperref" href="#code-user_model_remember">リスト<span class="ref">8.32</span></a>では、明示的に<code>User</code>をプレフィックスとして、新しいトークンやダイジェストのクラスメソッドを定義しました。これらは問題なく動作します。これらは、実際に<code>User.new_token</code>や<code>User.digest</code>を使用して<em>呼び出される</em>ので、おそらく最も明確な定義方法であると言えるでしょう。しかし実は、より「Ruby的に正しい」クラスメソッドの定義方法が、おそらく2とおりあります。1つはややわかりにくく、もう1つは非常に混乱するでしょう。テストスイートを実行して、<a class="hyperref" href="#code-token_digest_self">リスト<span class="ref">8.59</span></a> (ややわかりにくい) や <a class="hyperref" href="#code-token_digest_class_self">リスト<span class="ref">8.60</span></a> (非常に混乱する) の実装が正しいことを確認してください。これが問題です (<code>self</code>は、通常の文脈ではUser「モデル」、つまりユーザーオブジェクトの<em>インスタンス</em>を指しますが、<a class="hyperref" href="#code-token_digest_self">リスト<span class="ref">8.59</span></a>や<a class="hyperref" href="#code-token_digest_class_self">リスト<span class="ref">8.60</span></a>の文脈では、<code>self</code>は<code>User</code>「クラス」を指すことにご注意ください。わかりにくさの原因の一部はこの点にあります)。
</li>
<li>
<a class="hyperref" href="#sec-remember_tests"><span class="ref">8.4.6</span></a>では、現在のアプリケーション設計では、<a class="hyperref" href="#code-remember_me_test">リスト<span class="ref">8.51</span></a>の統合テストで仮想の<code>remember_token</code>属性にアクセスする手段がないことを説明しました。実は、<code>assigns</code>という特殊なテストメソッドを使用するとアクセスできるようになります。コントローラで定義した<em>インスタンス</em>変数にテストの内部からアクセスするには、テスト内部で<code>assigns</code>メソッドを使用します。このメソッドにはインスタンス変数に対応するシンボルを渡します。たとえば、<code>create</code>アクションで<code>@user</code>というインスタンス変数が定義されていれば、テスト内部では<code>assigns(:user)</code>と書くことでインスタンス変数にアクセスできます。本チュートリアルのアプリケーションの場合、Sessionsコントローラの<code>create</code>アクションでは、<code>user</code>を (インスタンス変数ではない) 通常のローカル変数として定義しましたが、これをインスタンス変数に変えてしまえば、<code>cookies</code>にユーザーの記憶トークンが正しく含まれているかどうかをテストできるようになります。このアイディアに従って<a class="hyperref" href="#code-login_create_user_instance">リスト<span class="ref">8.61</span></a>と<a class="hyperref" href="#code-improved_remember_me_test">リスト<span class="ref">8.62</span></a>の不足分を埋め (ヒントとして<code>●</code>や<code>FILL_IN</code>を目印に置いてあります)、[remember me] チェックボックスのテストを改良してください。
</li>
</ol>
<div class="codelisting" id="code-token_digest_self" data-tralics-id="uid877" data-number="8.59">
<div class="heading">
<span class="number">リスト8.59:</span> 

<span class="description"><code>self</code>を使ってトークンやダイジェストの新しいメソッドを定義する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ランダムなトークンを返す</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_token</span>
</span>    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-token_digest_class_self" data-tralics-id="uid878" data-number="8.60">
<div class="heading">
<span class="number">リスト8.60:</span> 

<span class="description"><code>class &lt;&lt; self</code>を使ってトークンやダイジェストの新しいメソッドを定義する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span>    <span class="c1"># 与えられた文字列のハッシュ値を返す</span>
<span class="hll">    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>      <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
      <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># ランダムなトークンを返す</span>
<span class="hll">    <span class="k">def</span> <span class="nf">new_token</span>
</span>      <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-login_create_user_instance" data-tralics-id="uid879" data-number="8.61">
<div class="heading">
<span class="number">リスト8.61:</span> 

<span class="description"><code>create</code>アクション内のインスタンス変数を使用するためのテンプレート<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="p">●</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">●</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="p">●</span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">log_in</span> <span class="p">●</span><span class="n">user</span>
</span><span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(●</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(●</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="p">●</span><span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-improved_remember_me_test" data-tralics-id="uid880" data-number="8.62">
<div class="heading">
<span class="number">リスト8.62:</span> 

<span class="description">[remember me] テストを改良するためのテンプレート<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
<span class="hll">    <span class="n">assert_equal</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">FILL_IN</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
    <span class="n">assert_nil</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div><div id="cha-8_footnotes">
  <div class="navigation">
<a class="next_page" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="number">第9章</span> ユーザーの更新・表示・削除</a><a class="prev_page" href="sign_up?version=4.2#cha-sign_up"><span class="number">第7章</span>ユーザー登録</a>
</div>
<ol class="footnotes">
    <li id="cha-8_footnote-1">その他に、一定時間が経過するとセッションを期限切れにするモデルもあります。このモデルは、インターネットバンキングや金融取引口座などの重要な情報を扱うWebサイトに向いています。<a class="arrow" href="#cha-8_footnote-ref-1">↑</a>
</li>
    <li id="cha-8_footnote-2">ブラウザによっては、「中断した時点から再開」などのオプション機能でセッションを復旧できるものもあります。このような動作はブラウザ依存で、かつブラウザ側でしか行えないので、Railsサーバーではこうしたセッション復旧機能を実現することはできません。<a class="arrow" href="#cha-8_footnote-ref-2">↑</a>
</li>
    <li id="cha-8_footnote-3">(注: <code>form_for</code>の代わりに<code>form_tag</code>を使うこともでき、Railsではこの方が慣用的な方法です。しかし、ユーザー登録フォームではform_forを使用する方が一般的であり、並列構造を強調するためにもform_forを使用しました。<a class="arrow" href="#cha-8_footnote-ref-3">↑</a>
</li>
    <li id="cha-8_footnote-4">
<a class="hyperref" href="#code-sessions_helper_include">リスト<span class="ref">8.11</span></a>でモジュールをインクルードしているので、Sessionコントローラで<code>log_in</code>メソッドを使用できます。<a class="arrow" href="#cha-8_footnote-ref-4">↑</a>
</li>
    <li id="cha-8_footnote-5">このように、メソッド呼び出しでの変数代入を記憶して次回以降の呼び出しで使い回す手法を<a href="http://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%A2%E5%8C%96" target="_blank"><em>メモ化 (memoization)</em></a> と呼びます。memorizationのスペルミス<em>ではなく</em>、それをもじったmemoization (rがない) という造語であることにご注意ください。<a class="arrow" href="#cha-8_footnote-ref-5">↑</a>
</li>
    <li id="cha-8_footnote-6">画像は<a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/" target="_blank">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>から引用しました。<a class="arrow" href="#cha-8_footnote-ref-6">↑</a>
</li>
    <li id="cha-8_footnote-7">Webブラウザは実際には<span class="tt">DELETE</span>リクエストを発行できないので、RailsではJavaScriptを使用してこのリクエストを「偽造」します。<a class="arrow" href="#cha-8_footnote-ref-7">↑</a>
</li>
    <li id="cha-8_footnote-8">詳しくは、<a href="http://getbootstrap.com/components/" target="_blank">Bootstrapコンポーネント一覧ページ</a> (英語) を参照してください。<a class="arrow" href="#cha-8_footnote-ref-8">↑</a>
</li>
    <li id="cha-8_footnote-9">クラウドIDEをご利用の場合は、別のブラウザでログイン動作を確認することをおすすめします。そうでないと、クラウドIDEを開いているブラウザも一緒に閉じるはめになってしまいます。<a class="arrow" href="#cha-8_footnote-ref-9">↑</a>
</li>
    <li id="cha-8_footnote-10">Sessionsコントローラがあることで、Usersコントローラで<code>log_in</code>メソッドを使用できるようになります。そのために必要なモジュールは<a class="hyperref" href="#code-sessions_helper_include">リスト<span class="ref">8.11</span></a>でインクルードされています。<a class="arrow" href="#cha-8_footnote-ref-10">↑</a>
</li>
    <li id="cha-8_footnote-11">一例として、かつて筆者が作成したテストスイートでは、Sessionsヘルパーから<code>log_in</code>メソッドをうっかり削除してしまったにもかかわらず、テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>のまま変わらなかったことがありました。原因は、テストで使用していたテストヘルパーメソッドの名前が、うかつにもSessionsヘルパーメソッド名と同じだったことです。そのため、アプリケーションが壊れていてもテストがパスしてしまいました。テストヘルパーメソッド名を、Sessionヘルパーメソッド名<code>log_in_as</code> (<a class="hyperref" href="#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>) とは異なる<code>is_logged_in?</code>で定義することで、この問題を回避できます。<a class="arrow" href="#cha-8_footnote-ref-11">↑</a>
</li>
    <li id="cha-8_footnote-12">ブラウザによっては、「<a href="http://stackoverflow.com/questions/20449641/rails-4-session-value-never-expires-or-dies-when-browser-closes" target="_blank">ログイン状態を保存する</a>」などでセッションを自動復元する機能がサポートされていることがあります。この機能は開発の邪魔になるので、ログアウトする前にこの機能を必ずオフにしておいてください。<a class="arrow" href="#cha-8_footnote-ref-12">↑</a>
</li>
    <li id="cha-8_footnote-13">インスタンス変数<code>@current_user</code>を<code>nil</code>にする必要があるのは、<code>@current_user</code>が<code>destroy</code>アクションより前に作成され (作成されていない場合)、<em>かつ</em>、リダイレクトを直接発行しなかった場合だけです。今回はリダイレクトを直接発行しているので、不要です。現実にこのような条件が発生する可能性はかなり低く、このアプリケーションでもこのような条件を作り出さないように開発しているので、本来はnilに設定する必要はないのですが、ここではセキュリティ上の死角を万が一にでも作り出さないためにあえてnilに設定しています。<a class="arrow" href="#cha-8_footnote-ref-13">↑</a>
</li>
    <li id="cha-8_footnote-14">セッションハイジャックは、セキュリティ上の注意を呼びかけるためにこれを実演する<a href="http://codebutler.com/firesheep" target="_blank">Firesheep</a>アプリケーションによって広く知られるようになりました。Firesheepを使用すると、公共Wi-Fiネットワーク経由で接続したときに多くの有名Webサイトの記憶トークンが丸見えになっていることがわかります。<a class="arrow" href="#cha-8_footnote-ref-14">↑</a>
</li>
    <li id="cha-8_footnote-15">このメソッドは、RailsCastの「<a href="http://railscasts.com/episodes/274-remember-me-reset-password" target="_blank">remember me</a>」の記事を元に選びました。<a class="arrow" href="#cha-8_footnote-ref-15">↑</a>
</li>
    <li id="cha-8_footnote-16">実際、これでもOKなのです。bcryptの<a href="https://ja.wikipedia.org/wiki/Salt_%28cryptography%29" target="_blank">ハッシュはソルト化されている</a>ので、2人のユーザーのパスワードが本当に一致するのかどうかはハッシュからは絶対わかりません。(訳注: 「ソルト」とは、暗号を強化するために加えられる任意の短い文字列です。念には念を入れて「塩ひとつまみ」を加えるというイメージであり、英語の「take it with a grain of salt」=半分疑ってかかるという言い回しが語源です)<a class="arrow" href="#cha-8_footnote-ref-16">↑</a>
</li>
    <li id="cha-8_footnote-17">記憶トークンが一意に保たれることで、攻撃者はユーザーIDと記憶トークンを<em>両方とも</em>奪い取ることに成功しない限りセッションをハイジャックできなくなります。<a class="arrow" href="#cha-8_footnote-ref-17">↑</a>
</li>
    <li id="cha-8_footnote-18">一般に、あるメソッドがオブジェクトのインスタンスを必要としていない場合は、クラスメソッドにするのが常道です。<a class="hyperref" href="account_activation_password_reset?version=4.2#sec-account_activation_mailer"><span class="ref">10.1.2</span></a>では、実際にこの決定が重要になってきます。<a class="arrow" href="#cha-8_footnote-ref-18">↑</a>
</li>
    <li id="cha-8_footnote-19">
<a class="hyperref" href="modeling_users?version=4.2#sec-a_hashed_password"><span class="ref">6.3.1</span></a>で解説したように、「暗号化されていないパスワード (unencrypted password)」という呼び方は正しくありません。ここで言うセキュアなパスワードとは、単に<em>ハッシュ化した</em>という意味であり、本格的な暗号化は行われていないからです。<a class="arrow" href="#cha-8_footnote-ref-19">↑</a>
</li>
    <li id="cha-8_footnote-20">筆者はこのような場合、代入式全体をかっこで囲むようにしています。これが比較でないことを思い出せるようにするためです。<a class="arrow" href="#cha-8_footnote-ref-20">↑</a>
</li>
    <li id="cha-8_footnote-21">システムでのcookiesの調べ方については、「&lt;ブラウザ名&gt; inspect cookies」でググってください。<a class="arrow" href="#cha-8_footnote-ref-21">↑</a>
</li>
    <li id="cha-8_footnote-22">読者のPaulo Célio Júniorからのご指摘でした。ありがとうございました。<a class="arrow" href="#cha-8_footnote-ref-22">↑</a>
</li>
    <li id="cha-8_footnote-23">読者のNiels de Ronからのご指摘でした。ありがとうございます。<a class="arrow" href="#cha-8_footnote-ref-23">↑</a>
</li>
    <li id="cha-8_footnote-24">ユーザーがこのチェックボックスをオフすると、すべてのコンピュータ上のすべてのブラウザからログアウトしますので、注意が必要です。ブラウザごとにユーザーのログインセッションを記憶する設計に変更すれば、ユーザーにとってもう少し便利にはなりますが、その分セキュリティが低下するうえ、実装も面倒になります。やる気の余っている方は実装してみてもよいでしょう。<a class="arrow" href="#cha-8_footnote-ref-24">↑</a>
</li>
    <li id="cha-8_footnote-25">以前は<code>remember user</code>をかっこなしで書きましたが、三項演算子ではかっこを省略すると文法エラーになります。<a class="arrow" href="#cha-8_footnote-ref-25">↑</a>
</li>
  </ol>
</div>
          </div>


  </body>
</html>
