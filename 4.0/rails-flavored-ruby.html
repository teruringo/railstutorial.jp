<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
<div id="book">
            




            
            
            <div id="cha-rails_flavored_ruby" class="chapter" data-tralics-id="cid23" data-number="4" data-chapter="rails_flavored_ruby">
<h1><a href="#cha-rails_flavored_ruby" class="heading hyperref"><span class="number">第4章</span> Rails風味のRuby</a></h1>
<p>この章では、<a class="hyperref" href="static_pages?version=4.2#cha-static_pages"><span class="ref">第3章</span></a>で使用した例を基に、Railsにおいて重要となるRubyのさまざまな要素について探っていくことにしましょう。Rubyは巨大な仕様を持つ言語ですが、幸い、Rails開発者にとって必要な知識は比較的少なくて済みます。また、一般のRuby入門書で扱っている内容とも多少異なっています。この章の目的は、「Rails風味のRuby」というものについての確固たる基盤を、皆さんのこれまでの言語経験に関わらず提供することです。この章には多くの話題が盛り込まれていますが、一度読んだだけで理解する必要はまったくありません。今後もこの章には頻繁に立ち戻って参照します。</p>
</div><div id="sec-motivation" class="section" data-tralics-id="cid24" data-number="4.1">
<h2><a href="#sec-motivation" class="heading hyperref"><span class="number">4.1 </span>動機</a></h2>
<p>前章でお見せしたとおり、Rubyの基礎知識がまったくない状態であったにもかかわらずRailsアプリケーションの骨組みを作り上げ、さらにテストまで行うことができました。このときは、本書が提供するテストコードと、テストスイートがパスするまでエラーメッセージの修正を繰り返すという方法だけを頼りに作業を進めました。しかしこのような初歩的な作業をいつまでも続けるわけにはいきませんので、今の私たちのRubyに関する知識と経験の限界に真正面から挑み、これを乗り越えるためにこの章を割り当てることにします。</p>
<p>前章の終わりでは、Railsのレイアウトを使用してビューでの重複を取り除くために、ほぼ静的なページを単に更新したにとどまりました (<a class="hyperref" href="#code-application_layout_redux"><span class="ref">リスト4.1</span></a>)。これは、<a class="hyperref" href="static_pages?version=4.2#code-application_layout"><span class="ref">リスト3.32</span></a>と同じものです。</p>
<div class="codelisting" id="code-application_layout_redux" data-tralics-id="uid338" data-number="4.1">
<div class="heading">
<span class="number">リスト4.1:</span> 

<span class="description">サンプルアプリケーションのWebサイトのレイアウト<span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                              <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-application_layout_redux"><span class="ref">リスト4.1</span></a>の以下の行にご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                       <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">ここでは、Railsの組み込み関数<code>stylesheet_link_tag</code> (詳細は<a href="http://www.google.com/url?q=http%3A%2F%2Fapi.rubyonrails.org%2Fclasses%2FActionView%2FHelpers%2FAssetTagHelper.html%23method-i-stylesheet_link_tag&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFdsiJc5GuynSli2H1XQn31qg_ZGw">Rails API</a>を参照) を使用して、<code>application.css</code>をすべての<a href="http://www.google.com/url?q=http%3A%2F%2Fwww.w3.org%2FTR%2FCSS2%2Fmedia.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNG8Vz9CAt220zozgRU67kOB6qkxzw">メディアタイプ</a>にインクルードしています (メディアタイプには、コンピュータの画面や印刷画面なども含まれます)。Rails開発経験者にとってこの行は実にシンプルですが、しかしここには少なくとも混乱を生じる可能性のあるRubyの概念が4つあります。Railsの組み込み関数、かっこを使わない関数呼び出し、シンボル、そしてハッシュです。これらの概念についてはこの章ですべて説明します。</p>
<p>Railsのビューでは膨大な組み込み関数を使用することができますが、それに加えて新しい関数を作成することもできます。この関数は<em>ヘルパー</em>と呼ばれます。カスタムヘルパーを作成する方法を学ぶために、まず<a class="hyperref" href="#code-application_layout_redux"><span class="ref">リスト4.1</span></a>のタイトル行の部分に注目しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App
</pre></div></div>
<p class="noindent">上の行は、ページタイトルの定義に依存しています。ページタイトルは、以下のようにビューで<code>provide</code>を使用して定義しています。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Home"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
<p class="noindent">このとき、もしタイトルをまったく与えていなければ、タイトルが空欄になってしまいます。これを防ぐには、すべてのページで使用する<em>基本タイトル</em>を定め、特定のページでは異なるタイトルに変更できるようなオプションを与えるのが常套手段です。これは現在のレイアウトでも、<em>ある点を除いて</em>達成されています。もしビューの1つから<code>provide</code>呼び出しを削除すると、そのページ固有のタイトルの代わりに以下のタイトルが表示されます。</p>
<div class="code"><div class="highlight"><pre> | Ruby on Rails Tutorial Sample App
</pre></div></div>
<p class="noindent">基本タイトルとしてはこれで正しいのですが、先頭に余分な縦棒 <code>|</code> が残ってしまっています。</p>
<p>ページタイトルが正しく表示されない問題を解決するために、<code>full_title</code>というヘルパーを作成することにします。<code>full_title</code>ヘルパーは、ページタイトルが定義されていない場合は基本タイトル「Ruby on Rails Tutorial Sample App」を返し、定義されている場合は基本タイトルに縦棒と追加ページタイトルを追加して返します (<a class="hyperref" href="#code-title_helper"><span class="ref">リスト4.2</span></a>)<sup class="footnote" id="cha-4_footnote-ref-1"><a href="#cha-4_footnote-1">1</a></sup>。</p>
<div class="codelisting" id="code-title_helper" data-tralics-id="uid340" data-number="4.2">
<div class="heading">
<span class="number">リスト4.2:</span> 

<span class="description"><code>full_title</code>ヘルパーを定義する<span class="break"></span> <span class="filepath">app/helpers/application_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページごとの完全なタイトルを返す</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="n">page_title</span> <span class="o">+</span> <span class="s2">" | "</span> <span class="o">+</span> <span class="n">base_title</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>ヘルパーを作成したので、これを使用してレイアウトをシンプルにすることができます。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span> | Ruby on Rails Tutorial Sample App<span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p class="noindent">上のコードを以下に置き換えます。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p class="noindent">置き換えた結果を<a class="hyperref" href="#code-application_layout_full_title"><span class="ref">リスト4.3</span></a>に示します。</p>
<div class="codelisting" id="code-application_layout_full_title" data-tralics-id="uid341" data-number="4.3">
<div class="heading">
<span class="number">リスト4.3:</span> 

<span class="description"><code>full_title</code>ヘルパーを使ったWebサイトのレイアウト<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
<span class="hll">    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</span>    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                              <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p>このヘルパーを定義することで、Homeページにこれまで表示されていた余分な「Home」という単語を表示せず、基本タイトルのみを正しく表示することもできるようになります。これを行うには、まず<a class="hyperref" href="#code-home_base_title_spec"><span class="ref">リスト4.4</span></a>に示すように以前のテストコードを更新し、<code>"Home"</code> という文字が表示されていないことを確認するテストを追加します。</p>
<div class="codelisting" id="code-home_base_title_spec" data-tralics-id="uid342" data-number="4.4">
<div class="heading">
<span class="number">リスト4.4:</span> 

<span class="description"> Homeページのタイトル確認用にテストを更新する <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/static_pages_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">StaticPagesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:home</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get help"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:help</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Help | Ruby on Rails Tutorial Sample App"</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get about"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:about</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
    <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"About | Ruby on Rails Tutorial Sample App"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>ここでテストスイートを実行して、テストが失敗することを確認します。</p>
<div class="codelisting" id="uid343" data-tralics-id="uid343" data-number="4.5">
<div class="heading">
<span class="number">リスト4.5:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
3 tests, 6 assertions, 1 failures, 0 errors, 0 skips
</pre></div></div>
</div>
<p>テストがパスするためには、<a class="hyperref" href="#code-home_page_base_title"><span class="ref">リスト4.6</span></a>のようにHomeページのビューから<code>provide</code>の行を削除する必要があります。</p>
<div class="codelisting" id="code-home_page_base_title" data-tralics-id="uid344" data-number="4.6">
<div class="heading">
<span class="number">リスト4.6:</span> 

<span class="description">ページタイトルをカスタマイズせずに表示するHomeページ <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://www.railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p class="noindent">この時点で、テストはパスするはずです。</p>
<div class="codelisting" id="uid345" data-tralics-id="uid345" data-number="4.7">
<div class="heading">
<span class="number">リスト4.7:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent"><em>注意</em>: これまでは<code>rake test</code>を実行した結果の一部 (成功結果や失敗結果など) も載せていましたが、紙幅の関係から、今後は実行結果を省略します。</p>
<p>Rails開発経験者にとっては、<a class="hyperref" href="#code-title_helper"><span class="ref">リスト4.2</span></a>のコードはスタイルシートをインクルードするのと大差ない単純なものですが、ここにもRubyの重要な概念が<em>多数</em>含まれています。モジュール、メソッド定義、任意のメソッド引数、コメント、ローカル変数の割り当て、論理値 (boolean)、制御フロー、文字列の結合、そして戻り値です。これらの概念についても、この章ですべて説明します。</p>
</div><div id="sec-strings_and_methods" class="section" data-tralics-id="cid25" data-number="4.2">
<h2><a href="#sec-strings_and_methods" class="heading hyperref"><span class="number">4.2</span> 文字列(string)とメソッド</a></h2>
<p>Ruby を学ぶためのツールとして、主に<em>Railsコンソール</em>を使用することにします。これは<a class="hyperref" href="toy_app?version=4.2#sec-demo_user_has_many_microposts"><span class="ref">2.3.3</span></a>でも登場した、Railsアプリケーションを対話的に操作するためのコマンドラインツールです。コンソールはインタラクティブRuby (<code>irb</code>) 上に構築されているため、Rubyの機能をすべて使うことができます(<a class="hyperref" href="#sec-a_controller_class"><span class="ref">4.4.4</span></a>でも説明しますが、コンソールからRails環境にアクセスすることもできます)。</p>
<p>クラウドIDEをご利用の場合は、オススメのirbの設定があります。シンプルなテキストエディタ「<code>nano</code>」を使って、ホームディレクトリに「 <code>.irbrc</code>」ファイルを作ってみましょう (<a class="hyperref" href="#code-irbrc">リスト<span class="ref">4.8</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> nano ~/.irbrc
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-irbrc">リスト<span class="ref">4.8</span></a>の設定を使用すると、irbのプロンプトがより簡潔な表示に置き換えられ、irbの邪魔な自動インデント機能がオフになります。</p>
<div class="codelisting" id="code-irbrc" data-tralics-id="uid346" data-number="4.8">
<div class="heading">
<span class="number">リスト4.8:</span> 

<span class="description">irbの設定ファイルを追加する<span class="break"></span> <span class="filepath">~/.irbrc</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">IRB</span><span class="o">.</span><span class="n">conf</span><span class="o">[</span><span class="ss">:PROMPT_MODE</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:SIMPLE</span>
<span class="no">IRB</span><span class="o">.</span><span class="n">conf</span><span class="o">[</span><span class="ss">:AUTO_INDENT_MODE</span><span class="o">]</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div></div>
</div>
<p>上の設定はあくまでオススメなので、<a class="hyperref" href="#code-irbrc">リスト<span class="ref">4.8</span></a>を追加しなくても、以下のようにRailsコンソールを開始できます。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment</span>
<span class="go">&gt;&gt;</span>
</pre></div></div>
<p class="noindent">デフォルトでは、コンソールは<em>development (開発) 環境</em>という、Railsによって定義された3種類の環境のうちの1つで起動します (他の2つは<em>test (テスト) 環境</em>と<em>production (本番) 環境</em>です)。この区別はこの章においては重要ではありませんが、<a class="hyperref" href="sign_up?version=4.2#sec-rails_environments"><span class="ref">7.1.1</span></a>でこれらの環境について詳細に説明します。</p>
<p>Railsコンソールは素晴しい学習ツールであり、その中を自由に探索できます。コンソールの中で何をしようとも、何かを壊すことは (まず) ありえないので、ご安心ください。Railsコンソールでは、スタックから抜けるにはCtrl-Cを押し、完全にコンソールを終了するにはCtrl-Dを押します。以後この章を進めるにあたり、有用なリソースである<a href="http://www.google.com/url?q=http%3A%2F%2Fruby-doc.org%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGnVAlIQc-wMc2YwAY36qylxKuiHQ">Ruby API</a>を参照しながら学習することをぜひお勧めします。Ruby APIには高濃縮の情報が詰まっています (少々<em>濃厚すぎる</em>とも言えます)。たとえば、Rubyの文字列の詳細を知りたい場合は、Ruby APIエントリの<code>String</code>クラスを参照すればよいのです。</p>
<div id="sec-comments" class="subsection" data-tralics-id="uid347" data-number="4.2.1">
<h3><a href="#sec-comments" class="heading hyperref"><span class="number">4.2.1</span> コメント</a></h3>
<p>Rubyの<em>コメント</em>はナンバー記号<code>#</code> (「ハッシュマーク」や「オクトソープ」とも呼ばれます) から始まり、行の終わりまでコメントとして扱われます。Rubyはコメントの内容を実行することはありませんが、適切なコメントはそれを読む人間にとって (コードの作者にとっても) 非常に有用です。以下のコードの場合、</p>
<div class="code"><div class="highlight"><pre><span class="c1"># ページごとの完全なタイトルを返す</span>
<span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">最初の行が、その後に定義されている関数の目的を説明しているコメントです。</p>
<p>コメントをコンソール内で入力する人は普通いませんが、ここでは学習のためにあえて以下のようにコメントを追加してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="mi">17</span> <span class="o">+</span> <span class="mi">42</span>   <span class="c1"># 数の加算</span>
<span class="go">=&gt; 59</span>
</pre></div></div>
<p class="noindent">この章のコードを (ファイルに保存するのでなく) Railsコンソールに入力したりコピペしたりするときであれば、コメントを省略してもかまいません。コメントをRailsコンソールに入力しても、コメントは常に無視されるので問題ありません。</p>
</div>
<div id="sec-strings" class="subsection" data-tralics-id="uid348" data-number="4.2.2">
<h3><a href="#sec-strings" class="heading hyperref"><span class="number">4.2.2</span> 文字列</a></h3>
<p><em>文字列 (string)</em> は、Webアプリケーションにおいておそらく最も重要なデータ構造です。これは、Webページというものが究極的にはサーバーからブラウザに送信された文字列にすぎないためです。それでは、コンソールで文字列について調べてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span>         <span class="c1"># 空の文字列</span>
<span class="go">=&gt; ""</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foo"</span>      <span class="c1"># 空ではない文字列</span>
<span class="go">=&gt; "foo"</span>
</pre></div></div>
<p class="noindent">ここで入力したものは<em>文字列リテラル</em>と呼ばれ (面白いことに<em>リテラル文字列</em>とも呼ばれます)、ダブルクォート<code>"</code> で囲むことで作成できます。このコンソールは、入力したそれぞれの行を評価した結果を表示しており、文字列リテラルの場合には文字列自身が表示されます。</p>
<p><code>+</code> 演算子を使用して、文字列を結合することもできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foo"</span> <span class="o">+</span> <span class="s2">"bar"</span>    <span class="c1"># 文字列の結合</span>
<span class="go">=&gt; "foobar"</span>
</pre></div></div>
<p class="noindent">評価の結果は、<code>"foo"</code> と <code>"bar"</code> を足した<code>"foobar"</code>になりました<sup class="footnote" id="cha-4_footnote-ref-2"><a href="#cha-4_footnote-2">2</a></sup>。</p>
<p>文字列を組み立てる他の方法として<em>式展開 (interpolation)</em> というものがあり、<code>#{}</code>という特殊な構文を使用します<sup class="footnote" id="cha-4_footnote-ref-3"><a href="#cha-4_footnote-3">3</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>    <span class="c1"># 変数の代入</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> Hartl"</span>     <span class="c1"># 文字列の式展開</span>
<span class="go">=&gt; "Michael Hartl"</span>
</pre></div></div>
<p class="noindent">ここでは、<code>"Michael"</code> という値を<code>first_name</code>変数に<em>割り当て</em>ると、この変数が <code>"#{first_name} Hartl"</code> という文字列の中で式展開されます。苗字と名前の両方を変数に割り当てることもできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">"Hartl"</span>
<span class="go">=&gt; "Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">last_name</span>    <span class="c1"># 間に空白を入れた結合</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">"</span>    <span class="c1"># 式展開を使った結合 (上と等価)</span>
<span class="go">=&gt; "Michael Hartl"</span>
</pre></div></div>
<p class="noindent">最後の2つの結果は同等であることにご注目ください。なお、著者は後者の式展開の方が好みです。空白を<code>"&nbsp;"</code>のように直接加えるのはどうもぎこちなく思えます。</p>
<div id="sec-printing" class="subsubsection" data-tralics-id="uid351" data-number="4.2.2.1">
<h4><a href="#sec-printing" class="heading">出力</a></h4>
<p>文字列を<em>出力</em>するために、Rubyの関数で最も一般に使われるのは<code>puts</code>です (putの三人称単数現在形ではなく「put string」なので、「put ess」と発音します)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"foo"</span>     <span class="c1"># 文字列の画面出力</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p class="noindent"><code>puts</code>メソッドでは<em>副作用</em>が重要な役割を果たします。どういうことかと言うと、<code>puts "foo"</code>は文字列「"foo"」を副作用としてスクリーンに表示しますが、返り値には「<a href="http://www.answers.com/nil" target="_blank">文字どおりの無</a>」である<code>nil</code>を返します。nilは「何にもない」ことを表すRubyの特別な値です。なお、<code>=&gt; nil</code> という結果は、簡素化のために今後省略することがあります。</p>
<p>上の例からも分かるように、<code>puts</code>を使用して出力すると、改行文字である<span class="inline_verbatim">\n</span>が自動的に出力の末尾に追加されます。<code>print</code>メソッドも同様の出力を行いますが、以下のように、改行文字を追加しない点が異なります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">"foo"</span>    <span class="c1"># 文字列の画面出力 (putsと同じだが改行がない)</span>
<span class="go">foo=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">"foo</span><span class="se">\n</span><span class="s2">"</span>  <span class="c1"># puts "foo" と等価</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
</div>
<div id="sec-single_quoted_strings" class="subsubsection" data-tralics-id="uid352" data-number="4.2.2.2">
<h4><a href="#sec-single_quoted_strings" class="heading">シングルクォート内の文字列</a></h4>
<p>これまでの例ではすべて<em>ダブルクォート文字列</em>を使用していましたが、Rubyでは<em>シングルクォート</em>もサポートしています。ほとんどの場合、ダブルクォートとシングルクォートのどちらを使用しても実質的に同じです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'foo'</span>          <span class="c1"># シングルクォートで囲んだ文字列</span>
<span class="go">=&gt; "foo"</span>
<span class="gp">&gt;&gt; </span><span class="s1">'foo'</span> <span class="o">+</span> <span class="s1">'bar'</span>
<span class="go">=&gt; "foobar"</span>
</pre></div></div>
<p>ただし、1つ重要な違いがあります。Rubyはシングルクォート文字列の中では式展開を行いません。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'#{foo} bar'</span>     <span class="c1"># シングルクォートで囲まれた文字列では式展開されない</span>
<span class="go">=&gt; "\#{foo} bar"</span>
</pre></div></div>
<p class="noindent">逆に言えば、ダブルクォート文字列を用いた文字列で<code>#</code>のような特殊な文字を使用する場合は、この文字をバックスラッシュで<em>エスケープ</em>する必要があります。</p>
<p>ダブルクォート文字列でもシングルクォート文字列と同じことができ、ダブルクォート文字列では式展開もできるのであれば、シングルクォート文字列にはどのような使い道があるのでしょうか。シングルクォートは、入力した文字をエスケープせずに「そのまま」保持するときに便利です。たとえば、いわゆる「バックスラッシュ」文字は、改行文字<span class="inline_verbatim">\n</span>と同様多くのシステム上で特殊な文字として扱われます。シングルクォートで文字列を囲めば、簡単にバックスラッシュ文字のような特殊文字をそのまま変数に含めることができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'\n'</span>       <span class="c1"># 'バックスラッシュ n' をそのまま扱う</span>
<span class="go">=&gt; "\\n"</span>
</pre></div></div>
<p class="noindent">前述の<code>#</code>文字と同様、Rubyでバックスラッシュそのものをエスケープする場合は、バックスラッシュがもう1つ必要です。ダブルクォート文字列の中では、バックスラッシュ文字そのものは<em>2つ</em>のバックスラッシュによって表されます。このような些細な例の場合はそれほど問題になりませんが、以下のようにエスケープの必要な文字が大量にある場合には、シングルクォートは非常に便利です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'Newlines (\n) and tabs (\t) both use the backslash character \.'</span>
<span class="go">=&gt; "Newlines (\\n) and tabs (\\t) both use the backslash character \\."</span>
</pre></div></div>
<p>最後にもう一度申し上げます。ほとんどの場合、シングルクォートとダブルクォートのどちらを使おうと大きな違いはありません。実際、一般のソースコードでは、明確な理由もなく両者が混用されているケースをよく見かけます。以上でRubyの文字列に関する説明は終わりです。あ、言い忘れていたことがありましたね。「Rubyの世界へようこそ!」</p>
</div>
</div>
<div id="sec-objects_and_message_passing" class="subsection" data-tralics-id="uid353" data-number="4.2.3">
<h3><a href="#sec-objects_and_message_passing" class="heading hyperref"><span class="number">4.2.3</span> オブジェクトとメッセージ受け渡し</a></h3>
<p>Rubyでは、あらゆるものが<code>オブジェクト</code>です。文字列や<em>nil</em>ですらオブジェクトです。このことの技術的な意味は<a class="hyperref" href="#sec-a_class_of_our_own"><span class="ref">4.4.2</span></a>で説明しますが、オブジェクトについてのこのような定義は、本で読んだだけではわかりません。さまざまなオブジェクトの例に触れることで、オブジェクトとは何であるかという直感を時間をかけて養う必要があります。</p>
<p>逆に、オブジェクトが何を<em>する</em>かを説明するのは簡単です。オブジェクトとは (いついかなる場合にも) メッセージに応答するものです。文字列のようなオブジェクトは、たとえば<code>length</code>というメッセージに応答できますが、これは文字列の文字数を返します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">length</span>        <span class="c1"># 文字列に "length" というメッセージを送る</span>
<span class="go">=&gt; 6</span>
</pre></div></div>
<p class="noindent">オブジェクトに渡すメッセージは、一般には<em>メソッド</em>と呼ばれます。メソッドの実体は、そのオブジェクトに定義された関数です<sup class="footnote" id="cha-4_footnote-ref-4"><a href="#cha-4_footnote-4">4</a></sup>。文字列は<code>empty?</code>メソッドにも応答できます。 </p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent"><code>empty?</code>メソッドの末尾にある疑問符にご注目ください。Rubyでは、メソッドが<code>true</code>または<code>false</code>という<em>論理値(boolean)</em>を返すことを末尾の疑問符で示す慣習があります。論理値は、特に<em>処理の流れを変更する</em>ときに有用です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">"foobar"</span>
<span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string is empty"</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string is nonempty"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; "The string is nonempty"</span>
</pre></div></div>
<p class="noindent">条件文を2つ以上含めたい場合は、<code>elsif</code> (<code>else</code> + <code>if</code>) という文を使います。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">nil?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The variable is nil"</span>
<span class="gp">&gt;&gt; </span><span class="k">elsif</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string is empty"</span>
<span class="gp">&gt;&gt; </span><span class="k">elsif</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string includes 'foo'"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; "The string includes 'foo'"</span>
</pre></div></div>
<p class="noindent">論理値は、<code>&amp;&amp;</code>、<code>||</code>、<code>!</code>演算子によって結合することもできます。それぞれ「and」「or」「not」という予約語で書くこともできます (訳注: Rubyでは、後者のandとorは、前者の&amp;&amp;と||演算子より処理の優先順位が低くなっています)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s2">"foo"</span>
<span class="go">=&gt; "foo"</span>
<span class="gp">&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="s2">""</span>
<span class="go">=&gt; ""</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"Both strings are empty"</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"One of the strings is empty"</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">"One of the strings is empty"</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"x is not empty"</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">"x is not empty"</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>Rubyでは、あらゆるものがオブジェクトです。従って、<code>nil</code>もオブジェクトであり、これも多くのメソッドに応答できます。ほぼあらゆるオブジェクトを文字列に変換する<code>to_s</code>メソッドを使用して、nilがメソッドに応答する例をお目にかけましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span>
<span class="go">=&gt; ""</span>
</pre></div></div>
<p class="noindent">確かに空文字列が出力されました。今度は<code>nil</code>に対してメッセージを<em>連鎖 (chain)</em> して渡せることを確認します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">NoMethodError: undefined method `empty?' for nil:NilClass</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>      <span class="c1"># メッセージを連鎖させる</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">このように、<code>nil</code>オブジェクト自身は<code>empty?</code>メソッドには応答しないにもかかわらず、<code>nil.to_s</code>とすると応答することがわかります。</p>
<p>皆さんのご推察どおり、実は<code>nil</code>かどうかを調べるメソッドもあります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foo"</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>ところで、以下のコードは</p>
<div class="code"><div class="highlight"><pre><span class="nb">puts</span> <span class="s2">"x is not empty"</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
</pre></div></div>
<p class="noindent"><code>if</code>キーワードの別の使い方を示しています。Rubyではこのように、後続する<code>if</code>での条件式が真のときにだけ実行される式 (後続if) を書くことができ、コードが非常に簡潔になります。なお、<code>unless</code>キーワードも同様に使用できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">string</span> <span class="o">=</span> <span class="s2">"foobar"</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"The string '</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">' is nonempty."</span> <span class="k">unless</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">The string 'foobar' is nonempty.</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>Rubyにおいて<code>nil</code>は特別なオブジェクトです。Rubyのオブジェクトのうち、オブジェクトそのものの論理値がfalseになるのは、<code>false</code>自身とnilの2つ<em>しかありません</em>。なお、「<code>!!</code>」(「バンバン (bang bang)」と読みます) という演算子を使うと、そのオブジェクトを2回否定することになるので、どんなオブジェクトも強制的に論理値に変換できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">!!</span><span class="kp">nil</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p class="noindent">その他のあらゆるRubyのオブジェクトは、ゼロですら<em>true</em>です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">!!</span><span class="mi">0</span>
<span class="go">=&gt; true</span>
</pre></div></div>
</div>
<div id="sec-method_definitions" class="subsection" data-tralics-id="uid355" data-number="4.2.4">
<h3><a href="#sec-method_definitions" class="heading hyperref"><span class="number">4.2.4</span> メソッドの定義</a></h3>
<p>Railsコンソールでも、<a class="hyperref" href="static_pages?version=4.2#code-static_pages_controller"><span class="ref">リスト3.6</span></a>の<code>home</code>アクションや、<a class="hyperref" href="#code-title_helper"><span class="ref">リスト4.2</span></a>の<code>full_title</code>ヘルパーと同じ方法でメソッドを定義することができます (メソッドの定義はファイルで行うのが普通なので、コンソールで行うのは少々面倒ですが、デモンストーレション目的であれば十分です)。たとえば、<em>引数</em>を1つ取り、引数が空かどうかに基づいたメッセージを返す<code>string_message</code>という関数を定義してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">str</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">str</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"It's an empty string!"</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; :string_message</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="go">It's an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span>
<span class="go">It's an empty string!</span>
</pre></div></div>
<p class="noindent">最後の例を見ると分かるように、メソッドの引数を省略することも可能です (かっこですら省略可能です)。これは、以下のコードでは</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">str</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">引数に<em>デフォルト</em>値を含めているからです (この例のデフォルト値は空の文字列です)。このように指定すると、<code>str</code>変数に引数を渡すことも渡さないこともできます。引数を渡さない場合は、指定のデフォルト値が自動的に使用されます。</p>
<p>ここで、Rubyの関数には「<em>暗黙の戻り値</em>がある」ことにご注意ください。これは、関数内で最後に評価された式の値が自動的に返されることを意味します (訳注: 関数で戻り値を明示的に指定しなかった場合の動作です)。この場合、引数の<code>str</code>が空かどうかに応じて、2つのメッセージ文字列のうちのいずれかを返します。もちろん、Rubyでは戻り値を明示的に指定することもできます。以下の関数は上の関数と同じ結果を返します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">str</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">"It's an empty string!"</span> <span class="k">if</span> <span class="n">str</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
</pre></div></div>
<p class="noindent">上の説明で気付いた方もいると思いますが、2番目の<code>return</code>は実はなくてもかまいません。関数中の最後に置かれた式 (この場合は <code>"The string is nonempty."</code>) は、<code>return</code>キーワードがなくても暗黙で値を返すためです。ここでは、両方に<code>return</code>を使用する方が見た目の対称性が保たれるので好ましいと言えます。</p>
<p>メソッドで引数の変数名にどんな名前を使っても、メソッドの呼び出し側には何の影響も生じないという点にもご注目ください。つまり、最初の例の<code>str</code>を別の変数名 (<code>the_function_argument</code>など) に変更しても、メソッドの呼び出し方は全く同じです。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">the_function_argument</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">the_function_argument</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"It's an empty string!"</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="go">It's an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div></div>
</div>
<div id="sec-back_to_the_title_helper" class="subsection" data-tralics-id="uid356" data-number="4.2.5">
<h3><a href="#sec-back_to_the_title_helper" class="heading hyperref"><span class="number">4.2.5</span> title ヘルパー、再び</a></h3>
<p>これで、<code>full_title</code>ヘルパー (<a class="hyperref" href="#code-title_helper">リスト<span class="ref">4.2</span></a>) のコードを理解するための準備が整いました<sup class="footnote" id="cha-4_footnote-ref-5"><a href="#cha-4_footnote-5">5</a></sup>。コメントを使って、各行の振る舞いに注釈を加えてみました (<a class="hyperref" href="#code-annotated_title_helper">リスト<span class="ref">4.9</span></a>)。</p>
<div class="codelisting" id="code-annotated_title_helper" data-tralics-id="uid358" data-number="4.9">
<div class="heading">
<span class="number">リスト4.9:</span> 

<span class="description">注釈付きの<code>title_helper</code>. <span class="break"></span> <span class="filepath">app/helpers/application_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページ毎に完全なタイトルを返す         # ドキュメントとしてのコメント</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span>                     <span class="c1"># メソッド定義とオプション引数</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>  <span class="c1"># 変数の代入</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>                              <span class="c1"># 論理値でテスト</span>
      <span class="n">base_title</span>                                      <span class="c1"># 暗黙的な返り値</span>
    <span class="k">else</span>
      <span class="n">page_title</span> <span class="o">+</span> <span class="s2">" | "</span> <span class="o">+</span> <span class="n">base_title</span>                 <span class="c1"># 文字列の結合</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>Webサイトのレイアウトで使用するコンパクトなヘルパーメソッドでは、関数定義、変数割り当て、論理評価、制御フロー、文字列の式展開<sup class="footnote" id="cha-4_footnote-ref-6"><a href="#cha-4_footnote-6">6</a></sup>など、Rubyのさまざまな要素が投入されています。最後に、<code>module ApplicationHelper</code>という要素について解説します。モジュールは、関連したメソッドをまとめる方法のひとつで、Rubyのクラスで<code>include</code>を使用すると、このモジュールを<em>ミックスイン (mixed in)</em>できます。単なるRubyのコードを書くのであれば、モジュールを作成するたびに明示的にインクルードして使用するのが普通ですが、Railsでは自動的にヘルパーモジュールをインクルードしてくれるので、include行をわざわざ書く必要がありません。つまり、この<code>full_title</code>メソッドは<a href="http://www.google.com/url?q=http%3A%2F%2Fcatb.org%2Fjargon%2Fhtml%2FA%2Fautomagically.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFzmpVQVieKs2fI3yvqzhpH8dP45w">自動的に</a>すべてのビューで利用できます。</p>
</div>
</div><div id="sec-other_data_structures" class="section" data-tralics-id="cid26" data-number="4.3">
<h2><a href="#sec-other_data_structures" class="heading hyperref"><span class="number">4.3</span> 他のデータ構造</a></h2>
<p>Webアプリケーションは突き詰めればただの文字列に過ぎませんが、実際にはこれらの文字列を<em>作る</em>ために文字列以外のデータ構造も必要となります。この節では、Railsアプリケーションを書くために重要となる、いくつかのRubyのデータ構造について説明します。</p>
<div id="sec-arrays_and_ranges" class="subsection" data-tralics-id="uid360" data-number="4.3.1">
<h3><a href="#sec-arrays_and_ranges" class="heading hyperref"><span class="number">4.3.1</span> 配列と範囲演算子</a></h3>
<p>配列 (array) は、特定の順序を持つ要素のリストです。<em>Railsチュートリアル</em>ではこれまで配列について解説していませんでしたが、配列を理解することは、ハッシュ (<a class="hyperref" href="#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>) やRailsのデータモデルを理解するための重要な基盤となります (データモデルとは<code>has_many</code>などの関連付けのことであり、<a class="hyperref" href="toy_app?version=4.2#sec-demo_user_has_many_microposts"><span class="ref">2.3.3</span></a>や<a class="hyperref" href="user_microposts?version=4.2#sec-user_micropost_associations"><span class="ref">11.1.3</span></a>で説明します)。</p>
<p>Rubyの文字列の理解にだいぶ時間を使ってしまいましたので、次に進むことにします。<code>split</code>メソッドを使用すると、文字列を自然に変換した配列を得ることができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span> <span class="s2">"foo bar     baz"</span><span class="o">.</span><span class="n">split</span>     <span class="c1"># 文字列を3つの要素を持つ配列に分割する</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p class="noindent">この操作によって、3つの文字列からなる配列が得られます。<code>split</code>で文字列を区切って配列にするときにはデフォルトで空白が使用されますが、以下のように他の文字を指定して区切ることもできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"fooxbarxbazx"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p>多くのコンピュータ言語の慣習と同様、Rubyの配列でも<em>ゼロオリジン</em>を採用しています。これは、配列の最初の要素のインデックスが0から始まり、2番目は1...と続くことを意味します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># Rubyでは角かっこで配列にアクセスする</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>              <span class="c1"># 配列の添字はマイナスにもなれる!</span>
<span class="go">=&gt; 17</span>
</pre></div></div>
<p class="noindent">上で示したとおり、配列の要素にアクセスするには角かっこを使用します。Rubyでは、角かっこ以外にも配列の要素にアクセスする方法が提供されています<sup class="footnote" id="cha-4_footnote-ref-7"><a href="#cha-4_footnote-7">7</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>                  <span class="c1"># 配列「a」の内容を確認する</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">second</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>    <span class="c1"># == を使って比較する</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">最後の行では、等しいことを確認する比較演算子<code>==</code>を使ってみました。この演算子や<code>!=</code> (“等しくない”) などの演算子は、他の多くの言語と共通です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span>       <span class="c1"># 配列も文字列と同様lengthメソッドに応答する</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">!=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>配列は、上記コードの最初の行の<code>length</code>メソッド以外にも、さまざまなメソッドに応答します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; [17, 8, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; [17, 42, 8]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
</pre></div></div>
<p class="noindent">上のどのメソッドを実行した場合にも、<code>a</code>自身は変更されていないという点にご注目ください。配列の内容を<em>変更</em>したい場合は、そのメソッドに対応する「破壊的」メソッドを使用します。破壊的メソッドの名前には、元のメソッドの末尾に「!」を追加したものを使用するのがRubyの慣習です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort!</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [8, 17, 42]</span>
</pre></div></div>
<p>また、<code>push</code>メソッド (または同等の<span class="inline_verbatim">&lt;&lt;</span>演算子) を使用して配列に要素を追加することもできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>                  <span class="c1"># 6 を配列に追加する</span>
<span class="go">=&gt; [42, 8, 17, 6]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>                     <span class="c1"># 7を配列に追加する</span>
<span class="go">=&gt; [42, 8, 17, 6, 7]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s2">"foo"</span> <span class="o">&lt;&lt;</span> <span class="s2">"bar"</span>        <span class="c1"># 配列に連続して追加する</span>
<span class="go">=&gt; [42, 8, 17, 6, 7, "foo", "bar"]</span>
</pre></div></div>
<p class="noindent">最後の例では、要素の追加を連鎖 (chain) できることを示しました。他の多くの言語の配列と異なり、Rubyでは異なる型が配列の中で共存できます (上の場合は整数と文字列)。</p>
<p>上では、文字列を配列に変換するのに<code>split</code>を使用しました。<code>join</code>メソッドはこれと逆の動作です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17, 7, "foo", "bar"]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span>                       <span class="c1"># 単純に連結する</span>
<span class="go">=&gt; "428177foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>                 <span class="c1"># カンマ+スペースを使って連結する</span>
<span class="go">=&gt; "42, 8, 17, 7, foo, bar"</span>
</pre></div></div>
<p><em>範囲 (range)</em> は、配列と密接に関係しています。<code>to_a</code>メソッドを使用して配列に変換すると理解しやすいと思います。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span>
<span class="go">=&gt; 0..9</span>
<span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">.</span><span class="n">to_a</span>              <span class="c1"># 配列でない数字の9にto_aを実行してしまった</span>
<span class="go">NoMethodError: undefined method `to_a' for 9:Fixnum</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 丸かっこを使って明示的に範囲クラスのto_aメソッドを呼ぶ</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</pre></div></div>
<p class="noindent"><code>0..9</code> は範囲として有効ですが、上の2番目の表記ではメソッドを呼ぶ際にかっこを追加する必要があることを示しています。</p>
<p>範囲は、配列の要素を取り出すのに便利です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="sx">%w[foo bar baz quux]</span>         <span class="c1"># %wを使用して文字列の配列に変換</span>
<span class="go">=&gt; ["foo", "bar", "baz", "quux"]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p class="noindent">インデックスに-1という値を指定できるのは極めて便利です。-1を使用すると、配列の長さを<em>知らなくても</em>配列の最後の要素を指定することができ、これにより配列を特定の開始位置の要素から最後の要素までを一度に選択することができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span>               <span class="c1"># 明示的に配列の長さを使って選択</span>
<span class="go">=&gt; [2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>                         <span class="c1"># 添字に-1を使って選択</span>
<span class="go">=&gt; [2, 3, 4, 5, 6, 7, 8, 9]</span>
</pre></div></div>
<p>以下のように、文字に対しても範囲を使用できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'e'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; ["a", "b", "c", "d", "e"]</span>
</pre></div></div>
</div>
<div id="sec-blocks" class="subsection" data-tralics-id="uid362" data-number="4.3.2">
<h3><a href="#sec-blocks" class="heading hyperref"><span class="number">4.3.2</span> ブロック</a></h3>
<p>配列と範囲はいずれも、<em>ブロック</em>を伴うさまざまなメソッドに対して応答することができます。ブロックは、Rubyの極めて強力な機能であり、かつわかりにくい機能でもあります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">}</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p class="noindent">上のコードでは、範囲オブジェクトである<code>(1..5)</code>に対して<code>each</code>メソッドを呼び出します。メソッドに渡されている<code>{ |i| puts 2 * i }</code>が、ブロックです。<code>|i|</code>では変数名が縦棒「|」に囲まれていますが、これはブロック変数に対して使用するRubyの構文で、ブロックを操作するときに使用する変数を指定します。この場合、範囲オブジェクトの<code>each</code>メソッドは、<code>i</code>という1つのローカル変数を使用してブロックを操作できます。そして、範囲に含まれるそれぞれの値をこの変数に次々に代入してブロックを実行します。</p>
<p>ブロックであることを示すには波かっこ { } で囲みますが、以下のようにdoとendで囲んで示すこともできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="gp">?</span>&gt;   <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p>ブロックには複数の行を記述できます (実際ほとんどのブロックは複数行です)。<em>Railsチュートリアル</em>ではRuby共通の慣習に従って、短い1行のブロックには波かっこを使用し、長い1行や複数行のブロックには<code>do..end</code>記法を使用しています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">number</span>
<span class="gp">&gt;&gt; </span>  <span class="nb">puts</span> <span class="s1">'--'</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">--</span>
<span class="go">4</span>
<span class="go">--</span>
<span class="go">6</span>
<span class="go">--</span>
<span class="go">8</span>
<span class="go">--</span>
<span class="go">10</span>
<span class="go">--</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p class="noindent">今度は<code>i</code>の代わりに<code>number</code>を使用していることにご注目ください。この変数 (ブロック変数) の名前は固定されていません。</p>
<p>ブロックは見た目よりもずっと奥が深く、ブロックを十分に理解するためには相当なプログラミング経験が必要です。そのためには、ブロックを含むコードをたくさん読みこなすことでブロックの本質を会得する以外に方法はありません<sup class="footnote" id="cha-4_footnote-ref-8"><a href="#cha-4_footnote-8">8</a></sup>。幸い、人間には個別の事例を一般化する能力というものがあります。ささやかですが、<code>map</code>メソッドなどを使用したブロックの使用例を参考のためにいくつかご紹介します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">"Betelgeuse!"</span> <span class="p">}</span>   <span class="c1"># 3.timesではブロックに変数を使用していない</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">}</span>          <span class="c1"># 「**」記法は冪乗 (べき乗) </span>
<span class="go">=&gt; [1, 4, 9, 16, 25]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span>                        <span class="c1"># %w で文字列の配列を作成</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="go">=&gt; ["A", "B", "C"]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
</pre></div></div>
<p class="noindent">上に示したように、<code>map</code>メソッドは、与えられたブロックを配列や範囲オブジェクトの各要素に対して適用し、その結果を返します。また、後半の2つの例では、<code>map</code>のブロック内で宣言した引数 (char) に対してメソッドを呼び出しています。こういったケースでは省略記法が一般的で、以下のように書くこともできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:downcase</span><span class="p">)</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
</pre></div></div>
<p class="noindent">(メソッド名に<em>シンボル</em>が使われているので奇妙に見えるかもしれません。これについては<a class="hyperref" href="#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>で説明します)。ひとつ面白い話があります。これは実は元々Ruby on Rails独自の記法でした。しかし多くの人がこの記法を好むようになったので、今ではRubyのコア機能として導入されています。</p>
<p>最後のブロックの例として、単体テストにも目を向けてみましょう (<a class="hyperref" href="#code-home_base_title_spec">リスト<span class="ref">4.4</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="nb">test</span> <span class="s2">"should get home"</span> <span class="k">do</span>
</span>  <span class="n">get</span> <span class="ss">:home</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="n">assert_select</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
<span class="hll"><span class="k">end</span>
</span></pre></div></div>
<p class="noindent">ここでは動作をすみずみまで理解する必要はありません (実際、<em>筆者</em>もこのコードをひと目で完璧に把握できるなどとは言いません)。ここで重要なのは、テストコードに<code>do</code>というキーワードがあることに気付き、そこからテストの本体が「そもそもブロックでできている」ことに気付くことです。すなわち、この<code>test</code>メソッドは文字列 (説明文) とブロックを引数にとり、テストが実行されるときにブロック内の文が実行される、ということが理解できます。</p>
<p>ところで、<a class="hyperref" href="beginning?version=4.2#sec-heroku_commands"><span class="ref">1.5.4</span></a>でランダムなサブドメインを生成するために以下のRubyコードを紹介しましたが、このコードを理解するための準備が整ったので、今こそ読み解いてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div></div>
<p class="noindent">順を追ってこのコードを組み立ててみると、動作がよくわかります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>                     <span class="c1"># 英小文字を列挙した配列を作る</span>
<span class="go">=&gt; ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o",</span>
<span class="go">"p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span>             <span class="c1"># シャッフルする</span>
<span class="go">=&gt; ["c", "g", "l", "k", "h", "z", "s", "i", "n", "d", "y", "u", "t", "j", "q",</span>
<span class="go">"b", "r", "o", "f", "e", "w", "v", "m", "a", "x", "p"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span>       <span class="c1"># 配列の冒頭7つの要素を取り出す</span>
<span class="go">=&gt; ["f", "w", "i", "a", "h", "p", "c", "x"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>  <span class="c1"># 取り出した要素を結合してひとつの文字列にする</span>
<span class="go">=&gt; "mznpybuj"</span>
</pre></div></div>
</div>
<div id="sec-hashes_and_symbols" class="subsection" data-tralics-id="uid364" data-number="4.3.3">
<h3><a href="#sec-hashes_and_symbols" class="heading hyperref"><span class="number">4.3.3</span> ハッシュとシンボル</a></h3>
<p>ハッシュは、本質的には配列と同じですが、インデックスとして整数値以外のものも使用できる点が配列と異なります (この理由から、いくつかの言語 (特にPerl) ではハッシュを<em>連想配列</em>と呼ぶこともあります)。ハッシュのインデックス (<em>キー</em>と呼ぶのが普通です) は、通常何らかのオブジェクトです。たとえば、以下のように文字列をキーとして使用できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># {}は空のハッシュ</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"first_name"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Michael"</span>     <span class="c1"># キーが "first_name" で値が "Michael"</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"last_name"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Hartl"</span>        <span class="c1"># キーが "last_name" で値が "Hartl"</span>
<span class="go">=&gt; "Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"first_name"</span><span class="o">]</span>                 <span class="c1"># 要素へのアクセスは配列の場合と似ている</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span>                               <span class="c1"># ハッシュのリテラル表記</span>
<span class="go">=&gt; {"last_name"=&gt;"Hartl", "first_name"=&gt;"Michael"}</span>
</pre></div></div>
<p class="noindent">ハッシュは、キーと値のペアを波かっこで囲んで表記します。キーと値のペアを持たない波かっこの組 (<code>{}</code>) は空のハッシュです。ここで重要なのは、ハッシュの波かっこは「ブロックの波かっことはまったく別物である」という点です (これは確かに紛らわしい点です)。ハッシュは配列と似ていますが、ハッシュでは要素の「並び順」が保証されないという重要な違いがあります<sup class="footnote" id="cha-4_footnote-ref-9"><a href="#cha-4_footnote-9">9</a></sup>。</p>
<p>角かっこを使ってハッシュの要素をひとつづつ定義する代わりに、以下のようにキーと値を<code>=&gt;</code>でリテラル表現するほうが簡単です (この記号はハッシュロケットと呼ばれます)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"first_name"</span> <span class="o">=&gt;</span> <span class="s2">"Michael"</span><span class="p">,</span> <span class="s2">"last_name"</span> <span class="o">=&gt;</span> <span class="s2">"Hartl"</span> <span class="p">}</span>
<span class="go">=&gt; {"last_name"=&gt;"Hartl", "first_name"=&gt;"Michael"}</span>
</pre></div></div>
<p class="noindent">ここではRubyのスタイルの慣習に従い、ハッシュの最初と最後に空白を追加しています。この空白は機能上はあってもなくてもよく、コンソールでは無視されます (なぜスペースを置くようになったのかはわかりませんが、おそらく初期の有力なRubyプログラマの好みが反映されたのでしょう)。</p>
<p>ここまではハッシュのキーに文字列を使用していましたが、Railsのハッシュキーでは文字列よりも<em>シンボル</em>の方が広く使用されています。シンボルは文字列と似ていますが、クォートで囲む代わりにコロンが前に置かれている点が異なります。たとえば、<code>:name</code>はシンボルです。もちろん、シンボルを「余分なものを削ぎ落した軽量な文字列」とみなしても構いません<sup class="footnote" id="cha-4_footnote-ref-10"><a href="#cha-4_footnote-10">10</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"name"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="go">=&gt; ["n", "a", "m", "e"]</span>
<span class="gp">&gt;&gt; </span><span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="go">NoMethodError: undefined method `split' for :name:Symbol</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; "raboof"</span>
<span class="gp">&gt;&gt; </span><span class="ss">:foobar</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">NoMethodError: undefined method `reverse' for :foobar:Symbol</span>
</pre></div></div>
<p class="noindent">シンボルは、Ruby以外ではごく一部の言語にしか採用されていない特殊なデータ形式です。最初は奇妙に思うかもしれませんが、Railsではシンボルをふんだんに使用しているので、すぐに慣れるでしょう。ただし文字列と違って、利用できない記号がある点にご注意ください</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="ss">:foo</span><span class="o">-</span><span class="n">bar</span>
<span class="go">NameError: undefined local variable or method `bar' for main:Object</span>
<span class="gp">&gt;&gt; </span><span class="p">:</span><span class="mi">2</span><span class="n">foo</span>
<span class="go">SyntaxError</span>
</pre></div></div>
<p class="noindent">一般的な英文字を使っている限り、シンボルの名前で不自由することはないでしょう。</p>
<p>ハッシュのキーとしてシンボルを採用する場合、<code>user</code> のハッシュは以下のように定義できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>              <span class="c1"># :name に対応する値を取得する</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>          <span class="c1"># 定義されていないキーの値にアクセスする</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p class="noindent">最後の例を見ると、未定義のハッシュ値は単純に<code>nil</code>であることがわかります。</p>
<p>ハッシュではシンボルをキーとして使うことが一般的なので、Ruby&nbsp;1.9からこのような特殊な場合のための新しい記法がサポートされました。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">2つ目の記法は、シンボルとハッシュロケットの組み合わせを、以下のようにキーの名前の (前ではなく) 後にコロンを置き、その後に値が続くように置き換えたものです。</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">この構成は、JavaScriptなど他の言語のハッシュ記法により近いものになっており、Railsコミュニティでも人気が高まっています。どちらの記法もよく使われているので、両方の見分けがつくことが重要です。ただ最初は少し見分けづらいのも事実です。たとえば<code>:name</code>は単独でシンボルとして使えますが、<code>name:</code>はその後ろに引数がなければ意味がありません。以下のコードの<code>:name =&gt;</code>と<code>name:</code>は、<em>ハッシュとしてのデータ構造は</em>全く同じです。つまり、</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">と</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">というコードは等価になります (一般的には省略記法が好まれますが、明示的に接頭にコロンをつけてシンボル (<code>:name</code>) であることを強調するという考え方もあります)。</p>
<p><a class="hyperref" href="#code-nested_hashes"><span class="ref">リスト4.10</span></a>に示したように、ハッシュの値にはほぼ何でも使用することができ、他のハッシュを使用することすらできます。</p>
<div class="codelisting" id="code-nested_hashes" data-tralics-id="uid367" data-number="4.10">
<div class="heading">
<span class="number">リスト4.10:</span> 

<span class="description">ハッシュの中のハッシュ</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># 'params' というハッシュを定義する ('parameters' の略)。</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"mhartl@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span>
<span class="go">=&gt; {:user=&gt;{:name=&gt;"Michael Hartl", :email=&gt;"mhartl@example.com"}}</span>
<span class="gp">&gt;&gt; </span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
<span class="go">=&gt; "mhartl@example.com"</span>
</pre></div></div>
</div>
<p class="noindent">Railsでは、このようなハッシュのハッシュ (または<em>ネストされたハッシュ</em>) が大量に使われています。実際の使用例は<a class="hyperref" href="sign_up?version=4.2#sec-unsuccessful_signups"><span class="ref">7.3</span></a>で説明します。</p>
<p>配列や範囲オブジェクトと同様、ハッシュも<code>each</code>メソッドに応答します。たとえば、<code>:success</code>と<code>:error</code>という 2つの状態を持つ <code>flash</code> という名前のハッシュについて考えてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">danger</span><span class="p">:</span> <span class="s2">"It failed."</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;"It worked!", :danger=&gt;"It failed."}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">Key :success has value "It worked!"</span>
<span class="go">Key :danger has value "It failed."</span>
</pre></div></div>
<p class="noindent">ここで、配列の<code>each</code>メソッドでは、ブロックの変数は1つだけですが、ハッシュの<code>each</code>メソッドでは、ブロックの変数は<em>キー</em>と<em>値</em>の2つになっていることに注意してください。従って、 ハッシュに対して<code>each</code>メソッドを実行すると、ハッシュの1つの「キーと値の<em>ペア</em>」ごとに処理を繰り返します。</p>
<p>最後の例として、便利な<code>inspect</code>メソッドを紹介します。これは要求されたオブジェクトを表現する文字列を返します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 配列を文字列として出力</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">5</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">inspect</span>    <span class="c1"># 配列のリテラルを出力</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:name</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">name</span>
<span class="go">:name</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="s2">"It worked!"</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">It worked!</span>
<span class="go">"It worked!"</span>
</pre></div></div>
<p class="noindent">ところで、オブジェクトを表示するために<code>inspect</code>を使用することは非常によくあることなので、 <code>p</code>関数というショートカットがあります<sup class="footnote" id="cha-4_footnote-ref-11"><a href="#cha-4_footnote-11">11</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">p</span> <span class="ss">:name</span>             <span class="c1"># 'puts :name.inspect' と同じ</span>
<span class="go">:name</span>
</pre></div></div>
</div>
<div id="sec-css_revisited" class="subsection" data-tralics-id="uid369" data-number="4.3.4">
<h3><a href="#sec-css_revisited" class="heading hyperref"><span class="number">4.3.4</span> CSS、再び</a></h3>
<p>それでは、もう一度<a class="hyperref" href="#code-application_layout_redux"><span class="ref">リスト4.1</span></a>に戻り、レイアウトに CSS (cascading style sheet) を追加する以下の行を見てみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                       <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>今なら、このコードを理解できるようになったはずです。<a class="hyperref" href="#sec-motivation"><span class="ref">4.1</span></a>でも簡単に説明したとおり、Railsではスタイルシートを追加するための特別な関数を使用しています。</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p class="noindent">上のコードは、その特別な関数を呼んでいます。しかし、ここで不思議な点がいくつもあります。第一に、丸かっこがありません。実は、Ruby では丸かっこは使用してもしなくても構いません。以下の2つの行は同等です。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># 関数呼び出しの丸かっこは省略可能。</span>
<span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>次に、<code>:media</code>引数はハッシュのようですが、波かっこがない点が不思議です。実は、ハッシュが関数呼び出しの<em>最後の</em>引数である場合は、波かっこを省略できます。以下の2つの行は同等です。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># 最後の引数がハッシュの場合、波かっこは省略可能。</span>
<span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="p">{</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                     <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>次に、<code>data-turbolinks-track</code>におけるキーと値のペアの表記が、旧式のハッシュロケット (=&gt;) スタイルになっている点が不思議です。実は、以下のような新しいハッシュ記法を使用すると、</p>
<div class="code"><div class="highlight"><pre><span class="n">data</span><span class="o">-</span><span class="n">turbolinks</span><span class="o">-</span><span class="ss">track</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p class="noindent">ハイフン (-) が入っているためにエラーが発生してしまいます。(<a class="hyperref" href="#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>で、シンボルにハイフンが使えなかったことを思い出してください) このため、以下のような旧式のハッシュロケット記法を使用するしかないのです。</p>
<div class="code"><div class="highlight"><pre><span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>最後に、Rubyが以下のようなコードを正常に実行できているのが不思議です。</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p class="noindent">上のコードには途中に改行が含まれているにもかかわらずです。実は、Rubyは改行と空白を区別していません<sup class="footnote" id="cha-4_footnote-ref-12"><a href="#cha-4_footnote-12">12</a></sup>。著者が上のコードに改行を追加した<em>理由</em>は、コードの読みやすさを損なわないために1行あたり80文字までに制限していたためです<sup class="footnote" id="cha-4_footnote-ref-13"><a href="#cha-4_footnote-13">13</a></sup>。</p>
<p>従って、</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span>
                                   <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p class="noindent">上のコードでは<code>stylesheet_link_tag</code>関数を2つの引数で呼んでいます。最初の引数である文字列は、スタイルシートへのパスを示しています。次の引数であるハッシュには2つの要素があり、最初の要素はメディアタイプを示し、次の要素はRails 4.0で追加された<a href="https://github.com/rails/turbolinks" target="_blank">turbolinks</a>という機能をオンにしています。コードが<span class="inline_verbatim">&lt;%= %&gt;</span>で囲まれていることによって、 このコードの実行結果はERbのテンプレートに挿入されます。ブラウザ上でこのページのソースを表示すると、必要なスタイルシートが含まれていることを確認できます (<a class="hyperref" href="#code-scss_source"><span class="ref">リスト4.11</span></a>)。(CSSファイル名の後に、<code>?</code>body=1のような行が余分に表示されていることがあります。これらはRailsによって挿入されているもので、サーバー上で変更があった場合にブラウザがCSSを再読み込みするのに使用します。)</p>
<div class="codelisting" id="code-scss_source" data-tralics-id="uid372" data-number="4.11">
<div class="heading">
<span class="number">リスト 4.11:</span>

<span class="description">インクルードされたCSSによって生成されたHTMLソース。</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">data-turbolinks-track=</span><span class="s">"true"</span> <span class="na">href=</span><span class="s">"/assets/application.css"</span> <span class="na">media=</span><span class="s">"all"</span>
<span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="nt">/&gt;</span>
</pre></div></div>
</div>
<p class="noindent">実際に<a href="http://www.google.com/url?q=http%3A%2F%2Flocalhost%3A3000%2Fassets%2Fapplication.css&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGWxdUoqbyuwtOlq8v1HbALLEGI4w">http://localhost:3000/assets/application.css</a>のCSSファイルにアクセスしてみると、わずかなコメントがある以外は空になっています。CSSの変更は<a class="hyperref" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="ref">第5章</span></a>で行います。</p>
</div>
</div><div id="sec-ruby_classes" class="section" data-tralics-id="cid27" data-number="4.4">
<h2><a href="#sec-ruby_classes" class="heading hyperref"><span class="number">4.4</span> Rubyにおけるクラス</a></h2>
<p>Rubyではあらゆるものがオブジェクトであるということは既に説明しましたが、この節では実際にオブジェクトをいくつか定義してみましょう。Rubyは、多くのオブジェクト指向言語と同様、メソッドをまとめるのに<em>クラス</em>を使用しています。これらのクラスから<em>インスタンスが生成される</em>ことでオブジェクトが作成されます。オブジェクト指向プログラミングの経験がない方にとっては何のことだかわからないと思いますので、いくつかの具体例を示すことにします。</p>
<div id="sec-constructors" class="subsection" data-tralics-id="uid373" data-number="4.4.1">
<h3><a href="#sec-constructors" class="heading hyperref"><span class="number">4.4.1</span> コンストラクタ</a></h3>
<p>実は、これまで示した多くの例の中でも、クラスを使用してオブジェクトのインスタンスを作成してきたのですが、オブジェクトを作成するところを明示的に説明していませんでした。たとえば、ダブルクォートを使って文字列のインスタンスを作成しましたが、これは文字列のオブジェクトを暗黙で作成する<em>リテラルコンストラクタ</em>です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">"foobar"</span>       <span class="c1"># ダブルクォートは実は文字列のコンストラクタ</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
</pre></div></div>
<p class="noindent">上のコードでは、文字列が<code>class</code>メソッドに応答しており、その文字列が所属するクラスを単に返していることがわかります。</p>
<p>暗黙のリテラルコンストラクタを使う代わりに、明示的に同等の<em>名前付きコンストラクタ</em>を使うことができます。名前付きコンストラクタは、クラス名に対して<code>new</code>メソッドを呼び出します<sup class="footnote" id="cha-4_footnote-ref-14"><a href="#cha-4_footnote-14">14</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>   <span class="c1"># 文字列の名前付きコンストラクタ</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">==</span> <span class="s2">"foobar"</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">この動作はリテラルコンストラクタと同等ですが、動作の内容が明確に示されています。</p>
<p>配列でも、文字列と同様にインスタンスを生成できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; [1, 3, 2]</span>
</pre></div></div>
<p class="noindent">ただし、ハッシュの場合は若干異なります。配列のコンストラクタである<code>Array.new</code> は配列の初期値を引数に取りますが、 <code>Hash.new</code> はハッシュの<em>デフォルト</em> 値を引数に取ります。これは、キーが存在しない場合のデフォルト値です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># 存在しないキー (:foo) の値にアクセスしてみる</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># 存在しないキーのデフォルト値をnilから0にする</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="go">=&gt; 0</span>
</pre></div></div>
<p>メソッドがクラス自身 (この場合は<code>new</code>) に対して呼び出されるとき、このメソッドを<em>クラスメソッド</em>と呼びます。クラスの<code>new</code>メソッドを呼び出した結果は、そのクラスのオブジェクトであり、これはクラスの<em>インスタンス</em>とも呼ばれます。<code>length</code>のように、インスタンスに対して呼び出すメソッドは<em>インスタンスメソッド</em>と呼ばれます。</p>
</div>
<div id="sec-a_class_of_our_own" class="subsection" data-tralics-id="uid375" data-number="4.4.2">
<h3><a href="#sec-a_class_of_our_own" class="heading hyperref"><span class="number">4.4.2</span> クラス継承</a></h3>
<p>クラスについて学ぶとき、<em>superclass</em>メソッドを使って<code>クラス階層</code>を調べてみるとよくわかります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>                        <span class="c1"># 変数sのクラスを調べる</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>             <span class="c1"># Stringクラスの親クラスを調べる</span>
<span class="go">=&gt; Object</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>  <span class="c1"># Ruby 1.9 からBasicObjectという新しい基底クラスが導入された</span>
<span class="go">=&gt; BasicObject</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p class="noindent">継承階層を<a class="hyperref" href="#fig-string_inheritance_ruby_1_9"><span class="ref">図4.1</span></a>に示します。ここでは、<code>String</code>クラスのスーパークラスは<code>Object</code>クラスで、<code>Object</code>クラスのスーパークラスは<code>BasicObject</code>クラスですが、 <code>BasicObject</code>クラスはスーパークラスを持たないことがわかります。この図式は、すべての Ruby のオブジェクトにおいて成り立ちます。クラス階層をたどっていくと、 Rubyにおけるすべてのクラスは最終的にスーパークラスを持たない<code>BasicObject</code>クラスを継承しています。これが、"Rubyではあらゆるものがオブジェクトである" ということの技術的な意味です。</p>
<div class="center figure" id="fig-string_inheritance_ruby_1_9" data-tralics-id="uid376" data-number="4.1">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/string_inheritance_ruby_1_9.png" alt="string_inheritance_ruby_1_9"></span>
<div class="caption">
<span class="header">図4.1</span> <span class="description"><code>String</code>クラスの継承階層
</span>
</div>
</div>
<p>クラスについてもっと深く知るためには、自分自身で作ってみるのが一番です。そこで、<code>Word</code>クラスを作成し、その中に、ある単語を前からと後ろからのどちらから読んでも同じ (つまり回文になっている) ならば<code>true</code>を返す<code>palindrome?</code>メソッドを作成してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>    <span class="n">string</span> <span class="o">==</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; :palindrome?</span>
</pre></div></div>
<p class="noindent">このクラスとメソッドは以下のように使うことができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span>              <span class="c1"># Wordオブジェクトを作成する</span>
<span class="go">=&gt; #&lt;Word:0x22d0b20&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">"level"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>もし上の例が少し不自然に思えるならば、勘が鋭いといえます。というのも、これはわざと不自然に書いたからです。文字列を引数に取るメソッドを作るためだけに、わざわざ新しいクラスを作るのは変です。単語<em>は</em>文字列なので、<a class="hyperref" href="#code-word_class"><span class="ref">リスト4.12</span></a>のように<code>Word</code>クラスは <code>String</code>クラスを<em>継承</em>するのが自然です(以下のリストを入力する前に、古い<code>Word</code>クラスの定義を消去するために、Railsコンソールをいったん終了してください)。</p>
<div class="codelisting" id="code-word_class" data-tralics-id="uid377" data-number="4.12">
<div class="heading">
<span class="number">リスト 4.12:</span> 

<span class="description">コンソールで<code>Word</code>クラスを定義する。</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span> <span class="o">&lt;</span> <span class="nb">String</span>             <span class="c1"># WordクラスはStringクラスを継承する。</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が鏡文字であればtrueを返す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>        <span class="c1"># selfは文字列自身を表す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="static_pages?version=4.2#sec-static_pages"><span class="ref">3.2</span></a>でも簡単に説明しましたが、上のコードの<code>Word &lt; String</code>は継承のためのRubyの記法です。こうすることで、新しい<code>palindrome?</code>メソッドだけではなく、Stringクラスで使用できるすべてのメソッドをWordクラスに対しても使用できるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"level"</span><span class="p">)</span>    <span class="c1"># 新しいWordを作成し、"level" で初期化する</span>
<span class="go">=&gt; "level"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">palindrome?</span>            <span class="c1"># Wordが鏡文字かどうか</span>を調べるメソッド
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>                 <span class="c1"># WordはStringで扱える全てのメソッドを継承している</span>
<span class="go">=&gt; 5</span>
</pre></div></div>
<p class="noindent"><code>Word</code>クラスは<code>String</code>クラスを継承しているので、コンソールを使用してクラス階層を明示的に確認できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Word</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#fig-word_inheritance_ruby_1_9"><span class="ref">図4.2</span></a>にこのクラス階層を示します。</p>
<div class="center figure" id="fig-word_inheritance_ruby_1_9" data-tralics-id="uid378" data-number="4.2">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/word_inheritance_ruby_1_9.png" alt="word_inheritance_ruby_1_9"></span>
<div class="caption">
<span class="header">図4.2: </span><span class="description"><a class="hyperref" href="#code-word_class"><span class="ref">リスト4.12</span></a>の (組み込みではない) <code>Word</code>クラスの継承階層。
</span>
</div>
</div>
<p><a class="hyperref" href="#code-word_class"><span class="ref">リスト4.12</span></a>では、単語の文字を逆順にしたものが元の単語と同じであるかどうかのチェックを、<code>Word</code>クラスの中から自分自身が持つ単語にアクセスすることで行なっていることにご注目ください。Rubyでは、<code>self</code>キーワードを使用してこれを指定することができます。<code>Word</code>クラスの中では、<code>self</code>はオブジェクト自身を指します。これはつまり、以下のコードを使用して、</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</pre></div></div>
<p class="noindent">単語が回文であるかどうかを確認できるということです<sup class="footnote" id="cha-4_footnote-ref-15"><a href="#cha-4_footnote-15">15</a></sup>。なお、Stringクラスの内部では、メソッドやぞくs<code>self.</code>も省略可能です</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="n">reverse</span>
</pre></div></div>
<p class="noindent">といった省略記法でも、うまく動きます。</p>
</div>
<div id="sec-modifying_built_in_classes" class="subsection" data-tralics-id="uid380" data-number="4.4.3">
<h3><a href="#sec-modifying_built_in_classes" class="heading hyperref"><span class="number">4.4.3</span> 組込みクラスの変更</a></h3>
<p>継承は強力な概念ですが、もし仮に継承を使用せずに<code>palindrome?</code>メソッドを<code>String</code>クラス自身に追加する (つまりStringクラスを拡張する) という、より自然な方法を使用することが可能だとしたら、わざわざWordクラスを作らなくても<code>palindrome?</code>をリテラル文字列に対して直接実行できるようになるはずです。そんなことが可能なのでしょうか (なお、現在のコードはそのようになっていないため、以下のようにエラーになります)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"level"</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">NoMethodError: undefined method `palindrome?' for "level":String</span>
</pre></div></div>
<p class="noindent">驚いたことに、Rubyでは組み込みの基本クラスの拡張が可能なのです。Ruby のクラスは<em>オープン</em>で変更可能であり、クラス設計者でない開発者でもこれらのクラスにメソッドを自由に追加することが許されています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が回文であればtrueを返す</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">"deified"</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">(Rubyで組み込みクラスにメソッドを追加できるということは実にクールですが、<code>"deified"</code> (=神格化された) という単語が回文になっていることも、それに劣らずクールではないでしょうか。)</p>
<p>組み込みクラスの変更はきわめて強力なテクニックですが、大いなる力には大いなる責任が伴います (訳注: 「スパイダーマン」の名台詞)。従って、<em>真に</em>正当な理由がない限り、組み込みクラスにメソッドを追加することは無作法であると考えられています。Railsの場合、組み込みクラスの変更を正当化できる理由がいくつもあります。たとえば、Web アプリケーションでは、変数が絶対に<em>空白</em>にならないようにしたくなることがよくあります (ユーザー名などはスペースや<a href="http://en.wikipedia.org/wiki/Whitespace_character" target="_blank">その他の空白文字</a>になって欲しくないものです) ので、Railsは<code>blank?</code>メソッドをRuby に追加しています。Railsの拡張は自動的にRailsコンソールにも取り込まれるので、以下のようにコンソールで拡張の結果を確認できます (注意: 以下のコードは純粋な <code>irb</code> では動作しません)。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="s2">"      "</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">"      "</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">スペースが集まってできた文字列は<em>空 (empty) </em>とは認識されませんが、<em>空白 (blank) </em>であると認識されていることがわかります。ここで、<code>nil</code>は空白と認識されることに注意してください。<code>nil</code>は文字列ではないので、Railsが実は<code>blank?</code>メソッドを<code>String</code>クラスではなく、そのさらに上の基底クラスに追加していることが推測できます。その基底クラスとは、(この章の最初で説明した) <code>Object</code>自身です。RailsによってRubyの組み込みクラスに追加が行われている例については、<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>で説明します。</p>
</div>
<div id="sec-a_controller_class" class="subsection" data-tralics-id="uid381" data-number="4.4.4">
<h3><a href="#sec-a_controller_class" class="heading hyperref"><span class="number">4.4.4</span> コントローラクラス</a></h3>
<p>これまでクラスや継承について説明してきましたが、これらの話は前の章にもあったような気がします。それもそのはずで、StaticPagesコントローラで継承やクラスについて触れたことがありました (<a class="hyperref" href="static_pages?version=4.2#code-adding_the_about_page"><span class="ref">リスト3.18</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">本書をここまで進めてきた今であれば、上のコードの意味は (たとえ漠然とであっても) 理解できるはずです。<code>StaticPagesController</code>クラスは<code>ApplicationController</code>を継承しており、<code>home</code>メソッド、<code>help</code>メソッド、<code>about</code>メソッドを備えています。Rails コンソールは、セッションごとにローカルのRails環境を読み込むので、コンソール内で明示的にコントローラを作成したり、そのクラス階層を調べたりすることができます<sup class="footnote" id="cha-4_footnote-ref-16"><a href="#cha-4_footnote-16">16</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span> <span class="o">=</span> <span class="no">StaticPagesController</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;StaticPagesController:0x22855d0&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; StaticPagesController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ApplicationController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Metal</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; AbstractController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div></div>
<p class="noindent">継承の関係を<a class="hyperref" href="#fig-static_pages_controller_inheritance"><span class="ref">図4.3</span></a>に示します。</p>
<div class="center figure" id="fig-static_pages_controller_inheritance" data-tralics-id="uid383" data-number="4.3">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/static_pages_controller_inheritance.png" alt="static_pages_controller_inheritance"></span>
<div class="caption">
<span class="header">図4.3: </span><span class="description">StaticPagesコントローラの継承階層
</span>
</div>
</div>
<p>Railsコンソールでは、その中からコントローラのアクション (実はメソッド) を呼ぶこともできます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">home</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p class="noindent">ここでは、<code>home</code>アクションの中身は空なので<code>nil</code>が返されます。</p>
<p>ここで重要な点があります。Railsのアクションには戻り値がありません。少なくとも、返される値は重要ではありません。<a class="hyperref" href="static_pages?version=4.2#cha-static_pages"><span class="ref">第3章</span></a>で示したとおり、<code>home</code>アクションはWebページを表示するためのものであり、値を返すためのものではありませんでした。しかも、第3章では一度も<code>StaticPagesController.new</code>を実行しませんでした。どうしてこれでうまくいっているのでしょうか。</p>
<p>実は、Railsは確かにRubyで<em>書かれて</em>いますが、既にRubyとは別物なのです。Railsのクラスは、普通のRubyオブジェクトと同様に振る舞うものもありますが、多くのクラスにはRailsの<a href="http://www.answers.com/grist" target="_blank">魔法の粉</a>が振りかけられています。Railsは<a href="http://en.wikipedia.org/wiki/Sui_generis" target="_blank"><em>独特</em></a>であり、 Rubyとは切り離して学習する必要があります。</p>
</div>
<div id="sec-a_user_class" class="subsection" data-tralics-id="uid384" data-number="4.4.5">
<h3><a href="#sec-a_user_class" class="heading hyperref"><span class="number">4.4.5</span> ユーザークラス</a></h3>
<p>最後に完全なクラスを作成して、この章を終わりにしましょう。そこで、<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>で使用する<code>User</code>クラスを最初から作成することにします。</p>
<p>これまではコンソール上でクラスを定義しましたが、このような面倒な作業はもう行いたくありません。これからは、アプリケーションのルートディレクトリに<code>example_user.rb</code>ファイルを作成し、そこに<a class="hyperref" href="#code-example_user"><span class="ref">リスト4.13</span></a>のように書くことにします。</p>
<div class="codelisting" id="code-example_user" data-tralics-id="uid385" data-number="4.13">
<div class="heading">
<span class="number">リスト4.13:</span> 

<span class="description"> example_userで使用するコード <span class="break"></span> <span class="filepath">example_user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>上のコードはこれまでよりもやや複雑になっていますので、順に見ていくことにします。以下の最初の行は、</p>
<div class="code"><div class="highlight"><pre>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</pre></div></div>
<p class="noindent">ユーザー名とメールアドレスに対応する<em>アトリビュートアクセサ</em>をそれぞれ作成します。このコードは、<a class="hyperref" href="toy_app?version=4.2#sec-mvc_in_action"><span class="ref">2.2.2</span></a>や<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>でも説明したように、<code>@name</code>および<code>@email</code><em>インスタンス変数</em>について、取り出し(get) と割り当て(set) を行う "ゲッター" と "セッター" というメソッドをそれぞれ作成します。Railsでは、インスタンス変数を作成するだけでビューで自動的に使えるようになるという点に主な利用価値がありますが、一般的には、インスタンス変数はRubyのそのクラス内のどこでも利用できるようにしたい変数として使われます(これについては後で詳しく説明します)。インスタンス変数は常に<code>@</code>記号で始まり、未定義の状態では値が<code>nil</code>になります。</p>
<p>最初の行にある<code>initialize</code>は、Rubyの特殊なメソッドです。これは <code>User.new</code>を実行すると自動的に呼び出されるメソッドです。この場合の<code>initialize</code>メソッドは、以下のように<code>attributes</code>という引数を1つ取ります。</p>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>
</pre></div></div>
<p class="noindent">上のコードで、<code>attributes</code>変数は空のハッシュを<em>デフォルトの値</em>として持つため、名前やメールアドレスのないユーザーを作ることができます (<a class="hyperref" href="#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>を思い出してください。存在しないキーに対してハッシュは<code>nil</code>を返すので、<code>:name</code>キーがなければ<code>attributes[:name]</code>は<code>nil</code> になり、同じことが<code>attributes[:email]</code>にも言えます)。</p>
<p>最後に、<code>formatted_email</code>メソッドを定義しましょう (<a class="hyperref" href="#sec-strings"><span class="ref">4.2.2</span></a>)。このメソッドは、文字列の式展開を利用して、<code>@name</code>と<code>@email</code>に割り当てられた値をユーザーのメールアドレスとして構成します。</p>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;"</span>
  <span class="k">end</span>
</pre></div></div>
<p class="noindent"><code>@</code> 記号によって示されているとおり、<code>@name</code>と<code>@email</code>は両方ともインスタンス変数なので、自動的に<code>formatted_email</code>メソッドで使えるようになります。</p>
<p>Railsコンソールを起動し、example_userのコードを<code>require</code>して、自作したクラスを試しに使ってみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">'./example_user'</span>     <span class="c1"># example_user のコードを読み込む方法</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User:0x224ceec @email=nil, @name=nil&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span>                 <span class="c1"># attribuributes[:name]は存在しないのでnil</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Example User"</span>           <span class="c1"># 名前を代入する</span>
<span class="go">=&gt; "Example User"</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"user@example.com"</span>      <span class="c1"># メールアドレスを代入する</span>
<span class="go">=&gt; "user@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; "Example User &lt;user@example.com&gt;"</span>
</pre></div></div>
<p class="noindent">上のコードで、requireのパスにある<code>’.’</code>は、Unixの “カレントディレクトリ” (現在のディレクトリ) を表し、<code>’./example_user’</code>というパスは、カレントディレクトリからの相対パスでexample_userファイルを探すようにRubyに指示します。次のコードでは空のexample_userを作成します。次に、対応する属性にそれぞれ手動で値を代入することで、名前とメールアドレスを与えます (<a class="hyperref" href="#code-example_user"><span class="ref">リスト4.13</span></a>で<code>attr_accessor</code>を使用しているので、アトリビュートアクセサを使用して代入できます)。以下のコードは、</p>
<div class="code"><div class="highlight"><pre><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Example User"</span>
</pre></div></div>
<p class="noindent"><code>@name</code>変数に<code>"Example User"</code>という値を設定します。同様に<code>email</code>属性にも値を設定します。これらの値は<code>formatted_email</code>メソッドで使用されます。</p>
<p><a class="hyperref" href="#sec-css_revisited"><span class="ref">4.3.4</span></a>では、最後のハッシュ引数の波かっこを省略できることを説明しました。それと同じ要領で<code>initialize</code>メソッドにハッシュを渡すことで、属性が定義済みの他のユーザを作成することができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User:0x225167c @email="mhartl@example.com", @name="Michael Hartl"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; "Michael Hartl &lt;mhartl@example.com&gt;"</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a> では、 ハッシュ引数を使用してオブジェクトを初期化します。これは一般に<em>マスアサインメント (mass assignment)</em> と呼ばれる技法で、Railsアプリケーションで多用されています。</p>
</div>
</div><div id="sec-conclusion" class="section" data-tralics-id="cid28" data-number="4.5">
<h2><a href="#sec-conclusion" class="heading hyperref"><span class="number">4.5</span> 最後に</a></h2>
<p>以上で、Ruby言語の概要の説明を終わります。<a class="hyperref" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="ref">第5章</span></a>では、この章で学んだ内容をサンプルアプリケーションの開発に活かしていきます。</p>
<p><a class="hyperref" href="#sec-a_user_class"><span class="ref">4.4.5</span></a>で作成した<code>example_user.rb</code>ファイルは今後使用することはありませんので、削除してください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm example_user.rb</pre></div></div>
<p class="noindent">その他の変更はリポジトリにコミットしましょう。その後、Bitbucketにプッシュし、Herokuにデプロイしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">$</span> git commit -am <span class="s2">"Add a full_title helper"</span>
<span class="gp">$</span> git push
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="gp">$</span><span class="nb"> </span>git push heroku
</pre></div></div>
<div id="sec-rails_flavored_ruby_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid386" data-number="4.5.1">
<h3><a href="#sec-rails_flavored_ruby_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">4.5.1</span> 本章のまとめ</a></h3>
<ul>
<li>Rubyは文字列を扱うためのメソッドを多数持っている
</li>
<li>Rubyの世界では、すべてがオブジェクトである
</li>
<li>Rubyでは<code>def</code>というキーワードを使ってメソッドを定義する
</li>
<li>Rubyでは<code>class</code>というキーワードを使ってクラスを定義する
</li>
<li>Railsのビューでは静的なHTMLと埋め込みRuby(ERb)が使える
</li>
<li>Rubyの組み込みクラスには配列、範囲、ハッシュなどがある
</li>
<li>Rubyのブロックは (他の似た機能と比べ) 柔軟な機能で、添え字を使ったデータ構造よりも自然にイテレーションができる
</li>
<li>シンボルとはラベルである。追加的な構造を持たない (代入などができない) 文字列みたいなもの。
</li>
<li>Rubyではオブジェクトを継承できる
</li>
<li>Rubyでは組み込みクラスですら内部を見たり修正したりできる
</li>
<li>「“deified”」という単語は回文である
</li>
</ul>
</div>
</div><div id="sec-exercises" class="section" data-tralics-id="cid29" data-number="4.6">
<h2><a href="#sec-exercises" class="heading hyperref"><span class="number">4.6</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>ブックのすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>でチュートリアルを購入いただいた方には無料で付属します。</p>
<ol>
<li>
<a class="hyperref" href="#code-string_shuffle"><span class="ref">リスト4.14</span></a>のコードにある２つの疑問符を、それぞれ適切なメソッドに置き換えて、与えられた文字列の文字をシャッフルする関数を作成してください。ヒント: <code>split</code>メソッド、<code>shuffle</code>メソッド、<code>join</code>メソッドを組み合わせてみましょう。
</li>
<li>
<a class="hyperref" href="#code-string_shuffle_two"><span class="ref">リスト4.15</span></a>を参考にして、上で作成した<code>shuffle</code>メソッドを <code>String</code>クラスに追加してください。
</li>
<li>
<code>person1</code>、<code>person2</code>、<code>person3</code>という3つのハッシュを作成してください。それぞれのハッシュには<code>:first</code>キーと<code>:last</code>キーを与え、さらにそれぞれのキーに名前と名字を値として割り当ててください。次に<code>params</code>ハッシュを作成し、<code>params[:father]</code>は<code>person1</code>、<code>params[:mother]</code>は<code>person2</code>、そして<code>params[:child]</code>は <code>person3</code>になるようにしてください。最後に、<code>params[:father][:first]</code>などが正しい値を持っていることを確認してください。
</li>
<li>Ruby API のオンラインマニュアルを見つけて、Hashクラスの<code>merge</code>メソッドについて読んでみてください。では、次の式の値は何ですか？
<div class="code"><div class="highlight"><pre>  <span class="p">{</span> <span class="s2">"a"</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">"b"</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span> <span class="s2">"b"</span> <span class="o">=&gt;</span> <span class="mi">300</span> <span class="p">})</span>
</pre></div></div>
</li>
</ol>
<div class="codelisting" id="code-string_shuffle" data-tralics-id="uid402" data-number="4.14">
<div class="heading">
<span class="number">リスト 4.14:</span> 

<span class="description">文字列をシャッフルする関数の骨組み。</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="n">s</span><span class="o">.</span><span class="sc">?(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="n">string_shuffle</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; "oobfra"</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-string_shuffle_two" data-tralics-id="uid403" data-number="4.15">
<div class="heading">
<span class="number">リスト 4.15:</span> 

<span class="description"><code>shuffle</code>メソッドを<code>String</code>クラスに追加するための骨組み。</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">shuffle</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span><span class="o">.</span><span class="sc">?(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; "borafo"</span>
</pre></div></div>
</div>
</div><div id="cha-4_footnotes">
  <div class="navigation">
<a class="next_page" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="number">第5章</span>レイアウトを作成する</a><a class="prev_page" href="static_pages?version=4.2#cha-static_pages"><span class="number">第3章</span>ほぼ静的なページの作成</a>
</div>
<ol class="footnotes">
    <li id="cha-4_footnote-1">あるヘルパーが特定のコントローラでのみ使用するものであれば、それに対応するヘルパーファイルに置く必要があります。たとえばStaticPagesコントローラ用ヘルパーは、通常<code>app/helpers/static_pages_helper.rb</code>になります。今回の場合、<code>full_title</code>ヘルパーはサイトのすべてのページで使用することを前提にしていますが、Railsにはこのような場合のための特別なヘルパーファイル<code>app/helpers/application_helper.rb</code>があります。<a class="arrow" href="#cha-4_footnote-ref-1">↑</a>
</li>
    <li id="cha-4_footnote-2">より詳細な“foo”と“bar”の起源については、<a href="http://www.catb.org/jargon/html/F/foo.html" target="_blank">Jargon Fileの“foo”という記事</a> (英語) を参照してください。ちなみに"foobarと"FUBAR"には<em>全く関係がありませんでした</em>。<a class="arrow" href="#cha-4_footnote-ref-2">↑</a>
</li>
    <li id="cha-4_footnote-3">PerlやPHPに精通した開発者であれば、<code>"foo $bar"</code>のようなドル記号による自動的な挿入を連想して比較することでしょう。<a class="arrow" href="#cha-4_footnote-ref-3">↑</a>
</li>
    <li id="cha-4_footnote-4">この章の全体にわたって、<em>関数</em>という言葉と<em>メソッド</em>という言葉が混在していることを前もってお詫びいたします。Rubyでは関数とメソッドには何の違いもありません。すべてのメソッドは関数であり、すべての関数はメソッドでもあります。それもこれも、あらゆるものがオブジェクトであるからです。<a class="arrow" href="#cha-4_footnote-ref-4">↑</a>
</li>
    <li id="cha-4_footnote-5">とはいうものの、まだ理解していないことが<em>1つ</em>あります。<em>Railsが<em>どのようにして</em>これらを結びつけているかということです。URLをアクションにマップする方法や、<code>full_title</code></em>ヘルパーをビューで利用できるようにする方法などがそうです。(この点を深く理解したい方には、「<em>The Rails 4 Way</em>」(Obie Fernandez著) がお勧めです) 。<a class="arrow" href="#cha-4_footnote-ref-5">↑</a>
</li>
    <li id="cha-4_footnote-6">文字列の式展開は魅力的です。実際、以前のチュートリアルではこれを多用していました。しかし、 <code>provide</code>メソッドは内部で文字列オブジェクトをSafeBufferオブジェクトに変換してしまうので、注意が必要です。文字列オブジェクトではないため、式展開をビューの中で使うと多くのエスケープ処理が実行されます。たとえば「Help’s on the way」は「Help&amp;amp;#39;s on the way」といった具合にエスケープされます (この問題を指摘いただいたJeremy Fleischmanに感謝します)。<a class="arrow" href="#cha-4_footnote-ref-6">↑</a>
</li>
    <li id="cha-4_footnote-7">このコードで使用している<code>second</code>メソッドは、実はRuby自身の一部ではなく、Railsが追加したものです。このコードが動作するのは、RailsによるRubyの拡張がRailsコンソールによって自動的に反映されるからです。<a class="arrow" href="#cha-4_footnote-ref-7">↑</a>
</li>
    <li id="cha-4_footnote-8">なおエキスパート向けには、ブロックが<em>クロージャ</em>になっているということを知っていただくと理解しやすいと思います。クロージャとは、データを伴う、その場限りの無名関数です。<a class="arrow" href="#cha-4_footnote-ref-8">↑</a>
</li>
    <li id="cha-4_footnote-9">実はRuby 1.9以降では、ハッシュの要素の順序が入力順と同じであることを保証していますが、ハッシュを特定の順序に依存してカウントするのは得策ではありません。<a class="arrow" href="#cha-4_footnote-ref-9">↑</a>
</li>
    <li id="cha-4_footnote-10">シンボルは文字列に比べてはるかに軽量なので、シンボル同士の比較を高速に行えます。文字列の比較は1文字ずつ行われる必要がありますが、シンボルでは瞬時に全体を比較できます (訳注: シンボルは内部的にはむしろ「固定桁の数値」であり、異なるシンボル同士の数値は重複しないことが保証されます)。これはハッシュのキーとして理想的な性質です。<a class="arrow" href="#cha-4_footnote-ref-10">↑</a>
</li>
    <li id="cha-4_footnote-11">実際には些細な違いがあり、<code>p</code>メソッドは画面出力だけでなく返り値もオブジェクトになります。しかし、<code>puts</code>メソッドの場合は引数によらず必ず<code>nil</code>が返り値になります。(指摘してくれたKatarzyna Siwekに感謝します。)<a class="arrow" href="#cha-4_footnote-ref-11">↑</a>
</li>
    <li id="cha-4_footnote-12">改行は、行の末尾と次の行の始まりを示します。コードの中では、<span class="inline_verbatim">\n</span>の文字列で表します。<a class="arrow" href="#cha-4_footnote-ref-12">↑</a>
</li>
    <li id="cha-4_footnote-13">もちろん、人間がいちいち文字数を<em>数えて</em>いたら頭がどうにかなってしまいます。だからこそ、多くのテキストエディタにはこれらを支援する機能が備わっています。たとえば、<a class="hyperref" href="beginning?version=4.2#fig-cloud9_gemfile"><span class="ref">図1.5</span></a>をもう一度見てみると、コードを80文字以下に抑えるための小さな縦線が右側に見えます。<a class="hyperref" href="beginning?version=4.2#sec-development_environment"><span class="ref">1.2.1</span></a>で紹介したCloud IDEでは、デフォルトでこのような行が含まれます。TextMateを使用していれば、<span class="tt">View &gt; Wrap Column &gt; 78</span>で設定できます。Sublime Textを使用していれば、<span class="tt">View &gt; Ruler &gt; 78</span>、または<span class="tt">View &gt; Ruler &gt; 80</span>で設定できます。<a class="arrow" href="#cha-4_footnote-ref-13">↑</a>
</li>
    <li id="cha-4_footnote-14">このメソッドの動作は、使用しているRubyのバージョンによって異なる可能性があります。この例ではRuby 1.9.3以上のバージョンを前提としています。<a class="arrow" href="#cha-4_footnote-ref-14">↑</a>
</li>
    <li id="cha-4_footnote-15">Rubyのクラスや<code>self</code>についてもっと詳しく知りたい場合は、<a href="http://railstips.org/" target="_blank">RailsTips</a>に投稿された “<a href="http://railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/" target="_blank">Rubyにおけるクラスとインスタンス変数</a>” (英語) を参照してください。<a class="arrow" href="#cha-4_footnote-ref-15">↑</a>
</li>
    <li id="cha-4_footnote-16">これらの階層にあるクラスの詳細を知る必要はないと思います。<em>私ですら</em>それらのクラスの詳細について知らないことがたくさんありますし、それでも私は2005年からRuby on Railsで問題なくプログラミングできています。これは (a)&nbsp;私がよほど無能であるか、(b) Railsの内部を知りつくさなくても熟練したRails開発者になれる、ということのどちらかでしょう。私のためにも読者の皆様のためにも、後者であることを祈ります。<a class="arrow" href="#cha-4_footnote-ref-16">↑</a>
</li>
  </ol>
</div>
          </div>
  </body>
</html>
