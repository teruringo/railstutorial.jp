<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
<div id="book">
            




            
            
            <div id="cha-sign_up" class="chapter" data-tralics-id="cid43" data-number="7" data-chapter="sign_up">
<h1><a href="#cha-sign_up" class="heading hyperref"><span class="number">第7章</span> ユーザー登録</a></h1>
<p>Userモデルができあがったので、いよいよユーザー登録機能を追加しましょう。<a class="hyperref" href="#sec-signup_form"><span class="ref">7.2</span></a>ではHTML<em>フォーム</em>を使用して登録情報をWebアプリケーションに送信します。続いて<a class="hyperref" href="#sec-successful_signups"><span class="ref">7.4</span></a>ではユーザーを新規作成して情報をデータベースに保存します。ユーザー登録手続きの最後には、作成されたユーザーの新しいプロファイルを表示できるようにするために、ユーザーを<em>表示する</em>ためのページを作成し、ユーザー用のRESTアーキテクチャを実装する第一歩を踏み出します (<a class="hyperref" href="toy_app?version=4.2#sec-mvc_in_action"><span class="ref">2.2.2</span></a>)。それに伴い、<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-layout_link_tests"><span class="ref">5.3.4</span></a>で実装した簡明かつ表現豊かな統合テストに対して、 いくつかのテストを追加していきます。</p>
<p>本章では、<a class="hyperref" href="modeling_users?version=4.2#cha-modeling_users"><span class="ref">第6章</span></a>で作成したUserモデルのバリデーションを信頼し、有効なメールアドレスを持っている (可能性のある) 新規ユーザーを増やしていきます。<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>では、 メールアドレスが<em>本当に</em>有効であることを確かめるために、<em>アカウントを有効化する</em>機能をサインアップの手順に追加します。</p>
</div><div id="sec-showing_users" class="section" data-tralics-id="cid44" data-number="7.1">
<h2><a href="#sec-showing_users" class="heading hyperref"><span class="number">7.1</span> ユーザーを表示する</a></h2>
<p>この節では、まずユーザーの名前とプロファイル写真を表示するためのページを作成します。モックアップを<a class="hyperref" href="#fig-profile_mockup_profile_name">図<span class="ref">7.1</span></a>に示しました<sup class="footnote" id="cha-7_footnote-ref-1"><a href="#cha-7_footnote-1">1</a></sup>。ユーザープロファイルページの最終的な目標は、<a class="hyperref" href="#fig-profile_mockup">図<span class="ref">7.2</span></a>のように<sup class="footnote" id="cha-7_footnote-ref-2"><a href="#cha-7_footnote-2">2</a></sup>ユーザーのプロファイル写真と基本ユーザーデータ、そしてマイクロポストの一覧を表示することです。(<a class="hyperref" href="#fig-profile_mockup">図<span class="ref">7.2</span></a>では、有名な<em>lorem ipsum</em>ダミーテキストを使用しています。このテキストの成り立ちには<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean" target="_blank">面白いエピソード</a>があるので機会がありましたらどうぞ。)このページを作成したら、<a class="hyperref" href="following_users?version=4.2#cha-following_users"><span class="ref">第12章</span></a>のサンプル・アプリケーションで使用する予定です。</p>
<p>バージョン管理を使用している場合は、いつもと同じようにトピックブランチを作成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div></div>
<div class="center figure" id="fig-profile_mockup_profile_name" data-tralics-id="uid620" data-number="7.1">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_mockup_profile_name_bootstrap.png" alt="images/figures/profile_mockup_profile_name_bootstrap"></div>
<div class="caption">
<span class="header">図7.1</span> <span class="description">この節で作成するユーザープロファイルのモックアップ
</span>
</div>
</div>
<div class="center figure" id="fig-profile_mockup" data-tralics-id="uid621" data-number="7.2">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_mockup_bootstrap.png" alt="images/figures/profile_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図7.2</span> <span class="description">理想とする最終的なプロファイルページのモックアップ
</span>
</div>
</div>
<div id="sec-rails_environments" class="subsection" data-tralics-id="uid622" data-number="7.1.1">
<h3><a href="#sec-rails_environments" class="heading hyperref"><span class="number">7.1.1</span> デバッグとRails環境</a></h3>
<p>この節で作成するプロファイルは、このアプリケーションにおける初めての真に動的なページになります。ビューそのものは1ページのコードですが、アプリケーションのデータベースから取り出した情報を使用して各プロファイルの表示をカスタマイズします。サンプルアプリケーションに動的なページを追加する準備として、ここでWebサイトのレイアウトにデバッグ情報を追加しましょう (<a class="hyperref" href="#code-rails_debug">リスト<span class="ref">7.1</span></a>)。これにより、ビルトインの<code>debug</code>メソッドと<code>params</code>変数を使用して、各プロファイルページにデバッグ用の情報が表示されるようになります (詳細については<a class="hyperref" href="#sec-a_users_resource"><span class="ref">7.1.2</span></a>で解説します)。</p>
<div class="codelisting" id="code-rails_debug" data-tralics-id="uid623" data-number="7.1">
<div class="heading">
<span class="number">リスト7.1:</span> 

<span class="description">サイトのレイアウトにデバッグ情報を追加する <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</span>    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
<p>本番環境に展開したアプリケーションではデバッグ情報を表示したくないので、<a class="hyperref" href="#code-rails_debug">リスト<span class="ref">7.1</span></a>には以下を記述してあります。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div></div>
<p class="noindent">こうしておくと、デバッグ情報はRailsの3つのデフォルト環境のうち、<em>開発環境</em>でしか表示されなくなります。(<a class="hyperref" href="#aside-rails_environments">コラム<span class="ref">7.1</span>)</a><sup class="footnote" id="cha-7_footnote-ref-3"><a href="#cha-7_footnote-3">3</a></sup>。特に、<code>Rails.env.development?</code>が<code>true</code>になるのは開発環境に限られるため、以下の埋め込みRubyは</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">本番アプリケーションやテストで挿入されることはありません。(テスト環境でデバッグ情報が表示されても直接問題になることはありませんが、よいことではありません。デバッグ情報は開発環境以外では使用すべきではありません。)</p>
<div class="aside" id="aside-rails_environments" data-tralics-id="uid625" data-number="7.1">
<div class="heading">
<span class="number">コラム7.1</span> 

<span class="description">Railsの3つの環境</span>
</div>
<p>Railsにはテスト環境 (<span class="tt">test</span>)、開発環境 (<span class="tt">development</span>)、そして本番環境 (<span class="tt">production</span>) の3つの環境がデフォルトで装備されています。Rails consoleのデフォルトの環境は<span class="tt">development</span>です。</p>
<pre class="verbatim">  $ rails console
  Loading development environment
  &gt;&gt; Rails.env
  =&gt; "development"
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?=&gt; false</pre>
<p class="noindent">上のように、Railsには<span class="tt">Rails</span>というオブジェクトがあり、それには環境の論理値 (boolean) を取る<span class="tt">env</span>という属性があります。たとえば、<span class="tt">Rails.env.test?</span>はテスト環境では<span class="tt">true</span>を返し、それ以外の環境では<span class="tt">false</span>を返します。</p>
<p>テスト環境のデバッグなど、他の環境でconsoleを実行する必要が生じた場合は、環境をパラメータとして<span class="tt">console</span>スクリプトに渡すことができます。</p>
<pre class="verbatim">  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; "test"
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>
<p>Railsサーバーではconsoleのデフォルトの環境として<span class="tt">development</span>が使用されますが、以下のように他の環境でconsoleを実行することもできます。</p>
<pre class="verbatim">$ rails server --environment production</pre>
<p class="noindent">アプリケーションを本番環境で実行する場合、本番のデータベースが利用できないとアプリケーションを実行できません。そのため、<span class="tt">rake db:migrate</span>を本番環境で実行して本番データベースを作成します。</p>
<pre class="verbatim">$ bundle exec rake db:migrate RAILS_ENV=production</pre>
<p class="noindent">(注: console、server、migrateの3つのコマンドでは、デフォルト以外の環境を指定する方法がそれぞれ異なっており、混乱を招く可能性があります。このため、3つの場合のすべてを本コラムで説明しました。)</p>
<p>ところで、サンプルアプリケーションを既にHeroku上にデプロイしている場合は、<span class="tt">heroku run console</span>というコマンドを打つことで、本番環境を確認することができます。</p>
<pre class="verbatim">  $ heroku run console
  &gt;&gt; Rails.env
  =&gt; "production"
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>
<p class="noindent">当然ながら、Herokuは本番サイト用のプラットフォームなので、実行されるアプリケーションはすべて本番環境となります。</p>

</div>
<p>デバッグ出力をきれいに整形するために、<a class="hyperref" href="filling_in_the_layout?version=4.2#cha-filling_in_the_layout"><span class="ref">第5章</span></a>で作成したカスタムスタイルシートを<span class="ref">リスト<a class="hyperref" href="#code-mixin_and_debug">7.2</a></span>のように追加します。</p>
<div class="codelisting" id="code-mixin_and_debug" data-tralics-id="uid626" data-number="7.2">
<div class="heading">
<span class="number">リスト7.2:</span> 

<span class="description">デバッグ表示を整形するための追加と、Sassのミックスイン <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap-sprockets"</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$gray-medium-light</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="hll"><span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
</span><span class="hll">  <span class="na">-moz-box-sizing</span><span class="o">:</span>    <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
</span><span class="hll">  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
</span><span class="hll">  <span class="na">box-sizing</span><span class="o">:</span>         <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="hll"><span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>
</span>
<span class="hll"><span class="nc">.debug_dump</span> <span class="p">{</span>
</span><span class="hll">  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
</span><span class="hll">  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
</span><span class="hll">  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span class="hll">  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
</span><span class="hll">  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span></pre></div></div>
</div>
<p class="noindent">ここでSassの<em>ミックスイン</em>機能 (ここでは<code>box_sizing</code>) を使用しています。ミックスイン機能を使用することで、CSSルールのグループをパッケージ化して複数の要素に適用することができます。たとえば以下のような変換を行います。</p>
<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div></div>
<p class="noindent">上を以下のように置き換えます。</p>
<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span>    <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span>         <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p class="noindent">ミックスインは<a class="hyperref" href="#sec-using_form_for"><span class="ref">7.2.1</span></a>でも使用します。今回の場合、デバッグ出力は<a class="hyperref" href="#fig-home_page_with_debug">図<span class="ref">7.3</span></a>のようになります。</p>
<div class="center figure" id="fig-home_page_with_debug" data-tralics-id="uid627" data-number="7.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/home_page_with_debug_3rd_edition.png" alt="images/figures/home_page_with_debug_3rd_edition"></div>
<div class="caption">
<span class="header">図7.3</span> <span class="description">サンプルアプリケーションのHomeページにデバッグ情報を表示する
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-home_page_with_debug">図<span class="ref">7.3</span></a>のデバッグ出力には、描画されるページの状態を把握するのに役立つ情報が含まれます。</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div></div>
<p class="noindent">これは<code>params</code>の内容で、YAML<sup class="footnote" id="cha-7_footnote-ref-4"><a href="#cha-7_footnote-4">4</a></sup>というものです。YAMLは基本的にハッシュであり、コントローラとページのアクションを一意に指定します。<a class="hyperref" href="#sec-a_users_resource"><span class="ref">7.1.2</span></a>には別の例もあります。</p>
</div>
<div id="sec-a_users_resource" class="subsection" data-tralics-id="uid629" data-number="7.1.2">
<h3><a href="#sec-a_users_resource" class="heading hyperref"><span class="number">7.1.2</span> Usersリソース</a></h3>
<p>ユーザープロファイルページを作成するには、その前にデータベースにユーザーが登録されている必要があります。これはいわゆる「卵が先か鶏が先か」問題です。このWebサイトでは、登録ページがない状態でどうやってユーザーを登録しておけばよいでしょうか。幸い、この問題は既に解決されています。<a class="hyperref" href="modeling_users?version=4.2#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>でRailsコンソールを使用してユーザーレコードを登録してありました。したがって、データベースの中に一人のユーザーがいるはずです。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 1</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2014-08-29 02:58:28", updated_at: "2014-08-29 02:58:28",</span>
<span class="go">password_digest: "$2a$10$YmQTuuDNOszvu5yi7auOC.F4G//FGhyQSWCpghqRWQW..."=&gt; 6</span>
</pre></div></div>
<p class="noindent">(もしまだデータベース上に一人もユーザーがいない場合は、<a class="hyperref" href="modeling_users?version=4.2#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>に戻ってユーザーを追加してください。) 先ほど、コンソールの出力結果からユーザーのIDが <code>1</code> であることを確認しました。次の目標は、このようなユーザー情報をWebアプリケーション上に表示することです。ここでは、Railsアプリケーションで好まれているRESTアーキテクチャ (<a class="hyperref" href="toy_app?version=4.2#aside-REST">コラム <span class="ref">2.2</span></a>) の習慣に従うことにしましょう。つまり、データを作成、表示、更新、削除可能な<em>リソース</em>として扱うということです。<a href="http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">HTTP標準</a>には、これらに対応する4つの基本操作 (<span class="tt">POST</span>、<span class="tt">GET</span>、<span class="tt">PATCH</span>、<span class="tt">DELETE</span>) が定義されています (<a class="hyperref" href="static_pages?version=4.2#aside-get_etc">コラム<span class="ref">3.2</span></a>)。</p>
<p>RESTの原則に従う場合、リソースへの参照はリソース名とユニークIDを使用するのが普通です。ユーザーを<em>リソース</em>とみなす場合、id=<code>1</code>のユーザーを参照するということは、/users/1というURLに対して<span class="tt">GET</span>リクエストを発行するということを意味します。ここで<code>show</code>というアクションの種類は、<em>暗黙</em>のリクエストになります。RailsのREST機能が有効になっていると、<span class="tt">GET</span>リクエストは自動的に<code>show</code>アクションとして扱われます。</p>
<p><a class="hyperref" href="toy_app?version=4.2#sec-a_user_tour"><span class="ref">2.2.1</span></a>で説明したとおり、id=<code>1</code>のユーザーにアクセスするためのページのURIは/users/1となります。ただし、現時点でこのURLを使用してもエラーになります (<a class="hyperref" href="#fig-profile_routing_error">図<span class="ref">7.4</span></a>)。</p>
<div class="center figure" id="fig-profile_routing_error" data-tralics-id="uid630" data-number="7.4">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_routing_error_3rd_edition.png" alt="images/figures/profile_routing_error_3rd_edition"></div>
<div class="caption">
<span class="header">図7.4: </span><span class="description">/users/1にアクセスした時のエラーログ
</span>
</div>
</div>
<p>/users/1 のURLを有効にするために、routesファイル (<code>config/routes.rb</code>)に以下の1行を追加します。</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div></div>
<p class="noindent">変更の結果を<a class="hyperref" href="#code-users_resource"><span class="ref">7.3</span></a>に示します。</p>
<div class="codelisting" id="code-users_resource" data-tralics-id="uid631" data-number="7.3">
<div class="heading">
<span class="number">リスト7.3:</span> 

<span class="description">Usersリソースをroutesファイルに追加する<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>             <span class="s1">'static_pages#home'</span>
  <span class="n">get</span> <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span> <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span> <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span> <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:users</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>今の短期的な目的はWebページ上にユーザーを表示することではありますが、<code>resources :users</code>という行は、動作する /users/1 URLを追加するためだけのものではありません。サンプルアプリケーションにこの行を追加すると、ユーザーのURLを生成するための多数の名前付きルート (<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-named_routes"><span class="ref">5.3.3</span></a>) と共に、RESTfulなUsersリソースで必要となる<em>すべての</em>アクションが利用できるようになります<sup class="footnote" id="cha-7_footnote-ref-5"><a href="#cha-7_footnote-5">5</a></sup>。この行に対応するURL、アクション、名前付きルートは<a class="hyperref" href="#table-RESTful_users"><span class="ref">表7.1</span></a>のようになります (<a class="hyperref" href="toy_app?version=4.2#table-demo_RESTful_users">表<span class="ref">2.2</span></a>との違いを比較してみてください)。次の3つの章に渡って、<a class="hyperref" href="#table-RESTful_users">表<span class="ref">7.1</span></a>の他の項目も利用して、Usersリソースを完全にRESTfulなリソースにするために必要なアクションをすべて作成する予定です。</p>
<div class="table" id="table-RESTful_users" data-tralics-id="uid633" data-number="7.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>HTTPリクエスト</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>アクション</strong></td>
<td class="align_left"><strong>名前付きルート</strong></td>
<td class="align_left"><strong>用途</strong></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>index</code></td>
<td class="align_left"><code>users_path</code></td>
<td class="align_left">すべてのユーザーを表示するページ</td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>show</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">特定のユーザーを表示するページ</td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/new</td>
<td class="align_left"><code>new</code></td>
<td class="align_left"><code>new_user_path</code></td>
<td class="align_left">ユーザーを新規作成するページ (ユーザー登録)</td>
</tr>
<tr>
<td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>create</code></td>
<td class="align_left"><code>users_path</code></td>
<td class="align_left">ユーザーを作成するアクション</td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left"><code>edit_user_path(user)</code></td>
<td class="align_left">id=<code>1</code>のユーザーを編集するページ
</td>
</tr>
<tr>
<td class="align_left"><span class="tt">PATCH</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>update</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">ユーザーを更新するアクション</td>
</tr>
<tr>
<td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">ユーザーを削除するアクション</td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表7.1</span> <span class="description"><a class="hyperref" href="#code-users_resource">リスト<span class="ref">7.3</span></a>のUsersリソースが提供するRESTfulなルート
</span>
</div>
</div>
<p><a class="hyperref" href="#code-users_resource">リスト<span class="ref">7.3</span></a>のコードを使用することで、ルーティングが有効になります。ただし、ルーティング先のページはまだありません (<a class="hyperref" href="#fig-user_show_unknown_action">図<span class="ref">7.5</span></a>)。この問題を解決するために、<a class="hyperref" href="#sec-a_gravatar_image"><span class="ref">7.1.4</span></a>で最小限のプロファイルページを作成する予定です。</p>
<div class="center figure" id="fig-user_show_unknown_action" data-tralics-id="uid634" data-number="7.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_show_unknown_action_3rd_edition.png" alt="images/figures/user_show_unknown_action_3rd_edition"></div>
<div class="caption">
<span class="header">図7.5</span> <span class="description">URL /users/1 のルーティングは有効だがページがない状態
</span>
</div>
</div>
<p>ユーザーを表示するために、標準的なRailsの場所を使用することにします。<code>app/views/users/show.html.erb</code>です。<a class="hyperref" href="filling_in_the_layout?version=4.2#code-generate_users_controller">リスト<span class="ref">5.28</span></a>でジェネレータを使用して作成した<code>new.html.erb</code>ビューと異なり、この<code>show.html.erb</code>ファイルは自動的には作成されないので、手動で作成します。このファイルを作成後、<a class="hyperref" href="#code-stub_user_view">リスト<span class="ref">7.4</span></a>の内容を貼り付けてください。</p>
<div class="codelisting" id="code-stub_user_view" data-tralics-id="uid635" data-number="7.4">
<div class="heading">
<span class="number">リスト7.4:</span> 

<span class="description">ユーザー情報を表示するための仮のビュー<span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">このビューでは埋め込みRubyを使用してユーザー名とメールアドレスを表示しています。インスタンス変数<code>@user</code>があることを前提としています。もちろん、ユーザー表示ページの最終的な状態はこれとは大きく異なりますし、このメールアドレスがこのまま一般に公開されるようなこともありません。</p>
<p>ユーザー表示ビューが正常に動作するためには、Usersコントローラ内の<code>show</code>アクションに対応する<code>@user</code>変数を定義する必要があります。ご想像のとおり、ここではUserモデルの<code>find</code>メソッド (<a class="hyperref" href="modeling_users?version=4.2#sec-finding_user_objects"><span class="ref">6.1.4</span></a>) を使用してデータベースからユーザーを取り出します。<a class="hyperref" href="#code-user_show_action">リスト<span class="ref">7.5</span></a>のように書き換えてください。</p>
<div class="codelisting" id="code-user_show_action" data-tralics-id="uid636" data-number="7.5">
<div class="heading">
<span class="number">リスト7.5:</span> 

<span class="description">Usersコントローラの<code>show</code>アクション<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ユーザーのid読み出しには<code>params</code>を使用しました。Usersコントローラにリクエストが正常に送信されると、<code>params[:id]</code>の部分はユーザーidの<span class="tt">1</span>に置き換わります。つまり、この箇所は<a class="hyperref" href="modeling_users?version=4.2#sec-finding_user_objects"><span class="ref">6.1.4</span></a>で学んだ<code>find</code>メソッドの <code>User.find(1)</code>と同じになります。(技術的な補足: <code>params[:id]</code>は文字列型の&nbsp;<code>"1"</code> ですが、<code>find</code>メソッドでは自動的に整数型に変換されます)。</p>
<p>ユーザーのビューとアクションが定義されたので、URL <a href="http://localhost:3000/users/1" target="_blank">/users/1</a> は完全に動作するようになりました (<a class="hyperref" href="#fig-user_show_rails">図<span class="ref">7.6</span></a>)。(もしbcrypt gemを追加してからまだ一度もRailsサーバを再起動させていない場合は、ここで再起動してください。) <a class="hyperref" href="#fig-user_show_rails">図<span class="ref">7.6</span></a>のデバッグ情報で<code>params[:id]</code>の値を確認できることにも注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">'1'</span>
</pre></div></div>
<p class="noindent">以下のコードを使用して</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">id=<span class="tt">1</span>のユーザーを検索できたのは以上の仕組みによるものです (<a class="hyperref" href="#code-user_show_action">リスト<span class="ref">7.5</span></a>)。</p>
<div class="center figure" id="fig-user_show_rails" data-tralics-id="uid637" data-number="7.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_show_3rd_edition.png" alt="images/figures/user_show_3rd_edition"></div>
<div class="caption">
<span class="header">図7.6</span> <span class="description">Usersリソース追加後ののユーザー表示ページ
</span>
</div>
</div>
</div>
<div id="sec-debugger" class="subsection" data-tralics-id="uid638" data-number="7.1.3">
<h3><a href="#sec-debugger" class="heading hyperref"><span class="number">7.1.3 </span>デバッガー</a></h3>
<p><a class="hyperref" href="#sec-a_users_resource"><span class="ref">7.1.2</span></a>で、アプリケーションの振る舞いを理解するために<code>デバッグ情報</code>が役に立つことを学びました。Rails 4.2からは、<span class="tt">byebug</span> gemを使ってもっと直接的にデバッグできるようになりました (<a class="hyperref" href="static_pages?version=4.2#code-gemfile_sample_app">リスト<span class="ref">3.2</span></a>)。どういう風にデバッグできるようになったのか、<code>デバッガー</code>をアプリケーションに差し込んで実際に確かめてみましょう (<a class="hyperref" href="#code-debugger">リスト<span class="ref">7.6</span></a>)。</p>
<div class="codelisting" id="code-debugger" data-tralics-id="uid639" data-number="7.6">
<div class="heading">
<span class="number">リスト7.6:</span> 

<span class="description">デバッガーをUsersコントローラに差し込む<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="n">debugger</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のようにdebuggerを差し込んだ後に /users/1 にアクセスしてみると、Railsサーバが<code>byebug</code>のプロンプトを表示するようになります。</p>
<div class="code"><div class="highlight"><pre><span class="go">(byebug)</span>
</pre></div></div>
<p class="noindent">ここではRailsコンソールのようにコマンドを呼び出すことができて、アプリケーションの今の状態を確認することができます。</p>
<div class="code"><div class="highlight"><pre><span class="go">(byebug) @user.name</span>
<span class="go">"Example User"</span>
<span class="go">(byebug) @user.email</span>
<span class="go">"example@railstutorial.org"</span>
<span class="go">(byebug) params[:id]</span>
<span class="go">"1"</span>
</pre></div></div>
<p class="noindent">Ctrl-Dを押すとプロンプトから抜け出すことができます。また、デバッグが終わったら<code>show</code>アクション内の<code>debugger</code>の行を削除してしまいましょう (<a class="hyperref" href="#code-debugger_removed">リスト<span class="ref">7.7</span></a>)。</p>
<div class="codelisting" id="code-debugger_removed" data-tralics-id="uid640" data-number="7.7">
<div class="heading">
<span class="number">リスト7.7:</span> 

<span class="description">デバッガーをUsersコントローラーから取り外す<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>今後Railsアプリケーションの中でよく分からない挙動があったら、上のように<code>debugger</code>を差し込んで調べてみましょう。トラブルが起こっていそうなコードの近くに差し込むのがコツです。<span class="tt">byebug</span>を使ってシステムの状態を調査することは、アプリケーション内のエラーを追跡したりデバッグするときに非常に強力なツールになります。</p>
</div>
<div id="sec-a_gravatar_image" class="subsection" data-tralics-id="uid641" data-number="7.1.4">
<h3><a href="#sec-a_gravatar_image" class="heading hyperref"><span class="number">7.1.4</span> Gravatar画像とサイドバー</a></h3>
<p>前節で基本的なユーザーページの定義は終わりましたので、今度は各ユーザーのプロファイル写真のあたりをもう少し肉付けし、サイドバーも作り始めましょう。ここでは世界共通のアバターとして認識されている「<a href="http://gravatar.com/" target="_blank">Gravatar</a>」をユーザープロファイルに導入してみましょう<sup class="footnote" id="cha-7_footnote-ref-6"><a href="#cha-7_footnote-6">6</a></sup>。Gravatarは無料のサービスで、プロファイル写真をアップロードして、指定したメールアドレスと関連付けることができます。Gravatarは、プロファイル写真をアップロードするときの面倒な作業や、写真が欠けたりなどのトラブル、置き場所の悩みを解決します。ユーザーのメールアドレスを組み込んだGravatar専用の画像パスを構成するだけで、対応するGravatarの画像が自動的に表示されます (カスタム画像を扱う方法については<a class="hyperref" href="user_microposts?version=4.2#sec-micropost_images"><span class="ref">11.4</span></a>で扱います)。</p>
<p>ここでは、<a class="hyperref" href="#code-user_show_view_with_gravatar">リスト<span class="ref">7.8</span></a>のように<code>gravatar_for</code>ヘルパーメソッドを使用してGravatarの画像を利用できるようにします。</p>
<div class="codelisting" id="code-user_show_view_with_gravatar" data-tralics-id="uid643" data-number="7.8">
<div class="heading">
<span class="number">リスト7.8:</span> 

<span class="description">ユーザー表示ビューに名前とGravatarを表示する<span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div></div>
</div>
<p>デフォルトでは、ヘルパーファイルで定義されているメソッドは自動的にすべてのビューで利用できます。ここでは、利便性を考えて<code>gravatar_for</code>をUsersコントローラに関連付けられているヘルパーファイルに置くことにしましょう。<a href="http://en.gravatar.com/site/implement/hash/" target="_blank">Gravatarのホームページ</a>にも書かれているように、GravatarのURLは<a href="http://ja.wikipedia.org/wiki/MD5" target="_blank">MD5ハッシュ</a>を用いてユーザーのメールアドレスをハッシュ化しています。Rubyでは、<code>Digest</code>ライブラリの<code>hexdigest</code>メソッドを使用したMD5ハッシュアルゴリズムが実装されています。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">"MHARTL@example.COM"</span><span class="o"></span>
<span class="hll"><span class="gp">&gt;&gt; </span><span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="go">=&gt; "1fda4469bcbec3badf5418269ffc5968"</span>
</pre></div></div>
<p class="noindent">メールアドレスは大文字と小文字を区別しませんが (<a class="hyperref" href="modeling_users?version=4.2#sec-format_validation"><span class="ref">6.2.4</span></a>)、MD5ハッシュでは大文字と小文字が区別されるので、Rubyの<code>downcase</code>メソッドを使用して<code>hexdigest</code>の引数を小文字に変換しています。(本チュートリアルでは、<a class="hyperref" href="modeling_users?version=4.2#code-email_downcase">リスト<span class="ref">6.31</span></a>のコールバック処理で小文字変換されたメールアドレスを利用しているため、ここで小文字変換を入れなくても結果は同じです。ただし、将来<code>gravatar_for</code>メソッドが別の場所から呼びだされる可能性を考えると、ここで小文字変換を入れることには意義があります。) <code>gravatar_for</code>ヘルパーを組み込んだ結果を<a class="hyperref" href="#code-gravatar_for_helper">リスト<span class="ref">7.9</span></a>に示しました。</p>
<div class="codelisting" id="code-gravatar_for_helper" data-tralics-id="uid644" data-number="7.9">
<div class="heading">
<span class="number">リスト7.9:</span> 

<span class="description"><code>gravatar_for</code>ヘルパーメソッドを定義する<span class="break"></span> <span class="filepath">app/helpers/users_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># 引数で与えられたユーザーのGravatar画像を返す</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-gravatar_for_helper">リスト<span class="ref">7.9</span></a>のコードは、Gravatarの画像タグに<code>gravatar</code>クラスとユーザー名のaltテキストを追加したものを返します (altテキストを追加しておくと、視覚障害のあるユーザーがスクリーンリーダーを使用するときにも役に立ちます)。</p>
<p>プロフィールページは<a class="hyperref" href="#fig-profile_with_gravatar">図<span class="ref">7.7</span></a>のようになります。ここにはデフォルトのGravatar画像が表示されていますが、これはデフォルトのメールアドレス<code>user@example.com</code>が本当のメールアドレスではないためです。(ちなみに<a href="http://www.example.com/" target="_blank">example.com</a>というドメイン名は、例として使用するために特別に予約されたドメインとなっています)</p>
<div class="center figure" id="fig-profile_with_gravatar" data-tralics-id="uid645" data-number="7.7">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_with_gravatar_3rd_edition.png" alt="images/figures/profile_with_gravatar_3rd_edition"></div>
<div class="caption">
<span class="header">図7.7</span> <span class="description">ユーザー表示ページにGravatarのデフォルト画像が表示されている
</span>
</div>
</div>
<p>アプリケーションでカスタムGravatarを利用できるようにするために、<code>update_attributes</code> (<a class="hyperref" href="modeling_users?version=4.2#sec-updating_user_objects"><span class="ref">6.1.5</span></a>) を使用してデータベース上のユーザー情報を更新します。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">ここではユーザーのメールアドレスに <code>example@railstutorial.org</code> を使用しました (<a class="hyperref" href="#fig-profile_custom_gravatar">図<span class="ref">7.8</span></a>)。このメールアドレスはRailsチュートリアルのロゴでも使用されています。</p>
<div class="center figure" id="fig-profile_custom_gravatar" data-tralics-id="uid646" data-number="7.8">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/profile_custom_gravatar_3rd_edition.png" alt="images/figures/profile_custom_gravatar_3rd_edition"></div>
<div class="caption">
<span class="header">図7.8: </span><span class="description">ユーザー表示ページにGravatarのカスタム画像が表示されている
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-profile_mockup_profile_name">図<span class="ref">7.1</span></a>のモックアップに近づけるために、ユーザーのサイドバーの最初のバージョンを作りましょう。ここでは<code>aside</code>タグを使用して実装します。このタグはサイドバーなどの補完コンテンツの表示に使用されますが、単独で表示することもできます。<code>row</code>クラスと<code>col-md-4</code>クラスも追加しておきます。これらのクラスはBootstrapの一部です。ユーザー表示ページを変更した結果を<a class="hyperref" href="#code-user_show_with_sidebar">リスト<span class="ref">7.10</span></a>に示します。</p>
<div class="codelisting" id="code-user_show_with_sidebar" data-tralics-id="uid647" data-number="7.10">
<div class="heading">
<span class="number">リスト7.10:</span> 

<span class="description">ユーザーの<code>show</code>ビューにサイドバーを追加する<span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p>HTML要素とCSSクラスを配置したことにより、プロフィールページ (とサイドバーとGravatar) にSCSSで<a class="hyperref" href="#code-sidebar_css">リスト<span class="ref">7.11</span></a>のようにスタイルを与えることができるようになりました<sup class="footnote" id="cha-7_footnote-ref-7"><a href="#cha-7_footnote-7">7</a></sup>。(テーブルCSSのルールがネスティング (入れ子) されていますが、これが有効になるのはAsset PipelineでSassエンジンが使用されている場合に限られます) 。ページの変更の結果を<a class="hyperref" href="#fig-user_show_sidebar_css">図<span class="ref">7.9</span></a>に示します。</p>
<div class="codelisting" id="code-sidebar_css" data-tralics-id="uid649" data-number="7.11">
<div class="heading">
<span class="number">リスト7.11:</span> 

<span class="description"> SCSSを使用してサイドバーなどのユーザー表示ページにスタイルを与える<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span><span class="nc">.user_info</span> <span class="p">{</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.gravatar_edit</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-user_show_sidebar_css" data-tralics-id="uid650" data-number="7.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_show_sidebar_css_3rd_edition.png" alt="images/figures/user_show_sidebar_css_3rd_edition"></div>
<div class="caption">
<span class="header">図7.9</span> <span class="description">ユーザー表示ページにサイドバーとCSSを追加する</span>
</div>
</div>
</div>
</div><div id="sec-signup_form" class="section" data-tralics-id="cid45" data-number="7.2">
<h2><a href="#sec-signup_form" class="heading hyperref"><span class="number">7.2</span> ユーザー登録フォーム</a></h2>
<p>ここまででユーザープロファイルページがひとまず動作するようになりましたので、今度はユーザー登録フォームを作成しましょう。<a class="hyperref" href="filling_in_the_layout?version=4.2#fig-new_signup_page">図<span class="ref">5.9</span></a> (<a class="hyperref" href="#fig-blank_signup_page_recap">図<span class="ref">7.10</span></a>にも再録) に示したとおり、ユーザー登録ページはまだ空白のままなので、このままではユーザー登録できません。この節の目標は、このみっともないページを改造して<a class="hyperref" href="#fig-signup_mockup">図<span class="ref">7.11</span></a>のモックアップのようなページに変えることです。</p>
<div class="center figure" id="fig-blank_signup_page_recap" data-tralics-id="uid651" data-number="7.10">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/new_signup_page_3rd_edition.png" alt="images/figures/new_signup_page_3rd_edition"></div>
<div class="caption">
<span class="header">図7.10</span> <span class="description">現状のユーザー登録ページ  <a href="http://localhost:3000/signup" target="_blank">/signup</a>
</span>
</div>
</div>
<div class="center figure" id="fig-signup_mockup" data-tralics-id="uid652" data-number="7.11">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_mockup_bootstrap.png" alt="images/figures/signup_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図7.11</span> <span class="description">ユーザー登録ページのモックアップ
</span>
</div>
</div>
<p>Web経由でユーザーを作成する機能をこれから追加しますので、<a class="hyperref" href="modeling_users?version=4.2#sec-creating_and_authenticating_a_user"><span class="ref">6.3.4</span></a>で作成したユーザーをここで削除しておきましょう。最も簡単な方法は、Rakeの<code>db:migrate:reset</code>タスクを実行してデータベースをリセットすることです。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
</pre></div></div>
<p class="noindent">最後に、システムによっては変更を反映するためにターミナル上でCtrl-Cを押してWebサーバーを再起動する必要が生じることもあります。</p>
<div id="sec-using_form_for" class="subsection" data-tralics-id="uid653" data-number="7.2.1">
<h3><a href="#sec-using_form_for" class="heading hyperref"><span class="number">7.2.1</span> <span class="tt">form_for</span>を使用する</a></h3>
<p>ユーザー登録ページで重要な点は、ユーザー登録に欠かせない情報を入力するための<em>form</em>です。これを行うには、Railsで<code>form_for</code>ヘルパーメソッドを使用します。このメソッドはActive Recordオブジェクトを取り込み、オブジェクトの属性を使用してフォームを構成します。</p>
<p>ユーザー登録ページ /signup のルーティングは、Usersコントローラーの<code>new</code>アクションに既に紐付けられていることを思い出してください (<a class="hyperref" href="filling_in_the_layout?version=4.2#code-signup_route">リスト<span class="ref">5.33</span></a>)。したがって、次のステップは、 <code>form_for</code>の引数で必要となるUserオブジェクトを作成することになります。必要となる<code>@user</code>変数の定義は、以下の<a class="hyperref" href="#code-new_action_with_user">リスト<span class="ref">7.12</span></a>のようになります。</p>
<div class="codelisting" id="code-new_action_with_user" data-tralics-id="uid654" data-number="7.12">
<div class="heading">
<span class="number">リスト7.12:</span> 

<span class="description"><code>new</code>アクションに<code>@user</code>変数を追加する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>フォームそのものは<a class="hyperref" href="#code-signup_form">リスト<span class="ref">7.13</span></a>で示します。<a class="hyperref" href="#sec-the_form_html"><span class="ref">7.2.2</span></a>で詳細について触れますが、まずは<a class="hyperref" href="#code-form_css">リスト<span class="ref">7.14</span></a>のSCSSで見栄えを整えてみましょう。<code>box_sizing</code>ミックスインを<a class="hyperref" href="#code-mixin_and_debug">リスト<span class="ref">7.2</span></a>から再利用していることに注目してください。これらのCSSルールが一度適用されると、ユーザー登録ページは<a class="hyperref" href="#fig-signup_form">図<span class="ref">7.12</span></a>のようになります.</p>
<div class="codelisting" id="code-signup_form" data-tralics-id="uid655" data-number="7.13">
<div class="heading">
<span class="number">リスト7.13:</span> 

<span class="description">新規ユーザーのためのユーザー登録フォーム<span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-form_css" data-tralics-id="uid656" data-number="7.14">
<div class="heading">
<span class="number">リスト7.14:</span> 

<span class="description">ユーザー登録フォームのCSS<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span> <span class="p">{</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span> <span class="nv">!important</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-signup_form" data-tralics-id="uid657" data-number="7.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_form_3rd_edition.png" alt="images/figures/signup_form_3rd_edition"></div>
<div class="caption">
<span class="header">図7.12: </span><span class="description">ユーザー登録フォーム
</span>
</div>
</div>
</div>
<div id="sec-the_form_html" class="subsection" data-tralics-id="uid658" data-number="7.2.2">
<h3><a href="#sec-the_form_html" class="heading hyperref"><span class="number">7.2.2 </span>フォームHTML</a></h3>
<p><a class="hyperref" href="#code-signup_form">リスト<span class="ref">7.13</span></a>で定義したフォームを理解するために、小さなコードに分けて考えてみましょう。まずは、埋め込みRubyが使われている<code>form_for</code>から<code>end</code>までの外側の構造を読み解いていきます。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent"><code>do</code>キーワードは、 <code>form_for</code>が1つの変数を持つブロックを取ることを表します。この変数<code>f</code>は “form” のfです。</p>
<p>通常、Railsヘルパーを使用している場合、実装の詳細について知っておく必要はありません。ただし<code>f</code>というオブジェクトが<em>何をするのかは知っておく</em>必要があります。この<code>f</code>オブジェクトは、<a href="http://www.w3schools.com/html/html_forms.asp" target="_blank">HTMLフォーム要素</a> (テキストフィールド、ラジオボタン、パスワードフィールドなど) に対応するメソッドが呼び出されると、<code>@user</code>の属性を設定するために特別に設計されたHTMLを返します。つまり、以下のコードを実行すると、</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">Userモデルの<code>name</code>属性を設定する、ラベル付きテキストフィールド要素を作成するのに必要なHTMLを作成します</p>
<p>生成されたフォームのHTMLを見たい場合は、ブラウザ上で表示画面を右クリックし、出てきたポップアップ項目の中から [ソースを表示] といった項目をクリックしてください。WebページのHTMLソースは<a class="hyperref" href="#code-signup_form_html">リスト<span class="ref">7.15</span></a>のようになります。HTMLソースの中の、フォームを形成するHTML構造に注目してみましょう。</p>
<div class="codelisting" id="code-signup_form_html" data-tralics-id="uid659" data-number="7.15">
<div class="heading">
<span class="number">リスト7.15:</span> 

<span class="description"><a class="hyperref" href="#fig-signup_form">図<span class="ref">7.12</span></a>のフォームのHTMLソース</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span>
      <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"utf8"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"&amp;#x2713;"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span>
         <span class="na">value=</span><span class="s">"NNb6+J/j46LcrgYUC60wQ2titMuJQ5lLqyAbnbAUkdo="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"email"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password_confirmation"</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password_confirmation"</span>
         <span class="na">name=</span><span class="s">"user[password_confirmation]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
         <span class="na">value=</span><span class="s">"Create my account"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
</div>
<p class="noindent">まずはこのHTMLソースの内部構造について説明します。<a class="hyperref" href="#code-signup_form">リスト<span class="ref">7.13</span></a>と<a class="hyperref" href="#code-signup_form_html">リスト<span class="ref">7.15</span></a>をじっくり見比べてみると、以下の埋め込みRubyは</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">以下のHTMLを生成していることがわかります。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent">また、以下の埋め込みRubyは</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">以下のHTMLを生成していることがわかります。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"email"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent">さらに、以下のコードは</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">以下のHTMLを生成していることがわかります。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent">次の<a class="hyperref" href="#fig-filled_in_form">図<span class="ref">7.13</span></a>に示すように、テキストフィールド (<code>type="text"</code>と<code>type="email"</code>) では内容をそのまま表示していますが、パスワードフィールド (<code>type="password"</code>) ではセキュリティ上の目的のために文字が隠蔽されています (<a class="hyperref" href="#fig-filled_in_form">図<span class="ref">7.13</span></a>)。(emailフィールドとtextフィールドは同じように見えますが、細かな点が違います。たとえば、<code>type="email"</code>となっている場合、モバイル端末から入力フォームをタップすると、メールアドレスに最適化された特別なキーボードが表示されるようになります。)</p>
<div class="center figure" id="fig-filled_in_form" data-tralics-id="uid660" data-number="7.13">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/filled_in_form_bootstrap_3rd_edition.png" alt="images/figures/filled_in_form_bootstrap_3rd_edition"></div>
<div class="caption">
<span class="header">図7.13</span> <span class="description"><code>text</code>フィールドと<code>password</code>フィールドに文字を入力した状態
</span>
</div>
</div>
<p><a class="hyperref" href="#sec-successful_signups"><span class="ref">7.4</span></a>でも説明しますが、ユーザーの作成で重要なのは<code>input</code>ごとにある特殊な<code>name</code>属性です。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent">Railsはこれらの<code>name</code>の値を使用して、初期化ハッシュを (<code>params</code>変数経由で) 構成します。このハッシュは、ユーザーが入力した値に基づいてユーザーを作成するとき (<a class="hyperref" href="#sec-unsuccessful_signups"><span class="ref">7.3</span></a>) に使用されます。</p>
<p>次に重要な要素は、<code>form</code>タグ自身です。Railsは<code>form</code>タグを作成するときに<code>@user</code>オブジェクトを使用します。すべてのRubyオブジェクトは自分のクラスを知っている (<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-constructors"><span class="ref">4.4.1</span></a>) ので、Railsは<code>@user</code>のクラスが<code>User</code>であることを知ることができます。また、<code>@user</code>は<em>新しい</em>ユーザーなので、 Railsは<code>post</code>メソッドを使用してフォームを構成する方法を知っています。これは新しいオブジェクトを作成するための正式な動詞 (verb) です (<a class="hyperref" href="static_pages?version=4.2#aside-get_etc">コラム<span class="ref">3.2</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div></div>
<p class="noindent">ここで<code>class</code>と<code>id</code>属性はほぼ無関係です。ここで重要な属性は<code>action="/users"</code>と<code>method="post"</code>です。これらの2つの属性は、HTTP <span class="tt">POST</span>リクエストに対する指示を構成しています。これらの属性の効用については次の2つの節で説明します。</p>
<p>ところで、<code>form</code> タグの内側で次のようなHTMLが生成されていたことにもお気付きでしょうか。</p>
<div class="code"><div class="highlight"><pre>  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"display:none"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"utf8"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"&amp;#x2713;"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span>
           <span class="na">value=</span><span class="s">"NNb6+J/j46LcrgYUC60wQ2titMuJQ5lLqyAbnbAUkdo="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
</pre></div></div>
<p class="noindent">このコードはブラウザ上では何も表示しませんが、Railsの内部で使用される特別なコードです。 したがって、どういった意図で生成されたのかは、現時点ではまだ理解しなくても大丈夫です。簡潔にまとめると、Unicode文字の「<code>&amp;#x2713;</code> (チェックマーク&nbsp;✓)」を使ってブラウザが正しい文字コードで送信できるようにしたり、 <em>Cross-Site Request Forgery (CSRF)</em>と呼ばれる攻撃を阻止するために<em>信頼できるトークン</em>を含めたりしています<sup class="footnote" id="cha-7_footnote-ref-8"><a href="#cha-7_footnote-8">8</a></sup>。</p>
</div>
</div><div id="sec-unsuccessful_signups" class="section" data-tralics-id="cid46" data-number="7.3">
<h2><a href="#sec-unsuccessful_signups" class="heading hyperref"><span class="number">7.3 </span>ユーザー登録失敗</a></h2>
<p><a class="hyperref" href="#fig-signup_form">図<span class="ref">7.12</span></a>ではフォームのHTMLがどうなっているかを簡単に説明しました (<a class="hyperref" href="#code-signup_form_html">リスト<span class="ref">7.15</span></a>参照) が、フォームを理解するには<em>ユーザー登録の失敗のとき</em>が最も参考になります。この節では、無効なデータ送信を受け付けるユーザー登録フォームを作成し、ユーザー登録フォームを更新してエラーの一覧を表示します。このモックアップを<a class="hyperref" href="#fig-signup_failure_mockup">図<span class="ref">7.14</span></a>に示します。</p>
<div class="center figure" id="fig-signup_failure_mockup" data-tralics-id="uid662" data-number="7.14">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_failure_mockup_bootstrap.png" alt="images/figures/signup_failure_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図7.14</span> <span class="description">ユーザー登録が失敗したときのモックアップ
</span>
</div>
</div>
<div id="sec-a_working_form" class="subsection" data-tralics-id="uid663" data-number="7.3.1">
<h3><a href="#sec-a_working_form" class="heading hyperref"><span class="number">7.3.1</span> 正しいフォーム</a></h3>
<p><a class="hyperref" href="#sec-a_users_resource"><span class="ref">7.1.2</span></a>で、<code>resources :users</code>を<code>routes.rb</code>ファイルに追加すると (<a class="hyperref" href="#code-users_resource">リスト<span class="ref">7.3</span></a>) 自動的にRailsアプリケーションが<a class="hyperref" href="#table-RESTful_users">表<span class="ref">7.1</span></a>のRESTful URI に応答するようになったことを思い出してください。特に、/usersへの<span class="tt">POST</span>リクエストは<code>create</code>アクションに送られます。私たちはここで、<code>create</code>アクションでフォーム送信を受け取り、<code>User.new</code>を使用して新しいユーザーオブジェクトを作成し、ユーザーを保存 (または保存に失敗) し、再度の送信用のユーザー登録ページを表示するという方法で機能を実装しようと思います。まずはユーザー登録フォームのコードを見直してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#sec-the_form_html"><span class="ref">7.2.2</span></a>で説明したように、このHTMLは<span class="tt">POST</span>リクエストを/usersというURLに送信します。</p>
<p>ユーザー登録フォームを動かすために、まず<a class="hyperref" href="#code-first_create_action">リスト<span class="ref">7.16</span></a>にようにコードを追加するところから始めます。このリストでは、<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-partials"><span class="ref">5.1.3</span></a>の「パーシャル」のところでも使った<code>render</code>メソッドを再度使いまわしています。<code>render</code>はコントローラのアクションの中でも正常に動作します。ここで、以前に説明した<code>if</code>-<code>else</code>分岐構造を思い出してください。この文を使用して、保存が成功したかどうかに応じて<code>@user.save</code>の値が<code>true</code>または<code>false</code> (<a class="hyperref" href="modeling_users?version=4.2#sec-creating_user_objects"><span class="ref">6.1.3</span></a>) になるときに、それぞれ成功時の処理と失敗時の処理を場合分けすることができます。</p>
<div class="codelisting" id="code-first_create_action" data-tralics-id="uid664" data-number="7.16">
<div class="heading">
<span class="number">リスト7.16:</span> 

<span class="description">ユーザー登録の失敗に対応できる<code>create</code>アクション <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># 実装は終わっていないことに注意!</span>
</span>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">コメントにもあるように、上のコードはまだ実装が完了していませんので注意してください。しかし実装の出発点としてはこれで十分です。なお、最終的な実装は<a class="hyperref" href="#sec-strong_parameters"><span class="ref">7.3.2</span></a>で完了します。</p>
<p><a class="hyperref" href="#code-first_create_action">リスト<span class="ref">7.16</span></a>のコードの動作を理解するもっともよい方法は、実際に無効なユーザー登録データを<em>送信 (submit)</em>してみることです。結果を<a class="hyperref" href="#fig-signup_failure">図<span class="ref">7.15</span></a>に、また、すべてのデバッグ情報を<a class="hyperref" href="#fig-signup_failure_rails_debug">図<span class="ref">7.16</span></a>に示しました (読みやすいようにフォントサイズを拡大しています)。(<a class="hyperref" href="#fig-signup_failure">図<span class="ref">7.15</span></a>の下部に見えているのがRailsの<em>web console</em>という機能です。これはrails consoleをブラウザ上で開けるようにし、デバッグをしやすくするための機能です。たとえばUserモデルを調べたいときなどには便利ですが、今のところは <code>params</code>の中身を精査するなどの込み入ったことはできません。)</p>
<div class="center figure" id="fig-signup_failure" data-tralics-id="uid665" data-number="7.15">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_failure_3rd_edition.png" alt="images/figures/signup_failure_3rd_edition"></div>
<div class="caption">
<span class="header">図7.15</span> <span class="description">ユーザー登録失敗
</span>
</div>
</div>
<div class="center figure" id="fig-signup_failure_rails_debug" data-tralics-id="uid666" data-number="7.16">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_failure_debug_3rd_edition.png" alt="images/figures/signup_failure_debug_3rd_edition"></div>
<div class="caption">
<span class="header">図7.16</span> <span class="description">ユーザー登録失敗時のデバッグ情報
</span>
</div>
</div>
<p>Railsが送信を扱う方法をより深く理解するために、デバッグ情報のうちパラメーターハッシュの<code>user</code>の部分を詳しく見てみましょう (<a class="hyperref" href="#fig-signup_failure_rails_debug">図<span class="ref">7.16</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Foo Bar"</span><span class="p">,</span>
            <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
            <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span><span class="p">,</span>
            <span class="s2">"password_confirmation"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span>
          <span class="p">}</span>
</pre></div></div>
<p class="noindent">このハッシュはUsersコントローラに<code>params</code>として渡されます。<a class="hyperref" href="#sec-a_users_resource"><span class="ref">7.1.2</span></a>で説明したとおり、この<code>params</code>ハッシュには各リクエストの情報が含まれています。/users/1のようなURLの場合、<code>params[:id]</code>の値は該当するユーザーの<code>id</code> (この例では<code>1</code>) になります。ユーザー登録情報の送信の場合、<code>params</code>には複数のハッシュに対するハッシュ (hash-of-hashes: 入れ子になったハッシュ) が含まれます (なお、<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>ではhash-of-hashesの説明とともに、コンソールセッションで使用するためにあえて<code>params</code>という名前の変数を導入しました)。上のデバッグ情報では、フォーム送信の結果が、送信された値に対応する属性とともに<code>user</code>ハッシュに保存されています。ハッシュのキーは、<code>input</code>タグの<code>name</code>属性です (<a class="hyperref" href="#code-signup_form">リスト<span class="ref">7.17</span></a>)。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"email"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent"><code>"user[email]"</code>という名前は、<code>user</code>ハッシュの<code>email</code>属性を正確に指します。</p>
<p>ハッシュのキーはデバッグ情報では文字列として表現されていますが、Railsはこれらを文字列ではなく、<code>params[:user]</code>がuser属性のハッシュになるような「シンボル」(Rubyの機能の1つで、一意性が保証された特別な文字列) としてUsersコントローラに渡します。実際、<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>で初めて使われ、<a class="hyperref" href="#code-first_create_action">リスト<span class="ref">7.21</span></a>でも使用されていたように、これらのハッシュは<code>User.new</code>の引数として必要な属性と正確に一致します。これはつまり、以下の行は</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">以下とほぼ等価であるということです。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div></div>
<p>以前のバージョンのRailsでは、以下のコードは</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">実際に動作しましたが、動作はデフォルトで不安定であり、悪意のあるユーザーによってアプリケーションのデータベースが書き換えられることのないように慎重な手続きによって使用しなければならず、しかもその手続はエラーを起こしやすいものでした。Rails 4.0以降では、上のコードはエラーになります (上の<a class="hyperref" href="#fig-signup_failure">図<span class="ref">7.15</span></a>および<a class="hyperref" href="#fig-signup_failure_rails_debug">図<span class="ref">7.16</span></a>を参照)。これにより、デフォルトでのセキュリティが高められました。</p>
</div>
<div id="sec-strong_parameters" class="subsection" data-tralics-id="uid667" data-number="7.3.2">
<h3><a href="#sec-strong_parameters" class="heading hyperref"><span class="number">7.3.2</span> Strong parameters</a></h3>
<p><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-a_user_class"><span class="ref">4.4.5</span></a>で、<em>マスアサインメント</em>の概念について簡単に説明しました。これは、以下のように値のハッシュを使用してRubyの変数を初期化するものです。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># 実装は終わっていないことに注意!</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-first_create_action">リスト<span class="ref">7.16</span></a>のコメントと、上の再録コメントでも重ねて指摘しているように、この実装は最終形ではありません。その理由は、<code>params</code>ハッシュ全体を初期化するという行為はセキュリティ上、<em>極めて</em>危険だからです。これは、ユーザーが送信したデータを<em>まるごと</em><code>User.new</code>に渡していることになります。ここで、Userモデルに<code>admin</code>属性というものがあるとしましょう。この属性は、Webサイトの管理者であるかどうかを示します(この属性を実装するのは<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-administrative_users"><span class="ref">9.4.1</span></a>になってからです)。<code>admin=’1’</code>という値を<code>params[:user]</code>の一部に紛れ込ませて渡してしまえば、この属性を<code>true</code>にすることができます。これは<span class="tt">curl</span>などのコマンドベースのHTTPクライアントを使用すれば簡単に行うことができます。<code>params</code>ハッシュがまるごと<code>User.new</code>に渡されてしまうと、どのユーザーでも<code>admin=’1’</code>をWebリクエストに紛れ込ませるだけでWebサイトの管理者権限を奪い取ることができてしまいます。</p>
<p>以前のバージョンのRailsでは、<code>モデル</code>層で<em>attr_accessible</em>メソッドを使用することで上のような危険を防止していましたが、 Rails 4.0ではコントローラ層で<em>Strong Parameters</em>というテクニックを使用することが推奨されています。Strong Parametersを使用することで、<em>必須</em>のパラメータと<em>許可された</em>パラメータを指定することができます。さらに、上のように<code>params</code>ハッシュをまるごと渡すとエラーが発生するので、Railsはデフォルトでマスアサインメントの脆弱性から守られるようになりました。</p>
<p>この場合、<code>params</code>ハッシュでは<code>:user</code>属性を必須とし、名前、メールアドレス、パスワード、パスワードの確認の属性をそれぞれ許可し、それ以外を許可しないようにしたいと考えています。これは、以下のように記述することで行うことができます。</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このコードの戻り値は、<code>params</code>ハッシュのバージョンと、許可された属性です (<code>:user</code>属性がない場合はエラーになります)。</p>
<p>これらのパラメータを使いやすくするために、<code>user_params</code>という外部メソッドを使用するのが慣習になっています。このメソッドは適切に初期化したハッシュを返し、<code>params[:user]</code>の代わりとして使用されます。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">この<code>user_params</code>メソッドはUsersコントローラの内部でのみ実行され、Web経由で外部ユーザーにさらされる必要はないため、<a class="hyperref" href="#code-create_action_strong_parameters">リスト<span class="ref">7.22</span></a>に示すようにRubyの<code>private</code>キーワードを使って<em>外部から使用できない</em>ようにします (<code>private</code>キーワードの詳細については <a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>で説明します)。</p>
<div class="codelisting" id="code-create_action_strong_parameters" data-tralics-id="uid668" data-number="7.17">
<div class="heading">
<span class="number">リスト7.17:</span> 

<span class="description"><code>create</code>アクションでStrong Parametersを使用する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
<span class="hll">      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
</span><span class="hll">                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ちなみに、<code>private</code>キーワード以降のコードを強調するために、<code>user_params</code>のインデントを1段深くしてあります。(経験的にはこれは賢い慣習だと思います。というのも、クラス内に多数のメソッドがある場合、privateメソッドの場所が簡単に見つかるからです。これにより、インデントが無い場合と比べて、どこからprivateになるのか困惑することがなくなります。)</p>
<p>この時点で、(送信ボタンを押してもエラーが出ないという意味で) ユーザー登録フォームは動くようになります。ただし<a class="hyperref" href="#fig-invalid_submission_no_feedback">図<span class="ref">7.17</span></a>が示すように、(開発者用のデバッグ領域を除いて)  間違った送信をしても何もフィードバックが返ってきていません。これはユーザーが困惑する原因となります。また、有効なユーザー情報を送信しても新しいユーザーが実際に作成されることもありません。前者の問題を<a class="hyperref" href="#sec-signup_error_messages"><span class="ref">7.3.3</span></a>で、後者の問題を<a class="hyperref" href="#sec-successful_signups"><span class="ref">7.4</span></a>でそれぞれ解決していきます。</p>
<div class="center figure" id="fig-invalid_submission_no_feedback" data-tralics-id="uid669" data-number="7.17">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/invalid_submission_no_feedback.png" alt="images/figures/invalid_submission_no_feedback"></div>
<div class="caption">
<span class="header">図7.17: </span><span class="description">無効な情報をユーザー登録フォームで送信した結果
</span>
</div>
</div>
</div>
<div id="sec-signup_error_messages" class="subsection" data-tralics-id="uid670" data-number="7.3.3">
<h3><a href="#sec-signup_error_messages" class="heading hyperref"><span class="number">7.3.3</span> ユーザー登録のエラーメッセージ</a></h3>
<p>ユーザー登録に失敗した場合の最後の手順として、問題が生じたためにユーザー登録が行われなかったということをユーザーにわかりやすく伝えるエラーメッセージを追加しましょう。Railsは、このようなメッセージをUserモデルの検証時に自動的に生成してくれます。たとえば、ユーザー情報のメールアドレスが無効で、パスワードが短すぎる状態で保存しようとしたとします。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">password</span><span class="p">:</span> <span class="s2">"dude"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"dude"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; ["Email is invalid", "Password is too short (minimum is 6 characters)"]</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="modeling_users?version=4.2#sec-presence_validation"><span class="ref">6.2.2</span></a>で少し触れた<code>errors.full_messages</code>オブジェクトは、 エラーメッセージの配列を持っています。</p>
<p>上のコンソールセッションに示されているように、<a class="hyperref" href="#code-first_create_action">リスト<span class="ref">7.16</span></a>で保存に失敗すると、<code>@user</code>オブジェクトに関連付けられたエラーメッセージの一覧が生成されます。このメッセージをブラウザで表示するには、ユーザーの<code>new</code>ページでエラーメッセージのパーシャル (partial) を出力します。このとき、<code>form-control</code>というCSSクラスも一緒に追加することで、Bootstrapがうまく取り扱ってくれるようになります。変更の結果を<a class="hyperref" href="#code-f_error_messages">リスト<span class="ref">7.18</span>に示します。</a>ここで使用しているエラーメッセージのパーシャルはあくまで試作品である点に注意してください。最終版は<a class="hyperref" href="user_microposts?version=4.2#sec-creating_microposts"><span class="ref">11.3.2</span></a>を参照してください。</p>
<div class="codelisting" id="code-f_error_messages" data-tralics-id="uid671" data-number="7.18">
<div class="heading">
<span class="number">リスト7.18:</span> 

<span class="description">ユーザー登録失敗時にエラーメッセージが表示されるようにする<span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ここでは、<code>’shared/error_messages’</code>というパーシャルを<code>render</code> (レンダリング) している点に注目してください。これはRails全般の慣習で、パーシャルは複数のコントローラにわたるビューに対し、専用の<code>shared/</code>ディレクトリを使用するようにしています(これは<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-edit_form"><span class="ref">9.1.1</span></a>で実現します)。ただし、今はまだ<code>app/views/shared</code>といったディレクトリは作っていないので、<a class="hyperref" href="beginning?version=4.2#table-unix_commands">表<span class="ref">1.1</span></a>で紹介した<code>mkdir</code>コマンドを使い、新しくディレクトリを作成する必要があります。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir app/views/shared
</pre></div></div>
<p class="noindent">また、いつものようにテキストエディタを使ってパーシャル (<code>_error_messages.html.erb</code>) も作成します。パーシャルの内容は<a class="hyperref" href="#code-errors_partial">リスト<span class="ref">7.19</span></a>のようになります。</p>
<div class="codelisting" id="code-errors_partial" data-tralics-id="uid672" data-number="7.19">
<div class="heading">
<span class="number">リスト7.19:</span> 

<span class="description">フォーム送信時にエラーメッセージを表示するためのパーシャル<span class="break"></span> <span class="filepath">app/views/shared/_error_messages.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">パーシャルによって、RailsとRubyには、Railsエラーオブジェクト用の2つのメソッドを含む多くの成果物が導入されました。最初は<code>count</code>メソッドを紹介します。これはエラーの数を返します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 2</span>
</pre></div></div>
<p class="noindent">もう1つは<code>any?</code>メソッドです。これは<code>empty?</code>メソッドと互いに補完します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-objects_and_message_passing"><span class="ref">4.2.3</span></a>では文字列に対して<code>empty?</code>メソッドを使用しましたが、Railsのエラーオブジェクトに対しても使用できます。オブジェクトが空の場合は<code>true</code>、 それ以外の場合は<code>false</code>を返します。<code>any?</code>メソッドはちょうど<code>empty?</code>と逆の動作で、要素が1つでもある場合は<code>true</code>、ない場合は<code>false</code>を返します。(なお、これらの<code>count</code>、<code>empty?</code>、<code>any?</code>メソッドは、Rubyの配列に対してもそのまま使用できます。これは<a class="hyperref" href="user_microposts?version=4.2#sec-showing_microposts"><span class="ref">11.2</span></a>で応用する予定です。)</p>
<p>さらに、<code>pluralize</code>という英語専用のテキストヘルパーが新たに登場しています。このヘルパーはデフォルトではコンソールでは使用できませんが、<code>ActionView::Helpers::TextHelper</code>を経由して明示的にインクルードできます<sup class="footnote" id="cha-7_footnote-ref-9"><a href="#cha-7_footnote-9">9</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span>
<span class="go">=&gt; "1 error"</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span>
<span class="go">=&gt; "5 errors"</span>
</pre></div></div>
<p class="noindent"><code>pluralize</code>の最初の引数に整数が与えられると、それに基づいて2番目の引数の英単語を複数形に変更したものを返します。このメソッドの背後には強力な<em>インフレクター (活用形生成) </em> があり、不規則活用を含むさまざまな単語を複数形にすることができます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"woman"</span><span class="p">)</span>
<span class="go">=&gt; "2 women"</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"erratum"</span><span class="p">)</span>
<span class="go">=&gt; "3 errata"</span>
</pre></div></div>
<p class="noindent"><code>pluralize</code>を使用することで、コードは以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">このコードはたとえば <code>"0 errors"</code>、<code>"1 error"</code>、<code>"2 errors"</code> などのように、エラーの数に応じて活用された単語を返します。これにより、<code>"1 errors"</code> のような英語の文法に合わない文字列を避けることができます (これはWeb上でどうしようもないほどよく見かけるエラーです)。</p>
<p><a class="hyperref" href="#code-errors_partial">リスト<span class="ref">7.24</span></a>には、エラーメッセージにスタイルを与えるためのCSS&nbsp;id <code>error_explanation</code>も含まれていることに注目してください (<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-custom_css"><span class="ref">5.1.2</span></a>のCSSでスタイルidに「<code>#</code>」記号を使用していることも思い出してください)。さらにRailsは、無効な内容で送信がされて元のページに戻されると、<code>div</code>で囲まれたエラー用のCSSクラス<code>field_with_errors</code>を返します。これらのラベルによって、<a class="hyperref" href="#code-error_messages_css">リスト<span class="ref">7.20</span></a>のようにエラーメッセージをSCSSで整形することができます。ここでは、Sassの<code>@extend</code>関数を使ってBootstrapの<code>has-error</code>というCSSクラスを適用してみます。</p>
<div class="codelisting" id="code-error_messages_css" data-tralics-id="uid674" data-number="7.20">
<div class="heading">
<span class="number">リスト7.20:</span> 

<span class="description">エラーメッセージにスタイルを与えるためのCSS<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">30</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.has-error</span><span class="o">;</span>
  <span class="nc">.form-control</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$state-danger-text</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-f_error_messages">リスト<span class="ref">7.18</span></a>と<a class="hyperref" href="#code-errors_partial">リスト<span class="ref">7.19</span></a>のコードと、SCSSの<a class="hyperref" href="#code-error_messages_css">リスト<span class="ref">7.20</span></a>を組み合わせることで、無効なユーザー登録情報を送信したときのエラーメッセージが分かりやすくなります (<a class="hyperref" href="#fig-signup_error_messages">図<span class="ref">7.18</span></a>)。これらのメッセージはモデルの検証時に生成されるので、メールアドレスのスタイルやパスワードの最小文字列などを変更すると、メッセージも自動的に変更されます。<br>
<br>
(このとき、存在性のバリデーションもhas_secure_passwordによるバリデーションも空のパスワードを検知してしまうため、ユーザー登録フォームで空のパスワードを入力すると2つの同じエラーメッセージが表示されてしまいます。もちろんこういった冗長なエラーメッセージを直接修正することも可能ですが、幸運にも今回の場合は、後ほど追加する allow_nil: true というオプションでこの問題は解決できます。)</p>
<div class="center figure" id="fig-signup_error_messages" data-tralics-id="uid675" data-number="7.18">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_error_messages_3rd_edition.png" alt="images/figures/signup_error_messages_3rd_edition"></div>
<div class="caption">
<span class="header">図7.17</span> <span class="description">ユーザー登録失敗時のエラーメッセージ
</span>
</div>
</div>
</div>
<div id="sec-a_test_for_invalid_submission" class="subsection" data-tralics-id="uid676" data-number="7.3.4">
<h3><a href="#sec-a_test_for_invalid_submission" class="heading hyperref"><span class="number">7.3.4 </span>失敗時のテスト</a></h3>
<p>完全なテスト機能を備えた強力なWebフレームワークがなかった頃は、開発者はフォームのテストを毎回手動で行う必要がありました。たとえば、もし仮にユーザー登録ページを手動でテストしなければならないとしたら、ブラウザでそのページを表示し、有効なデータと無効なデータを交互に流しこみ、どちらの場合にもアプリケーションが正常に動作することを確認しなければならないでしょう。さらに、アプリケーションに変更が生じるたびに、まったく同じテストを繰り返さなければなりません。このプロセスは苦痛で、バグも発生しがちです。</p>
<p>しかし幸運なことに、Railsではフォーム用のテストを書くことができ、こういったプロセスを自動化することができます。本項では、無効な送信をしたときの正しい振る舞いについてテストを書いていきます。<a class="hyperref" href="#sec-a_test_for_valid_submission"><span class="ref">7.4.4</span></a>では同様の方法で、有効な送信をしたときの正しい振る舞いについてテストを書いていきます。</p>
<p>まずは、新規ユーザー登録用の統合テストを生成するところから始めていきます。コントローラーの慣習である「リソース名は複数形」に因んで、統合テストのファイル名は<code>users_signup</code>とします。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_signup
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_signup_test.rb</span>
</pre></div></div>
<p class="noindent">(<a class="hyperref" href="#sec-a_test_for_valid_submission"><span class="ref">7.4.4</span></a>で書くテストでも、ここで生成したファイルを使います)</p>
<p>このテストでは、ユーザー登録ボタンを押したときに (ユーザー情報が無効であるために) ユーザーが<em>作成されない</em>ことを確認します。(なお、エラーメッセージに対するテストは<a class="hyperref" href="#sec-signup_exercises"><span class="ref">7.7</span></a>の演習に残しておきます。)これを確認するには、ユーザーの<em>count</em>を使用します。背後で動作するこの<code>count</code>メソッドは、<code>User</code>を含むあらゆるActive Recordクラスで使用できます。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#sec-signup_form"><span class="ref">7.2</span></a>の冒頭でデータベースをリセットしてあるので、現時点では<code>User.count</code>は<code>0</code>になっています。<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-layout_link_tests"><span class="ref">5.3.4</span></a>のように、 <code>assert_select</code>を使って関連ページのHTML要素をテストしていきます。これにより、今後うっかり要素を変更してしまっても気付けるようになります。</p>
<p>まずは<code>get</code>メソッドを使ってユーザー登録ページにアクセスします。</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="n">signup_path</span>
</pre></div></div>
<p class="noindent">フォーム送信をテストするためには、 <code>users_path</code>に対して<span class="tt">POST</span>リクエストを送信する必要があります (<a class="hyperref" href="#table-RESTful_users">表<span class="ref">7.1</span></a>)。これは、次のように<code>post</code>関数を使って実現できます</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                           <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                           <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                           <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><code>create</code>アクションの<code>User.new</code> (<a class="hyperref" href="#code-signup_flash">リスト<span class="ref">7.16</span></a>)で期待されているデータを、<code>params[:user]</code>というハッシュにまとめています。また、 <code>assert_no_difference</code>メソッドのブロック内で<code>post</code>関数を使い、メソッドの引数には<code>’User.count’</code>を与えています。これは、 <code>assert_no_difference</code>のブロックを実行する前後で引数の値 (<code>User.count</code>) が変わらないことをテストしています。すなわちこのテストは、ユーザ数を覚えた後に、データを投稿してみて、ユーザ数が変わらないかどうかを検証するテストになります。したがって、以下のコードと等価になります。</p>
<div class="code"><div class="highlight"><pre><span class="n">before_count</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="n">after_count</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">assert_equal</span> <span class="n">before_count</span><span class="p">,</span> <span class="n">after_count</span>
</pre></div></div>
<p class="noindent">これらのコードは等価ではありますが、<code>assert_no_difference</code>を使う方が明瞭で、Rubyの慣習的にも正しいです。</p>
<p>また、上のコードでは<code>get</code>関数を使っていないことにも注目してください。これは各関数に技術的な関連性がなく、ユーザー登録ページにアクセスしなくても、直接<code>post</code>関数を呼び出してユーザー登録ができることを意味しています。個人的には、コンセプトを明確にする意味とユーザー登録ページをダブルチェックする意味も兼ねて、 (実際の手順に倣って) 両方の関数を呼び出す方が好きです。</p>
<p>上記のアイデアをコードに落とし込むと、<a class="hyperref" href="#code-a_test_for_invalid_submission">リスト<span class="ref">7.21</span></a>のようになります。なお、送信に失敗したときに<code>new</code>アクションが再描画されるはずなので、<code>assert_template</code>を使ったテストも含めていることに注意してください。エラーメッセージが正しく表示されているかどうかについては、演習として残しておきます (<a class="hyperref" href="#sec-signup_exercises"><span class="ref">7.7</span></a>)。</p>
<div class="codelisting" id="code-a_test_for_invalid_submission" data-tralics-id="uid677" data-number="7.21">
<div class="heading">
<span class="number">リスト7.21:</span> 

<span class="description">無効なユーザー登録に対するテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">アプリケーションコードは既に実装済みなので、今回の統合テストも含め、全てのテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid678" data-tralics-id="uid678" data-number="7.22">
<div class="heading">
<span class="number">リスト7.22:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-successful_signups" class="section" data-tralics-id="cid47" data-number="7.4">
<h2><a href="#sec-successful_signups" class="heading hyperref"><span class="number">7.4 </span>ユーザー登録成功</a></h2>
<p>無効なフォームの送信を扱えるようになったので、いよいよ新規ユーザーを実際にデータベースに保存できるようにし (もちろんフォームが有効な場合に)、ユーザー登録フォームを完成させましょう。まずは、ユーザーを保存できるようにします。保存に成功すると、ユーザー情報は自動的にデータベースに登録されます。次にブラウザの表示を<em>リダイレクト</em>して、登録されたユーザーのプロファイルを表示します。ついでにウェルカムメッセージも表示しましょう。モックアップを<a class="hyperref" href="#fig-signup_success_mockup">図<span class="ref">7.19</span></a>に示します。保存に失敗した場合は、単に<a class="hyperref" href="#sec-unsuccessful_signups"><span class="ref">7.3</span></a>で開発したとおりの動作が実行されます。</p>
<div class="center figure" id="fig-signup_success_mockup" data-tralics-id="uid679" data-number="7.19">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_success_mockup_bootstrap.png" alt="images/figures/signup_success_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図7.19</span> <span class="description">ユーザー登録に成功した画面のモックアップ
</span>
</div>
</div>
<div id="sec-the_finished_signup_form" class="subsection" data-tralics-id="uid680" data-number="7.4.1">
<h3><a href="#sec-the_finished_signup_form" class="heading hyperref"><span class="number">7.4.1</span> 登録フォームの完成</a></h3>
<p>ユーザー登録フォームを完成させるために、<a class="hyperref" href="#code-create_action_strong_parameters">リスト<span class="ref">7.17</span></a>のコメントアウトされた部分にコードを書き、適切に動作するようにしましょう。現状では、有効な情報で送信するとエラーが発生してしまいます。<a class="hyperref" href="#fig-valid_submission_error">図<span class="ref">7.20</span></a>が示すように、Railsのデフォルトのアクションは対応するビューを表示するようになっています。しかし<code>create</code>アクションに対応するビューのテンプレートがないため (あるはずがありません)、このようなエラーが発生しています。</p>
<div class="center figure" id="fig-valid_submission_error" data-tralics-id="uid681" data-number="7.20">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/valid_submission_error.png" alt="images/figures/valid_submission_error"></div>
<div class="caption">
<span class="header">図7.20: </span><span class="description">有効な情報でユーザー登録をしてもエラーメッセージが表示される
</span>
</div>
</div>
<p>ユーザー登録に成功した場合は、ページを描画するのではなく別のページに<em>リダイレクト</em>するようにしてみましょう。ルートURLにリダイレクトしてもよいですが、一般的な慣習にしたがって、新しく作成されたユーザーのプロフィールページにリダイレクトしてみます。実際のアプリケーションコードを<a class="hyperref" href="#code-user_create_action">リスト<span class="ref">7.23</span></a>に示します (<code>redirect_to</code>メソッドに注目してください)。</p>
<div class="codelisting" id="code-user_create_action" data-tralics-id="uid682" data-number="7.23">
<div class="heading">
<span class="number">リスト7.23:</span> 

<span class="description">保存とリダイレクトを行う、userの<code>create</code>アクション<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="n">redirect_to</span> <span class="vi">@user</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div></div>
<p class="noindent">といった行がありますが、これは次のコードと等価になります。</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">これはRailsが、<code>redirect_to @user</code>というコードから<code>user_url(@user)</code>といったコードを実行したいことを(自動的に)推察してくれた結果になります。</p>
</div>
<div id="sec-the_flash" class="subsection" data-tralics-id="uid683" data-number="7.4.2">
<h3><a href="#sec-the_flash" class="heading hyperref"><span class="number">7.4.2</span> flash</a></h3>
<p><a class="hyperref" href="#code-user_create_action">リスト<span class="ref">7.23</span></a>のコードによって、ユーザー登録フォームが実際に動くようになりました。これでブラウザから正しいユーザー情報を登録できるようになりましたが、その前にWebアプリケーションに常識的に備わっている機能を追加してみましょう。登録完了後に表示されるページにメッセージを表示し (この場合は新規ユーザーへのウェルカムメッセージ)、2度目以降にはそのページにメッセージを表示しないようにするというものです。</p>
<p>Railsでこういった情報を表示するためには、<em>flash</em>という特殊な変数を使います。この変数はハッシュのように扱います。Railsの一般的な慣習に倣って、<code>:success</code>というキーには成功時のメッセージを代入するようにします (<a class="hyperref" href="#code-signup_flash">リスト<span class="ref">7.24</span></a>)。</p>
<div class="codelisting" id="code-signup_flash" data-tralics-id="uid684" data-number="7.24">
<div class="heading">
<span class="number">リスト7.24:</span> 

<span class="description">ユーザー登録ページにフラッシュメッセージを追加する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
</span>      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><code>flash</code>変数に代入したメッセージは、リダイレクトした直後のページで表示できるようになります。今回は<code>flash</code>内に存在するキーがあるかを調べ、もしあればその値 (メッセージ) を全て表示するように、レイアウトを修正します。<a class="hyperref" href="rails_flavored_ruby?version=4.2#sec-hashes_and_symbols"><span class="ref">4.3.3</span></a>でコンソール上で実行した例を思い出してみてください。そこではあえて<code>flash</code>と名付けたハッシュを使用してハッシュの値を列挙しました。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">danger</span><span class="p">:</span> <span class="s2">"It failed."</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;"It worked!", danger: "It failed."}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">danger</span>
<span class="go">It failed.</span>
</pre></div></div>
<p class="noindent">上で示したパターンに則って、flash変数の内容をWebサイト全体にわたって表示できるようにすると、次のようなコードになります。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">message_type</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-</span><span class="cp">&lt;%=</span> <span class="n">message_type</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">message</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">なお、このコードではHTMLとERbが雑に混ざっています。これをキレイに整形する課題は演習として残しておきます (<a class="hyperref" href="#sec-signup_exercises"><span class="ref">7.7</span></a>)。さて、次の埋め込みRubyでは</p>
<div class="code"><div class="highlight"><pre>alert-<span class="cp">&lt;%=</span> <span class="n">message_type</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">適用するCSSクラスをメッセージの種類によって変更するようにしています。これにより、たとえば<code>:success</code>キーのメッセージが表示される場合、適用されるCSSクラスは次のようになります。</p>
<div class="code"><div class="highlight"><pre>alert-success
</pre></div></div>
<p class="noindent">(<code>:success</code>キーはシンボルですが、テンプレート内に反映させる直前で、埋め込みRubyが自動的に<code>"success"</code>という文字列に変換しています。)これにより、キーの内容によって異なったCSSクラスを適用させることができ、メッセージの種類によってスタイルを動的に変更させることができます。たとえば、<a class="hyperref" href="log_in_log_out?version=4.2#sec-rendering_with_a_flash_message"><span class="ref">8.1.4</span></a>では<code>flash[:error]</code>を使用してログインに失敗したことを表すメッセージを表示します<sup class="footnote" id="cha-7_footnote-ref-10"><a href="#cha-7_footnote-10">10</a></sup>。(実際、既に<code>alert-danger</code>というCSSクラスを使って、<a class="hyperref" href="#code-errors_partial">リスト<span class="ref">7.19</span></a>のエラーメッセージのスタイルをdivタグで指定しています。)Bootstrap CSSは、このようなflashのクラス用に4つのスタイルを持っています (<code>success</code>、<code>info</code>、<code>warning</code>、<code>danger</code>)。また、本書のサンプルアプリケーションでは、これらの全てのスタイルを場合に応じて使っていきます。</p>
<p>テンプレート内にflashのメッセージが差し込まれるので、次のようなコードは、</p>
<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
</pre></div></div>
<p class="noindent">最終的には次のようなHTMLはになります。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success"</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
<p>先ほど説明した埋め込みRubyをレイアウトに埋め込んだ結果を、<a class="hyperref" href="#code-layout_flash">リスト<span class="ref">7.25</span></a>に示します。</p>
<div class="codelisting" id="code-layout_flash" data-tralics-id="uid686" data-number="7.25">
<div class="heading">
<span class="number">リスト7.25:</span> 

<span class="description"><code>flash</code>変数の内容をWebサイトのレイアウトに追加する<span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
<span class="hll">      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">message_type</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-</span><span class="cp">&lt;%=</span> <span class="n">message_type</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">message</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
</div>
<div id="sec-the_first_signup" class="subsection" data-tralics-id="uid687" data-number="7.4.3">
<h3><a href="#sec-the_first_signup" class="heading hyperref"><span class="number">7.4.3</span> 実際のユーザー登録</a></h3>
<p>ついにユーザー登録が完成しました。名前を “Rails Tutorial”、メールアドレスを “example@railstutorial.org”として登録してみましょう (<a class="hyperref" href="#fig-first_signup">図<span class="ref">7.21</span></a>)。登録結果 (<a class="hyperref" href="#fig-signup_flash">図<span class="ref">7.20</span></a>)にはユーザー登録成功を示すウェルカムメッセージが、<code>success</code>クラスのさわやかな緑色の背景で表示されています。このクラスは<a class="hyperref" href="filling_in_the_layout?version=4.2#sec-custom_css"><span class="ref">5.1.2</span></a>のBootstrap CSSフレームワークのものです。もしメールアドレスが既に使用されているというメッセージが表示されたら、<a class="hyperref" href="#sec-signup_form"><span class="ref">7.2</span></a>でやったようにRakeの<code>db:migrate:reset</code>を実行してデータベースをリセットしてください。ユーザー表示ページを再度読み込むと、今度はフラッシュメッセージは表示されなくなりました (<a class="hyperref" href="#fig-signup_flash_reloaded">図<span class="ref">7.23</span></a>)。</p>
<div class="center figure" id="fig-first_signup" data-tralics-id="uid688" data-number="7.21">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/first_signup.png" alt="images/figures/first_signup"></div>
<div class="caption">
<span class="header">図7.21: </span><span class="description">ユーザー登録に必要な情報を入力する
</span>
</div>
</div>
<div class="center figure" id="fig-signup_flash" data-tralics-id="uid689" data-number="7.22">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_flash_3rd_edition.png" alt="images/figures/signup_flash_3rd_edition"></div>
<div class="caption">
<span class="header">図7.22</span> <span class="description">ユーザー登録が成功し、フラッシュメッセージが表示される
</span>
</div>
</div>
<div class="center figure" id="fig-signup_flash_reloaded" data-tralics-id="uid690" data-number="7.23">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_flash_reloaded_3rd_edition.png" alt="images/figures/signup_flash_reloaded_3rd_edition"></div>
<div class="caption">
<span class="header">図7.23</span> <span class="description">ブラウザでページを再読み込みすると、フラッシュメッセージが表示されなくなる
</span>
</div>
</div>
<p>今度はデータベースを覗いて、新規ユーザーが確かに登録されていることをダブルチェックしましょう。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Rails Tutorial", email: "example@railstutorial.org",</span>
<span class="go">created_at: "2014-08-29 19:53:17", updated_at: "2014-08-29 19:53:17",</span>
<span class="go">password_digest: "$2a$10$zthScEx9x6EkuLa4NolGye6O0Zgrkp1B6LQ12pTHlNB..."=&gt; 6</span>
</pre></div></div>
</div>
<div id="sec-a_test_for_valid_submission" class="subsection" data-tralics-id="uid691" data-number="7.4.4">
<h3><a href="#sec-a_test_for_valid_submission" class="heading hyperref"><span class="number">7.4.4 </span>成功時のテスト</a></h3>
<p>次に進む前に、ここで一旦、有効な送信に対するテストを書いてみます。これによって、アプリケーションの振る舞いを検証し、もし今後バグが埋め込またらそれを検知できるようになります。<a class="hyperref" href="#sec-a_test_for_invalid_submission"><span class="ref">7.3.4</span></a>で書いた無効な送信に対するテストと同様に、今回の目的はデータベースの中身が正しいかどうか検証することです。すなわち、有効な情報を送信して、ユーザーが<em>作成された</em>ことを確認します。<a class="hyperref" href="#code-a_test_for_invalid_submission">リスト<span class="ref">7.21</span></a>のときと同じは、次のようにテストを書きましたが</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">今回は<code>assert_difference</code>というメソッドを使ってテストを書きます。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><code>assert_no_difference</code>と同様に、このメソッドは第一引数に文字列 (<code>’User.count’</code>) を取り、<code>assert_difference</code>ブロック内の処理を実行する直前と、実行した直後の<code>User.count</code>の値を比較します。第二引数はオプションですが、ここには比較した結果の差異 (今回の場合は1) を渡します。</p>
<p><a class="hyperref" href="#code-a_test_for_invalid_submission">リスト<span class="ref">7.21</span></a>と同じファイルに<code>assert_difference</code>を使ったテストを追加すると、<a class="hyperref" href="#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>のようになります。ここで、users_pathにPOSTリクエストを送信するために、<code>post_via_redirect</code>というメソッドを使っていることに注目してください。このメソッドは、POSTリクエストを送信した結果を見て、指定されたリダイレクト先に移動するメソッドです。したがって、この行の直後では<code>’users/show’</code>テンプレートが表示されているはずです。ちなみに、ここにflashのテストも追加しておくとよいでしょう。これは演習として残しておきます (<a class="hyperref" href="#sec-signup_exercises"><span class="ref">7.7</span></a>)。</p>
<div class="codelisting" id="code-a_test_for_valid_submission" data-tralics-id="uid692" data-number="7.26">
<div class="heading">
<span class="number">リスト7.26:</span> 

<span class="description">有効なユーザー登録に対するテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>では、ユーザー登録に成功させた後に、どのテンプレートが表示されているのか検証していることにも注目してください。このテストがパスするためには、Userのルート(<a class="hyperref" href="#code-users_resource">リスト<span class="ref">7.3</span></a>)とUserの <code>show</code>アクション(<a class="hyperref" href="#code-user_show_action">リスト<span class="ref">7.5</span></a>)、そして<code>show.html.erb</code>ビュー(<a class="hyperref" href="#code-user_show_view_with_gravatar">リスト<span class="ref">7.8</span></a>)がそれぞれ正しく動いている必要があります。最後に、</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_template</span> <span class="s1">'users/show'</span>
</pre></div></div>
<p class="noindent">上のコードでは、ユーザープロフィールに関するほぼ全て (たとえばページにアクセスしたらなんらかの理由でエラーが発生しないかどうかなど) をテストできていることに注目してください。この類のエンドツーエンドテストは、アプリケーションの重要な機能をカバーしてくれています。こういった理由が統合テストが便利だと呼ばれる所以です。</p>
</div>
</div><div id="sec-professional_grade_deployment" class="section" data-tralics-id="cid48" data-number="7.5">
<h2><a href="#sec-professional_grade_deployment" class="heading hyperref"><span class="number">7.5 </span>プロのデプロイ</a></h2>
<p>ユーザー登録ページを動かすことができたので、このアプリケーションをデプロイして、本番環境でも動かせるようにしてみましょう。<a class="hyperref" href="static_pages?version=4.2#cha-static_pages"><span class="ref">第3章</span></a>からデプロイをして来ましたが、実際にデータを<em>操作できるようにする</em>デプロイは初めてです。そこで、この機会にプロレベルのデプロイ方法について説明していきます。具体的には、ユーザー登録をセキュアにするために、本番用のアプリケーションに重要な機能を追加していきます。その後、デフォルトのWebサーバを実際の世界で使われているWebサーバに置き換えていきます。</p>
<p>デプロイの下準備として、まずはこの時点までの変更を<code>master</code>ブランチにマージしておいてください。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Finish user signup"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div></div>
<div id="sec-ssl_in_production" class="subsection" data-tralics-id="uid693" data-number="7.5.1">
<h3><a href="#sec-ssl_in_production" class="heading hyperref"><span class="number">7.5.1 </span>本番環境でのSSL</a></h3>
<p>本章で開発したユーザー登録フォームで送信すると、名前やメールアドレス、パスワードといったデータがネットワーク越しに流されていきます。実は、このようなネットワークに流れるデータは途中で捕捉できるため、扱いには注意が必要です。これはサンプルアプリケーションの本質的なセキュリティ上の欠陥です。そしてこれを修正するために<a href="http://ja.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">Secure Sockets Layer (SSL)</a><sup class="footnote" id="cha-7_footnote-ref-11"><a href="#cha-7_footnote-11">11</a></sup>を使います。これはローカルのサーバからネットワークに流れる前に、大事な情報を暗号化する技術です。今回はユーザー登録ページのためだけにSSLを導入しますが、これはWebサイト全体で適用できるため、<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>で実装するログイン機構をセキュアにしたり、<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>で説明する<em>セッションハイジャック</em>の脆弱性に対しても多くの利点を生み出します。</p>
<p>そしてSSLを有効化するのも簡単です。 <code>production.rb</code>という本番環境の設定ファイルの1行を修正するだけで済みます。 具体的には、 <code>config</code>変数で「本番環境ではSSLを強制する」という設定をするだけです (<a class="hyperref" href="#code-ssl_in_production">リスト<span class="ref">7.27</span></a>)。</p>
<div class="codelisting" id="code-ssl_in_production" data-tralics-id="uid695" data-number="7.27">
<div class="heading">
<span class="number">リスト7.27:</span> 

<span class="description">本番環境ではSSLを使うように修正する<span class="break"></span> <span class="filepath">config/environments/production.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security,</span>
  <span class="c1"># and use secure cookies.</span>
<span class="hll">  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>次に、遠隔にあるサーバーのSSLをセットアップします。本番用のWebサイトでSSLを使えるようにするためには、ドメイン毎に<em>SSL証明書</em>を購入し、セットアップする必要があります。これには多くの作業が必要となりますが、幸運にもそういった作業をしなくても済む方法があります。それは、Heroku上でサンプルアプリケーションを動かし、HerokuのSSL証明書に便乗する方法です (訳注: ただし、この方法はHerokuのサブドメインでのみ有効です。独自ドメインを使う場合はSSL証明書を購入する必要があります)。結果として、<a class="hyperref" href="#sec-production_webserver"><span class="ref">7.5.2</span></a>でアプリケーションのデプロイが終わると、自動的にSSLが有効化されているはずです。(もし<code>www.example.com</code>などの独自ドメインでSSLを使いたい場合は、<a href="http://devcenter.heroku.com/articles/ssl" target="_blank">Heroku’s page on SSL</a> (英語) の記事を参照してください。)</p>
</div>
<div id="sec-production_webserver" class="subsection" data-tralics-id="uid696" data-number="7.5.2">
<h3><a href="#sec-production_webserver" class="heading hyperref"><span class="number">7.5.2 </span>本番環境用Webサーバー</a></h3>
<p>SSLを導入したので、次はアプリケーションの設定をいじって、本番環境に適したWebサーバを使ってみましょう。Herokuのデフォルトでは、Rubyだけで実装されたWEBrickというWebサーバを使っています。WEBrickは簡単にセットアップできたり動せることが特長ですが、著しいトラフィックを扱うことには適していません。つまり、WEBrickは<a href="https://devcenter.heroku.com/articles/ruby-default-web-server" target="_blank">本番環境として適切なWebサーバではありません</a>。よって、今回は<a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank">WEBrickをPumaというWebサーバに置き換えてみます</a>。Pumaは多数のリクエストを捌くことに適したWebサーバです。</p>
<p>新しいWebサーバを追加するために、<a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank">Heroku内のPumaドキュメント</a> (英語) にしたがってセットアップしていきます。まずは<span class="tt">puma</span> gemを<code>Gemfile</code>に追加します (<a class="hyperref" href="#code-puma_gemfile">リスト<span class="ref">7.28</span></a>)。このとき、ローカル環境 (開発用の環境) でPumaを使う必要はないので、<a class="hyperref" href="#code-puma_gemfile">リスト<span class="ref">7.28</span></a>のように<code>:production</code>グループの中に追加しておきます。</p>
<div class="codelisting" id="code-puma_gemfile" data-tralics-id="uid697" data-number="7.28">
<div class="heading">
<span class="number">リスト7.28:</span> 

<span class="description"><code>Gemfile</code>にPumaを追加する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span>             <span class="s1">'0.17.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="hll">  <span class="n">gem</span> <span class="s1">'puma'</span><span class="p">,</span>           <span class="s1">'2.11.1'</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">Bundlerでは本番環境用のgemはインストールしない設定にしておいたので (<a class="hyperref" href="static_pages?version=4.2#sec-sample_app_setup"><span class="ref">3.1</span></a>)、<a class="hyperref" href="#code-puma_gemfile">リスト<span class="ref">7.28</span></a>は開発環境に影響はありません。しかし、Bundlerに<code>Gemfile.lock</code>を更新してもらう必要があるので、いつものように次のコマンドを実行しておきます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install</pre></div></div>
<p>次のステップは、<code>config/puma.rb</code>というファイルを作成し、そこに<a class="hyperref" href="#code-production_webserver_config">リスト<span class="ref">7.29</span></a>のような設定情報を追加します。<a class="hyperref" href="#code-production_webserver_config">リスト<span class="ref">7.29</span></a>は<a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank">Herokuのドキュメント</a><sup class="footnote" id="cha-7_footnote-ref-12"><a href="#cha-7_footnote-12">12</a></sup>をそのまま引用したコードです。これらのコードは理解しなくても大丈夫です。</p>
<div class="codelisting" id="code-production_webserver_config" data-tralics-id="uid699" data-number="7.29">
<div class="heading">
<span class="number">リスト7.29:</span> 

<span class="description">本番環境のWebサーバー設定ファイル<span class="break"></span> <span class="filepath">config/puma.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">workers</span> <span class="nb">Integer</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">'WEB_CONCURRENCY'</span><span class="o">]</span> <span class="o">||</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">threads_count</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">'MAX_THREADS'</span><span class="o">]</span> <span class="o">||</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">threads</span> <span class="n">threads_count</span><span class="p">,</span> <span class="n">threads_count</span>

<span class="n">preload_app!</span>

<span class="n">rackup</span>      <span class="no">DefaultRackup</span>
<span class="n">port</span>        <span class="no">ENV</span><span class="o">[</span><span class="s1">'PORT'</span><span class="o">]</span>     <span class="o">||</span> <span class="mi">3000</span>
<span class="n">environment</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'RACK_ENV'</span><span class="o">]</span> <span class="o">||</span> <span class="s1">'development'</span>

<span class="n">on_worker_boot</span> <span class="k">do</span>
  <span class="c1"># Worker specific setup for Rails 4.1+</span>
  <span class="c1"># See: https://devcenter.heroku.com/articles/</span>
  <span class="c1"># deploying-rails-applications-with-the-puma-web-server#on-worker-boot</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>最後に、<code>Procfile</code>と呼ばれる、Heroku上でPumaのプロセスを走らせる設定ファイルを作成します (<a class="hyperref" href="#code-procfile">リスト<span class="ref">7.30</span></a>)。なお、この<code>Procfile</code>はルートディレクトリ (<code>Gemfile</code>と同じディレクトリ) に置いておく必要があるので、ファイルの置き場所には注意してください。</p>
<div class="codelisting" id="code-procfile" data-tralics-id="uid700" data-number="7.30">
<div class="heading">
<span class="number">リスト7.30:</span> 

<span class="description">Pumaが使うように<code>Procfile</code>で定義する<span class="break"></span> <span class="filepath">./Procfile</span></span>
</div>

<div class="code"><div class="highlight"><pre>web: bundle <span class="nb">exec </span>puma -C config/puma.rb
</pre></div></div>
</div>
<p>これで、本番環境用のWebサーバの設定は完了しました。これらの変更をコミットし、デプロイしてみましょう<sup class="footnote" id="cha-7_footnote-ref-13"><a href="#cha-7_footnote-13">13</a></sup>。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Use SSL and the Puma webserver in production"
$ git push
$ git push heroku
$ heroku run rake db:migrate
</pre></div></div>
<p class="noindent">ユーザー登録フォームが無事に動いたら成功です。成功すると<a class="hyperref" href="#fig-signup_in_production">図<span class="ref">7.24</span></a>のようになります。このとき、URLが<span class="tt">https://</span>に変わっていて、アドレスバーに鍵アイコンが表示されていることにも注目してください (<a class="hyperref" href="#fig-signup_in_production">図<span class="ref">7.24</span></a>)。これは先ほど設定したSSLがうまく動いていることを示しています。</p>
<div class="center figure" id="fig-signup_in_production" data-tralics-id="uid702" data-number="7.24">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/signup_in_production_3rd_edition.png" alt="images/figures/signup_in_production_3rd_edition"></div>
<div class="caption">
<span class="header">図7.24: </span><span class="description">本番環境 (Web上) で実際にユーザー登録をしてみる
</span>
</div>
</div>
</div>
<div id="sec-ruby_version_number" class="subsection" data-tralics-id="uid703" data-number="7.5.3">
<h3><a href="#sec-ruby_version_number" class="heading hyperref"><span class="number">7.5.3 </span>Rubyのバージョン番号</a></h3>
<p>ところで、Herokuのデプロイするとき、もしかしたら次のような警告メッセージを目にしたことがあるかもしれません。</p>
<div class="code"><div class="highlight"><pre>###### WARNING:
       You have not declared a Ruby version in your Gemfile.
       To set your Ruby version add this line to your Gemfile:
       ruby '2.1.5'
</pre></div></div>
<p class="noindent">(これは「Rubyのバージョンを明示的に指定してください」というメッセージですが) 経験的には、本書のようなチュートリアルの段階では明示的に指定しない方がスムーズに進むことが多いので、この警告は現時点では無視してしまった方がよいでしょう。というのも、サンプルアプリケーションでRubyのバージョンを常に最新に保っておくと、多大な不都合に繋がりかねないからです<sup class="footnote" id="cha-7_footnote-ref-14"><a href="#cha-7_footnote-14">14</a></sup>。また、本書のサンプルアプリケーションにおいては、ローカルで使っているバージョンと本番環境のバージョンが異なっていても、違い生じることはほぼ無いでしょう。とは言うものの、次の点は頭の片隅に置いておいてください。それは、仕事でHerokuを使ったアプリケーションを動かす場合は<code>Gemfile</code>でRubyのバージョンを明示しておいた方が賢明である、という点です。これによって開発環境と本番環境の互換性を最大限に高めることができるので、(バージョンの差異による誤作動やエラーなどが無くなり) お勧めです。</p>
</div>
</div><div id="cid49" class="section" data-tralics-id="cid49" data-number="7.6">
<h2><a href="#cid49" class="heading hyperref"><span class="number">7.6</span> 最後に</a></h2>
<p>ユーザー登録機能の実装は、私たちのサンプルアプリケーションにとって大きなマイルストーンでした。この時点でサンプルアプリケーションはかなり実用的になってきましたが、まだ重要な機能がいくつも残っています。<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>では、認証 (authentication) システムを導入し、ユーザーがログインとログアウトをできるようにします。<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="ref">第9章</span></a>では、どのユーザーも自分のアカウント情報を更新できるようにし、Webサイトの管理者がユーザーを削除できるようにします。それにより、Usersリソースに<a class="hyperref" href="#table-RESTful_users">表<span class="ref">7.1</span></a>のRESTアクションがすべて実装されるようにします。</p>
<div id="sec-sign_up_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid705" data-number="7.6.1">
<h3><a href="#sec-sign_up_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">7.6.1 </span>本章のまとめ</a></h3>
<ul>
<li>
<code>debug</code>メソッドを使うことで、役立つデバッグ情報を表示できる
</li>
<li>Sassのmixin機能を使うと、CSSのルールをまとめたり他の場所で再利用できるようなる
</li>
<li>Railsには標準で3つ環境が備わっており、それぞれ<code>開発環境 (development)</code>、<code>テスト環境 (test)</code>、<code>本番環境 (production)</code>と呼ぶ
</li>
<li>標準的なRESTfulなURLを通して、ユーザー情報を<em>リソース</em>として扱えるようになった</li>
<li>Gravatarを使うと、ユーザーのプロフィール画像を簡単に表示できるようになる
</li>
<li>
<code>form_for</code>ヘルパーは、Active Recordのオブジェクトに対応したフォームを生成する
</li>
<li>ユーザー登録に失敗した場合はnewビューを再描画するようにした。その際、Active Recordが自動的に検知したエラーメッセージを表示できるようにした
</li>
<li>
<code>flash</code>変数を使うと、一時的なメッセージを表示できるようになる
</li>
<li>ユーザー登録に成功すると、データベース上にユーザーが追加、プロフィールページにリダイレクト、ウェルカムメッセージの表示といった順で処理が進む
</li>
<li>統合テストを使うことで送信フォームの振る舞いを検証したり、バグの発生を検知したりできる
</li>
<li>セキュアな通信と高いパフォーマンスを確保するために、本番環境ではSSLとPumaを導入した
</li>
</ul>
</div>
</div><div id="sec-signup_exercises" class="section" data-tralics-id="cid50" data-number="7.7">
<h2><a href="#sec-signup_exercises" class="heading hyperref"><span class="number">7.7</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>ブックのすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で本書ルを購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>演習とチュートリアル本編との食い違いを避ける方法については、演習用のトピックブランチに追加したメモ (<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>) を参照してください。</p>
<ol>
<li>
<a class="hyperref" href="#code-gravatar_option">リスト<span class="ref">7.31</span></a>のコードを使用して、<a class="hyperref" href="#sec-a_gravatar_image"><span class="ref">7.1.4</span></a>で定義された<code>gravatar_for</code>ヘルパーにオプションの<code>size</code>パラメーターを取ることができる (<code>gravatar_for user, size: 40</code>のようなコードをビューで使用できる) ことを確認してください。(<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-users_index"><span class="ref">9.3.1</span></a>でこれを改善したヘルパーを使います)
</li>
<li>
<a class="hyperref" href="#code-f_error_messages">リスト<span class="ref">7.18</span></a>で実装したエラーメッセージに対するテストを書いてみてください。どのくらい細かくテストするかはお任せします。<a class="hyperref" href="#code-error_messages_test">リスト<span class="ref">7.32</span></a>にテンプレートを用意しておいたので、参考にしてください。
</li>
<li>
<a class="hyperref" href="#sec-the_flash"><span class="ref">7.4.2</span></a>で実装したflashに対するテストを書いてみてください。どのくらい細かくテストするかはお任せします。 <a class="hyperref" href="#code-flash_test">リスト<span class="ref">7.33</span></a>に最小限のテンプレートを用意しておいたので、参考にしてください (ヒント:  <code>FILL_IN</code>メソッドを適切なコードに置き換えると完成します)。(テキストに対するテストは壊れやすいです。文量の少ないflashのキーであっても、それは同じです。個人的には、flashが空でないかをテストするだけの場合が多いです)
</li>
<li>
<a class="hyperref" href="#sec-the_flash"><span class="ref">7.4.2</span></a>で触れたように、flash用のHTML (<a class="hyperref" href="#code-layout_flash">リスト<span class="ref">7.25</span></a>) は読みにくいです。より読みやすくした<a class="hyperref" href="#code-layout_flash_content_tag">リスト<span class="ref">7.34</span></a>のコードに対してテストスイートを実行し、こちらも正常に動作することを確認してください。このコードでは、Railsの<code>content_tag</code>ヘルパーを使用しています。
</li>
</ol>
<div class="codelisting" id="code-gravatar_option" data-tralics-id="uid721" data-number="7.31">
<div class="heading">
<span class="number">リスト7.31:</span> 

<span class="description"><code>gravatar_for</code>ヘルパーにキーワード引数を追加する<span class="break"></span> <span class="filepath">app/helpers/users_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># 引数で与えられたユーザーのGravatar画像を返す</span>
<span class="hll">  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">80</span> <span class="p">})</span>
</span>    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="hll">    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
</span><span class="hll">    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">"</span>
</span>    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-error_messages_test" data-tralics-id="uid722" data-number="7.32">
<div class="heading">
<span class="number">リスト7.32:</span> 

<span class="description">エラーメッセージをテストするためのテンプレート<span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s1">'div#&lt;CSS id for error explanation&gt;'</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s1">'div.&lt;CSS class for field with error&gt;'</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-flash_test" data-tralics-id="uid723" data-number="7.33">
<div class="heading">
<span class="number">リスト7.33:</span> 

<span class="description">flashをテストするためのテンプレート<span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
<span class="hll">    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">FILL_IN</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-layout_flash_content_tag" data-tralics-id="uid724" data-number="7.34">
<div class="heading">
<span class="number">リスト7.34:</span> 

<span class="description"><code>content_tag</code>を使ってレイアウトの中に<code>flash</code>を埋め込む <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">message_type</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"alert alert-</span><span class="si">#{</span><span class="n">message_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span>      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
</div>
</div><div id="cha-7_footnotes">
  <div class="navigation">
<a class="next_page" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="number">第8章</span>ログイン、ログアウト</a><a class="prev_page" href="modeling_users?version=4.2#cha-modeling_users"><span class="number">第6章</span>ユーザーのモデルを作成する</a>
</div>
<ol class="footnotes">
    <li id="cha-7_footnote-1">
<a href="http://gomockingbird.com/" target="_blank">Mockingbird</a>では<a class="hyperref" href="#fig-profile_mockup_profile_name">図<span class="ref">7.1</span></a>のプロファイル写真のようなカスタム画像はサポートされていません。ここでは<a href="http://www.gimp.org/" target="_blank">GIMP</a>を使用して手動で画像を置きました。<a class="arrow" href="#cha-7_footnote-ref-1">↑</a>
</li>
    <li id="cha-7_footnote-2">このカバの画像は<a href="http://www.flickr.com/photos/43803060@N00/24308857/" target="_blank">http://www.flickr.com/photos/43803060@N00/24308857/</a>から引用しました。<a class="arrow" href="#cha-7_footnote-ref-2">↑</a>
</li>
    <li id="cha-7_footnote-3">実は、この3つ以外にもカスタムの環境を作成することができます。詳細については「<a href="http://railscasts.com/episodes/72-adding-an-environment" target="_blank">環境を追加した場合のRailsCast</a> (英語)」を参照してください。<a class="arrow" href="#cha-7_footnote-ref-3">↑</a>
</li>
    <li id="cha-7_footnote-4">Railsの<code>debug</code>情報は <a href="http://www.yaml.org/" target="_blank">YAML</a> (一種の<a href="http://catb.org/jargon/html/R/recursive-acronym.html" target="_blank">再帰的略語</a>であり、“YAML Ain’t Markup Language” の略とされています) 形式で表示されます。YAMLは人間<em>だけでなく</em>コンピュータにとっても読みやすい形式です。<a class="arrow" href="#cha-7_footnote-ref-4">↑</a>
</li>
    <li id="cha-7_footnote-5">この時点では、<em>ルーティング</em>は動作していますが、対応するページが動作しているとは限りません。たとえば、/users/1/edit がUsersコントローラの<code>edit</code>アクションに正常にルーティングされているとしても、<code>edit</code>アクションが存在しなければ、このURLにアクセスしたときにエラーになります。<a class="arrow" href="#cha-7_footnote-ref-5">↑</a>
</li>
    <li id="cha-7_footnote-6">ヒンズー教では、アバターは人間や動物の形をとって神が顕現したものと考えられています。これを拡大解釈して、<em>アバター</em>という用語は、特にネット界隈で、その人物を表現するもの (かつその人そのものの一部でもある) という意味で使われます。<a class="arrow" href="#cha-7_footnote-ref-6">↑</a>
</li>
    <li id="cha-7_footnote-7">
<a class="hyperref" href="#code-sidebar_css">リスト<span class="ref">7.11</span></a>では<code>.gravatar_edit</code>というCSSクラスを追加しています。これは<a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="ref">第9章</span></a>でも使われます。<a class="arrow" href="#cha-7_footnote-ref-7">↑</a>
</li>
    <li id="cha-7_footnote-8">動作の詳細を知りたい場合は、Stack Overflowの<a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token" target="_blank">Rails信頼性トークン関連の書き込み</a> (英語) を参照してください。<a class="arrow" href="#cha-7_footnote-ref-8">↑</a>
</li>
    <li id="cha-7_footnote-9">私は<a href="http://api.rubyonrails.org/v4.2.2/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize" target="_blank">Rails API</a>で<code>pluralize</code>を探し、これを見つけました。<a class="arrow" href="#cha-7_footnote-ref-9"> ↑</a>
</li>
    <li id="cha-7_footnote-10">実際には、これに非常に近い<code>flash.now</code>を使いますが、本当に必要になるまでは使わないようにしようかと思います。<a class="arrow" href="#cha-7_footnote-ref-10">↑</a>
</li>
    <li id="cha-7_footnote-11">技術上は、SSLはTLS (Transport Layer Security) と名称が変わりましたが、未だに “SSL” と呼ばれ続けています。<a class="arrow" href="#cha-7_footnote-ref-11">↑</a>
</li>
    <li id="cha-7_footnote-12">
<a class="hyperref" href="#code-production_webserver_config">リスト<span class="ref">7.29</span></a>では少しだけコードの見栄えを修正しています。これは標準的な1行80文字の制限に合わせるための変更です。<a class="arrow" href="#cha-7_footnote-ref-12">↑</a>
</li>
    <li id="cha-7_footnote-13">本章ではデータモデルに対して変更を加えていなかったので、<a class="hyperref" href="modeling_users?version=4.2#sec-modeling_users_conclusion"><span class="ref">6.4</span></a>のステップが済んでいれば、本当はHeroku上でマイグレーションを実行しなくても問題ないはずです。ただし、読者からトラブル報告がいくつか来ていたので、念のため<code>heroku run rake db:migrate</code>を実行するようにしてあります。<a class="arrow" href="#cha-7_footnote-ref-13">↑</a>
</li>
    <li id="cha-7_footnote-14">たとえば、 ローカルマシンでRuby 2.1.4がインストールできなくて何時間も過ごしてしまい、なんとか無事にインストールできたと思ったら、先日Ruby 2.1.5がリリースされたことに気付いたときなどです。ちなみにRuby 2.1.5のインストールにも苦戦しました。<a class="arrow" href="#cha-7_footnote-ref-14">↑</a>
</li>
  </ol>
</div>
          </div>

  </body>
</html>
