<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
<div id="book">
            




            
            
            <div id="cha-account_activation_and_password_reset" class="chapter" data-tralics-id="cid65" data-number="10" data-chapter="account_activation_password_reset">
<h1><a href="#cha-account_activation_and_password_reset" class="heading hyperref"><span class="number">第10章</span> アカウント有効化とパスワード再設定</a></h1>
<p><a class="hyperref" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users">第<span class="ref">9</span>章</a>では、基本的なUsersリソース (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>の標準的なRESTアクションをすべて使用) と、自由道の高い認証 (authentication) および認可 (authorization) システムを作成しました。本章ではこのシステムの仕上げとして、互いに強く関連している2つの機能、すなわちアカウントの有効化 (アクティベーション: 新規ユーザーのメールアドレスが有効であることを確認する機能) と、パスワードの再設定 (パスワードを忘れてしまったユーザー向けの機能) を実装することにします。これらの機能ごとに新しいリソースを作成し、それぞれのコントローラ/ルーティング/データベース移行の例について見ていくことにします。その途中で、Railsの開発環境や本番環境からメールを送信する方法についても学習します。最後に、2つの機能を完全に連携させます。パスワードを再設定すると、パスワード再設定用のリンクがメールで送信され、その宛先メールアドレスが有効であることは最初のアカウント有効化で確認済みである、といった具合です<sup class="footnote" id="cha-10_footnote-ref-1"><a href="#cha-10_footnote-1">1</a></sup>。</p>
</div><div id="sec-account_activation" class="section" data-tralics-id="cid66" data-number="10.1">
<h2><a href="#sec-account_activation" class="heading hyperref"><span class="number">10.1 </span>アカウントの有効化</a></h2>
<p>今の状態では、新しくアカウントを登録したユーザーはアカウントに対するフルアクセス権限を持っています (<a class="hyperref" href="sign_up?version=4.2#cha-sign_up">第<span class="ref">7</span>章</a>) が、このままではいかにも大雑把です。そこで、アカウントを有効化する手順を実装して、ユーザーが登録に使用したメールアドレスを本当に所有、管理しているのかどうかを確認するようにしましょう。これを行うおおよその流れは、有効化トークンやダイジェストをユーザーと関連付け、ユーザーにメールを送信し、そのメールにはトークンを含むリンクを記載しておき、ユーザーがそのリンクをクリックすると有効化できるようになる、というものです。</p>
<p>アカウントを有効化する段取りは、ユーザーログイン (<a class="hyperref" href="log_in_log_out?version=4.2#sec-logging_in"><span class="ref">8.2</span></a>)、特にユーザーの記憶 (<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>) と似ています。基本的な手順は次のようになります。</p>
<ol>
<li>ユーザーの初期状態は「有効化されていない」(unactivated) にしておく。
</li>
<li>ユーザー登録が行われたときに、有効化トークンと、それに対応する有効化ダイジェストを生成する。
</li>
<li>有効化ダイジェストはデータベースに保存しておき、有効化トークンはメールアドレスと一緒に、ユーザーに送信する有効化用メールのリンクに仕込んでおく<sup class="footnote" id="cha-10_footnote-ref-2"><a href="#cha-10_footnote-2">2</a></sup>。
</li>
<li>ユーザーがメールのリンクをクリックしたら、アプリケーションはメールアドレスをキーにしてユーザーを探し、データベース内に保存しておいた有効化ダイジェストと比較することでトークンを認証する。
</li>
<li>ユーザーを認証できたら、ユーザーのステータスを「有効化されていない」から「有効化済み」(activated) に変更する。
</li>
</ol>
<p>都合の良いことに、今回実装するアカウント有効化やパスワード再設定の仕組みと、以前に実装したパスワードや記憶トークンの仕組みにはよく似た点が多いので、多くのアイデアを使い回すことができます (<code>User.digest</code>メソッド、<code>User.new_token</code>メソッド、改造版の<code>user.authenticated?</code>メソッドなど)。<a class="hyperref" href="#table-password_token_digest">表<span class="ref">10.1</span></a>に両者の似ている点を示します (<a class="hyperref" href="#sec-password_reset"><span class="ref">10.2</span>のパスワード再設定も含む</a>)。<a class="hyperref" href="#sec-activating_the_account"><span class="ref">10.1.3</span></a>の<a class="hyperref" href="#table-password_token_digest">表<span class="ref">10.1</span></a>を元に、より一般性の高い<code>authenticated?</code>メソッドを定義することにします。</p>
<div class="table" id="table-password_token_digest" data-tralics-id="uid1009" data-number="10.1">
<table class="tabular">
<tbody><tr class="bottom_border">
<td colspan="1" class="align_center"><strong>検索キー</strong></td>
<td colspan="1" class="align_center"><strong>文字列</strong></td>
<td colspan="1" class="align_center"><strong>ダイジェスト</strong></td>
<td colspan="1" class="align_center"><strong>認証</strong></td>
</tr>
<tr>
<td class="align_left"><code>email</code></td>
<td class="align_left"><code>password</code></td>
<td class="align_left"><code>password_digest</code></td>
<td class="align_left"><code>authenticate(password)</code></td>
</tr>
<tr>
<td class="align_left"><code>id</code></td>
<td class="align_left"><code>remember_token</code></td>
<td class="align_left"><code>remember_digest</code></td>
<td class="align_left"><code>authenticated?(:remember, token)</code></td>
</tr>
<tr>
<td class="align_left"><code>email</code></td>
<td class="align_left"><code>activation_token</code></td>
<td class="align_left"><code>activation_digest</code></td>
<td class="align_left"><code>authenticated?(:activation, token)</code></td>
</tr>
<tr>
<td class="align_left"><code>email</code></td>
<td class="align_left"><code>reset_token</code></td>
<td class="align_left"><code>reset_digest</code></td>
<td class="align_left"><code>authenticated?(:reset, token)</code></td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表10.1: </span><span class="description">ログイン/記憶トークン/アカウントの有効化/パスワードの再設定で似ている点
</span>
</div>
</div>
<p>それではいつものように、Gitで新機能用のトピックブランチを作成しましょう。<a class="hyperref" href="#sec-email_in_production"><span class="ref">10.3</span></a>で説明したとおり、アカウントの有効化とパスワードの再設定では、メールの設定部分に共通するところがありますので、その部分を両機能に適用してからGitのmasterにマージします。こうすることで共通のトピックブランチを使えるようになり、便利です。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b account-activation-password-reset
</pre></div></div>
<div id="sec-account_activations_resource" class="subsection" data-tralics-id="uid1010" data-number="10.1.1">
<h3><a href="#sec-account_activations_resource" class="heading hyperref"><span class="number">10.1.1 </span>AccountActivationsリソース</a></h3>
<p>セッション機能 (<a class="hyperref" href="log_in_log_out?version=4.2#sec-sessions_and_failed_login"><span class="ref">8.1</span></a>) を使用して、アカウントの有効化という作業を「リソース」としてモデル化することにします。アカウントの有効化リソースはActive Recordのモデルとはこの際関係ないので、両者を関連付けることはしません。その代わりに、この作業に必要なデータ (有効化トークンや有効化ステータスなど) をUserモデルに追加することにします。ただし、アカウント有効化におけるやりとりでは、標準のREST URLを使用するようにします。有効化用のリンクにアクセスするとユーザーの有効化ステータスが必然的に変わるので、標準的な<code>edit</code>アクションを使用することにします<sup class="footnote" id="cha-10_footnote-ref-3"><a href="#cha-10_footnote-3">3</a></sup>。では始めましょう。AccountActivationsコントローラを以下のコマンドで生成します<sup class="footnote" id="cha-10_footnote-ref-4"><a href="#cha-10_footnote-4">4</a></sup>。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller AccountActivations --no-test-framework
</pre></div></div>
<p class="noindent">上のコマンドでは、テストを生成しないというオプションを指定していることにご注目ください。著者はコントローラのテストよりも統合テスト (<a class="hyperref" href="#sec-activation_test_and_refactoring"><span class="ref">10.1.4</span></a>) の方が望ましいと考えているので、コントローラのテストを生成しないようにしているのです。</p>
<p>有効化メールでは以下の形式のURLを使用します。</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">これは、<code>edit</code>アクションへの名前付きルートが必要になるということです。そのための<code>resources</code>行を追加します (<a class="hyperref" href="#code-account_activations_route">リスト<span class="ref">10.1</span></a>)。</p>
<div class="codelisting" id="code-account_activations_route" data-tralics-id="uid1013" data-number="10.1">
<div class="heading">
<span class="number">リスト10.1:</span> 

<span class="description">アカウント有効化に使用するリソースを追加する <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>続いて、一意の有効化トークンがユーザー有効化に必要です。アカウント有効化のセキュリティは、パスワードや記憶トークンやパスワードの再設定 (<a class="hyperref" href="#sec-password_reset">10.2</a>) に比べると注意点が少なくて済みます。後者への攻撃が成功すれば全権を奪われてしまう可能性がありますが、前者も有効化トークンをハッシュ化しておかなければアカウントに攻撃を受ける可能性があります<sup class="footnote" id="cha-10_footnote-ref-5"><a href="#cha-10_footnote-5">5</a></sup>。そこで、<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me">8.4</a>の記憶トークンの例に従って、一般公開してもよい「仮想トークン」と、データベース内にのみ保存する「ハッシュダイジェスト」を組み合わせるとにします。これにより、以下を使用して有効化トークンにアクセスし、</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span>
</pre></div></div>
<p class="noindent">以下のようなコードでユーザーを認証できるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">(これを行うには<a class="hyperref" href="log_in_log_out?version=4.2#code-authenticated_p">リスト<span class="ref">8.33</span></a>の<code>authenticated?</code>メソッドを改良する必要があります)。続いて、<code>activated</code>属性を追加して論理値 (true/false) を取るようにします。これで、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-administrative_users"><span class="ref">9.4.1</span></a>で説明した自動生成の論理値メソッドと同じような感じで、ユーザーが有効であるかどうかをテストできるようになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div></div>
<p class="noindent">最後に、本チュートリアルで使うことはありませんが、ユーザーを有効にしたときの日時も念のために記録しておきます。変更後のデータモデルは<a class="hyperref" href="#fig-user_model_account_activation">図<span class="ref">10.1</span></a>のようになります。</p>
<div class="center figure" id="fig-user_model_account_activation" data-tralics-id="uid1015" data-number="10.1">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_account_activation.png" alt="user_model_account_activation"></span>
<div class="caption">
<span class="header">図10.1: </span><span class="description">Userモデルにユーザー有効化用の属性を追加する
</span>
</div>
</div>
<p>以下のマイグレーションをコマンドラインで実行して<a class="hyperref" href="#fig-user_model_account_activation">図<span class="ref">10.1</span></a>のデータモデルを追加すると、3つの属性が新しく追加されます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_activation_to_users <span class="se">\</span>
<span class="gp">&gt;</span> activation_digest:string activated:boolean activated_at:datetime
</pre></div></div>
<p class="noindent">(上記の2行目にある '&gt;' という文字は、改行を示すためにシェルが自動的に挿入する文字です。手動で入力しないよう、注意してください) <code>admin</code> 属性 (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-admin_migration">リスト<span class="ref">9.50</span></a>) の時と同様に、<code>activated</code>属性のデフォルトの論理値を<code>false</code>にします (<a class="hyperref" href="#code-add_activation_to_users_migration">リスト<span class="ref">10.2</span></a>)。</p>
<div class="codelisting" id="code-add_activation_to_users_migration" data-tralics-id="uid1016" data-number="10.2">
<div class="heading">
<span class="number">リスト 10.2:</span> 

<span class="description">アカウント有効化用の属性とインデックスを追加するマイグレーション <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_activation_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddActivationToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activation_digest</span><span class="p">,</span> <span class="ss">:string</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated_at</span><span class="p">,</span> <span class="ss">:datetime</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">いつものようにマイグレーションを実行します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p>ユーザーが新しい登録を完了するためには必ずアカウントの有効化が必要になるのですから、有効化トークンや有効化ダイジェストはユーザーオブジェクトが作成される前に作成しておく必要があります。これによく似た状況を<a class="hyperref" href="modeling_users?version=4.2#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>でも説明しました。メールアドレスをデータベースに保存する前に、メールアドレスを全部小文字に変換する必要があったのでした。あのときは、<code>before_save</code>コールバックに<code>downcase</code>メソッドをバインドしました (<a class="hyperref" href="modeling_users?version=4.2#code-email_downcase">リスト<span class="ref">6.31</span></a>)。オブジェクトに<code>before_save</code>コールバックを用意しておくと、オブジェクトが保存される直前、オブジェクトの作成時や更新時にそのコールバックが呼び出されます。しかし今回は、オブジェクトが作成されたときだけコールバックを呼び出したいのです。それ以外のときには呼び出したくないのです。そこで<code>before_create</code>コールバックが必要になります。このコールバックは以下のように定義できます。</p>
<div class="code"><div class="highlight"><pre><span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</pre></div></div>
<p class="noindent">上のコードは<em>メソッド参照</em>と呼ばれるもので、こうすることでRailsは<code>create_activation_digest</code>というメソッドを探し、ユーザーを作成する前に実行するようになります (<a class="hyperref" href="modeling_users?version=4.2#code-email_downcase">リスト<span class="ref">6.31</span></a>では、<code>before_save</code>に明示的にブロックを渡していましたが、メソッド参照の方が一般にお勧めできます)。 <code>create_activation_digest</code>メソッド自体はUserモデル内でしか使用しないので、外部に公開する必要はありません。<a class="hyperref" href="sign_up?version=4.2#sec-strong_parameters"><span class="ref">7.3.2</span></a>のときと同じように<code>private</code>キーワードを指定して、このメソッドをRuby流に隠蔽します。</p>
<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_activation_digest</span>
    <span class="c1"># トークンとダイジェストを作成する.</span>
  <span class="k">end</span>
</pre></div></div>
<p class="noindent">クラス内で<code>private</code>キーワードより下に記述したメソッドは自動的に非公開となります。このことはコンソールセッションですぐ確かめられます。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_activation_digest</span>
<span class="go">NoMethodError: private method `create_activation_digest' called for #&lt;User&gt;</span>
</pre></div></div>
<p>今回<code>before_create</code>コールバックを使用する目的は、トークンとそれに対応するダイジェストを割り当てるためです。割り当ては以下のように行うことができます。</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
<span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このコードでは、記憶トークンで使用したトークンのメソッドやダイジェストのメソッドをストレートに使いまわしています。<a class="hyperref" href="log_in_log_out?version=4.2#code-user_model_remember">リスト<span class="ref">8.32</span></a>の<code>remember</code>メソッドと比べてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># 永続セッションのためにユーザーをデータベースに記憶する</span>
<span class="k">def</span> <span class="nf">remember</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
  <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">主な違いは、後者の<code>update_attribute</code>の使い方にあります。この違いは、記憶トークンやダイジェストは既にデータベースにいるユーザーのために作成される (その分やりやすい) のに対し、<code>before_create</code>コールバックの方はユーザーが作成される<em>前</em>に呼び出される (その分面倒) ことが原因です。このコールバックがあることで、(<a class="hyperref" href="sign_up?version=4.2#code-create_action_strong_parameters">リスト<span class="ref">7.17</span></a>でユーザー登録を行ったときに)<code>User.new</code>で新しいユーザーが定義されると、<code>activation_token</code>属性や<code>activation_digest</code>属性を自動的に得られます。後者のactivation_digest属性は既にデータベースのカラムとの関連付けができあがっている (<a class="hyperref" href="#fig-user_model_account_activation">図<span class="ref">10.1</span></a>) ので、ユーザーが保存されるときに一緒に自動保存されます。</p>
<p>上で説明したことをUserモデルに実装すると<a class="hyperref" href="#code-user_model_activation_code">リスト<span class="ref">10.3</span></a>のようになります。有効化トークンは本質的に仮のものでなければならないので、このモデルの<code>attr_accessor</code>にもうひとつ追加しました。メールアドレスを小文字にするときにもメソッド参照が使用される機会があることにご注目ください。</p>
<div class="codelisting" id="code-user_model_activation_code" data-tralics-id="uid1017" data-number="10.3">
<div class="heading">
<span class="number">リスト10.3:</span> 

<span class="description">Userモデルにアカウント有効化のコードを追加する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span>
</span><span class="hll">  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
</span><span class="hll">  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="c1"># メールアドレスをすべて小文字にする</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</span>    <span class="k">end</span>

    <span class="c1"># 有効化トークンとダイジェストを作成およびアサインする</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>先に進む前に、サンプルデータとフィクスチャも更新し、テスト時のサンプルとユーザーを事前に有効化しておきましょう (<a class="hyperref" href="#code-seed_users_activated">リスト<span class="ref">10.4</span></a>と<a class="hyperref" href="#code-fixture_users_activated">リスト<span class="ref">10.5</span></a>)。なお、<code>Time.zone.now</code>はRailsの組み込みヘルパーであり、サーバーのタイムゾーンに応じたタイムスタンプを返します。</p>
<div class="codelisting" id="code-seed_users_activated" data-tralics-id="uid1018" data-number="10.4">
<div class="heading">
<span class="number">リスト10.4:</span> 

<span class="description">サンプルユーザーを最初から有効にしておく <span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">admin</span><span class="p">:</span>     <span class="kp">true</span><span class="p">,</span>
<span class="hll">             <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class="hll">             <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>
<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
              <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
              <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
<span class="hll">              <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class="hll">              <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-fixture_users_activated" data-tralics-id="uid1019" data-number="10.5">
<div class="heading">
<span class="number">リスト10.5:</span> 

<span class="description">フィクスチャのユーザーを有効にしておく <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
  <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">archer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sterling Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duchess@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">lana</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Lana Kane</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hands@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">mallory</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Mallory Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">boss@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
<span class="l-Scalar-Plain">user_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">&lt;%= "User</span> <span class="c1">#{n}" %&gt;</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= "user-#{n}@example.com" %&gt;</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span><span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</pre></div></div>
</div>
<p>いつものようにデータベースを初期化して、サンプルデータを再度生成し直し、<a class="hyperref" href="#code-seed_users_activated">リスト<span class="ref">10.4</span></a>の変更を反映します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
$ bundle exec rake db:seed
</pre></div></div>
</div>
<div id="sec-account_activation_mailer" class="subsection" data-tralics-id="uid1020" data-number="10.1.2">
<h3><a href="#sec-account_activation_mailer" class="heading hyperref"><span class="number">10.1.2 </span>AccountActivationsメイラーメソッド</a></h3>
<p>データのモデル化が終わったので、今度はアカウント有効化メールの送信に必要なコードを追加しましょう。このメソッドではAction Mailerライブラリを使用してUserの<em>メイラー</em>を追加します。このメイラーはUsersコントローラの<code>create</code>アクションで有効化リンクをメール送信するために使用します。メイラーの構成はコントローラのアクションとよく似ており、メールのテンプレートをビューと同じ要領で定義できます。この節ではメイラーとビューを定義して、有効化トークンとメールアドレス (=有効にするアカウントのアドレス) を含むリンクをその中で使用します。</p>
<p>メイラーは、モデルやコントローラと同様に<code>rails generate</code>で生成できます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate mailer UserMailer account_activation password_reset
</pre></div></div>
<p class="noindent">上のコマンドを実行したことで、本節で必要となる<code>account_activation</code>メソッドと、次節 (<a class="hyperref" href="#sec-password_reset"><span class="ref">10.2</span></a>) で必要となる<code>password_reset</code>メソッドが生成されました。</p>
<p>生成したメイラーごとに、ビューテンプレートが2つずつ生成されます。1つはテキストメール用のテンプレート、1つはHTMLメール用テンプレートです。アカウント有効化メイラーメソッドのテンプレートを<a class="hyperref" href="#code-generated_account_activation_view_text">リスト<span class="ref">10.6</span></a>と<a class="hyperref" href="#code-generated_account_activation_view_html">リスト<span class="ref">10.7</span></a>に示します。</p>
<div class="codelisting" id="code-generated_account_activation_view_text" data-tralics-id="uid1021" data-number="10.6">
<div class="heading">
<span class="number">リスト10.6:</span> 

<span class="description">アカウント有効化メイラーのテキストビュー (自動生成) <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.text.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre>UserMailer#account_activation

<span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span>, find me in app/views/user_mailer/account_activation.text.erb
</pre></div></div>
</div>
<div class="codelisting" id="code-generated_account_activation_view_html" data-tralics-id="uid1022" data-number="10.7">
<div class="heading">
<span class="number">リスト10.7:</span> 

<span class="description">アカウント有効化メイラーのHTMLビュー (自動生成) <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>UserMailer#account_activation<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span>, find me in app/views/user_mailer/account_activation.html.erb
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p>生成されたメイラーの動作を簡単に追ってみましょう (<a class="hyperref" href="#code-generated_application_mailer">リスト<span class="ref">10.8</span></a>と<a class="hyperref" href="#code-generated_user_mailer">リスト<span class="ref">10.9</span></a>)。<a class="hyperref" href="#code-generated_application_mailer">リスト<span class="ref">10.8</span></a>には、デフォルトの<code>from</code>アドレス (アプリケーション全体で共通) があります。<a class="hyperref" href="#code-generated_user_mailer">リスト<span class="ref">10.9</span></a>の各メソッドには宛先メールアドレスもあります。<a class="hyperref" href="#code-generated_application_mailer">リスト<span class="ref">10.8</span></a>ではメールのフォーマットに対応するメイラーレイアウトも使用されています。なお本チュートリアルの説明には直接関係ありませんが、生成されるHTMLメイラーのレイアウトやテキストメイラーのレイアウトは<code>app/views/layouts</code>で確認できます。生成されたコードにはインスタンス変数<code>@greeting</code>も含まれています。このインスタンス変数は、ちょうど普通のビューでコントローラのインスタンス変数を利用できるのと同じように、メイラービューで利用できます。</p>
<div class="codelisting" id="code-generated_application_mailer" data-tralics-id="uid1023" data-number="10.8">
<div class="heading">
<span class="number">リスト10.8:</span> 

<span class="description">生成されたApplicationメイラー <span class="break"></span> <span class="filepath">app/mailers/application_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"from@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-generated_user_mailer" data-tralics-id="uid1024" data-number="10.9">
<div class="heading">
<span class="number">リスト10.9:</span> 

<span class="description">生成されたUserメイラー <span class="break"></span> <span class="filepath">app/mailers/user_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.account_activation.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.password_reset.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>最初に、生成されたテンプレートをカスタマイズして、実際に有効化メールで使えるようにします (<a class="hyperref" href="#code-application_mailer">リスト<span class="ref">10.10</span></a>)。次に、ユーザーを含むインスタンス変数を作成してビューで使えるようにし、<code>user.email</code>にメール送信します (<a class="hyperref" href="#code-mail_account_activation">リスト<span class="ref">10.11</span></a>)。<a class="hyperref" href="#code-mail_account_activation">リスト<span class="ref">10.11</span></a>では、<code>mail</code>に<code>subject</code>キーも引数として渡しています。この値はメールの件名になります。</p>
<div class="codelisting" id="code-application_mailer" data-tralics-id="uid1025" data-number="10.10">
<div class="heading">
<span class="number">リスト10.10:</span> 

<span class="description">新しいデフォルトの<code>from</code>アドレスを使用するアプリケーションメイラー <span class="break"></span> <span class="filepath">app/mailers/application_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"noreply@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-mail_account_activation" data-tralics-id="uid1026" data-number="10.11">
<div class="heading">
<span class="number">リスト10.11:</span> 

<span class="description">アカウント有効化リンクをメール送信する <span class="break"></span> <span class="filepath">app/mailers/user_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

<span class="hll">  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Account activation"</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>

    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>テンプレートビューは、通常のビューと同様ERBで自由にカスタマイズできます。ここでは挨拶文にユーザー名を含め、カスタムの有効化リンクを追加します。この後、Railsサーバーでユーザーをメールアドレスで検索して有効化トークンを認証できるようにしたいので、リンクにはメールアドレスとトークンを両方含めておく必要があります。AccountActivationsリソースで有効化をモデル化したので、トークン自体は<a class="hyperref" href="#code-account_activations_route">リスト<span class="ref">10.1</span></a>で定義した名前付きルートの引数で使用されます。</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">ここで思い出してみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_user_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上のメソッドは、以下の形式のURLを生成します。</p>
<div class="code"><div class="highlight"><pre>http://www.example.com/users/1/edit
</pre></div></div>
<p class="noindent">これに対応するアカウント有効化リンクのベースURLは以下のようになります。</p>
<div class="code"><div class="highlight"><pre>http://www.example.com/account_activations/q5lt38hQDc_959PVoo6b7A/edit
</pre></div></div>
<p class="noindent">上のURLの「<code>q5lt38hQDc_959PVoo6b7A</code>」という部分は<code>new_token</code>メソッドで生成されたものです (<a class="hyperref" href="log_in_log_out?version=4.2#code-token_method">リスト<span class="ref">8.31</span></a>)。URLで使用できるようにBase64でエンコードされています。これはちょうど/users/1/editの「1」のようなユーザーIDと同じ役割を果たします。このトークンは、特にActivationsコントローラの<code>edit</code>アクションでは<code>params</code>ハッシュで<code>params[:id]</code>として参照できます。</p>
<p><em>クエリパラメータ</em>を使用して、このURLにメールアドレスもうまく組み込んでみましょう。クエリパラメータとは、URLの末尾で疑問符「?」に続けてキーと値のペアを記述したものです<sup class="footnote" id="cha-10_footnote-ref-6"><a href="#cha-10_footnote-6">6</a></sup>。</p>
<div class="code"><div class="highlight"><pre>account_activations/q5lt38hQDc_959PVoo6b7A/edit?email=foo%40example.com
</pre></div></div>
<p class="noindent">メールアドレスの「@」記号はURLでは「<code>%40</code>」とBase64エンコードで表現されています。これは「エスケープ」と呼ばれる手法で、ここではURLで通常使用できない文字を含めるために使用されます。Railsでクエリパラメータを設定するには、以下のように名前付きルートにハッシュを追加します。</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このようにして名前付きルートでクエリパラメータを定義すると、Railsが特殊な文字を自動的にエスケープしてくれます。コントローラで<code>params[:email]</code>からメールアドレスを取り出すときには、自動的にエスケープを解除してくれます。</p>
<p>ここまでできれば、<a class="hyperref" href="#code-mail_account_activation">リスト<span class="ref">10.11</span></a>で定義した<code>@user</code>インスタンス変数、editへの名前付きルート、ERBを組み合わせて、必要なリンクを作成できます (<a class="hyperref" href="#code-account_activation_view_text">リスト<span class="ref">10.12</span></a>と<a class="hyperref" href="#code-account_activation_view_html">リスト<span class="ref">10.13</span></a>)。<a class="hyperref" href="#code-account_activation_view_html">リスト<span class="ref">10.13</span></a>のHTMLテンプレートでは、正しいリンクを組立てるために<code>link_to</code>メソッドを使用していることにご注目ください。</p>
<div class="codelisting" id="code-account_activation_view_text" data-tralics-id="uid1028" data-number="10.12">
<div class="heading">
<span class="number">リスト10.12:</span> 

<span class="description">アカウント有効化のテキストビュー <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.text.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre>Hi <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>,

Welcome to the Sample App! Click on the link below to activate your account:

<span class="cp">&lt;%=</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-account_activation_view_html" data-tralics-id="uid1029" data-number="10.13">
<div class="heading">
<span class="number">リスト10.13:</span> 

<span class="description">アカウント有効化のHTMLビュー <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>Hi <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>,<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
Welcome to the Sample App!Click on the link below to activate your account:
<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Activate"</span><span class="p">,</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>
                                                    <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-account_activation_view_text">リスト<span class="ref">10.12</span></a>や<a class="hyperref" href="#code-account_activation_view_html">リスト<span class="ref">10.13</span></a>で定義したテンプレートの実際の表示を簡単に確認するために、<em>メールプレビュー</em>という裏技を使ってみましょう。Railsでは、特殊なURLにアクセスするとメールのメッセージをその場でプレビューすることができます。メールを実際に送信しなくてもよいので大変便利です。これを利用するには、アプリケーションのdevelopment環境の設定に手を加える必要があります (<a class="hyperref" href="#code-development_email_settings">リスト<span class="ref">10.14</span></a>)。</p>
<div class="codelisting" id="code-development_email_settings" data-tralics-id="uid1030" data-number="10.14">
<div class="heading">
<span class="number">リスト10.14:</span> 

<span class="description">development環境のメール設定 <span class="break"></span> <span class="filepath">config/environments/development.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'example.com'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-development_email_settings">リスト<span class="ref">10.14</span></a>のホスト名「<code>’example.com’</code>」の部分は各自のdevelopment環境に合わせて変更してください。たとえば、著者のシステムでは以下のどちらでも動くようになっています (クラウドIDEとローカルサーバーで使い分けています)。</p>
<div class="code"><div class="highlight"><pre><span class="n">host</span> <span class="o">=</span> <span class="s1">'rails-tutorial-c9-mhartl.c9.io'</span>     <span class="c1"># クラウド IDE</span>
</pre></div></div>
<p class="noindent">または</p>
<div class="code"><div class="highlight"><pre><span class="n">host</span> <span class="o">=</span> <span class="s1">'localhost:3000'</span>                     <span class="c1"># ローカルサーバー</span>
</pre></div></div>
<p>developmentサーバーを再起動して<a class="hyperref" href="#code-development_email_settings">リスト<span class="ref">10.14</span></a>の設定を読み込んだら、次は<a class="hyperref" href="#sec-account_activation_mailer"><span class="ref">10.1.2</span></a>で自動生成したUserメイラーの<em>プレビューファイル</em>の更新が必要です (<a class="hyperref" href="#code-generated_user_mailer_previews">リスト<span class="ref">10.15</span></a>)。</p>
<div class="codelisting" id="code-generated_user_mailer_previews" data-tralics-id="uid1031" data-number="10.15">
<div class="heading">
<span class="number">リスト10.15:</span> 

<span class="description">Userメイラープレビュー (自動生成) <span class="break"></span> <span class="filepath">test/mailers/previews/user_mailer_preview.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-mail_account_activation">リスト<span class="ref">10.11</span></a>で定義した<code>account_activation</code>の引数には有効な (=実在する) ユーザーオブジェクトを渡す必要があるため、<a class="hyperref" href="#code-generated_user_mailer_previews">リスト<span class="ref">10.15</span></a>はこのままでは動きません。これを回避するために、<code>user</code>変数をdevelopmentデータベースの最初のユーザーになるように定義して、それを<code>UserMailer.account_activation</code>に引数として渡します (<a class="hyperref" href="#code-account_activation_preview">リスト<span class="ref">10.16</span></a>)。<a class="hyperref" href="#code-account_activation_preview">リスト<span class="ref">10.16</span></a>では<code>user.activation_token</code>にも値を代入している点にご注目ください。<a class="hyperref" href="#code-account_activation_view_text">リスト<span class="ref">10.12</span></a>や<a class="hyperref" href="#code-account_activation_view_html">リスト<span class="ref">10.13</span></a>のアカウント有効化テンプレートではアカウント有効化トークンが必要なので、代入は省略できません。なお、<code>activation_token</code>は仮の属性でしかないので (<a class="hyperref" href="#sec-account_activations_resource"><span class="ref">10.1.1</span></a>)、データベースのユーザーはこの値を実際には持っていません。</p>
<div class="codelisting" id="code-account_activation_preview" data-tralics-id="uid1032" data-number="10.16">
<div class="heading">
<span class="number">リスト10.16:</span> 

<span class="description">アカウント有効化のプレビューメソッド (動作可能) <span class="break"></span> <span class="filepath">test/mailers/previews/user_mailer_preview.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-account_activation_preview">リスト<span class="ref">10.16</span></a>のプレビューコードを実装すると、指定のURLでアカウント有効化メールをプレビューできるようになります (クラウドIDEをご利用の場合は、<code>localhost:3000</code>の部分を対応するベースURLに置き換えてください)。HTMLメールとテキストメールのプレビューを<a class="hyperref" href="#fig-account_activation_html_preview">図<span class="ref">10.2</span></a>と<a class="hyperref" href="#fig-account_activation_text_preview">図<span class="ref">10.3</span></a>に示します。</p>
<div class="center figure" id="fig-account_activation_html_preview" data-tralics-id="uid1033" data-number="10.2">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/account_activation_html_preview.png" alt="images/figures/account_activation_html_preview"></div>
<div class="caption">
<span class="header">図10.2: </span><span class="description">アカウント有効化メールのプレビュー (HTMLバージョン)
</span>
</div>
</div>
<div class="center figure" id="fig-account_activation_text_preview" data-tralics-id="uid1034" data-number="10.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/account_activation_text_preview.png" alt="images/figures/account_activation_text_preview"></div>
<div class="caption">
<span class="header">図10.3: </span><span class="description">アカウント有効化メールのプレビュー (テキストバージョン)
</span>
</div>
</div>
<p>最後に、このメールプレビューのテストも作成して、プレビューをダブルチェックできるようにします。便利なテスト例がRailsによって自動生成されているので (<a class="hyperref" href="#code-generated_user_mailer_test">リスト<span class="ref">10.17</span></a>)、これを利用すればテストの作成は割と簡単です。</p>
<div class="codelisting" id="code-generated_user_mailer_test" data-tralics-id="uid1035" data-number="10.17">
<div class="heading">
<span class="number">リスト10.17:</span> 

<span class="description">Userメイラーのテスト (Railsによる自動生成) <span class="break"></span> <span class="filepath">test/mailers/user_mailer_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-generated_user_mailer_test">リスト<span class="ref">10.17</span></a>のテストでは、<code>assert_match</code>という非常に強力なメソッドが使用されています。これを使えば、正規表現で文字列をテストできます。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_match</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># false</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'$#!*+@'</span>      <span class="c1"># false</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#code-real_account_activation_test">リスト<span class="ref">10.18</span></a>のテストでは、<code>assert_match</code>メソッドを使用して名前、有効化トークン、エスケープ済みメールアドレスがメール本文に含まれているかどうかをテストします。最後にもうひとつ小技をお教えします。</p>
<div class="code"><div class="highlight"><pre><span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このメソッドを使うと、ユーザーのメールのテストをエスケープできます<sup class="footnote" id="cha-10_footnote-ref-7"><a href="#cha-10_footnote-7">7</a></sup>。</p>
<div class="codelisting" id="code-real_account_activation_test" data-tralics-id="uid1037" data-number="10.18">
<div class="heading">
<span class="number">リスト10.18:</span> 

<span class="description">現在のメールの実装をテストする <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/mailers/user_mailer_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>               <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-real_account_activation_test">リスト<span class="ref">10.18</span></a>のテストコードでは、フィクスチャユーザーに有効化トークンを追加している点にご注目ください。追加しない場合は空白になります。</p>
<p>このテストがパスするには、テストファイル内のドメイン名を正しく設定する必要があります (<a class="hyperref" href="#code-test_domain_host">リスト<span class="ref">10.19</span></a>)。</p>
<div class="codelisting" id="code-test_domain_host" data-tralics-id="uid1038" data-number="10.19">
<div class="heading">
<span class="number">リスト10.19:</span> 

<span class="description">テストのドメインホストを設定する <span class="break"></span> <span class="filepath">config/environments/test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
<span class="hll">  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'example.com'</span> <span class="p">}</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">上のコードを使用すると、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1039" data-tralics-id="uid1039" data-number="10.20">
<div class="heading">
<span class="number">リスト10.20:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test:mailers
</pre></div></div>
</div>
<p>あとはユーザー登録を行う<code>create</code>アクションに数行追加するだけで、メイラーをアプリケーションで実際に使うことができます (<a class="hyperref" href="#code-user_signup_with_account_activation">リスト<span class="ref">10.21</span></a>)。<a class="hyperref" href="#code-user_signup_with_account_activation">リスト<span class="ref">10.21</span></a>では、登録時のリダイレクトの挙動が変更されている点にご注意ください。変更前は、ユーザーのプロファイルページ (<a class="hyperref" href="sign_up?version=4.2#sec-successful_signups"><span class="ref">7.4</span></a>) にリダイレクトしていましたが、アカウント有効化を実装するうえでは無意味な動作なので、リダイレクト先をルートURLに変更してあります。</p>
<div class="codelisting" id="code-user_signup_with_account_activation" data-tralics-id="uid1040" data-number="10.21">
<div class="heading">
<span class="number">リスト10.21:</span> 

<span class="description">ユーザー登録にアカウント有効化を追加する <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span><span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-user_signup_with_account_activation">リスト<span class="ref">10.21</span></a>ではリダイレクト先をプロファイルページからルートURLに変更し、かつユーザーは以前のようにログインしないようになっています。したがって、アプリケーションの動作が仮に正しくても、現在のテストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になります。そこで、失敗が発生するテストの行をひとまずコメントアウトしておきます (<a class="hyperref" href="#code-comment_out_failing_tests">リスト<span class="ref">10.22</span></a>)。コメントアウトした部分は、<a class="hyperref" href="#sec-activation_test_and_refactoring"><span class="ref">10.1.4</span></a>でアカウント有効化のテストをパスさせるときに元に戻します。</p>
<div class="codelisting" id="code-comment_out_failing_tests" data-tralics-id="uid1041" data-number="10.22">
<div class="heading">
<span class="number">リスト10.22:</span> 

<span class="description">失敗するテストを一時的にコメントアウトする <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
<span class="hll">    <span class="c1"># assert_template 'users/show'</span>
</span><span class="hll">    <span class="c1"># assert is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>この状態で実際に新規ユーザーとして登録してみると、リダイレクトされて<a class="hyperref" href="#fig-redirected_not_activated">図<span class="ref">10.4</span></a>のようになり、<a class="hyperref" href="#code-account_activation_email">リスト<span class="ref">10.23</span></a>のようなメールが生成されます。ただし、実際にメールが生成されるわけでは<em>ない</em>のでご注意ください。ここに引用したのはサーバーログに出力されたメールです (メールが見えるまで多少スクロールが必要でしょう)。production環境で実際にメール送信する方法については<a class="hyperref" href="#sec-email_in_production"><span class="ref">10.3</span></a>で説明します。</p>
<div class="codelisting" id="code-account_activation_email" data-tralics-id="uid1042" data-number="10.23">
<div class="heading">
<span class="number">リスト10.23:</span> 

<span class="description">サーバーログに表示されたアカウント有効化メールの例</span>
</div>

<div class="code"><div class="highlight"><pre>Sent mail to michael@michaelhartl.com (931.6ms)
Date: Wed, 03 Sep 2014 19:47:18 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;540770474e16_61d3fd1914f4cd0300a0@mhartl-rails-tutorial-953753.mail&gt;
Subject: Account activation
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5407704656b50_61d3fd1914f4cd02996a";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5407704656b50_61d3fd1914f4cd02996a
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Hi Michael Hartl,

Welcome to the Sample App! Click on the link below to activate your account:

http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com
----==_mimepart_5407704656b50_61d3fd1914f4cd02996a
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;h1&gt;Sample App&lt;/h1&gt;

&lt;p&gt;Hi Michael Hartl,&lt;/p&gt;

&lt;p&gt;
Welcome to the Sample App! Click on the link below to activate your account:
&lt;/p&gt;

&lt;a href="http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com"&gt;Activate&lt;/a&gt;
----==_mimepart_5407704656b50_61d3fd1914f4cd02996a--
</pre></div></div>
</div>
<div class="center figure" id="fig-redirected_not_activated" data-tralics-id="uid1043" data-number="10.4">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/redirected_not_activated.png" alt="images/figures/redirected_not_activated"></div>
<div class="caption">
<span class="header">図10.4: </span><span class="description">登録後リダイレクトしたホームページにアカウント有効化確認のメッセージが表示される
</span>
</div>
</div>
</div>
<div id="sec-activating_the_account" class="subsection" data-tralics-id="uid1044" data-number="10.1.3">
<h3><a href="#sec-activating_the_account" class="heading hyperref"><span class="number">10.1.3 </span>アカウントを有効化する</a></h3>
<p><a class="hyperref" href="#code-account_activation_email">リスト<span class="ref">10.23</span></a>のとおりにメールが生成できたら、今度はAccountActivationsコントローラの<code>edit</code>アクションを書いて、実際にユーザーを有効化できるようにする必要があります。ここで、有効化トークンとメールをそれぞれ<code>params[:id]</code>と<code>params[:email]</code>で参照できる (<a class="hyperref" href="#sec-account_activation_mailer"><span class="ref">10.1.2</span></a>) ことを思い出してみましょう。パスワードのモデル (<a class="hyperref" href="log_in_log_out?version=4.2#code-find_authenticate_user">リスト<span class="ref">8.5</span></a>) と記憶トークン (<a class="hyperref" href="log_in_log_out?version=4.2#code-persistent_current_user">リスト<span class="ref">8.36</span></a>) で学んだことを元に、次のようなコードでユーザーを検索して認証することにします。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">(この後、上の式にひとつ論理値を追加します。何が追加されるか考えてみましょう)。</p>
<p>上のコードで使用している<code>authenticated?</code>メソッドは、アカウント有効化のダイジェストと、渡されたトークンが一致するかどうかをチェックします。ただし、このメソッドは記憶トークン (<a class="hyperref" href="log_in_log_out?version=4.2#code-authenticated_p">リスト<span class="ref">8.33</span></a>) 用なので今は正常に動作しません。</p>
<div class="code"><div class="highlight"><pre><span class="c1"># トークンがダイジェストと一致したらtrueを返す</span>
<span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><code>remember_digest</code>はUserモデルの属性であり、モデル内では以下のように書き換えることができます。</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">remember_digest</span>
</pre></div></div>
<p class="noindent">上をどうにかして<em>変数</em>として扱いたいのです。そこで以下を呼び出すことにします。</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>
</pre></div></div>
<p class="noindent"><code>authenticated?</code>に該当のパラメータを渡す代わりに、上のようにします。</p>
<p>この一見不思議な手法は「<em>メタプログラミング</em>」の最初の例になります。メタプログラミングを一言で言うと「プログラムでプログラムを作成する」ことです。メタプログラミングはRubyが有するきわめて強力な機能であり、Railsの一見魔法のような機能 (訳注:&nbsp;「黒魔術」と呼ばれることもあります) の多くは、Rubyのメタプログラミングによって実現されています。ここで重要なのは、<code>send</code>メソッドの強力きわまる機能です。このメソッドは、与えられたオブジェクトに「メッセージを送る」ことによって、メソッド呼び出しに自由に名前を付けることができます。たとえば、このコンソールセッションでネイティブのRubyオブジェクトに<code>send</code>メソッドを実行して、配列の長さを得るとします。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:length</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'length'</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
</pre></div></div>
<p class="noindent">上のコードで、シンボル<code>:length</code>や文字列<code>’length’</code>を<code>send</code>メソッドに渡していますが、これは与えられたオブジェクト (ここではa) の<code>length</code>メソッドを呼び出すことと完全に同等です。もうひとつ例をお見せします。データベースの最初のユーザーが持つ<code>activation_digest</code>属性にアクセスしてみます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">activation_digest</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:activation_digest</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'activation_digest'</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="hll"><span class="gp">&gt;&gt; </span><span class="n">attribute</span> <span class="o">=</span> <span class="ss">:activation</span>
</span><span class="hll"><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
</span><span class="hll"><span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
</span></pre></div></div>
<p class="noindent">最後の例では、シンボル<code>:activation</code>に等しい<code>attribute</code>変数を定義し、文字列の式展開 (interpolation) を使用して引数を正しく組み立ててから、<code>send</code>に渡していることです。文字列<code>’activation’</code>でも同じことができますが、Rubyではシンボルを使う方が普通です。</p>
<div class="code"><div class="highlight"><pre><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span>
</pre></div></div>
<p class="noindent">シンボルと文字列どちらを使用した場合にも、上のコードは以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="s2">"activation_digest"</span>
</pre></div></div>
<p class="noindent">文字列は式展開されます (<a class="hyperref" href="sign_up?version=4.2#sec-the_flash"><span class="ref">7.4.2</span></a>でシンボルが式展開されて文字列になったことを思い出しましょう)。</p>
<p><code>send</code>メソッドの動作原理がわかったので、それに基いて<code>authenticated?</code>メソッドを書き換えます。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'remember_digest'</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">この配置されたテンプレートで、関数の引数にダイジェスト名を追加してこのメソッドを一般化し、続いて上のように文字列の式展開を使用します。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">(上では2番目の引数<code>token</code>の名前を変更して、メソッドが一般化されたことをあえて強調しています)。このコードはモデル内にあるので<code>self</code>は省略できます。最終的にRubyらしく書かれたコードは次のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent">ここまでできれば、以下のように呼び出すことで<code>authenticated?</code>の従来の振舞いを再現できます。</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>以上の説明を実際のUserモデルに適用してできた、一般化された<code>authenticated?</code>メソッドを<a class="hyperref" href="#code-generalized_authenticated_p">リスト<span class="ref">10.24</span></a>に示します。</p>
<div class="codelisting" id="code-generalized_authenticated_p" data-tralics-id="uid1045" data-number="10.24">
<div class="heading">
<span class="number">リスト10.24:</span> 

<span class="description">一般化した<code>authenticated?</code>メソッド <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># トークンがダイジェストと一致したらtrueを返す</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-generalized_authenticated_p">リスト<span class="ref">10.24</span></a>のキャプションに示されているとおり、テストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になります。</p>
<div class="codelisting" id="uid1046" data-tralics-id="uid1046" data-number="10.25">
<div class="heading">
<span class="number">リスト10.25:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">テストが失敗する理由は、<code>current_user</code>メソッド (<a class="hyperref" href="log_in_log_out?version=4.2#code-persistent_current_user">リスト<span class="ref">8.36</span></a>) と<code>nil</code>ダイジェストのテスト (<a class="hyperref" href="log_in_log_out?version=4.2#code-test_authenticated_invalid_token">リスト<span class="ref">8.43</span></a>) の両方で、<code>authenticated?</code>が古いままになっており、引数も2つではなくまだ1つのままです。これを解消するために両者を更新して、新しい一般的なメソッドを使用するようにします (<a class="hyperref" href="#code-generalized_current_user">リスト<span class="ref">10.26</span></a>と<a class="hyperref" href="#code-test_authenticated_invalid_token_updated">リスト<span class="ref">10.27</span></a>)。</p>
<div class="codelisting" id="code-generalized_current_user" data-tralics-id="uid1047" data-number="10.26">
<div class="heading">
<span class="number">リスト10.26:</span> 

<span class="description"><code>current_user</code>内の一般化した<code>authenticated?</code>メソッド<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 現在ログイン中のユーザーを返す (いる場合)</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-test_authenticated_invalid_token_updated" data-tralics-id="uid1048" data-number="10.27">
<div class="heading">
<span class="number">リスト10.27:</span> 

<span class="description">Userテスト内の一般化した<code>authenticated?</code>メソッド <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
<span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>今度はテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1049" data-tralics-id="uid1049" data-number="10.28">
<div class="heading">
<span class="number">リスト10.28:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">コードにこのようなリファクタリングを施すと非常にエラーが発生しやすくなるので (訳注: 黒魔術と呼ばれる理由でもあります)、しっかりしたテストスイートが不可欠です。<a class="hyperref" href="log_in_log_out?version=4.2#sec-login_with_remembering"><span class="ref">8.4.2</span></a>や<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_tests"><span class="ref">8.4.6</span></a>でよいテストを書くためにあえてトラブルを発生させてみたのはそうした理由からです。</p>
<p><code>authenticated?</code>が<a class="hyperref" href="#code-generalized_authenticated_p">リスト<span class="ref">10.24</span></a>のようになったことで、やっと<code>edit</code>アクションを書く準備ができました。このアクションは、<code>params</code>ハッシュで与えられたメールアドレスに対応するユーザーを認証します。ユーザーが有効であることを確認する中核部分は以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent"><code>!user.activated?</code>という記述にご注目ください。先ほど「ひとつ論理値を追加します」と言っていたのはこのことです。このコードは、既に有効になっているユーザーを誤って再度有効化しないために必要です。正当であろうとなかろうと、有効化が行われるとユーザーはログイン状態になります。もしこのコードがなければ、攻撃者がユーザーの有効化リンクを後から盗みだしてクリックするだけで、本当のユーザーとしてログインできてしまいます。そうした攻撃を防ぐためにこのコードは非常に重要です。</p>
<p>上の論理値に基いてユーザーを認証するには、ユーザーを認証してから<code>activated_at</code>タイムスタンプを更新する必要があります。(update_attributesではなくupdate_attributeを実行していることに注目してください。update_attributesだとバリデーションが実行されてしまうため、今回のようにパスワードを入力していない状態で更新すると、バリデーションで失敗してしまいます。)</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上のコードを<code>edit</code>アクション (<a class="hyperref" href="#code-account_activation_edit_action">リスト<span class="ref">10.29</span></a>) で使用します。<a class="hyperref" href="#code-account_activation_edit_action">リスト<span class="ref">10.29</span></a>では有効化トークンが無効だった場合の処理も行われている点にご注目ください。トークンが無効になるようなことは実際にはめったにありませんが、もしそうなった場合はルートURLにリダイレクトされる仕組みです。</p>
<div class="codelisting" id="code-account_activation_edit_action" data-tralics-id="uid1050" data-number="10.29">
<div class="heading">
<span class="number">リスト10.29:</span> 

<span class="description">アカウントを有効化する<code>edit</code>アクション <span class="break"></span> <span class="filepath">app/controllers/account_activations_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-account_activation_edit_action">リスト<span class="ref">10.29</span></a>のコードを使用すると、<a class="hyperref" href="#code-account_activation_email">リスト<span class="ref">10.23</span></a>にあるURLを貼り付けてユーザーを有効化できます。著者のシステム上では、以下のURLをブラウザで開くと、</p>
<div class="code"><div class="highlight"><pre>http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#fig-activated_user">図<span class="ref">10.5</span></a>のようになりました。</p>
<div class="center figure" id="fig-activated_user" data-tralics-id="uid1051" data-number="10.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/activated_user.png" alt="images/figures/activated_user"></div>
<div class="caption">
<span class="header">図10.5: </span><span class="description">有効化が成功した場合に表示されるプロファイルページ
</span>
</div>
</div>
<p>もちろん、この時点ではユーザーのログイン方法を変更していないので、ユーザーの有効化にはまだ<em>何の意味もありません</em>。ユーザーの有効化が役に立つためには、ユーザーが有効である場合にのみログインできるようにログイン方法を変更する必要があります。<a class="hyperref" href="#code-preventing_unactivated_logins">リスト<span class="ref">10.30</span></a>に示したように、これを行うには<code>user.activated?</code>がtrueの場合にのみログインを許可し、そうでない場合はルートURLにリダイレクトして<code>warning</code>で警告を表示します (<a class="hyperref" href="#fig-not_activated_warning">図<span class="ref">10.6</span></a>)。</p>
<div class="codelisting" id="code-preventing_unactivated_logins" data-tralics-id="uid1052" data-number="10.30">
<div class="heading">
<span class="number">リスト10.30:</span> 

<span class="description">有効でないユーザーがログインすることのないようにする<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">        <span class="n">redirect_back_or</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">else</span>
</span><span class="hll">        <span class="n">message</span>  <span class="o">=</span> <span class="s2">"Account not activated. "</span>
</span><span class="hll">        <span class="n">message</span> <span class="o">+=</span> <span class="s2">"Check your email for the activation link."</span>
</span><span class="hll">        <span class="n">flash</span><span class="o">[</span><span class="ss">:warning</span><span class="o">]</span> <span class="o">=</span> <span class="n">message</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-not_activated_warning" data-tralics-id="uid1053" data-number="10.6">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/not_activated_warning.png" alt="images/figures/not_activated_warning"></div>
<div class="caption">
<span class="header">図10.6: </span><span class="description">有効になっていないユーザーに表示される警告メッセージ
</span>
</div>
</div>
<p>これで、ユーザー有効化機能のおおまかな部分については実装できました (改良すべき点として、有効化されていないユーザーが表示されないようにする必要もあるのですが、これは<a class="hyperref" href="#sec-activation_resets_exercises"><span class="ref">10.5</span></a>の課題に回すことにします)。次の<a class="hyperref" href="#sec-activation_test_and_refactoring"><span class="ref">10.1.4</span></a>でテストをもう少し追加し、リファクタリングを少々施せば完了です。</p>
</div>
<div id="sec-activation_test_and_refactoring" class="subsection" data-tralics-id="uid1054" data-number="10.1.4">
<h3><a href="#sec-activation_test_and_refactoring" class="heading hyperref"><span class="number">10.1.4 </span>有効化のテストとリファクタリング</a></h3>
<p>この節では、アカウント有効化の統合テストを追加します。正しい情報でユーザー登録を行った場合のテスト (<a class="hyperref" href="sign_up?version=4.2#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>) は既にあるので、<a class="hyperref" href="sign_up?version=4.2#sec-a_test_for_valid_submission"><span class="ref">7.4.4</span></a>で開発したテストに若干手を加えることにします。追加される行数はそこそこ多いのですが、基本的に素直なので心配はありません。<a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>をご覧ください。</p>
<div class="codelisting" id="code-signup_with_account_activation_test" data-tralics-id="uid1055" data-number="10.31">
<div class="heading">
<span class="number">リスト10.31:</span> 

<span class="description">ユーザー登録のテストにアカウント有効化を追加する <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"valid signup information with account activation"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
<span class="hll">      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
</span>                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
    <span class="c1"># 有効化していない状態でログインしてみる</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># 有効化トークンが不正な場合</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="s2">"invalid token"</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># トークンは正しいがメールアドレスが無効な場合</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'wrong'</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># 有効化トークンが正しい場合</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">activated?</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>のコードは分量が多いように見えますが、本当に重要な部分は以下の1行です。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
</pre></div></div>
<p class="noindent">上のコードは、配信されたメッセージがきっかり1つであるかどうかを確認します。配列<code>deliveries</code>はグローバルなので、<code>setup</code>メソッドでこれを初期化しておかないと、並行して行われる他のテストでメールが配信されたときにエラーで中断してしまいます (<a class="hyperref" href="#sec-password_reset_test"><span class="ref">10.2.5</span></a>でも似た事例をご紹介します)。<a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>の<code>assigns</code>メソッドは本チュートリアル初登場です。<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out">第<span class="ref">8</span>章</a>の演習 (<a class="hyperref" href="log_in_log_out?version=4.2#sec-log_in_out_exercises"><span class="ref">8.6</span></a>) で説明したように、<code>assigns</code>メソッドを使用すると、対応するアクション内にあるインスタンス変数にアクセスできるようになります。たとえば、Usersコントローラの<code>create</code>アクションでは<code>@user</code>というインスタンス変数が定義されています (<a class="hyperref" href="#code-user_signup_with_account_activation">リスト<span class="ref">10.21</span></a>) ので、テストで<code>assigns(:user)</code>とするとこのインスタンス変数にアクセスできるようになります。最後に、<a class="hyperref" href="#code-comment_out_failing_tests">リスト<span class="ref">10.22</span></a>でコメントアウトしておいた行を<a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>で元に戻していることにご注意ください。</p>
<p>これでテストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1056" data-tralics-id="uid1056" data-number="10.32">
<div class="heading">
<span class="number">リスト10.32:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>のテストができたので、ユーザー操作の一部をコントローラからモデルに移動するというささやかなリファクタリングを行う準備ができました。ここでは特に、<code>activate</code>メソッドを作成してユーザーの有効化属性を更新し、<code>send_activation_email</code>メソッドを作成して有効化メールを送信します。この新しいメソッドを<a class="hyperref" href="#code-user_activation_methods">リスト<span class="ref">10.33</span></a>に示します。また、リファクタリングされたアプリケーションコードを<a class="hyperref" href="#code-user_signup_refactored">リスト<span class="ref">10.34</span></a>と<a class="hyperref" href="#code-account_activation_refactored">リスト<span class="ref">10.35</span></a>に示します。</p>
<div class="codelisting" id="code-user_activation_methods" data-tralics-id="uid1057" data-number="10.33">
<div class="heading">
<span class="number">リスト10.33:</span> 

<span class="description">Userモデルにユーザー有効化メソッドを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># アカウントを有効にする</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 有効化用のメールを送信する</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-user_signup_refactored" data-tralics-id="uid1058" data-number="10.34">
<div class="heading">
<span class="number">リスト10.34:</span> 

<span class="description">ユーザーモデルオブジェクトからメールを送信する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="vi">@user</span><span class="o">.</span><span class="n">send_activation_email</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-account_activation_refactored" data-tralics-id="uid1059" data-number="10.35">
<div class="heading">
<span class="number">リスト10.35:</span> 

<span class="description">ユーザーモデルオブジェクト経由でアカウントを有効化する<span class="break"></span> <span class="filepath">app/controllers/account_activations_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">user</span><span class="o">.</span><span class="n">activate</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-user_activation_methods">リスト<span class="ref">10.33</span></a>では<code>user.</code>という記法を使用していないことにご注目ください。Userモデルにはそのような変数はないので、これがあるとエラーになります。</p>
<div class="code"><div class="highlight"><pre><span class="gd">-user.update_attribute(:activated,    true)</span>
<span class="gd">-user.update_attribute(:activated_at, Time.zone.now)</span>
<span class="gi">+update_attribute(:activated,    true)</span>
<span class="gi">+update_attribute(:activated_at, Time.zone.now)</span>
</pre></div></div>
<p class="noindent">(<code>user</code>を<code>self</code>に切り替えるという手もあるのですが、<code>self</code>はモデル内では必須ではないと<a class="hyperref" href="modeling_users?version=4.2#sec-uniqueness_validation"><span class="ref">6.2.5</span></a>で解説したことを思い出しましょう)。Userメイラー内の呼び出しでは、<code>@user</code>が<code>self</code>に変更されている点にもご注目ください。</p>
<div class="code"><div class="highlight"><pre><span class="gd">-UserMailer.account_activation(@user).deliver_now</span>
<span class="gi">+UserMailer.account_activation(self).deliver_now</span>
</pre></div></div>
<p class="noindent">どんなに簡単なリファクタリングであっても、<em>この手の</em>変更はつい忘れてしまうものです。テストをきちんと書いておけば、この種の見落としを検出できます。以上でテストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1060" data-tralics-id="uid1060" data-number="10.36">
<div class="heading">
<span class="number">リスト10.36:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>ついにアカウントの有効化を実装できました。きりのよい所でGitにコミットしておきましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Add account activations"</span>
</pre></div></div>
</div>
</div><div id="sec-password_reset" class="section" data-tralics-id="cid67" data-number="10.2">
<h2><a href="#sec-password_reset" class="heading hyperref"><span class="number">10.2 </span>パスワードの再設定</a></h2>
<p>アカウント有効化の実装が完了し、ユーザーのメールアドレスが正しいことを確認できるようになったので、今度はユーザーがパスワードを忘れてしまった場合に対応できるようにしましょう。実際にやってみるとわかると思いますが、パスワード再設定の仕組みは、アカウント有効化と似ている部分が多く、<a class="hyperref" href="#sec-account_activation"><span class="ref">10.1</span></a>で学んだ手法の多くをここでも適用できます。とは言うものの、最初の部分はそれなりに異なります。アカウントの有効化と異なり、パスワードを再設定する場合はビューを1つ変更する必要があり、新しいフォームも2つ (メールレイアウト用と新しいパスワードの送信用) 必要です。</p>
<p>コードを実際に書く前に、パスワード再設定の想定手順をモックアップ (=スクリーンショット画像を改変して作った模型) で確かめましょう。まず、サンプルアプリケーションのログインフォームに「forgot password」リンクを追加します (<a class="hyperref" href="#fig-login_forgot_password_mockup">図<span class="ref">10.7</span></a>)。この「forgot password」リンクをクリックするとフォームが表示され、そこにメールアドレスを入力してメールを送信すると、そのメールにパスワード再設定用のリンクが記載されています (<a class="hyperref" href="#fig-forgot_password_form_mockup">図<span class="ref">10.8</span></a>)。この再設定用のリンクをクリックすると、ユーザーのパスワードを再設定してよいかどうかの確認を求めるフォームが表示されます (<a class="hyperref" href="#fig-reset_password_form_mockup">図<span class="ref">10.9</span></a>)。</p>
<div class="center figure" id="fig-login_forgot_password_mockup" data-tralics-id="uid1061" data-number="10.7">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_forgot_password_mockup.png" alt="images/figures/login_forgot_password_mockup"></div>
<div class="caption">
<span class="header">図10.7: </span><span class="description">「forgot password」リンクのモックアップ
</span>
</div>
</div>
<div class="center figure" id="fig-forgot_password_form_mockup" data-tralics-id="uid1062" data-number="10.8">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/forgot_password_form_mockup.png" alt="images/figures/forgot_password_form_mockup"></div>
<div class="caption">
<span class="header">図10.8: </span><span class="description">「forgot password」フォームのモックアップ
</span>
</div>
</div>
<div class="center figure" id="fig-reset_password_form_mockup" data-tralics-id="uid1063" data-number="10.9">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/reset_password_form_mockup.png" alt="images/figures/reset_password_form_mockup"></div>
<div class="caption">
<span class="header">図10.9: </span><span class="description">パスワード再設定用フォームのモックアップ
</span>
</div>
</div>
<p>アカウント有効化の際と似ていて、PasswordResetsリソースを作成して、再設定用のトークンとそれに対応するダイジェストを保存するのが今回の目的となります。全体の流れは以下のとおりです。</p>
<ol>
<li>ユーザーがパスワードの再設定をリクエストすると、ユーザーが送信したメールアドレスをキーにしてデータベースからユーザーを見つける。
</li>
<li>該当のメールアドレスがデータベースにある場合は、再設定用トークンとそれに対応する再設定用ダイジェストを生成する。
</li>
<li>再設定用ダイジェストはデータベースに保存しておき、再設定用トークンはメールアドレスと一緒に、ユーザーに送信する有効化用メールのリンクに仕込んでおく。
</li>
<li>ユーザーがメールのリンクをクリックしたら、アプリケーションはメールアドレスをキーにしてユーザーを探し、データベース内に保存しておいた再設定用ダイジェストと比較することでトークンを認証する。</li>
<li>認証に成功したら、パスワード変更用のフォームをユーザーに表示する。
</li>
</ol>
<div id="sec-password_resets_resource" class="subsection" data-tralics-id="uid1069" data-number="10.2.1">
<h3><a href="#sec-password_resets_resource" class="heading hyperref"><span class="number">10.2.1 </span>PasswordResetsリソース</a></h3>
<p>アカウント有効化 (<a class="hyperref" href="#sec-account_activations_resource"><span class="ref">10.1.1</span></a>) の場合と同様、最初に新しいリソースで使用するコントローラを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller PasswordResets new edit --no-test-framework
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#sec-account_activations_resource"><span class="ref">10.1.1</span></a>のときと同様にテストを生成しないようにするフラグを追加し、代わりに<a class="hyperref" href="#sec-activation_test_and_refactoring"><span class="ref">10.1.4</span></a>の統合テストを生成するようにします。</p>
<p>新しいパスワードを再設定するためのフォーム (<a class="hyperref" href="#fig-forgot_password_form_mockup">図<span class="ref">10.8</span></a>) と、Userモデル内のパスワードを変更するためのフォーム (<a class="hyperref" href="#fig-reset_password_form_mockup">図<span class="ref">10.9</span></a>) が両方必要になるので、今回は<code>new</code>、<code>create</code>、<code>edit</code>、<code>update</code>のルーティングも必要になります。この変更は、ルーティングファイルの<code>resources</code>行で行います (<a class="hyperref" href="#code-password_resets_resource">リスト<span class="ref">10.37</span></a>)。</p>
<div class="codelisting" id="code-password_resets_resource" data-tralics-id="uid1070" data-number="10.37">
<div class="heading">
<span class="number">リスト10.37:</span> 

<span class="description">パスワード再設定用リソースを追加する<span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-password_resets_resource">リスト<span class="ref">10.37</span></a>のコードはRESTfulのルーティング (<a class="hyperref" href="#table-RESTful_password_resets">表<span class="ref">10.2</span></a>) に従っています。特に、<a class="hyperref" href="#table-RESTful_password_resets">表<span class="ref">10.2</span></a>の最初のルーティングでは「forgot password」フォームへのリンク作成に以下を使用しています。</p>
<div class="code"><div class="highlight"><pre><span class="n">new_password_reset_path</span>
</pre></div></div>
<p class="noindent">(<a class="hyperref" href="#code-log_in_password_reset">リスト<span class="ref">10.38</span></a>と<a class="hyperref" href="#fig-forgot_password_link">図<span class="ref">10.10</span></a>参照)</p>
<div class="table" id="table-RESTful_password_resets" data-tralics-id="uid1071" data-number="10.2">
<table class="tabular">
<tbody><tr class="bottom_border">
<td class="align_left"><strong>HTTPリクエスト</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>アクション</strong></td>
<td class="align_left"><strong>名前付きルート</strong></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/password_resets/new</td>
<td class="align_left"><code>new</code></td>
<td class="align_left"><code>new_password_reset_path</code></td>
</tr>
<tr>
<td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/password_resets</td>
<td class="align_left"><code>create</code></td>
<td class="align_left"><code>password_resets_path</code></td>
</tr>
<tr>
<td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/password_resets/&lt;トークン&gt;/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left"><code>edit_password_reset_path(トークン)</code></td>
</tr>
<tr>
<td class="align_left"><span class="tt">PATCH</span></td>
<td class="align_left">/password_resets/&lt;トークン&gt;</td>
<td class="align_left"><code>update</code></td>
<td class="align_left"><code>password_reset_path(トークン)</code></td>
</tr>
</tbody></table>
<div class="caption">
<span class="header">表10.2: </span><span class="description"><a class="hyperref" href="#code-password_resets_resource">リスト<span class="ref">10.37</span></a>のPasswordResetsリソースで提供されるRESTfulルーティング
</span>
</div>
</div>
<div class="codelisting" id="code-log_in_password_reset" data-tralics-id="uid1072" data-number="10.38">
<div class="heading">
<span class="number">リスト10.38:</span> 

<span class="description">パスワード再設定画面へのリンクを追加する<span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"(forgot password)"</span><span class="p">,</span> <span class="n">new_password_reset_path</span> <span class="cp">%&gt;</span>
</span>      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-forgot_password_link" data-tralics-id="uid1073" data-number="10.10">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/forgot_password_link.png" alt="images/figures/forgot_password_link"></div>
<div class="caption">
<span class="header">図10.10: </span><span class="description">「forgot password」リンクのあるログインページ
</span>
</div>
</div>
<p>パスワード再設定のデータモデルも、アカウント有効化の場合と似ています (<a class="hyperref" href="#fig-user_model_account_activation">図<span class="ref">10.1</span></a>)。記憶トークン (<a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_me"><span class="ref">8.4</span></a>) とアカウント有効化トークン (<a class="hyperref" href="#sec-account_activation"><span class="ref">10.1</span></a>) で設定したパターンに従い、パスワードの再設定でも、メールに記載する仮想の再設定用トークンと、ユーザーの取得で使う再設定用ダイジェストをペアにすることにします。トークンをハッシュ化せずにデータベースに保存すると、トークンが攻撃者によってデータベースから読み出されたときにセキュリティ上の問題が生じます: 攻撃者がユーザーのメールアドレスにパスワード再設定のリクエストを送信し、このメールと盗んだトークンを使用して攻撃者がパスワード再設定リンクを開けば、アカウントを奪い取ることができてしまいます。従って、パスワードの再設定では必ずダイジェストを使用してください。セキュリティ上の注意点をもうひとつ。再設定用のリンクはなるべく短時間 (数時間以内) で<em>期限切れ</em>になるようにしなければなりません。そのために、再設定メールの送信時刻も記録する必要があります。以上に基いて<code>reset_digest</code>属性と<code>reset_sent_at</code>属性を追加したユーザーデータベースは<a class="hyperref" href="#fig-user_model_password_reset">図<span class="ref">10.11</span></a>のようになります。</p>
<div class="center figure" id="fig-user_model_password_reset" data-tralics-id="uid1074" data-number="10.11">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_password_reset.png" alt="user_model_password_reset"></span>
<div class="caption">
<span class="header">図10.11: </span><span class="description">パスワード再設定で使用する属性を追加したUserモデル
</span>
</div>
</div>
<p>以下を実行して、マイグレーションに<a class="hyperref" href="#fig-user_model_password_reset">図<span class="ref">10.11</span></a>の属性を追加します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_reset_to_users reset_digest:string <span class="se">\</span>
<span class="gp">&gt;</span> reset_sent_at:datetime
</pre></div></div>
<p class="noindent">(上記の2行目にある '&gt;' という文字は、改行を示すためにシェルが自動的に挿入する文字です。手動で入力しないよう、注意してください) 後はいつものようにマイグレーションを実行します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
</div>
<div id="sec-password_resets_controller_and_form" class="subsection" data-tralics-id="uid1075" data-number="10.2.2">
<h3><a href="#sec-password_resets_controller_and_form" class="heading hyperref"><span class="number">10.2.2 </span>PasswordResetsコントローラとフォーム</a></h3>
<p>新しいパスワード再設定の画面を作成するために、前節でActive Recordを使用しないリソースを新規作成したときの手法、つまり、新しいセッションを作成するためのログインフォーム (<a class="hyperref" href="log_in_log_out?version=4.2#code-login_form">リスト<span class="ref">8.2</span></a>) をここでも使用することにします。参考までに<a class="hyperref" href="#code-login_form_redux">リスト<span class="ref">10.39</span></a>を再掲したのでご覧ください。</p>
<div class="codelisting" id="code-login_form_redux" data-tralics-id="uid1076" data-number="10.39">
<div class="heading">
<span class="number">リスト10.39:</span> 

<span class="description">ログインフォームのコード (再掲)<span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p>新しいパスワード再設定フォームは<a class="hyperref" href="#code-login_form_redux">リスト<span class="ref">10.39</span></a>と多くの共通点がありますが、重要な違いとして、<code>form_for</code>の呼び出しで使用するリソースとURLが異なっていることと、パスワード属性が省略されていることが挙げられます。変更を反映した結果を<a class="hyperref" href="#code-new_password_reset">リスト<span class="ref">10.40</span></a>と<a class="hyperref" href="#fig-forgot_password_form">図<span class="ref">10.12</span></a>に示します。</p>
<div class="codelisting" id="code-new_password_reset" data-tralics-id="uid1077" data-number="10.40">
<div class="heading">
<span class="number">リスト10.40:</span> 

<span class="description">新しいパスワード再設定画面<span class="break"></span> <span class="filepath">app/views/password_resets/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Forgot password"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Forgot password<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:password_reset</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_resets_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<div class="center figure" id="fig-forgot_password_form" data-tralics-id="uid1078" data-number="10.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/forgot_password_form.png" alt="images/figures/forgot_password_form"></div>
<div class="caption">
<span class="header">図10.12: </span><span class="description">「forgot password」フォーム
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-forgot_password_form">図<span class="ref">10.12</span></a>のフォームから送信を行なった後、メールアドレスをキーとしてユーザーをデータベースから見つけ、パスワード再設定用トークンと送信時のタイムスタンプでデータベースの属性を更新する必要があります。それに続いてルートURLにリダイレクトし、フラッシュメッセージをユーザーに表示します。送信が無効の場合は、ログイン (<a class="hyperref" href="log_in_log_out?version=4.2#code-correct_login_failure">リスト<span class="ref">8.9</span></a>) と同様に<code>new</code>ページを出力して<code>flash.now</code>メッセージを表示します。変更の結果を<a class="hyperref" href="#code-create_password_reset">リスト<span class="ref">10.41</span></a>に示します。</p>
<div class="codelisting" id="code-create_password_reset" data-tralics-id="uid1079" data-number="10.41">
<div class="heading">
<span class="number">リスト10.41:</span> 

<span class="description">パスワード再設定用の<code>create</code>アクション<span class="break"></span> <span class="filepath">app/controllers/password_resets_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_reset</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">create_reset_digest</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">send_password_reset_email</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>Userモデル内のコードは、<code>before_create</code>コールバック (<a class="hyperref" href="#code-user_model_activation_code">リスト<span class="ref">10.3</span></a>) 内で使用される<code>create_activation_digest</code>メソッドと似ています(<a class="hyperref" href="#code-user_model_password_reset">リスト<span class="ref">10.42</span></a>)。</p>
<div class="codelisting" id="code-user_model_password_reset" data-tralics-id="uid1080" data-number="10.42">
<div class="heading">
<span class="number">リスト10.42:</span> 

<span class="description">Userモデルにパスワード再設定用メソッドを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span><span class="p">,</span> <span class="ss">:reset_token</span>
</span>  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># アカウントを有効にする</span>
  <span class="k">def</span> <span class="nf">activate</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 有効化用のメールを送信する</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># パスワード再設定の属性を設定する</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_digest</span><span class="p">,</span>  <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">reset_token</span><span class="p">))</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># パスワード再設定のメールを送信する</span>
  <span class="k">def</span> <span class="nf">send_password_reset_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># メールアドレスをすべて小文字にする</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>

    <span class="c1"># 有効化トークンとダイジェストを作成および代入する</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#fig-invalid_email_password_reset">図<span class="ref">10.13</span></a>に示すように、この時点でのアプリケーションは、無効なメールアドレスを入力した場合に正常に動作します。正しいメールアドレスを送信した場合にもアプリケーションが正常に動作するためには、パスワード再設定のメイラーメソッドを定義する必要があります。</p>
<div class="center figure" id="fig-invalid_email_password_reset" data-tralics-id="uid1081" data-number="10.13">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/invalid_email_password_reset.png" alt="images/figures/invalid_email_password_reset"></div>
<div class="caption">
<span class="header">図10.13: </span><span class="description">「forgot password」フォームに無効なメールアドレスを入力した場合
</span>
</div>
</div>
</div>
<div id="sec-password_reset_mailer" class="subsection" data-tralics-id="uid1082" data-number="10.2.3">
<h3><a href="#sec-password_reset_mailer" class="heading hyperref"><span class="number">10.2.3 </span>PasswordResetsメイラーメソッド</a></h3>
<p><a class="hyperref" href="#code-user_model_password_reset">リスト<span class="ref">10.42</span></a>でパスワード再設定のメールを送信するコードは、以下の部分です。</p>
<div class="code"><div class="highlight"><pre><span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</pre></div></div>
<p class="noindent">上のコードが動作するために必要なパスワード再設定用メイラーメソッドは、<a class="hyperref" href="#sec-account_activation_mailer"><span class="ref">10.1.2</span></a>で開発したアカウント有効化用メイラーメソッドとほぼ同じです。最初にユーザーメイラーに<code>password_reset</code>メソッドを作成し (<a class="hyperref" href="#code-mail_password_reset">リスト<span class="ref">10.43</span></a>)、続いてテキストメールのビューテンプレート (<a class="hyperref" href="#code-password_reset_text">リスト<span class="ref">10.44</span></a>) と HTMLメールのビューテンプレート (<a class="hyperref" href="#code-password_reset_html">リスト<span class="ref">10.45</span></a>) をそれぞれ定義します。</p>
<div class="codelisting" id="code-mail_password_reset" data-tralics-id="uid1083" data-number="10.43">
<div class="heading">
<span class="number">リスト10.43:</span> 

<span class="description">パスワード再設定のリンクをメール送信する<span class="break"></span> <span class="filepath">app/mailers/user_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Account activation"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Password reset"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-password_reset_text" data-tralics-id="uid1084" data-number="10.44">
<div class="heading">
<span class="number">リスト10.44:</span> 

<span class="description">パスワード再設定のテンプレート (テキストメール)<span class="break"></span> <span class="filepath">app/views/user_mailer/password_reset.text.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre>To reset your password click the link below:

<span class="cp">&lt;%=</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>

This link will expire in two hours. 

If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
</pre></div></div>
</div>
<div class="codelisting" id="code-password_reset_html" data-tralics-id="uid1085" data-number="10.45">
<div class="heading">
<span class="number">リスト10.45:</span> 

<span class="description">パスワード再設定のテンプレート (HTMLメール)<span class="break"></span> <span class="filepath">app/views/user_mailer/password_reset.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Password reset<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>To reset your password click the link below:<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Reset password"</span><span class="p">,</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span>
                                                      <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;p&gt;</span>This link will expire in two hours.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
</div>
<p>アカウント有効化メールの場合 (<a class="hyperref" href="#sec-account_activation_mailer"><span class="ref">10.1.2</span></a>) と同様、Railsのメールプレビュー機能でパスワード再設定のメールをプレビューしましょう。そのためのコードは<a class="hyperref" href="#code-account_activation_preview">リスト<span class="ref">10.16</span></a>と基本的にまったく同じです (<a class="hyperref" href="#code-password_reset_preview">リスト<span class="ref">10.46</span></a>)。</p>
<div class="codelisting" id="code-password_reset_preview" data-tralics-id="uid1086" data-number="10.46">
<div class="heading">
<span class="number">リスト10.46:</span> 

<span class="description">パスワード再設定のプレビューメソッド (動作可能)<span class="break"></span> <span class="filepath">test/mailers/previews/user_mailer_preview.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-password_reset_preview">リスト<span class="ref">10.46</span></a>のコードで、HTMLメールとテキストメールをそれぞれプレビューできるようになります (<a class="hyperref" href="#fig-password_reset_html_preview">図<span class="ref">10.14</span></a>と<a class="hyperref" href="#fig-password_reset_text_preview">図<span class="ref">10.15</span></a>)。</p>
<div class="center figure" id="fig-password_reset_html_preview" data-tralics-id="uid1087" data-number="10.14">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/password_reset_html_preview.png" alt="images/figures/password_reset_html_preview"></div>
<div class="caption">
<span class="header">図10.14: </span><span class="description">パスワード再設定メールのプレビュー (HTMLバージョン)
</span>
</div>
</div>
<div class="center figure" id="fig-password_reset_text_preview" data-tralics-id="uid1088" data-number="10.15">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/password_reset_text_preview.png" alt="images/figures/password_reset_text_preview"></div>
<div class="caption">
<span class="header">図10.15: </span><span class="description">パスワード再設定メールのプレビュー (テキストバージョン)
</span>
</div>
</div>
<p>アカウント有効化メイラーメソッドのテスト (<a class="hyperref" href="#code-real_account_activation_test">リスト<span class="ref">10.18</span></a>) の場合と同様、パスワード再設定用メイラーメソッドのテストを書くことにします (<a class="hyperref" href="#code-password_reset_mailer_test">リスト<span class="ref">10.47</span></a>)。ただし、有効化トークンの場合と異なり、パスワード再設定用トークンはビューの中で使用される点にご注意ください。有効化トークンは<code>before_create</code>コールバックでユーザーひとりひとりに対して作成されます (<a class="hyperref" href="#code-user_model_activation_code">リスト<span class="ref">10.3</span></a>) が、パスワード再設定用用トークンの方はユーザーが「forgot password」フォームを送信できた場合にだけ作成されます。この動作は統合テストで自然に行われます (<a class="hyperref" href="#code-password_reset_integration_test">リスト<span class="ref">10.54</span></a>) が、このテストではパスワード再設定用トークンを手動で作成する必要があります。</p>
<div class="codelisting" id="code-password_reset_mailer_test" data-tralics-id="uid1089" data-number="10.47">
<div class="heading">
<span class="number">リスト10.47:</span> 

<span class="description">パスワード再設定用メイラーメソッドのテストを追加する<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/mailers/user_mailer_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>               <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span>    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span>        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">これでテストスイートは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1090" data-tralics-id="uid1090" data-number="10.48">
<div class="heading">
<span class="number">リスト10.48:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-mail_password_reset">リスト<span class="ref">10.43</span></a>、<a class="hyperref" href="#code-password_reset_text">リスト<span class="ref">10.44</span></a>、<a class="hyperref" href="#code-password_reset_html">リスト<span class="ref">10.45</span></a>のコードを使用すると、正しいメールアドレスを送信したときの画面は<a class="hyperref" href="#fig-valid_email_password_reset">図<span class="ref">10.16</span></a>のようになります。このメールはサーバーログでは<a class="hyperref" href="#code-password_reset_email">リスト<span class="ref">10.49</span></a>のように表示されます。</p>
<div class="center figure" id="fig-valid_email_password_reset" data-tralics-id="uid1091" data-number="10.16">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/valid_email_password_reset.png" alt="images/figures/valid_email_password_reset"></div>
<div class="caption">
<span class="header">図10.16: </span><span class="description">有効なメールアドレスを送信した場合
</span>
</div>
</div>
<div class="codelisting" id="code-password_reset_email" data-tralics-id="uid1092" data-number="10.49">
<div class="heading">
<span class="number">リスト10.49:</span> 

<span class="description">サーバーログに表示されたパスワード再設定メールの例</span>
</div>

<div class="code"><div class="highlight"><pre>Sent mail to michael@michaelhartl.com (66.8ms)
Date: Thu, 04 Sep 2014 01:04:59 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;5407babbee139_8722b257d04576a@mhartl-rails-tutorial-953753.mail&gt;
Subject: Password reset
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5407babbe3505_8722b257d045617";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

To reset your password click the link below:

http://rails-tutorial-c9-mhartl.c9.io/password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com

This link will expire in two hours.

If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;h1&gt;Password reset&lt;/h1&gt;

&lt;p&gt;To reset your password click the link below:&lt;/p&gt;

&lt;a href="http://rails-tutorial-c9-mhartl.c9.io/
password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com"&gt;Reset password&lt;/a&gt;

&lt;p&gt;This link will expire in two hours.&lt;/p&gt;

&lt;p&gt;
If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
&lt;/p&gt;
----==_mimepart_5407babbe3505_8722b257d045617--
</pre></div></div>
</div>
</div>
<div id="sec-resetting_the_password" class="subsection" data-tralics-id="uid1093" data-number="10.2.4">
<h3><a href="#sec-resetting_the_password" class="heading hyperref"><span class="number">10.2.4 </span>パスワードを再設定する</a></h3>
<p>以下のようなフォームリンクが動作するためには、</p>
<div class="code"><div class="highlight"><pre>http://example.com/password_resets/3BdBrXeQZSWqFIDRN8cxHA/edit?email=foo%40bar.com
</pre></div></div>
<p class="noindent">パスワード再設定のフォームが必要です。この作業はユーザーのeditビューでユーザーを更新する (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-user_edit_view">リスト<span class="ref">9.2</span></a>) のと似ていますが、今回はパスワード入力フィールドと確認用フィールドだけを使います。今回は少しだけ面倒な点があります。メールアドレスをキーとしてユーザーを検索するということは、<code>edit</code>アクションと<code>update</code>アクションの両方でメールアドレスが必要になるということです。例のメールアドレス入りリンクのおかげで、<code>edit</code>アクションでメールアドレスを取り出すのは問題ありません。しかしフォームを送信するとこの値は消えてしまいます。この値はどこに保持しておくのがよいのでしょうか。このメールアドレスの最適な保存方法は、<em>隠しフィールド</em>としてページ内に保存することです。これにより、フォームを送信すると他の情報と一緒にメールアドレスが送信されます。これらを反映したものを<a class="hyperref" href="#code-password_reset_form">リスト<span class="ref">10.50</span></a>に示します。</p>
<div class="codelisting" id="code-password_reset_form" data-tralics-id="uid1094" data-number="10.50">
<div class="heading">
<span class="number">リスト10.50:</span> 

<span class="description">パスワード再設定のフォーム<span class="break"></span> <span class="filepath">app/views/password_resets/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Reset password'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Reset password<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Update password"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-password_reset_form">リスト<span class="ref">10.50</span></a>では以下のフォームタグヘルパーを使用している点にご注意ください。</p>
<div class="code"><div class="highlight"><pre><span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
</pre></div></div>
<p class="noindent">以下のようないつものヘルパーではありません。</p>
<div class="code"><div class="highlight"><pre><span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
</pre></div></div>
<p class="noindent">これは、再設定用のリンクをクリックすると、前者ではメールアドレスが<code>params[:email]</code>に保存されますが、後者を使用すると<code>params[:user][:email]</code>に保存されてしまうからです。</p>
<p>今度は、このフォームを出力 (レンダリング) するためにPasswordResetsコントローラの<code>edit</code>アクション内で<code>@user</code>インスタンス変数を定義する必要があります。アカウント有効化 (<a class="hyperref" href="#code-account_activation_edit_action">リスト<span class="ref">10.29</span></a>) の場合と同様、<code>params[:email]</code>にあるメールアドレスに対応するユーザーをこの変数に保存します。続いて、<code>params[:id]</code> (<a class="hyperref" href="#code-generalized_authenticated_p">リスト<span class="ref">10.24</span></a>で定義した、一般化された<code>authenticated?</code>メソッド) の再設定用トークンを使用して、このユーザーが正当なものである (ユーザーが存在する、有効化されている、認証済みである) ことを確認します。<code>edit</code>アクションと<code>update</code>アクションのどちらの場合も正当な<code>@user</code>が存在する必要があるので、いくつかのbeforeフィルタを使用して@userの検索とバリデーションを行います (<a class="hyperref" href="#code-password_reset_edit_action">リスト<span class="ref">10.51</span></a>)。</p>
<div class="codelisting" id="code-password_reset_edit_action" data-tralics-id="uid1095" data-number="10.51">
<div class="heading">
<span class="number">リスト10.51:</span> 

<span class="description">パスワード再設定の<code>edit</code>アクション<span class="break"></span> <span class="filepath">app/controllers/password_resets_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class="hll">  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">get_user</span>
<span class="hll">      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="k">end</span>

    <span class="c1"># 正しいユーザーを確認する</span> 
    <span class="k">def</span> <span class="nf">valid_user</span>
<span class="hll">      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span>
</span><span class="hll">              <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-password_reset_edit_action">リスト<span class="ref">10.51</span></a>では以下のコードを使用しています。</p>
<div class="code"><div class="highlight"><pre><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">上を以下のコードと比べてみましょう。</p>
<div class="code"><div class="highlight"><pre><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">このコードは<a class="hyperref" href="#code-generalized_current_user">リスト<span class="ref">10.26</span></a>で使用されていました。もうひとつ、</p>
<div class="code"><div class="highlight"><pre><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p class="noindent">これは<a class="hyperref" href="#code-account_activation_edit_action">リスト<span class="ref">10.29</span></a>で使用されていました。いずれの場合も、<a class="hyperref" href="#table-password_token_digest">表<span class="ref">10.1</span></a>の認証メソッドを完了します。</p>
<p>上のコードを使用することで、<a class="hyperref" href="#code-password_reset_email">リスト<span class="ref">10.49</span></a>のログにあるリンクを開いたときにパスワード再設定のフォームが出力されるようになります。実行結果を<a class="hyperref" href="#fig-password_reset_form">図<span class="ref">10.17</span></a>に示します。</p>
<div class="center figure" id="fig-password_reset_form" data-tralics-id="uid1096" data-number="10.17">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/password_reset_form.png" alt="images/figures/password_reset_form"></div>
<div class="caption">
<span class="header">図10.17: </span><span class="description">パスワード再設定のフォーム
</span>
</div>
</div>
<p><a class="hyperref" href="#code-password_reset_edit_action">リスト<span class="ref">10.51</span></a>の<code>edit</code>アクションに対応する<code>update</code>アクションを定義するには、4通りの場合分けに対応する必要があります: パスワード再設定の期限が切れている場合、更新に成功した場合、更新が失敗した場合 (パスワードが正しくないなど)、更新が失敗した場合 (一見更新が成功したように見えるがパスワードが2つとも空欄) です。1番目は<code>edit</code>アクションと <code>update</code>アクションの両方で対応する必要があるため、論理的にはbeforeフィルタで行うべきです (<a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>)。2番目と3番目はメインの<code>if</code>文の2つの分岐に対応します (<a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>)。editフォームはActive Recordモデルオブジェクト (ユーザーなど) を変更するので、エラーメッセージの出力に<a class="hyperref" href="#code-password_reset_form">リスト<span class="ref">10.50</span></a>の一部を共有できます。唯一の例外は、4番目のパスワードが空欄の場合です。現在のUserモデルでは空パスワードが許されている (<a class="hyperref" href="updating_and_deleting_users?version=4.2#code-allow_blank_password">リスト<span class="ref">9.10</span></a>) ので、空パスワードの場合については明示的に検出および対応する必要があります<sup class="footnote" id="cha-10_footnote-ref-8"><a href="#cha-10_footnote-8">8</a></sup>。今回は、以下のように<code>@user</code>オブジェクトのエラーメッセージにエラーを直接追加して対応することにします。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="s2">"can't be empty"</span><span class="p">)</span>
</pre></div></div>
<div class="codelisting" id="code-password_reset_update_action" data-tralics-id="uid1098" data-number="10.52">
<div class="heading">
<span class="number">リスト10.52:</span> 

<span class="description">パスワード再設定の<code>update</code>アクション<span class="break"></span> <span class="filepath">app/controllers/password_resets_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>         <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span>       <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:check_expiration</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_reset</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">create_reset_digest</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">send_password_reset_email</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
<span class="hll">    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:password</span><span class="o">].</span><span class="n">empty?</span>
</span>      <span class="n">@user<span class="o">.</span>errors</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="ss">:password, </span> <span class="s2">"can't be empty"</span><span class="o">)</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
<span class="hll">    <span class="k">elsif</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span>      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password has been reset."</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
<span class="hll">      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</span>    <span class="k">end</span>

    <span class="c1"># Beforeフィルタ</span>

    <span class="k">def</span> <span class="nf">get_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># 正しいユーザーを確認する</span>
<span class="hll">    <span class="k">def</span> <span class="nf">valid_user</span>
</span>      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span>
              <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
        <span class="n">redirect_to</span> <span class="n">root_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># 再設定用トークンが期限切れかどうかを確認する</span>
<span class="hll">    <span class="k">def</span> <span class="nf">check_expiration</span>
</span>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_expired?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password reset has expired."</span>
        <span class="n">redirect_to</span> <span class="n">new_password_reset_url</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>の実装では以下のコードを使用して、パスワード再設定の期限切れの論理値テストをUserモデルに委譲 (delegate) しています。</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_expired?</span>
</pre></div></div>
<p class="noindent">上のコードが動作するには、この<code>password_reset_expired?</code>メソッドを定義する必要があります。<a class="hyperref" href="#sec-password_reset_mailer"><span class="ref">10.2.3</span></a>のメールテンプレートのところで説明したように、パスワード再設定の期限を設定し、2時間以上パスワードが再設定されなかった場合は期限切れにする必要があります。これをRubyで表現すると以下のようになります。</p>
<div class="code"><div class="highlight"><pre><span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</pre></div></div>
<p class="noindent">この「<code>&lt;</code>」記号を「〜より少ない」と読んでしまうと、「パスワード再設定メール送信時から経過した時間が、2時間より少ない場合」となってしまい、ここで行おうとしていることと反対の意味になってしまいます。「<code>&lt;</code>」はここでは「〜より早い時刻」と読んでください。これなら「パスワード再設定メールの送信時刻が、現在時刻より2時間以上前の場合」となり、<em>期待どおり</em>の条件となります。そして条件が満たされると<a class="hyperref" href="#code-user_model_password_reset_expired">リスト<span class="ref">10.53</span></a>の<code>password_reset_expired?</code>メソッドが実行されます (この比較の公式な証明を<a class="hyperref" href="#sec-expiration_proof"><span class="ref">10.6</span></a>に付録として追加しました)。</p>
<div class="codelisting" id="code-user_model_password_reset_expired" data-tralics-id="uid1099" data-number="10.53">
<div class="heading">
<span class="number">リスト10.53:</span> 

<span class="description">Userモデルにパスワード再設定用メソッドを追加する<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># パスワード再設定の期限が切れている場合はtrueを返す</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
<span class="hll">    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-user_model_password_reset_expired">リスト<span class="ref">10.53</span></a>のコードを使用すると、<a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>の<code>update</code>アクションが動作するようになります。送信が無効だった場合と有効だった場合の画面をそれぞれ<a class="hyperref" href="#fig-password_reset_failure">図<span class="ref">10.18</span></a>と<a class="hyperref" href="#fig-password_reset_success">図<span class="ref">10.19</span></a>に示します (確認のために2時間も待っていられないので、テストにはもうひとつ分岐を追加しますが、これは<a class="hyperref" href="#sec-activation_resets_exercises"><span class="ref">10.5</span></a>の演習に回すことにします)。</p>
<div class="center figure" id="fig-password_reset_failure" data-tralics-id="uid1100" data-number="10.18">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/password_reset_failure.png" alt="images/figures/password_reset_failure"></div>
<div class="caption">
<span class="header">図10.18: </span><span class="description">パスワードの再設定が失敗した場合
</span>
</div>
</div>
<div class="center figure" id="fig-password_reset_success" data-tralics-id="uid1101" data-number="10.19">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/password_reset_success.png" alt="images/figures/password_reset_success"></div>
<div class="caption">
<span class="header">図10.19: </span><span class="description">パスワードの再設定が成功した場合
</span>
</div>
</div>
</div>
<div id="sec-password_reset_test" class="subsection" data-tralics-id="uid1102" data-number="10.2.5">
<h3><a href="#sec-password_reset_test" class="heading hyperref"><span class="number">10.2.5 </span>パスワードの再設定をテストする</a></h3>
<p>この節では、<a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>の2つ (または3つ) の分岐、つまり送信に成功した場合と失敗した場合の統合テストを作成します (前述のとおり、3番目の場合については演習に回します)。まずはパスワード再設定のテストファイルを生成しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test password_resets
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/password_resets_test.rb</span>
</pre></div></div>
<p>パスワード再設定をテストする手順は、アカウント有効化のテスト (<a class="hyperref" href="#code-signup_with_account_activation_test">リスト<span class="ref">10.31</span></a>) と多くの共通点がありますが、テストの冒頭部分には次のような違いがあります: 最初に「forgot password」フォームを表示して無効なメールアドレスを送信し、次はそのフォームで有効なメールアドレスを送信します。後者ではパスワード再設定用トークンが作成され、再設定用メールが送信されます。続いて、メールのリンクを開いて無効な情報を送信し、次にそのリンクから有効な情報を送信して、それぞれが期待どおりに動作することを確認します。作成したテストを<a class="hyperref" href="#code-password_reset_integration_test">リスト<span class="ref">10.54</span></a>に示します。このテストはコードリーディングのよい練習台になりますので、みっちりお読みください。</p>
<div class="codelisting" id="code-password_reset_integration_test" data-tralics-id="uid1103" data-number="10.54">
<div class="heading">
<span class="number">リスト10.54:</span> 

<span class="description">パスワード再設定の統合テスト<span class="break"></span> <span class="filepath">test/integration/password_resets_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password resets"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># メールアドレスが無効</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># メールアドレスが有効</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
    <span class="n">assert_not_equal</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reset_digest</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">reset_digest</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># パスワード再設定用フォーム</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="c1"># メールアドレスが無効</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 無効なユーザー</span>
    <span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="c1"># メールアドレスが正しく、トークンが無効</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="s1">'wrong token'</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># メールアドレスもトークンも有効</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/edit'</span>
    <span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="c1"># 無効なパスワードと確認</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobaz"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"barquux"</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># パスワードが空</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 有効なパスワードと確認</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobaz"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobaz"</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-password_reset_integration_test">リスト<span class="ref">10.54</span></a>で使用されているアイデアの大半は、本チュートリアルで既出です。今回の新しい要素は<code>input</code>タグぐらいでしょう。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
</pre></div></div>
<p class="noindent">上のコードは、<code>input</code>タグに正しい名前、type="hidden"、メールアドレスがあるかどうかを確認します。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"email"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"michael@example.com"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p><a class="hyperref" href="#code-password_reset_integration_test">リスト<span class="ref">10.54</span></a>のコードを使用すると、テストコードは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるはずです。</p>
<div class="codelisting" id="uid1104" data-tralics-id="uid1104" data-number="10.55">
<div class="heading">
<span class="number">リスト10.55:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-email_in_production" class="section" data-tralics-id="cid68" data-number="10.3">
<h2><a href="#sec-email_in_production" class="heading hyperref"><span class="number">10.3 </span>本番環境でのメール</a></h2>
<p>アカウント有効化とパスワード復旧の最大の山場であるこのセクションでは、いよいよproduction (本番) 環境でアプリケーションからメールを送信します。最初に無料のサービスを利用してメールを送信し、続いてアプリケーションの設定とデプロイを行います。</p>
<p>production環境からメール送信するために、「SendGrid」というHerokuアドオンを使用してアカウントを検証します (このアドオンを使用するにはHerokuアカウントにクレジットカードを設定する必要がありますが、アカウント検証では料金は発生しません)。本チュートリアルでは、「starter tier」というサービスを使用することにします。これは、(執筆時点では) 1日の最大メール数が400通までという制限がありますが、無料で使用することができます。アドオンをアプリに追加するには、以下のコマンドを実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku addons:create sendgrid:starter</pre></div></div>
<p>(訳注: herokuコマンドのバージョンが古いとここで失敗するかもしれません。その場合は、Heroku Toolbelt ( https://toolbelt.heroku.com/ ) を使って最新版に更新するか、次の古い文法のコマンドを試してみてください: $ heroku addons:add sendgrid:starter ) <br>
<br>
アプリケーションでSendGridアドオンを使用するには、production環境の<a href="https://ja.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol" target="_blank">SMTP</a>に情報を記入する必要があります。<a class="hyperref" href="#code-sendgrid_config">リスト<span class="ref">10.56</span></a>に示したとおり、本番Webサイトのアドレスを<code>host</code>変数に定義する必要もあります。</p>
<div class="codelisting" id="code-sendgrid_config" data-tralics-id="uid1105" data-number="10.56">
<div class="heading">
<span class="number">リスト10.56:</span> 

<span class="description">production環境のRailsでSendGridを使用する設定<span class="break"></span> <span class="filepath">config/environments/production.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'【ここにHerokuのサブドメインを入力】.herokuapp.com'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span> <span class="p">}</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s1">'smtp.sendgrid.net'</span><span class="p">,</span>
    <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_USERNAME'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_PASSWORD'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="s1">'heroku.com'</span><span class="p">,</span>
    <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-sendgrid_config">リスト<span class="ref">10.56</span></a>のメール設定にはSendGridアカウントの<code>user_name</code>と<code>password</code>設定を記入する行もありますが、そこには記入せず、必ず環境変数「<code>ENV</code>」に設定するよう十分ご注意ください。本番運用するアプリケーションでは、暗号化されていないIDやパスワードのような重要なセキュリティ情報は「絶対に」ソースコードに直接書き込まないでください。そのような情報は環境変数に記述し、そこからアプリケーションに読み込む必要があります。今回の場合、そうした変数はSendGridアドオンが自動的に設定してくれますが、<a class="hyperref" href="user_microposts?version=4.2#sec-image_upload_in_production"><span class="ref">11.4.4</span></a>では環境変数を自分で設定しなければなりません。参考までに、<a class="hyperref" href="#code-sendgrid_config">リスト<span class="ref">10.56</span></a>で使用するHerokuの環境変数を表示するには、以下のコマンドを実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku config:get SENDGRID_USERNAME
<span class="gp">$</span> heroku config:get SENDGRID_PASSWORD
</pre></div></div>
<p>この時点で、Gitのトピックブランチをmasterにマージしておきましょう。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git add -A
$ git commit -m "Add password resets &amp; email configuration"
$ git checkout master
$ git merge account-activation-password-reset
</pre></div></div>
<p class="noindent">続いてリモートリポジトリにプッシュし、Herokuにデプロイします。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push
$ git push heroku
$ heroku run rake db:migrate
</pre></div></div>
<p>Herokuへのデプロイが完了したら、自分が管理しているメールアドレスを使用して、production環境のサンプルアプリケーションでユーザー登録を行ってみましょう。<a class="hyperref" href="#sec-account_activations_resource"><span class="ref">10.1.1</span></a>で実装した有効化メールが配信されるはずです (<a class="hyperref" href="#fig-activation_email_production">図<span class="ref">10.20</span></a>)。また、パスワードを忘れた時の再設定手順も<a class="hyperref" href="#sec-password_reset"><span class="ref">10.2</span></a>で実装したとおりに動作するはずです (<a class="hyperref" href="#fig-reset_email_production">図<span class="ref">10.21</span></a>)。</p>
<div class="center figure" id="fig-activation_email_production" data-tralics-id="uid1106" data-number="10.20">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/activation_email_production.png" alt="images/figures/activation_email_production"></div>
<div class="caption">
<span class="header">図10.20: </span><span class="description">production環境から送信したアカウント有効化メール
</span>
</div>
</div>
<div class="center figure" id="fig-reset_email_production" data-tralics-id="uid1107" data-number="10.21">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/reset_email_production.png" alt="images/figures/reset_email_production"></div>
<div class="caption">
<span class="header">図10.21: </span><span class="description">production環境から送信したパスワード再設定メール
</span>
</div>
</div>
</div><div id="sec-activation_resets_conclusion" class="section" data-tralics-id="cid69" data-number="10.4">
<h2><a href="#sec-activation_resets_conclusion" class="heading hyperref"><span class="number">10.4</span> 最後に</a></h2>
<p>アカウント有効化機能とパスワード再設定機能が追加されたことで、ついにサンプルアプリケーションの登録、ログイン、ログアウト機能がすべて本格的に実装完了しました。<em>Railsチュートリアル</em>のこの後の章では、Twitterのようなマイクロポスト機能 (<a class="hyperref" href="user_microposts?version=4.2#cha-user_microposts">第<span class="ref">11</span>章</a>) と、フォロー中のユーザーの投稿のステータスフィード機能 (<a class="hyperref" href="following_users?version=4.2#cha-following_users">第<span class="ref">12</span>章</a>) の基本的な部分をサイトに搭載することにしましょう。それらの章では、Railsの強力な機能 (画像アップロード、カスタムのデータベースクエリ、<code>has_many</code>や<code>has_many :through</code>を使用した高度なデータベースモデリングなど) を多数紹介する予定です。</p>
<div id="sec-activation_resets_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid1108" data-number="10.4.1">
<h3><a href="#sec-activation_resets_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">10.4.1 </span>本章のまとめ</a></h3>
<ul>
<li>アカウント有効化は Active Recordオブジェクトではないが、セッションの場合と同様に、リソースでモデル化できる。
</li>
<li>メール送信のためのActive Mailerアクションやビューの生成機能がRailsに備わっている。
</li>
<li>Action MailerではテキストメールとHTMLメールを両方利用できる。
</li>
<li>メイラーアクションで定義したインスタンス変数は、他のアクションやビューと同様、メイラーのビューから参照できる。
</li>
<li>パスワードの再設定は Active Recordオブジェクトではないが、セッションやアカウント有効化の場合と同様に、リソースでモデル化できる。
</li>
<li>アカウント有効化やパスワード再設定では、ユーザーを有効化したりパスワードを再設定するために一意のURLを作成する。一意のURLには生成したトークンが使用される。
</li>
<li>メイラーのテストと統合テストは、どちらもUserメイラーの振舞いを確認するのに有用。
</li>
<li>SendGridを使用するとproduction環境からメールを送信できる。
</li>
</ul>
</div>
</div><div id="sec-activation_resets_exercises" class="section" data-tralics-id="cid70" data-number="10.5">
<h2><a href="#sec-activation_resets_exercises" class="heading hyperref"><span class="number">10.5</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>から購入いただいた方は無料で入手いただけます。</p>
<p>演習とチュートリアル本編の食い違いを避ける方法については、<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>のトピックブランチの演習に追加したメモをご覧ください。</p>
<ol>
<li>
<a class="hyperref" href="#code-password_reset_expire_test">リスト<span class="ref">10.57</span></a>のテンプレートを埋めて、期限切れのパスワード再設定のブランチ (<a class="hyperref" href="#code-password_reset_update_action">リスト<span class="ref">10.52</span></a>) の統合テストを作成してください (10.57 のコードにある<code>response.body</code>は、そのページのHTML本文をすべて返すメソッドです)。期限切れのテスト方法はさまざまですが、<a class="hyperref" href="#code-password_reset_expire_test">リスト<span class="ref">10.57</span></a>でおすすめした手法 (大文字小文字は区別されません) を使えば、レスポンスの本文に「expired」という語があるかどうかをチェックできます。
</li>
<li>現在は、/usersのユーザーインデックスページを開くと<em>すべての</em>ユーザーが表示され、/users/:idのようにIDを指定すると個別のユーザーを表示できます。しかし考えてみれば、有効でないユーザーは表示する意味がありません。そこで、<a class="hyperref" href="#code-show_only_active_users_exercise">リスト<span class="ref">10.58</span></a><sup class="footnote" id="cha-10_footnote-ref-9"><a href="#cha-10_footnote-9">9</a></sup>のテンプレートに記入して、この動作を変更してください。なお、ここで使用するActive Recordの<code>where</code>メソッドについては、<a class="hyperref" href="user_microposts?version=4.2#sec-a_proto_feed"><span class="ref">11.3.3</span></a>でもう少し詳しく説明します。<em>応用問題</em>: /usersと/users/:id両方の統合テストを作成してください。
</li>
<li>
<a class="hyperref" href="#code-user_model_password_reset">リスト<span class="ref">10.42</span></a>では、<code>activate</code>メソッドと<code>create_reset_digest</code>メソッドの両方で<code>update_attribute</code>を呼び出しており、それぞれのアクセスによってデータベーストランザクションが個別に発生してしまう点が残念です。<a class="hyperref" href="#code-update_columns">リスト<span class="ref">10.59</span></a>のテンプレートに記入することで、個別の<code>update_attribute</code>呼び出しを単一の<code>update_columns</code>呼び出しに統合し、データベースアクセスが1回で済むようにしてください。変更後にテストを実行し、<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になることを確認してください。
</li>
</ol>
<div class="codelisting" id="code-password_reset_expire_test" data-tralics-id="uid1121" data-number="10.57">
<div class="heading">
<span class="number">リスト10.57:</span> 

<span class="description">パスワード再設定の期限切れのテスト<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/password_resets_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"expired token"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>

    <span class="vi">@user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span> <span class="p">}</span>
    <span class="n">assert_response</span> <span class="ss">:redirect</span>
    <span class="n">follow_redirect!</span>
<span class="hll">    <span class="n">assert_match</span> <span class="sr">/FILL_IN/i</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-show_only_active_users_exercise" data-tralics-id="uid1122" data-number="10.58">
<div class="heading">
<span class="number">リスト 10.58:</span> 

<span class="description">有効なユーザーだけを表示するコードのテンプレート  <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span> </span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">unless</span> <span class="no">FILL_IN</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-update_columns" data-tralics-id="uid1123" data-number="10.59">
<div class="heading">
<span class="number">リスト10.59:</span> 

<span class="description"><code>update_columns</code>を使用するテンプレート<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span><span class="p">,</span> <span class="ss">:reset_token</span>
  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># アカウントを有効にする</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="ss">activated_at</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 有効化用のメールを送信する</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># パスワード再設定の属性を設定する</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">reset_digest</span><span class="p">:</span>  <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                   <span class="ss">reset_sent_at</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># パスワード再設定用メールを送信する</span>
  <span class="k">def</span> <span class="nf">send_password_reset_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># メールアドレスをすべて小文字にする</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>

    <span class="c1"># 有効化トークンとダイジェストを作成およびアサインする</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div><div id="sec-expiration_proof" class="section" data-tralics-id="cid71" data-number="10.6">
<h2><a href="#sec-expiration_proof" class="heading hyperref"><span class="number">10.6 </span>証明: 期限切れの比較</a></h2>
<p>この説では、<a class="hyperref" href="#sec-resetting_the_password"><span class="ref">10.2.4</span></a>で用いたパスワード期限切れの期間の比較が正しいことを証明します。最初に、期間を2つ定義します。<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame"><nobr><span class="math" id="MathJax-Span-1" role="math" style="width: 1.894em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.671em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.838em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-4"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-5" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-6" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.114em; vertical-align: -0.244em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1"> \Delta t_r </script></span>をパスワード再設定メール送信時してからの期間、<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-2-Frame"><nobr><span class="math" id="MathJax-Span-7" role="math" style="width: 1.894em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.671em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.838em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-8"><span class="mi" id="MathJax-Span-9" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-10"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-11" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-12" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.114em; vertical-align: -0.244em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-2"> \Delta t_e </script></span>をパスワード再設定の有効な期間 (例: 2時間) と定めます。パスワードの再設定は、メールが送信された時刻から経過した期間が、有効期間よりも長くなった場合に「期限切れ」となります。これを次のように表します。</p>
<div id="eq-time_delta" class="equation" data-tralics-id="uid1124" data-number="10.1"><span class="MathJax_Preview" style="color: inherit;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-3-Frame"><nobr><span class="math" id="MathJax-Span-13" role="math" style="width: 5.397em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.841em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.838em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-14"><span class="mi" id="MathJax-Span-15" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-16"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-17" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-18" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 0.281em;">&gt;</span><span class="mi" id="MathJax-Span-20" style="font-family: MathJax_Main; padding-left: 0.281em;">Δ</span><span class="msubsup" id="MathJax-Span-21"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-22" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-23" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-24" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.114em; vertical-align: -0.244em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-3">\begin{equation}
\label{eq:time_delta}
\Delta t_r > \Delta t_e.
\end{equation}</script>
</div>
<p class="noindent">ここで、現在時刻 (訳注: 比較を行った時刻) を<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-4-Frame"><nobr><span class="math" id="MathJax-Span-25" role="math" style="width: 1.171em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.393em 1000em 2.505em -999.997em); top: -2.166em; left: 0.003em;"><span class="mrow" id="MathJax-Span-26"><span class="msubsup" id="MathJax-Span-27"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-28" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-29" style="font-size: 70.7%; font-family: MathJax_Math-italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.058em;"></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.172em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.991em; vertical-align: -0.244em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-4"> t_N </script></span>で表し、パスワード再設定メールの送信時刻を<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-5-Frame"><nobr><span class="math" id="MathJax-Span-30" role="math" style="width: 0.893em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.393em 1000em 2.505em -999.997em); top: -2.166em; left: 0.003em;"><span class="mrow" id="MathJax-Span-31"><span class="msubsup" id="MathJax-Span-32"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-33" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-34" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.172em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.991em; vertical-align: -0.244em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-5"> t_r </script></span>で表し、有効期間が切れる時刻を<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-6-Frame"><nobr><span class="math" id="MathJax-Span-35" role="math" style="width: 0.893em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.393em 1000em 2.505em -999.997em); top: -2.166em; left: 0.003em;"><span class="mrow" id="MathJax-Span-36"><span class="msubsup" id="MathJax-Span-37"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-38" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-39" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.172em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.991em; vertical-align: -0.244em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-6"> t_e </script></span> (例: 2時間前) と表すと、次の2つの関係式を得ることができます。</p>
<div id="eq-delta_p" class="equation" data-tralics-id="uid1125" data-number="10.2"><span class="MathJax_Preview" style="color: inherit;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-7-Frame"><nobr><span class="math" id="MathJax-Span-40" role="math" style="width: 6.676em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.009em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.838em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-41"><span class="mi" id="MathJax-Span-42" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-43"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-45" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-46" style="font-family: MathJax_Main; padding-left: 0.281em;">=</span><span class="msubsup" id="MathJax-Span-47" style="padding-left: 0.281em;"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-49" style="font-size: 70.7%; font-family: MathJax_Math-italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.058em;"></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-50" style="font-family: MathJax_Main; padding-left: 0.225em;">−</span><span class="msubsup" id="MathJax-Span-51" style="padding-left: 0.225em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-52" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-53" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.114em; vertical-align: -0.244em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-7">\begin{equation}
\label{eq:delta_p}
\Delta t_r = t_N - t_r
\end{equation}</script>
</div>
<p class="noindent">および</p>
<div id="eq-delta_e" class="equation" data-tralics-id="uid1126" data-number="10.3"><span class="MathJax_Preview" style="color: inherit;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-8-Frame"><nobr><span class="math" id="MathJax-Span-54" role="math" style="width: 7.01em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.287em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.838em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-55"><span class="mi" id="MathJax-Span-56" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-57"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-58" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-59" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-60" style="font-family: MathJax_Main; padding-left: 0.281em;">=</span><span class="msubsup" id="MathJax-Span-61" style="padding-left: 0.281em;"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-62" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-63" style="font-size: 70.7%; font-family: MathJax_Math-italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.058em;"></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-64" style="font-family: MathJax_Main; padding-left: 0.225em;">−</span><span class="msubsup" id="MathJax-Span-65" style="padding-left: 0.225em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-66" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-67" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-68" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.114em; vertical-align: -0.244em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-8">\begin{equation}
\label{eq:delta_e}
\Delta t_e = t_N - t_e.
\end{equation}</script>
</div>
<p class="noindent"><a class="hyperref" href="#eq-delta_p">式(<span class="ref">10.2</span>)</a>と<a class="hyperref" href="#eq-delta_e">式(<span class="ref">10.3</span>)</a>を<a class="hyperref" href="#eq-time_delta">(<span class="ref">10.1</span>)</a>に代入すると、次の結果が得られます。</p>
<div class="equation"><span class="MathJax_Preview" style="color: inherit;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-9-Frame"><nobr><span class="math" id="MathJax-Span-69" role="math" style="width: 10.291em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.234em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(-0.164em 1000em 4.007em -999.997em); top: -2.166em; left: 0.003em;"><span class="mrow" id="MathJax-Span-70"><span class="mtable" id="MathJax-Span-71" style="padding-right: 0.17em; padding-left: 0.17em;"><span style="display: inline-block; position: relative; width: 8.901em; height: 0px;"><span style="position: absolute; clip: rect(2.45em 1000em 6.454em -999.997em); top: -4.669em; left: 0.003em;"><span style="display: inline-block; position: relative; width: 3.061em; height: 0px;"><span style="position: absolute; clip: rect(3.117em 1000em 4.34em -999.997em); top: -5.336em; right: 0.003em;"><span class="mtd" id="MathJax-Span-72"><span class="mrow" id="MathJax-Span-73"><span class="mi" id="MathJax-Span-74" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-75"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-76" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-77" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.228em 1000em 4.34em -999.997em); top: -3.946em; right: 0.003em;"><span class="mtd" id="MathJax-Span-87"><span class="mrow" id="MathJax-Span-88"><span class="msubsup" id="MathJax-Span-89"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-90" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-91" style="font-size: 70.7%; font-family: MathJax_Math-italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.058em;"></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-92" style="font-family: MathJax_Main; padding-left: 0.225em;">−</span><span class="msubsup" id="MathJax-Span-93" style="padding-left: 0.225em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-94" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-95" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.228em 1000em 4.34em -999.997em); top: -2.555em; right: 0.003em;"><span class="mtd" id="MathJax-Span-108"><span class="mrow" id="MathJax-Span-109"><span class="mo" id="MathJax-Span-110" style="font-family: MathJax_Main;">−</span><span class="msubsup" id="MathJax-Span-111"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-112" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-113" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.674em;"></span></span><span style="position: absolute; clip: rect(2.338em 1000em 6.064em -999.997em); top: -4.391em; left: 4.062em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.284em 1000em 4.229em -999.997em); top: -5.336em; left: 50%; margin-left: -0.386em;"><span class="mtd" id="MathJax-Span-78"><span class="mrow" id="MathJax-Span-79"><span class="mo" id="MathJax-Span-80" style="font-family: MathJax_Main;">&gt;</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.284em 1000em 4.229em -999.997em); top: -3.946em; left: 50%; margin-left: -0.386em;"><span class="mtd" id="MathJax-Span-96"><span class="mrow" id="MathJax-Span-97"><span class="mo" id="MathJax-Span-98" style="font-family: MathJax_Main;">&gt;</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.284em 1000em 4.229em -999.997em); top: -2.555em; left: 50%; margin-left: -0.386em;"><span class="mtd" id="MathJax-Span-114"><span class="mrow" id="MathJax-Span-115"><span class="mo" id="MathJax-Span-116" style="font-family: MathJax_Main;">&gt;</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.396em;"></span></span><span style="position: absolute; clip: rect(2.505em 1000em 6.565em -999.997em); top: -4.724em; left: 5.842em;"><span style="display: inline-block; position: relative; width: 3.061em; height: 0px;"><span style="position: absolute; clip: rect(3.117em 1000em 4.34em -999.997em); top: -5.336em; left: 0.003em;"><span class="mtd" id="MathJax-Span-81"><span class="mrow" id="MathJax-Span-82"><span class="mi" id="MathJax-Span-83" style="font-family: MathJax_Main;">Δ</span><span class="msubsup" id="MathJax-Span-84"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-85" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-86" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.228em 1000em 4.34em -999.997em); top: -3.946em; left: 0.003em;"><span class="mtd" id="MathJax-Span-99"><span class="mrow" id="MathJax-Span-100"><span class="msubsup" id="MathJax-Span-101"><span style="display: inline-block; position: relative; width: 1.059em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-102" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-103" style="font-size: 70.7%; font-family: MathJax_Math-italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.058em;"></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-104" style="font-family: MathJax_Main; padding-left: 0.225em;">−</span><span class="msubsup" id="MathJax-Span-105" style="padding-left: 0.225em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-106" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-107" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(3.228em 1000em 4.34em -999.997em); top: -2.555em; left: 0.003em;"><span class="mtd" id="MathJax-Span-117"><span class="mrow" id="MathJax-Span-118"><span class="mo" id="MathJax-Span-119" style="font-family: MathJax_Main;">−</span><span class="msubsup" id="MathJax-Span-120"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-121" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-122" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-123" style="font-family: MathJax_Main;">,</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.73em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.172em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 4.324em; vertical-align: -1.91em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-9"> 
\begin{array}{rcl}
\Delta t_r & > & \Delta t_e \\
t_N - t_r & > & t_N - t_e \\
-t_r & > & -t_e,
\end{array}
 </script>
</div>
<p class="noindent">両辺に<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-10-Frame"><nobr><span class="math" id="MathJax-Span-124" role="math" style="width: 1.449em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.282em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.894em 1000em 2.895em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-125"><span class="mo" id="MathJax-Span-126" style="font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-127" style="font-family: MathJax_Main;">1</span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.867em; vertical-align: -0.059em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-10"> -1 </script></span>をかけると、次の式が得られます。</p>
<div id="eq-time_comparison" class="equation" data-tralics-id="uid1127" data-number="10.4"><span class="MathJax_Preview" style="color: inherit;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-11-Frame"><nobr><span class="math" id="MathJax-Span-128" role="math" style="width: 3.562em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.173em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.949em 1000em 3.061em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-129"><span class="msubsup" id="MathJax-Span-130"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-131" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-132" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-133" style="font-family: MathJax_Main; padding-left: 0.281em;">&lt;</span><span class="msubsup" id="MathJax-Span-134" style="padding-left: 0.281em;"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-135" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-136" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-137" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.991em; vertical-align: -0.244em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-11">\begin{equation}
\label{eq:time_comparison}
t_r < t_e.
\end{equation}</script>
</div>
<p class="noindent"><a class="hyperref" href="#eq-time_comparison">(<span class="ref">10.4</span>)</a>をRailsコードに置き換え、値を<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-12-Frame"><nobr><span class="math" id="MathJax-Span-138" role="math" style="width: 6.176em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.564em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.782em 1000em 3.117em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-139"><span class="msubsup" id="MathJax-Span-140"><span style="display: inline-block; position: relative; width: 0.781em; height: 0px;"><span style="position: absolute; clip: rect(3.228em 1000em 4.174em -999.997em); top: -4.001em; left: 0.003em;"><span class="mi" id="MathJax-Span-141" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -3.834em; left: 0.336em;"><span class="mi" id="MathJax-Span-142" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-143" style="font-family: MathJax_Main; padding-left: 0.281em;">=</span><span class="texatom" id="MathJax-Span-144" style="padding-left: 0.281em;"><span class="mrow" id="MathJax-Span-145"><span class="mn" id="MathJax-Span-146" style="font-family: MathJax_Main;">2</span><span class="mtext" id="MathJax-Span-147" style="font-family: MathJax_Main;">&nbsp;</span><span class="texatom" id="MathJax-Span-148"><span class="mrow" id="MathJax-Span-149"><span class="mo" id="MathJax-Span-150"><span style="font-family: STIXGeneral, 'Arial Unicode MS', serif; font-size: 90%; font-style: normal; font-weight: normal;">時</span></span></span></span><span class="texatom" id="MathJax-Span-151"><span class="mrow" id="MathJax-Span-152"><span class="mo" id="MathJax-Span-153"><span style="font-family: STIXGeneral, 'Arial Unicode MS', serif; font-size: 90%; font-style: normal; font-weight: normal;">間</span></span></span></span><span class="texatom" id="MathJax-Span-154"><span class="mrow" id="MathJax-Span-155"><span class="mo" id="MathJax-Span-156"><span style="font-family: STIXGeneral, 'Arial Unicode MS', serif; font-size: 90%; font-style: normal; font-weight: normal;">前</span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.238em; vertical-align: -0.306em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-12"> t_e = \mathrm{2\ 時間前} </script></span>とすると、<a class="hyperref" href="#code-user_model_password_reset_expired">リスト<span class="ref">10.53</span></a>の<code>password_reset_expired?</code>メソッドと同じコードになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">password_reset_expired?</span>
  <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="#sec-resetting_the_password"><span class="ref">10.2.4</span></a>でも説明したとおり、「<code>&lt;</code>」を「〜より少ない」ではなく「〜より早い時刻」と解釈すれば、「パスワードの再設定は、現在より2時間以上前の時刻に行われた」という言明と一致します。</p>
</div><div id="cha-10_footnotes">
  <div class="navigation">
<a class="next_page" href="user_microposts?version=4.2#cha-user_microposts">«&nbsp;<span class="number">第11章</span>ユーザーのマイクロポスト</a><a class="prev_page" href="updating_and_deleting_users?version=4.2#cha-updating_showing_and_deleting_users"><span class="number">第9章</span> ユーザーの更新・表示・削除</a>
</div>
<ol class="footnotes">
    <li id="cha-10_footnote-1">細かいことを言えば、<a class="hyperref" href="updating_and_deleting_users?version=4.2#sec-updating_users"><span class="ref">9.1</span></a>のアカウント設定更新機能を使って、おかしなメールアドレスを設定することもできてしまいます。ここで行う実装では、メールによるメールアドレス検証のメリットを (やりすぎない範囲で) 十分享受できるはずです。<a class="arrow" href="#cha-10_footnote-ref-1">↑</a>
</li>
    <li id="cha-10_footnote-2">せっかくユーザーIDが既にアプリケーションのURLでそのまま使われているのですから、メールアドレスの代わりにユーザーIDを使うという手ももちろんあります。ただ、メールアドレスにしておけば、将来何らかの理由でユーザーIDをぼかしておきたくなる場合に役に立つかもしれません (競合他社があなたのアプリケーションのユーザー数を推測しにくいようにしたい、など)。<a class="arrow" href="#cha-10_footnote-ref-2">↑</a>
</li>
    <li id="cha-10_footnote-3">こういう場合は<code>update</code>アクションにするのではないかとお思いの方もいるでしょう。しかし、有効化リンクはメールでユーザーに送られることを思い出してください。このリンクをクリックすれば、ブラウザで普通にクリックしたのと同じことになり、ブラウザから発行されるのは (<code>update</code>アクションで使用する<span class="tt">PATCH</span>リクエストではなく) 必然的に<span class="tt">GET</span>リクエストになります。GETリクエストを受けるにはeditアクションにならざるを得ないわけです。<a class="arrow" href="#cha-10_footnote-ref-3">↑</a>
</li>
    <li id="cha-10_footnote-4">
<code>edit</code>アクションを使いたいのですから、コマンドラインで<code>edit</code>と指定すればよいように思えますが、そうすると使いもしないeditビューやテストまで生成されてしまうのです。<a class="arrow" href="#cha-10_footnote-ref-4">↑</a>
</li>
    <li id="cha-10_footnote-5">たとえば、攻撃者が仮にデータベースにアクセスできてしまうと、攻撃者が作成した新しいアカウントを即座に有効にすることができてしまいます。攻撃者はそのアカウントでゆうゆうとログインし、パスワードを変更してそのアカウントの権限を手に入れることでしょう。<a class="arrow" href="#cha-10_footnote-ref-5">↑</a>
</li>
    <li id="cha-10_footnote-6">URLのクエリパラメータではキー/値ペアを複数使用することもできます。その場合は、「<code>&amp;</code>」を使用して「<code>/edit?name=Foo%20Bar&amp;email=foo%40example.com</code>」のように区切ります。<a class="arrow" href="#cha-10_footnote-ref-6">↑</a>
</li>
    <li id="cha-10_footnote-7">これについてもう少し詳しくお知りになりたい場合は、<a href="http://lmgtfy.com/?q=ruby+rails+escape+url" target="_blank">「ruby rails escape url」で検索してみてください</a>。おそらく<a href="http://stackoverflow.com/questions/6714196/ruby-url-encoding-string" target="_blank">2通りの手法</a> (<code>URI::encode(str)</code>と<code>CGI::escape(str)</code>) が見つかると思います。両方試してみるとわかると思いますが、実際に動作するのは後者の方です (実はもうひとつ方法があります: <code>ERB::Util</code>ライブラリの<a href="http://apidock.com/ruby/ERB/Util/url_encode" target="_blank">url_encode</a>メソッドでも同じことができます)。<a class="arrow" href="#cha-10_footnote-ref-7">↑</a>
</li>
    <li id="cha-10_footnote-8">この場合、パスワードフィールドが空である場合だけを扱います。パスワードの確認フィールドが空の場合は、確認フィールドのバリデーションで検出され、エラーメッセージが表示されるので不要です。ただし、パスワードフィールドとパスワード確認フィールドが両方空だとバリデーションがスキップされてしまいます。<a class="arrow" href="#cha-10_footnote-ref-8">↑</a>
</li>
    <li id="cha-10_footnote-9">
<a class="hyperref" href="#code-show_only_active_users_exercise">リスト<span class="ref">10.58</span></a>では、<code>&amp;&amp;</code>ではなく<code>and</code>を使用していることにご注意ください。&amp;&amp;とandの動作は「ほぼ」同等ですが、&amp;&amp;演算子の方がandよりも<a href="http://ja.wikipedia.org/wiki/%E6%BC%94%E7%AE%97%E5%AD%90%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D" target="_blank"><em>優先順位</em></a>が高いので、&amp;&amp;だと<code>root_url</code>との論理的な結び付きが強くなりすぎてしまい、不適切です。<code>root_url</code>をかっこで囲んでこの問題を回避することもできますが、<code>and</code>を使用する方が常道です。<a class="arrow" href="#cha-10_footnote-ref-9">↑</a>
</li>
  </ol>
</div>
          </div>
  </body>
</html
