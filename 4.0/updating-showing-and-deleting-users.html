<html dir="ltr">
  <head>
    <title>Ruby on Rails チュートリアル</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">

<div id="book">
            




            
            
            <div id="cha-updating_showing_and_deleting_users" class="chapter" data-tralics-id="cid58" data-number="9" data-chapter="updating_and_deleting_users">
<h1><a href="#cha-updating_showing_and_deleting_users" class="heading hyperref"><span class="number">第9章</span> ユーザーの更新・表示・削除</a></h1>
<p>この章では、Usersリソース用のRESTアクション (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>) のうち、これまで未実装だった<code>edit</code>、<code>update</code>、<code>index</code>、<code>destroy</code>アクションを追加し、RESTアクションを完成させます。まずはユーザーが自分のプロファイルを自分で更新できるようにします。ここで早速<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>で実装した認証用のコードを使いますが、これは認可モデルについて説明する自然なキッカケになります。次に、すべてのユーザーを一覧できるようにします (もちろん認証を要求します)。これはサンプルデータとページネーション (pagnation) を導入する動機にもなります。最後に、ユーザーを削除し、データベースから完全に消去する機能を追加します。ユーザーの削除はどのユーザーにも許可できるものではないので、管理ユーザーという特権クラスを作成し、このユーザーにのみ削除を許可するようにします。</p>
</div><div id="sec-updating_users" class="section" data-tralics-id="cid59" data-number="9.1">
<h2><a href="#sec-updating_users" class="heading hyperref"><span class="number">9.1</span> ユーザーを更新する</a></h2>
<p>ユーザー情報を編集するパターンは、(<a class="hyperref" href="sign_up?version=4.2#cha-sign_up"><span class="ref">第7章</span></a>)の新規ユーザーの作成と極めて似通っています。新規ユーザー用のビューを出力する<code>new</code>アクションの代わりに、ユーザーを編集するための<code>edit</code>アクションを作成すればよいのです。 <span class="tt">POST</span>リクエストに応答する<code>create</code>の代わりに、<span class="tt">PATCH</span>リクエストに応答する<code>update</code>アクションを作成すればよいのです (<a class="hyperref" href="static_pages?version=4.2#aside-get_etc">コラム<span class="ref">3.3</span></a>)。最大の違いは、ユーザー登録は誰でも実行できますが、ユーザー情報を更新できるのはそのユーザー自身に限られるということです。<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>の認証 (authentication) システムを使えば、<em>before_action</em>を使用してこれを行えます。</p>
<p>では最初に、いつものように<code>updating-users</code>トピックブランチを作成しましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b updating-users
</pre></div></div>
<div id="sec-edit_form" class="subsection" data-tralics-id="uid881" data-number="9.1.1">
<h3><a href="#sec-edit_form" class="heading hyperref"><span class="number">9.1.1</span> 編集フォーム</a></h3>
<p>まずは編集フォームから始めます。モックアップは<a class="hyperref" href="#fig-edit_user_mockup">図<span class="ref">9.1</span></a>のとおりです<sup class="footnote" id="cha-9_footnote-ref-1"><a href="#cha-9_footnote-1">1</a></sup>。
<a class="hyperref" href="#fig-edit_user_mockup">図<span class="ref">9.1</span></a>のモックアップを動くページにするためには、Usersコントローラに<code>edit</code>アクションを追加して、それに対応するeditビューを実装する必要があります。<code>edit</code>アクションの実装から始めますが、ここではデータベースから適切なユーザーデータを読み込む必要があります。ここで注意して頂きたいのは、<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>ではユーザー編集ページの正しいURLが/users/1/editとなっていることです (ユーザーのidが<span class="tt">1</span>の場合)。ユーザーのidは<code>params[:id]</code>変数で取り出すことができるのを思い出してください。つまり、<a class="hyperref" href="#code-initial_edit_action">リスト<span class="ref">9.1</span></a>のコードを使えばそのユーザーを指定できるということです。</p>
<div class="center figure" id="fig-edit_user_mockup" data-tralics-id="uid883" data-number="9.1">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/edit_user_mockup_bootstrap.png" alt="images/figures/edit_user_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図9.1: </span><span class="description">ユーザー編集ページのモックアップ
</span>
</div>
</div>
<div class="codelisting" id="code-initial_edit_action" data-tralics-id="uid884" data-number="9.1">
<div class="heading">
<span class="number">リスト9.1:</span> 

<span class="description">ユーザーの<code>edit</code>アクション <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>ユーザー編集ページに対応するビュー を、<a class="hyperref" href="#code-user_edit_view">リスト<span class="ref">9.2</span></a>に示します (このファイルは手動で作成する必要があります)。このコードが<a class="hyperref" href="sign_up?version=4.2#code-signup_form">リスト<span class="ref">7.13</span></a>と極めて似通っていることに注目してください。重複が多いということは、それらのコードの繰り返しをパーシャルにまとめることができるということです。パーシャルにまとめる作業は演習の課題 (<a class="hyperref" href="#sec-updating_deleting_exercises"><span class="ref">9.6</span></a>) に回します。</p>
<div class="codelisting" id="code-user_edit_view" data-tralics-id="uid885" data-number="9.2">
<div class="heading">
<span class="number">リスト9.2:</span> 

<span class="description">ユーザーのeditビュー<span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gravatar_edit"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
<p class="noindent">上のコードでは、<a class="hyperref" href="sign_up?version=4.2#sec-signup_error_messages"><span class="ref">7.3.3</span></a>で導入した<code>error_messages</code>パーシャルを再利用しています。ところで、Gravatarへのリンクで<code>target="_blank"</code>が使われていますが、これを使うとリンク先を新しいタブ (またはウィンドウ) で開くようになるので、別のWebサイトへリンクするときなどに便利です。</p>
<p><a class="hyperref" href="#code-initial_edit_action">リスト<span class="ref">9.1</span></a>の<code>@user</code>インスタンス変数使うと、編集ページがうまく描画されるようになります (<a class="hyperref" href="#fig-edit_page">図<span class="ref">9.2</span></a>)。<a class="hyperref" href="#fig-edit_page">図<span class="ref">9.2</span></a>の"Name"や"Email"の部分を見ると、Railsによって名前やメールアドレスのフィールドに値が自動的に入力されていることがわかります。これらの値は、<code>@user</code>変数の属性情報から引き出されています。</p>
<div class="center figure" id="fig-edit_page" data-tralics-id="uid886" data-number="9.2">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/edit_page_3rd_edition.png" alt="images/figures/edit_page_3rd_edition"></div>
<div class="caption">
<span class="header">図9.2</span> <span class="description">名前とメールアドレスが入力済みの、初期状態のユーザー編集ページ
</span>
</div>
</div>
<p><a class="hyperref" href="#fig-edit_page">図<span class="ref">9.2</span></a>のHTMLソースを見てみると、少しだけ違う箇所もありますが、おおよそformタグは期待どおりに表示されています (<a class="hyperref" href="#code-edit_form_html">リスト<span class="ref">9.3</span></a>)。。</p>
<div class="codelisting" id="code-edit_form_html" data-tralics-id="uid887" data-number="9.3">
<div class="heading">
<span class="number">リスト9.3:</span> 

<span class="description"><a class="hyperref" href="#code-user_edit_view">リスト<span class="ref">9.2</span></a>で定義されたeditフォーム (<a class="hyperref" href="#fig-edit_page">図<span class="ref">9.2</span></a>) のHTML</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">class=</span><span class="s">"edit_user"</span>
      <span class="na">id=</span><span class="s">"edit_user_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
</div>
<p class="noindent">以下の入力フィールドに隠し属性があることに注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p class="noindent">Webブラウザはネイティブでは<span class="tt">PATCH</span>リクエスト (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>でRESTの慣習として要求されている) を送信できないので、Railsは<span class="tt">POST</span>リクエストと隠し<code>input</code>フィールドを利用してPATCHリクエストを「偽造」しています<sup class="footnote" id="cha-9_footnote-ref-2"><a href="#cha-9_footnote-2">2</a></sup>。</p>
<p>ここでもう1つ微妙な点を指摘しておきたいと思います。<a class="hyperref" href="#code-user_edit_view">リスト<span class="ref">9.2</span></a>の<code>form_for(@user)</code>のコードは、<a class="hyperref" href="sign_up?version=4.2#code-signup_form">リスト<span class="ref">7.13</span></a>のコードと<em>完全に</em>同じです。だとすると、Railsはどうやって新規ユーザー用の<span class="tt">POST</span>リクエストとユーザー編集用の<span class="tt">PATCH</span>リクエストを区別するのでしょうか。その答えは、Railsは、ユーザーが新規なのか、それともデータベースに存在する既存のユーザーであるかを、Active Recordの<code>new_record?</code>論理値メソッドを使用して区別できるからです。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p class="noindent">Railsは、<code>form_for(@user)</code>を使用してフォームを構成すると、<code>@user.new_record?</code>が<code>true</code>のときには<span class="tt">POST</span>を、<code>false</code>のときには<span class="tt">PATCH</span>を使用します。</p>
<p>仕上げに、ナビゲーションバーにあるユーザー設定へのリンクを更新します。<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>で示した<code>edit_user_path</code>という名前付きルートと、 <a class="hyperref" href="log_in_log_out?version=4.2#code-persistent_current_user">リスト<span class="ref">8.36</span></a>で定義した<code>current_user</code>というヘルパーメソッドを使うと、実装が簡単です。</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p class="noindent">完全なアプリケーションコードを<a class="hyperref" href="#code-settings_link">リスト<span class="ref">9.4</span></a>に示します。</p>
<div class="codelisting" id="code-settings_link" data-tralics-id="uid889" data-number="9.4">
<div class="heading">
<span class="number">リスト9.4:</span> 

<span class="description">レイアウトの “Settings” リンクを更新する<span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div>
</div>
</div>
<div id="sec-unsuccessful_edits" class="subsection" data-tralics-id="uid890" data-number="9.1.2">
<h3><a href="#sec-unsuccessful_edits" class="heading hyperref"><span class="number">9.1.2</span> 編集の失敗</a></h3>
<p>本項では、<a class="hyperref" href="sign_up?version=4.2#sec-unsuccessful_signups"><span class="ref">7.3</span></a>のユーザー登録に失敗したときと似た方法で、編集に失敗した場合について扱っていきます。まずは<code>update</code>アクションの作成から進めますが、これは<a class="hyperref" href="modeling_users?version=4.2#sec-updating_user_objects">リスト<span class="ref">9.5</span></a>にあるように、<code>update_attributes</code> (<a class="hyperref" href="#code-user_update_action_unsuccessful"><span class="ref">6.1.5</span></a>) を使って送信された<code>params</code>ハッシュに基いてユーザーを更新します。無効な情報が送信された場合、更新の結果として<code>false</code>が返され、<code>else</code>に分岐して編集ページをレンダリングします。このパターンは以前にも出現したことを覚えているでしょうか。この構造は<code>create</code>アクションの最初のバージョン (<a class="hyperref" href="sign_up?version=4.2#code-first_create_action">リスト<span class="ref">7.16</span></a>) と極めて似通っています。</p>
<div class="codelisting" id="code-user_update_action_unsuccessful" data-tralics-id="uid891" data-number="9.5">
<div class="heading">
<span class="number">リスト9.5:</span> 

<span class="description">ユーザーの<code>update</code>アクションの初期実装 <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
<span class="hll">    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span>      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">render</span> <span class="s1">'new'</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span>      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">render</span> <span class="s1">'edit'</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>update_attributes</code>への呼び出しで<code>user_params</code>を使用していることに注目してください。<a class="hyperref" href="sign_up?version=4.2#sec-strong_parameters"><span class="ref">7.3.2</span></a>でも説明したように、ここではStrong Parametersを使用してマスアサインメントの脆弱性を防止しています。</p>
<p>Userモデルのバリデーションとエラーメッセージのパーシャルが既にあるので (<a class="hyperref" href="#code-user_edit_view">リスト<span class="ref">9.2</span></a>)、無効な情報を送信すると役立つエラーメッセージが表示されるようになっています (<a class="hyperref" href="#fig-buggy_edit_with_invalid_information">図<span class="ref">9.3</span></a>)。</p>
<div class="center figure" id="fig-buggy_edit_with_invalid_information" data-tralics-id="uid892" data-number="9.3">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/edit_with_invalid_information_3rd_edition.png" alt="images/figures/edit_with_invalid_information_3rd_edition"></div>
<div class="caption">
<span class="header">図9.3</span> <span class="description">更新フォームの送信で発生したエラーメッセージ
</span>
</div>
</div>
</div>
<div id="sec-testing_unsuccessful_edits" class="subsection" data-tralics-id="uid893" data-number="9.1.3">
<h3><a href="#sec-testing_unsuccessful_edits" class="heading hyperref"><span class="number">9.1.3 </span>編集失敗時のテスト</a></h3>
<p><a class="hyperref" href="#sec-unsuccessful_edits"><span class="ref">9.1.2</span></a>では編集フォームの失敗時を実装しました。次に、<a class="hyperref" href="static_pages?version=4.2#aside-when_to_test">コラム<span class="ref">3.3</span></a>で説明したテストのガイドラインに従って、エラーを検知するための統合テストを書いていきましょう。まずはいつものように、統合テストを生成するところから始めます。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_edit
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_edit_test.rb</span>
</pre></div></div>
<p class="noindent">最初は編集失敗時の簡単なテストを追加します (<a class="hyperref" href="#code-unsuccessful_edit_test">リスト<span class="ref">9.6</span></a>)。<a class="hyperref" href="#code-unsuccessful_edit_test">リスト<span class="ref">9.6</span></a>のテストでは、まず編集ページにアクセスし、editビューが描画されるかどうかをチェックしています。その後、無効な情報を送信してみて、editビューが再描画されるかどうかをチェックします。ここで、<span class="tt">PATCH</span>リクエストを送るために<code>patch</code>メソッドを使っていることに注目してください。これは<code>get</code>や<code>post</code>、<code>delete</code>メソッドと同じように、HTTPリクエストを送信するためのメソッドです。</p>
<div class="codelisting" id="code-unsuccessful_edit_test" data-tralics-id="uid894" data-number="9.6">
<div class="heading">
<span class="number">リスト9.6:</span> 

<span class="description">編集の失敗に対するテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"unsuccessful edit"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                                    <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
                                    <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                                    <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>この時点では、テストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>しているはずです。</p>
<div class="codelisting" id="uid895" data-tralics-id="uid895" data-number="9.7">
<div class="heading">
<span class="number">リスト9.7:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-successful_edits" class="subsection" data-tralics-id="uid896" data-number="9.1.4">
<h3><a href="#sec-successful_edits" class="heading hyperref"><span class="number">9.1.4 </span>TDDで編集を成功させる</a></h3>
<p>今度は編集フォームが動作するようにしましょう。プロファイル画像の編集は、画像のアップロードをGravatarに任せてあるので、既に動作するようになっています。<a class="hyperref" href="#fig-edit_page">図<span class="ref">9.2</span></a>の [change] リンクをクリックすれば、<a class="hyperref" href="#fig-gravatar_cropper">図<span class="ref">9.4</span></a>のようにGravatarを編集できます。ではそれ以外の機能の実装にとりかかりましょう。</p>
<div class="center figure" id="fig-gravatar_cropper" data-tralics-id="uid897" data-number="9.4">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/gravatar_cropper.png" alt="images/figures/gravatar_cropper"></div>
<div class="caption">
<span class="header">図9.4</span> <span class="description"><a href="http://gravatar.com/" target="_blank">Gravatar</a>の画像調整インターフェイス (写真は<a href="http://www.michaelhartl.com/" target="_blank">誰かさん</a>)
</span>
</div>
</div>
<p>そろそろ、より快適にテストをするためには、アプリケーション用のコードを「実装する前に」統合テストを書いた方が便利だと気付いた読者もいるかもしれません。実際、そういったテストのことは「<em>受け入れテスト (Acceptance Tests)</em>」として呼ばれていて、ある機能の実装が完了し、受け入れ可能な状態になったかどうかを決めるテストとして知られています。実際に体験してもらうために、今回はテスト駆動開発を使ってユーザーの編集機能を実装してみましょう。</p>
<p>まずは、<a class="hyperref" href="#code-unsuccessful_edit_test">リスト<span class="ref">9.6</span></a>のテストを参考にして、ユーザー情報を更新する正しい振る舞いをテストで定義します (今回は有効な情報を送信するように修正します)。次に、flashメッセージが空でないかどうかと、プロフィールページにリダイレクトされるかどうかをチェックします。また、データベース内のユーザー情報が正しく変更されたかどうかも検証します。変更の結果を<a class="hyperref" href="#code-successful_edit_test">リスト<span class="ref">9.8</span></a>に示します。このとき、<a class="hyperref" href="#code-successful_edit_test">リスト<span class="ref">9.8</span></a>のパスワードとパスワード確認が空であることに注目してください。ユーザー名やメールアドレスを編集するときに毎回パスワードを入力するのは不便なので、(パスワードを変更する必要が無いときは) パスワードを入力せずに更新できると便利です。また、<a class="hyperref" href="modeling_users?version=4.2#sec-updating_user_objects"><span class="ref">6.1.5</span></a>で紹介した<code>@user.reload</code>を使って、データベースから最新のユーザー情報を読み込み直して、正しく更新されたかどうかを確認している点にも注目してください。(こういった正しい振る舞いというのは一般に忘れがちですが、受け入れテスト (もしくは一般的なテスト駆動開発) では先にテストを書くので、効果的なユーザー体験について考えるようになります。)</p>
<div class="codelisting" id="code-successful_edit_test" data-tralics-id="uid898" data-number="9.8">
<div class="heading">
<span class="number">リスト9.8:</span> 

<span class="description">編集の成功に対するテスト<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"successful edit"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="s2">"Foo Bar"</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
                                    <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                                    <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                                    <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">assert_equal</span> <span class="nb">name</span><span class="p">,</span>  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_equal</span> <span class="n">email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>テストにパスする必要のある、<a class="hyperref" href="#code-successful_edit_test">リスト<span class="ref">9.8</span></a>の<code>update</code>アクションは、<a class="hyperref" href="#code-user_update_action">リスト<span class="ref">9.9</span></a>に示したように、<code>create</code>アクション (<a class="hyperref" href="log_in_log_out?version=4.2#code-login_upon_signup">リスト<span class="ref">8.22</span></a>) の最終的なフォームとほぼ同じです。</p>
<div class="codelisting" id="code-user_update_action" data-tralics-id="uid899" data-number="9.9">
<div class="heading">
<span class="number">リスト9.9:</span> 

<span class="description">ユーザーの<code>update</code>アクション <span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="vi">@user</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-user_update_action">リスト<span class="ref">9.9</span></a>のキャプションにも書いておきましたが、このテストはまだ<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>のままのはずです。というのも、パスワードの長さに対するバリデーション (<a class="hyperref" href="modeling_users?version=4.2#code-password_implementation">リスト<span class="ref">6.39</span></a>) があるので、パスワードやパスワード確認の欄を空にしておくとこれに引っかかってしまうからです (<a class="hyperref" href="#code-successful_edit_test">リスト<span class="ref">9.8</span></a>)。テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるためには、パスワードのバリデーションに対して、空だったときの例外処理を加える必要があります。こういったときに便利な<code>allow_nil: true</code>というオプションがあるので、これを <code>validates</code>に追加します (<a class="hyperref" href="#code-allow_blank_password">リスト<span class="ref">9.10</span></a>)。</p>
<div class="codelisting" id="code-allow_blank_password" data-tralics-id="uid900" data-number="9.10">
<div class="heading">
<span class="number">リスト9.10:</span> 

<span class="description">パスワードが空のままでも更新できるようにする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">}</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">},</span> <span class="ss">allow_nil</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-allow_blank_password">リスト<span class="ref">9.10</span></a>によって、新規ユーザー登録時に空のパスワードが有効になってしまうのかと心配になるかもしれませんが、安心してください。<a class="hyperref" href="modeling_users?version=4.2#sec-minimum_password_standards"><span class="ref">6.3.3</span></a>で説明したように、<code>has_secure_password</code>では (追加したバリデーションとは別に) オブジェクト生成時に存在性を検証するようになっているため、空のパスワードが新規ユーザー登録時に有効になることはありません。(それだけでなく、実は空のパスワードを入力すると存在性のバリデーションとhas_secure_passwordのバリデーションがそれぞれ実行され、2つの同じエラーメッセージが表示されるというバグがあったのですが、この問題も解決できてしまいます。)</p>
<p>このコードを追加したことにより、ユーザー編集ページが動くようになります (<a class="hyperref" href="#fig-edit_form_working">図<span class="ref">9.5</span></a>)。すべてのテストを走らせてみて、<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>したかどうか確かめてみてください。</p>
<div class="codelisting" id="uid901" data-tralics-id="uid901" data-number="9.11">
<div class="heading">
<span class="number">リスト 9.11:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<div class="center figure" id="fig-edit_form_working" data-tralics-id="uid902" data-number="9.5">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/edit_form_working.png" alt="images/figures/edit_form_working"></div>
<div class="caption">
<span class="header">図9.5: </span><span class="description">編集に成功した結果
</span>
</div>
</div>
</div>
</div><div id="sec-authorization" class="section" data-tralics-id="cid60" data-number="9.2">
<h2><a href="#sec-authorization" class="heading hyperref"><span class="number">9.2</span> 認可</a></h2>
<p>ウェブアプリケーションの文脈では、<em>認証</em> (authentication) はサイトのユーザーを識別することであり、<em>認可</em> (authorization) はそのユーザーが実行可能な操作を管理することです。<a class="hyperref" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="ref">第8章</span></a>で認証システムを構築したことで、認可のためのシステムを実装する準備もできました。</p>
<p><a class="hyperref" href="#sec-updating_users"><span class="ref">9.1</span></a>のeditアクションとupdateアクションはすでに完全に動作していますが、セキュリティ上の大穴が1つ空いています。 どのユーザーでもあらゆるアクションにアクセスでき、ログインさえしていれば他のユーザーの情報を編集できてしまいます。この節では、ユーザーにログインを要求し、かつ自分以外のユーザー情報を変更できないようにするセキュリティモデルを構築しましょう。</p>
<p><a class="hyperref" href="#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>では、ログインしていないユーザーが保護されたページにアクセスしようとした際のケースについて対処していきます。こういったケースはアプリケーションを使っていると普通に起こることなので、ログインページに転送して、そのときに分かりやすいメッセージも表示するようにしましょう。モックアップを<a class="hyperref" href="#fig-login_page_protected_mockup">図<span class="ref">9.6</span></a>に示します。一方で、許可されていないページに対してアクセスするログイン済みのユーザーがいたら (たとえば他人のユーザー編集ページにアクセスしようとしたら)、ルートURLにリダイレクトさせるようにします (<a class="hyperref" href="#sec-requiring_the_right_user"><span class="ref">9.2.2</span></a>)。</p>
<div class="center figure" id="fig-login_page_protected_mockup" data-tralics-id="uid903" data-number="9.6">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/login_page_protected_mockup.png" alt="images/figures/login_page_protected_mockup"></div>
<div class="caption">
<span class="header">図9.6: </span> <span class="description">保護されたページにアクセスしたときのページのモックアップ</span>
</div>
</div>
<div id="sec-requiring_logged_in_users" class="subsection" data-tralics-id="uid904" data-number="9.2.1">
<h3><a href="#sec-requiring_logged_in_users" class="heading hyperref"><span class="number">9.2.1</span> ユーザーにログインを要求する</a></h3>
<p><a class="hyperref" href="#fig-login_page_protected_mockup">図<span class="ref">9.6</span></a>のように転送させる仕組みを実装したいときは、Usersコントローラの中で<em>beforeフィルター</em>を使います。beforeフィルターは、<code>before_action</code>メソッドを使って何らかの処理が実行される直前に特定のメソッドを実行する仕組みです<sup class="footnote" id="cha-9_footnote-ref-3"><a href="#cha-9_footnote-3">3</a></sup>。今回はユーザーにログインを要求するために、<a class="hyperref" href="#code-authorize_before_filter">リスト<span class="ref">9.12</span></a>のように<code>logged_in_user</code>メソッドを定義して<code>before_action :logged_in_user</code>という形式で使います</p>
<div class="codelisting" id="code-authorize_before_filter" data-tralics-id="uid906" data-number="9.12">
<div class="heading">
<span class="number">リスト9.12:</span> 

<span class="description">beforeフィルターに<code>logged_in_user</code>を追加する RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
<span class="hll">      <span class="k">unless</span> <span class="n">logged_in?</span>
</span><span class="hll">        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">login_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">デフォルトでは、beforeフィルターはコントローラ内の<em>すべての</em>アクションに適用されるので、ここでは適切な<code>:only</code>オプションハッシュを渡すことによって<code>:edit</code>と<code>:update</code>アクションにのみこのフィルタが適用されるように制限をかけています。</p>
<p>beforeフィルターを使って実装した結果 (<a class="hyperref" href="#code-authorize_before_filter">リスト<span class="ref">9.12</span></a>) は、一度ログアウトしてユーザー編集ページ (<a href="http://localhost:3000/users/1/edit" target="_blank">/users/1/edit</a>) にアクセスしてみることで確認できます (<a class="hyperref" href="#fig-protected_log_in">図<span class="ref">9.7</span></a>)。</p>
<div class="center figure" id="fig-protected_log_in" data-tralics-id="uid907" data-number="9.7">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/protected_log_in_3rd_edition.png" alt="images/figures/protected_log_in_3rd_edition"></div>
<div class="caption">
<span class="header">図9.7</span> <span class="description">保護されたページにアクセスした直後のログインフォーム
</span>
</div>
</div>
<p><a class="hyperref" href="#code-authorize_before_filter">リスト<span class="ref">9.12</span></a>のキャプションに記したように、今の段階ではテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>失敗</strong></span><span class="sc"></span></span>します。</p>
<div class="codelisting" id="uid908" data-tralics-id="uid908" data-number="9.13">
<div class="heading">
<span class="number">リスト9.13:</span> <span class="description"><span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">原因は、editアクションやupdateアクションでログインを要求するようになったため、ログインしていないユーザーだとこれらのテストが失敗するようになったためです。</p>
<p>このため、editアクションやupdateアクションをテストする前にログインしておく必要があります。解決策は簡単で、 <a class="hyperref" href="log_in_log_out?version=4.2#sec-remember_tests"><span class="ref">8.4.6</span></a>で開発した<code>log_in_as</code>ヘルパー  (<a class="hyperref" href="log_in_log_out?version=4.2#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>) を使うことです。修正した結果を<a class="hyperref" href="#code-edit_tests_logged_in">リスト<span class="ref">9.14</span></a>に示します。</p>
<div class="codelisting" id="code-edit_tests_logged_in" data-tralics-id="uid909" data-number="9.14">
<div class="heading">
<span class="number">リスト9.14:</span> 

<span class="description">テストユーザーでログインする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"unsuccessful edit"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"successful edit"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">(<a class="hyperref" href="#code-edit_tests_logged_in">リスト<span class="ref">9.14</span></a>の<code>setup</code>メソッド内でログイン処理をまとめてしまうことも可能です。しかし、<a class="hyperref" href="#sec-friendly_forwarding"><span class="ref">9.2.3</span></a>で片方のテストをログインする<em>前に</em>編集ページにアクセスするように変更したいので、ここでまとめてしまっても結局は元に戻すことになってしまいます。)</p>
<p>今度はテストスイートがパスするはずです。</p>
<div class="codelisting" id="uid910" data-tralics-id="uid910" data-number="9.15">
<div class="heading">
<span class="number">リスト9.15:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">これでテストスイートがパスするようになりましたが、実はbeforeフィルターの実装はまだ終わっておりません。セキュリティモデルに関する実装を取り外してもテストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になってしまうかどうか、実際にコメントアウトして確かめてみましょう (<a class="hyperref" href="#code-commented_out_before_filter">リスト<span class="ref">9.16</span></a>)。なんと<a href="http://catb.org/jargon/html/B/Bad-Thing.html" target="_blank">悪いこと</a>に、すべてのテストが成功してしまいました。<a class="hyperref" href="#code-commented_out_before_filter">リスト<span class="ref">9.16</span></a>のコードは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>にならなければいけないのですから、これは巨大なセキュリティーホールといえるでしょう。テストを書いて、この問題に対処しましょう。</p>
<div class="codelisting" id="code-commented_out_before_filter" data-tralics-id="uid911" data-number="9.16">
<div class="heading">
<span class="number">リスト9.16:</span> 

<span class="description">セキュリティモデルを確認するためにbeforeフィルターをコメントアウトする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># before_action :logged_in_user, only: [:edit, :update]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>beforeフィルターは基本的にアクションごとに適用していくので、Usersコントローラのテストもアクションごとに書いていきます。具体的には、正しい種類のHTTPリクエストを使って<code>edit</code>アクションと<code>update</code>アクションをそれぞれ実行させてみて、flashにメッセージが代入されたかどうか、ログイン画面にリダイレクトされたかどうかを確認してみましょう。<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>から、適切なリクエストはそれぞれ<span class="tt">GET</span>と<span class="tt">PATCH</span>であることがわかります。したがって、テスト内では<code>get</code>メソッドと<code>patch</code>メソッドを使います。修正した結果を<a class="hyperref" href="#code-edit_update_redirect_tests">リスト<span class="ref">9.17</span></a>に示します。</p>
<div class="codelisting" id="code-edit_update_redirect_tests" data-tralics-id="uid912" data-number="9.17">
<div class="heading">
<span class="number">リスト9.17:</span> 

<span class="description"><code>edit</code>と<code>update</code>アクションの保護に対するテストする RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get new"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:new</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect edit when not logged in"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect update when not logged in"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">ここで、<code>get</code>も<code>patch</code>も次のように</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
</pre></div></div>
<p class="noindent">といった形で引数が渡されていることに注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
</pre></div></div>
<p class="noindent">上のコードでは、Railsの慣習によって<code>id: @user</code>という引数が自動的に<code>@user.id</code>に変換されています (これはコントローラでリダイレクトしたときと同様です)。2つ目のケースでは、ルーティングで正しく処理されるように<code>user</code>というハッシュも渡しています。(実は<a class="hyperref" href="toy_app?version=4.2#cha-a_toy_app"><span class="ref">第2章</span></a>のToyアプリケーションのUsersコントローラではテストも生成されていて、中を見ると上と同じコードになっています。)</p>
<p>この時点では、(beforeフィルターが無効のままなので) テストスイートは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になるはずです。beforeフィルターのコメントアウトを元に戻して、<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span>になるかどうか確かめてみましょう (<a class="hyperref" href="#code-uncommented_before_filter">リスト<span class="ref">9.18</span></a>)。</p>
<div class="codelisting" id="code-uncommented_before_filter" data-tralics-id="uid913" data-number="9.18">
<div class="heading">
<span class="number">リスト9.18:</span> 

<span class="description">beforeフィルターを再び有効化する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">コメントアウトしていた箇所を元に戻すと、テストが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するようになるはずです。</p>
<div class="codelisting" id="uid914" data-tralics-id="uid914" data-number="9.19">
<div class="heading">
<span class="number">リスト9.19:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">これらのテストを実装したことによって、うっかり誰でも編集できてしまうバグがあっても、すぐに検知できるようになりました。</p>
</div>
<div id="sec-requiring_the_right_user" class="subsection" data-tralics-id="uid915" data-number="9.2.2">
<h3><a href="#sec-requiring_the_right_user" class="heading hyperref"><span class="number">9.2.2</span> 正しいユーザーを要求する</a></h3>
<p>当然のことですが、ログインを要求するだけでは十分ではありません。ユーザーが<em>自分の情報だけを</em>編集できるようにする必要があります。<a class="hyperref" href="#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>では、深刻なセキュリティ上の欠陥を見逃してしまうテストを見てきました。そこで本項では、セキュリティモデルが正しく実装されている確信を持つために、テスト駆動開発で進めていきます。したがって、Usersコントローラのテスト (<a class="hyperref" href="#code-edit_update_redirect_tests">リスト<span class="ref">9.17</span></a>) を補完するように、テストを追加するところから始めていきます。</p>
<p>まずはユーザーの情報が互いに編集できないことを確認するために、サンプルユーザーをもう一人追加します。ユーザー用のfixtureファイルに2人目のユーザーを追加してみましょう (<a class="hyperref" href="#code-fixture_second_user">リスト<span class="ref">9.20</span></a>)。</p>
<div class="codelisting" id="code-fixture_second_user" data-tralics-id="uid916" data-number="9.20">
<div class="heading">
<span class="number">リスト9.20:</span> 

<span class="description">fixtureファイルに２人目のユーザーを追加する<span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>

<span class="hll"><span class="l-Scalar-Plain">archer</span><span class="p-Indicator">:</span>
</span><span class="hll">  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sterling Archer</span>
</span><span class="hll">  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duchess@example.gov</span>
</span><span class="hll">  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
</span></pre></div></div>
</div>
<p>次に、 <a class="hyperref" href="log_in_log_out?version=4.2#code-test_helper_log_in">リスト<span class="ref">8.50</span></a>で定義した<code>log_in_as</code>メソッドを使って、<code>edit</code>アクションと<code>update</code>アクションをテストします (<a class="hyperref" href="#code-edit_update_wrong_user_tests">リスト<span class="ref">9.21</span></a>)。このとき、既にログイン済みのユーザーを対象としているため、ログインページではなくルートURLにリダイレクトしている点に注意してください。</p>
<div class="codelisting" id="code-edit_update_wrong_user_tests" data-tralics-id="uid917" data-number="9.21">
<div class="heading">
<span class="number">リスト9.21:</span> 

<span class="description">間違ったユーザーが編集しようとしたときのテスト RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should get new"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:new</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect edit when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect update when not logged in"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect edit when logged in as wrong user"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
</span><span class="hll">    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect update when logged in as wrong user"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
</span><span class="hll">    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div>
</div>
<p>別のユーザーのプロフィールを編集しようとしたらリダイレクトさせたいので、<code>correct_user</code>というメソッドを作成し、beforeフィルターからこのメソッドを呼び出すようにします (<a class="hyperref" href="#code-correct_user_before_filter">リスト<span class="ref">9.22</span></a>)。beforeフィルターの<code>correct_user</code>で<code>@user</code>変数を定義しているため、<a class="hyperref" href="#code-correct_user_before_filter">リスト<span class="ref">9.22</span></a>では<code>edit</code>と<code>update</code>の各アクションから、<code>@user</code>への代入文を削除している点にも注意してください。</p>
<div class="codelisting" id="code-correct_user_before_filter" data-tralics-id="uid918" data-number="9.22">
<div class="heading">
<span class="number">リスト9.22:</span> 

<span class="description">beforeフィルター (<code>correct_user</code>) を使って編集と更新を保護する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
<span class="hll">      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>今度はテストスイートが<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid919" data-tralics-id="uid919" data-number="9.23">
<div class="heading">
<span class="number">リスト9.23:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p>最後に、リファクタリングではありますが、一般的な慣習に倣って<code>current_user?</code>という論理値を返すメソッドを実装します。<code>correct_user</code>の中で使えるようにしたいので、Sessionsヘルパーの中にこのメソッドを追加します (<a class="hyperref" href="#code-current_user_p">リスト<span class="ref">9.24</span></a>)。このメソッドを使うと今までの</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
</pre></div></div>
<p class="noindent">といった部分が、次のように (少し) 分かりやすいコードになります。</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<div class="codelisting" id="code-current_user_p" data-tralics-id="uid920" data-number="9.24">
<div class="heading">
<span class="number">リスト9.24:</span> 

<span class="description"><code>current_user?</code> メソッド<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given user is the current user.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">先ほどのメソッドを使って比較演算していた行を置き換えると、<a class="hyperref" href="#code-correct_user_before_filter_boolean">リスト<span class="ref">9.25</span></a>になります。</p>
<div class="codelisting" id="code-correct_user_before_filter_boolean" data-tralics-id="uid921" data-number="9.25">
<div class="heading">
<span class="number">リスト9.25:</span> 

<span class="description">最終的な<code>correct_user</code>の実装 GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div>
<div id="sec-friendly_forwarding" class="subsection" data-tralics-id="uid922" data-number="9.2.3">
<h3><a href="#sec-friendly_forwarding" class="heading hyperref"><span class="number">9.2.3</span> フレンドリーフォワーディング</a></h3>
<p>ここまででWebサイトの認可機能は完成したかのように見えますが、後1つ小さなキズがあります。保護されたページにアクセスしようとすると、問答無用で自分のプロファイルページに移動させられてしまいます。別の言い方をすれば、ログインしていないユーザーが編集ページにアクセスしようとしていたなら、ユーザーがログインした後にはその編集ページにリダイレクトされるようにするのが望ましい動作です。リダイレクト先は、ユーザーが開こうとしていたページにしてあげるのが親切というものです。</p>
<p>実際のコードは少し複雑ですが、フレンドリーフォワーディングのテストは非常にシンプルに書くことができます。ログインした後に編集ページへのアクセスする、という順序を逆にしてあげるだけです (<a class="hyperref" href="#code-edit_tests_logged_in">リスト<span class="ref">9.14</span></a>)。<a class="hyperref" href="#code-friendly_forwarding_test">リスト<span class="ref">9.26</span></a>が示すように、実際のテストはまず編集ページにアクセスし、ログインした後に、(デフォルトのプロフィールページではなく) <em>編集</em>ページにリダイレクトされているかどうかをチェックするといったテストです。(なお、リダイレクトによってedit用のテンプレートが描画されなくなったので、<a class="hyperref" href="#code-friendly_forwarding_test">リスト<span class="ref">9.26</span></a>では該当するテストを削除しています)</p>
<div class="codelisting" id="code-friendly_forwarding_test" data-tralics-id="uid923" data-number="9.26">
<div class="heading">
<span class="number">リスト9.26:</span> 

<span class="description">フレンドリーフォワーディングのテスト RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"successful edit with friendly forwarding"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="nb">name</span>  <span class="o">=</span> <span class="s2">"Foo Bar"</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
                                    <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                                    <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                                    <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">assert_equal</span> <span class="nb">name</span><span class="p">,</span>  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_equal</span> <span class="n">email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>失敗するテストが書けたので、ようやくフリンドリーフォワーディングを実装する準備ができました<sup class="footnote" id="cha-9_footnote-ref-4"><a href="#cha-9_footnote-4">4</a></sup>。ユーザーを希望のページに転送するには、リクエスト時点のページをどこかに保存しておき、その場所にリダイレクトさせる必要があります。この動作を<code>store_location</code>と<code>redirect_back_or</code>の2つのメソッドを使用して実現してみましょう。なお、これらのメソッドはSessionsヘルパーで定義しています (<a class="hyperref" href="#code-friendly_forwarding_code">リスト<span class="ref">9.27</span></a>)。</p>
<div class="codelisting" id="code-friendly_forwarding_code" data-tralics-id="uid925" data-number="9.27">
<div class="heading">
<span class="number">リスト9.27:</span> 

<span class="description">フレンドリーフォワーディングの実装<span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Redirects to stored location (or to the default).</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="hll">    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
</span><span class="hll">    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:forwarding_url</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Stores the URL trying to be accessed.</span>
  <span class="k">def</span> <span class="nf">store_location</span>
<span class="hll">    <span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">get?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">転送先のURLを保存する仕組みは、<a class="hyperref" href="log_in_log_out?version=4.2#sec-a_working_log_in_method"><span class="ref">8.2.1</span></a>でユーザーをログインさせたときと同じで、<code>session</code>変数を使います。また、リクエスト先のURLを取得するために、<a class="hyperref" href="#code-friendly_forwarding_code">リスト<span class="ref">9.27</span></a>では<code>request</code>オブジェクトも使っています (<code>request.url</code>でリクエスト先が取得できます)。</p>
<p><a class="hyperref" href="#code-friendly_forwarding_code">リスト<span class="ref">9.27</span></a>の<code>store_location</code>メソッドでは、 リクエストが送られたURLを<code>session</code>変数の<code>:forwarding_url</code>キーに格納しています。ただし、<code>GET</code>リクエストが送られたときだけ格納するようにしておきます。これによって、たとえばログインしていないユーザーがフォームを使って送信した場合、転送先のURLを保存させないようにできます。これは稀なケースですが起こり得ます。たとえばユーザがセッション用のcookieを手動で削除してフォームから送信するケースなどです。こういったケースに対処しておかないと、<code>POST</code>や <code>PATCH</code>、<code>DELETE</code>リクエストを期待しているURLに対して (リダイレクトを通して) <code>GET</code>リクエストが送られてしまい、場合によってはエラーが発生します。このため、<code>if request.get?</code>という条件文を使ってこのケースの対策しています<sup class="footnote" id="cha-9_footnote-ref-5"><a href="#cha-9_footnote-5">5</a></sup>。</p>
<p>先ほど定義した<code>store_location</code>メソッドを使って、早速beforeフィルタの<code>logged_in_user</code>を修正してみます (<a class="hyperref" href="#code-add_store_location">リスト<span class="ref">9.28</span></a>)。</p>
<div class="codelisting" id="code-add_store_location" data-tralics-id="uid927" data-number="9.28">
<div class="heading">
<span class="number">リスト9.28:</span> 

<span class="description">ログインユーザー用beforeフィルターに<code>store_location</code>を追加する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
<span class="hll">        <span class="n">store_location</span>
</span>        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>フォワーディング自体を実装するには、<code>redirect_back_or</code>メソッドを使用します。リクエストされたURLが存在する場合はそこにリダイレクトし、ない場合は何らかのデフォルトのURLにリダイレクトします。デフォルトのURLは、Sessionコントローラの<code>create</code>アクションに追加し、サインイン成功後にリダイレクトします (<a class="hyperref" href="#code-friendly_session_create">リスト<span class="ref">9.29</span></a>)。<code>redirect_back_or</code>メソッドでは、次のようにor演算子<code>||</code>を使用します。</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div></div>
<p class="noindent">このコードは、値が<code>nil</code>でなければ<code>session[:forwarding_url]</code>を評価し、nilであれば与えられたデフォルトのURLを使用します<a class="hyperref" href="#code-friendly_forwarding_code">リスト<span class="ref">9.27</span></a>では、session.delete(:forwarding_url) という式を通して転送用のURLを削除している点に注意してください。これをやっておかないと、次回ログインしたときに保護されたページに転送されてしまい、ブラウザを閉じるまでこれが繰り返されてしまいます (このコードのテストは<a class="hyperref" href="#sec-updating_deleting_exercises"><span class="ref">9.6</span></a>の演習とします)。ちなみに、最初にredirect文を実行しても、セッションが削除される点を覚えておくとよいでしょう。実は、明示的に<code>return</code>文やメソッド内の最終行が呼び出されない限り、リダイレクトは発生しません。したがって、redirect文の後にあるコードでも、そのコードは実行されるのです。</p>
<div class="codelisting" id="code-friendly_session_create" data-tralics-id="uid928" data-number="9.29">
<div class="heading">
<span class="number">リスト9.29:</span> 

<span class="description">フレンドリーフォワーディングを備えた<code>create</code>アクション<span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">      <span class="n">redirect_back_or</span> <span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>これで、<a class="hyperref" href="#code-friendly_forwarding_test">リスト<span class="ref">9.26</span></a>のフレンドリーフォワーディング用統合テストはパスするはずです。成功すれば、基本ユーザー認証機能とページ保護機能の実装は完了です。いつものように、以下を実行してテストスイートが <span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>緑色</strong></span><span class="sc"></span></span> (成功) になることを確認してから先に進みましょう。</p>
<div class="codelisting" id="uid929" data-tralics-id="uid929" data-number="9.30">
<div class="heading">
<span class="number">リスト9.30:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-showing_all_users" class="section" data-tralics-id="cid61" data-number="9.3">
<h2><a href="#sec-showing_all_users" class="heading hyperref"><span class="number">9.3</span> すべてのユーザーを表示する</a></h2>
<p>この節では、いよいよ<a href="http://www.google.com/url?q=http%3A%2F%2Fwww.answers.com%2Fpenultimate&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNERK6hcEQw8b5GJvd4-7so0Hn14QA">最後から2番目の</a>ユーザーアクションである<code>index</code>アクションを追加しましょう。このアクションは、<em>すべての</em>ユーザーを一覧表示します。その際、データベースにサンプルデータを追加する方法や、将来ユーザー数が膨大になってもindexページを問題なく表示できるようにするためのユーザー出力の<em>ページネート (paginate=ページ分割)</em> の方法を学びます。ユーザーの一覧、ページネーション用リンク、移動用の [Users] リンクのモックアップを<a class="hyperref" href="#fig-user_index_mockup">図<span class="ref">9.8</span></a>に示します<sup class="footnote" id="cha-9_footnote-ref-6"><a href="#cha-9_footnote-6">6</a></sup>。</p>
<div class="center figure" id="fig-user_index_mockup" data-tralics-id="uid931" data-number="9.8">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_mockup_bootstrap.png" alt="images/figures/user_index_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図9.8: </span><span class="description">ユーザー一覧ページのモックアップ
</span>
</div>
</div>
<div id="sec-users_index" class="subsection" data-tralics-id="uid932" data-number="9.3.1">
<h3><a href="#sec-users_index" class="heading hyperref"><span class="number">9.3.1 </span>ユーザーインデックス</a></h3>
<p>ユーザーの一覧ページを実装するために、まずはセキュリティモデルについて考えてみましょう。ユーザーの<code>show</code>ページについては、今後も (ログインしているかどうかに関わらず) サイトを訪れたすべてのユーザーから見えるようにしておきますが、ユーザーの<code>index</code>ページはログインしたユーザーにしか見せないようにし、未登録のユーザーがデフォルトで表示できるページを制限します<sup class="footnote" id="cha-9_footnote-ref-7"><a href="#cha-9_footnote-7">7</a></sup>。</p>
<p><code>index</code>ページを不正なアクセスから守るために、まずは<code>index</code>アクションが正しくリダイレクトするか検証するテストを書いてみます (<a class="hyperref" href="#code-index_action_redirected_test">リスト<span class="ref">9.31</span></a>)。</p>
<div class="codelisting" id="code-index_action_redirected_test" data-tralics-id="uid934" data-number="9.31">
<div class="heading">
<span class="number">リスト9.31:</span> 

<span class="description"><code>index</code>アクションのリダイレクトをテストする RED<span style="color:red"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect index when not logged in"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="ss">:index</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">次に、beforeフィルタの<code>logged_in_user</code>に<code>index</code>アクションを追加して、このアクションを保護します (<a class="hyperref" href="#code-logged_in_user_index">リスト<span class="ref">9.32</span></a>)。</p>
<div class="codelisting" id="code-logged_in_user_index" data-tralics-id="uid935" data-number="9.32">
<div class="heading">
<span class="number">リスト9.32:</span> 

<span class="description"><code>index</code>アクションにはログインを要求する GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>

<span class="hll">  <span class="k">def</span> <span class="nf">index</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span>  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>今度はすべてのユーザーを表示するために、全ユーザーが格納された変数を作成し、順々に表示するindexビューを実装します。Toyアプリケーションにも同じindexアクションがあったことを思い出してください (<a class="hyperref" href="toy_app?version=4.2#code-demo_index_action">リスト<span class="ref">2.5</span></a>)。そのときと同様に、<code>User.all</code>を使ってデータベース上の全ユーザーを取得し、ビューで使用可能な<code>@users</code>というインスタンス変数に代入させます (<a class="hyperref" href="#code-user_index">リスト<span class="ref">9.33</span></a>)。(すべてのユーザーを一気に読み出すとデータ量が多い場合に問題が生じるのではないかと思われた方、そのとおりです。このキズは<a class="hyperref" href="#sec-pagination"><span class="ref">9.3.3</span></a>で修正します。)</p>
<div class="codelisting" id="code-user_index" data-tralics-id="uid936" data-number="9.33">
<div class="heading">
<span class="number">リスト9.33:</span> 

<span class="description">ユーザーの<code>index</code>アクション<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>実際のインデックスページを作成するには、ユーザーを列挙してユーザーごとに<code>li</code>タグで囲むビューを作成する必要があります。ここでは<code>each</code>メソッドを使用してこれを行います。それぞれの行をリストタグ<code>ul</code>で囲いながら、各ユーザーのGravatarと名前を表示します (<a class="hyperref" href="#code-user_index_view">リスト<span class="ref">9.34</span></a>)。</p>
<div class="codelisting" id="code-user_index_view" data-tralics-id="uid937" data-number="9.34">
<div class="heading">
<span class="number">リスト9.34:</span> 

<span class="description">ユーザーのindexビュー<span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-user_index_view">リスト<span class="ref">9.34</span></a>では、<a class="hyperref" href="sign_up?version=4.2#code-gravatar_option"><span class="ref">7.7</span></a>の演習の<a class="hyperref" href="sign_up?version=4.2#sec-signup_exercises">リスト<span class="ref">7.31</span></a>の結果を利用しています。これは、Gravatarヘルパーにデフォルト以外のサイズを指定するオプションを渡します。この演習をまだやっていない場合は、<a class="hyperref" href="sign_up?version=4.2#code-gravatar_option">リスト<span class="ref">7.31</span></a>に従ってUsersヘルパーファイルを更新してから先に進んでください。</p>
<p>CSS (正確にはSCSSですが) にもちょっぴり手を加えておきましょう (<a class="hyperref" href="#code-user_index_css">リスト<span class="ref">9.35</span></a>)。</p>
<div class="codelisting" id="code-user_index_css" data-tralics-id="uid938" data-number="9.35">
<div class="heading">
<span class="number">リスト9.35:</span> 

<span class="description">ユーザーのindexページ用のCSS<span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">Users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$gray-lighter</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
</div>
<p>最後に、サイト内移動用のヘッダーにユーザー一覧表示用のリンクを追加します。これには<code>users_path</code>を使用し、<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>に残っている最後の名前付きルートを割り当てます。変更の結果を<a class="hyperref" href="#code-users_link">リスト<span class="ref">9.36</span></a>に示します。</p>
<div class="codelisting" id="code-users_link" data-tralics-id="uid939" data-number="9.36">
<div class="heading">
<span class="number">リスト9.36:</span> 

<span class="description">ユーザー一覧ページへのリンクを更新する<span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
<span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div>
</div>
<p>これでユーザーのインデックスは完全に動くようになり、テストも全て<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>パス</strong></span><span class="sc"></span></span>するようになります。</p>
<div class="codelisting" id="uid940" data-tralics-id="uid940" data-number="9.37">
<div class="heading">
<span class="number">リスト9.37:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
<p class="noindent">ところで、<a class="hyperref" href="#fig-user_index_only_one">図<span class="ref">9.9</span></a>のようにユーザーが1人のままではいささか寂しすぎます。もう少し何とかしてみましょう。</p>
<div class="center figure" id="fig-user_index_only_one" data-tralics-id="uid941" data-number="9.9">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_only_one_3rd_edition.png" alt="images/figures/user_index_only_one_3rd_edition"></div>
<div class="caption">
<span class="header">図9.9</span> <span class="description">ユーザー一覧ページにユーザーが1人しか表示されていない
</span>
</div>
</div>
</div>
<div id="sec-sample_users" class="subsection" data-tralics-id="uid942" data-number="9.3.2">
<h3><a href="#sec-sample_users" class="heading hyperref"><span class="number">9.3.2</span> サンプルのユーザー</a></h3>
<p>この節では、一人ぼっちのユーザーに仲間を加えてあげることにします。複数のユーザーが表示されたユーザーインデックスページにするためには、ブラウザでサインアップページを表示してユーザーを手作業で1人ずつ追加するという方法も<em>ありますが</em>、せっかくなのでRubyとRakeを使用してユーザーを一気に作成しましょう。</p>
<p>まず、<em>Gemfile</em>に<code>Faker</code> gemを追加します (<a class="hyperref" href="#code-faker_gemfile">リスト<span class="ref">9.38</span></a>)。これは、実際にありそうなユーザー名とメールアドレスを持つサンプルユーザーを自動的に作成するものです。</p>
<div class="codelisting" id="code-faker_gemfile" data-tralics-id="uid943" data-number="9.38">
<div class="heading">
<span class="number">リスト9.38:</span> 

<span class="description"><code>Gemfile</code>にFakerを追加する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>               <span class="s1">'3.1.7'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                <span class="s1">'1.4.2'</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div>
</div>
<p class="noindent">次に、いつものように以下を実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install</pre></div></div>
<p>では、サンプルユーザーを生成するRakeタスクを追加してみましょう。Railsでは<code>db/seeds.rb</code>というファイルを標準として使います。結果を<a class="hyperref" href="#code-db_seed">リスト<span class="ref">9.39</span></a>に示します。(<a class="hyperref" href="#code-db_seed">リスト<span class="ref">9.39</span></a>のコードは少し応用的です。詳細が完全に理解できなくても問題ありません)</p>
<div class="codelisting" id="code-db_seed" data-tralics-id="uid944" data-number="9.39">
<div class="heading">
<span class="number">リスト9.39:</span> 

<span class="description">データベース上にサンプルユーザーを生成するRakeタスク<span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>

<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
               <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
               <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-db_seed">リスト<span class="ref">9.39</span></a>のコードでは、Example Userという名前とメールアドレスを持つ1人のユーザと、それらしい名前とメールアドレスを持つ99人のユーザーを作成します。<code>create!</code>は基本的に<code>create</code>メソッドと同じものですが、ユーザーが無効な場合に<code>false</code>を返すのではなく例外を発生させる (<a class="hyperref" href="modeling_users?version=4.2#sec-finding_user_objects"><span class="ref">6.1.4</span></a>) 点が異なります。こうしておくと見過ごしやすいエラーを回避できるので、デバッグが容易になります。</p>
<p>それでは、データベースをリセットして、<a class="hyperref" href="#code-db_seed">リスト<span class="ref">9.39</span></a>のRakeタスクを実行 (<code>db:seed</code>) してみましょう<sup class="footnote" id="cha-9_footnote-ref-8"><a href="#cha-9_footnote-8">8</a></sup>。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
$ bundle exec rake db:seed
</pre></div></div>
<p class="noindent">データベース上にデータを追加するのは遅くなりがちで、システムによっては数分かかることもあり得ます。</p>
<p><code>db:seed</code>でRakeタスクを実行し終わると、サンプルアプリケーションのユーザーが100人になっています。<a class="hyperref" href="#fig-user_index_all">図<span class="ref">9.10</span></a>が示すように、 最初のいくつかのメールアドレスについては、デフォルトのGravatar画像以外の写真を関連付けてみました。(システム環境によっては、ここでRailsを再起動させる必要があるかもしれません。)</p>
<div class="center figure" id="fig-user_index_all" data-tralics-id="uid946" data-number="9.10">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_all_3rd_edition.png" alt="images/figures/user_index_all_3rd_edition"></div>
<div class="caption">
<span class="header">図9.9</span> <span class="description">ユーザー一覧ページに100人のサンプルユーザーが表示されている
</span>
</div>
</div>
</div>
<div id="sec-pagination" class="subsection" data-tralics-id="uid947" data-number="9.3.3">
<h3><a href="#sec-pagination" class="heading hyperref"><span class="number">9.3.3</span> ページネーション</a></h3>
<p>これで、最初のユーザーにも仲間ができました。しかし今度は逆に、1つのページに<em>大量の</em>ユーザーが表示されてしまっています。100人でもかなり大きい数であると思いますし、今後は数千ユーザーに増える可能性もあります。これを解決するのが<em>ページネーション (pagination) </em>というもので、この場合は、たとえば1つのページに一度に30人だけユーザーを表示するというものです。</p>
<p>Railsには豊富なページネーションメソッドがあります。今回はその中で最もシンプルかつ堅牢な<a href="http://www.google.com/url?q=http%3A%2F%2Fwiki.github.com%2Fmislav%2Fwill_paginate%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFUUWVsOjcsif3BKcLc9CibpIrT0A">will_paginate</a>メソッドを使用してみましょう。これを使用するには、Gemfileに<span class="tt">will_paginate</span> gem と<span class="tt">bootstrap-will_paginate</span> gemを両方インクルードし、Bootstrapのページネーションスタイルを使用してwill_paginateを構成します。更新した<code>Gemfile</code>を<a class="hyperref" href="#code-will_paginate_gem">リスト<span class="ref">9.40</span></a>に示します。</p>
<div class="codelisting" id="code-will_paginate_gem" data-tralics-id="uid948" data-number="9.40">
<div class="heading">
<span class="number">リスト9.40:</span> 

<span class="description"><code>Gemfile</code>に<span class="tt">will_paginate</span>を追加する</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.7'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.4.2'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.0.7'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div>
</div>
<p class="noindent">次に<code>bundle install</code>を実行します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install</pre></div></div>
<p class="noindent">新しいgemが正しく読み込まれるように、Webサーバーを再起動してください。</p>
<p>ページネーションが動作するには、ユーザーのページネーションを行うようにRailsに指示するコードをindexビューに追加する必要があります。また、<code>index</code>アクションにある<code>User.all</code>を、ページネーションを理解できるオブジェクトに置き換える必要もあります。まずは、ビューに特殊な<code>will_paginate</code>メソッドを追加しましょう (<span class="ref">リスト<a class="hyperref" href="#code-will_paginate_index_view">9.41</a></span>)。同じコードがリストの上と下に2つありますが、その理由はこの後で説明します。</p>
<div class="codelisting" id="code-will_paginate_index_view" data-tralics-id="uid949" data-number="9.41">
<div class="heading">
<span class="number">リスト9.41:</span> 

<span class="description">ユーザー一覧ページでpaginationを使う<span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="hll"><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</span>
<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="hll"><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</span></pre></div></div>
</div>
<p>この<code>will_paginate</code>メソッドは少々不思議なことに、<code>users</code>ビューのコードの中から<code>@users</code>オブジェクトを自動的に見つけ出し、それから他のページにアクセスするためのページネーションリンクを作成しています。ただし、<a class="hyperref" href="#code-will_paginate_index_view">リスト<span class="ref">9.41</span></a>のビューはこのままでは動きません。というのも、現在の<code>@users</code>変数には<code>User.all</code>の結果が含まれていますが (<a class="hyperref" href="#code-user_index">リスト<span class="ref">9.33</span></a>)、<code>will_paginate</code>では<code>paginate</code>メソッドを使った結果が必要だからです。必要となるデータの例は次のとおりです。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">  User Load (1.5ms)  SELECT "users".* FROM "users" LIMIT 30 OFFSET 0</span>
<span class="go">   (1.7ms)  SELECT COUNT(*) FROM "users"</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
</pre></div></div>
<p class="noindent"><code>paginate</code>では、キーが<code>:page</code>で値がページ番号のハッシュを引数に取ります。<code>User.paginate</code>は、<code>:page</code>パラメーターに基いて、データベースからひとかたまりのデータ (デフォルトでは30) を取り出します。従って、1ページ目は1から30のユーザー、2ページ目は31から60のユーザーといった具合にデータが取り出されます。ちなみに<code>page</code>が<code>nil</code>の場合、 <code>paginate</code>は単に最初のページを返します。</p>
<p><code>paginate</code>を使用することで、サンプルアプリケーションのユーザーのページネーションを行えるようになります。具体的には、<code>index</code>アクション内の<code>all</code>を<code>paginate</code>メソッドに置き換えます (<a class="hyperref" href="#code-will_paginate_index_action">リスト<span class="ref">9.42</span></a>)。ここで<code>:page</code>パラメーターには<code>params[:page]</code>が使用されていますが、これは<code>will_paginate</code>によって自動的に生成されます。</p>
<div class="codelisting" id="code-will_paginate_index_action" data-tralics-id="uid950" data-number="9.42">
<div class="heading">
<span class="number">リスト9.42:</span> 

<span class="description"><code>index</code>アクションでUsersをページネートする<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>以上で、ユーザー一覧ページは<a class="hyperref" href="#fig-user_index_pagination">図<span class="ref">9.11</span></a>のように動作するはずです (システム環境によっては、ここでRailsを再起動する必要があるかもしれません)。<code>will_paginate</code>をユーザーリストの上と下の両方に配置してあるので、ページネーションのリンクもページの上と下の両方に表示されています。</p>
<div class="center figure" id="fig-user_index_pagination" data-tralics-id="uid951" data-number="9.11">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_pagination_3rd_edition.png" alt="images/figures/user_index_pagination_3rd_edition"></div>
<div class="caption">
<span class="header">図9.11: </span><span class="description">ページネーションされたユーザー一覧ページ
</span>
</div>
</div>
<p>[<a href="http://localhost:3000/users?page=2" target="_blank">2</a>] リンクまたは [<a href="http://localhost:3000/users?page=2" target="_blank">Next</a>] リンクをクリックすると、<a class="hyperref" href="#fig-user_index_page_two_rails_3">図<span class="ref">9.12</span></a>のように次のページに移動します。</p>
<div class="center figure" id="fig-user_index_page_two_rails_3" data-tralics-id="uid952" data-number="9.12">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_page_two_3rd_edition.png" alt="images/figures/user_index_page_two_3rd_edition"></div>
<div class="caption">
<span class="header">図9.12</span> <span class="description">ユーザー一覧の2ページ目
</span>
</div>
</div>
</div>
<div id="sec-users_index_test" class="subsection" data-tralics-id="uid953" data-number="9.3.4">
<h3><a href="#sec-users_index_test" class="heading hyperref"><span class="number">9.3.4 </span>ユーザーインデックスのテスト</a></h3>
<p>これでユーザー一覧ページが動くようになったので、<a class="hyperref" href="#sec-pagination"><span class="ref">9.3.3</span></a>のページネーションに対する簡単なテストも書いておきましょう。今回のテストでは、ログイン、indexページにアクセス、最初のページにユーザーがいることを確認、ページネーションのリンクがあることを確認、といった順でテストしていきます。最後の2つのステップでは、テスト用のデータベースに31人以上のユーザーがいる必要があります。</p>
<p> <a class="hyperref" href="#code-fixture_second_user">リスト<span class="ref">9.20</span></a>で2人目のユーザーをfixtureに追加しましたが、今回はもっと多くのユーザーを作成する必要があります。手動で追加するのは面倒そうですね。幸運には、ユーザー用fixtureファイルの<code>password_digest</code>属性で使ったように、fixtureでは埋め込みRubyをサポートしています。これを利用してさらに30人のユーザーを追加してみましょう (<a class="hyperref" href="#code-users_fixtures_extra_users">リスト<span class="ref">9.43</span></a>)。なお、今後必要になるので、<a class="hyperref" href="#code-users_fixtures_extra_users">リスト<span class="ref">9.43</span></a>では2人の名前付きユーザーも一緒に追加しています。</p>
<div class="codelisting" id="code-users_fixtures_extra_users" data-tralics-id="uid954" data-number="9.43">
<div class="heading">
<span class="number">リスト9.43:</span> 

<span class="description">fixtureにさらに30人のユーザーを追加する<span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;

archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

mallory:
  name: Mallory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;
</pre></div></div>
</div>
<p><a class="hyperref" href="#code-users_fixtures_extra_users">リスト<span class="ref">9.43</span></a>のfixtureファイルができたので、indexページに対するテストを書いてみます。まずは、いつものように統合テストを生成します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_index
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_index_test.rb</span>
</pre></div></div>
<p class="noindent">今回のテストでは、<code>pagination</code>クラスを持った<code>div</code>タグをチェックして、最初のページにユーザーがいることを確認します。結果は<a class="hyperref" href="#code-user_index_test">リスト<span class="ref">9.44</span></a>のようになります。</p>
<div class="codelisting" id="code-user_index_test" data-tralics-id="uid955" data-number="9.44">
<div class="heading">
<span class="number">リスト9.44:</span> 

<span class="description">ユーザー一覧とページネーションに対するテスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_index_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersIndexTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index including pagination"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_template</span> <span class="s1">'users/index'</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">このテストは<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid956" data-tralics-id="uid956" data-number="9.45">
<div class="heading">
<span class="number">リスト9.45:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
<div id="sec-partial_refactoring" class="subsection" data-tralics-id="uid957" data-number="9.3.5">
<h3><a href="#sec-partial_refactoring" class="heading hyperref"><span class="number">9.3.5</span> パーシャルのリファクタリング</a></h3>
<p>ユーザー一覧ページにページネーションを実装することができましたが、私はここで1つの改良を加えてみたいのです。実はRailsにはコンパクトなビューを作成するための素晴らしいツールがいくつもあります。この節ではそれらのツールを使用して一覧ページのリファクタリング (動作を変えずにコードを整理すること) を行うことにします。サンプルアプリケーションのテストは既に完了しているので、Webサイトの機能を損なうことなく安心してリファクタリングに取りかかれます。</p>
<p>リファクタリングの第一歩は、<a class="hyperref" href="#code-will_paginate_index_view">リスト<span class="ref">9.41</span></a>のユーザーの<code>li</code>を<code>render</code>呼び出しに置き換えることです (<a class="hyperref" href="#code-index_view_first_refactoring">リスト<span class="ref">9.46</span></a>)。</p>
<div class="codelisting" id="code-index_view_first_refactoring" data-tralics-id="uid958" data-number="9.46">
<div class="heading">
<span class="number">リスト9.46:</span> 

<span class="description">indexビューに対する最初のリファクタリング<span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
</span>  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ここでは、<code>render</code>をパーシャルの名前の文字列に対してではなく、<code>User</code>クラスの<code>user</code>変数に対して実行していることに注意してください<sup class="footnote" id="cha-9_footnote-ref-9"><a href="#cha-9_footnote-9">9</a></sup>。この場合、Railsは自動的に<code>_user.html.erb</code>という名前のパーシャルを探します。このパーシャルを作成する必要があります (<a class="hyperref" href="#code-user_partial">リスト<span class="ref">9.47</span></a>)。</p>
<div class="codelisting" id="code-user_partial" data-tralics-id="uid960" data-number="9.47">
<div class="heading">
<span class="number">リスト9.47:</span> 

<span class="description">各ユーザーを表示するパーシャル<span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div>
</div>
<p>これは間違いなく大きな進歩です。しかしここで終わらせず、さらに改良してみましょう。今度は<code>render</code>を<code>@users</code>変数に対して<em>直接</em>実行します (<a class="hyperref" href="#code-index_final_refactoring"><span class="ref">リスト9.48</span></a>)。</p>
<div class="codelisting" id="code-index_final_refactoring" data-tralics-id="uid961" data-number="9.48">
<div class="heading">
<span class="number">リスト9.48:</span> 

<span class="description">ユーザー一覧ページの完全なリファクタリング GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
<span class="hll">  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</span><span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div>
</div>
<p class="noindent">Railsは<code>@users</code>を<code>User</code>オブジェクトのリストであると推測します。さらに、ユーザーのコレクションを与えて呼び出すと、Railsは自動的にユーザーのコレクションを列挙し、それぞれのユーザーを<code>_user.html.erb</code>パーシャルで出力します (訳注: each doとendで囲む必要がなくなります)。これにより、<a class="hyperref" href="#code-index_final_refactoring">リスト<span class="ref">9.48</span></a>のコードは極めてコンパクトになります。</p>
<p>これに限らず、リファクタリングを行う場合には、アプリケーションのコードを変更する前と後で必ずテストを実行し、いずれも<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>になることを確認するようにしてください。 </p>
<div class="codelisting" id="uid962" data-tralics-id="uid962" data-number="9.49">
<div class="heading">
<span class="number">リスト9.49:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-deleting_users" class="section" data-tralics-id="cid62" data-number="9.4">
<h2><a href="#sec-deleting_users" class="heading hyperref"><span class="number">9.4</span> ユーザーを削除する</a></h2>
<p>ユーザーの一覧ページはついに完了しました。残るは<code>destroy</code>だけです。これを実装することで、RESTに準拠した正統なアプリケーションとなります。この節では、ユーザーを削除するためのリンクを追加します。モックアップを<a class="hyperref" href="#fig-user_index_delete_links_mockup">図<span class="ref">9.13</span></a>に示します。また、削除を行うのに必要な<code>destroy</code>アクションも実装します。しかしその前に、削除を実行できる権限を持つ<em>管理 (admin) </em>ユーザーのクラスを作成しましょう。</p>
<div class="center figure" id="fig-user_index_delete_links_mockup" data-tralics-id="uid963" data-number="9.13">
<div class="graphics image box"><img src="http://railstutorial.jp/books/4.2/images/figures/user_index_delete_links_mockup_bootstrap.png" alt="images/figures/user_index_delete_links_mockup_bootstrap"></div>
<div class="caption">
<span class="header">図9.13: </span><span class="description">削除リンクを追加したユーザー一覧のモックアップ
</span>
</div>
</div>
<div id="sec-administrative_users" class="subsection" data-tralics-id="uid964" data-number="9.4.1">
<h3><a href="#sec-administrative_users" class="heading hyperref"><span class="number">9.4.1</span> 管理ユーザー</a></h3>
<p>特権を持つ管理ユーザーを識別するために、論理値をとる<code>admin</code>属性をUserモデルに追加します。この後で説明しますが、こうすると自動的に<code>admin?</code>メソッド (論理値を返す) も使えるようになりますので、これを使用して管理ユーザーの状態をテストできます。変更後のデータモデルは<a class="hyperref" href="#fig-user_model_admin">図<span class="ref">9.14</span></a>のようになります。</p>
<div class="center figure" id="fig-user_model_admin" data-tralics-id="uid965" data-number="9.14">
<span class="graphics"><img src="http://railstutorial.jp/books/4.2/images/figures/user_model_admin_3rd_edition.png" alt="user_model_admin_3rd_edition"></span>
<div class="caption">
<span class="header">図9.14:</span> <span class="description">論理値をとる<code>admin</code>属性が追加されたUserモデル
</span>
</div>
</div>
<p>ここでいつものように、マイグレーションを実行して<code>admin</code>属性を追加しましょう。コマンドラインで、この属性の型を<code>boolean</code>と指定します。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div></div>
<p>マイグレーションを実行すると<code>admin</code>カラムが<code>users</code>テーブル (<a class="hyperref" href="#code-admin_migration">リスト<span class="ref">9.50</span></a>) に追加されます。<a class="hyperref" href="#code-admin_migration">リスト<span class="ref">9.50</span></a>では、<code>default: false</code>という引数を<code>add_column</code>に追加しています。これは、デフォルトでは管理者に<em>なれない</em>ということを示すためです (<code>default: false</code>引数を与えない場合、 <code>admin</code>の値はデフォルトで<code>nil</code>になりますが、これは<code>false</code>と同じ意味ですので、必ずしもこの引数を与える必要はありません。ただし、このように明示的に引数を与えておけば、コードの意図をRailsと開発者に明確に示すことができます)。</p>
<div class="codelisting" id="code-admin_migration" data-tralics-id="uid966" data-number="9.50">
<div class="heading">
<span class="number">リスト9.50:</span> 

<span class="description">boolean型の<code>admin</code>属性をUserに追加するマイグレーション<span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_admin_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p>後はいつものようにマイグレーションを実行します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate
</pre></div></div>
<p class="noindent">Rails consoleで動作を確認すると、期待どおり<code>admin</code>属性が追加されて論理値をとり、さらに疑問符の付いた<code>admin?</code>メソッドも利用できるようになっています。</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p class="noindent">ここでは<code>toggle!</code>メソッドを使用して <code>admin</code>属性の状態を<code>false</code>から<code>true</code>に反転しています。</p>
<p>仕上げに、最初のユーザーだけをデフォルトで管理者にするようサンプルデータを更新しましょう (<a class="hyperref" href="#code-populator_with_admin">リスト<span class="ref">9.51</span></a>)。</p>
<div class="codelisting" id="code-populator_with_admin" data-tralics-id="uid967" data-number="9.51">
<div class="heading">
<span class="number">リスト9.51:</span> 

<span class="description">サンプルデータ生成タスクに管理者を1人追加する<span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
<span class="hll">             <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span>
<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
               <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
               <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">次に、データベースをリセットして、サンプルデータを再度生成します。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake db:migrate:reset
$ bundle exec rake db:seed
</pre></div></div>
<div id="sec-revisiting_strong_parameters" class="subsubsection" data-tralics-id="uid968" data-number="9.4.1.1">
<h4><a href="#sec-revisiting_strong_parameters" class="heading">Strong Parameters、再び</a></h4>
<p><a class="hyperref" href="#code-populator_with_admin">リスト<span class="ref">9.51</span></a>では、初期化ハッシュに<code>admin: true</code>を設定することでユーザーを管理者にしていることにお気付きになりましたでしょうか。ここでは、荒れ狂うWeb世界にオブジェクトをさらすことの危険性を改めて強調しています。もし、任意のWebリクエストの初期化ハッシュをオブジェクトに渡せるとなると、攻撃者は以下のような<span class="tt">PATCH</span>リクエストを送信してくるかもしれません<sup class="footnote" id="cha-9_footnote-ref-10"><a href="#cha-9_footnote-10">10</a></sup>。</p>
<div class="code"><div class="highlight"><pre>patch /users/17?admin=1
</pre></div></div>
<p class="noindent">このリクエストは、17番目のユーザーを管理者に変えてしまいます。ユーザーのこの行為は、少なくとも重大なセキュリティ違反となる可能性がありますし、実際にはそれだけでは済まないでしょう。</p>
<p>このような危険があるからこそ、編集してもよい安全な属性だけを更新することが重要になります。<a class="hyperref" href="sign_up?version=4.2#sec-strong_parameters"><span class="ref">7.3.2</span></a>で説明したとおり、<em>Strong Parameters</em>を使用してこれを行います。具体的には、 以下のように<code>params</code>ハッシュに対して<code>require</code>と<code>permit</code>を呼び出します。</p>
<div class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div></div>
<p class="noindent">上のコードでは、許可された属性リストに<code>admin</code>が含まれて<em>いない</em>ことに注目してください。これにより、任意のユーザーが自分自身にアプリケーションの管理者権限を与えることを防止できます。この問題は重大であるため、編集可能になってはならない属性に対するテストを作成することをぜひともお勧めします。<code>admin</code>属性のテストについては演習に回します (<a class="hyperref" href="#sec-updating_deleting_exercises"><span class="ref">9.6</span></a>)。</p>
</div>
</div>
<div id="sec-the_destroy_action" class="subsection" data-tralics-id="uid970" data-number="9.4.2">
<h3><a href="#sec-the_destroy_action" class="heading hyperref"><span class="number">9.4.2</span> <span class="tt">destroy</span>アクション</a></h3>
<p>Usersリソースの最後の仕上げとして、<code>destroy</code>アクションへのリンクを追加しましょう。まず、ユーザーインデックスページの各ユーザーに削除用のリンクを追加し、続いて管理ユーザーへのアクセスを制限します。これによって、現在のユーザーが管理者のときに限り <code>[delete]</code> リンクが表示されるようになります (<a class="hyperref" href="#code-delete_links">リスト<span class="ref">9.52</span></a>)。</p>
<div class="codelisting" id="code-delete_links" data-tralics-id="uid971" data-number="9.52">
<div class="heading">
<span class="number">リスト9.52:</span> 

<span class="description">ユーザー削除用リンクの実装 (管理者にのみ表示される)<span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="hll">  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class="hll">    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
</span><span class="hll">  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span><span class="nt">&lt;/li&gt;</span>
</pre></div></div>
</div>
<p class="noindent">ここで、必要な<code>DELETE</code>リクエストを発行するリンクの生成は<span class="tt">method: :delete</span>引数によって行われている点に注目してください。 また、各リンクを<code>if</code>文で囲い、管理者にだけ削除リンクが表示されるようにしています。管理者から見えるページを<a class="hyperref" href="#fig-index_delete_links_rails_3">図<span class="ref">9.15</span></a>に示します。</p>
<p>ブラウザはネイティブでは<span class="tt">DELETE</span>リクエストを送信できないため、RailsではJavaScriptを使用してこれを偽造します。つまり、JavaScriptがオフになっているとユーザー削除のリンクも無効になるということです。JavaScriptをサポートしないブラウザをサポートする必要がある場合は、フォームと<span class="tt">POST</span>リクエストを使用して<span class="tt">DELETE</span>リクエストを偽造することもできます。こちらはJavaScriptがなくても動作します<sup class="footnote" id="cha-9_footnote-ref-11"><a href="#cha-9_footnote-11">11</a></sup>。</p>
<div class="center figure" id="fig-index_delete_links_rails_3" data-tralics-id="uid973" data-number="9.15">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/index_delete_links_3rd_edition.png" alt="images/figures/index_delete_links_3rd_edition"></div>
<div class="caption">
<span class="header">図9.15: </span><span class="description">ユーザー一覧ページに削除用リンクが表示される
</span>
</div>
</div>
<p>この削除リンクが動作するためには、<code>destroy</code>アクション (<a class="hyperref" href="sign_up?version=4.2#table-RESTful_users">表<span class="ref">7.1</span></a>) を追加する必要があります。このアクションでは、該当するユーザーを見つけてActive Recordの<code>destroy</code>メソッドを使用して削除し、最後にユーザーインデックスに移動します (<a class="hyperref" href="#code-destroy_action">リスト<span class="ref">9.53</span></a>)。ユーザーを削除するためにはログインしていなくてはならないので、<a class="hyperref" href="#code-destroy_action">リスト<span class="ref">9.53</span></a>では<code>:destroy</code>アクションも<code>logged_in_user</code>フィルターに追加しています。</p>
<div class="codelisting" id="code-destroy_action" data-tralics-id="uid974" data-number="9.53">
<div class="heading">
<span class="number">リスト9.53:</span> 

<span class="description">実際に動作する<code>destroy</code>アクションを追加する <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span>  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</span><span class="hll">    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"User deleted"</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">users_url</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><code>destroy</code>アクションでは、<code>find</code>メソッドと<code>destroy</code>メソッドを1行で書くために2つのメソッドを連結 (chain) している点に注目してください。</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div></div>
<p>結果として、管理者だけがユーザーを削除できるようになります (より具体的には、削除リンクが見えているユーザーのみ削除できる)。しかし、実はまだ大きなセキュリティホールがあります。ある程度の腕前を持つ攻撃者なら、コマンドラインで<span class="tt">DELETE</span>リクエストを直接発行するという方法でサイトの全ユーザーを削除してしまうことができるでしょう。サイトを正しく防衛するには、<code>destroy</code>アクションにもアクセス制御を行う必要があります。これを実装してようやく、管理者<em>だけが</em>ユーザーを削除できるようにします。</p>
<p><a class="hyperref" href="#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>と<a class="hyperref" href="#sec-requiring_the_right_user"><span class="ref">9.2.2</span></a>と同じように、今回はbeforeフィルターを使って<code>destroy</code>アクションへのアクセスを制御します。実装する<code>admin_user</code>フィルターを<a class="hyperref" href="#code-admin_destroy_before_filter">リスト<span class="ref">9.54</span></a>に示します。</p>
<div class="codelisting" id="code-admin_destroy_before_filter" data-tralics-id="uid975" data-number="9.54">
<div class="heading">
<span class="number">リスト9.54:</span> 

<span class="description">beforeフィルターで<code>destroy</code>アクションを管理者だけに限定する<span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># Confirms an admin user.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
<span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
</div>
<div id="sec-user_destroy_tests" class="subsection" data-tralics-id="uid976" data-number="9.4.3">
<h3><a href="#sec-user_destroy_tests" class="heading hyperref"><span class="number">9.4.3 </span>ユーザー削除のテスト</a></h3>
<p>ユーザー削除と同じくらい重要なことは、その振る舞いが期待されたかどうかを確かめる良いテストを書くことです。そこで、まずはユーザー用fixtureファイルを修正し、今いるサンプルユーザーの一人を管理者にしてみます (<a class="hyperref" href="#code-fixture_user_admin">リスト<span class="ref">9.55</span></a>)。</p>
<div class="codelisting" id="code-fixture_user_admin" data-tralics-id="uid977" data-number="9.55">
<div class="heading">
<span class="number">リスト9.55:</span> 

<span class="description">fixture内の最初のユーザーを管理者にする<span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="hll">  admin: true
</span>
archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

mallory:
  name: Mallory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;
</pre></div></div>
</div>
<p><a class="hyperref" href="#sec-requiring_logged_in_users"><span class="ref">9.2.1</span></a>で経験してきたように、Usersコントローラをテストするために、アクション単位でアクセス制御をテストします。<a class="hyperref" href="log_in_log_out?version=4.2#code-user_logout_test">リスト<span class="ref">8.28</span></a>のログアウトのテストと同様に、<code>削除</code>をテストするために、<span class="tt">DELETE</span>リクエストを発行して<code>destroy</code>アクションを直接動作させます。このとき2つのケースをチェックします。1つは、ログインしていないユーザーであれば、ログイン画面にリダイレクトされることです。もう1つは、ログイン済みではあっても管理者でなければ、ホーム画面にリダイレクトされることです。変更の結果を<a class="hyperref" href="#code-action_tests_admin">リスト<span class="ref">9.56</span></a>に示します。</p>
<div class="codelisting" id="code-action_tests_admin" data-tralics-id="uid978" data-number="9.56">
<div class="heading">
<span class="number">リスト9.56:</span> 

<span class="description">管理者権限の制御をアクションレベルでテストする GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when logged in as a non-admin"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent">このとき、<a class="hyperref" href="#code-action_tests_admin">リスト<span class="ref">9.56</span></a>では<code>assert_no_difference</code>メソッド (<a class="hyperref" href="sign_up?version=4.2#code-a_test_for_invalid_submission">リスト<span class="ref">7.21</span></a>) を使って、ユーザー数が変化しないことを確認している点に注目してください。</p>
<p><a class="hyperref" href="#code-action_tests_admin">リスト<span class="ref">9.56</span></a>のテストでは、管理者ではないユーザーの振る舞いについて検証していますが、管理者ユーザーの振る舞いと一緒に確認できるとよさそうです。そこで、管理者であればユーザー一覧画面に削除リンクが表示される仕様を利用して、<a class="hyperref" href="#code-user_index_test">リスト<span class="ref">9.44</span></a>のテストに今回のテストを追加していくことにします。これにより、後ほど追加する管理者の振る舞いについても簡単にテストが書けそうです。さて、今回のテストで唯一の手の込んだ箇所は、管理者が削除リンクをクリックしたときに、ユーザーが削除されたことを確認する部分です。今回は次のようなテストでこれを実現しました。</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p class="noindent"><a class="hyperref" href="sign_up?version=4.2#code-a_test_for_valid_submission">リスト<span class="ref">7.26</span></a>では<code>assert_difference</code>メソッドを使ってユーザーが作成されたことを確認しましたが、今回は同じメソッドを使ってユーザーが<em>削除された</em>ことを確認しています。具体的には、<code>DELETE</code>リクエストを適切なURLに向けて発行し、<code>User.count</code>を使ってユーザー数が<span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame"><nobr><span class="math" id="MathJax-Span-1" role="math" style="width: 1.449em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.282em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.894em 1000em 2.895em -999.997em); top: -2.722em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="mo" id="MathJax-Span-3" style="font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-4" style="font-family: MathJax_Main;">1</span></span><span style="display: inline-block; width: 0px; height: 2.728em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.867em; vertical-align: -0.059em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1"> -1 </script></span>減ったかどうかを確認しています。</p>
<p>したがって、管理者や一般ユーザーのテスト、そしてページネーションや削除リンクのテストをすべてまとめると、<a class="hyperref" href="#code-delete_link_integration_test">リスト<span class="ref">9.57</span></a>のようになります。</p>
<div class="codelisting" id="code-delete_link_integration_test" data-tralics-id="uid979" data-number="9.57">
<div class="heading">
<span class="number">リスト9.57:</span> 

<span class="description">削除リンクとユーザー削除に対する統合テスト GREEN<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong></strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_index_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersIndexTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@admin</span>     <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@non_admin</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index as admin including pagination and delete links"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@admin</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_template</span> <span class="s1">'users/index'</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="n">first_page_of_users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">first_page_of_users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
      <span class="k">unless</span> <span class="n">user</span> <span class="o">==</span> <span class="vi">@admin</span>
        <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@non_admin</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index as non-admin"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@non_admin</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<p class="noindent"><a class="hyperref" href="#code-delete_link_integration_test">リスト<span class="ref">9.57</span></a>では各ユーザーの削除リンクをテストするときに、ユーザーが管理者であればスキップしている点にも注目してください (これは<a class="hyperref" href="#code-delete_links">リスト<span class="ref">9.52</span></a>により、管理者であれば削除リンクが表示されないからです)。</p>
<p>これで、削除に関するコードに対して、よくテストできている状態になりました。テストスイートを走らせると<span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>成功</strong></span><span class="sc"></span></span>するはずです。</p>
<div class="codelisting" id="uid980" data-tralics-id="uid980" data-number="9.58">
<div class="heading">
<span class="number">リスト9.58:</span> <span class="description"><span style="color:ForestGreen"><span class="sc"></span><span class="sc"><strong>GREEN</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ bundle exec rake test
</pre></div></div>
</div>
</div>
</div><div id="sec-updating_and_deleting_users_conclusion" class="section" data-tralics-id="cid63" data-number="9.5">
<h2><a href="#sec-updating_and_deleting_users_conclusion" class="heading hyperref"><span class="number">9.5</span> 最後に</a></h2>
<p><a class="hyperref" href="filling_in_the_layout?version=4.2#sec-user_signup"><span class="ref">5.4</span></a>でUsersコントローラをご紹介して以来、長い道のりをたどってきました。あの頃はユーザー登録すらありませんでしたが、今は登録もログインもログアウトもできます。プロフィールの表示も、設定の編集も、すべてのユーザーの一覧画面もあります。さらに、一部のユーザーは他のユーザーを削除することすらできるようになりました。</p>
<p>この時点で、サンプルアプリケーションはWebサイトとしての十分な基盤 (ユーザーを認証したり認可したり) が整ったといえるでしょう。<a class="hyperref" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="ref">第10章</span></a>では、さらに2つの改善を加えます。メールアドレスを使ってアカウントを有効化する機能と (すなわち本当に有効なメールアドレスか検証するプロセスと)、ユーザーがパスワードを忘れてしまったときのためのパスワードリセット機能です。</p>
<p>次の章に進む前に、すべての変更をmasterブランチにマージしておきましょう。</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Finish user edit, update, index, and destroy actions"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
<span class="gp">$</span> git push
</pre></div></div>
<p class="noindent">アプリケーションを本番展開したり、サンプルデータを本番データとして作成することもできます (本番データベースをリセットするには<code>pg:reset</code>タスクを使用します)。</p>
<div class="code"><div class="highlight"><pre>$ bundle exec rake test
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rake db:migrate
$ heroku run rake db:seed
$ heroku restart
</pre></div></div>
<p class="noindent">もちろん、実際のWebサイトではサンプルデータを生成したくないという人もいるかと思いますが、これには理由があります (<a class="hyperref" href="#fig-heroku_sample_users">図<span class="ref">9.16</span></a>)。それは、<a class="hyperref" href="#fig-heroku_sample_users">図<span class="ref">9.16</span></a>が示すように、サンプルユーザーの表示順序が変化してしまい、<a class="hyperref" href="#fig-user_index_pagination">図<span class="ref">9.11</span></a>にあるようなローカル環境での表示順序と異なってしまうことです。これは現時点ではまだデフォルトの表示順序が指定されていないことが原因です。 結果として、データベースの内容に応じて表示順序が異なってしまいます。それだけのことかと思われるかもしれませんが、これは今後マイクロポストを実装するときに問題となります。なお、この問題については<a class="hyperref" href="user_microposts?version=4.2#sec-ordering_and_dependency"><span class="ref">11.1.4</span></a>で解決していきます。</p>
<div class="center figure" id="fig-heroku_sample_users" data-tralics-id="uid981" data-number="9.16">
<div class="graphics image"><img src="http://railstutorial.jp/books/4.2/images/figures/heroku_sample_users.png" alt="images/figures/heroku_sample_users"></div>
<div class="caption">
<span class="header">図9.16: </span><span class="description">本番環境のユーザー一覧ページ
</span>
</div>
</div>
<div id="sec-updating_what_we_learned_in_this_chapter" class="subsection" data-tralics-id="uid982" data-number="9.5.1">
<h3><a href="#sec-updating_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">9.5.1 </span>本章のまとめ</a></h3>
<ul>
<li>ユーザーは、編集フォームから<span class="tt">PATCH</span>リクエストを<code>update</code>アクションに対して送信し、情報を更新する
</li>
<li>Strong Parametersを使うことで、安全にWeb上から更新させることができる
</li>
<li>beforeフィルターを使うと、特定のアクションが実行される直前にメソッドを呼び出すことができる
</li>
<li>beforeフィルターを使って、認可 (アクセス制御) を実現した
</li>
<li>認可に対するテストでは、特定のHTTPリクエストを直接送信する低級なテストと、ブラウザの操作をシミュレーションする高級なテスト (統合テスト) の2つを利用した
</li>
<li>フレンドリーフォワーディングとは、ログイン成功時に元々行きたかったページに転送させる機能である
</li>
<li>ユーザー一覧ページでは、すべてのユーザーをページ毎に分割して表示する
</li>
<li>
<code>rake db:seed</code>コマンドは、<code>db/seeds.rb</code>にあるサンプルデータをデータベースに流し込む
</li>
<li>
<code>render @users</code>を実行すると、自動的に<code>_user.html.erb</code>パーシャルを参照し、各ユーザーをコレクションとして表示する
</li>
<li>論理属性<code>admin</code>を追加すると、自動的に<code>user.admin?</code>メソッドが使えるようになる
</li>
<li>管理者が削除リンクをクリックすると、<span class="tt">DELETE</span>リクエストが<code>destroy</code>アクションに向けて送信され、該当するユーザーが削除される
</li>
<li>fixtureファイル内で埋め込みRubyを使うと、多量のテストユーザーを作成することができる
</li>
</ul>
</div>
</div><div id="sec-updating_deleting_exercises" class="section" data-tralics-id="cid64" data-number="9.6">
<h2><a href="#sec-updating_deleting_exercises" class="heading hyperref"><span class="number">9.6</span> 演習</a></h2>
<p><em>注</em>: 『<em>演習の解答マニュアル</em> (英語)』には<em>Ruby on Railsチュートリアル</em>のすべての演習の解答が掲載されており、<a href="http://www.railstutorial.org/" target="_blank">www.railstutorial.org</a>で原著を購入いただいた方には無料で配布しています (訳注: 解答は英語です)。</p>
<p>なお、演習とチュートリアル本編の食い違いを避ける方法については、演習用のトピックブランチに追加したメモ (<a class="hyperref" href="static_pages?version=4.2#sec-static_pages_exercises"><span class="ref">3.6</span></a>) を参考にしてください。</p>
<ol>
<li>フレンドリーフォワーディングで、最初に与えられたURLにのみ確実に転送されていることを確認するテストを作成してください。続けてログインを行った後、転送先のURLはデフォルト (プロフィール画面) に戻る必要もありますので、これもテストで確認してください。<em>ヒント</em>: <a class="hyperref" href="#code-friendly_forwarding_test">リスト<span class="ref">9.26</span></a>に<code>session[:forwarding_url]</code>の正しい値を確認するテストを追加してください。
</li>
<li>レイアウトにあるすべてのリンクに対して統合テストを書いてみましょう。ログイン済みユーザーとそうでないユーザーのそれぞれに対して、正しい振る舞いを考えてください。<em>ヒント</em>: <code>log_in_as</code>ヘルパーを使って<a class="hyperref" href="filling_in_the_layout?version=4.2#code-layout_links_test">リスト<span class="ref">5.25</span></a>にテストを追加してみましょう。
</li>
<li>Web経由で<code>admin</code>属性を変更できないことを確認してください。<a class="hyperref" href="#code-forbidden_admin_test"><span class="ref">リスト9.59</span></a>に示したように、<span class="tt">PATCH</span>リクエストを <code>update</code>メソッドに直接発行するテストを作成してください。テストが正しい振る舞いをしているかどうか確信を得るために、まずは<code>admin</code>を<code>user_params</code>メソッド内の許可されたパラメータ一覧に<em>追加</em>するところから始めてみましょう。最初のテストは<span style="color:red"><span class="sc"></span><span class="sc"><strong>RED</strong></span><span class="sc"></span></span>になるはずです。
</li>
<li>
<a class="hyperref" href="#code-new_edit_partial">リスト<span class="ref">9.60</span></a>のパーシャルを使用して、<code>new.html.erb</code>ビューと<code>edit.html.erb</code>ビューをリファクタリングし、コードの重複を取り除いてください。このとき、<a class="hyperref" href="#code-new_user_with_partial">リスト<span class="ref">9.61</span></a>のようにフォーム変数<code>f</code>を明示的にローカル変数として渡す必要があることに注意してください。また、provide関数を使うと、パーシャル化したnewフォームやeditフォームの重複をさらに取り除くことも可能です (Jose Carlos Montero Gómezの指摘に感謝します)。
</li>
</ol>
<div class="codelisting" id="code-forbidden_admin_test" data-tralics-id="uid999" data-number="9.59">
<div class="heading">
<span class="number">リスト9.59:</span> 

<span class="description"><code>admin</code>属性の変更が禁止されていることをテストする<span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect update when logged in as wrong user"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should not allow the admin attribute to be edited via the web"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class="hll">    <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@other_user</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                                            <span class="ss">admin</span><span class="p">:</span> <span class="no">FILL_IN</span> <span class="p">}</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">FILL_IN</span><span class="o">.</span><span class="n">admin?</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div class="codelisting" id="code-new_edit_partial" data-tralics-id="uid1000" data-number="9.60">
<div class="heading">
<span class="number">リスト9.60:</span> 

<span class="description"><code>new</code>フォームと<code>edit</code>フォームをパーシャル化する<span class="break"></span> <span class="filepath">app/views/users/_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for(<span class="n"><span class="s1">@user</span><span class="n">)</span> <span class="n">do |f|</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="s1">@user</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="ss">yield(:button_text)</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">"btn btn-primary"</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;% end %&gt;</span></span></span>
</pre></div></div>
</div>
<div class="codelisting" id="code-new_user_with_partial" data-tralics-id="uid1001" data-number="9.61">
<div class="heading">
<span class="number">リスト9.61:</span> 

<span class="description">newビューをパーシャル化する<span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:button_text</span><span class="p">,</span> <span class="s1">'Create my account'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'form'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

</pre></div></div>
</div>
<div class="codelisting" id="_code-edit_user_with_partial" data-tralics-id="uid1004" data-number="9.62">
<div class="heading">
<span class="number">リスト9.62:</span>

<span class="description">editビューをパーシャル化する<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:button_text</span><span class="p">,</span> <span class="s1">"Save changes"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">"form"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gravatar_edit"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>Change<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
</div>
</div><div id="cha-9_footnotes">
  <div class="navigation">
<a class="next_page" href="account_activation_password_reset?version=4.2#cha-account_activation_and_password_reset"><span class="number">第10章</span>アカウントの有効化とパスワードのリセット</a><a class="prev_page" href="log_in_log_out?version=4.2#cha-log_in_log_out"><span class="number">第8章</span>ログイン、ログアウト</a>
</div>
<ol class="footnotes">
    <li id="cha-9_footnote-1">画像は<a href="http://www.flickr.com/photos/sashawolff/4598355045/" target="_blank">http://www.flickr.com/photos/sashawolff/4598355045/</a>からの引用です。<a class="arrow" href="#cha-9_footnote-ref-1">↑</a>
</li>
    <li id="cha-9_footnote-2">この動作の詳細を気にする必要はありません (悪いことをしているわけでもありません)。この詳細に関心を抱くのはRailsフレームワークそのものの開発者ぐらいであり、Railsでアプリケーションを開発する人にとっては重要ではありません。<a class="arrow" href="#cha-9_footnote-ref-2">↑</a>
</li>
    <li id="cha-9_footnote-3">beforeフィルター (before filters) はこれまで<code>before_filter</code>と呼ばれていましたが、「アクションの直前で実行される」という点を強調するためにRailsコアチームによって名前が変更されました。<a class="arrow" href="#cha-9_footnote-ref-3">↑</a>
</li>
    <li id="cha-9_footnote-4">このセクションのコードでは、<a href="http://thoughtbot.com/" target="_blank">thoughtbot</a>社が提供する<a href="http://github.com/thoughtbot/clearance" target="_blank">Clearance</a> gemを適用しています。<a class="arrow" href="#cha-9_footnote-ref-4">↑</a>
</li>
    <li id="cha-9_footnote-5">Yoel Adlerの指摘によって、この問題と解決策が見つかりました。感謝いたします。<a class="arrow" href="#cha-9_footnote-ref-5">↑</a>
</li>
    <li id="cha-9_footnote-6">子供の写真は<a href="http://www.flickr.com/photos/glasgows/338937124/" target="_blank">http://www.flickr.com/photos/glasgows/338937124/</a>からの引用です。<a class="arrow" href="#cha-9_footnote-ref-6">↑</a>
</li>
    <li id="cha-9_footnote-7">ちなみにこれはTwitterの認可モデルと同じです。<a class="arrow" href="#cha-9_footnote-ref-7">↑</a>
</li>
    <li id="cha-9_footnote-8">原理的には、<code>rake db:reset</code>コマンド1つでこれら2つのタスクを実行することがもできますが、最新のRailsだとうまく動かないのでこのようにしています。<a class="arrow" href="#cha-9_footnote-ref-8">↑</a>
</li>
    <li id="cha-9_footnote-9">この<code>user</code>という名前そのものはまったく重要ではないことに注意してください。たとえばuserをfoobarに置き換え、<code>@users.each do |foobar|</code>と書いてから<code>render foobar</code>と呼び出しても問題なく動作します。重要なのは、そのオブジェクトそのものではなく、そのオブジェクトが属している<em>クラス</em> (この場合は<code>User</code>クラス) の方です。<a class="arrow" href="#cha-9_footnote-ref-9">↑</a>
</li>
    <li id="cha-9_footnote-10">
<span class="tt">curl</span>などのコマンドラインツールを使用すると、<span class="tt">PATCH</span>リクエストをこの形式で送信することができます。<a class="arrow" href="#cha-9_footnote-ref-10">↑</a>
</li>
    <li id="cha-9_footnote-11">詳しくはRailsCastの “<a href="http://railscasts.com/episodes/77-destroy-without-javascript" target="_blank">JavaScriptを使わない削除</a>” (英語) を観てください。<a class="arrow" href="#cha-9_footnote-ref-11">↑</a>
</li>
  </ol>
</div>
          </div>
  </body>
</html>
